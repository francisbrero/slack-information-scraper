(function(){"use strict";TS.registerModule("presence_manager",{addPresenceList:function(presence_list){presence_list.added_sig.add(_addMembers);presence_list.removed_sig.add(_removeMembers)},removePresenceList:function(presence_list){presence_list.added_sig.remove(_addMembers);presence_list.removed_sig.remove(_removeMembers)},createList:function(members){var list=new TS.PresenceList(members);TS.presence_manager.addPresenceList(list);return list},queryMemberPresence:function(member){if(_sub_list.indexOf(member)>-1)return;if(_query_list.indexOf(member))return;_query_list.push(member);_sendQueryList()},test:{getSubObject:function(){return _members},getSubList:function(){return _sub_list},getSubNames:function(){return _sub_list.map(function(id){return _.get(TS.members.getMemberById(id),"name",null)})},getQueryList:function(){return _sub_list},getQueryNames:function(){return _query_list.map(function(id){return _.get(TS.members.getMemberById(id),"name",null)})}}});var _SLACKBOT_ID="USLACKBOT";var _members={};var _sub_list=[];var _query_list=[];var _sub_timeout=null;var _query_timeout=null;var _addMembers=function(members){if(!_.isArray(members))members=[members];members.forEach(function(member){_addMember(member)})};var _removeMembers=function(members){if(!_.isArray(members))members=[members];members.forEach(function(member){_removeMember(member)})};var _addMember=function(member){if(member===_SLACKBOT_ID)return;if(_members[member]){_members[member]++}else{_members[member]=1;_sub_list.push(member);_sendSubList()}};var _removeMember=function(member){if(_members[member]){_members[member]--;if(!_members[member]){var index=_sub_list.indexOf(member);_sub_list.splice(index,1);_sendSubList()}}};var _sendSubList=function(){if(_sub_timeout)return;_sub_timeout=setTimeout(function(){TS.metrics.count("presence_manager",_sub_list.length);if(TS.presence_manager.test){TS.log(1117,"presence subscription ->",TS.presence_manager.test.getSubNames())}TS.ms.send({type:"presence_sub",ids:_sub_list});_sub_timeout=null},1)};var _sendQueryList=function(){if(_query_timeout)return;_query_timeout=setTimeout(function(){if(TS.presence_manager.test){TS.log(1117,"presence query ->",TS.presence_manager.test.getQueryNames())}TS.ms.send({type:"presence_query",ids:_query_list});_query_timeout=null},1)}})();(function(){"use strict";TS.registerComponent("PresenceList",{_constructor:function(members){this._list=[];this.added_sig=new signals.Signal;this.removed_sig=new signals.Signal;if(!TS.boot_data.feature_presence_sub){this.add=_.noop;this.remove=_.noop;this.clear=_.noop;return}if(members)this.add(members)},add:function(members){if(!_.isArray(members))members=[members];var add_list=_.difference(members,this._list);if(add_list.length){this._list=this._list.concat(add_list);this.added_sig.dispatch(add_list)}},remove:function(members){if(!_.isArray(members))members=[members];var remove_list=_.intersection(members,this._list);if(remove_list.length){this._list=_.difference(this._list,remove_list);this.removed_sig.dispatch(remove_list)}},clear:function(){this.removed_sig.dispatch(this._list);this._list=[]},destroy:function(){this.removed_sig.dispatch(this._list);this._list=null}})})();(function(){"use strict";TS.registerModule("compression",{onStart:function(){},compress:function(k,str,immediate,after){var start=Date.now();if(immediate){var result=LZString.compress(str);var elapsed=Date.now()-start;TS.log(488,k+" took "+elapsed+"ms to _compress immediately str.length: "+str.length);return after({k:k,str:result})}_doCompressionJob(k,str,function(result,job_work_ms){var elapsed=Date.now()-start;TS.log(488,k+" took "+elapsed+"ms for the compression worker to callback ("+job_work_ms+"ms spent within the worker) result.length: "+result.length);after({k:k,str:result})})},deCompress:function(k,str){return""},terminate:function(){if(_worker)_worker.terminate();_worker=null}});var _worker=null;var _count=0;var _callbacks={};var _doCompressionJob=function(k,str,callback){if(!_worker)_makeWorker();_count++;var job_key="job_key"+_count;_callbacks[job_key]=function(result,job_work_ms){callback(result,job_work_ms);delete _callbacks[job_key]};_worker.postMessage({request:"compress",input:str,job_key:job_key,k:k})};var _makeWorker=function(){if(_worker){TS.error("_makeWorker but there is a _worker");return}var LZString_url=cdn_url+"/85b8/js/libs/lz-string-1.4.4.js";var using_local_js=TS.qs_args["local_assets"]||TS.qs_args["js_path"];var is_dev=TS.boot_data.version_ts==="dev";if(using_local_js||is_dev){LZString_url=location.protocol+"//"+location.host+LZString_url}_worker=TS.utility.makeWebWorker("function() {			self.importScripts('"+LZString_url+"');			self.onmessage = function(e) {				var start = Date.now();				var result;				if (e.data.request == 'compress') {					result = LZString.compress(e.data.input)				}				var elapsed = Date.now() - start;				postMessage({					request: e.data.request,					result: result,					job_key: e.data.job_key,					k: e.data.k,					elapsed: elapsed				});			}		}",function(e){var callback=_callbacks[e.data.job_key];if(!callback){TS.error("e.data.job_key:"+e.data.job_key+" had no record in _callbacks??");return}callback(e.data.result,e.data.elapsed)})}})();(function(){"use strict";TS.registerModule("storage",{version:"0.85",msgs_version:window.boot_data&&boot_data.cache_version||"unknown_version",cache_ts_version:window.boot_data&&boot_data.cache_ts_version||"unknown_version",do_compression:!TS.model.is_our_app&&typeof window.Worker!=="undefined"&&(!window.bowser||!bowser.phantom),test:function(){return{getLocalStorage:_getLs,setLocalStorage:_setLs,getKeys:_getKeys,set:_set}},onStart:function(){TS.storage.onStart=function(){};if(TS.boot_data.page_has_incomplete_user_model){if(TS.boot_data.feature_flannel_fe)TS.log(1989,"Flannel: disabling member bot cache");TS.storage.disableMemberBotCache();TS.storage.version+="-nomemberbotcache"}if(!TS.storage.do_compression&&!TS.boot_data.feature_disable_ls_compression&&TS.boot_data.feature_force_ls_compression){TS.warn("Special case: force-enabling LS compression for this session.");TS.storage.do_compression=true}if(TS.storage.do_compression&&TS.boot_data.feature_disable_ls_compression){if(TS.pri)TS.log(488,"TS.storage: disabling compression");TS.storage.do_compression=false}TS.storage.version+=TS.storage.do_compression?"-compressed-LZString":"";var should_disable=_disabled||TS.qs_args["ls_disabled"]=="1"||!_ls||TS.boot_data&&TS.boot_data.ls_disabled||TS.boot_data&&TS.boot_data.feature_tw&&TS.boot_data.feature_tw_ls_disabled||function(){if(!TS.storage.storageAvailable()){_removeAllOurKeys();if(!TS.storage.storageAvailable()){TS.warn("TS.storage.storageAvailable() = false in onStart after flushing all our keys, so disabling");return true}}return false}();if(TS.boot_data&&TS.boot_data.feature_tw&&TS.boot_data.feature_tw_ls_disabled){TS.warn("feature_tw_ls_disabled is on: you should call TS.storage.flush() if you are working with model data. Gets will be from the buffer and Sets will not persist.")}if(TS.qs_args.feature_flannel_fe&&TS.qs_args.feature_flannel_fe==0){TS.log(1989,"Flannel: dumping LS because of feature_flannel_fe url_flag override");TS.storage.completelyEmptyAllStorageAndReset()}TS.log(488,"TS.storage.onStart should_disable:"+should_disable);TS.log(488,"TS.storage.do_compression:"+TS.storage.do_compression+" (_ls.getItem('is_compressed') == 'yes'):"+(_ls&&_ls.getItem("is_compressed")=="yes"));TS.ui.window_unloaded_sig.add(_windowUnloaded);TS.ui.window_focus_changed_sig.add(_windowBlurred);TS.storage.setDisabled(should_disable);_set("rxn_records",null)},setDisabled:function(disabled){if(_disabled==disabled)return;if(disabled||!_ls){_disabled=true;if(_ls)_removeAllOurKeys()}else{_disabled=false;_setUp()}TS.info("_disabled:"+_disabled)},storageAvailable:function(){if(!_ls)return false;try{var key="test_to_see_if_we_can_write_to_local_storage";_ls.setItem(key,"foo");_ls.removeItem(key);return true}catch(err){return false}},storageSize:function(log){var length=0;if(!_ls)return length;var keys=_getKeys();var c=0;var key;var value;for(var i=0;i<keys.length;i++){c++;key=keys[i];value=_ls.getItem(key);if(!value&&value!==""){TS.warn(key+" not measurable value, typeof:"+typeof value)}else{length+=value.length;if(log)TS.info(key+"="+(value.length*2/1024).toFixed(2)+"KB "+"(total="+(length/1024).toFixed(2)+"KB)")}}if(log)TS.info("total for "+c+" items is "+(length/1024).toFixed(2)+"KB");return length},isUsingMemberBotCache:function(){return!_user_bot_caching_disabled&&(TS.model&&TS.model.supports_user_bot_caching)},disableMemberBotCache:function(){if(TS.pri)TS.log(488,'disableMemberBotCache(): _user_bot_caching_disabled is currently "'+_user_bot_caching_disabled+'"');_user_bot_caching_disabled=true},completelyEmptyAllStorageAndResetIfTooOld:function(){if(!_isStorageTooOld())return false;TS.warn("last LS activity too old, we're purging");TS.storage.completelyEmptyAllStorageAndReset();return true},completelyEmptyAllStorageAndReset:function(){TS.info("completelyEmptyAllStorageAndReset running");_completelyEmptyAllStorage();TS.storage.storeLastEventTS("",true,true);var fetched_b4_flush=TS.storage.fetchLastEventTS(true);TS.info("completelyEmptyAllStorageAndReset fetched_b4_flush:"+fetched_b4_flush);if(fetched_b4_flush){TS.info("completelyEmptyAllStorageAndReset _getKeys:"+_getKeys().join(", "));TS.info("completelyEmptyAllStorageAndReset Object.keys(_buffer):"+Object.keys(_buffer).join(", "))}_flushBuffer(true,"completelyEmptyAllStorageAndReset");var fetched_after_flush=TS.storage.fetchLastEventTS(true);TS.info("completelyEmptyAllStorageAndReset fetched_after_flush:"+fetched_after_flush);if(fetched_after_flush){TS.info("completelyEmptyAllStorageAndReset _getKeys:"+_getKeys().join(", "));TS.info("completelyEmptyAllStorageAndReset Object.keys(_buffer):"+Object.keys(_buffer).join(", "))}},cleanOutCacheTsStorage:function(){var keys=_getKeys();TS.dir(488,keys,"_getKeys()");TS.storage.storeBots();TS.storage.storeMembers();keys=_getKeys();TS.dir(488,keys,"_getKeys()")},flush:function(also_clear_cache){TS.log(488,"TS.storage.flush()");_removeAllOurKeys();if(also_clear_cache)TS.storage.clearBufferAndCache()},clearBufferAndCache:function(){TS.log(488,"TS.storage.clearBufferAndCache()");_buffer={};_ls_fetch_cache={};_last_cache_ts_possible=null;if(TS.compresion)TS.compression.terminate()},fetchLastActiveModelObId:function(){return _get("last_active_model_ob_id",undefined)},storeLastActiveModelObId:function(id){_set("last_active_model_ob_id",id||undefined,true)},fetchStorageVersion:function(){return _get("storage_version")},storeStorageVersion:function(val){_set("storage_version",val,true)},fetchCacheTSStorageVersion:function(){return _get("storage_cache_ts_version")},storeCacheTSStorageVersion:function(val){_set("storage_cache_ts_version",val,true)},_makeMsgInputId:function(id){return"msg_input_"+id},fetchLastMsgInput:function(id){return _get(TS.storage._makeMsgInputId(id),null)},storeLastMsgInput:function(id,txt){_set(TS.storage._makeMsgInputId(id),txt)},_makeCommentInputId:function(id){return"comment_input_"+id},fetchLastCommentInput:function(id){return _get(TS.storage._makeCommentInputId(id),null)},storeLastCommentInput:function(id,txt){_set(TS.storage._makeCommentInputId(id),txt)},fetchOldestTs:function(id){return _get(_makeOldestTsId(id),null)},storeOldestTs:function(id,ts){_set(_makeOldestTsId(id),ts);return},fetchActiveHistory:function(){return _get("active_history",[])||[]},storeActiveHistory:function(history){_set("active_history",history,true)},fetchLastEventTS:function(log){return _get("last_event_ts","",log)||""},storeLastEventTS:function(ts,immediate,log){_set("last_event_ts",ts,immediate,log)},fetchUIState:function(){return _get("ui_state",{})||{}},storeUIState:function(state){_set("ui_state",state)},fetchExpandableState:function(){return _get("expandable_state",{})||{}},storeExpandableState:function(state){_set("expandable_state",state)},fetchClientWindows:function(){return _get("client_windows",{})||{}},storeClientWindows:function(wins){_set("client_windows",wins)},fetchInputHistory:function(){var A=_get("input_history",[])||[];if(typeof A==="string")A=[A];var max=300;if(A.length>max)A.length=max;return A},storeInputHistory:function(history){_set("input_history",history)},fetchCustomEmoji:function(){return _get("custom_emoji",null)||null},storeCustomEmoji:function(val){_set("custom_emoji",val)},fetchEmojiUse:function(){return _get("emoji_use",{})||{}},storeEmojiUse:function(val){_set("emoji_use",val)},fetchApps:function(){return _get("apps",null)||null},storeApps:function(val){_set("apps",val)},fetchAppsSearchResults:function(){return _get("apps_search",null)||null},storeAppsSearchResults:function(val){_set("apps_search",val)},fetchCmds:function(){return _get("cmds",null)||null},storeCmds:function(val){_set("cmds",val)},fetchChannelPageState:function(){return _get("channel_page_state",{})||{}},storeChannelPageState:function(state){_set("channel_page_state",state)},fetchInvitesState:function(){return _get("invites_state",[])||[]},storeInvitesState:function(state){_set("invites_state",state)},fetchReplyInput:function(model_ob_id,thread_ts){var inputs=_get("reply_inputs")||[];var prev_input=_.find(inputs,{model_ob_id:model_ob_id,thread_ts:thread_ts});return prev_input?prev_input.text:""},storeReplyInput:function(model_ob_id,thread_ts,text){var max_saved_inputs=10;var inputs=_get("reply_inputs")||[];inputs=_.reject(inputs,{model_ob_id:model_ob_id,thread_ts:thread_ts});if(inputs.length>max_saved_inputs){inputs.shift()}inputs.push({model_ob_id:model_ob_id,thread_ts:thread_ts,text:text});_set("reply_inputs",inputs)},fetchFilterState:function(){return _get("team_filter_state","")||""},storeFilterState:function(state){_set("team_filter_state",state)},fetchCallsState:function(){return _get("calls_state",{})||{}},storeCallsState:function(state){_set("calls_state",state)},fetchMembers:function(){if(!TS.storage.isUsingMemberBotCache()){return[]}var members_data=_get("members_data");if(!members_data)return[];return members_data.members||[]},storeMembers:function(members){if(!TS.storage.isUsingMemberBotCache()){members=[]}_set("last_cache_ts",null,true);var members_data=members?{members:members,cache_ts:_last_cache_ts_possible}:null;_set("members_data",members_data)},fetchBots:function(){if(!TS.storage.isUsingMemberBotCache())return[];var bots_data=_get("bots_data");if(!bots_data)return[];return bots_data.bots||[]},storeBots:function(bots){if(!TS.storage.isUsingMemberBotCache()){bots=[]}_set("last_cache_ts",null,true);var bots_data=bots?{bots:bots,cache_ts:_last_cache_ts_possible}:null;_set("bots_data",bots_data)},rememberLastCacheTS:function(ts){if(!TS.storage.isUsingMemberBotCache()){if(TS.pri&&ts)TS.log(488,"rememberLastCacheTS: Exiting because isUsingMemberBotCache() returned false.");return}if(!ts)return;if(_last_cache_ts_possible&&ts<=_last_cache_ts_possible){if(TS.pri)TS.log(488,"rememberLastCacheTS: provided ts of "+ts+" <= _last_cache_ts_possible of "+_last_cache_ts_possible+" - exiting.");return}if(TS.pri)TS.log(488,"rememberLastCacheTS("+ts+")");_last_cache_ts_possible=ts},fetchLastCacheTS:function(){var last_possible=parseInt(_last_cache_ts_possible,10)||0;if(!TS.storage.isUsingMemberBotCache()){if(last_possible){TS.warn("fetchLastCacheTS: isUsingMemberBotCache() = false, but returning last_possible of "+last_possible+" instead of 0.");return last_possible}if(TS.pri)TS.log(488,"fetchLastCacheTS: returning 0 because isUsingMemberBotCache() returned false, and no last_possible from _last_cache_ts_possible.",last_possible,_last_cache_ts_possible);return 0}var ls_result=parseInt(_get("last_cache_ts"),10)||0;var result=ls_result||last_possible;if(TS.pri)TS.log(488,'fetchLastCacheTS: _get returned "'+ls_result+'", last_possible = "'+last_possible+'" - returning "'+result+'"');return result},fetchFrecency:function(namespace){return _get("frecency_"+namespace)},storeFrecency:function(namespace,data){_set("frecency_"+namespace,data)},clearFrecency:function(namespace){_set("frecency_"+namespace,"")},fetchEnterpriseState:function(){return _get("enterprise_state",{})||{}},storeEnterpriseState:function(state){_set("enterprise_state",state)}});var _prefix=window.boot_data.user_id+"_";var _msgs_id_part="channel_msgs_";var _oldest_ts_part="oldest_msg_ts_";var _makeOldestTsId=function(id){return _oldest_ts_part+id};var _disabled;var _user_bot_caching_disabled=false;var _immediate_saves=false;var _last_cache_ts_possible=null;var _buffer={};var _ls_fetch_cache={};var _slow_get_threshold=1e3;var _slow_get_logged=false;var _slow_set_threshold=1e3;var _slow_set_logged=false;var _slow_write_threshold=1e3;var _slow_write_logged=false;var _slow_all_write_logged=false;var _flush_all_buffer_interv=null;var _flush_all_buffer_interv_ms=2e3;var _flush_all_buffer_user_inactive_ms=1e4;var _flush_one_buffer_user_inactive_ms=1e3;var _getKeys=function(){var A=[];if(!_ls)return A;var len=_ls.length;if(!len)return A;for(var i=0;i<len;i++){A.push(_ls.key(i))}return A};var _setUp=function(){var keys;if(!_disabled){var temp_storage_version=TS.storage.fetchStorageVersion()||"";var is_compressed=temp_storage_version.indexOf("-compressed")!=-1||_ls.getItem("is_compressed")=="yes";if(TS.storage.do_compression&&!is_compressed){TS.warn("migrating to compressed format");keys=_getKeys();keys.forEach(function(k){var name=k.replace(_prefix,"");var val=_convertTypeForFetch(k,_ls.getItem(k));var log_string="converting: "+k+" -> "+name+" val.length: "+(val===undefined||val===null?-1:String(val).length);_set(name,null);_set(name,val);if(_get(name)==val){TS.log(488,log_string+" SUCCESS _get(name) has a value:"+!!_get(name)+", and it it the same as val")}else{TS.error(log_string+" FAILURE _get(name) !== val")}});TS.warn("migration to compressed format complete, "+keys.length+" migrated");TS.storage.storeStorageVersion(TS.storage.version)}else{TS.log(488,"no migration needed")}_ls.setItem("is_compressed",TS.storage.do_compression?"yes":"no")}var storage_cache_ts_version=TS.storage.fetchCacheTSStorageVersion();TS.log(488,"TS.storage.cache_ts_version:"+TS.storage.cache_ts_version);TS.log(488,"storage_cache_ts_version:"+storage_cache_ts_version);var storage_version=TS.storage.fetchStorageVersion()||"";TS.log(488,"TS.storage.version:"+TS.storage.version);TS.log(488,"storage_version:"+storage_version);TS.log(488,"TS.storage last_unload_flushing: "+_get("last_unload_flushing"));TS.log(488,"TS.storage.storageAvailable(): "+TS.storage.storageAvailable());keys=_getKeys();TS.dir(488,keys,"_getKeys()");if(!TS.storage.storageAvailable()){TS.warn("TS.storage.storageAvailable() = false so flushing all our keys");_removeAllOurKeys()}else if(storage_version!=TS.storage.version){TS.warn("storage_version:"+storage_version+" does not match TS.storage.version:"+TS.storage.version+" so flushing all our keys: "+keys.join(", "));_removeAllOurKeys()}else if(!TS.storage.fetchLastEventTS()){TS.warn("TS.storage.fetchLastEventTS() is empty so flushing channel data");_completelyEmptyAllStorage()}else if(storage_cache_ts_version!=TS.storage.cache_ts_version){TS.warn("storage_cache_ts_version:"+storage_cache_ts_version+" does not match TS.storage.cache_ts_version:"+TS.storage.cache_ts_version+" so flushing user/bot data");TS.storage.cleanOutCacheTsStorage()}TS.storage.storeStorageVersion(TS.storage.version);TS.storage.storeCacheTSStorageVersion(TS.storage.cache_ts_version);TS.ms.connected_sig.addOnce(_flushAllBufferOnIdleTimer)};var _removeAllOurKeys=function(){_getKeys().forEach(function(key){if(key.indexOf(_prefix)===0)_ls.removeItem(key)})};var _isStorageTooOld=function(){var last_event_ts=TS.storage.fetchLastEventTS();var last_ts=last_event_ts;if(last_ts){var last_date=TS.utility.date.toDateObject(last_ts);var elapsed=Date.now()-last_date;var limit_ms=3*864e5;if(elapsed>limit_ms){return true}}return false};var _completelyEmptyAllStorage=function(){var keys=_getKeys();TS.log(488,keys,"_getKeys()");var key;for(var i=0;i<keys.length;i++){key=keys[i];if(key.indexOf(_prefix)!==0)continue;if(key.indexOf(_msgs_id_part)==-1&&key.indexOf(_oldest_ts_part)==-1)continue;_ls.removeItem(key);delete _buffer[key];TS.warn("_ls.removeItem:"+key)}for(key in _buffer){if(key.indexOf(_prefix)!==0)continue;if(key.indexOf(_msgs_id_part)==-1&&key.indexOf(_oldest_ts_part)==-1)continue;delete _buffer[key];TS.warn("delete _buffer:"+key)}_ls_fetch_cache={};keys=_getKeys();TS.dir(488,keys,"_getKeys()")};var _windowUnloaded=function(){_immediate_saves=true;_set("last_unload_flushing",(new Date).toString(),true);_flushBuffer(true,"_windowUnloaded");TS.compression.terminate()};var _windowBlurred=function(){_flushBuffer(true,"_windowBlurred")};var _flushAllBufferOnIdleTimer=function(){if(_flush_all_buffer_interv){window.clearInterval(_flush_all_buffer_interv);_flush_all_buffer_interv=null}_flush_all_buffer_interv=window.setInterval(_maybeFlushBuffer,_flush_all_buffer_interv_ms)};var _maybeFlushBuffer=function(){if(!TS.model)return;var buffer_count=Object.keys(_buffer).length;if(!buffer_count)return;var ok_to_flush_all=false;var ok_to_flush_why="";if(!TS.model.ui.is_window_focused){ok_to_flush_why="window blurred!";ok_to_flush_all=true}var ms_since_activity=Date.now()-TS.model.client.last_user_active_timestamp;if(!ok_to_flush_all){if(ms_since_activity>=_flush_all_buffer_user_inactive_ms){ok_to_flush_why="window focused, but user has been idle long enough "+ms_since_activity+" >= "+_flush_all_buffer_user_inactive_ms;ok_to_flush_all=true}}TS.log(488,"_maybeFlushBuffer ok_to_flush_all:"+ok_to_flush_all);if(ok_to_flush_all){_flushBuffer(true,"maybeFlushBuffer ("+buffer_count+") "+ok_to_flush_why);return}var ok_to_flush_some=ms_since_activity>_flush_one_buffer_user_inactive_ms;TS.log(488,"_maybeFlushBuffer ok_to_flush_some:"+ok_to_flush_some);ok_to_flush_why="window focused, but user has been idle long enough "+ms_since_activity+" >= "+_flush_one_buffer_user_inactive_ms;if(ok_to_flush_some){_flushBuffer(false,"maybeFlushBuffer ("+buffer_count+") "+ok_to_flush_why)}};var _prepareValForStorage=function(val){return typeof val=="string"||typeof val=="number"||!val?val:JSON.stringify(val)};var _correctBadValsFromStorage=function(val){if(val=="undefined")return null;if(val=="null")return null;return val};var _flushBuffer=function(all,why){if(_disabled)return;var begin=new Date;var start=Date.now();var duration;var i=0;var k;var do_log=TS.model&&TS.model.team&&TS.model.team.domain&&TS.boot_data.feature_tinyspeck;var elapsed;var storage_size;var debug_time;var val;for(k in _buffer){if(_buffer[k].being_flushed)continue;val=_prepareValForStorage(_buffer[k].val);if(val===undefined||val===null){_ls.removeItem(k);delete _buffer[k];delete _ls_fetch_cache[k]}else{try{_compressAndStore(k,val)}catch(err){TS.warn("_flushBuffer _ls.setItem failed once, flushing all our keys. TS.storage.storageSize():"+TS.storage.storageSize(false));TS.error(0,err);_removeAllOurKeys();delete _buffer[k];delete _ls_fetch_cache[k];continue}}i++;duration=Date.now()-start;if(do_log){TS.log(488,"_flushBuffer _ls.setItem "+k+": "+duration+"ms "+(_buffer[k]&&_buffer[k].val&&_buffer[k].val.toString?_buffer[k].val.toString().substr(0,100):"NULL?"))}if(!all){elapsed=new Date-begin;if(!_slow_write_logged&&elapsed>_slow_write_threshold){_slow_write_logged=true;debug_time=new Date;try{storage_size=TS.storage.storageSize()}catch(err){}debug_time=new Date-debug_time;var message="Took "+elapsed+"ms for "+i+" item (!all case) (threshold is "+_slow_write_threshold+" ms). Key: "+k+". Buffer length: "+(_buffer[k]&&_buffer[k].val&&_buffer[k].val.toString()?_buffer[k].val.toString().length:"unknown (not a string)")+". localStorage size: "+(storage_size||"unknown")+". Time to read LS size: "+debug_time;TS.info("_flushBuffer exceeded slow write threshold: "+message)}}if(_buffer[k]){_buffer[k].being_flushed=true}if(!all){TS.log(488,"_flushBuffer: Wrote one item. why: "+why);return}_ls_fetch_cache={}}if(i&&!_slow_all_write_logged){elapsed=new Date-begin;if(elapsed>_slow_write_threshold){_slow_all_write_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}var message="Took "+elapsed+"ms for "+i+" items (threshold is "+_slow_write_threshold+" ms). localStorage size: "+storage_size+". App open for "+((new Date-TSConnLogger.start_time)/1e3/60).toFixed(2)+" min. why: "+why;TS.info("_flushBuffer exceeded slow write threshold (all case): "+message)}}if(i===0){TS.log(488,"_flushBuffer: Nothing to save.")}else{TS.log(488,"_flushBuffer: Saved "+i+(i===1?" item":" items")+" why: "+why)}};var _get=function(name,default_value,log){var k=_prefix+name;if(log)TS.info("_get name:"+name+" k:"+k+" disabled:"+_disabled+' _buffer["'+k+'"].val:'+(_buffer[k]&&_buffer[k].val));if(_disabled){return _buffer[k]&&_buffer[k].val||default_value}if(k in _buffer){return _buffer[k]&&_buffer[k].val||default_value}if(_ls_fetch_cache.hasOwnProperty(k)){return _ls_fetch_cache[k]}var result=_convertTypeForFetch(k,_decompress(k,_ls.getItem(k)),default_value,log);_ls_fetch_cache[k]=result;return result};var _convertTypeForFetch=function(k,val,default_value,log){var elapsed=new Date;var result=_correctBadValsFromStorage(val);if(log)TS.info("_get _correctBadValsFromStorage(_ls.getItem(k)) k:"+k+" typeof result:"+typeof result+" /^[{[]/.test(result):"+/^[{[]/.test(result));var storage_size;if(result&&typeof result=="string"&&/^[{[]/.test(result)){result=TS.utility.parseJSONOrElse(result)||result}result=result||(default_value!==undefined?default_value:null);elapsed=new Date-elapsed;if(!_slow_get_logged&&elapsed>_slow_get_threshold){_slow_get_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}var message="_get took longer than threshold: Took "+elapsed+"ms to read "+k+" (theshold is "+_slow_get_threshold+"ms), length = "+(result&&!isNaN(result.length)?result.length:"unknown")+". Storage size: "+storage_size;TS.info(message)}return result};var _set=function(name,value,immediate,log){var failed=false;var elapsed=new Date;var storage_size;var k=_prefix+name;_buffer[k]={val:value,being_flushed:false};_ls_fetch_cache[k]=_buffer[k].val;if(log)TS.info("_set immediate:"+immediate+" name:"+name+" k:"+k+" disabled:"+_disabled+" do_compression:"+TS.storage.do_compression+' _buffer["'+k+'"].val:'+_buffer[k].val);if(immediate){if(!_disabled){var val=_prepareValForStorage(value);if(val===undefined||val===null){_ls.removeItem(k);delete _buffer[k]}else{try{_compressAndStore(k,val,immediate)}catch(err){TS.warn("_set _ls.setItem failed, flushing. TS.storage.storageSize():"+TS.storage.storageSize(false));failed=true}}}if(log)TS.info("_set failed:"+failed);if(!failed){if(log)TS.info('_set _buffer["'+k+'"]:'+(_buffer[k]&&JSON.stringify(_buffer[k])));elapsed=new Date-elapsed;if(elapsed>_slow_set_threshold){TS.warn("_set immediately "+name+": "+elapsed+"ms "+(value&&value.toString?value.toString().substr(0,100):"NULL?"));if(!_slow_set_logged){_slow_set_logged=true;try{storage_size=TS.storage.storageSize()}catch(err){}var message="_set exceeded slow set threshold (immediate): Took "+elapsed+"ms to write "+k+" (theshold is "+_slow_set_threshold+"ms), length = "+(value&&!isNaN(value.length)?value.length:"unknown")+". Storage length: "+storage_size;TS.info(message)}}else{TS.log(488,"_set GOOD immediately: "+immediate+" "+name+": "+elapsed+"ms",value)}return}}};var _calcLastCacheTS=function(){var k=_prefix+"bots_data";var bots_data_raw=_ls.getItem(k);var bots_data=bots_data_raw&&JSON.parse(_correctBadValsFromStorage(_decompress(k,bots_data_raw)))||null;var k=_prefix+"members_data";var members_data_raw=_ls.getItem(k);var members_data=members_data_raw&&JSON.parse(_correctBadValsFromStorage(_decompress(k,members_data_raw)))||null;if(!TS.model.bots.length&&members_data&&members_data.cache_ts){if(TS.pri)TS.log(488,"_calcLastCacheTS: no TS.model.bots.length, but we have members_data && members_data.cache_ts = "+members_data.cache_ts);return members_data.cache_ts}else if(bots_data&&bots_data.cache_ts&&members_data&&members_data.cache_ts){if(TS.pri)TS.log(488,"_calcLastCacheTS: bots_data && members_data && both have cache_ts, returning the lesser of "+bots_data.cache_ts+" and "+members_data.cache_ts);return bots_data.cache_ts<members_data.cache_ts?bots_data.cache_ts:members_data.cache_ts}else{if(TS.pri)TS.log(488,"_calcLastCacheTS: WTF maybe no members or bots data at all? Returning 0",members_data,bots_data);return 0}};var _storeLastCacheTS=function(){if(!TS.storage.isUsingMemberBotCache()){if(TS.pri)TS.log(488,"_storeLastCacheTS(): Exiting because isUsingMemberBotCache() returned false.");return}var last_cache_ts=_calcLastCacheTS();TS.log(488,"setting last_cache_ts from _calcLastCacheTS(): "+last_cache_ts);_set("last_cache_ts",last_cache_ts,true)};var _using_macgap_ls=!!(window.macgap&&macgap.ls);var _ls=_using_macgap_ls?macgap.ls:window.localStorage;var _getLs=function(){return _ls};var _setLs=function(ls){_ls=ls};var _compressAndStore=function(k,str,immediate){str=String(str);if(TS.storage.do_compression){TS.compression.compress(k,str,immediate||_immediate_saves,_afterCompress);return}_afterCompress({k:k,str:str})};var _afterCompress=function(ob){_ls.setItem(ob.k,ob.str);var testAndFinishOrTryAgain=function(i){var from_ls=_ls.getItem(ob.k);if(from_ls===ob.str){if(i>1)TS.warn(ob.k+" now saved, try #"+i);delete _buffer[ob.k];delete _ls_fetch_cache[ob.k];var name=ob.k.replace(_prefix,"");if(name=="bots_data"||name=="members_data"){_storeLastCacheTS()}return}if(i>1&&(!_buffer[ob.k]||_buffer[ob.k].val!=ob.str)){TS.error("buffer changed for "+ob.k+" so we don't care anymore, a new value is being set for it, try #"+i);return}else{TS.error("WTF not saved, try #"+i+" "+ob.k+" "+(ob.str||"").length+" typeof ob.str:"+typeof ob.str+" from_ls:"+typeof from_ls);_ls.setItem(ob.k,ob.str);setTimeout(testAndFinishOrTryAgain,1e3,i+1)}};testAndFinishOrTryAgain(1)};var _decompress=function(k,str){if(!TS.storage.do_compression){return str}var start=Date.now();if(str)str=LZString.decompress(str);var elapsed=Date.now()-start;if(str)TS.log(488,k+" took "+elapsed+"ms to _decompress str.length: "+str.length);return str}})();(function(){"use strict";TS.registerModule("api.connection",{onStart:function(){_should_send_timing_data=TS.qs_args["api_timings"]||TS.utility.enableFeatureForUser(_timing_percentage)},test:function(){var test_ob={};Object.defineProperty(test_ob,"_should_send_timing_data",{get:function(){return _should_send_timing_data},set:function(v){_should_send_timing_data=v}});return test_ob},waitForAPIConnection:function(){var retry_interval=arguments.length<=0||arguments[0]===undefined?1e3:arguments[0];var max_retries=arguments[1];var connection_timeout_ms=6e4;var retry_attempts=0;var retry_interval_value=typeof retry_interval=="function"?retry_interval():retry_interval;var retry_interval_ms=retry_interval_value;var _retryLater=function(jq_xhr,text_status,error_msg){if(typeof max_retries=="number"&&retry_attempts>max_retries){TS.warn("Unable to reconnect to the API after "+retry_attempts+" retry attempts");failure_sig.dispatch();return}var info=retry_attempts?"Internet connection still offline after "+retry_attempts+" retry attempts":"Internet connection still offline";TS.warn([info,text_status,error_msg].join(" "));retry_attempts++;setTimeout(_testConnection,retry_interval_ms)};var _onSuccess=function(){if(_should_send_timing_data)var offline_duration_ms=TS.metrics.measureAndClear("api_offline_duration","api_connectivity_lost");var offline_duration_s=_.round(offline_duration_ms/1e3,2);var message=retry_attempts?"Internet connection has been re-established after "+retry_attempts+" retry attempts;":"Internet connection has been re-established";var info=[message,"offline for "+offline_duration_s+" seconds"];TS.info(info.join(" "));success_sig.dispatch()};var _testConnection=function(){$.ajax({url:TS.model.api_url+"api.test",timeout:connection_timeout_ms}).then(function(data,status,resp){if(data&&data.ok){_onSuccess()}else{_retryLater();
}}).fail(_retryLater)};var success_sig=new signals.Signal;var failure_sig=new signals.Signal;if(_should_send_timing_data)TS.metrics.mark("api_connectivity_lost");return new Promise(function(resolve,reject){success_sig.addOnce(resolve);failure_sig.addOnce(reject);_testConnection()})},waitForMSToReconnect:function(){return new Promise(function(resolve,reject){var ms_asleep=TS.model.ms_asleep;var ms_connected=TS.model.ms_connected;var calling_rtm_start=TS.model.calling_rtm_start;var calling_test_fast_reconnect=TS.model.calling_test_fast_reconnect;var should_reconnect=!ms_connected&&!calling_rtm_start&&!calling_test_fast_reconnect;var info=["API paused? "+TS.api.isPaused(),"MS asleep? "+ms_asleep,"MS connected? "+ms_connected,"Starting RTM? "+calling_rtm_start,"Attempting fast reconnect? "+calling_test_fast_reconnect];TS.info("Re-establishing the MS connection. Current state: "+info.join(", "));if(ms_connected){TS.info("MS is already connected");resolve();return}if(calling_rtm_start){TS.info("MS not connected, proceeding with rtm.start");resolve();return}if(calling_test_fast_reconnect){TS.info("MS not connected, proceeding with a fast reconnect");resolve();return}if(should_reconnect){TS.info("MS not connected, listening for the connected signal");TS.ms.connected_sig.addOnce(resolve);if(ms_asleep){if(_should_send_timing_data)TS.metrics.count("ms_should_wake_up_from_sleep");TS.info("Trying to wake up the MS up.");TS.ms.wake()}else{TS.info("Restarting MS connection");TS.ms.startReconnectionImmediately()}}})}});var _timing_percentage=1;var _should_send_timing_data})();(function(){"use strict";TS.registerModule("api",{paused_sig:new signals.Signal,unpaused_sig:new signals.Signal,Q_empty_sig:new signals.Signal,onStart:function(){if(TS.boot_data.feature_name_tagging_client){var name_tagging_arg_methods=["channels.view","rtm.leanStart","rtm.start","users.info","users.list"];_.forEach(name_tagging_arg_methods,function(method){_default_api_args_by_method[method]={name_tagging:true}})}if(TS.boot_data.feature_canonical_avatars_web_client){var canonical_avatars_arg_methods=["channels.view","rtm.leanStart","rtm.start","users.info","users.list"];_.forEach(canonical_avatars_arg_methods,function(method){_default_api_args_by_method[method]={canonical_avatars:true}})}if(TS.boot_data.feature_message_replies){_ensure_model_methodsA.push("channels.replies");_ensure_model_methodsA.push("groups.replies");_ensure_model_methodsA.push("im.replies");_ensure_model_methodsA.push("subscriptions.thread.getView")}},test:function(){var test_ob={_one_at_a_time_methodsA:_one_at_a_time_methodsA,_ensure_model_methodsA:_ensure_model_methodsA,_pause:_pause,_unPause:_unPause,_pauseUntilAPIConnectionRestored:_pauseUntilAPIConnectionRestored,_promisify:_promisify,_getMaxAttempts:_getMaxAttempts,_incrementPending:_incrementPending,_decrementPending:_decrementPending,_getDefaultArgsByMethodName:_getDefaultArgsByMethodName,_kickOffACallOrEnqueue:_kickOffACallOrEnqueue,_callOutsideHandler:_callOutsideHandler,_nextFromQ:_nextFromQ,_reQueue:_reQueue,_calculateHTTPErrorDelayMs:_calculateHTTPErrorDelayMs,_makeLogSafeMethodName:_makeLogSafeMethodName,_logError:_logError,_getAPIErrorObject:_getAPIErrorObject,_maybeShowConnectivityWarning:_maybeShowConnectivityWarning,_one_at_a_time_Q:_one_at_a_time_Q};Object.defineProperty(test_ob,"_pauseFor",{get:function(){return _pauseFor},set:function(v){_pauseFor=v}});Object.defineProperty(test_ob,"_pauseUntilBackOnline",{get:function(){return _pauseUntilBackOnline},set:function(v){_pauseUntilBackOnline=v}});Object.defineProperty(test_ob,"_pauseUntilServiceIsUp",{get:function(){return _pauseUntilServiceIsUp},set:function(v){_pauseUntilServiceIsUp=v}});Object.defineProperty(test_ob,"_one_at_a_time_call_pending",{get:function(){return _one_at_a_time_call_pending},set:function(v){_one_at_a_time_call_pending=v}});Object.defineProperty(test_ob,"_is_paused",{get:function(){return _is_paused},set:function(v){_is_paused=v}});Object.defineProperty(test_ob,"_ensure_model_methodsA",{get:function(){return _ensure_model_methodsA},set:function(v){_ensure_model_methodsA=v}});Object.defineProperty(test_ob,"_one_at_a_time_methodsA",{get:function(){return _one_at_a_time_methodsA},set:function(v){_one_at_a_time_methodsA=v}});Object.defineProperty(test_ob,"_max_attempts",{get:function(){return _max_attempts}});Object.defineProperty(test_ob,"_pending",{get:function(){return _pending},set:function(v){_pending=v}});Object.defineProperty(test_ob,"_pause_secs",{get:function(){return _pause_secs},set:function(v){_pause_secs=v}});Object.defineProperty(test_ob,"_maybeTimingClearMarks",{get:function(){return _maybeTimingClearMarks},set:function(v){_maybeTimingClearMarks=v}});Object.defineProperty(test_ob,"_maybeTimingCount",{get:function(){return _maybeTimingCount},set:function(v){_maybeTimingCount=v}});Object.defineProperty(test_ob,"_maybeTimingMark",{get:function(){return _maybeTimingMark},set:function(v){_maybeTimingMark=v}});Object.defineProperty(test_ob,"_maybeTimingMeasure",{get:function(){return _maybeTimingMeasure},set:function(v){_maybeTimingMeasure=v}});Object.defineProperty(test_ob,"_maybeShowConnectivityWarning",{get:function(){return _maybeShowConnectivityWarning},set:function(v){_maybeShowConnectivityWarning=v}});Object.defineProperty(test_ob,"_default_api_args",{get:function(){return _default_api_args},set:function(v){_default_api_args=v}});Object.defineProperty(test_ob,"_default_api_args_by_method",{get:function(){return _default_api_args_by_method},set:function(v){_default_api_args_by_method=v}});Object.defineProperty(test_ob,"_kickOffACall",{get:function(){return _kickOffACall},set:function(v){_kickOffACall=v}});Object.defineProperty(test_ob,"_kickOffACallOrEnqueue",{get:function(){return _kickOffACallOrEnqueue},set:function(v){_kickOffACallOrEnqueue=v}});Object.defineProperty(test_ob,"_last_connectivity_warning_time",{get:function(){return _last_connectivity_warning_time},set:function(v){_last_connectivity_warning_time=v}});Object.defineProperty(test_ob,"_api_queue_depth_warning_threshold",{get:function(){return _api_queue_depth_warning_threshold},set:function(v){_api_queue_depth_warning_threshold=v}});Object.defineProperty(test_ob,"_main_Q",{get:function(){return _main_Q},set:function(v){_main_Q=v}});Object.defineProperty(test_ob,"_one_at_a_time_Q",{get:function(){return _one_at_a_time_Q},set:function(v){_one_at_a_time_Q=v}});Object.defineProperty(test_ob,"_makeRequest",{get:function(){return _makeRequest},set:function(v){_makeRequest=v}});return test_ob},call:function(method,args,handler,dont_set_active,progressHandler){return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler)},callImmediately:function(method,args,handler,dont_set_active,progressHandler){var top_of_Q=true;if(_one_at_a_time_methodsA.indexOf(method)!=-1){if(_one_at_a_time_call_pending){TS.warn(method+" cannot be called with TS.api.callImmediately because a one-at-a-time call is already pending, so sending to _kickOffACallOrEnqueue for enqueuing");return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler,top_of_Q)}}if(_is_paused){TS.warn(method+" cannot be called with TS.api.callImmediately because we are waiting due to a non-200 response, so sending to _kickOffACallOrEnqueue for enqueuing");return _kickOffACallOrEnqueue(method,args,handler,dont_set_active,progressHandler,top_of_Q)}args=args||{};var p=_promisify(method,handler);return _kickOffACall(method,args,p,dont_set_active,progressHandler)},callSynchronously:function(method,args,handler,dont_set_active,progressHandler){args=args||{};args._synchronously=true;return TS.api.callImmediately(method,args,handler,dont_set_active,progressHandler)},debugGetCounts:function(){return{_method_call_counts:_method_call_counts,_pending:_pending}},hasPendingRequests:function(){return!!_pending},getQLengths:function(){return{_main_Q:_main_Q.length,_one_at_a_time_Q:_one_at_a_time_Q.length}},isPaused:function(){return _is_paused},callFuncWhenApiQisEmpty:function(func){if(TS.api.hasPendingRequests()){if(!TS.api.Q_empty_sig.has(func)){TS.api.Q_empty_sig.addOnce(func)}}else{func()}},debugShowStatus:function(){console.group("TS.api status");if(_is_paused){if(_pause_secs){console.log("API calls are paused for "+_pause_secs+"more seconds")}else{console.log("API calls are paused.")}}else{console.log("API calls are NOT paused")}console.warn("Pending count is "+_pending+", main queue length is "+_main_Q.length+", and one-at-a-time queue length is "+_one_at_a_time_Q.length);if(_method_call_counts.total_asks==_method_call_counts.total_attempts){console.log("Total API calls made (there have been no retries): "+_method_call_counts.total_asks)}else{console.log("Total API calls made (not including retries): "+_method_call_counts.total_asks);console.log("Total API calls made (including retries): "+_method_call_counts.total_attempts)}if(_method_call_counts.total_non_200s){console.warn("Total non-200 API responses: "+_method_call_counts.total_non_200s)}else{console.log("No non-200 API responses")}console.groupEnd("TS.api status")},debugShowQueue:function(){_.forEach({main:_main_Q,"one-at-a-time":_one_at_a_time_Q},function(queue,queue_name){console.group("TS.api "+queue_name+" queue");if(queue.length){queue.forEach(function(pending_call){console.log(pending_call.method,pending_call.args)})}else{console.log("Nothing pending in "+queue_name+" queue")}console.groupEnd("TS.api "+queue_name+" queue")})},debugSetPaused:function(paused){var debug_pause_secs=100;if(paused){_pause({reason:{DEBUG:true},retry_after:debug_pause_secs*1e3});console.log("API calls are now paused for",debug_pause_secs,"seconds")}else{_unPause();console.log("API calls are now unpaused")}},runNextFromQueue:function(){if(_is_paused){TS.info("Calls are paused, so runNextFromQueue doing anything");return}TS.info("Running next from queue");_nextFromQ()}});var _default_api_args={};var _default_api_args_by_method={};var _ensure_model_methodsA=["activity.mentions","stars.list","files.list","files.info","search.messages","search.files","channels.history","groups.history","im.history","mpim.history","channels.listShared","groups.listShared","unread.history"];var _timing_methodsA=["rtm.start","rtm.leanStart","files.list"];var _progress_check_methodsA=["rtm.start","rtm.leanStart","activity.mentions","stars.list","files.list","files.info","apps.list","commands.list","channels.list","emoji.list","help.issues.list","subteams.list","subteams.users.list","rtm.checkFastReconnect"];var _one_at_a_time_methodsA=["users.prefs.set","rtm.start","rtm.leanStart","rtm.checkFastReconnect","enterprise.setPhoto"];var _no_retry_methodsA=["dnd.teamInfo","screenhero.rooms.create","screenhero.rooms.join","screenhero.rooms.refreshToken","screenhero.rooms.invite"];var _no_token=["api.test","auth.emailToken","auth.findTeam","auth.findUser","auth.loginMagic","auth.signin","enterprise.signup.complete","enterprise.signup.checkDomain","enterprise.signup.checkPassword","helpdesk.get","search.apps","signup.addLead","team.checkEmailDomains","test.versionInfo","oauth.access"];var _pending=0;var _main_Q=[];var _one_at_a_time_call_pending=false;var _one_at_a_time_Q=[];var _limit=4;var _is_paused=false;var _pause_secs=0;var _pause_interv;var _max_attempts=10;var _timeout_ms=6e4;var _timeout_breathing_room_ms=5e3;var _successful_breathing_ms=100;var _method_call_counts={total_asks:0,total_attempts:0,total_non_200s:0};var _consecutive_errors=0;var _getMaxAttempts=function(method){if(method=="rtm.start")return 2;if(method=="rtm.leanStart")return 2;if(method=="rtm.checkFastReconnect")return 2;return _max_attempts};var _exceededMaxConsecutiveErrors=function(method,attempts){var max_attempts=_getMaxAttempts(method);if(method=="rtm.start"&&attempts>=max_attempts)return true;if(method=="rtm.leanStart"&&attempts>=max_attempts)return true;if(method=="rtm.checkFastReconnect"&&attempts>=max_attempts)return true;if(_consecutive_errors>=4)return true};var _incrementPending=function(method){_pending++;if(_pending>=10){_maybeTimingCount("ts_api_pending_10plus")}else if(_pending>=5){_maybeTimingCount("ts_api_pending_5plus")}else if(_pending>=3){_maybeTimingCount("ts_api_pending_3plus")}else if(_pending==2){_maybeTimingCount("ts_api_pending_2")}else if(_pending==1){_maybeTimingCount("ts_api_pending_1")}if(_one_at_a_time_methodsA.indexOf(method)!=-1){_one_at_a_time_call_pending=true}};var _decrementPending=function(method){_pending--;if(_one_at_a_time_methodsA.indexOf(method)!=-1){_one_at_a_time_call_pending=false}};var _onRequestDone=function(method){_decrementPending(method);if(!_is_paused)_nextFromQ()};var _getDefaultArgsByMethodName=function(method){return _.assign({},_default_api_args,_default_api_args_by_method[method])};var _kickOffACallOrEnqueue=function(method,args,handler,dont_set_active,progressHandler,top_of_Q){if(_.isUndefined(method)){TS.error("Tried to make API call, but API method name was not specified");throw new Error("Invalid API call")}args=_.defaults(args||{},_getDefaultArgsByMethodName(method));if(method=="im.open"&&!args.team){args.team=TS.members.getExternalTeamIdForMemberById(args.user)||""}var p=_promisify(method,handler);var use_Q;if(_one_at_a_time_methodsA.indexOf(method)!=-1){if(!_is_paused&&!_one_at_a_time_call_pending){return _kickOffACall(method,args,p,dont_set_active,progressHandler)}use_Q=_one_at_a_time_Q}else{if(!_is_paused&&_pending<_limit){return _kickOffACall(method,args,p,dont_set_active,progressHandler)}use_Q=_main_Q}if(window.TSConnLogger)TSConnLogger.log("api_q_"+_makeLogSafeMethodName(method),"TS.api Qing "+method);var o={p:p,method:method,args:args,dont_set_active:dont_set_active,progressHandler:progressHandler};if(top_of_Q){use_Q.unshift(o)}else{use_Q.push(o)}if(_is_paused){_maybeTimingCount("ts_api_called_while_paused");_maybeShowConnectivityWarning()}if(use_Q==_main_Q){_maybeTimingCount("ts_api_main_queue_depth",_main_Q.length)}return p.promise};var _kickOffACall=function(method,args,p,dont_set_active,progressHandler){if(p.promise.isCancelled()){TS.log(2,method+" cancelled before call could be made in TS.api");setTimeout(_nextFromQ,1);return p.promise}if(window.TSConnLogger)TSConnLogger.log("api_call_"+_makeLogSafeMethodName(method),"TS.api calling "+method);TS.log(2,'calling method "'+method+'" args._attempts:'+args._attempts);_incrementPending(method);if(TS.boot_data.page_needs_enterprise&&args.enterprise_token&&TS.boot_data.feature_enterprise_search_ui&&!TS.model.prefs.search_only_current_team){args.token=args.enterprise_token}else{args.token=TS.model.api_token}if(!TS.client&&!dont_set_active){args.set_active=true;TS.model.last_net_send=Date.now()}var start=Date.now();var timing_ob=_startTiming(method,args);var timestamp=start/1e3;var url=TS.model.api_url+method+"?_x_id="+TS.boot_data.version_uid.substring(0,8)+"-"+timestamp;_.each(TS.qs_args,function(value,key){if(key.indexOf("feature_")==0||key.indexOf("exp_")==0){url+="&"+encodeURIComponent(key)+"="+encodeURIComponent(value)}});if((method=="rtm.start"||method=="rtm.leanStart")&&TS.client){url=TS.utility.appendLogToUrlWithLimit(url,TS.ms.getConnectionFlowLog())}if(TS.boot_data.feature_channel_eventlog_client){if(method=="channels.history"||method=="groups.history"||method=="im.history"||method=="mpim.history"){args.visible=1}}var headersHandler=function(){_logTimingForHeaders(timing_ob)};var dataHandler=function(data,request_id){var ms=Date.now()-start;if(window.TSConnLogger)TSConnLogger.log("api_complete_"+_makeLogSafeMethodName(method),"TS.api complete "+method+" (took "+ms+"ms)");TS.dir(2,{data:data,args:args},'got api rsp for method "'+method+'" (took '+ms+"ms)");data=data||{ok:false};if(data.ok){_logTimingForCompletion(timing_ob);_callOutsideHandler(method,args,data,request_id,p);return{breathing_ms:_successful_breathing_ms,try_again:false}}_cancelTiming(timing_ob);_logError(method,args,data);if(_no_retry_methodsA.indexOf(method)!=-1){TS.warn('NOT re-Qing "'+method+'", as specified');_callOutsideHandler(method,args,data,request_id,p);return{breathing_ms:_successful_breathing_ms,try_again:false}}if((data.status==429||data.status==503)&&args._attempts>=_getMaxAttempts(method)||args._synchronously){TS.warn('NOT re-Qing api call "'+method+'" because we tried too many times ('+args._attempts+")");_callOutsideHandler(method,args,data,request_id,p);return{breathing_ms:_successful_breathing_ms,try_again:false}}if(data.error=="_timeout"){return{breathing_ms:_timeout_breathing_room_ms,try_again:true}}if(data.error=="_badly_formed"){return{breathing_ms:_successful_breathing_ms,try_again:true}}if(data.error=="_http_error"){args._delay_ms=_calculateHTTPErrorDelayMs(args,data);if(data.status==0&&_exceededMaxConsecutiveErrors(method,args._attempts)){_pauseUntilBackOnline(args._attempts);return{breathing_ms:0}}else if(data.status==429){_pauseFor(args._delay_ms)}else if(data.status==503){_pauseFor(args._delay_ms)}else if(data.status>=500&&_exceededMaxConsecutiveErrors(method,args._attempts)){var retry_delay=function(){var args={};return function(){args._delay_ms=_calculateHTTPErrorDelayMs(args,data)}}();_pauseUntilServiceIsUp(retry_delay,_max_attempts,args._attempts);return{breathing_ms:0}}_method_call_counts.total_non_200s++;return{breathing_ms:args._delay_ms}}var retry=false;var retry_max_attempts=3;var retry_breathing_ms=_successful_breathing_ms;if(args._attempts<retry_max_attempts){if((method=="search.files"||method=="search.messages")&&data.error=="solr_failed"){retry=true}else if(method=="users.info"&&data.error=="user_not_found"){retry_breathing_ms=1e3*args._attempts;retry=true}}if(retry){return{breathing_ms:retry_breathing_ms,try_again:true}}_callOutsideHandler(method,args,data,request_id,p);return{breathing_ms:_successful_breathing_ms,try_again:false}};_makeRequest(url,method,args,p,headersHandler,dont_set_active,progressHandler,dataHandler);return p.promise};var _makeRequest=function(url,method,args,p,headersHandler,dont_set_active,progressHandler,dataHandler){var req=new XMLHttpRequest;var abort_on_slow_progress=_progress_check_methodsA.indexOf(method)!=-1;var progress_timer=0;if(!args._attempts){args._attempts=0;_method_call_counts.total_asks++;_method_call_counts[method]=_method_call_counts[method]?_method_call_counts[method]+1:1}args._attempts++;_method_call_counts.total_attempts++;TS.log(48,method+" count: "+_method_call_counts[method]+" (asks: "+_method_call_counts.total_asks+" attempts: "+_method_call_counts.total_attempts+")");var on200Response=function(){var data=JSON.parse(req.responseText);_consecutive_errors=0;var ret=dataHandler(data,req.getResponseHeader("X-Slack-Req-Id"));setTimeout(function(){if(ret.try_again)_reQueue(method,args,p,dont_set_active,progressHandler);_onRequestDone(method)},ret.breathing_ms)};if(TS.boot_data.feature_tinyspeck){var on200ResponseInner=on200Response;on200Response=function(){var t0=performance.now();var return_value=on200ResponseInner();var duration=performance.now()-t0;if(duration>1e3){TS.warn("Handling `"+method+"` API response took a long time ("+Math.floor(duration)+" ms)")}return return_value}}var onNon200Response=function(){if(window.TSConnLogger)TSConnLogger.log("api_non_200_"+_makeLogSafeMethodName(method),"TS.api got a "+req.status+" response for method: "+method);if((method=="rtm.start"||method=="rtm.leanStart")&&TS.ms)TS.ms.logConnectionFlow("TS.api got a "+req.status+" response for method: "+method);var data={ok:false,error:"_http_error",status:parseInt(req.status),retry_after:parseInt(req.getResponseHeader&&req.getResponseHeader("Retry-After"))};if(data.status>=500||data.status==0){_consecutive_errors++}else{_consecutive_errors=0}var ret=dataHandler(data);function retryRequest(){_reQueue(method,args,p,dont_set_active,progressHandler);_onRequestDone(method)}if(ret.try_again===false){var request_id;_callOutsideHandler(method,args,data,request_id,p);_onRequestDone(method)}else if(ret.breathing_ms){setTimeout(retryRequest,ret.breathing_ms)}else{retryRequest()}};var timeout=function(){req.onerror=_.noop;req.onreadystatechange=_.noop;req.onprogress=_.noop;req.abort();setProgressTimer=_.noop;var data={ok:false,error:"_timeout",seconds:_timeout_ms};var ret=dataHandler(data);setTimeout(function(){if(ret.try_again)_reQueue(method,args,p,dont_set_active,progressHandler);_onRequestDone(method)},ret.breathing_ms)};p.onCancel=function(){TS.log(2,method+" cancelled and aborted during request in TS.api");req.onerror=_.noop;req.onreadystatechange=_.noop;req.onprogress=_.noop;req.abort();setProgressTimer=_.noop;clearTimeout(progress_timer);setTimeout(_onRequestDone,_successful_breathing_ms,method)};var setProgressTimer=function(perc){TS.log(222,method+" progress: "+(perc!=undefined&&perc!=-1&&perc*100+"%"||perc!=-1&&perc!==0&&perc*100+"%"||"unknown"));if(!abort_on_slow_progress)return;clearTimeout(progress_timer);var progress_timeout_ms=_timeout_ms;if(method=="rtm.start"){if(args.cache_ts){progress_timeout_ms=_timeout_ms*1.5}else{progress_timeout_ms=_timeout_ms*2}}progress_timer=setTimeout(function(){clearTimeout(progress_timer);TS.ms.logConnectionFlow(method+"_timeout");TS.error(_timeout_ms+"ms passed, no "+method+" progress");timeout()},progress_timeout_ms)};req.onprogress=function(evt){var perc=evt.lengthComputable?evt.loaded/evt.total:-1;if(abort_on_slow_progress)setProgressTimer(perc);if(progressHandler)progressHandler(perc)};req.onerror=function(e){};req.onreadystatechange=function(){if(req.readyState==1){}else if(req.readyState==2){if(headersHandler)headersHandler(req)}else if(req.readyState==3){}else if(req.readyState==4){req.onprogress({loaded:1,total:1,lengthComputable:true});req.onprogress=_.noop;clearTimeout(progress_timer);if(req.status==200){req.onreadystatechange=null;on200Response()}else{onNon200Response()}}};var form_data=new FormData;var include_token=_no_token.indexOf(method)<0;var any_data=false;Object.keys(args).map(function(k){if(k==="token"&&!include_token)return;if(k[0]==="_")return;form_data.append(k,args[k]);any_data=true});req.open("POST",url,!args._synchronously);req.setRequestHeader("X-Slack-Version-Ts",TS.boot_data.version_ts);if(abort_on_slow_progress)setProgressTimer(0);if(any_data){req.send(form_data)}else{req.send()}};var _nextFromQ=function(){var o;if(_one_at_a_time_Q.length&&!_one_at_a_time_call_pending){o=_one_at_a_time_Q.shift()}else if(_main_Q.length>=QUEUE_FAIRNESS_THRESHOLD&&_last_api_method_called){var o=_.find(_main_Q,function(queue_item){return _makeMethodNameGeneric(queue_item.method)!==_last_api_method_called});if(o&&_main_Q[0]!==o){_.remove(_main_Q,o)}else{o=_main_Q.shift()}}else if(_main_Q.length){o=_main_Q.shift()}if(!o){if(_pending===0){TS.api.Q_empty_sig.dispatch();_last_api_method_called=undefined}return}_last_api_method_called=_makeMethodNameGeneric(o.method);_kickOffACall(o.method,o.args,o.p,o.dont_set_active,o.progressHandler)};var _startTiming=function(method,args){var complete_label="api_call_"+_makeLogSafeMethodName(method);var headers_label=complete_label+"__headers";var mark_label="start_"+_method_call_counts.total_asks+"_"+complete_label;_maybeTimingMark(mark_label);return{args:args,method:method,mark_label:mark_label,headers_label:headers_label,complete_label:complete_label,ephemeral:_timing_methodsA.indexOf(method)===-1}};var _logTimingForHeaders=function(timing_ob){if(!timing_ob)return;_maybeTimingMeasure(timing_ob.headers_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral});_addSpecialTiming(timing_ob,timing_ob.headers_label)};var _logTimingForCompletion=function(timing_ob){if(!timing_ob)return;_maybeTimingMark(timing_ob.complete_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral});_addSpecialTiming(timing_ob,timing_ob.complete_label);_maybeTimingClearMarks(timing_ob.mark_label)};var _addSpecialTiming=function(timing_ob,root_label){if(!timing_ob)return;if(timing_ob.method=="rtm.start"||timing_ob.method=="rtm.leanStart"){var special_label=root_label;special_label+="__dmeliding_"+(timing_ob.args.only_relevant_ims?"yes":"no");special_label+="__usercache_"+(TS.storage.isUsingMemberBotCache()?"yes":"no");if(TS.storage.isUsingMemberBotCache()){if(parseInt(timing_ob.args.cache_ts)){special_label+="__hadcache_yes"}else{if(TS.model.had_bad_user_cache){special_label+="__hadcache_bad";if(root_label==timing_ob.complete_label)TS.model.had_bad_user_cache=false}else{special_label+="__hadcache_no"}}}_maybeTimingMeasure(special_label,timing_ob.mark_label,null,{ephemeral:timing_ob.ephemeral})}};var _cancelTiming=function(timing_ob){if(!timing_ob)return;_maybeTimingClearMarks(timing_ob.mark_label)};var _logError=function(method,args,data){if(data.error=="file_deleted"){}else{TS.error('api call "'+method+'" not ok');if(TS.qs_args["log_api_failures"]){try{TS.warn("args: "+JSON.stringify(args))}catch(err){TS.warn("could not stringify args")}try{TS.warn("data: "+JSON.stringify(data))}catch(err){TS.warn("could not stringify data")}}else{TS.warn("args/data logging skipped, run with ?log_api_failures=1 to enable full logging")}}};var _callOutsideHandler=function(method,args,data,request_id,p){var proceed=function(){p.handler(data.ok,data,args,request_id);return Promise.resolve()};if(!data.ok&&data.active_migration&&TS.boot_data){var response_type=TS.boot_data.api_active_migration_error_response_type;if(!response_type){TS.info('API returned "active_migration" (enterprise org migration) for '+method+" - not alerting or reloading because no api_active_migration_error_response_type set.",data)}else if(TS.boot_data.ignore_api_active_migration_error){TS.info('API returned "active_migration" (enterprise org migration) for '+method+' - skipping "'+response_type+'" because ignore_api_active_migration_error set.',data)}else if(response_type=="allow_reload"){if(!TS.boot_data.active_migration_reload_underway){TS.warn('About to reload because API returned "active_migration" (enterprise org migration) for '+method+" and api_active_migration_error_response_type allows reload.",data);TS.boot_data.active_migration_reload_underway=true;window.location.reload()}}else if(response_type=="show_dialog"){if(TS.boot_data.user_saw_migration_dialog){TS.info('API returned "active_migration" (enterprise org migration) for '+method+", but user has already seen dialog. Doing nothing.")}else{TS.info('API returned "active_migration" (enterprise org migration) for '+method+". Showing migration dialog.");TS.ui.fs_modal.start({title:"This team is joining an Enterprise Organization!",body:"Apologies for the interruption. This team is currently being migrated into "+(data.enterprise_name?"the <b>"+TS.utility.htmlEntities(data.enterprise_name)+"</b> Organization":"an Organization")+", which can take some time to complete. In the meantime, you won't be able to use it, but we'll email you once it's done.",show_cancel_button:false,show_go_button:false,disable_default_controls:true,disable_esc:true});TS.boot_data.user_saw_migration_dialog=true}}else{TS.warn('API returned "active_migration" (enterprise org migration) for '+method+', but api_active_migration_error_response_type of "'+response_type+'" not recognized - doing nothing.',data)}return proceed()}if(!data.ok)return proceed();if(_ensure_model_methodsA.indexOf(method)==-1)return proceed();var ensureBots=function(){if(!TS.lazyLoadMembersAndBots())return Promise.resolve();TS.log(528,'running api data from "'+method+'" through TS.members.ensureMembersInDataArePresent()');return TS.bots.ensureBotsInDataArePresent(data,method,args.channel||undefined).catch(function(err){TS.error(err)})};var ensureMembers=function(){TS.log(528,'running api data from "'+method+'" through TS.members.ensureMembersInDataArePresent()');return TS.members.ensureMembersInDataArePresent(data,method,args.channel||undefined).catch(function(err){TS.error(err)})};var ensureModelObs=function(){TS.log(528,'running api data from "'+method+'" through TS.shared.ensureModelObsInDataArePresent()');return TS.shared.ensureModelObsInDataArePresent(data,method).catch(function(err){TS.error(err)})};ensureModelObs().then(function(){return Promise.join(ensureBots(),ensureMembers())}).then(proceed)};var _reQueue=function(method,args,p,dont_set_active,progressHandler){TS.warn('re Qing api call "'+method+'"');var use_Q=_one_at_a_time_methodsA.indexOf(method)!=-1?_one_at_a_time_Q:_main_Q;use_Q.unshift({method:method,args:args,p:p,dont_set_active:dont_set_active,progressHandler:progressHandler})};var _calculateHTTPErrorDelayMs=function(args,data){var max_secs;var increase_rate;var retry_after_secs=data.retry_after||0;if(data.status==429||data.status==503){increase_rate=1.1;retry_after_secs=retry_after_secs||60;max_secs=Math.max(180,parseInt(data.retry_after)||0)}else{increase_rate=1.3;retry_after_secs=1;max_secs=60}var ms=!args._delay_ms?(retry_after_secs+1)*1e3:Math.min(args._delay_ms*increase_rate,max_secs*1e3);ms+=Math.random()*(ms/2);return Math.floor(ms)};var _makeLogSafeMethodName=function(method){return String(method).replace(/\./g,"_")};var _getAPIErrorObject=function(response){var error=new Error('API call "'+response.method+'" not ok');error.method=response.method;error.data=response.data;error.args=response.args;return error};var _promisify=function(method,handler){var reject_promise;var resolve_promise;var promise=new Promise(function(resolve,reject,onCancel){resolve_promise=resolve;reject_promise=reject;onCancel(function(){if(typeof handler=="function")TS.error("Because you passed a handler, which is deprecated, this API call has been cancelled but your handler has not been called. Use Promise chaining to cancel and react.");promisfy_obj.onCancel()})});if(typeof handler=="function"){promise=promise.caught(_.noop)}var inner_handler=function(ok,data,args,request_id){var resp_obj={data:data,args:args,method:method,request_id:request_id};if(ok){resolve_promise(resp_obj)}else{reject_promise(_getAPIErrorObject(resp_obj))}if(handler){handler(ok,data,args,request_id)}};var promisfy_obj={promise:promise,handler:inner_handler,onCancel:_.noop};return promisfy_obj};var _timingFraction=.01;var _shouldSendTimingData=TS.qs_args["api_timings"]||Math.random()<=_timingFraction;var _maybeTimingCount=function(label,value){if(!_shouldSendTimingData)return;TS.metrics.count(label,value)};var _maybeTimingMark=function(label){if(!_shouldSendTimingData)return;TS.metrics.mark(label)};var _maybeTimingMeasure=function(measure_label,start_mark_label,end_mark_label,options){if(!_shouldSendTimingData)return;TS.metrics.measure(measure_label,start_mark_label,end_mark_label,options)};var _maybeTimingClearMarks=function(mark_label){if(!_shouldSendTimingData)return;TS.metrics.clearMarks(mark_label)};var _api_queue_depth_warning_threshold=100;var _last_connectivity_warning_time=0;var _maybeShowConnectivityWarning=function(){if(TS.ui.fs_modal.is_showing)return;if(!_is_paused)return;if(_main_Q.length<_api_queue_depth_warning_threshold)return;var max_connectivity_warning_interval=5*60*1e3;if(Date.now()-_last_connectivity_warning_time<max_connectivity_warning_interval)return;_last_connectivity_warning_time=Date.now();TS.metrics.count("ts_api_connectivity_warning_shown");TS.ui.fs_modal.start({title:"Connection troubles",body:"We're having a bit of trouble with our connections to Slack's servers. We've seen this problem clear up with a restart of Slack, a solution which we suggest to you now only with great regret and self-loathing.",go_button_text:"Reload Slack",cancel_button_text:"Ignore",onGo:function(){TS.metrics.count("ts_api_connectivity_warning_reload");TS.reload(null,"API queue was too deep and user chose to reload")},onCancel:function(){TS.metrics.count("ts_api_connectivity_warning_ignore")}})};var QUEUE_FAIRNESS_THRESHOLD=5;var _last_api_method_called;var _makeMethodNameGeneric=function(method_name){return method_name.replace(/^(channels|groups|im|mpim)\./,"_modelob_.")};var _pause=function(info){if(typeof info=="undefined"){throw new Error("Please specify the reason pausing the API")}if(!_is_paused){_is_paused=true;_maybeTimingCount("ts_api_pause");
_maybeTimingMark("ts_api_pause_start");TS.api.paused_sig.dispatch(info)}};var _unPause=function(){if(_is_paused){_is_paused=false;_maybeTimingCount("ts_api_unpause");_maybeTimingMeasure("ts_api_pause_duration","ts_api_pause_start");_maybeTimingClearMarks("ts_api_pause_start")}};var _notifyUnpaused=function(){TS.api.unpaused_sig.dispatch()};var _PAUSE_TICK_MS=1e3;var _pauseFor=function(delay_ms){_pause_secs=Math.max(_pause_secs,Math.ceil(delay_ms/_PAUSE_TICK_MS));_pause({reason:{API_ERROR:true},retry_after:_pause_secs});clearInterval(_pause_interv);_pause_interv=setInterval(function(){_pause_secs--;TS.api.paused_sig.dispatch({reason:{API_ERROR:true},retry_after:_pause_secs});if(!_pause_secs){clearInterval(_pause_interv);_unPause();TS.api.connection.waitForMSToReconnect().then(function(){_notifyUnpaused();_nextFromQ()})}},_PAUSE_TICK_MS)};var _pauseUntilAPIConnectionRestored=function(reason,retry_interval,max_retries){if(_is_paused){return}_pause({reason:reason});return TS.api.connection.waitForAPIConnection(retry_interval,max_retries).then(_unPause).then(TS.api.connection.waitForMSToReconnect).then(_notifyUnpaused).then(_nextFromQ)};var _pauseUntilBackOnline=function(consecutive_connection_failures){TS.warn(consecutive_connection_failures+" consecutive connection errors. Pausing API queue until internet returns");return _pauseUntilAPIConnectionRestored({OFFLINE:true})};var _pauseUntilServiceIsUp=function(retry_interval,max_retries,consecutive_500s){TS.warn("Received "+consecutive_500s+" consecutive 500s; pausing API queue until we determine the service is in a good state");return _pauseUntilAPIConnectionRestored({SERVICE_DOWN:true},retry_interval,max_retries)}})();(function(){"use strict";TS.registerModule("permissions",{})})();(function(){"use strict";TS.registerModule("permissions.channels",{canMemberJoinChannel:function(channel_model_ob,member_model_ob){if(!channel_model_ob||!member_model_ob)return false;if(!TS.boot_data.page_needs_enterprise)return true;if(channel_model_ob.is_im||channel_model_ob.is_mpim)return true;if(!channel_model_ob.is_shared&&!member_model_ob._is_local)return false;if(channel_model_ob.is_shared&&!member_model_ob._is_local){var allowed_teams=channel_model_ob.shares.map(function(team){return team.id});var matches=_.intersection(member_model_ob.enterprise_user.teams,allowed_teams);if(!matches.length)return false}return true}})})();(function(){"use strict";TS.registerModule("tips",{onStart:function(){_$body.delegate(".ts_tip_lazy, .ts_tip_float","mouseenter",_onMouseEnter);_$body.delegate(".ts_tip_float","mouseleave",_onMouseLeave);_$body.on("click",".ts_tip",function(e){if(TS.isPartiallyBooted()){e.preventDefault();e.stopPropagation();TS.incremental_boot.userDidInteractWithUI();return}_toggleTipTitle($(this))})},hideAll:function(){$(".ts_tip").addClass("ts_tip_hide")},unhideAll:function(){$(".ts_tip").removeClass("ts_tip_hide")},updateTipTitle:function($tipped_el,tip){var $tip_el=_getTipEl($tipped_el);if($tip_el.length){$tip_el.html(tip)}else{$tipped_el.attr("title",tip)}if(_$tipped_el&&_$tipped_el[0]==$tipped_el[0]){_$floater_tip_el.html(tip);_positionFloater()}},updateFloater:function(args){if(args.title){_$floater_tip_el.text(args.title)}if(args.classes_to_add){_$floater.addClass(args.classes_to_add.join(" "))}}});var _$body=$("BODY");var _$scroller=null;var _$tipped_el=null;var _$floater=null;var _$floater_tip_el=null;var _unhide_ms=10;var _last_tim=0;var _onMouseEnter=function(e){_$tipped_el=$(e.currentTarget);var is_multiline=_$tipped_el.hasClass("ts_tip_multiline");_$tipped_el.addClass("ts_tip_hidden");if(_$tipped_el.children(".ts_tip_tip").length==0){var title=_$tipped_el.prop("title");if(is_multiline){_$tipped_el.append('<span class="ts_tip_tip"><span class="ts_tip_multiline_inner">'+title+"</span></span>")}else{_$tipped_el.append('<span class="ts_tip_tip">'+title+"</span></span>")}}_$tipped_el.removeAttr("title");_$tipped_el.removeClass("ts_tip_lazy");_$body.children("#ts_tip_float_floater").remove();if(_$tipped_el.hasClass("ts_tip_float")){var classes=_$tipped_el.attr("class").split(/\s+/).filter(function(name){if(name=="ts_tip_float")return false;if(name=="ts_tip_lazy")return false;return name.indexOf("ts_tip")===0});var floater_html=TS.templates.builders.strBuilder('<div id="ts_tip_float_floater" style="width:${w}px; height:${h}px;" class="${classes}">${tip_html}</div>',{w:_$tipped_el.outerWidth(),h:_$tipped_el.outerHeight(),classes:classes.join(" "),tip_html:_$tipped_el.find(".ts_tip_tip").clone()[0].outerHTML});_$floater=$(floater_html);_$body.append(_$floater);_last_tim=setTimeout(function(){_$floater.removeClass("ts_tip_hidden");_positionFloater()},_unhide_ms);_$scroller=_$tipped_el.closest(":scrollable(vertical)");_$scroller.on("scroll.ts_tip_removal",_hideFloater);_$tipped_el.on("destroyed.ts_tip_removal",_hideFloater);if(_$tipped_el.hasClass("ts_tip_hide_on_click")){_$tipped_el.on("click.ts_tip_removal",_hideFloater)}if(is_multiline){_$floater_tip_el=_$floater.find(".ts_tip_multiline_inner")}else{_$floater_tip_el=_$floater.find(".ts_tip_tip_inner");if(!_$floater_tip_el.length)_$floater_tip_el=_$floater.find(".ts_tip_tip")}}else{setTimeout(function(){_$tipped_el.removeClass("ts_tip_hidden")},_unhide_ms)}};var _onMouseLeave=function(e){_hideFloater()};var _hideFloater=function(){clearTimeout(_last_tim);if(_$floater){_$floater.addClass("ts_tip_hidden")}if(_$tipped_el){_$tipped_el.off("click.ts_tip_removal");_$tipped_el.off("destroyed.ts_tip_removal")}if(_$scroller){_$scroller.off("scroll.ts_tip_removal")}_$scroller=null;_$tipped_el=null;_$floater=null;_$floater_tip_el=null};var _positionFloater=function(){var offset=_$tipped_el.offset();var allowance=2;var ww=window.innerWidth-allowance;var wh=window.innerHeight-allowance;var is_mulitline=_$floater.hasClass("ts_tip_multiline");var getRect=function(){if(is_mulitline){return _$floater.find(".ts_tip_multiline_inner").dimensions_rect()}else{return _$floater.find(".ts_tip_tip").dimensions_rect()}};var setHorizontalPositionClass=function(c){_$floater.removeClass("			ts_tip_right 			ts_tip_rightish 			ts_tip_left 			ts_tip_leftish 			ts_tip_multiline_top_leftish 			ts_tip_multiline_top_left 			ts_tip_multiline_top_right 			ts_tip_multiline_top_rightish 		").addClass(c)};_$floater.css("left",offset.left).css("top",offset.top);var rect=getRect();if(rect.bottom>wh){_$floater.removeClass("ts_tip_bottom").addClass("ts_tip_top")}else if(rect.top<allowance){_$floater.removeClass("ts_tip_top").addClass("ts_tip_bottom")}if(is_mulitline){if(rect.right>ww){setHorizontalPositionClass("ts_tip_multiline_top_rightish")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_multiline_top_leftish")}rect=getRect();if(rect.right>ww){setHorizontalPositionClass("ts_tip_multiline_top_right")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_multiline_top_left")}}else{if(rect.right>ww){setHorizontalPositionClass("ts_tip_rightish")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_leftish")}rect=getRect();if(rect.right>ww){setHorizontalPositionClass("ts_tip_right")}else if(rect.left<allowance){setHorizontalPositionClass("ts_tip_left")}}};var _toggleTipTitle=function($tipped_el){var $tip_el=_getTipEl($tipped_el);var toggle_attribute="tip-toggle-auto";var $tip_toggle_el;if($tipped_el.data(toggle_attribute)){$tip_toggle_el=$tipped_el}else if($tip_el.data(toggle_attribute)){$tip_toggle_el=$tip_el}if(!($tip_toggle_el&&$tip_toggle_el.length))return;var current_text=$tip_el.html();var new_text=$tip_toggle_el.data(toggle_attribute);if(!new_text)return TS.warn("No toggle state text defined on tipped element. Please add text to data-tip-toggle-text or data-tip-toggle-auto attribute");TS.tips.updateTipTitle($tipped_el,new_text);$tip_toggle_el.data(toggle_attribute,current_text)};var _getTipEl=function($tipped_el){var $tip_el=$tipped_el.find(".ts_tip_multiline_inner");if(!$tip_el.length)$tip_el=$tipped_el.find(".ts_tip_tip_inner");if(!$tip_el.length)$tip_el=$tipped_el.find(".ts_tip_tip");return $tip_el}})();(function(){"use strict";TS.registerModule("notifs",{onStart:function(){},canCorGHaveChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}return TS.notifs.canModelObHaveChannelMentions(model_ob)},canModelObHaveChannelMentions:function(model_ob){if(model_ob.is_im){return false}if(TS.model.team.prefs.who_can_at_channel=="admin"||TS.model.team.prefs.who_can_at_channel=="owner"){return true}if(model_ob.is_general&&(TS.model.team.prefs.who_can_at_everyone=="admin"||TS.model.team.prefs.who_can_at_everyone=="owner")){return true}if(model_ob.is_general&&(TS.model.team.prefs.who_can_post_general=="admin"||TS.model.team.prefs.who_can_post_general=="owner")){return true}var setting=TS.notifs.getCalculatedCorGNotifySetting(model_ob.id);if(setting!="mentions"&&setting!="nothing"){return true}return!TS.notifs.hasUserSuppressedCorGChannelMentions(model_ob.id)},hasUserSuppressedCorGChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}var i=TS.model.at_channel_suppressed_channels.indexOf(model_ob.id);if(i!=-1)return true;return false},hasUserSuppressedCorGPushChannelMentions:function(c_id){var model_ob=TS.channels.getChannelById(c_id)||TS.groups.getGroupById(c_id)||TS.mpims.getMpimById(c_id);if(!model_ob){TS.error("no model_ob for c_id:"+c_id+"?");return true}var i=TS.model.push_at_channel_suppressed_channels.indexOf(model_ob.id);if(i!=-1)return true;return false},isCorGMuted:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.muted_channels.indexOf(c_id)>-1){return true}return false},getGlobalPushNotificationSetting:function(){if(TS.model.prefs.push_everything)return"everything";if(TS.model.prefs.push_mention_alert&&TS.model.prefs.push_dm_alert)return"dm_and_mentions";if(TS.model.prefs.push_mention_alert)return"mentions";if(TS.model.prefs.push_dm_alert)return"dms";return"nothing"},getCorGsNotUsingGlobalPushNotificationSetting:function(){var ret={nothing:[],mentions:[],everything:[]};var model_ob;var i;var all={};var id;var A;var global_setting="quiet";if(TS.model.prefs.push_mention_alert)global_setting="mentions";if(TS.model.prefs.push_everything)global_setting="loud";A=TS.model.prefs.push_loud_channels_set?TS.model.prefs.push_loud_channels_set.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;all[id]="quiet"}A=TS.channels.getChannelsForUser();for(i=0;i<A.length;i++){if(!A[i])continue;id=A[i].id;if(TS.notifs.getCalculatedCorGPushNotifySetting(id)!="mentions")continue;if(!TS.notifs.hasUserSuppressedCorGPushChannelMentions(id))continue;all[id]="mentions_suppressed";ret.mentions.push(A[i])}A=TS.model.prefs.push_mention_channels?TS.model.prefs.push_mention_channels.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;if(!all[id])continue;all[id]="mentions"}A=TS.model.prefs.push_loud_channels?TS.model.prefs.push_loud_channels.split(","):[];for(i=0;i<A.length;i++){id=$.trim(A[i]);if(!id)continue;if(!all[id])continue;all[id]="loud"}for(id in all){model_ob=TS.channels.getChannelById(id)||TS.groups.getGroupById(id)||TS.mpims.getMpimById(id);if(!model_ob)continue;if(model_ob.is_archived)continue;if(model_ob.is_channel&&!model_ob.is_member)continue;if(all[id]=="loud"){if(global_setting=="loud")continue;ret.everything.push(model_ob)}else if(all[id]=="mentions"){if(global_setting=="mentions")continue;ret.mentions.push(model_ob)}else if(all[id]=="mentions_suppressed"){}else{if(global_setting=="quiet")continue;ret.nothing.push(model_ob)}}return ret},getGlobalNotificationSetting:function(){if(!TS.model.prefs.growls_enabled)return"nothing";if(TS.model.prefs.all_channels_loud)return"everything";return"mentions"},getCorGsNotUsingGlobalNotificationSetting:function(){var ret={nothing:[],mentions:[],everything:[],muted:[]};var model_ob;var i;var channels=TS.channels.getChannelsForUser();for(i in channels){model_ob=channels[i];if(model_ob.is_archived)continue;if(!model_ob.is_member)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}for(i in TS.model.groups){model_ob=TS.model.groups[i];if(model_ob.is_archived)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}for(i in TS.model.mpims){model_ob=TS.model.mpims[i];if(model_ob.is_archived)continue;if(_isCorGNotifySettingNothingSetSpecifically(model_ob.id))ret.nothing.push(model_ob);if(_isCorGNotifySettingMentionsSetSpecifically(model_ob.id))ret.mentions.push(model_ob);if(_isCorGNotifySettingEverythingSetSpecifically(model_ob.id))ret.everything.push(model_ob);if(TS.notifs.isCorGMuted(model_ob.id))ret.muted.push(model_ob)}return ret},getCalculatedCorGNotifySetting:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}var is_loud_changed=_isCorGLoudSet(c_id);if(is_loud_changed){if(_isCorGLoud(c_id))return"everything";if(_isCorGNever(c_id))return"nothing";return"mentions"}if(TS.model.prefs.growls_enabled){if(TS.model.prefs.all_channels_loud)return"everything";return"mentions"}return"nothing"},muteOrUnmuteCorG:function(c_id){if(!c_id)return;if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}var model_ob=TS.shared.getModelObById(c_id);if(!model_ob)return;if(model_ob.is_im)return;var is_muted=TS.notifs.isCorGMuted(c_id);if(!is_muted){TS.notifs.makeCorGMuted(c_id);if(model_ob.is_channel){TS.channels.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else if(model_ob.is_mpim){TS.mpims.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else if(model_ob.is_group){TS.groups.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}}else{TS.notifs.makeCorGNOTMuted(c_id)}var val=TS.model.muted_channels.join(",");TS.prefs.onPrefChanged({name:"muted_channels",value:val});TS.prefs.setPrefByAPI({name:"muted_channels",value:val})},makeCorGMuted:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.muted_channels.indexOf(c_id);if(i==-1)TS.model.muted_channels.push(c_id);TS.prefs.setMutedChannels(TS.model.muted_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGNOTMuted:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.muted_channels.indexOf(c_id);if(i!=-1)TS.model.muted_channels.splice(i,1);TS.prefs.setMutedChannels(TS.model.muted_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.at_channel_suppressed_channels.indexOf(c_id);if(i==-1)TS.model.at_channel_suppressed_channels.push(c_id);TS.prefs.setSuppressedChannels(TS.model.at_channel_suppressed_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGNOTSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.at_channel_suppressed_channels.indexOf(c_id);if(i!=-1)TS.model.at_channel_suppressed_channels.splice(i,1);TS.prefs.setSuppressedChannels(TS.model.at_channel_suppressed_channels.join(","));if(!TS.client)return;if(channel)TS.channels.calcUnreadCnts(channel);if(group)TS.groups.calcUnreadCnts(group);if(mpim)TS.mpims.calcUnreadCnts(mpim)},makeCorGPushSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_at_channel_suppressed_channels.indexOf(c_id);if(i==-1)TS.model.push_at_channel_suppressed_channels.push(c_id);TS.prefs.setPushSuppressedChannels(TS.model.push_at_channel_suppressed_channels.join(","))},makeCorGNOTPushSuppressed:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_at_channel_suppressed_channels.indexOf(c_id);if(i!=-1)TS.model.push_at_channel_suppressed_channels.splice(i,1);TS.prefs.setPushSuppressedChannels(TS.model.push_at_channel_suppressed_channels.join(","))},makeCorGDTopNothing:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.loud_channels.indexOf(c_id);if(i!=-1)TS.model.loud_channels.splice(i,1);TS.prefs.setLoudChannels(TS.model.loud_channels.join(","));i=TS.model.never_channels.indexOf(c_id);if(TS.model.prefs.growls_enabled){if(i==-1)TS.model.never_channels.push(c_id);_markCorGAsDTopNonDefault(c_id)}else{if(i!=-1)TS.model.never_channels.splice(i,1);_markCorGAsDTopDefault(c_id)}TS.prefs.setNeverChannels(TS.model.never_channels.join(","))},makeCorGDTopEverything:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.never_channels.indexOf(c_id);if(i!=-1)TS.model.never_channels.splice(i,1);TS.prefs.setNeverChannels(TS.model.never_channels.join(","));i=TS.model.loud_channels.indexOf(c_id);if(TS.model.prefs.growls_enabled&&TS.model.prefs.all_channels_loud){if(i!=-1)TS.model.loud_channels.splice(i,1);_markCorGAsDTopDefault(c_id)}else{if(i==-1)TS.model.loud_channels.push(c_id);_markCorGAsDTopNonDefault(c_id)}TS.prefs.setLoudChannels(TS.model.loud_channels.join(","))},makeCorGDTopMentions:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.loud_channels.indexOf(c_id);if(i!=-1)TS.model.loud_channels.splice(i,1);TS.prefs.setLoudChannels(TS.model.loud_channels.join(","));i=TS.model.never_channels.indexOf(c_id);if(i!=-1)TS.model.never_channels.splice(i,1);TS.prefs.setNeverChannels(TS.model.never_channels.join(","));if(TS.model.prefs.growls_enabled&&!TS.model.prefs.all_channels_loud){_markCorGAsDTopDefault(c_id)}else{_markCorGAsDTopNonDefault(c_id)}},makeCorGPushNothing:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_loud_channels.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels.splice(i,1);TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","));i=TS.model.push_mention_channels.indexOf(c_id);if(i!=-1)TS.model.push_mention_channels.splice(i,1);TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","));if(TS.model.prefs.push_everything||TS.model.prefs.push_mention_alert){_markCorGAsPushNonDefault(c_id)}else{_markCorGAsPushDefault(c_id)}},makeCorGPushEverything:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_mention_channels.indexOf(c_id);if(i!=-1)TS.model.push_mention_channels.splice(i,1);TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","));i=TS.model.push_loud_channels.indexOf(c_id);if(TS.model.prefs.push_everything){if(i!=-1)TS.model.push_loud_channels.splice(i,1);_markCorGAsPushDefault(c_id)}else{if(i==-1)TS.model.push_loud_channels.push(c_id);_markCorGAsPushNonDefault(c_id)}TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","))},makeCorGPushMentions:function(c_id){var channel=TS.channels.getChannelById(c_id);var group=TS.groups.getGroupById(c_id);var mpim=TS.mpims.getMpimById(c_id);if(!channel&&!group&&!mpim){TS.error('wtf no channel/group "'+c_id+'"');return false}var i=TS.model.push_loud_channels.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels.splice(i,1);TS.prefs.setPushLoudChannels(TS.model.push_loud_channels.join(","));i=TS.model.push_mention_channels.indexOf(c_id);if(!TS.model.prefs.push_mention_alert||TS.model.prefs.push_everything){if(i==-1)TS.model.push_mention_channels.push(c_id);_markCorGAsPushNonDefault(c_id)}else{if(i!=-1)TS.model.push_mention_channels.splice(i,1);_markCorGAsPushDefault(c_id)}TS.prefs.setPushMentionChannels(TS.model.push_mention_channels.join(","))},getCalculatedCorGPushNotifySetting:function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}var is_push_loud_changed=_isCorGPushLoudSet(c_id);if(is_push_loud_changed){if(_isCorGPushLoud(c_id))return"everything";if(_isCorGPushMention(c_id))return"mentions";return"nothing"}if(TS.model.prefs.push_everything)return"everything";if(TS.model.prefs.push_mention_alert)return"mentions";return"nothing"}});var _isCorGLoud=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.loud_channels.indexOf(c_id)>-1){return true}return false};var _isCorGNever=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.never_channels.indexOf(c_id)>-1){return true}return false};var _isCorGLoudSet=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.loud_channels_set&&TS.model.loud_channels_set.indexOf(c_id)>-1){return true}return false};var _isCorGNotifySettingNothingSetSpecifically=function(c_id){if(TS.model.prefs.growls_enabled&&TS.notifs.getCalculatedCorGNotifySetting(c_id)=="nothing"){return true}return false};var _isCorGNotifySettingMentionsSetSpecifically=function(c_id){var setting=TS.notifs.getCalculatedCorGNotifySetting(c_id);if(setting!="mentions")return false;if(!TS.model.prefs.growls_enabled||TS.model.prefs.all_channels_loud){return true}if(TS.notifs.hasUserSuppressedCorGChannelMentions(c_id)){return true}return false};var _isCorGNotifySettingEverythingSetSpecifically=function(c_id){if((!TS.model.prefs.growls_enabled||!TS.model.prefs.all_channels_loud)&&TS.notifs.getCalculatedCorGNotifySetting(c_id)=="everything"){return true}return false};var _isCorGPushLoud=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_loud_channels.indexOf(c_id)>-1){return true}return false};var _isCorGPushMention=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_mention_channels.indexOf(c_id)>-1){return true}return false};var _isCorGPushLoudSet=function(c_id){if(!c_id){TS.error('wtf no c_id "'+c_id+'"');return false}if(TS.model.push_loud_channels_set&&TS.model.push_loud_channels_set.indexOf(c_id)>-1){return true}return false};var _markCorGAsDTopNonDefault=function(c_id){var i=TS.model.loud_channels_set.indexOf(c_id);if(i==-1)TS.model.loud_channels_set.push(c_id);TS.prefs.setLoudChannelsSet(TS.model.loud_channels_set.join(","))};var _markCorGAsDTopDefault=function(c_id){var i=TS.model.loud_channels_set.indexOf(c_id);if(i!=-1)TS.model.loud_channels_set.splice(i,1);TS.prefs.setLoudChannelsSet(TS.model.loud_channels_set.join(","))};var _markCorGAsPushNonDefault=function(c_id){var i=TS.model.push_loud_channels_set.indexOf(c_id);if(i==-1)TS.model.push_loud_channels_set.push(c_id);TS.prefs.setPushLoudChannelsSet(TS.model.push_loud_channels_set.join(","))};var _markCorGAsPushDefault=function(c_id){var i=TS.model.push_loud_channels_set.indexOf(c_id);if(i!=-1)TS.model.push_loud_channels_set.splice(i,1);TS.prefs.setPushLoudChannelsSet(TS.model.push_loud_channels_set.join(","))}})();(function(){"use strict";TS.registerModule("channels",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,left_sig:new signals.Signal,member_left_sig:new signals.Signal,list_fetched_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,topic_changed_sig:new signals.Signal,purpose_changed_sig:new signals.Signal,created_sig:new signals.Signal,deleted_sig:new signals.Signal,renamed_sig:new signals.Signal,archived_sig:new signals.Signal,unarchived_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,converted_to_shared_sig:new signals.Signal,shared_teams_updated_sig:new signals.Signal,data_updated_sig:new signals.Signal,onStart:function(){},addMsg:function(id,msg){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}if(!TS.shared.addMsg(channel,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.channels.calcUnreadCnts(channel,and_mark);TS.utility.msgs.maybeTruncateMsgs(channel);TS.channels.message_received_sig.dispatch(channel,msg)},calcUnreadCnts:function(channel,and_mark){TS.shared.calcUnreadCnts(channel,TS.channels,and_mark)},removeMsg:function(id,msg){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}if(channel._archive_msgs)TS.utility.msgs.spliceMsg(channel._archive_msgs,msg);var msgs=channel.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.channels.message_removed_sig.dispatch(channel,msg);TS.channels.calcUnreadCnts(channel,true)},changeMsgText:function(id,msg,txt){var channel=TS.channels.getChannelById(id);if(!channel){TS.error('unknown channel "'+id+'"');return}msg.text=txt;TS.channels.message_changed_sig.dispatch(channel,msg)},sendMsg:function(channel_id,text,in_reply_to_msg,should_broadcast_reply){var err_txt;var channel=TS.channels.getChannelById(channel_id);if(!channel)return false;if(channel.is_archived)return false;if(!channel.is_member)return false;var general=TS.channels.getGeneralChannel();var errorOut=function(err_txt,ephemeral_type){if(ephemeral_type){var ephemeral_msg={text:err_txt,ephemeral_type:ephemeral_type,slackbot_feels:"sad_surprise"};TS.client.ui.addOrFlashEphemeralBotMsg(ephemeral_msg)}else{TS.generic_dialog.alert(err_txt).then(function(){if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}})}if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.populateReplyInput(text);TS.ui.replies.focusReplyInput()}else{TS.utility.contenteditable.value(TS.client.ui.$msg_input,text);TS.view.focusMessageInput()}};if(channel.is_general&&!TS.members.canUserPostInGeneral()){errorOut("A Team Owner has restricted posting to the #*"+channel.name+"* channel.","general_posting_restricted");return false}var clean_text=TS.format.cleanMsg(text);var is_at_here=TS.model.here_regex.test(clean_text);var is_at_channel=TS.model.channel_regex.test(clean_text)||TS.model.group_regex.test(clean_text)||is_at_here;var is_at_everyone=TS.model.everyone_regex.test(clean_text)||channel.is_general&&is_at_channel;if(is_at_everyone){if(!TS.members.canUserAtEveryone()){err_txt="<p>A Team Owner has restricted the use of <b>@everyone</b> messages.</p>";if(TS.model.user.is_restricted){err_txt="<p>Your account is restricted, and you cannot send <b>@everyone</b> messages.</p>"}if(!channel.is_general&&TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>'}errorOut(err_txt);return false}if(!channel.is_general&&!is_at_here){if(!general||!general.is_member){err_txt="<p>You cannot send <b>@everyone</b> messages.</p>";if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>'}errorOut(err_txt)}else{TS.generic_dialog.start({title:"Send @everyone a message",body:'<p class="bold">Would you like to switch to #'+general.name+' and send your message?</p><p class="">Using <b>@everyone</b> in a message is a way to address your whole team, but it must be done in the #'+general.name+' channel.</p><p class="no_bottom_margin">If you just want to address everyone in this channel, use <b>@channel</b> instead.</p>',show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.channels.displayChannel(general.id,text)},onCancel:function(){TS.utility.contenteditable.value(TS.client.ui.$msg_input,text);TS.view.focusMessageInput()}})}return false}}if(is_at_channel&&!TS.members.canUserAtChannelOrAtGroup()){var key_word=is_at_here?"@here":"@channel";err_txt="<p>A Team Owner has restricted the use of <b>"+key_word+"</b> messages.</p>";errorOut(err_txt);return false}if(TS.ui.needToShowAtChannelWarning(channel_id,text)){TS.ui.at_channel_warning_dialog.startInMessagePane(channel_id,text,TS.channels);return false}return TS.shared.sendMsg(channel_id,text,TS.channels,in_reply_to_msg,should_broadcast_reply)},onSendMsg:function(success,imsg){var channel=TS.channels.getChannelById(imsg.SENT_MSG.channel);if(!channel){TS.error("unknown channel? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,channel,TS.channels)},displayChannel:function(channel_id,and_send_txt,from_history,replace_history_state){if(TS.boot_data.feature_tinyspeck)TS.console.logStackTrace("Channel switch notice");if(TS.isPartiallyBooted()&&channel_id!==TS.model.initial_cid){TS.warn("Can't switch model objects during incremental boot; this is a programming error");TS.sounds.play("beep");return}TS.metrics.mark("start_channel_change_"+channel_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.error('channel "'+channel_id+'" unknown');return}TS.utility.msgs.maybeClearPrevLastRead();TS.utility.msgs.maybeClearPrevLastRead(channel);TS.shared.maybeClearHasAutoScrolled();if(channel_id==TS.model.active_channel_id&&!replace_history_state&&!TS.client.activeChannelIsHidden()){TS.warn('channel "'+channel_id+'" already displayed');if(and_send_txt){TS.channels.sendMsg(channel_id,$.trim(and_send_txt))}return}if(TS.pri)TS.log(999,"displayChannel: #"+channel.name);if(channel._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(channel,TS.channels)}if(!channel.is_member){if(and_send_txt){TS.model.requested_channel_joins[channel_id]={and_send_txt:and_send_txt};TS.channels.join(channel.name);return}else{TS.client.archives.previous_model_ob=TS.shared.getActiveModelOb();
}}var no_history_add=replace_history_state?false:from_history;var switched=TS.client.channelDisplaySwitched(channel_id,replace_history_state,no_history_add);var signal=function(){if(switched){TS.channels.pre_switched_sig.dispatch();TS.channels.switched_sig.dispatch()}if(and_send_txt){TS.channels.sendMsg(channel_id,$.trim(and_send_txt))}return null};if(TS.boot_data.page_needs_enterprise&&channel.is_shared){return TS.channels.promiseToEnsureChannelsInfo(channel_id,channel.is_shared).then(signal)}else{return Promise.resolve(signal())}},setLastRead:function(channel,ts,reason){if(channel.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts: "+ts);return false}if(channel.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[channel.id+"_"+ts];delete TS.model.last_reads_set_by_client[channel.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time on channel "+channel.id+". last_read:"+channel.last_read+" new:"+ts+" reason: "+(reason||"unspecified"));return}TS.info("going back in time on channel "+channel.id+". last_read: "+channel.last_read+" new: "+ts+" reason: "+(reason||"unspecified"));if(channel.last_read-ts>10)TS.console.logStackTrace("going back in time callstack");TS.utility.msgs.maybeClearPrevLastRead(channel);TS.utility.msgs.setPrevLastRead(channel,ts)}else{TS.utility.msgs.maybeClearPrevLastRead(channel);TS.utility.msgs.maybeSetPrevLastRead(channel,ts)}if(TS.pri)TS.log(999,"TS.channels.setLastRead: #"+channel.name+", current last_read = "+channel.last_read+", new value = "+ts+" reason: "+(reason||"unspecified"));channel.last_read=ts;if(TS.boot_data.feature_pin_update){if(reason)channel._marked_reason=reason}TS.channels.marked_sig.dispatch(channel);TS.utility.msgs.maybeClearUsersCountsInfo(channel);TS.channels.calcUnreadCnts(channel);return true},markMostRecentReadMsg:function(channel,reason,allow_latest_via_users_counts){if(!channel){TS.error("channel unknown");return}if((!channel.msgs||!channel.msgs.length)&&!allow_latest_via_users_counts)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(channel);if(!most_recent_valid_ts){if(channel.is_member&&(channel.msgs&&channel.msgs.length||!channel._latest_via_users_counts))TS.warn('no valid tses for channel "'+channel.id+'"???');return}TS.utility.msgs.maybeClearUsersCountsMentionCountDisplay(channel);channel.all_read_this_session_once=true;TS.channels.markReadMsg(channel.id,most_recent_valid_ts,reason)},markReadMsg:function(channel_id,ts,reason){var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.error('channel "'+channel_id+'" unknown');return}if(channel.last_read==ts){return}if(TS.channels.setLastRead(channel,ts,reason)){channel._marked_reason=reason;if(channel.is_member){channel.needs_api_marking=true}}},onMarked:function(ok,data,args){var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}if(ok||data&&(data.error=="not_in_channel"||data.error=="is_archived")){}else{channel.needs_api_marking=true}},join:function(name,callback,in_background){if(TS.model.user.is_restricted)return Promise.reject(new Error("Account is restricted"));if(!name)return Promise.reject(new Error("No channel name given"));if(!TS.channels.getChannelByName(name)){if(TS.model.created_channels[name]){return Promise.reject("Already joining")}TS.model.created_channels[name]=true}return TS.api.call("channels.join",{name:name,_in_background:!!in_background},function(ok,data,args){TS.channels.onJoin(ok,data,args);if(callback){callback(ok,data,args)}if(!ok){delete TS.model.created_channels[name]}})},onJoin:function(ok,data,args){if(!ok){if(data.error=="name_taken"){}else if(data.error=="is_archived"){TS.channels.displayChannel(TS.channels.getChannelByName(args.name).id)}else if(data.error=="restricted_action"){TS.generic_dialog.alert("<p>You don't have permission to create new channels.</p><p>Talk to your Team Owner.</p>")}else{TS.error("failed to join channel");alert("failed to join channel")}return}var channel_id;var channel;if(data.channel){channel=TS.channels.upsertChannel(data.channel);channel_id=data.channel.id}if(!channel_id){TS.error("no channel_id?!!");return}var and_send_txt="";if(TS.model.requested_channel_joins[channel_id]){and_send_txt=TS.model.requested_channel_joins[channel_id].and_send_txt;delete TS.model.requested_channel_joins[channel_id]}if(!channel){TS.error("no channel?!!");return}if(args._in_background){return}if(!channel.needs_created_message&&!channel.never_needs_joined_msg){channel.needs_joined_message=true}if(TS.client)TS.channels.displayChannel(channel_id,and_send_txt)},leave:function(id){var channel=TS.channels.getChannelById(id);if(!channel)return;if(channel.is_general||TS.model.user.is_restricted){TS.generic_dialog.alert("Sorry, you can't leave <b>#"+channel.name+"</b>!");return}else if(channel.is_private){TS.generic_dialog.start({title:"Leave "+channel.name,body:"<p>If you leave the private channel, you will no longer be able to see any of its messages. To rejoin the private channel, you will have to be re-invited.</p><p>Are you sure you wish to leave?</p>",go_button_text:"Yes, leave the private channel",onGo:function(){TS.api.call("channels.leave",{channel:id},TS.channels.onLeave)}});return}TS.channels.markMostRecentReadMsg(channel,TS.model.marked_reasons.left);TS.client.markLastReadsWithAPI();TS.api.call("channels.leave",{channel:id},TS.channels.onLeave)},onLeave:function(ok,data,args){if(!ok){TS.error("failed to leave channel");return}var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}channel.msgs.length=0;if(channel.is_limited)channel.is_limited=false},setTopic:function(id,topic){TS.api.call("channels.setTopic",{channel:id,topic:topic},TS.channels.onSetTopic)},onSetTopic:function(ok,data,args){if(!ok){TS.error("failed to set channel topic");return}},setPurpose:function(id,purpose){TS.api.call("channels.setPurpose",{channel:id,purpose:purpose},TS.channels.onSetPurpose)},onSetPurpose:function(ok,data,args){if(!ok){TS.error("failed to set channel purpose");return}},lookupById:function(id){return!!_id_map[id]},getChannelById:function(id){if(TS.model.submodel)return TS.model.submodel.getChannelById(id);var channels=TS.model.channels;var channel=_id_map[id];if(channel){return channel}if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=channel;return channel}}if(TS.model.deferred_archived_channels&&TS.model.channels.length){var removed_items=_.remove(TS.model.deferred_archived_channels,{id:id});channel=removed_items[0]||null;_id_map[id]=channel;if(channel){var skip_existing_check_because_object_definitely_does_not_exist=true;_upsertChannel(channel,skip_existing_check_because_object_definitely_does_not_exist);return channel}return null}return null},getFirstChannelYouAreIn:function(){var channels=TS.model.channels;var channel;if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_member)return channel}return null},getGeneralChannel:function(){var channels=TS.model.channels;var channel;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_general)return channel}if(TS.boot_data.feature_tinyspeck){var general_id="C024BE7LR";console.warn("TS patch/fix: Trying to return channel "+general_id+" since no channels have an is_general = true :/");channel=TS.channels.getChannelById(general_id);if(channel){console.warn("TS patch/fix: Found channel #"+channel.name);return channel}console.warn("TS patch/fix: WTF, could not find channel with ID "+general_id)}},getChannelByName:function(name){name=_.toLower(name);if(TS.model.submodel)return TS.model.submodel.getChannelByName(name);var channels=TS.model.channels;var channel=_name_map[name];if(channel){return channel}if(!channels)return null;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel._name_lc==name||"#"+channel._name_lc==name){TS.warn(name+" not in _name_map?");_name_map["#"+name]=channel;_name_map[name]=channel;return channel}}if(TS.model.deferred_archived_channels&&TS.model.channels.length){var removed_items=_.remove(TS.model.deferred_archived_channels,{name:name});channel=removed_items[0]||null;_name_map[name]=channel;_name_map["#"+name]=channel;if(channel){var skip_existing_check_because_object_definitely_does_not_exist=true;_upsertChannel(channel,skip_existing_check_because_object_definitely_does_not_exist)}return channel}return null},upsertChannel:function(channel){return _upsertChannel(channel)},processNewChannelForUpserting:function(channel){_processNewChannelForUpserting(channel)},removeChannel:function(channel){var channels=TS.model.channels;if(TS.pri)TS.log(4,'removing channel "'+channel.id+'"');var c;for(var i=0;i<channels.length;i++){c=channels[i];if(c.id==channel.id){channels.splice(i,1);break}}delete _id_map[channel.id];delete _name_map[channel._name_lc];delete _name_map["#"+channel._name_lc];if(TS.client){if(TS.model.active_channel_id==channel.id){TS.client.activeChannelDisplayGoneAway()}}channel.msgs.length=0;if(channel.is_limited)channel.is_limited=false;TS.channels.deleted_sig.dispatch(channel)},channelRenamed:function(channel){var existing_channel=TS.channels.getChannelById(channel.id);delete _name_map[existing_channel._name_lc];delete _name_map["#"+existing_channel._name_lc];if(TS.boot_data.feature_reveal_channel_renames){channel.previous_names=[existing_channel._name_lc].concat(existing_channel.previous_names||[])}var new_channel=TS.channels.upsertChannel(channel);new_channel._name_lc=_.toLower(new_channel.name);_name_map[new_channel._name_lc]=new_channel;_name_map["#"+new_channel._name_lc]=new_channel;TS.channels.renamed_sig.dispatch(new_channel)},markScrollTop:function(id,scroll_top){var channel=TS.channels.getChannelById(id);if(!channel)return false;if(channel.scroll_top==scroll_top){return false}channel.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var channel=TS.channels.getChannelById(id);if(!channel)return false;return TS.shared.maybeLoadScrollBackHistory(channel,TS.channels,force)},onHistory:function(ok,data,args){var channel=TS.channels.getChannelById(args.channel);if(!channel){TS.error('wtf no channel "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");channel.history_fetch_retries?channel.history_fetch_retries++:channel.history_fetch_retries=1;TS.channels.history_fetched_sig.dispatch(channel);return}delete channel.history_fetch_retries;var fetching_more=TS.shared.onHistory(channel,data,args,TS.channels);if(!fetching_more){channel.history_is_being_fetched=false;TS.channels.history_fetched_sig.dispatch(channel)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(channel);TS.channels.calcUnreadCnts(channel,and_mark)},fetchHistory:function(channel,api_args,handler){if(!channel){TS.error('wtf no channel "'+channel+'"');return}TS.shared.maybeClearHasAutoScrolled(channel);channel.history_is_being_fetched=true;channel.history_fetch_failed=false;TS.channels.history_being_fetched_sig.dispatch(channel);if(channel.history_fetch_retries>5){delete channel.history_fetch_retries;channel.history_is_being_fetched=false;channel.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("channels.history",api_args,handler||TS.channels.onHistory)},topicChanged:function(channel,user_id,ts,topic){if(!channel.topic)channel.topic={};channel.topic.creator=user_id;channel.topic.last_set=ts;channel.topic.value=topic;TS.channels.topic_changed_sig.dispatch(channel,user_id,topic)},purposeChanged:function(channel,user_id,ts,purpose){if(!channel.purpose)channel.purpose={};channel.purpose.creator=user_id;channel.purpose.last_set=ts;channel.purpose.value=purpose;TS.channels.purpose_changed_sig.dispatch(channel,user_id,purpose)},closeArchivedChannel:function(id){TS.shared.closeArchivedChannel(id)},makeMembersWithPreselectsForTemplate:function(A,preselected_ids){preselected_ids=preselected_ids||[];var ret=[];for(var i=0;i<A.length;i++){var member=A[i];var preselected=preselected_ids.indexOf(member.id)!=-1;ret[i]={member:member,preselected:preselected}}return ret},getActiveMembersNotInThisChannelForInviting:function(id,act_like_an_admin,members_subset){var A=[];var is_admin=act_like_an_admin||TS.model.user.is_admin;if(TS.model.user.is_ultra_restricted)return A;var channel=TS.channels.getChannelById(id);if(!channel)return A;var member;var active_members=members_subset||TS.members.getActiveMembersExceptSelfAndSlackbot();for(var m=0;m<active_members.length;m++){member=active_members[m];if(member.is_ultra_restricted)continue;if(!is_admin&&member.is_restricted)continue;if(channel.members.indexOf(member.id)==-1){A.push(member)}}return A},calcActiveMembersForChannel:function(channel){channel.active_members.length=0;if(!channel.members)return;var member;for(var m=0;m<channel.members.length;m++){member=TS.members.getMemberById(channel.members[m]);if(!member)continue;if(member.deleted)continue;channel.active_members.push(member.id)}},calcActiveMembersForAllChannels:function(){var channels=TS.model.channels;for(var i=0;i<channels.length;i++){TS.channels.calcActiveMembersForChannel(channels[i])}},fetchList:function(){TS.api.call("channels.list",{exclude_members:1},TS.channels.onListFetched)},onListFetched:function(ok,data,args){if(!ok){TS.error("failed to fetch channel list");return}$.each(data.channels,function(i,channel){TS.channels.upsertChannel(channel)});TS.channels.list_fetched_sig.dispatch(data.channels)},kickMember:function(id,member_id){if(!TS.members.canUserKickFromChannels())return;var channel=TS.channels.getChannelById(id);if(!channel)return;return TS.shared.kickMember(channel,member_id)},getChannelsForUser:function(){if(TS.model.submodel)return TS.model.submodel.getChannelsForUser();if(!TS.model.user.is_restricted){return TS.model.channels}_users_channels.length=0;var channel;for(var i=0;i<TS.model.channels.length;i++){channel=TS.model.channels[i];if(!channel.is_member)continue;_users_channels.push(channel)}return _users_channels},getUnarchivedChannelsForUser:function(){_unarchived_channels.length=0;var channels=TS.channels.getChannelsForUser();var channel;for(var i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived)continue;_unarchived_channels.push(channel)}return _unarchived_channels},setDataRetention:function(channel_id,retention_type,retention_duration,handler){var args={channel:channel_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("channels.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.channels.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(channel_id,handler){TS.api.call("channels.getRetention",{channel:channel_id},handler)},promiseToEnsureChannelsInfo:function(channel_id,include_shared,force){if(!include_shared&&!force)return Promise.resolve();var p=_channels_info_p_map[channel_id];if(p&&!force)return p;p=TS.api.callImmediately("channels.info",{channel:channel_id,include_shared:include_shared}).then(function(response){if(!response.data.ok)return TS.generic_dialog.alert("Something went wrong when fetching information about the channel.","Oops! Something went wrong.");TS.channels.upsertChannel(response.data.channel);return TS.members.ensureMembersArePresent(response.data.channel.members,_.fill(Array(response.data.channel.members.length),channel_id))}).catch(function(error){return Promise.reject(Error("channels.info api call failed when trying to get data for: "+channel_id))});_channels_info_p_map[channel_id]=p;return p}});var _users_channels=[];var _unarchived_channels=[];var _id_map={};var _name_map={};var _channels_info_p_map={};var _upsertChannel=function(channel,skip_existing_check_because_object_definitely_does_not_exist){var channels=TS.model.channels;var existing_channel=skip_existing_check_because_object_definitely_does_not_exist?null:TS.channels.getChannelById(channel.id);var members;if(TS.boot_data.feature_no_unread_counts){delete channel.unread_count}if(TS.boot_data.feature_tinyspeck&&channel.id==="C00")TS.warn("_upsertChannel() got a bad channel id of C00",channel);if(existing_channel){if(TS.pri)TS.log(5,'updating existing channel "'+channel.id+'"');for(var k in channel){if(k=="members"){members=channel["members"];if(channel["is_shared"]){existing_channel.members=_.union(existing_channel.members,members)}else{if(existing_channel.members.length!==members.length)TS.metrics.count("channel_upsert_membership_discrepancy");existing_channel.members.length=0;for(var i=0;i<members.length;i++){existing_channel.members.push(members[i])}}}else if(k==="pinned_items"){if(TS.client){TS.pins.upsertPinnedItems(channel.pinned_items);existing_channel.pinned_items=channel.pinned_items}}else{existing_channel[k]=channel[k]}}channel=existing_channel;if(TS.isPartiallyBooted()&&channel.oldest_msg_ts===null){channel.oldest_msg_ts=TS.storage.fetchOldestTs(channel.id)}TS.shared.maybeResetHistoryFetched(channel);if(TS.client&&channel.is_member){var should_defer_initial_msg_history=true;TS.shared.checkInitialMsgHistory(channel,TS.channels,should_defer_initial_msg_history)}}else{if(TS.pri)TS.log(5,'adding channel "'+channel.id+'"');channels.push(channel);_processNewChannelForUpserting(channel);_id_map[channel.id]=channel;_name_map[channel._name_lc]=channel;_name_map["#"+channel._name_lc]=channel;if(channel.pinned_items&&TS.client)TS.pins.upsertPinnedItems(channel.pinned_items)}if(channel.is_member&&channel.is_archived){TS.error("channel.is_member and channel.is_archived are both true for "+channel.id+" #"+channel.name);TS.dir(0,channel);channel.is_member=false}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(channel);if(TS.model.active_cid==channel.id){TS.channels.calcUnreadCnts(channel,and_mark)}else{if(!existing_channel)TS.channels.calcUnreadCnts(channel,and_mark)}}TS.channels.calcActiveMembersForChannel(channel);return channel};var _processNewChannelForUpserting=function(channel){channel._hotness=0;TS.shared.setPriorityForDev(channel);channel.is_channel=true;channel.is_general=!!channel.is_general;channel._name_lc=_.toLower(channel.name);channel._show_in_list_even_though_no_unreads=false;TS.shared.maybeResetHistoryFetched(channel);if(!channel.members)channel.members=[];if(!channel.topic)channel.topic={};if(!channel.purpose)channel.purpose={};if(!TS.boot_data.feature_no_unread_counts){if(!channel.unread_count)channel.unread_count=0}channel.active_members=[];channel.is_member=!!channel.is_member;channel.scroll_top=-1;channel.history_is_being_fetched=false;channel.needs_api_marking=false;channel.unread_highlight_cnt=0;channel.unread_highlights=[];channel.unread_cnt=0;channel.unreads=[];channel.oldest_unread_ts=null;channel.has_fetched_history_after_scrollback=false;if(TS.client){if(TS._incremental_boot&&channel.msgs&&channel.msgs.length>0){channel.msgs=channel.msgs.map(function(msg){return TS.utility.msgs.processImsg(msg,channel.id)});TS.utility.msgs.setMsgs(channel,channel.msgs)}else{TS.utility.msgs.setMsgs(channel,[])}}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(channel)}}channel.oldest_msg_ts=TS.storage.fetchOldestTs(channel.id)||null;channel.last_msg_input=TS.storage.fetchLastMsgInput(channel.id)||null;if(TS.model.created_channels[channel.name]){channel.needs_created_message=true;delete TS.model.created_channels[channel.name]}}})();(function(){"use strict";TS.registerModule("channels.read_only",{list_updated_sig:new signals.Signal,updateList:function(channel_ids){if(!channel_ids||!_.isArray(channel_ids))return;var new_read_only_channels=_.uniq(channel_ids);var new_channels=_.difference(new_read_only_channels,TS.model.read_only_channels);var old_channels=_.difference(TS.model.read_only_channels,new_read_only_channels);old_channels.forEach(function(channel_id){var channel=TS.shared.getModelObById(channel_id);if(channel)channel.is_read_only=false});new_channels.forEach(function(channel_id){var channel=TS.shared.getModelObById(channel_id);if(channel)channel.is_read_only=true});TS.model.read_only_channels=new_read_only_channels;TS.channels.read_only.list_updated_sig.dispatch()},addChannelToList:function(channel_id){TS.model.read_only_channels=_.uniq(_.concat(TS.model.read_only_channels,channel_id));TS.channels.read_only.list_updated_sig.dispatch()},removeChannelFromList:function(channel_id){TS.model.read_only_channels=TS.model.read_only_channels.filter(function(id){return id!==channel_id});TS.channels.read_only.list_updated_sig.dispatch()},isReadOnly:function(channel_id){if(TS.boot_data.page_needs_enterprise){if(TS.model.user.enterprise_user&&TS.model.user.enterprise_user.is_owner)return false}else{if(TS.model.user.owner)return false}var model_ob=TS.shared.getModelObById(channel_id);if(!model_ob)return false;if(model_ob.is_im||model_ob.is_mpim)return false;if(!_.isUndefined(model_ob.is_read_only))return model_ob.is_read_only;return TS.model.read_only_channels.indexOf(channel_id)>-1}})})();(function(){"use strict";TS.registerModule("channels.ui",{onStart:function(){},showDataRetentionDialog:function(channel_id,handler,retention_type,retention_duration){var load_retention_data=!retention_type;var channel,im,group,mpim;channel=TS.channels.getChannelById(channel_id);if(!channel)im=TS.ims.getImById(channel_id);if(!channel&&!im)mpim=TS.mpims.getMpimById(channel_id);if(!channel&&!im&&!mpim)group=TS.groups.getGroupById(channel_id);if(!im&&!channel&&!group&&!mpim){TS.error("unknown channel_id passed to data retention dialog:"+channel_id);return}var channel_name,model_type;if(channel){model_type="channel";channel_name="#"+TS.utility.htmlEntities(channel.name)}else if(im||mpim){model_type="conversation";channel_name="this conversation"}else{model_type="channel";channel_name=TS.utility.htmlEntities(group.name)}var team_type=TS.model.team.prefs.retention_type;var team_duration=TS.model.team.prefs.retention_duration;if(group){team_type=TS.model.team.prefs.group_retention_type;team_duration=TS.model.team.prefs.group_retention_duration}else if(im||mpim){team_type=TS.model.team.prefs.dm_retention_type;team_duration=TS.model.team.prefs.dm_retention_duration}var modal_body=_retentionDialogLoadingHtml();if(!load_retention_data){modal_body=TS.templates.channel_data_retention_dialog({model_type:model_type,retention_type:retention_type,retention_duration:retention_duration,team_type:team_type,team_duration:team_duration})}TS.generic_dialog.start({title:TS.i18n.t("Edit retention policy for {channel_name}","channels")({channel_name:channel_name}),body:modal_body,go_button_text:TS.i18n.t("Save settings","channels")(),enter_always_gos:true,onGo:function(){var type=$("select[name=retention_type]").val();var duration=$("#retention_duration").val();if(type===null)return;if(duration===null)return;if(channel){TS.channels.setDataRetention(channel_id,type,duration,handler)}else if(im){TS.ims.setDataRetention(channel_id,type,duration,handler)}else if(mpim){TS.mpims.setDataRetention(channel_id,type,duration,handler)}else{TS.groups.setDataRetention(channel_id,type,duration,handler)}},onShow:load_retention_data?null:_onShowDataRetentionDialog});if(load_retention_data){if(channel){TS.channels.getDataRetention(channel_id,_onChannelsGetRetention)}else if(im){TS.ims.getDataRetention(channel_id,_onImGetRetention)}else if(mpim){TS.mpims.getDataRetention(channel_id,_onImGetRetention)}else{TS.groups.getDataRetention(channel_id,_onGroupsGetRetention)}}},showArchiveChannelDialog:function(model_ob){TS.generic_dialog.start({title:TS.i18n.t("Archive #{channel_name}","channels")({channel_name:model_ob.name}),body:TS.templates.channel_option_archive_channel({name:model_ob.name}),go_button_text:TS.i18n.t("Yes, archive the channel","channels")(),onGo:function(){TS.api.call("channels.archive",{channel:model_ob.id},function(ok,data,args){if(ok){if(TS.web){$("p.alert").addClass("hidden");$("#archive_success").removeClass("hidden");$("#archive_btn").addClass("hidden");$("#unarchive_btn").removeClass("hidden")}return}var err_str=TS.i18n.t("Archiving failed with error: {error}","channels")({error:data.error});if(data.error==="last_ra_channel"){if(TS.model.user.is_admin){err_str=TS.i18n.t("Sorry, you cant archive this channel because it is the only channel one of the guest account members belongs to. If you first disable the guest account, you will then be able to archive the channel.","channels")()}else{err_str=TS.i18n.t("Sorry, you cant archive this channel because it is the only channel one of the guest account members belongs to.","channels")()}}else if(data.error==="restricted_action"){err_str=TS.i18n.t("<p>You dont have permission to archive channels.</p><p>Talk to your Team Owner.</p>","channels")()}else if(data.error==="already_archived"){err_str=TS.i18n.t("This channel was already archived.","channels")()}else if(data.error==="cant_archive_general"){err_str=TS.i18n.t("This channel cannot be archived.","channels")()}setTimeout(TS.generic_dialog.alert,500,err_str)})}})},showArchiveGroupDialog:function(model_ob,and_leave){var title=TS.i18n.t("{leave, select, true{Leave and archive}other{Archive}} {prefix}{name}","channels")({leave:and_leave,prefix:TS.model.group_prefix,name:model_ob.name});var go_button_text=TS.i18n.t("{leave, select, true{Yes, leave & archive the channel}other{Yes, archive the channel}}","channel")({leave:and_leave});TS.generic_dialog.start({title:title,body:TS.templates.channel_option_archive_group({name:model_ob.name,group_prefix:TS.model.group_prefix}),go_button_text:go_button_text,onGo:function(){TS.api.call("groups.archive",{channel:model_ob.id},function(ok,data,args){if(ok){if(and_leave&&TS.client){TS.shared.closeArchivedChannel(model_ob.id)}if(TS.web){$("p.alert").addClass("hidden");$("#archive_success").removeClass("hidden");$("#archive_btn").addClass("hidden");$("#unarchive_btn").removeClass("hidden")}return}var err_str=TS.i18n.t("Archiving failed with error: {error}","channels")({error:data.error});if(data.error==="last_ra_channel"){if(TS.model.user.is_admin){err_str=TS.i18n.t("Sorry, you cant archive this channel because it is the only channel one of the guest account members belongs to. If you first disable the guest account, you will then be able to archive the channel.","channels")()}else{err_str=TS.i18n.t("Sorry, you cant archive this channel because it is the only channel one of the guest account members belongs to.","channels")()}}else if(data.error==="already_archived"){err_str=TS.i18n.t("This channel was already archived.","channels")()}else if(data.error==="restricted_action"){err_str=TS.i18n.t("<p>You dont have permission to archive private channels.</p><p>Talk to your Team Owner.</p>","channels")()}setTimeout(TS.generic_dialog.alert,500,err_str)})}})},channelCreateDialogShowNameTakenAlert:function(div){div.find(".modal_input_note").addClass("hidden");div.find(".name_taken_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowDisallowedCharsAlert:function(div){div.find(".modal_input_note").addClass("hidden");div.find(".invalid_chars_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowSinglePunctuationAlert:function($div){$div.find(".modal_input_note").addClass("hidden");$div.find(".single_punctuation_warning").removeClass("hidden");$("#channel_create_title").select()},channelCreateDialogShowOtherErrorAlert:function($div,text){if(!text)text=TS.i18n.t("Sorry! Something went wrong.","channels")();$div.find(".modal_input_note").addClass("hidden");$div.find(".other_error").removeClass("hidden").find(".error_message").text(text)},channelCreateDialogCleanName:function($div){var title=$div.find(".title_input").val();var clean_title=TS.utility.cleanChannelName(title);while(title.substr(0,1)=="#")title=title.substr(1);if(clean_title!=title){$div.find(".title_input").val(clean_title);TS.channels.ui.channelCreateDialogShowDisallowedCharsAlert($div);return false}return true},channelCreateDialogValidateInput:function($div){var title=$div.find(".title_input").val();var clean_title=TS.utility.cleanChannelName(title);if(!TS.channels.ui.channelCreateDialogCleanName($div)){return false}if(clean_title==="_"||clean_title==="-"){TS.channels.ui.channelCreateDialogShowSinglePunctuationAlert($div);return false}if(!title){$("#channel_create_title").select();return false}if(TS.channels.getChannelByName(title)||TS.groups.getGroupByName(title)||TS.members.getMemberByName(title)){TS.channels.ui.channelCreateDialogShowNameTakenAlert($div);return false}return true}});var _onChannelsGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("channel",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("channel",data)}};var _onGroupsGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("group",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("group",data)}};var _onImGetRetention=function(ok,data,args){if(ok){var type=data.retention.retention_type;var duration=data.retention.retention_duration;_replaceDataRetentionLoadingAnimation("conversation",type,duration)}else{_replaceDataRetentionLoadingAnimationWithError("conversation",data)}};var _replaceDataRetentionLoadingAnimation=function(model_type,type,duration){var anim=$("#generic_dialog .loading_hash_animation");var team_type=TS.model.team.prefs.retention_type;var team_duration=TS.model.team.prefs.retention_duration;if(model_type==="group"){team_type=TS.model.team.prefs.group_retention_type;team_duration=TS.model.team.prefs.group_retention_duration}else if(model_type==="conversation"){team_type=TS.model.team.prefs.dm_retention_type;team_duration=TS.model.team.prefs.dm_retention_duration}if(model_type==="group"){model_type="channel"}anim.replaceWith(TS.templates.channel_data_retention_dialog({model_type:model_type,retention_type:type,retention_duration:duration,team_type:team_type,team_duration:team_duration}));_onShowDataRetentionDialog()};var _replaceDataRetentionLoadingAnimationWithError=function(model_type,data){var anim=$("#generic_dialog .loading_hash_animation");if(data.error==="no_perms"||data.error==="is_archived"||data.error==="not_paid"){if(model_type==="group"){model_type="channel"}anim.replaceWith('<p class="no_bottom_margin">'+TS.i18n.t("Sorry! You cant change the retention duration for this {model_type}.","channels")({model_type:model_type})+"</p>")}else{anim.replaceWith('<p class="no_bottom_margin">'+TS.i18n.t("Oops! Something went wrong. Please try again.","channels")()+"</p>")}};var _onShowDataRetentionDialog=function(){$("select[name=retention_type]").change(function(){if(this.value!=1){$("#team_retention_pref").removeClass("hidden");$("#retention_duration_container, #retention_duration_warning").addClass("hidden")}else{$("#team_retention_pref").addClass("hidden");$("#retention_duration_container, #retention_duration_warning").removeClass("hidden");if($("#retention_duration").val()===0){$("#retention_duration").val("")}$("#retention_duration").focus()}}).change()};var _retentionDialogLoadingHtml=function(){var url=cdn_url+"/f85a/img/loading_hash_animation_@2x.gif";var loading_text=TS.i18n.t("Loading...","channels")();return'<div class="loading_hash_animation" style="margin: 2rem;"><img src="'+url+'" alt="'+loading_text+'" /><br />'+loading_text+"</div>"}})();TS.registerModule("constants",{onStart:_.noop,avatar_size_map:{20:{standard:"image_24",retina:"image_48"},24:{standard:"image_24",retina:"image_48"},32:{standard:"image_32",retina:"image_72"},36:{standard:"image_48",retina:"image_72"},48:{standard:"image_48",retina:"image_72"
},64:{standard:"image_64",retina:"image_64"},72:{standard:"image_72",retina:"image_192"},192:{standard:"image_192",retina:"image_192"}},restricted_overlay:{standard:cdn_url+"/0180/img/avatar_overlays.png",retina:cdn_url+"/0180/img/avatar_overlays_@2x.png"}});(function(){"use strict";TS.registerModule("groups",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,left_sig:new signals.Signal,member_left_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,topic_changed_sig:new signals.Signal,purpose_changed_sig:new signals.Signal,deleted_sig:new signals.Signal,renamed_sig:new signals.Signal,opened_sig:new signals.Signal,closed_sig:new signals.Signal,archived_sig:new signals.Signal,unarchived_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,converted_to_shared_sig:new signals.Signal,shared_teams_updated_sig:new signals.Signal,onStart:function(){},addMsg:function(id,msg){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}if(!TS.shared.addMsg(group,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.groups.calcUnreadCnts(group,and_mark);TS.utility.msgs.maybeTruncateMsgs(group);TS.groups.message_received_sig.dispatch(group,msg);if(!group.is_open){TS.api.call("groups.open",{channel:group.id},TS.groups.onOpened)}},calcUnreadCnts:function(group,and_mark){TS.shared.calcUnreadCnts(group,TS.groups,and_mark)},removeMsg:function(id,msg){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}if(group._archive_msgs)TS.utility.msgs.spliceMsg(group._archive_msgs,msg);var msgs=group.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.groups.message_removed_sig.dispatch(group,msg);TS.groups.calcUnreadCnts(group,true)},changeMsgText:function(id,msg,txt){var group=TS.groups.getGroupById(id);if(!group){TS.error('unknown group "'+id+'"');return}msg.text=txt;TS.groups.message_changed_sig.dispatch(group,msg)},sendMsg:function(group_id,text,in_reply_to_msg,should_broadcast_reply){return TS.shared.sendMsgGroup(group_id,text,TS.groups,in_reply_to_msg,should_broadcast_reply)},onSendMsg:function(success,imsg){var group=TS.groups.getGroupById(imsg.SENT_MSG.channel);if(!group){TS.error("unknown group? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,group,TS.groups)},closeGroup:function(id){var group=TS.groups.getGroupById(id);if(!group){return}TS.api.call("groups.close",{channel:id},TS.groups.onClosed)},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var group=TS.groups.getGroupById(args.channel);if(group){group.is_open=false;if(group.is_archived)group.was_archived_this_session=false;if(TS.model.active_group_id==group.id){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.groups.closed_sig.dispatch(group)}}},onOpened:function(ok,data){if(!ok){return}},displayGroup:function(group_id,and_send_txt,from_history,replace_history_state){if(TS.isPartiallyBooted()&&group_id!==TS.model.initial_cid){TS.warn("Can't switch model objects during incremental boot; this is a programming error");TS.sounds.play("beep");return}TS.metrics.mark("start_channel_change_"+group_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var group=TS.groups.getGroupById(group_id);if(!group){TS.error('group "'+group_id+'" unknown');return}TS.utility.msgs.maybeClearPrevLastRead();TS.utility.msgs.maybeClearPrevLastRead(group);TS.shared.maybeClearHasAutoScrolled();if(group._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(group,TS.groups)}TS.log(999,"displayGroup "+group.id+" from_history:"+from_history+" replace_history_state:"+replace_history_state);if(group_id==TS.model.active_group_id&&!replace_history_state&&!TS.client.activeChannelIsHidden()){TS.warn('group "'+group_id+'" already displayed');if(and_send_txt){TS.groups.sendMsg(group_id,$.trim(and_send_txt))}return}var no_history_add=replace_history_state?false:from_history;var switched=TS.client.channelDisplaySwitched(group_id,replace_history_state,no_history_add);var signal=function(){if(switched){TS.groups.pre_switched_sig.dispatch();TS.groups.switched_sig.dispatch()}if(group.is_open){if(and_send_txt){TS.groups.sendMsg(group_id,$.trim(and_send_txt))}return null}TS.model.requested_group_opens[group_id]={and_send_txt:and_send_txt};TS.api.call("groups.open",{channel:group.id},TS.groups.onOpened)};if(TS.boot_data.page_needs_enterprise&&group.is_shared){return TS.groups.promiseToEnsureGroupsInfo(group_id,group.is_shared).then(signal)}else{return Promise.resolve(signal())}},setLastRead:function(group,ts,reason){if(group.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(group.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[group.id+"_"+ts];delete TS.model.last_reads_set_by_client[group.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time group.last_read:"+group.last_read+" new:"+ts);return}TS.info("going back in time group.last_read:"+group.last_read+" new:"+ts);TS.utility.msgs.maybeClearPrevLastRead(group);TS.utility.msgs.setPrevLastRead(group,ts)}else{TS.utility.msgs.maybeClearPrevLastRead(group);TS.utility.msgs.maybeSetPrevLastRead(group,ts)}group.last_read=ts;if(TS.boot_data.feature_pin_update){if(reason)group._marked_reason=reason}TS.groups.marked_sig.dispatch(group);TS.utility.msgs.maybeClearUsersCountsInfo(group);TS.groups.calcUnreadCnts(group);return true},markMostRecentReadMsg:function(group,reason,allow_latest_via_users_counts){if(!group){TS.error("group unknown");return}if((!group.msgs||!group.msgs.length)&&!allow_latest_via_users_counts)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(group);if(!most_recent_valid_ts){if(group.msgs&&group.msgs.length||!group._latest_via_users_counts)TS.warn('no valid tses for group "'+group.id+'"???');return}TS.utility.msgs.maybeClearUsersCountsMentionCountDisplay(group);group.all_read_this_session_once=true;TS.groups.markReadMsg(group.id,most_recent_valid_ts,reason)},markReadMsg:function(group_id,ts,reason){var group=TS.groups.getGroupById(group_id);if(!group){TS.error('group "'+group_id+'" unknown');return}if(group.last_read==ts){return}if(TS.groups.setLastRead(group,ts,reason)){group._marked_reason=reason;group.needs_api_marking=true}},onMarked:function(ok,data,args){var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}if(ok||data&&data.error=="is_archived"){}else{group.needs_api_marking=true}},create:function(name,and_invite_members_idsA,callback){if(!name)return;TS.model.created_groups[name]=true;var and_invite_members_ids_str=and_invite_members_idsA?and_invite_members_idsA.join(","):"";TS.api.call("groups.create",{name:name,_and_invite_members_ids:and_invite_members_ids_str},function(ok,data,args){TS.groups.onCreate(ok,data,args);if(callback){callback(ok,data,args)}})},createChild:function(group_id,and_invite_members_idsA,callback){var group=TS.groups.getGroupById(group_id);if(!group)return;TS.model.archives_and_recreated_groups[group_id]=true;var and_invite_members_ids_str=and_invite_members_idsA?and_invite_members_idsA.join(","):"";TS.api.call("groups.createChild",{channel:group_id,_and_invite_members_ids:and_invite_members_ids_str},function(ok,data,args){TS.groups.onCreate(ok,data,args);if(callback){callback(ok,data,args)}})},onCreate:function(ok,data,args){if(!ok){if(data.error=="name_taken"){}else if(data.error=="restricted_action"){}else{TS.error("failed to create group");alert("failed to create group")}return}var group;var group_id;if(data.group){group=TS.groups.upsertGroup(data.group);group_id=data.group.id}if(!group_id){TS.error("no group_id?!!");return}if(!group){TS.error("no group?!!");return}var and_invite_members_ids=args._and_invite_members_ids?args._and_invite_members_ids.split(","):null;if(and_invite_members_ids){for(var i=0;i<and_invite_members_ids.length;i++){TS.api.call("groups.invite",{channel:group_id,user:and_invite_members_ids[i]})}}if(TS.client)TS.groups.displayGroup(group_id)},getLeaveAction:function(group_id){if(TS.model.user.is_ultra_restricted)return"";if(!TS.groups.canLeaveGroup(group_id))return"";var group=TS.groups.getGroupById(group_id);if(group.is_archived){return"close"}var active_humans=group.active_members.filter(function(member_id){var member=TS.members.getMemberById(member_id);return!member.is_bot});if(active_humans.length===1){return"leave_and_archive"}else{return"leave"}},leave:function(id){var group=TS.groups.getGroupById(id);if(!group){TS.error("WTF no group:"+id);return}var leave_action=TS.groups.getLeaveAction(id);if(leave_action==="close"){TS.shared.closeArchivedChannel(id)}else if(leave_action==="leave_and_archive"){TS.channels.ui.showArchiveGroupDialog(group,true)}else if(leave_action==="leave"){TS.generic_dialog.start({title:"Leave "+TS.model.group_prefix+group.name,body:"<p>If you leave the private channel, you will no longer be able to see any of its messages. To rejoin the private channel, you will have to be re-invited.</p><p>Are you sure you wish to leave?</p>",go_button_text:"Yes, leave the private channel",onGo:function(){TS.api.call("groups.leave",{channel:id},TS.groups.onLeave)}})}else{TS.generic_dialog.alert("Sorry, you can't leave <b>"+TS.model.group_prefix+group.name+"</b>!")}},onLeave:function(ok,data,args){if(!ok){if(data&&data.error=="last_member"){TS.shared.closeArchivedChannel(args.channel);return}TS.error("failed to leave group");return}var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}group.msgs.length=0;if(group.is_limited)group.is_limited=false},setTopic:function(id,topic){TS.api.call("groups.setTopic",{channel:id,topic:topic},TS.groups.onSetTopic)},onSetTopic:function(ok,data,args){if(!ok){TS.error("failed to set group topic");return}},setPurpose:function(id,purpose){TS.api.call("groups.setPurpose",{channel:id,purpose:purpose},TS.groups.onSetPurpose)},onSetPurpose:function(ok,data,args){if(!ok){TS.error("failed to set group purpose");return}},lookupById:function(id){return!!_id_map[id]},getGroupById:function(id){if(TS.model.submodel)return TS.model.submodel.getGroupById(id);var groups=TS.model.groups;var group=_id_map[id];if(group){return group}if(!groups)return null;for(var i=0;i<groups.length;i++){group=groups[i];if(group.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=group;return group}}if(TS.model.deferred_archived_groups&&TS.model.groups.length){var removed_items=_.remove(TS.model.deferred_archived_groups,{id:id});group=removed_items[0]||null;_id_map[id]=group;if(group){var skip_existing_check_because_object_definitely_does_not_exist=true;_upsertGroup(group,skip_existing_check_because_object_definitely_does_not_exist)}return group}return null},getGroupByName:function(name){name=_.toLower(name);if(TS.model.submodel)return TS.model.submodel.getGroupByName(name);var groups=TS.model.groups;var group=_name_map[name];if(group){return group}if(!groups)return null;for(var i=0;i<groups.length;i++){group=groups[i];if(group._name_lc==name||TS.model.group_prefix+group._name_lc==name){TS.warn(name+" not in _name_map?");_name_map[name]=group;_name_map[TS.model.group_prefix+name]=group;return group}}if(TS.model.deferred_archived_groups&&TS.model.groups.length){var removed_items=_.remove(TS.model.deferred_archived_groups,{name:name});group=removed_items[0]||null;_name_map[name]=group;_name_map[TS.model.group_prefix+name]=group;if(group){var skip_existing_check_because_object_definitely_does_not_exist=true;_upsertGroup(group,skip_existing_check_because_object_definitely_does_not_exist)}return group}return null},upsertGroup:function(group){return _upsertGroup(group)},processNewGroupForUpserting:function(group){return _processNewGroupForUpserting(group)},removeGroup:function(group){var groups=TS.model.groups;TS.log(4,'removing group "'+group.id+'"');var c;for(var i=0;i<groups.length;i++){c=groups[i];if(c.id==group.id){groups.splice(i,1);break}}delete _id_map[group.id];delete _name_map[group._name_lc];delete _name_map[TS.model.group_prefix+group._name_lc];if(TS.client){if(TS.model.active_group_id==group.id){TS.client.activeChannelDisplayGoneAway()}}group.msgs.length=0;if(group.is_limited)group.is_limited=false;TS.groups.deleted_sig.dispatch(group)},groupRenamed:function(group){var existing_group=TS.groups.getGroupById(group.id);delete _name_map[existing_group._name_lc];delete _name_map[TS.model.group_prefix+existing_group._name_lc];var new_group=TS.groups.upsertGroup(group);new_group._name_lc=_.toLower(new_group.name);_name_map[new_group._name_lc]=new_group;_name_map[TS.model.group_prefix+new_group._name_lc]=new_group;TS.groups.renamed_sig.dispatch(new_group)},markScrollTop:function(id,scroll_top){var group=TS.groups.getGroupById(id);if(!group)return false;if(group.scroll_top==scroll_top){return false}group.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var group=TS.groups.getGroupById(id);if(!group)return false;return TS.shared.maybeLoadScrollBackHistory(group,TS.groups,force)},onHistory:function(ok,data,args){var group=TS.groups.getGroupById(args.channel);if(!group){TS.error('wtf no group "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");group.history_fetch_retries?group.history_fetch_retries++:group.history_fetch_retries=1;TS.groups.history_fetched_sig.dispatch(group);return}delete group.history_fetch_retries;var fetching_more=TS.shared.onHistory(group,data,args,TS.groups);if(!fetching_more){group.history_is_being_fetched=false;TS.groups.history_fetched_sig.dispatch(group)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(group);TS.groups.calcUnreadCnts(group,and_mark)},fetchHistory:function(group,api_args,handler){if(!group){TS.error('wtf no group "'+group+'"');return}TS.shared.maybeClearHasAutoScrolled(group);group.history_is_being_fetched=true;group.history_fetch_failed=false;TS.groups.history_being_fetched_sig.dispatch(group);if(group.history_fetch_retries>5){delete group.history_fetch_retries;group.history_is_being_fetched=false;group.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}if(group.is_private&&_.startsWith(group.id,"C")){TS.api.call("channels.history",api_args,handler||TS.groups.onHistory)}else{TS.api.call("groups.history",api_args,handler||TS.groups.onHistory)}},topicChanged:function(group,user_id,ts,topic){if(!group.topic)group.topic={};group.topic.creator=user_id;group.topic.last_set=ts;group.topic.value=topic;TS.groups.topic_changed_sig.dispatch(group,user_id,topic)},purposeChanged:function(group,user_id,ts,purpose){if(!group.purpose)group.purpose={};group.purpose.creator=user_id;group.purpose.last_set=ts;group.purpose.value=purpose;TS.groups.purpose_changed_sig.dispatch(group,user_id,purpose)},getUnarchivedClosedGroups:function(id){_unarchived_closed_groups.length=0;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;if(group.is_open)continue;_unarchived_closed_groups.push(group)}return _unarchived_closed_groups},getUnarchivedGroups:function(){_unarchived_groups.length=0;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;_unarchived_groups.push(group)}return _unarchived_groups},getActiveMembersNotInThisGroupForInviting:function(id,act_like_an_admin,members_subset){var model_ob=TS.shared.getModelObById(id);if(!model_ob)return[];return _getActiveMembersForInvitingWorker(act_like_an_admin,model_ob,members_subset)},getActiveMembersForInviting:function(act_like_an_admin){return _getActiveMembersForInvitingWorker(act_like_an_admin)},getGroupsWithTheseActiveMembers:function(members_idsA){if(TS.model.submodel)return TS.model.submodel.getGroupsWithTheseActiveMembers(members_idsA);var A=[];var groups=TS.model.groups;var group;var members_ids_str=members_idsA.sort().join(",");var groups_active_members;var member;for(var i=0;i<groups.length;i++){group=groups[i];group.members.sort();groups_active_members=[];for(var m=0;m<group.members.length;m++){member=TS.members.getMemberById(group.members[m]);if(!member)continue;if(member.deleted)continue;groups_active_members.push(member.id)}if(members_ids_str==groups_active_members.join(",")){A.push(group)}}return A},calcActiveMembersForGroup:function(group){group.active_members.length=0;if(!group.members)return;var member;for(var m=0;m<group.members.length;m++){member=TS.members.getMemberById(group.members[m]);if(!member)continue;if(member.deleted)continue;group.active_members.push(member.id)}},calcActiveMembersForAllGroups:function(){var groups=TS.model.groups;for(var i=0;i<groups.length;i++){TS.groups.calcActiveMembersForGroup(groups[i])}},createSuggestedName:function(member_idsA){var name=TS.model.user.name;var membersA=[];var member;var i;var max_l=TS.model.channel_name_max_length;for(i=0;i<member_idsA.length;i++){member=TS.members.getMemberById(member_idsA[i]);if(!member)continue;membersA.push(member)}membersA.sort(function compare(a,b){if(a.id==TS.ui.group_create_dialog.start_member_id)return-1;if(b.id==TS.ui.group_create_dialog.start_member_id)return 1;var a_srt=a._name_lc;var b_srt=b._name_lc;if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0});for(i=0;i<membersA.length;i++){member=membersA[i];name+="-"+member.name.split("-")[0]}if(name.length>max_l){name=name.substr(0,max_l);if(name.charAt(name.length-1)=="-"){name=name.substr(0,max_l-1)}}var name_root=name;var suffix=1;var suffix_str;while(TS.channels.getChannelByName(name)||TS.groups.getGroupByName(name)||TS.members.getMemberByName(name)){suffix_str=(suffix+1).toString();suffix++;name=name_root+suffix_str;if(name.length>max_l){name=name_root.substr(0,max_l-suffix_str.length)+suffix_str}}return name},kickMember:function(id,member_id){if(!TS.members.canUserKickFromGroups())return;var group=TS.groups.getGroupById(id);if(!group)return;return TS.shared.kickMember(group,member_id)},canLeaveGroup:function(group_id){if(!TS.model.user.is_restricted)return true;if(TS.model.user.is_ultra_restricted)return false;if(TS.channels.getChannelsForUser().length)return true;var groups=TS.model.groups;var group;for(var i=0;i<groups.length;i++){group=groups[i];if(group.is_archived)continue;if(group.id==group_id)continue;return true}return false},setDataRetention:function(group_id,retention_type,retention_duration,handler){var args={channel:group_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("groups.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.groups.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(group_id,handler){TS.api.call("groups.getRetention",{channel:group_id},handler)},promiseToEnsureGroupsInfo:function(group_id,include_shared,force){if(!include_shared&&!force)return Promise.resolve();var p=_groups_info_p_map[group_id];if(p&&!force)return p;p=TS.api.callImmediately("groups.info",{channel:group_id,include_shared:include_shared}).then(function(response){TS.groups.upsertGroup(response.data.group);return TS.members.ensureMembersArePresent(response.data.group.members,_.fill(Array(response.data.group.members.length),group_id))}).catch(function(error){return Promise.reject(Error("groups.info api call failed when trying to get data for: "+group_id))});_groups_info_p_map[group_id]=p;return p}});var _id_map={};var _name_map={};var _groups_info_p_map={};var _unarchived_closed_groups=[];var _unarchived_groups=[];var _getActiveMembersForInvitingWorker=function(act_like_an_admin,group,members_subset){var A=[];if(TS.model.user.is_ultra_restricted&&!act_like_an_admin)return A;var members_for_user=members_subset||TS.members.getActiveMembersExceptSelfAndSlackbot();var member;for(var m=0;m<members_for_user.length;m++){member=members_for_user[m];if(member.deleted)continue;if(member.is_slackbot)continue;if(member.is_self)continue;if(member.is_ultra_restricted)continue;if(!group||group.members.indexOf(member.id)==-1){A.push(member)}}return A};var _upsertGroup=function(group,skip_existing_check_because_object_definitely_does_not_exist){var groups=TS.model.groups;var existing_group=skip_existing_check_because_object_definitely_does_not_exist?null:TS.groups.getGroupById(group.id);var members;if(TS.boot_data.feature_no_unread_counts){delete group.unread_count}if(existing_group){TS.log(4,'updating existing group "'+group.id+'"');for(var k in group){if(k=="members"){members=group["members"];existing_group.members.length=0;for(var i=0;i<members.length;i++){existing_group.members.push(members[i])}}else if(k==="pinned_items"){if(TS.client){TS.pins.upsertPinnedItems(group.pinned_items);existing_group.pinned_items=group.pinned_items}}else{existing_group[k]=group[k]}}group=existing_group;if(TS.isPartiallyBooted()&&group.oldest_msg_ts===null){group.oldest_msg_ts=TS.storage.fetchOldestTs(group.id)}TS.shared.maybeResetHistoryFetched(group);if(TS.client){var should_defer_initial_msg_history=true;TS.shared.checkInitialMsgHistory(group,TS.groups,should_defer_initial_msg_history)}}else{TS.log(4,'adding group "'+group.id+'"');groups.push(group);TS.utility.ensureInArray(TS.model.all_group_ids,group.id);_processNewGroupForUpserting(group);_id_map[group.id]=group;_name_map[group._name_lc]=group;_name_map[TS.model.group_prefix+group._name_lc]=group;if(group.pinned_items&&TS.client)TS.pins.upsertPinnedItems(group.pinned_items)}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(group);if(TS.model.active_cid==group.id){TS.groups.calcUnreadCnts(group,and_mark)}else{if(!existing_group)TS.groups.calcUnreadCnts(group,and_mark)}}TS.groups.calcActiveMembersForGroup(group);return group};var _processNewGroupForUpserting=function(group){group._hotness=0;TS.shared.setPriorityForDev(group);group.is_group=true;group._name_lc=_.toLower(group.name);group._show_in_list_even_though_no_unreads=false;TS.shared.maybeResetHistoryFetched(group);group.active_members=[];group.scroll_top=-1;group.history_is_being_fetched=false;group.needs_api_marking=false;group.unread_highlight_cnt=0;group.unread_highlights=[];group.unread_cnt=0;group.unreads=[];group.oldest_unread_ts=null;group.has_fetched_history_after_scrollback=false;if(TS.client){if(TS._incremental_boot&&group.msgs&&group.msgs.length>0){group.msgs=group.msgs.map(function(msg){return TS.utility.msgs.processImsg(msg,group.id)});TS.utility.msgs.setMsgs(group,group.msgs)}else{TS.utility.msgs.setMsgs(group,[])}}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(group)}}group.oldest_msg_ts=TS.storage.fetchOldestTs(group.id)||null;group.last_msg_input=TS.storage.fetchLastMsgInput(group.id)||null;if(TS.model.created_groups[group.name]){delete TS.model.created_groups[group.name]}}})();(function(){"use strict";TS.registerModule("files",{team_file_added_sig:new signals.Signal,team_file_deleted_sig:new signals.Signal,team_file_changed_sig:new signals.Signal,team_file_shared_sig:new signals.Signal,team_file_comment_added_sig:new signals.Signal,team_file_comment_edited_sig:new signals.Signal,team_file_comment_deleted_sig:new signals.Signal,file_uploaded_sig:new signals.Signal,file_uploading_sig:new signals.Signal,file_progress_sig:new signals.Signal,file_canceled_sig:new signals.Signal,file_queue_emptied_sig:new signals.Signal,channel_files_fetched_sig:new signals.Signal,user_changed_public_url_sig:new signals.Signal,uploadQ:[],uploading:false,polling_count:0,polling_file_id:null,polling_ticket:null,polling_tim:null,polling_handler:null,waiting_for_refresh:{},supported_audio_type_re:/^(mp3|wav)$/,supported_video_type_re:/^(mp4|mov)$/,onStart:function(){TS.prefs.team_disable_file_editing_changed_sig.add(TS.files.getFileActions,TS.files.upsertAndSignal)},isFilePrivate:function(file){return!file.is_public&&!file.is_external&&!file.is_shared},isFileUntitled:function(file){return file.name=="-"},createPublicURL:function(file,callback){if(TS.model.team.prefs.disallow_public_file_urls){return}TS.api.callImmediately("files.sharedPublicURL",{file:file.id},function(ok,data,args){if(ok){TS.files.upsertAndSignal({id:file.id,public_url_shared:true});TS.files.user_changed_public_url_sig.dispatch(data.file)}else if(data.error&&data.error==="not_allowed"){TS.model.team.prefs.disallow_public_file_urls=true;if(TS.boot_data.feature_external_files){TS.generic_dialog.alert("An administator has disabled external file URL creation. You will not be able to create an external URL for this Post.")}else{TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this space.")}}if(callback&&typeof callback=="function"){callback(ok,data,args)}})},createSpace:function(callback){TS.api.callSynchronously("files.createSpace",{},function(ok,data,args){if(ok){var file=TS.files.upsertAndSignal(data.file).file;if(TS.web)TS.ssb.upsertFileInSSBParentWin(file);callback(file)}else{TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>');callback(null)}})},createAndOpenNewSpace:function(optional_callback,open_in_browser){TS.files.createSpace(function(file){if(file){var qs=TS.model.active_cid?"?origin_channel="+TS.model.active_cid:"";var url=file.permalink+qs;if(open_in_browser||!TS.ssb.openNewFileWindow(file,url,qs)){TS.utility.openInNewTab(url,file.id)}}if(typeof optional_callback=="function"){optional_callback(file)}})},createMultnomah:function(callback){TS.api.callSynchronously("files.createMultnomah",{},function(ok,data,args){if(ok){var file=TS.files.upsertAndSignal(data.file).file;if(TS.web)TS.ssb.upsertFileInSSBParentWin(file);callback(file)}else{TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>');callback(null)}})},createAndOpenNewMultnomah:function(optional_callback,open_in_browser){TS.files.createMultnomah(function(file){if(file){var qs=TS.model.active_cid?"?origin_channel="+TS.model.active_cid:"";var url=file.permalink+qs;if(open_in_browser||!TS.ssb.openNewFileWindow(file,url,qs)){TS.utility.openInNewTab(url,file.id)}}if(typeof optional_callback=="function"){optional_callback(file)}})},promptForFileUnshare:function(file_id,c_id){var channel=TS.channels.getChannelById(c_id);if(!channel)var group=TS.groups.getGroupById(c_id);if(!group)group=TS.mpims.getMpimById(c_id);if(!group&&!channel)return;TS.generic_dialog.start({title:"Un-share file",body:"<p>Are you sure you want to un-share this file from the <b>"+(channel?"#"+channel.name+"</b> channel":group.name+"</b> private channel")+"?</p>					<p>Un-sharing the file will not remove existing share and comment messages, but it will keep any future comments from appearing 					in the channel.</p>",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, unshare this file",cancel_button_text:"Cancel",onGo:function(){TS.files.unshareFile(file_id,c_id)}})},shareFile:function(id,channel_id,comment,share_quietly,callback){var share_args={file:id,channel:channel_id,comment:comment||""};share_args["resharing_aware"]=true;if(share_quietly){share_args["share_quietly"]=true}return TS.api.call("files.share",share_args,function(ok,data,args){TS.files.onFileShare(ok,data,args);if(callback)callback(ok,data,args)})},onFileShare:function(ok,data,args){if(!ok){return}TS.files.fetchFileInfo(args.file,function(id,file){TS.templates.builders.updateFileShareLabels(file);if(TS.web){TS.files.upsertAndSignal(file)}});if(TS.web&&TS.web.space)TS.web.space.onFileShare(ok,data,args)},unshareFile:function(id,channel_id,callback){TS.api.call("files.unshare",{file:id,channel:channel_id},function(ok,data,args){TS.files.onFileUnShare(ok,data,args);if(callback){callback(id,TS.files.getFileById(id))}})},fetchFileInfo:function(id,callback){var raw=false;return _fetchFileInfoWorker(id,raw,callback)},fetchFileInfoRaw:function(id,callback){var raw=true;return _fetchFileInfoWorker(id,raw,callback)},onFileUnShare:function(ok,data,args){if(!ok){return}else{TS.files.fetchFileInfo(args.file,function(id,file){TS.templates.builders.updateFileShareLabels(file);if(TS.web){TS.files.upsertAndSignal(file)}})}},fetchTeamFiles:function(types_str,callback){TS.api.call("files.list",{types:types_str,count:_files_page_size},function(ok,data,args){if(ok){if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}}if(callback)callback(ok,data,args)})},fetchMemberFiles:function(id,types_str,callback){TS.api.call("files.list",{user:id,types:types_str,count:_files_page_size},function(ok,data,args){if(ok){if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}}if(callback)callback(ok,data,args)})},fetchChannelFiles:function(id,callback,count,types){var types_str=types&&types.length?types.join(","):"";if(callback){TS.api.call("files.list",{channel:id,types:types_str,count:count},function(ok,data,args){if(ok){TS.files.onChannelFetch(ok,data,args)}callback(ok,data,args)})}else{TS.api.call("files.list",{channel:id,types:types_str},TS.files.onChannelFetch)}},onChannelFetch:function(ok,data,args){if(!ok){return}if(data.files){var file;for(var i=0;i<data.files.length;i++){file=data.files[i];TS.files.upsertFile(file)}}TS.files.channel_files_fetched_sig.dispatch(args.channel,data.files)},addComment:function(id,comment,channel_id,callback){var args={file:id,comment:comment,channel:channel_id||""};TS.api.callImmediately("files.comments.add",args,function(ok,data,args){TS.files.onFileComment(ok,data,args);if(callback){callback(ok,data,args)}})},onFileComment:function(ok,data,args){if(!ok){return}var file=TS.files.getFileById(args.file);if(!file){TS.error("no file? "+args.file);return}TS.files.addCommentToFile(data.comment,file)},getFileById:function(id){return TS.files.getFileByProp("id",id)},getFileByDownloadUrlPrivate:function(url){return TS.files.getFileByProp("url_private_download",url)},getFileByProp:function(name,value){if(!name)return null;if(!value)return null;var files=TS.model.files;var file;for(var i=0;i<files.length;i++){file=files[i];if(file[name]==value)return file}return null},getFileActions:function(file){if(!file)return;var actions={};var file_belongs_to_user=false;if(file.user==TS.model.user.id)file_belongs_to_user=true;if(file.is_public){actions.share=true}else if(file_belongs_to_user){actions.share=true}else{actions.share_private_file=true}actions.comment=true;if(!file.public_url_shared&&file.mode!="external"&&!TS.model.user.is_restricted&&!TS.model.team.prefs.disallow_public_file_urls){if(file.is_public){actions.create_public_link=true}else if(file_belongs_to_user){actions.create_public_link=true}}if(file.public_url_shared&&!TS.model.user.is_restricted&&(TS.model.user.is_admin||file_belongs_to_user)&&!TS.model.team.prefs.disallow_public_file_urls){actions.revoke_public_link=true}if(file.mode=="hosted"||file.mode=="snippet"){actions.download=true}if(file.mimetype&&file.mimetype.indexOf("image/")===0||file.mode=="external"||file.mode=="snippet"||file.mode=="email"){actions.open_original=true}if(TS.web){if(file.mode=="post"||file.mode=="snippet"||file.mode=="space"||file.mode=="email"||file.mode=="multnomah"){actions.print=true}}if(file.mode=="space"&&!(file.user==="USLACKBOT"&&file.name==="Getting_Started_with_Posts")){actions.learn_more=true}if(file.mode=="space"||file.mode=="multnomah"){actions.new_window=true}if(file.mode=="space"&&file.state!="locked")actions.edit=true;if(file_belongs_to_user){if(file.mode=="snippet"||file.mode=="post"||file.mode=="space"||file.mode=="multnomah"){
actions.edit=true}if(file.mode=="hosted"||file.mode=="email"){actions.edit_title=true}actions.delete_file=true}if(TS.model.user.is_admin){actions.delete_file=true}if(TS.clipboard.canWriteText()){actions.copy_file_link=true}if(file.mode=="external"){if(file_belongs_to_user||TS.model.user.is_admin){actions.refresh=true}}if(window.Dropbox&&Dropbox.isBrowserSupported()&&TS.model.prefs.dropbox_enabled){if(file.mode=="hosted"){actions.save_to_dropbox=true}}if(TS.client){var model_ob=TS.shared.getActiveModelOb();if(TS.pins.canUserPinHere(model_ob)){if(file.pinned_to&&file.pinned_to.indexOf(model_ob.id)!==-1){actions.unpin_file=true}else{var can_pin=!!file.is_public;if(file.channels){can_pin=can_pin||file.channels.indexOf(model_ob.id)!==-1}else{TS.warn("No channels array for file object in getFileActions(): "+file.id)}if(file.groups){can_pin=can_pin||file.groups.indexOf(model_ob.id)!==-1}else{TS.warn("No groups array for file object in getFileActions(): "+file.id)}if(file.ims){can_pin=can_pin||file.ims.indexOf(model_ob.id)!==-1}else{TS.warn("No ims array for file object in getFileActions(): "+file.id)}if(can_pin)actions.pin_file=true}}}actions.rxn_file=true;if(TS.model.team.prefs.disable_file_editing){actions.edit=false;actions.edit_title=false}if(TS.model.team.prefs.disable_file_deleting){actions.delete_file=false}if(file.is_tombstoned){actions.edit=false;actions.edit_title=false;actions.delete_file=false}return actions},getFileCommentActions:function(comment,file){if(!comment)return{};var actions={can_edit:true,can_delete:true};if(comment.user!=TS.model.user.id){actions.can_edit=false}else if(TS.model.team.prefs.msg_edit_window_mins>-1&&(Date.now()-TS.utility.date.toDateObject(comment.timestamp))/6e4>TS.model.team.prefs.msg_edit_window_mins){actions.can_edit=false}if(!TS.model.team.prefs.allow_message_deletion){if(!TS.model.user.is_admin){actions.can_delete=false}}else if(comment.user!=TS.model.user.id){if(!TS.model.user.is_admin){actions.can_delete=false}}if(TS.client){var model_ob=TS.shared.getActiveModelOb();if(TS.pins.canUserPinHere(model_ob)){if(comment.pinned_to&&comment.pinned_to.indexOf(model_ob.id)!==-1){actions.can_unpin=true}else{var can_pin=!!file.is_public;if(file.channels){can_pin=can_pin||file.channels.indexOf(model_ob.id)!==-1}else{TS.warn("No channels array for file object in getFileCommentActions(): "+file.id)}if(file.groups){can_pin=can_pin||file.groups.indexOf(model_ob.id)!==-1}else{TS.warn("No groups array for file object in getFileCommentActions(): "+file.id)}if(file.ims){can_pin=can_pin||file.ims.indexOf(model_ob.id)!==-1}else{TS.warn("No ims array for file object in getFileCommentActions(): "+file.id)}if(can_pin)actions.can_pin=true}}}actions.rxn_file_comment=true;return actions},getThumbSrcForFile:function(file,options){try{file=_ensureFileObject(file)}catch(err){return false}if(!file.thumb_360&&!file.thumb_360_gif)return false;if(!options)options={};if(!options.max_size)options.max_size=480;if(TS.boot_data.feature_a11y_pref_no_animation&&TS.model.prefs.a11y_animations===false&&file.filetype==="gif"){if(file.deanimate_gif){return file.deanimate_gif}else{if(options.max_size>360&&file.thumb_480){return file.thumb_480}else if(file.thumb_160){return file.thumb_160}}}if(file.thumb_480_gif||file.thumb_360_gif){if(options.max_size>360&&file.thumb_480_gif)return file.thumb_480_gif;if(file.thumb_360_gif)return file.thumb_360_gif}if(options.max_size>480&&file.thumb_1024)return file.thumb_1024;if(options.max_size>360&&file.thumb_960)return file.thumb_960;if(file.thumb_720)return file.thumb_720;if(file.thumb_480)return file.thumb_480;return file.thumb_360},fileIsImage:function(file){try{file=_ensureFileObject(file)}catch(err){return false}var has_thumb=file.thumb_360||file.thumb_360_gif;var gdrive_native=file.external_type==="gdrive"&&file.mimetype.indexOf("image/")<0;return has_thumb&&!gdrive_native},fileIsSupportedAudio:function(file){return TS.files.supported_audio_type_re.test(_ensureFileObject(file).filetype)},fileIsSupportedVideo:function(file){return TS.files.supported_video_type_re.test(_ensureFileObject(file).filetype)},fileIsHostedSupportedMedia:function(file){try{file=_ensureFileObject(file)}catch(err){return false}var is_supported=TS.files.fileIsSupportedAudio(file)||TS.files.fileIsSupportedVideo(file);var is_hosted=!file.is_external||!_.isEmpty(_.get(file,"video.outputs"));return is_supported&&is_hosted},fileIsPDF:function(file){try{file=_ensureFileObject(file)}catch(err){return false}return file.filetype==="pdf"},getFileTemplateArguments:function(file,image_1x_max_size){var args={};args.current_user_id=TS.model.user.id;args.file_partial="generic";if(/(snippet|post|email|multnomah)/.test(file.mode))args.file_partial=file.mode;if(/(space)/.test(file.mode))args.file_partial="post";if(TS.files.fileIsImage(file)){args.file_partial="image";args.image_src=TS.files.getThumbSrcForFile(file,{max_size:image_1x_max_size});args.image_width=image_1x_max_size===360?file.thumb_360_w:file.thumb_480_w||file.thumb_360_w;args.image_height=image_1x_max_size===360?file.thumb_360_h:file.thumb_480_h||file.thumb_360_h;args.preserve_aspect_ratio=args.image_width>0&&args.image_height>0;args.preview_actions_class="";if(args.image_width<170||args.image_height<50){args.preview_actions_class+=" overflow_preview_actions"}if(args.image_width<170){args.preview_actions_class+=" overflow_preview_actions_width"}}if(/(post|space|email|multnomah|generic)/.test(args.file_partial))args.title_hider=true;if(file.mode=="snippet")args.title_hider=file.title==="Untitled";args.filesize=file.size>2e4&&!/(gdoc|gpres|gsheet|gdraw)/.test(file.filetype);if(!/(space|post)/.test(file.filetype))args.meta_filetype=new Handlebars.SafeString(TS.templates.builders.makeFiletypeHTML(file));if(TS.templates.builders.makeExternalFiletypeHTML(file)===args.meta_filetype)args.meta_filetype=false;if(TS.files.fileIsHostedSupportedMedia(file)){if(TS.files.fileIsSupportedVideo(file)){args.file_is_video=true;var best_output={width:file.width,height:file.height,source:file.url_private,size:file.size};if(file.video){args.transcoding_status=file.video.status;if(file.video.outputs){for(var i=file.video.outputs.length-1;i>=0;i--){var output=file.video.outputs[i];if(!output.source)continue;if(!best_output.width||output.width>best_output.width)best_output=output}}}args.video_height=TS.model.native_video_embed_height;args.video_preload="metadata";if(best_output.size<=TS.model.native_media_preload_limit_bytes)args.video_preload="auto";args.best_source=best_output.source}if(TS.files.fileIsSupportedAudio(file)){args.file_is_audio=true;args.audio_preload="metadata";if(file.size<=TS.model.native_media_preload_limit_bytes)args.audio_preload="auto"}}return args},getFileDetailsMetaTemplateArguments:function(file){var file_actions=TS.files.getFileActions(file);var is_post=file.mode==="post";var is_post_or_space=file.mode==="space"||file.mode==="post";var is_snippet=file.mode==="snippet";var is_multnomah=file.mode=="multnomah";var template_args={file:file,user:TS.model.user,download:file.mode==="hosted",edit_link:is_post?file.edit_link:file.permalink,edit:(is_post_or_space||is_snippet)&&file.user===TS.model.user.id,is_post:is_post,is_post_or_space:is_post_or_space,is_snippet:is_snippet,is_multnomah:is_multnomah,show_open_public_link:!TS.model.team.prefs.disallow_public_file_urls,show_revoke_public_link:!TS.model.team.prefs.disallow_public_file_urls&&file_actions.revoke_public_link};if(file.mode==="email"){template_args.to_more_count=file.to.length-1;template_args.cc_more_count=file.cc.length-1}if(file&&file.id){if(file.mode=="snippet"||file.mode=="post"||file.mode=="space"){if(!file.content&&!file.content_html&&!file.content_highlight_html){TS.files.fetchFileInfo(file.id)}}}return template_args},createFileCommentsGroup:function(file){var comments_grouped={};function generateCommentsGroupedObj(file,c_id,comment){var model_ob=TS.shared.getModelObById(c_id);var display_name=model_ob&&TS.shared.getDisplayNameForModelOb(model_ob);var share_info_channel=file.share_info&&file.share_info[c_id];var share_info_timestamp=share_info_channel&&share_info_channel.timestamp;var share_info_member=TS.members.getMemberById(share_info_channel&&share_info_channel.user_id);var share_info_name=share_info_member&&TS.members.getMemberDisplayName(share_info_member);comments_grouped[c_id]={name:display_name,first_share:{name:share_info_name,timestamp:share_info_timestamp},comments:comment?[comment]:[]}}for(var i=file.comments.length-1;i>=0;i--){var comment=file.comments[i];if(comment.channel){if(comments_grouped[comment.channel]){comments_grouped[comment.channel].comments.unshift(comment)}else{generateCommentsGroupedObj(file,comment.channel,comment)}}}_.each([file.channels,file.groups,file.ims,file.mpims],function(list){if(list){for(var i=list.length-1;i>=0;i--){var c_id=list[i];if(!comments_grouped[c_id]){generateCommentsGroupedObj(file,c_id)}}}});file._comments_grouped=comments_grouped},resetFileCommentsGroup:function(file){file._comments_grouped=null},sortFiles:function(files){function compare(a,b){if(a.timestamp<b.timestamp)return 1;if(a.timestamp>b.timestamp)return-1;return 0}files.sort(compare)},getFileCommentById:function(file,comment_id){var comment;for(var i=0;i<file.comments.length;i++){comment=file.comments[i];if(comment.id==comment_id)return comment}return null},addCommentToFile:function(comment,file){var exisiting_comment=TS.files.getFileCommentById(file,comment.id);if(exisiting_comment){return exisiting_comment}comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions);delete comment.reactions;file.comments.push(comment);TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_added_sig.dispatch(file,comment);return comment},editCommentOnFile:function(comment,file){var was_comment;var good=false;var initial_comment_changed=false;for(var i=0;i<file.comments.length;i++){was_comment=file.comments[i];if(was_comment.id==comment.id){good=true;file.comments[i]=comment;if(was_comment.is_starred){comment.is_starred=true}if(was_comment._rxn_key){comment._rxn_key=was_comment._rxn_key}if(was_comment.pinned_to&&!comment.pinned_to){comment.pinned_to=was_comment.pinned_to}if(file.initial_comment&&was_comment.id==file.initial_comment.id){file.initial_comment=comment;initial_comment_changed=true}break}}if(!good){return false}TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_edited_sig.dispatch(file,comment);if(initial_comment_changed)TS.files.team_file_changed_sig.dispatch(file);return true},deleteCommentOnFile:function(comment_id,file){var was_comment;var A=[];var deleted_comment;for(var i=0;i<file.comments.length;i++){was_comment=file.comments[i];if(was_comment.id==comment_id){deleted_comment=was_comment;if(file.initial_comment&&was_comment.id==file.initial_comment.id){file.initial_comment=null}continue}A.push(was_comment)}if(A.length==file.comments.length){return}file.comments=A;TS.files.sortCommentsOnFile(file);TS.files.team_file_comment_deleted_sig.dispatch(file,comment_id,deleted_comment);TS.files.team_file_changed_sig.dispatch(file)},sortCommentsOnFile:function(file){function compare(a,b){if(a.timestamp>b.timestamp)return 1;if(a.timestamp<b.timestamp)return-1;return 0}file.comments.sort(compare)},upsertFile:function(file){if(Object.keys(file).length<2){TS.error("upserting a bad file object! it has less than 2 properties")}if(file.mode==="space"){try{if(file.preview&&/^\s*<document>/.test(file.preview)){var $p=$(file.preview);if($p.length)file.preview=$p.html();if(TS.boot_data.feature_files_list&&$p.length){var $first_fragment=$p.children().eq(0);if($first_fragment.hasClass("list")){$first_fragment.find("li:not(:first)").remove()}if($first_fragment.prop("tagName").toLowerCase()==="pre"){file.preview_in_list=$first_fragment.length?'<span class="monospace">'+TS.utility.htmlEntities($first_fragment.text())+"</span>":""}else{file.preview_in_list=$first_fragment.length?TS.utility.htmlEntities($first_fragment.text()):""}}}}catch(err){TS.log(93,"problem with file.preview id:"+file.id);TS.log(93,"file.preview: "+file.preview)}try{if(file.content_html){var $c=$(file.content_html);if($c.length)file.content_html=$c.html()}}catch(err){TS.log(93,"problem with file.content_html id:"+file.id);TS.log(93,"file.content_html: "+file.content_html)}}if(TS.boot_data.feature_files_list&&file.mode==="post"&&file.preview){var preview=file.preview;var preview_list=preview.split("\n");var preview_list_length=preview_list.length;for(var j=0;j<preview_list_length;j++){var preview_line=preview_list[j];if(preview_line){file.preview_in_list=preview_line;break}}}if(file.mode==="snippet"){var content_keys=["content","content_highlight_html"];var max_length_of_content=12800;_.forEach(content_keys,function(content_key){if(file[content_key]&&file[content_key].length>max_length_of_content){file[content_key]=truncate(file[content_key],max_length_of_content);file.is_truncated=true}})}var files=TS.model.files;var existing_file=TS.files.getFileById(file.id);var status="NOOP";var what_changed=[];var c_ids_to_save;var comment;var existing_rxns;var i;if(existing_file){file._rxn_key=TS.rxns.getRxnKey("file",file.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file._rxn_key);if(existing_rxns&&!file.reactions){TS.warn("file:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions)}delete file.reactions;if(file.comments){for(i=0;i<file.comments.length;i++){comment=file.comments[i];comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(comment._rxn_key);if(existing_rxns&&!comment.reactions){TS.warn("comment:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions)}delete comment.reactions}}if(file.initial_comment){file.initial_comment._rxn_key=TS.rxns.getRxnKey("file_comment",file.initial_comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file.initial_comment._rxn_key);if(existing_rxns&&!file.initial_comment.reactions){TS.warn("initial_comment:"+file.id+" has reactions in local model, but we are upserting an object that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file.initial_comment._rxn_key,file.initial_comment.reactions)}delete file.initial_comment.reactions}if(file.is_tombstoned!==existing_file.is_tombstoned){for(var k in existing_file){if(k=="is_tombstoned"){existing_file[k]=!!file[k]}else{delete existing_file[k]}}}else if(file.is_tombstoned==existing_file.is_tombstoned&&!file.is_tombstoned){delete existing_file.is_tombstoned}c_ids_to_save=(existing_file.channels||[]).concat(existing_file.ims||[]).concat(existing_file.groups||[]);for(var k in file){if(k=="channels"||k=="ims"||k=="groups"||k=="pinned_to"||k=="to"||k=="from"||k=="cc"||k=="attachments"){var changed=false;var new_prop_array=_.isArray(file[k])?file[k]:[];var old_prop_array=_.isArray(existing_file[k])?existing_file[k]:[];if(k=="to"||k=="from"||k=="cc"||k=="attachments"){if(old_prop_array.length!=new_prop_array.length){changed=true}}else{if(old_prop_array.join("")!=new_prop_array.join("")){changed=true;if(k=="channels"||k=="ims"||k=="groups"){c_ids_to_save=c_ids_to_save.concat(file[k]||[])}}}if(changed){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="preview"){if(existing_file[k]!==file[k]){existing_file[k]=file[k];if(existing_file.content)delete existing_file.content;if(existing_file.content_html)delete existing_file.content_html;if(existing_file.content_highlight_html)delete existing_file.content_highlight_html;status="CHANGED";what_changed=what_changed.concat([k,"content","content_html","content_highlight_html"])}}else if(k=="comments"){if(file[k]&&!TS.utility.areSimpleObjectsEqual(file[k],existing_file[k],"file:"+file.id+" "+file.name)){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="content"){if(file[k]&&existing_file[k]!=file[k]){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(k=="editor"||k=="state"){if(file[k]!=existing_file[k]){c_ids_to_save=[];what_changed.push(k);existing_file[k]=file[k];status="CHANGED"}}else if(k=="initial_comment"){existing_file[k]=file[k]}else if(k=="reactions"){existing_file[k]=file[k]}else if((k=="channel_map"||k=="group_map"||k=="im_map"||k=="teams"||k=="teams_shared_with"||k=="users")&&!TS.utility.isScalar(file[k])){existing_file[k]=file[k]}else if(k=="video"){if(file[k]&&!TS.utility.areSimpleObjectsEqual(file[k],existing_file[k],"file:"+file.id+" "+file.name)){existing_file[k]=file[k];status="CHANGED";what_changed.push(k)}}else if(existing_file[k]!=file[k]){if(file[k]&&!TS.utility.isScalar(file[k])){existing_file[k]=file[k];TS.warn(k+" is not scalar! it needs to be handled by upsertFile specifically to test if it has changed! "+typeof file[k])}else if(typeof file[k]!="boolean"||!file[k]!=!existing_file[k]){what_changed.push(k+" ["+existing_file[k]+"] -> ["+file[k]+"]");existing_file[k]=file[k];status="CHANGED"}}}}else{status="ADDED";file._rxn_key=TS.rxns.getRxnKey("file",file.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions);delete file.reactions;if(file.comments){for(i=0;i<file.comments.length;i++){comment=file.comments[i];comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions);delete comment.reactions}if(file.initial_comment){file.initial_comment._rxn_key=TS.rxns.getRxnKey("file_comment",file.initial_comment.id);TS.rxns.upsertRxnsFromDataAndUpdateUI(file.initial_comment._rxn_key,file.initial_comment.reactions);delete file.initial_comment.reactions}}files.push(file);var member=TS.members.getMemberById(file.user);if(member){member.files.push(file);TS.files.sortFiles(member.files);member.has_files=true}else{TS.error("hmmm, file "+file.id+" does not have a know user "+file.user)}_addFileToInlineImgs(file);existing_file=file}if(status=="CHANGED"){_addFileToInlineImgs(file);if(_.includes(what_changed,"comments")){TS.utility.msgs.updateCommentReferences(existing_file)}}if(!existing_file.comments){existing_file.comments=[]}else{existing_file.comments_count=Math.max(existing_file.comments_count,existing_file.comments.length)}if(!existing_file.channels){existing_file.channels=[]}if(!existing_file.ims){existing_file.ims=[]}if(!existing_file.groups){existing_file.groups=[]}existing_file.is_shared=existing_file.groups.length>0||existing_file.channels.length>0;TS.files.sortFiles(TS.model.files);return{status:status,file:existing_file,what_changed:what_changed}},upsertAndSignal:function(file){var upsert=TS.files.upsertFile(file);if(upsert.status=="CHANGED"){TS.files.team_file_changed_sig.dispatch(upsert.file)}else if(upsert.status=="ADDED"){TS.files.team_file_added_sig.dispatch(upsert.file)}return upsert},removeFile:function(file_id){TS.log(4,'removing file "'+file_id+'"');var i;var file=TS.files.getFileById(file_id);if(file)file.is_deleted=true;var channels=TS.model.channels;var channel;for(i=0;i<channels.length;i++){channel=channels[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(channel,file);if(file)TS.utility.msgs.removeFileComments(channel,file);TS.utility.msgs.removeFileReferences(channel,file_id)}var groups=TS.model.groups;var group;for(i=0;i<groups.length;i++){group=groups[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(group,file);if(file)TS.utility.msgs.removeFileComments(group,file);TS.utility.msgs.removeFileReferences(group,file_id)}var ims=TS.model.ims;var im;for(i=0;i<ims.length;i++){im=ims[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(im,file);if(file)TS.utility.msgs.removeFileComments(im,file);TS.utility.msgs.removeFileReferences(im,file_id)}var mpims=TS.model.mpims;var mpim;for(i=0;i<mpims.length;i++){mpim=mpims[i];if(file)TS.utility.msgs.removeFileSharesAndMentions(mpim,file);if(file)TS.utility.msgs.removeFileComments(mpim,file);TS.utility.msgs.removeFileReferences(mpim,file_id)}if(file)TS.files.team_file_deleted_sig.dispatch(file)},upload:function(args){if(TS.files.uploading){TS.files.uploadQ.push(args)}else{TS.files.actuallyUpload(args)}},actuallyUpload:function(args){TS.files.uploading=true;args.retry_num=args.retry_num||0;var form_data=new FormData;var display_name;var cancelable=!!args.file;if(args.text){display_name=args.title||args.filetype;TS.files.file_uploading_sig.dispatch(display_name,args.retry_num>0,cancelable);form_data.append("content",args.text);if(args.filetype){form_data.append("filetype",args.filetype)}if(args.filename){TS.warn("ignoring filename because it makes no sense for text files")}}else{display_name=args.title||args.filename||args.file.name||"blob";TS.files.file_uploading_sig.dispatch(display_name,args.retry_num>0,cancelable);if(typeof args.file=="string"){form_data.append("content64",args.file)}else{form_data.append("file",args.file)}if(args.filename){form_data.append("filename",args.filename)}if(args.filetype){TS.warn("ignoring filetype we send a filename which can intuit it")}}form_data.append("token",TS.model.api_token);if(args.channels&&args.channels.length){var channels_str=typeof args.channels=="string"?args.channels:args.channels.join?args.channels.join(","):"";form_data.append("channels",channels_str)}form_data.append("title",args.title);if(args.initial_comment){form_data.append("initial_comment",args.initial_comment)}var api_method="files.uploadAsync";if(args.link){if(args.is_dropbox)api_method="files.uploadExternal";if(args.is_box)api_method="files.uploadExternal";form_data.append("link",args.link)}var url;if(api_method=="files.uploadAsync"){url=TS.model.async_api_url+api_method}else{url=TS.model.api_url+api_method}var errored=false;_current_xhr=$.ajax({url:url,data:form_data,dataType:"json",cache:false,contentType:false,processData:false,type:"POST",xhr:function(){var xhr=jQuery.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var percent_done=parseInt(100*evt.loaded/evt.total,10);TS.files.file_progress_sig.dispatch(percent_done)}else{TS.info("Upload length not computable")}},false)}return xhr},error:function(data,textStatus,errorThrown){errored=true;TS.info("Error: Failed to upload file.");TS.info("textStatus:"+textStatus+" errorThrown:"+errorThrown);TS.info("data:"+data);if(textStatus==="abort"){TS.files.file_canceled_sig.dispatch(display_name);TS.files.uploadOver(false);return}if(args.retry_num===0){args.retry_num++;TS.files.actuallyUpload(args)}else{TS.generic_dialog.start({title:"Upload failed",body:"Hmm, it looks like your file failed to upload. Want to try again?",go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadOver(false)}})}},complete:function(data){if(errored)return;data=jQuery.parseJSON(data.responseText);if(data&&data.ok&&data.file){if(api_method=="files.uploadAsync"){var pollHandler=function(ok,data,args){if(!TS.files.polling_file_id)return;if(ok){if(data.status=="complete"){var upsert=TS.files.upsertAndSignal(data.file);TS.files.uploadProcessingOver(true,upsert.file.id)}else if(data.status=="failed"){var debug_str="";if(data.debug&&TS.boot_data.feature_tinyspeck){debug_str="<br><br>TS only Debugging:<br><br>"+data.debug}TS.generic_dialog.start({title:"Upload failed",body:"Hmm, it looks like your file failed to upload. Want to try again?"+debug_str,go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadProcessingOver(false,TS.files.polling_file_id)}})}else{TS.files.pollForUploadProcessing()}}else{TS.generic_dialog.start({title:"Upload failed",body:"Hmm, it looks like your file failed to upload.",show_cancel_button:true});TS.files.uploadProcessingOver(false,TS.files.polling_file_id)}};TS.files.startPollingForUploadProcessing(data.file,data.ticket,pollHandler)}else{var upsert=TS.files.upsertAndSignal(data.file);TS.files.uploadOver(data.ok,upsert.file.id)}}else{TS.info("Error: Failed to upload file.");TS.info(data);if(data){if(args.retry_num===0){args.retry_num++;TS.files.actuallyUpload(args)}else if(data.error==="folders_not_supported"){TS.generic_dialog.start({title:"Folders not supported",body:"<p>Sorry, <b>"+TS.utility.htmlEntities(args.filename)+"</b> is a folder, and folder uploads are not supported by Slack.</p>									<p>Try uploading a .zip version of the file instead.</p>",show_cancel_button:false,esc_for_ok:true,onGo:function(){TS.generic_dialog.end();TS.files.uploadOver(false)}})}else if(data.error==="request_timeout"){TS.generic_dialog.start({title:"File upload timed out",body:'<p>It looks like you\'re on a slow or inconsistent internet connection. You may want to try your file upload again later. Or, try again now and it might work if you cross your fingers!</p>									<p>If you\'re still having problems, you can:</p><ul><li><a href="/help/test" target="'+TS.templates.builders.newWindowName()+'" class="bold">Run our Self-Help Tests</a></li><li><a href="/help/requests/new" target="'+TS.templates.builders.newWindowName()+'" class="bold">Contact our support team</li></ul>',show_cancel_button:false,esc_for_ok:true,onGo:function(){TS.generic_dialog.end();TS.files.uploadOver(false)}})}else if(data.error==="file_uploads_disabled"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, file uploads have been disabled on this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}})}else if(data.error==="file_uploads_except_images_disabled"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, only images can be uploaded to this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}})}else{TS.generic_dialog.start({title:"Upload failed",body:"Hmm, it looks like your file failed to upload. Want to try again?",go_button_text:"Yes, try again",cancel_button_text:"No, cancel",onGo:function(){args.retry_num++;TS.files.actuallyUpload(args)},onCancel:function(){TS.files.uploadOver(false)}})}}else{alert("Upload failed.");TS.files.uploadOver(false)}}}})},startPollingForUploadProcessing:function(file_id,ticket,pollHandler){TS.files.polling_count=0;TS.files.polling_file_id=file_id;TS.files.polling_ticket=ticket;TS.files.polling_handler=pollHandler;TS.files.pollForUploadProcessing()},pollForUploadProcessing:function(){TS.files.polling_count++;TS.files.polling_tim=setTimeout(function(){if(!TS.files.polling_ticket)return;TS.api.callImmediately("files.uploadStatus",{ticket:TS.files.polling_ticket},function(ok,data,args){if(!TS.files.polling_ticket)return;TS.files.polling_handler(ok,data,args)})},TS.files.polling_count*1e3)},uploadProcessingOver:function(ok,file_id){if(TS.files.polling_file_id!=file_id){return}TS.info("TS.files.uploadProcessingOver polling_file_id:"+TS.files.polling_file_id+" polling_ticket:"+TS.files.polling_ticket+" polling_count:"+TS.files.polling_count);TS.files.polling_count=0;TS.files.polling_file_id=null;TS.files.polling_ticket=null;TS.files.polling_handler=null;clearTimeout(TS.files.polling_tim);TS.files.uploadOver(ok,file_id)},uploadOver:function(ok,file_id){TS.files.file_uploaded_sig.dispatch(ok,file_id);TS.files.uploading=false;_current_xhr=null;if(TS.files.uploadQ.length){TS.files.actuallyUpload.call(null,TS.files.uploadQ.shift())}else{TS.files.file_queue_emptied_sig.dispatch()}},cancelCurrentUpload:function(){if(_current_xhr){_current_xhr.abort()}},deleteFile:function(id){TS.api.call("files.delete",{file:id},TS.files.onFileDelete)},onFileDelete:function(ok,data,args){if(!ok){return}},endEditFileTitle:function(){$("#file_edit_title_container").addClass("hidden");$("#file_title_container").removeClass("hidden")},saveEditFileTitle:function(file_id){var file=TS.files.getFileById(file_id);if(!file)return;var val=$("#file_edit_title_input").val();if(!$.trim(val)){TS.sounds.play("beep");return}var prev_title=file.title;if(prev_title==val){TS.files.endEditFileTitle();return}TS.api.callImmediately("files.edit",{file:file_id,title:val},function(ok,data,args){if(!ok){TS.files.upsertAndSignal({id:file_id,title:prev_title});TS.generic_dialog.alert("Something's gone wrong, and your change didn't save. If you see this message more than once, you may want to try restarting Slack.","Oh, crumbs!","Got it")}});val=TS.utility.htmlEntities(val);TS.files.upsertAndSignal({id:file_id,title:val});TS.files.endEditFileTitle()},editFileTitle:function(file_id){var file=TS.files.getFileById(file_id);if(!file)return;var title=file.title;if(title){title=TS.format.unFormatMsg(title)}else{title=file.name}$("#file_title_container").addClass("hidden");$("#file_edit_title_container").removeClass("hidden");$("#file_edit_title_input").val(title);$("#file_edit_title_input").select()},openBoxChooser:function(){TS.utility.box.unregister(TS.utility.box.SUCCESS_EVENT_TYPE,TS.files.onBoxChooser);TS.utility.box.success(TS.files.onBoxChooser);TS.utility.box.launchPopup()},onBoxChooser:function(box_files){var files=new Array(box_files.length);for(var i=0;i<box_files.length;i++){var b=box_files[i];files[i]={name:b.name,link:b.url,is_box:true}}TS.ui.upload_dialog.startWithCommentFromChatInput(files)},openDropboxChooser:function(){var linkType="preview";Dropbox.choose({success:TS.files.onDropboxChooser,linkType:linkType,multiselect:true})},onDropboxChooser:function(dropbox_files){var files=[];for(var i=0;i<dropbox_files.length;i++){var d=dropbox_files[i];files.push({name:d.name,size:d.bytes,link:d.link,icon:d.icon,is_dropbox:true})}TS.ui.upload_dialog.startWithCommentFromChatInput(files)},makeFileNameFromFile:function(file){var now=Date.now()/1e3;return file.name||"Pasted image at "+TS.utility.date.toFilenameFriendlyDate(now)+".png"},makeFileTitleFromFile:function(file){var now=Date.now()/1e3;return file.name||"Pasted image at "+TS.utility.date.toDate(now)},justUploadTheseFileNow:function(files){var file;for(var i=0;i<files.length;i++){file=files[i];if(file.size>TS.model.upload_file_size_limit_bytes){continue}TS.files.upload({file:file,filename:TS.files.makeFileNameFromFile(file),title:TS.files.makeFileTitleFromFile(file),channels:[TS.shared.getActiveModelOb().id],initial_comment:""})}},refreshFile:function(id){TS.files.startRefreshingFile(id);TS.api.call("files.refresh",{file:id},TS.files.onFileRefresh)},onFileRefresh:function(ok,data,args){var id=args.file;if(ok){TS.menu.$menu.find("#refresh_file").find(".item_label").text("File refreshed!").end()}else if(!ok){TS.files.doneRefreshingFile(id,'<span class="moscow_red">Refresh failed.</span>',5e3);TS.menu.$menu.find("#refresh_file").find(".item_label").text("Refresh failed").end()}if(ok&!data.will_refresh){TS.files.doneRefreshingFile(id,'<span class="moscow_red">File refreshed < 1 minute ago.</span>',5e3)}if(TS.web&&ok){TS.menu.$menu.find("#refresh_file").find(".item_label").text("Reloading...");location.reload()}if(!ok){if(data.error=="file_deleted"){var existing_file=TS.files.getFileById(id);if(existing_file){TS.files.removeFile(existing_file.id)}}return}},fileWasMaybeRefreshed:function(file){if(!file)return;if(!TS.files.waiting_for_refresh[file.id])return;TS.files.doneRefreshingFile(file.id,'<span class="kelly_green">File refreshed!</span>',6e4)},startRefreshingFile:function(id){TS.files.waiting_for_refresh[id]=true;$('.file_refresh[data-file-id="'+id+'"]').addClass("hidden");$('.file_refresh_status[data-file-id="'+id+'"]').removeClass("hidden")},doneRefreshingFile:function(id,msg,ms){delete TS.files.waiting_for_refresh[id];$('.file_refresh_status[data-file-id="'+id+'"]').html(msg);setTimeout(function(){$('.file_refresh[data-file-id="'+id+'"]').removeClass("hidden");$('.file_refresh_status[data-file-id="'+id+'"]').text("Refreshing file...").addClass("hidden");
},ms)},shareOrReshareFile:function(file_id,hide_file_preview,space_has_title,source_model_ob_id){var file=TS.files&&TS.files.getFileById?TS.files.getFileById(file_id):null;var can_reshare=false;var is_owned_by_other=file.user!=TS.model.user.id;var is_owned_by_a_user=!file.bot_id;if(TS.files.isFilePrivate(file)&&is_owned_by_other&&is_owned_by_a_user){can_reshare=true}if(!file){TS.error("File for reshare doesn't exist: "+file_id);return}else if(can_reshare){TS.files.reShareConfirmation([file],function(){TS.ui.share_dialog.start(file_id,hide_file_preview,space_has_title,source_model_ob_id)})}else{TS.ui.share_dialog.start(file_id,hide_file_preview,space_has_title,source_model_ob_id)}},reShareConfirmation:function(files,callback){var file_owners=files.map(function(file){return TS.members.getMemberDisplayNameById(file.user,true)});file_owners=_.uniq(file_owners);var user_names=TS.utility.concatNames(file_owners);var has_pluralization="has";var file_pluralization="this file";var msg_title="You're about to share a private file";var it_pluralization="it";if(file_owners.length>1){has_pluralization="have"}if(files.length>1){file_pluralization="these files";msg_title="You're about to share private files";it_pluralization="them"}else{var title=files[0].title||"Untitled";title=TS.format.formatNoSpecials(title);file_pluralization="the file <b>"+title+"</b>"}var msg_body="<p><b>"+user_names+"</b> "+has_pluralization+" privately shared "+file_pluralization+" with you. Are you sure you want to proceed with sharing "+it_pluralization+" somewhere else?</p><p>Its important to note that any comments on "+file_pluralization+" will also be shared.</p>";TS.generic_dialog.start({title:msg_title,body:msg_body,show_cancel_button:true,show_go_button:true,go_button_text:"Proceed with sharing",cancel_button_text:"Cancel",onGo:callback})},updateFileListItem:function(file,$container){var $file_list_item=$container.find('.file_list_item[data-file-id="'+file.id+'"]');if($file_list_item.length){$file_list_item.replaceWith(TS.templates.builders.fileHTML(file));if(TS.files.fileIsImage(file))$container.find(".lazy").lazyload()}}});var _current_xhr=null;var _files_page_size=20;var _addFileToInlineImgs=function(file){if(!TS.files.fileIsImage(file))return;var inline_img={width:file.thumb_360_w,height:file.thumb_360_h,link_url:file.url_private,internal_file_id:file.id};if(TS.boot_data.feature_a11y_pref_no_animation&&file.filetype==="gif"){if(file.deanimate_gif){TS.inline_imgs.makeInternalInlineImg(file.deanimate_gif,inline_img)}else if(file.thumb_160){TS.inline_imgs.makeInternalInlineImg(file.thumb_160,inline_img)}}if(file.thumb_480_gif||file.thumb_360_gif){if(file.thumb_480_gif)TS.inline_imgs.makeInternalInlineImg(file.thumb_480_gif,inline_img);if(file.thumb_360_gif)TS.inline_imgs.makeInternalInlineImg(file.thumb_360_gif,inline_img)}else{if(file.thumb_720)TS.inline_imgs.makeInternalInlineImg(file.thumb_720,inline_img);if(file.thumb_480)TS.inline_imgs.makeInternalInlineImg(file.thumb_480,inline_img);if(file.thumb_360)TS.inline_imgs.makeInternalInlineImg(file.thumb_360,inline_img)}};var _fetchFileInfoWorker=function(id,raw,callback){var handleRsp=function(rsp){var file;if(rsp&&rsp.data){var no_upsert=!!raw;_onFileFetch(rsp.data.ok,rsp.data,rsp.args,no_upsert);file=raw?rsp.data.file:TS.files.getFileById(id)}if(callback){callback(id,file)}return file||id};return TS.api.call("files.info",{file:id,page:1,count:500,truncate:1}).then(function(response){return handleRsp(response)}).catch(function(err){return handleRsp(err)})};var _onFileFetch=function(ok,data,args,no_upsert){if(!ok){if(data.error=="file_deleted"){var existing_file=TS.files.getFileById(args.file);if(existing_file){TS.files.removeFile(existing_file.id)}else if(args.file){TS.files.removeFile(args.file)}}else if(data.error=="file_not_found"){TS.files.removeFile(args.file)}return}if(data.file){data.file.comments=data.comments;data.file.content=data.content;data.file.content_html=data.content_html;data.file.content_highlight_html=data.content_highlight_html;if(!no_upsert){TS.files.upsertAndSignal(data.file)}}};var _ensureFileObject=function(file_or_file_id){var file=_.isString(file_or_file_id)?TS.files.getFileById(file_or_file_id):file_or_file_id;if(!_.isObject(file))throw"Expected file or file ID.";return file}})();(function(){"use strict";TS.registerModule("rooms",{added_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_participants_sig:new signals.Signal,changed_date_end_sig:new signals.Signal,changed_channels_sig:new signals.Signal,onStart:function(){},getRoomById:function(id){return TS.rooms.getRoomByProp("id",id)},getRoomByProp:function(name,value){if(!name)return null;var rooms=TS.model.rooms;var room;for(var i in rooms){room=rooms[i];if(room[name]===value)return room}return null},upsertAndSignal:function(room){var upsert=TS.rooms.upsertRoom(room);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("name")!=-1){TS.rooms.changed_name_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("participants")!=-1){TS.rooms.changed_participants_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("date_end")!=-1){TS.rooms.changed_date_end_sig.dispatch(upsert.room)}if(upsert.what_changed.indexOf("channels")!=-1){TS.rooms.changed_channels_sig.dispatch(upsert.room)}}else if(upsert.status=="ADDED"){TS.rooms.added_sig.dispatch(upsert.room)}return upsert},upsertRoom:function(room){var rooms=TS.model.rooms;var existing_room=TS.rooms.getRoomById(room.id);var status="NOOP";var what_changed=[];var c_ids_to_save;if(room.date_start)room.date_start=Number(room.date_start);if(room.date_end)room.date_end=Number(room.date_end);if(room.was_rejected)room.was_rejected=Boolean(room.was_rejected);if(room.is_dm_call)room.is_dm_call=Boolean(room.is_dm_call);if(room.was_missed)room.was_missed=Boolean(room.was_missed);if(existing_room){TS.log(4,'updating existing room "'+room.id+'"');c_ids_to_save=existing_room.channels||[];for(var k in room){var special_struct_keys=["participants","channels","participant_history","participants_camera_on","participants_camera_off","participants_screenshare_on","participants_screenshare_off"];if(special_struct_keys.indexOf(k)!==-1){if(room[k]&&!TS.utility.areSimpleObjectsEqual(room[k],existing_room[k])){what_changed.push(k);existing_room[k]=room[k];status="CHANGED";if(k=="channels"){c_ids_to_save=c_ids_to_save.concat(room[k]||[])}}}else if(existing_room[k]!=room[k]){if(room[k]&&!TS.utility.isScalar(room[k])){existing_room[k]=room[k];TS.warn(k+" is not scalar! it needs to be handled by upsertRoom specifically to test if it has changed! "+typeof room[k])}else if(typeof room[k]!="boolean"||!room[k]!=!existing_room[k]){what_changed.push(k);existing_room[k]=room[k];status="CHANGED"}}}room=existing_room}else if(room.id){status="ADDED";TS.log(4,'adding room "'+room.id);rooms.push(room)}else{TS.error("bad error, no room.id")}return{status:status,room:room,what_changed:what_changed}}})})();(function(){"use strict";TS.registerModule("ims",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,closed_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,opened_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,addMsg:function(id,msg){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}if(!TS.shared.addMsg(im,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.ims.calcUnreadCnts(im,and_mark);TS.utility.msgs.maybeTruncateMsgs(im);TS.ims.message_received_sig.dispatch(im,msg);if(!im.is_open){TS.api.call("im.open",{user:im.user,return_im:true,reason:"TS.ims.addMsg"},TS.ims.onOpened)}},calcUnreadCnts:function(im,and_mark){TS.shared.calcUnreadCnts(im,TS.ims,and_mark)},removeMsg:function(id,msg){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}if(im._archive_msgs)TS.utility.msgs.spliceMsg(im._archive_msgs,msg);var msgs=im.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.ims.message_removed_sig.dispatch(im,msg);TS.ims.calcUnreadCnts(im,true)},changeMsgText:function(id,msg,txt){var im=TS.ims.getImById(id);if(!im){TS.error('unknown im "'+id+'"');return}msg.text=txt;TS.ims.message_changed_sig.dispatch(im,msg)},sendMsg:function(im_id,text,in_reply_to_msg,should_broadcast_reply){return TS.shared.sendMsg(im_id,text,TS.ims,in_reply_to_msg,should_broadcast_reply)},onSendMsg:function(success,imsg){var im=TS.ims.getImById(imsg.SENT_MSG.channel);if(!im){TS.error("unknown im? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,im,TS.ims)},closeImByMemberId:function(member_id){var im=TS.ims.getImByMemberId(member_id);if(!im){return}TS.ims.closeIm(im.id)},closeIm:function(id){var im=TS.ims.getImById(id);if(!im||!im.is_open)return;im.is_open=false;var is_im_active=TS.model.active_im_id==id;if(is_im_active&&TS.client)TS.client.activeChannelDisplayGoneAway();TS.ims.onClosed(true,{no_op:!is_im_active},{channel:id});TS.api.call("im.close",{channel:id}).catch(function(){im.is_open=true;TS.ims.onClosed(true,{no_op:!is_im_active},{channel:id})})},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var im=TS.ims.getImById(args.channel);if(im)TS.ims.closed_sig.dispatch(im)}},startImById:function(id,from_history,and_send_txt){var im=TS.ims.getImById(id);if(!im){TS.error(id+" not an im");return}TS.ims.startImByMemberId(im.user,from_history,and_send_txt)},startImByMemberName:function(member_name,from_history,and_send_txt){var member=TS.members.getMemberByName(member_name);if(!member){TS.error("no member?? "+member_name);return}TS.ims.startImByMemberId(member.id,from_history,and_send_txt)},startImByMemberId:function(member_id,from_history,and_send_txt){var im=TS.ims.getImByMemberId(member_id);if(im){TS.ims.displayIm(im.id,from_history);if(im.is_open){if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}return Promise.resolve()}}TS.model.requested_im_opens[member_id]={and_send_txt:and_send_txt};return TS.api.call("im.open",{user:member_id,return_im:true,reason:"TS.ims.startImByMemberId"},TS.ims.onOpened)},promiseToStartImByMemberId:function(member_id,from_history,and_send_txt,callback){var start_p=TS.ims.startImByMemberId(member_id,from_history,and_send_txt,callback);var isActive=function(){var now_active=TS.shared.getActiveModelOb();return now_active&&now_active.is_im&&now_active.user===member_id};if(isActive())return Promise.resolve();return start_p.then(function(){if(isActive())return Promise.resolve();var im_switched;return new Promise(function(resolve){im_switched=function(){if(isActive())return resolve()};TS.ims.switched_sig.add(im_switched)}).timeout(3e4).finally(function(){delete TS.model.requested_im_opens[member_id];TS.ims.switched_sig.remove(im_switched)})})},onOpened:function(ok,data,args){if(!ok){return}if(args.return_im&&data.channel){TS.ims.upsertIm(data.channel)}},displayIm:function(im_id,from_history,and_send_txt){if(TS.isPartiallyBooted()&&im_id!==TS.model.initial_cid){TS.warn("Can't switch model objects during incremental boot; this is a programming error");TS.sounds.play("beep");return}TS.metrics.mark("start_channel_change_"+im_id);var im=TS.ims.getImById(im_id);if(!im){TS.error('im "'+im_id+'" unknown');return}TS.utility.msgs.maybeClearPrevLastRead();TS.utility.msgs.maybeClearPrevLastRead(im);TS.shared.maybeClearHasAutoScrolled();if(im._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(im,TS.ims)}if(im_id==TS.model.active_im_id&&!TS.client.activeChannelIsHidden()){if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}return}var no_history_add=from_history;if(TS.client.channelDisplaySwitched(im_id,false,no_history_add)){TS.ims.pre_switched_sig.dispatch();TS.ims.switched_sig.dispatch()}if(and_send_txt){TS.ims.sendMsg(im.id,$.trim(and_send_txt))}},setLastRead:function(im,ts,reason){if(im.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(im.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[im.id+"_"+ts];delete TS.model.last_reads_set_by_client[im.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time im.last_read:"+im.last_read+" new:"+ts);return}TS.info("going back in time im.last_read:"+im.last_read+" new:"+ts);TS.utility.msgs.maybeClearPrevLastRead(im);TS.utility.msgs.setPrevLastRead(im,ts)}else{TS.utility.msgs.maybeClearPrevLastRead(im);TS.utility.msgs.maybeSetPrevLastRead(im,ts)}im.last_read=ts;if(TS.boot_data.feature_pin_update){if(reason)im._marked_reason=reason}TS.ims.marked_sig.dispatch(im);TS.utility.msgs.maybeClearUsersCountsInfo(im);TS.ims.calcUnreadCnts(im);return true},markMostRecentReadMsg:function(im,reason,allow_latest_via_users_counts){if(!im){TS.error("im unknown");return}if((!im.msgs||!im.msgs.length)&&!allow_latest_via_users_counts)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(im);if(!most_recent_valid_ts){if(im.msgs&&im.msgs.length||!im._latest_via_users_counts)TS.warn('no valid tses for im "'+im.id+'"???');return}TS.utility.msgs.maybeClearUsersCountsMentionCountDisplay(im);im.all_read_this_session_once=true;TS.ims.markReadMsg(im.id,most_recent_valid_ts,reason)},markReadMsg:function(im_id,ts,reason){var im=TS.ims.getImById(im_id);if(!im){TS.error('im "'+im_id+'" unknown');return}if(im.last_read==ts){return}if(TS.ims.setLastRead(im,ts,reason)){im._marked_reason=reason;im.needs_api_marking=true}},onMarked:function(ok,data,args){var im=TS.ims.getImById(args.channel);if(!im){TS.error('wtf no im "'+args.channel+'"');return}if(!ok)im.needs_api_marking=true},getImById:function(id){if(TS.model.submodel)return TS.model.submodel.getImById(id);var ims=TS.model.ims;var im=_id_map[id];if(im){return im}if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.id==id){TS.warn(id+" not in _id_map");_id_map[id]=im;return im}}return null},getDisplayNameOfUserForIm:function(im){if(TS.boot_data.feature_name_tagging_client){return TS.members.getMemberFullName(im.user)}else{return TS.members.getMemberDisplayName(TS.members.getMemberById(im.user))}},getDisplayNameOfUserForImLowerCase:function(im){return TS.members.getMemberDisplayNameLowerCase(TS.members.getMemberById(im.user))},getImByUsername:function(name){if(TS.model.submodel)return TS.model.submodel.getImByUsername(name);var member=TS.members.getMemberByName(name);if(!member)return null;return TS.ims.getImByMemberId(member.id)},getImByMemberId:function(id){if(TS.model.submodel)return TS.model.submodel.getImByMemberId(id);var ims=TS.model.ims;var im=_member_id_map[id];if(im){return im}if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.user==id){TS.warn(id+" not in _member_id_map?");_member_id_map[id]=im;return im}}return null},getFirstOpenIm:function(){var ims=TS.model.ims;var im;if(!ims)return null;for(var i=0;i<ims.length;i++){im=ims[i];if(im.is_open)return im}return null},isImWithDeletedMember:function(model_ob){if(!model_ob.is_im)return false;var member=TS.members.getMemberById(model_ob.user);if(!member||!member.deleted)return false;return true},setNameFromMember:function(member){var im=member._submodel?member._submodel.getImByMemberId(member.id):TS.ims.getImByMemberId(member.id);if(!im)return;_setName(im,member)},upsertIm:function(im){var ims=TS.model.ims;var existing_im=TS.ims.getImById(im.id);if(TS.boot_data.feature_no_unread_counts){delete im.unread_count}if(existing_im){if(TS.pri)TS.log(4,'updating existing im "'+im.id+'"');for(var k in im){existing_im[k]=im[k]}im=existing_im;if(TS.isPartiallyBooted()&&im.oldest_msg_ts===null){im.oldest_msg_ts=TS.storage.fetchOldestTs(im.id)}TS.shared.maybeResetHistoryFetched(im);if(TS.client&&(im.is_open||im.unread_cnt)){var should_defer_initial_msg_history=true;TS.shared.checkInitialMsgHistory(im,TS.ims,should_defer_initial_msg_history)}}else{if(TS.pri)TS.log(4,'adding im "'+im.id+'"');ims.push(im);TS.utility.ensureInArray(TS.model.all_im_ids,im.id);var member=TS.members.getMemberById(im.user);_processNewImForUpserting(im,member);_id_map[im.id]=im;_member_id_map[im.user]=im}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(im);if(TS.model.active_cid==im.id){TS.ims.calcUnreadCnts(im,and_mark)}else{if(!existing_im)TS.ims.calcUnreadCnts(im,and_mark)}}return im},processNewImForUpserting:function(im){_processNewImForUpserting(im)},markScrollTop:function(id,scroll_top){var im=TS.ims.getImById(id);if(!im)return false;if(im.scroll_top==scroll_top){return false}im.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var im=TS.ims.getImById(id);if(!im)return false;return TS.shared.maybeLoadScrollBackHistory(im,TS.ims,force)},onHistory:function(ok,data,args){var im=TS.ims.getImById(args.channel);if(!im){TS.error('wtf no im "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");im.history_fetch_retries?im.history_fetch_retries++:im.history_fetch_retries=1;TS.ims.history_fetched_sig.dispatch(im);return}delete im.history_fetch_retries;var fetching_more=TS.shared.onHistory(im,data,args,TS.ims);if(!fetching_more){im.history_is_being_fetched=false;TS.ims.history_fetched_sig.dispatch(im)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(im);TS.ims.calcUnreadCnts(im,and_mark);if(TS.view){if(!fetching_more&&im.unread_cnt){TS.client.channel_pane.rebuild("ims")}}},fetchHistory:function(im,api_args,handler){if(!im){TS.error('wtf no im "'+im+'"');return}TS.shared.maybeClearHasAutoScrolled(im);im.history_is_being_fetched=true;im.history_fetch_failed=false;TS.ims.history_being_fetched_sig.dispatch(im);if(im.history_fetch_retries>5){delete im.history_fetch_retries;im.history_is_being_fetched=false;im.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("im.history",api_args,handler||TS.ims.onHistory)},checkForOldImsToClose:function(){return TS.shared.checkForOldImsToClose()},setDataRetention:function(im_id,retention_type,retention_duration,handler){var args={channel:im_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("im.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.ims.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(im_id,handler){TS.api.call("im.getRetention",{channel:im_id},handler)}});var _id_map={};var _member_id_map={};var _setName=function(im,member){if(TS._incremental_boot&&im.name){}else{im.name=im.user}if(member)im.name=member.name;im._name_lc=_.toLower(im.name)};var _processNewImForUpserting=function(im,member){im._hotness=0;TS.shared.setPriorityForDev(im);im.is_im=true;_setName(im,member);if(member){if(member.is_slackbot){im.is_slackbot_im=true}else if(member.is_self){im.is_self_im=true}}TS.shared.maybeResetHistoryFetched(im);im.opened_this_session=false;im.scroll_top=-1;im.history_is_being_fetched=false;im.needs_api_marking=false;im.unread_highlight_cnt=0;im.unread_highlights=[];im.unread_cnt=0;im.unreads=[];im.oldest_unread_ts=null;im.has_fetched_history_after_scrollback=false;if(TS.client){if(TS._incremental_boot&&im.msgs&&im.msgs.length>0){im.msgs=im.msgs.map(function(msg){return TS.utility.msgs.processImsg(msg,im.id)});TS.utility.msgs.setMsgs(im,im.msgs)}else{TS.utility.msgs.setMsgs(im,[])}}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(im)}}im.oldest_msg_ts=TS.storage.fetchOldestTs(im.id)||null;im.last_msg_input=TS.storage.fetchLastMsgInput(im.id)||null}})();(function(){"use strict";TS.registerModule("mpims",{switched_sig:new signals.Signal,pre_switched_sig:new signals.Signal,joined_sig:new signals.Signal,member_joined_sig:new signals.Signal,history_fetched_sig:new signals.Signal,history_being_fetched_sig:new signals.Signal,message_received_sig:new signals.Signal,message_removed_sig:new signals.Signal,message_changed_sig:new signals.Signal,marked_sig:new signals.Signal,closed_sig:new signals.Signal,unread_changed_sig:new signals.Signal,unread_highlight_changed_sig:new signals.Signal,opened_sig:new signals.Signal,msg_not_sent_sig:new signals.Signal,data_retention_changed_sig:new signals.Signal,onStart:function(){TS.prefs.display_real_names_override_changed_sig.add(_realNamePrefChanged);TS.prefs.team_display_real_names_changed_sig.add(_realNamePrefChanged);if(TS.boot_data.feature_name_tagging_client){TS.prefs.display_preferred_names_changed_sig.add(_realNamePrefChanged)}TS.members.changed_profile_sig.add(_memberRealNameChanged)},getVisibleMpims:function(){var all=TS.model.mpims;return all.filter(function(mpim){if(mpim.is_open)return true;if(mpim.is_starred)return true;if(mpim.unread_cnt)return true;if(!mpim.latest&&(!mpim.msgs||!mpim.msgs.length))return false;if(mpim.members&&mpim.members.length===2)return false;if(TS.model.user.is_ultra_restricted)return true;return true})},addMsg:function(id,msg){var mpim=TS.mpims.getMpimById(id);if(!mpim){TS.error('unknown mpim "'+id+'"');return}if(!TS.shared.addMsg(mpim,msg))return;var and_mark=!TS.utility.msgs.isTempMsg(msg);TS.mpims.calcUnreadCnts(mpim,and_mark);TS.utility.msgs.maybeTruncateMsgs(mpim);TS.mpims.message_received_sig.dispatch(mpim,msg);if(!mpim.is_open&&TS.utility.msgs.msgCanCountAsUnread(msg)){if(mpim.members.length==1){var user=mpim.members[0];TS.api.call("im.open",{user:user,return_im:true,reason:"TS.mpims.addMsg"},TS.ims.onOpened)}else if(mpim.members.length>1){var users=mpim.members.join(",");TS.api.call("mpim.open",{users:users},TS.mpims.onOpened)}else{}}},calcUnreadCnts:function(mpim,and_mark){TS.shared.calcUnreadCnts(mpim,TS.mpims,and_mark)},removeMsg:function(id,msg){var mpim=TS.mpims.getMpimById(id);if(!mpim){TS.error('unknown mpim "'+id+'"');return}if(mpim._archive_msgs)TS.utility.msgs.spliceMsg(mpim._archive_msgs,msg);var msgs=mpim.msgs;TS.utility.msgs.spliceMsg(msgs,msg);TS.mpims.message_removed_sig.dispatch(mpim,msg);TS.mpims.calcUnreadCnts(mpim,true)},changeMsgText:function(id,msg,txt){},sendMsg:function(mpim_id,text,in_reply_to_msg,should_broadcast_reply){return TS.shared.sendMsgGroup(mpim_id,text,TS.mpims,in_reply_to_msg,should_broadcast_reply)},onSendMsg:function(success,imsg){var mpim=TS.mpims.getMpimById(imsg.SENT_MSG.channel);if(!mpim){TS.error("unknown mpim? "+imsg.SENT_MSG.channel);return}TS.shared.onSendMsg(success,imsg,mpim,TS.mpims)},closeMpim:function(id){var mpim=TS.mpims.getMpimById(id);if(!mpim){return}TS.api.call("mpim.close",{channel:id},TS.mpims.onClosed)},onClosed:function(ok,data,args){if(!ok){return}if(data.no_op){var mpim=TS.mpims.getMpimById(args.channel);if(mpim)TS.mpims.closed_sig.dispatch(mpim)}},startMpimWithMembers:function(members,callback){var ids=members.map(function(user){return user.id});ids=ids.join(",");TS.api.call("mpim.open",{users:ids},function(ok,data,args){if(data.group){var mpim=TS.mpims.upsertMpim(data.group);if(mpim){TS.mpims.displayMpim(mpim.id)}else{TS.error("no mpim?!?")}}if(callback)callback(ok,data,args)})},onOpened:function(ok,data){if(!ok){return}},displayMpim:function(mpim_id,and_send_txt,from_history,replace_history_state){if(TS.isPartiallyBooted()&&mpim_id!==TS.model.initial_cid){TS.warn("Can't switch model objects during incremental boot; this is a programming error");TS.sounds.play("beep");return}TS.metrics.mark("start_channel_change_"+mpim_id);from_history=!!from_history;replace_history_state=!!replace_history_state;var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.error('mpim "'+mpim_id+'" unknown');return}TS.utility.msgs.maybeClearPrevLastRead();TS.utility.msgs.maybeClearPrevLastRead(mpim);TS.shared.maybeClearHasAutoScrolled();if(mpim._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(mpim,TS.mpims)}if(mpim_id==TS.model.active_mpim_id&&!replace_history_state&&!TS.client.activeChannelIsHidden()){TS.warn('mpim "'+mpim_id+'" already displayed');if(and_send_txt){TS.mpims.sendMsg(mpim_id,$.trim(and_send_txt))}return}var no_history_add=replace_history_state?false:from_history;if(TS.client.channelDisplaySwitched(mpim_id,replace_history_state,no_history_add)){TS.mpims.pre_switched_sig.dispatch();TS.mpims.switched_sig.dispatch()}if(mpim.is_open){if(and_send_txt){TS.mpims.sendMsg(mpim_id,$.trim(and_send_txt))}return}TS.model.requested_mpim_opens[mpim_id]={and_send_txt:and_send_txt};var user_ids=mpim.members.filter(function(member_id){return TS.model.user.id!==member_id});TS.api.call("mpim.open",{users:user_ids.join(",")},TS.mpims.onOpened)},setLastRead:function(mpim,ts,reason){if(mpim.last_read==ts){return false}if(ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1){TS.error("bad ts:"+ts);return false}if(mpim.last_read>ts){var dont_allow_back_setting=TS.model.last_reads_set_by_client[mpim.id+"_"+ts];delete TS.model.last_reads_set_by_client[mpim.id+"_"+ts];if(dont_allow_back_setting){TS.warn("NOT going back in time mpim.last_read:"+mpim.last_read+" new:"+ts);return}TS.info("going back in time mpim.last_read:"+mpim.last_read+" new:"+ts);TS.utility.msgs.maybeClearPrevLastRead(mpim);TS.utility.msgs.setPrevLastRead(mpim,ts)}else{TS.utility.msgs.maybeClearPrevLastRead(mpim);TS.utility.msgs.maybeSetPrevLastRead(mpim,ts)}mpim.last_read=ts;if(TS.boot_data.feature_pin_update){if(reason)mpim._marked_reason=reason}TS.mpims.marked_sig.dispatch(mpim);TS.utility.msgs.maybeClearUsersCountsInfo(mpim);TS.mpims.calcUnreadCnts(mpim);return true},markMostRecentReadMsg:function(mpim,reason,allow_latest_via_users_counts){if(!mpim){TS.error("mpim unknown");return}if((!mpim.msgs||!mpim.msgs.length)&&!allow_latest_via_users_counts)return;var most_recent_valid_ts=TS.utility.msgs.getMostRecentValidTs(mpim);if(!most_recent_valid_ts){if(mpim.msgs&&mpim.msgs.length||!mpim._latest_via_users_counts)TS.warn('no valid tses for mpim "'+mpim.id+'"???');return}TS.utility.msgs.maybeClearUsersCountsMentionCountDisplay(mpim);mpim.all_read_this_session_once=true;TS.mpims.markReadMsg(mpim.id,most_recent_valid_ts,reason)},markReadMsg:function(mpim_id,ts,reason){var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.error('mpim "'+mpim_id+'" unknown');return}if(mpim.last_read==ts){return}if(TS.mpims.setLastRead(mpim,ts,reason)){mpim._marked_reason=reason;mpim.needs_api_marking=true}},onMarked:function(ok,data,args){var mpim=TS.mpims.getMpimById(args.channel);if(!mpim){TS.error('wtf no mpim "'+args.channel+'"');return}if(!ok)mpim.needs_api_marking=true},getMpimById:function(id){if(TS.model.submodel)return TS.model.submodel.getMpimById(id);var mpims=TS.model.mpims;var mpim=_id_map[id];if(mpim){return mpim}if(!mpims)return null;for(var i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=mpim;return mpim}}return null},getMpimByName:function(name){name=_.toLower(name);if(TS.model.submodel)return TS.model.submodel.getMpimByName(name);var mpims=TS.model.mpims;var mpim=_name_map[name];if(mpim)return mpim;if(!mpims)return null;for(var i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim._name_lc==name){TS.warn(name+" not in _name_map?");_name_map[mpim._name_lc]=mpim;_name_map[mpim._internal_name]=mpim;return mpim}}return null},getActiveMembers:function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);return members.filter(function(m){return!m.deleted})},getMembersInDisplayOrder:function(mpim){if(!mpim)return;if(mpim._members&&mpim._members.length===mpim.members.length-1)return mpim._members;mpim._members=_.without(mpim.members,TS.model.user.id).map(function(user_id){return mpim._submodel?mpim._submodel.getMemberById(user_id):TS.members.getMemberById(user_id)});return mpim._members},getDisplayName:function(mpim,for_header,show_last_initial,truncate_at){var should_truncate=_.isInteger(truncate_at);if(mpim._display_name&&!for_header&&!show_last_initial&&!should_truncate)return mpim._display_name;if(mpim._display_name_truncated&&!for_header&&!show_last_initial&&should_truncate)return mpim._display_name_truncated;var members=TS.mpims.getMembersInDisplayOrder(mpim);if(TS.boot_data.feature_name_tagging_client)return _getDisplayTitle(mpim,for_header);var display_real_names=TS.members.shouldDisplayRealNames();var first_name_map={};if(display_real_names){members.forEach(function(member){if(member.profile.first_name){if(!first_name_map[member.profile.first_name])first_name_map[member.profile.first_name]=[];first_name_map[member.profile.first_name].push(member)}})}var names=members.map(function(member){if(member.profile.first_name&&display_real_names){var first_name=$.trim(member.profile.first_name);var last_name=$.trim(member.profile.last_name);var name=first_name;if(first_name_map[first_name]&&first_name_map[first_name].length>1&&last_name||show_last_initial){name+=" "+_getFirstLetter(last_name)+"."}if(for_header){name=TS.utility.htmlEntities($.trim(name));name='<li class="mpdm_member '+TS.templates.makeMemberDomId(member)+" "+TS.templates.makeMemberPresenceStateClass(member)+'" data-member-id="'+member.id+'">'+name+"</li>"}return name}else{var user_name=$.trim(member.name);if(for_header){user_name=TS.utility.htmlEntities(user_name);user_name='<li class="mpdm_member '+TS.templates.makeMemberDomId(member)+" "+TS.templates.makeMemberPresenceStateClass(member)+'" data-member-id="'+member.id+'">'+user_name+"</li>"}return user_name}});var display_name;if(should_truncate&&for_header){display_name=names.slice(0,truncate_at).join(" ")}else if(for_header){display_name=names.join(" ")}else if(should_truncate&&names.length>truncate_at+1){var show_names=names.splice(0,truncate_at);display_name=show_names.join(", ")+" and "+names.length+" others"}else{display_name=names.join(", ")}if(!for_header&&!show_last_initial&&!should_truncate)mpim._display_name=display_name;if(!for_header&&!show_last_initial&&should_truncate)mpim._display_name_truncated=display_name;return display_name},getDisplayNameLowerCase:function(mpim){if(mpim._display_name_lc)return mpim._display_name_lc;var display_name=TS.mpims.getDisplayName(mpim);mpim._display_name_lc=_.toLower(display_name);return mpim._display_name_lc},getTooltipText:function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);var names=members.map(function(member){if(member.profile.real_name)return member.profile.real_name;return member.name});var tooltip=names.join(", ");if(tooltip===TS.mpims.getDisplayName(mpim))return"";return tooltip},getMpimArchivesPath:function(mpim){return"/archives/"+mpim.id},getMemberCount:function(mpim){return Math.min(Math.max(mpim.members.length-1,2),9)},upsertMpim:function(mpim_group){var mpims=TS.model.mpims;var existing_mpim=TS.mpims.getMpimById(mpim_group.id);if(TS.boot_data.feature_no_unread_counts){delete mpim_group.unread_count}if(existing_mpim){TS.log(4,'updating existing mpim "'+existing_mpim.id+'"');for(var k in mpim_group){if(k==="name")continue;existing_mpim[k]=mpim_group[k]}mpim_group=existing_mpim;if(TS.isPartiallyBooted()&&mpim_group.oldest_msg_ts===null){mpim_group.oldest_msg_ts=TS.storage.fetchOldestTs(mpim_group.id)}TS.shared.maybeResetHistoryFetched(existing_mpim);if(TS.client&&(mpim_group.is_open||mpim_group.unread_cnt)){var should_defer_initial_msg_history=true;TS.shared.checkInitialMsgHistory(mpim_group,TS.mpims,should_defer_initial_msg_history)}}else{TS.log(4,'adding mpim "'+mpim_group.id+'"');mpims.push(mpim_group);TS.utility.ensureInArray(TS.model.all_group_ids,mpim_group.id);_processNewMpimForUpserting(mpim_group);_id_map[mpim_group.id]=mpim_group}if(TS.client){var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(mpim_group);if(TS.model.active_cid==mpim_group.id){TS.mpims.calcUnreadCnts(mpim_group,and_mark)}else{if(!existing_mpim)TS.mpims.calcUnreadCnts(mpim_group,and_mark)}}return mpim_group},processNewMpimForUpserting:function(mpim_group){_processNewMpimForUpserting(mpim_group)},markScrollTop:function(id,scroll_top){var mpim=TS.mpims.getMpimById(id);
if(!mpim)return false;if(mpim.scroll_top==scroll_top){return false}mpim.scroll_top=scroll_top;return true},maybeLoadScrollBackHistory:function(id,force){var mpim=TS.mpims.getMpimById(id);if(!mpim)return false;return TS.shared.maybeLoadScrollBackHistory(mpim,TS.mpims,force)},onHistory:function(ok,data,args){var mpim=TS.mpims.getMpimById(args.channel);if(!mpim){TS.error('wtf no mpim "'+args.channel+'"');return}if(!ok||!data||!data.messages){TS.error("failed to get history");mpim.history_fetch_retries?mpim.history_fetch_retries++:mpim.history_fetch_retries=1;TS.mpims.history_fetched_sig.dispatch(mpim);return}delete mpim.history_fetch_retries;var fetching_more=TS.shared.onHistory(mpim,data,args,TS.mpims);if(!fetching_more){mpim.history_is_being_fetched=false;TS.mpims.history_fetched_sig.dispatch(mpim)}var and_mark=TS.utility.msgs.shouldMarkUnreadsOnMessageFetch(mpim);TS.mpims.calcUnreadCnts(mpim,and_mark);if(TS.view){if(!fetching_more&&mpim.unread_cnt){TS.client.channel_pane.rebuild("ims")}}},fetchHistory:function(mpim,api_args,handler){if(!mpim){TS.error('wtf no mpim "'+mpim+'"');return}TS.shared.maybeClearHasAutoScrolled(mpim);mpim.history_is_being_fetched=true;mpim.history_fetch_failed=false;TS.mpims.history_being_fetched_sig.dispatch(mpim);if(mpim.history_fetch_retries>5){delete mpim.history_fetch_retries;mpim.history_is_being_fetched=false;mpim.history_fetch_failed=true;if(TS.client)TS.client.msg_pane.updateEndMarker();return}TS.api.call("mpim.history",api_args,handler||TS.mpims.onHistory)},setNamesFromMember:function(member){var mpims=member._submodel?member._submodel.getAllMpims():TS.model.mpims;mpims.forEach(function(mpim){if(_.includes(mpim.members,member.id)){_updateMpimName(mpim);_clearDisplayNameCache(mpim)}})},checkMpimMatch:function(mpim,prefix_regexes,suffix_regexes){if(!mpim)return;var match_names_only=true;var every_regex_matched=true;var members=TS.mpims.getMembersInDisplayOrder(mpim);for(var i=0;i<prefix_regexes.length;i++){var regex_matched=false;for(var j=0;j<members.length;j++){if(TS.utility.members.checkMemberMatch(members[j],prefix_regexes[i],match_names_only)||suffix_regexes&&TS.utility.members.checkMemberMatch(members[j],suffix_regexes[i],match_names_only)){regex_matched=true}}if(!regex_matched)every_regex_matched=false}return every_regex_matched},setDataRetention:function(group_id,retention_type,retention_duration,handler){var args={channel:group_id,retention_type:$("select[name=retention_type]").val()};if(args.retention_type==1){args.retention_duration=$("#retention_duration").val()}TS.api.call("mpim.setRetention",args,function(ok,data,args){if(handler){handler(ok,data,args)}if(ok){TS.mpims.data_retention_changed_sig.dispatch(args)}})},getDataRetention:function(group_id,handler){TS.api.call("mpim.getRetention",{channel:group_id},handler)},convertToGroup:function(mpim,group_name){var c_id=mpim.id;return TS.api.call("mpim.convertToGroup",{channel:c_id,name:group_name})}});var _id_map={};var _name_map={};var _makeNameForMpim=function(mpim){var members=TS.mpims.getMembersInDisplayOrder(mpim);if(members.length<2){return mpim._internal_name}return"@"+members.map(function(member){if(!member._is_local)return member.name+"_"+member.team_id;return member.name}).join(",")};var _updateMpimName=function(mpim){if(mpim._name_lc)delete _name_map[mpim._name_lc];if(mpim._submodel){if(mpim._is_updating_name){return}mpim._is_updating_name=true}mpim.name=_makeNameForMpim(mpim);mpim._name_lc=_.toLower(mpim.name);_name_map[mpim._name_lc]=mpim;if(mpim._submodel){delete mpim._is_updating_name}};var _memberRealNameChanged=function(member){TS.model.mpims.forEach(function(mpim){if(mpim.members.indexOf(member.id)!==-1)_clearDisplayNameCache(mpim)})};var _realNamePrefChanged=function(){TS.model.mpims.forEach(_clearDisplayNameCache)};var _clearDisplayNameCache=function(mpim){delete mpim._display_name;delete mpim._display_name_lc};var _getFirstLetter=function(word){var first=word.charCodeAt(0);var second;if(first>=55296&&first<=56319&&word.length>1){second=word.charCodeAt(1);if(second>=56320&&second<=57343){return word.substring(0,2)}}return word.substring(0,1)};var _getDisplayTitle=function(mpim,for_header){var members=TS.mpims.getMembersInDisplayOrder(mpim);var names=members.map(function(member){var name=TS.members.getMemberDisplayName(member);if(for_header){name=TS.utility.htmlEntities($.trim(name));name='<li class="mpdm_member '+TS.templates.makeMemberDomId(member)+" "+TS.templates.makeMemberPresenceStateClass(member)+'" data-member-id="'+member.id+'">'+name+"</li>"}return name});var display_name=for_header?names.join(" "):names.join(", ");if(!for_header)mpim._display_name=display_name;return display_name};var _processNewMpimForUpserting=function(mpim_group){mpim_group._internal_name=mpim_group.name;_name_map[mpim_group._internal_name]=mpim_group;_updateMpimName(mpim_group);mpim_group._hotness=0;TS.shared.setPriorityForDev(mpim_group);mpim_group.is_mpim=true;mpim_group.opened_this_session=false;mpim_group.scroll_top=-1;mpim_group.history_is_being_fetched=false;mpim_group.needs_api_marking=false;mpim_group.unread_highlight_cnt=0;mpim_group.unread_highlights=[];mpim_group.unread_cnt=0;mpim_group.unreads=[];mpim_group.oldest_unread_ts=null;mpim_group.has_fetched_history_after_scrollback=false;if(TS.client){TS.shared.maybeResetHistoryFetched(mpim_group);if(TS._incremental_boot&&mpim_group.msgs&&mpim_group.msgs.length>0){mpim_group.msgs=mpim_group.msgs.map(function(msg){return TS.utility.msgs.processImsg(msg,mpim_group.id)});TS.utility.msgs.setMsgs(mpim_group,mpim_group.msgs)}else{TS.utility.msgs.setMsgs(mpim_group,[])}}else{if(TS.boot_data.msgs){TS.utility.msgs.ingestMessagesFromBootData(mpim_group)}}mpim_group.oldest_msg_ts=TS.storage.fetchOldestTs(mpim_group.id);mpim_group.last_msg_input=TS.storage.fetchLastMsgInput(mpim_group.id)}})();(function(){"use strict";TS.registerModule("shared",{msg_sent_sig:new signals.Signal,model_ob_hotness_changed_sig:new signals.Signal,onStart:function(){TS.shared.updateHotnessByIdThrottled=TS.utility.throttleFunc(TS.shared.updateHotnessByIdThrottled,1e3);TS.ms.connected_sig.addOnce(_logChannelSwitch);TS.channels.switched_sig.add(_logChannelSwitch);TS.ims.switched_sig.add(_logChannelSwitch);TS.groups.switched_sig.add(_logChannelSwitch);TS.mpims.switched_sig.add(_logChannelSwitch)},calcUnreadCnts:function(model_ob,controller,and_mark){if(TS._incremental_boot){return}if(model_ob._did_defer_initial_msg_history){TS.shared.checkInitialMsgHistory(model_ob,controller);return}model_ob.unreads.length=0;model_ob.unread_highlights.length=0;model_ob.oldest_unread_ts=null;var msgs=model_ob.msgs;var was_cnt=model_ob.unread_cnt;var was_highlight_cnt=model_ob.unread_highlight_cnt;var msg;var some_can_cnt_as_unread=false;var this_can_cnt_as_unread=false;var can_have_any_unreads=true;var user_is_away=TS.model.user.presence=="away";if(!model_ob.was_archived_this_session){if(model_ob.is_archived)can_have_any_unreads=false;if(model_ob.is_channel&&!model_ob.is_member)can_have_any_unreads=false}if(model_ob.is_im){var member=TS.members.getMemberById(model_ob.user);if(member&&member.deleted)can_have_any_unreads=false}var model_ob_is_muted=TS.notifs.isCorGMuted(model_ob.id);var channel_mentions_can_count=model_ob.is_im||model_ob.is_mpim||TS.notifs.canCorGHaveChannelMentions(model_ob.id);if(can_have_any_unreads&&msgs){for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.ts<=model_ob.last_read)continue;if(TS.utility.msgs.isTempMsg(msg)&&!msg._alert_even_though_temp)continue;this_can_cnt_as_unread=TS.utility.msgs.msgCanCountAsUnread(msg);some_can_cnt_as_unread=some_can_cnt_as_unread||this_can_cnt_as_unread;if(!this_can_cnt_as_unread)continue;model_ob.unreads.push(msg.ts);if(!model_ob.oldest_unread_ts||msg.ts<model_ob.oldest_unread_ts){model_ob.oldest_unread_ts=msg.ts}if(channel_mentions_can_count){var msg_time_ms=parseFloat(msg.ts)*1e3;var ignore_at_here_mentions=user_is_away||msg_time_ms<TS.model.user._presence_last_changed;if(TS.utility.msgs.msgContainsMention(msg,ignore_at_here_mentions)){model_ob.unread_highlights.push(msg.ts)}}else{if(TS.utility.msgs.getMsgMentionData(msg).non_channel_mentions){model_ob.unread_highlights.push(msg.ts)}}}}if(!some_can_cnt_as_unread&&model_ob.unreads.length){model_ob.unreads.length=0;model_ob.unread_highlights.length=0;model_ob.oldest_unread_ts=null;if(and_mark){controller.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.none_qualify)}}if(TS.pri)TS.log(99,"TS.shared.calcUnreadCnts: #"+model_ob.name+", unreads.length: "+model_ob.unreads.length+" and_mark: "+and_mark);model_ob.unread_cnt=model_ob.unreads.length;if(model_ob_is_muted){if(model_ob.unread_cnt)model_ob._show_in_list_even_though_no_unreads=true}model_ob.unread_highlight_cnt=model_ob.unread_highlights.length;if(TS.boot_data.feature_wait_for_all_mentions_in_client){model_ob.unread_highlight_cnt_in_client=parseInt(model_ob.unread_highlight_cnt,10);if(TS.model.prefs&&TS.model.prefs.mark_msgs_read_immediately&&model_ob._mention_count_display_via_users_counts)model_ob.unread_highlight_cnt=Math.max(model_ob.unread_highlight_cnt_in_client,model_ob._mention_count_display_via_users_counts||0)}TS.shared.maybeMarkReadIfMuted(model_ob,controller);TS.utility.msgs.countAllUnreads();if(was_cnt!=model_ob.unread_cnt){controller.unread_changed_sig.dispatch(model_ob)}if(was_highlight_cnt!=model_ob.unread_highlight_cnt){controller.unread_highlight_changed_sig.dispatch(model_ob)}if(TS.model.prefs.hotness){TS.shared.updateHotnessByIdThrottled(model_ob.id)}if(TS.client){if(!model_ob._users_counts_info||!model_ob._users_counts_info.has_unreads)return;if(!model_ob._history_fetched_since_last_connect||model_ob.history_is_being_fetched)return;if(!model_ob.msgs.length||model_ob.unread_cnt)return;delete model_ob._users_counts_info;if(TS.notifs.isCorGMuted(model_ob.id)){if(TS.pri)TS.log(99,"TS.shared.calcUnreadCnts: #"+model_ob.name+": ignoring possible users.counts has_unreads discrepancy because channel is muted.");return}var current_model_ob=TS.shared.getActiveModelOb();if(current_model_ob&&current_model_ob.id===model_ob.id){if(TS.pri)TS.log(99,"TS.shared.calcUnreadCnts: #"+model_ob.name+": ignoring possible users.counts has_unreads discrepancy due to active channel.");return}var latest=TS.utility.msgs.getMostRecentValidTs(model_ob);var mark_reason=TS.model.marked_reasons.none_qualify;TS.warn('Found users.counts discrepancy: has_unreads = true for "'+model_ob.id+'", but client calculated 0 unreads after fetching history ('+model_ob.msgs.length+' msgs). Marking now with reason="'+mark_reason+'" to correct discrepancy, assuming last_read ('+model_ob.last_read+") < latest ("+latest+").");if(parseFloat(model_ob.last_read)>=parseFloat(latest)){TS.warn('WTF last >= latest for "'+model_ob.id+'"? Bailing, not attempting to mark.');return}controller.markMostRecentReadMsg(model_ob,mark_reason)}},getLatestMsgTs:function(model_ob){if(model_ob.latest&&model_ob.latest.ts)return model_ob.latest.ts;return model_ob.latest||model_ob._latest_via_users_counts},queueConsistencyCheckAfterHistory:function(model_ob){if(!model_ob){TS.warn("queueConsistencyCheck: WTF no model_ob");return}if(model_ob._consistency_is_being_checked||model_ob._consistency_has_been_checked)return;var controller=TS.shared.getControllerForModelOb(model_ob);controller.history_fetched_sig.addOnce(function(history_model_ob){if(!history_model_ob)return;if(history_model_ob._consistency_is_being_checked||history_model_ob._consistency_has_been_checked)return;if(TS.pri)TS.log(58,'"'+model_ob.id+'" "'+model_ob.name+'": fetched history, now checking consistency.');TS.utility.msgs.checkConsistencyViaApi(history_model_ob.id)})},maybeFetchHistoryAndThenCheckConsistency:function(model_ob){var and_consistency=true;TS.shared.maybeFetchHistory(model_ob,and_consistency)},maybeFetchHistory:function(model_ob,also_check_consistency){if(!model_ob){TS.warn("maybeFetchHistory: WTF no model_ob?");return}var function_sig;if(TS.pri)function_sig='maybeFetchHistory: "'+model_ob.id+'" "'+model_ob.name+'": ';if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,function_sig+"history is being fetched already. Queueing consistency check and exiting.");TS.shared.queueConsistencyCheckAfterHistory(model_ob);return}if(model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,function_sig+"history already fetched.");TS.utility.msgs.checkConsistencyViaApi(TS.model.active_cid);return}if(TS.pri){if(also_check_consistency){TS.log(58,function_sig+"checking history first, then consistency.")}else{TS.log(58,function_sig+"checking history.")}}if(also_check_consistency)TS.shared.queueConsistencyCheckAfterHistory(model_ob);var controller=TS.shared.getControllerForModelOb(model_ob);TS.shared.checkInitialMsgHistory(model_ob,controller);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeClearNewMsgsTimer(model_ob)},checkInitialMsgHistory:function(model_ob,controller,defer_api_check){if(model_ob.history_is_being_fetched){TS.warn('checkInitialMsgHistory NOT DOING ANYTHING, because "'+model_ob.name+'" history_is_being_fetched:true');return}delete model_ob._did_defer_initial_msg_history;if(defer_api_check){model_ob._needs_unread_recalc=true}else{TS.utility.msgs.maybeFetchUserDataFromLS(model_ob)}var initial_count=TS.model.initial_msgs_cnt;var latest_ts=TS.shared.getLatestMsgTs(model_ob);var msg=TS.utility.msgs.getMsg(latest_ts,model_ob.msgs);if(msg&&!model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,'We have all recent "'+model_ob.id+'" "'+model_ob.name+'" messages, but have not fetched history since last connect. Will fetch, omitting "latest".');msg=null;latest_ts=null}if(msg){TS.log(58,'we have all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs unread_count:'+model_ob.unread_count+" unread_cnt:"+model_ob.unread_cnt+" initial_count:"+initial_count);TS.shared.maybeDealWithAllSentTempMsgs(model_ob,controller);var status=TS.utility.msgs.getOlderMsgsStatus(model_ob);if(model_ob.msgs.length<TS.model.initial_msgs_cnt&&status.more){if(TS.isPartiallyBooted()){}else{TS.error("calling loadHistory because status.more=true && model_ob.msgs.length < TS.model.initial_msgs_cnt: "+model_ob.msgs.length+" < "+TS.model.initial_msgs_cnt);TS.dir(0,status,model_ob.name);TS.shared.loadHistory(model_ob,controller,initial_count)}return true}if(!TS.boot_data.feature_no_unread_counts){if(model_ob.msgs.length<model_ob.unread_count&&status.more){initial_count=Math.min(TS.model.special_initial_msgs_cnt,model_ob.unread_count-model_ob.msgs.length+1);TS.log(58,"calling loadHistory because model_ob.msgs.length < model_ob.unread_count");TS.warn('setting special initial_count for "'+model_ob.id+'" "'+model_ob.name+'" to:'+initial_count);TS.shared.loadHistory(model_ob,controller,initial_count);return true}}}else if(defer_api_check){model_ob._did_defer_initial_msg_history=true}else{TS.log(58,'WE DO NOT HAVE ALL RECENT MESSAGES for "'+model_ob.id+'" "'+model_ob.name+'" unread_count:'+model_ob.unread_count+" unread_cnt:"+model_ob.unread_cnt+" initial_count:"+initial_count);var no_oldest=false;if(!TS.boot_data.feature_no_unread_counts&&model_ob.unread_count>TS.model.initial_msgs_cnt){initial_count=Math.min(TS.model.special_initial_msgs_cnt,model_ob.unread_count);TS.warn('setting special initial_count for "'+model_ob.id+'" "'+model_ob.name+'" to:'+initial_count)}else if(!model_ob.msgs.length){}var api_args={channel:model_ob.id,count:initial_count,inclusive:typeof model_ob.latest=="string"};if(latest_ts){api_args.latest=latest_ts}if(no_oldest){TS.log(58,'we have some but not all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs but we no_oldest so are not setting oldest for api call')}else if(model_ob.msgs.length&&!TS.utility.msgs.isTempMsg(model_ob.msgs[0])){TS.log(58,'we have some but not all recent "'+model_ob.id+'" "'+model_ob.name+'" msgs');api_args.oldest=model_ob.msgs[0].ts}else{TS.log(58,'we have no "'+model_ob.id+'" msgs')}if(!model_ob._history_fetched_since_last_connect){if(!model_ob.msgs.length){if(TS.pri)TS.log(58,'we have no msgs for "'+model_ob.id+'" "'+model_ob.name+'", and have not fetched history since last connection');if(api_args.latest){if(TS.pri)TS.log(58,"no msgs.length. dropping api_args.latest of "+api_args.latest+' for "'+model_ob.id+'" "'+model_ob.name+'"');delete api_args.latest}if(api_args.oldest){if(TS.pri)TS.log(58,"no msgs.length. dropping api_args.oldest of "+api_args.oldest+' for "'+model_ob.id+'" "'+model_ob.name+'"');delete api_args.oldest}}else if(model_ob.msgs.length===1&&!TS.utility.msgs.isTempMsg(model_ob.msgs[0])){if(TS.pri)TS.log(58,'first new message on "'+model_ob.id+'" "'+model_ob.name+", fetching history without any latest/oldest");delete api_args.latest;delete api_args.oldest}else{if(TS.pri)TS.log(58,"we have some ("+model_ob.msgs.length+') but not all recent msgs for "'+model_ob.id+'" "'+model_ob.name+'", and have not fetched history since last connection');if(api_args.latest){if(TS.pri)TS.log(58,'first history fetch since connect for "'+model_ob.id+'" "'+model_ob.name+'" - deleting api_args.latest of '+api_args.latest);delete api_args.latest}if(api_args.oldest&&api_args.count){if(TS.pri)TS.log(58,"We have api_args.oldest, fetching oldest + "+api_args.count+' messages on "'+model_ob.id+'" "'+model_ob.name+'" to get client up-to-date.')}}}var doIt=function(){if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,'NOT fetching history on "'+model_ob.id+'" "'+model_ob.name+'", history already being fetched')}else{if(TS.pri)TS.log(58,'fetching history for "'+model_ob.id+'" "'+model_ob.name+'" with api_args',api_args);controller.fetchHistory(model_ob,api_args)}};if(TS.model.ms_connected)doIt()}},maybeLoadScrollBackHistory:function(model_ob,controller,force){if(!force&&model_ob.scroll_top!==0)return false;var status=TS.utility.msgs.getOlderMsgsStatus(model_ob);if(!status.more){TS.info("Not loading scrollback in "+model_ob.id+": "+status.text);if(status.code===3){var debug_old_msg_timestamps=_.map(model_ob.msgs,"ts");TS.shared.checkForMoreMsgs(model_ob).then(function(){var message;message="more messages than expected in "+model_ob.id;TS.logError(message,"oldest_msg_ts or is_limited is wrong","Scrollback history error");var debug_new_msg_timestamps=_.map(model_ob.msgs,"ts");var debug_timestamp_differences_old=_.difference(debug_old_msg_timestamps,debug_new_msg_timestamps);var debug_timestamp_differences_new=_.difference(debug_new_msg_timestamps,debug_old_msg_timestamps);if(debug_timestamp_differences_old.length||debug_timestamp_differences_new.length){message="timestamps not present in new data:"+debug_timestamp_differences_old.toString()+"; timestamps not present in old data: "+debug_timestamp_differences_new.toString();TS.logError(message,"Found a difference in timestamps before and after history call","Scrollback history error")}else{TS.log(null,"Did not find a difference between old and new timestamp data after history API call.")}if(TS.shared.getActiveModelOb().id!==model_ob.id||model_ob.history_is_being_fetched)return;if(model_ob.is_limited)model_ob.is_limited=false;if(model_ob.oldest_msg_ts)TS.utility.msgs.resetOldestMsgsTs(model_ob);TS.shared.loadScrollBackHistory(model_ob,controller)},_.noop)}return false}return TS.shared.loadScrollBackHistory(model_ob,controller)},loadScrollBackHistory:function(model_ob,controller){if(!model_ob.msgs.length)return;TS.info(model_ob.id+" HAS MORE");TS.shared.loadHistory(model_ob,controller);model_ob.has_fetched_history_after_scrollback=true;model_ob.fetched_history_after_scrollback_time=Date.now();return true},loadHistory:function(model_ob,controller,count){var api_args={channel:model_ob.id,latest:model_ob.msgs[model_ob.msgs.length-1].ts,count:count||TS.model.subsequent_msgs_cnt};controller.fetchHistory(model_ob,api_args)},checkForMoreMsgs:function(model_ob){return TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),{channel:model_ob.id,latest:model_ob.msgs[model_ob.msgs.length-1].ts,count:1}).then(function(res){if(res.data.messages&&res.data.messages.length>0){return Promise.resolve(res)}else{return Promise.reject(new Error("No more messages"))}})},onSendMsg:function(success,imsg,model_ob,controller){var temp_msg=TS.utility.msgs.getMsgByRspId(imsg.reply_to,model_ob.msgs);if(!success){if(temp_msg){TS.model.unsent_msgs[temp_msg.ts]=true;controller.msg_not_sent_sig.dispatch(model_ob,temp_msg,imsg)}else{TS.error("that makes no sense")}return}TS.view.scroll_down_when_msg_from_user_is_added=true;var new_msg;if(temp_msg){new_msg=_.cloneDeep(temp_msg);new_msg.text=imsg.text;new_msg.ts=imsg.ts;delete new_msg.rsp_id;controller.removeMsg(model_ob.id,temp_msg)}else{TS.warn("no temp msg for "+imsg.reply_to);new_msg={text:imsg.text,user:TS.model.user.id,ts:imsg.ts}}if(TS.boot_data.feature_message_replies&&imsg.SENT_MSG.thread_ts){new_msg.thread_ts=imsg.SENT_MSG.thread_ts}controller.addMsg(imsg.SENT_MSG.channel||model_ob.id,TS.utility.msgs.processImsg(new_msg,model_ob.id));TS.client.ui.maybeHandleSingleEmoji(imsg.text);TS.prefs.recordEmojiUse(imsg.text);var not_present_membersA;var what;var ts=TS.utility.date.makeTsStamp();if(model_ob.is_channel){what="channel";not_present_membersA=TS.channels.getActiveMembersNotInThisChannelForInviting(model_ob.id)}else if(model_ob.is_group&&!model_ob.is_mpim){what="private channel";not_present_membersA=TS.groups.getActiveMembersNotInThisGroupForInviting(model_ob.id)}else{return}if(!not_present_membersA.length)return;var subteam_matches=imsg.text.match(/<!subteam\^(.*?)\|@.+>/g);if(subteam_matches){for(var k=0;k<subteam_matches.length;k++){var cmd=subteam_matches[k].replace(">","").replace("<","");cmd=cmd.split("|")[0];var user_group_id=cmd.split("^")[1];if(!user_group_id)continue;(function(local_user_group_id){TS.user_groups.getUserGroupMembers(local_user_group_id,function(updated_group){var members_not_in_channel=[];var user_group_members=updated_group.users;if(!user_group_members)return;for(var j=0;j<user_group_members.length;j++){var member=TS.members.getMemberById(user_group_members[j]);if(not_present_membersA.indexOf(member)==-1)continue;if(members_not_in_channel.indexOf(member)>-1)continue;members_not_in_channel.push(member)}if(!members_not_in_channel.length)return;var member_idsA=members_not_in_channel.map(function(member){return member.id});var name="<!subteam^"+local_user_group_id+">";var count=members_not_in_channel.length;var prompt="TS.client.ui.promptForGroupOrChannelInvite('"+model_ob.id+"', '"+member_idsA.join(",")+"', '"+ts+"')";var message="TS.client.ui.sendChannelMsgThroughSlackBot('"+model_ob.id+"', '"+imsg.ts+"', '"+member_idsA.join(",")+"', '"+ts+"')";var nothing="TS.utility.msgs.removeEphemeralMsg('"+model_ob.id+"', '"+ts+"')";TS.client.msg_pane.addMaybeClick(prompt,TS.client.ui.promptForGroupOrChannelInvite.bind(Object.create(null),model_ob.id,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(message,TS.client.ui.sendChannelMsgThroughSlackBot.bind(Object.create(null),model_ob.id,imsg.ts,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(nothing,TS.utility.msgs.removeEphemeralMsg.bind(Object.create(null),model_ob.id,ts));var bot_text=[];bot_text.push("You mentioned the "+name+" User Group, but "+(count===1?"one member":count+" members")," of that User Group"+(count===1?" is":" are")+" not in this "+what+".");if(model_ob.id.charAt(0)==="G"){bot_text.push(" If you'd like I can"," <javascript:"+prompt+"|invite them to join>,"," or, <javascript:"+nothing+"|do nothing>.")}else{bot_text.push(" If you'd like I can"," <javascript:"+message+"|send them a link to this message>?"," Or, <javascript:"+nothing+"|do nothing>.")}TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,ts:ts,text:bot_text.join("")});ts=TS.utility.date.makeTsStamp()})})(user_group_id)}}if(TS.boot_data.feature_mention_non_members)return;var mention_matches=imsg.text.match(/<@(.*?)>/g);var bad_mention_membersA=[];var member;var i;if(mention_matches){for(i=0;i<mention_matches.length;i++){member=TS.utility.msgs.getMemberFromMemberMarkup(mention_matches[i].replace(">","").replace("<",""));if(not_present_membersA.indexOf(member)==-1)continue;if(bad_mention_membersA.indexOf(member)>-1)continue;bad_mention_membersA.push(member)}}if(!bad_mention_membersA.length)return;var names_text="";var member_idsA=[];for(i=0;i<bad_mention_membersA.length;i++){if(i!==0){if(i==bad_mention_membersA.length-1){if(bad_mention_membersA.length>2)names_text+=",";names_text+=" and "}else{names_text+=", "}}names_text+="<@"+bad_mention_membersA[i].id+">";member_idsA.push(bad_mention_membersA[i].id)}var prompt="TS.client.ui.promptForGroupOrChannelInvite('"+model_ob.id+"', '"+member_idsA.join(",")+"', '"+ts+"')";var message="TS.client.ui.sendChannelMsgThroughSlackBot('"+model_ob.id+"', '"+imsg.ts+"', '"+member_idsA.join(",")+"', '"+ts+"')";var nothing="TS.utility.msgs.removeEphemeralMsg('"+model_ob.id+"', '"+ts+"')";TS.client.msg_pane.addMaybeClick(prompt,TS.client.ui.promptForGroupOrChannelInvite.bind(Object.create(null),model_ob.id,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(message,TS.client.ui.sendChannelMsgThroughSlackBot.bind(Object.create(null),model_ob.id,imsg.ts,member_idsA.join(","),ts));TS.client.msg_pane.addMaybeClick(nothing,TS.utility.msgs.removeEphemeralMsg.bind(Object.create(null),model_ob.id,ts));TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,ts:ts,text:"You mentioned "+names_text+", but they're not in this "+what+". Would you like to "+"<javascript:"+prompt+"|invite them to join>"+(model_ob.is_group?"?":" or have slackbot <javascript:"+message+"|send them a link to your message>?")+" Or, <javascript:"+nothing+"|do nothing>."})},sendMsg:function(c_id,text,controller,in_reply_to_msg,should_broadcast_reply){if(!text)return false;var model_ob=TS.shared.getModelObById(c_id);var d=model_ob&&model_ob.msgs&&model_ob.msgs[0]&&TS.utility.date.toDateObject(model_ob.msgs[0].ts+1)||Date.now();var temp_ts=TS.utility.date.makeTsStamp(d);text=TS.format.cleanMsg(text);if(text.indexOf("DELEEEEETETEEESTTTT")===0)TS.ms.disconnect();var params={type:"message",channel:c_id,text:$.trim(text)};if(TS.boot_data.feature_message_replies&&in_reply_to_msg){params.thread_ts=in_reply_to_msg.thread_ts||in_reply_to_msg.ts;params.reply_broadcast=should_broadcast_reply}var rsp_id;if(TS.boot_data.feature_message_replies&&should_broadcast_reply){TS.api.callImmediately("chat.postMessage",params)}else{rsp_id=TS.ms.send(params,controller.onSendMsg,temp_ts)}TS.typing.userEnded(model_ob);var placeholder_msg={type:"message",text:text,user:TS.model.user.id,ts:temp_ts,rsp_id:rsp_id};TS.ui.handy_rxns.decorateMsg(placeholder_msg,placeholder_msg.text);if(params.thread_ts){placeholder_msg.thread_ts=params.thread_ts}var add_placeholder=true;if(in_reply_to_msg&&TS.boot_data.feature_message_replies)add_placeholder=false;if(add_placeholder)controller.addMsg(c_id,placeholder_msg);TS.shared.msg_sent_sig.dispatch(model_ob,rsp_id);return true},sendMsgGroup:function(model_ob_id,text,controller,in_reply_to_msg,should_broadcast_reply){var model_ob=TS.shared.getModelObById(model_ob_id);var model_label=model_ob.is_mpim?"conversation":"channel";if(!model_ob)return false;if(model_ob.is_archived)return false;var general=TS.channels.getGeneralChannel();var errorOut=function(err_txt){TS.generic_dialog.alert(err_txt).then(function(){if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}});if(TS.boot_data.feature_message_replies&&in_reply_to_msg){TS.ui.replies.populateReplyInput(text)}else{TS.utility.contenteditable.value(TS.client.ui.$msg_input,text)}};var clean_text=TS.format.cleanMsg(text);var err_txt;if(TS.model.everyone_regex.test(clean_text)){if(!TS.members.canUserAtEveryone()){err_txt="<p>A Team Owner has restricted the use of <b>@everyone</b> messages.</p>";if(TS.model.user.is_restricted){err_txt="<p>Your account is restricted, and you cannot send <b>@everyone</b> messages.</p>"}if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@"+model_label+"</b> instead.</p>"}errorOut(err_txt);return false}if(!general||!general.is_member){err_txt="<p>You cannot send <b>@everyone</b> messages.</p>";if(TS.members.canUserAtChannelOrAtGroup()){err_txt+='<p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@"+model_label+"</b> instead.</p>"}errorOut(err_txt)}else{TS.generic_dialog.start({title:"Send @everyone a message",body:'<p class="bold">Would you like to switch to #'+TS.utility.htmlEntities(general.name)+' and send your message?</p><p class="">Using <b>@everyone</b> in a message is a way to address your whole team, but it must be done in the #'+TS.utility.htmlEntities(general.name)+' channel.</p><p class="no_bottom_margin">If you just want to address everyone in this '+model_label+", use <b>@channel</b> instead.</p>",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.channels.displayChannel(general.id,text)},onCancel:function(){TS.utility.contenteditable.value(TS.client.ui.$msg_input,text);TS.view.focusMessageInput()}})}return false}var is_at_here=TS.model.here_regex.test(clean_text);var is_at_group=TS.model.channel_regex.test(clean_text)||TS.model.group_regex.test(clean_text)||is_at_here;if(is_at_group&&!TS.members.canUserAtChannelOrAtGroup()){var key_word=is_at_here?"@here":"@channel";err_txt="<p>A Team Owner has restricted the use of <b>"+key_word+"</b> messages.</p>";errorOut(err_txt);return false}if(TS.ui.needToShowAtChannelWarning(model_ob_id,text)){TS.ui.at_channel_warning_dialog.startInMessagePane(model_ob_id,text,controller);return false}return TS.shared.sendMsg(model_ob_id,text,controller,in_reply_to_msg,should_broadcast_reply)},onHistory:function(model_ob,data,args,controller){var msgs=model_ob.msgs;var imsg;if(data.is_limited){if(TS.pri)TS.log(58,'data.is_limited case: setting has_more = false, is_limited = true for "'+model_ob.id+'" "'+model_ob.name+'"',model_ob,data,args);data.has_more=false;model_ob.is_limited=true}var needs_unread_recalc;if(!model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,'first history fetch for "'+model_ob.id+'" "'+model_ob.name+'"',model_ob,data,args);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeResetUnreadsCheck(model_ob);if(args.oldest){if(!data.has_more){if(TS.pri)TS.log(58,'first history fetch. has_more is false for "'+model_ob.id+'" "'+model_ob.name+'" - we should have all recent msgs. Setting _history_fetched_since_last_connect.',args,data,model_ob);model_ob._history_fetched_since_last_connect=true;if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,'Resetting history_is_being_fetched for "'+model_ob.id+'" "'+model_ob.name+'"');model_ob.history_is_being_fetched=false}needs_unread_recalc=true;if(TS.client&&TS.client.msg_pane){TS.client.msg_pane.maybeStartNewMsgsTimer(model_ob)}}else{model_ob.msgs=[];var api_args={channel:model_ob.id,count:TS.model.initial_msgs_cnt,inclusive:true};if(TS.pri)TS.log(58,'first history fetch. has_more is TRUE for "'+model_ob.id+'" "'+model_ob.name+'" - dumping history and fetching most recent '+TS.model.initial_msgs_cnt+" msgs. prior history call data follows.",args,data,model_ob);return controller.fetchHistory(model_ob,api_args)}}else{if(TS.pri)TS.log(58,'first history fetch. no "oldest" param for "'+model_ob.id+'" "'+model_ob.name+'", marking _history_fetched_since_last_connect = true.',args,data,model_ob);model_ob._history_fetched_since_last_connect=true;if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,'Resetting history_is_being_fetched for "'+model_ob.id+'" "'+model_ob.name+'"');model_ob.history_is_being_fetched=false}needs_unread_recalc=true;if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeStartNewMsgsTimer(model_ob)}}if(args.oldest){if(data.has_more){TS.info(model_ob.name+" has more than one page of msg history between what is in cache and the latest, so let's dump what we have and just use this page of results");
TS.info(model_ob.name+" args.oldest:"+args.oldest);msgs.length=0;if(model_ob.is_limited)model_ob.is_limited=false}}var new_msgs=[];var new_msgs_tses=[];if(data.messages){for(var i=0;i<data.messages.length;i++){if(!TS.utility.msgs.getMsg(data.messages[i].ts,msgs)){imsg=data.messages[i];new_msgs.push(TS.utility.msgs.processImsgFromHistory(imsg,model_ob.id));new_msgs_tses.push(imsg.ts)}}if(TS.pri)TS.log(58,'got history for "'+model_ob.id+'" "'+model_ob.name+'", added '+new_msgs.length+" new messages out of "+data.messages.length+" total.")}if(TS.boot_data.feature_updated_history_fetch_and_merge&&model_ob._msgs_to_merge_on_history&&model_ob._msgs_to_merge_on_history.length){var did_add_merged_messages;_.each(model_ob._msgs_to_merge_on_history,function(item,offset){if(new_msgs_tses.indexOf(item.ts)===-1&&!TS.utility.msgs.getMsg(item.ts,msgs)&&!TS.utility.msgs.isTempMsg(item)){if(TS.boot_data.feature_tinyspeck)TS.warn('got history for "'+model_ob.id+'" "'+model_ob.name+'", merging in msg with ts='+item.ts+" because it was not included in the history response.",args);new_msgs.push(TS.utility.msgs.processImsgFromHistory(item,model_ob.id));did_add_merged_messages=true}else{if(TS.pri)TS.log(58,"NOT merging message for #"+model_ob.name+" because it already exists, or is temporary.",item)}});model_ob._msgs_to_merge_on_history=null}if(new_msgs.length&&!TS.utility.msgs.getDisplayedMsgs(new_msgs).length){TS.warn("no displayed msgs in this page for "+model_ob.id+' "'+model_ob.name+'"! We expect TS.client.ui.afterHistoryFetch to detect this and load another page')}msgs=new_msgs.concat(msgs);if(did_add_merged_messages)TS.utility.msgs.sortMsgs(msgs);msgs=TS.utility.msgs.setMsgs(model_ob,msgs);TS.log(4,model_ob.id+" msgs has more history now");if(model_ob.latest&&model_ob.latest.ts&&!TS.utility.msgs.getMsg(model_ob.latest.ts,msgs)){TS.log(4,"tacking on latest msg "+model_ob.latest.ts);imsg=model_ob.latest;TS.utility.msgs.appendMsg(msgs,TS.utility.msgs.processImsgFromHistory(imsg,model_ob.id));TS.utility.msgs.sortMsgs(msgs)}if(!args.oldest){if(!data.has_more&&!data.is_limited){TS.utility.msgs.setOldestMsgsTs(model_ob)}}TS.shared.maybeDealWithAllSentTempMsgs(model_ob,controller);if(needs_unread_recalc){if(TS.pri)TS.log(58,"onHistory: post-message merge, doing recalc of unread counts for #"+model_ob.name);var and_mark=false;controller.calcUnreadCnts(model_ob,and_mark)}},maybeDealWithAllSentTempMsgs:function(model_ob,controller){if(!TS.ms)return;for(var k in TS.ms.sent_map){var sent_data=TS.ms.sent_map[k];if(sent_data.msg.channel!=model_ob.id)continue;var temp_ts=sent_data.temp_ts;var temp_msg=TS.utility.msgs.getMsg(temp_ts,model_ob.msgs);if(!temp_msg)continue;var existing_msg=TS.utility.msgs.getNonTempMsgFromUserMatchingText(sent_data.msg.text,TS.model.user.id,model_ob.msgs);if(existing_msg){var existing_time=TS.utility.date.toDateObject(existing_msg.ts);var temp_time=TS.utility.date.toDateObject(temp_ts);if(existing_time<temp_time){TS.info("existing_msg time is older than temp_msg time, so it cant be the message we were looking for");existing_msg=null}}if(!existing_msg){TS.warn("not removing, we dont appear to have this non-temp message:"+sent_data.msg.text);TS.model.unsent_msgs[temp_msg.ts]=true;controller.msg_not_sent_sig.dispatch(model_ob,temp_msg);continue}TS.info("removing temp_msg:"+temp_msg.ts+" "+temp_msg.text+" existing_msg:"+existing_msg.ts+" "+existing_msg.text);delete TS.ms.sent_map[k];if(!controller)controller=TS.shared.getControllerForModelOb(model_ob);if(_.isFunction(controller.removeMsg))controller.removeMsg(model_ob.id,temp_msg)}},getControllerForModelOb:function(model_ob){if(!model_ob)return{};if(model_ob.is_im){return TS.ims}else if(model_ob.is_mpim){return TS.mpims}else if(model_ob.is_group){return TS.groups}else{return TS.channels}},getActiveModelOb:function(){var model_ob;if(TS.client){if(TS.model.active_channel_id){model_ob=TS.channels.getChannelById(TS.model.active_channel_id)}else if(TS.model.active_im_id){model_ob=TS.ims.getImById(TS.model.active_im_id)}else if(TS.model.active_mpim_id){model_ob=TS.mpims.getMpimById(TS.model.active_mpim_id)}else if(TS.model.active_group_id){model_ob=TS.groups.getGroupById(TS.model.active_group_id)}}else{if(TS.boot_data.channel_id){model_ob=TS.channels.getChannelById(TS.boot_data.channel_id)}else if(TS.boot_data.im_id){model_ob=TS.ims.getImById(TS.boot_data.im_id)}else if(TS.boot_data.mpim_id){model_ob=TS.mpims.getMpimById(TS.boot_data.mpim_id)}else if(TS.boot_data.group_id){model_ob=TS.groups.getGroupById(TS.boot_data.group_id)}else{TS.warn("WTF getActiveModelOb found no ob");TS.warn("TS.boot_data.channel_id: "+TS.boot_data.channel_id);TS.warn("TS.boot_data.im_id: "+TS.boot_data.im_id);TS.warn("TS.boot_data.group_id: "+TS.boot_data.group_id)}}return model_ob},getDisplayNameForModelOb:function(model_ob){if(model_ob.is_mpim){return TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_im){var escaped=false;var include_at_sign=true;return TS.members.getMemberDisplayNameById(model_ob.user,escaped,include_at_sign)}else if(model_ob.is_group||model_ob.is_private){return model_ob.name}else if(model_ob.is_channel){return"#"+model_ob.name}else{TS.warn("getDisplayNameForModelOb: unknown model_ob type: "+model_ob.id);return model_ob.id}},getDisplayNameForModelObNoSigns:function(model_ob){if(model_ob.is_mpim){return TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_im){var escaped=false;var include_at_sign=false;return TS.members.getMemberDisplayNameById(model_ob.user,escaped,include_at_sign)}else if(model_ob.is_group||model_ob.is_channel){return model_ob.name}else{TS.warn("getDisplayNameForModelOb: unknown model_ob type: "+model_ob.id);return model_ob.id}},getModelObById:function(id){if(!id)return null;var ob_type=id[0];if(ob_type==="C"){return TS.channels.getChannelById(id)}else if(ob_type==="G"){return TS.mpims.getMpimById(id)||TS.groups.getGroupById(id)}else if(ob_type==="S"){return TS.user_groups.getUserGroupsById(id)}else if(ob_type==="E"){return TS.emoji.getEmojiById(id)}else if(ob_type==="B"){return TS.bots.getBotById(id)}else if(ob_type==="U"||ob_type=="W"){return TS.members.getMemberById(id)}else{return TS.ims.getImById(id)}},getAllModelObsForUser:function(){return TS.channels.getChannelsForUser().concat(TS.model.groups,TS.model.ims,TS.model.mpims)},getShareModelObId:function(model_ob_id,callback){var im;var channel;var maybeCancelArchivesView=function(id){if(TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==id){TS.client.archives.cancel()}};if(model_ob_id&&TS.utility.strLooksLikeAMemberId(model_ob_id)){im=TS.ims.getImByMemberId(model_ob_id);if(!im){TS.api.call("im.open",{user:model_ob_id,return_im:true,reason:"TS.shared.getShareModelObId"},function(ok,data,args){if(ok){TS.ims.onOpened(ok,data,args);im=TS.ims.getImByMemberId(model_ob_id);if(im){callback(im.id)}else if(TS.web){callback(data.channel.id)}else{TS.error("getShareModelObId opened an IM, but it is not in the model? data.channel.id: "+data.channel.id)}}else{TS.error("getShareModelObId try to open an IM, but failed data: "+JSON.stringify(data||null))}})}else{model_ob_id=im.id;maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}}else if(model_ob_id&&model_ob_id.charAt(0)==="C"){channel=TS.channels.getChannelById(model_ob_id);if(!channel.is_member&&!channel.is_archived){TS.channels.join(channel.name,function(ok,data,args){if(ok){callback(model_ob_id)}else{callback(model_ob_id)}})}else{maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}}else{maybeCancelArchivesView(model_ob_id);callback(model_ob_id)}},getModelObIdForSendingMsg:function(id,callback){var im;var channel;if(id&&TS.utility.strLooksLikeAMemberId(id)){im=TS.ims.getImByMemberId(id);if(!im){TS.api.call("im.open",{user:id,return_im:true,reason:"TS.shared.getModelObIdForSendingMsg"},function(ok,data,args){if(ok){TS.ims.onOpened(ok,data,args);im=TS.ims.getImByMemberId(id);if(im){callback(im.id)}else if(TS.web){callback(data.channel.id)}else{TS.error("getModelObIdForSendingMsg opened an IM, but it is not in the model? data.channel.id: "+data.channel.id)}}else{TS.error("getModelObIdForSendingMsg try to open an IM, but failed data: "+JSON.stringify(data||null))}})}else{id=im.id;callback(id)}}else if(id&&id.charAt(0)==="C"){channel=TS.channels.getChannelById(id);if(!channel.is_member&&!channel.is_archived){TS.channels.join(channel.name,function(ok,data,args){if(ok){callback(id)}else{callback(id)}})}else{callback(id)}}else{callback(id)}},maybeMarkReadIfMuted:function(model_ob,controller){if(!model_ob)return;if(!TS.notifs.isCorGMuted(model_ob.id))return;if(!model_ob.unreads.length||model_ob.unread_highlights.length)return;if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){if(TS.model.active_cid==model_ob.id)return}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"&&!model_ob.is_starred){if(TS.model.active_cid==model_ob.id)return}if(model_ob.is_mpim){TS.mpims.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else if(model_ob.is_group){TS.groups.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}else{TS.channels.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.muted)}},markReadMsg:function(model_ob_id,ts,reason){var model_ob=TS.shared.getModelObById(model_ob_id);var controller=TS.shared.getControllerForModelOb(model_ob);if(_.isFunction(controller.markReadMsg))controller.markReadMsg(model_ob.id,ts,reason)},moveLastMsgInput:function(from_channel,to_channel){if(!from_channel.last_msg_input)return;to_channel.last_msg_input=from_channel.last_msg_input;from_channel.last_msg_input="";TS.storage.storeLastMsgInput(from_channel.id,from_channel.last_msg_input);TS.storage.storeLastMsgInput(to_channel.id,to_channel.last_msg_input)},closeArchivedChannel:function(id){var model_ob=TS.shared.getModelObById(id);if(!model_ob)return;if(!model_ob.is_archived)return;model_ob.was_archived_this_session=false;TS.client.activeChannelDisplayGoneAway()},getLastMsg:function(model_ob){if(!model_ob.msgs||model_ob.msgs.length===0)return null;for(var i=0;i<model_ob.msgs.length;i++){if(!TS.utility.msgs.isMsgHidden(model_ob.msgs[i])&&!model_ob.msgs[i].is_ephemeral)return model_ob.msgs[i]}return null},sorterByLastMsg:function(a,b){var a_msg=a&&TS.shared.getLastMsg(a);var b_msg=b&&TS.shared.getLastMsg(b);var a_ts;var b_ts;if(a_msg){a_ts=parseFloat(a_msg.ts)}else if(a){a_ts=TS.shared.getLatestMsgTs(a);if(a_ts)a_ts=parseFloat(a_ts)}if(b_msg){b_ts=parseFloat(b_msg.ts)}else if(b){b_ts=TS.shared.getLatestMsgTs(b);if(b_ts)b_ts=parseFloat(b_ts)}if(a_ts&&b_ts){if(a_ts>b_ts)return-1;if(b_ts>a_ts)return 1}else{if(a_ts)return-1;if(b_ts)return 1}return 0},hasUnreads:function(model_ob){if(!model_ob)return false;if(!TS.boot_data.feature_no_unread_counts){return!!model_ob.unread_count}var latest_ts=TS.shared.getLatestMsgTs(model_ob);if(!latest_ts)return false;return latest_ts>model_ob.last_read},checkForOldImsToClose:function(){var ims=TS.model.ims;var mpims=TS.model.mpims;var model_obs=ims.concat(mpims);var model_ob;var activity_ts;var activity_date;var ms_since_activity;var i;var dms_listed_cnt=0;var allow_in_list=11;var allow_elapsed_ms=1e3*60*60*168;for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(!model_ob.is_open&&!model_ob.unread_cnt)continue;dms_listed_cnt++}var this_too_many=dms_listed_cnt-allow_in_list;if(this_too_many<1)return;TS.info("checkForOldImsToClose might close some. this_too_many:"+this_too_many);var leaveA=[];for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(model_ob.is_slackbot_im)continue;if(model_ob.is_self_im)continue;if(!model_ob.is_open)continue;if(model_ob.unread_cnt)continue;if(model_ob.is_starred)continue;if(model_ob.opened_this_session)continue;if(model_ob==TS.shared.getActiveModelOb())continue;activity_ts=TS.shared.getLatestMsgTs(model_ob)||"";if(model_ob.msgs&&model_ob.msgs.length&&model_ob.msgs[0]&&model_ob.msgs[0].ts>activity_ts){activity_ts=model_ob.msgs[0].ts}if(activity_ts){activity_date=TS.utility.date.toDateObject(activity_ts)}else{activity_date=new Date(model_ob.created*1e3)}ms_since_activity=new Date-activity_date;if(ms_since_activity>allow_elapsed_ms){TS.info(model_ob.name+" "+activity_date+" ms_since_activity:"+ms_since_activity+" allow_elapsed_ms:"+allow_elapsed_ms);leaveA.push({model_ob:model_ob,ms_since_activity:ms_since_activity})}}if(!leaveA.length){TS.info("checkForOldImsToClose found no candidates for closing")}leaveA.sort(function compare(a,b){var a_srt=a.ms_since_activity;var b_srt=b.ms_since_activity;if(a_srt<b_srt)return 1;if(a_srt>b_srt)return-1;return 0});leaveA.length=leaveA.length>this_too_many?this_too_many:leaveA.length;for(i=0;i<leaveA.length;i++){model_ob=leaveA[i].model_ob;TS.warn("checkForOldImsToClose CLOSING:"+model_ob.name+" ms_since_activity:"+leaveA[i].ms_since_activity);if(model_ob.is_im){TS.ims.closeIm(model_ob.id)}else if(model_ob.is_mpim){TS.mpims.closeMpim(model_ob.id)}}},ensureModelObIsPresent:function(c_id){return new Promise(function(resolve,reject){if(!c_id)return resolve();if(typeof c_id!=="string")return resolve();_getModelObByIdFromModelOrApi(c_id).then(resolve,reject)})},getModelObIdsNotPresent:function(c_ids){return c_ids.filter(function(c_id){return!TS.shared.getModelObById(c_id)})},promiseToHaveAllRelevantImIds:function(){_ensure_im_ids_p=_ensure_im_ids_p||new Promise(function(resolve,reject){TS.api.callImmediately("im.list").then(function(resp){if(resp.data&&resp.data.ims&&resp.data.ims.length){resp.data.ims.forEach(function(im){TS.utility.ensureInArray(TS.model.all_im_ids,im.id)});TS.log(528,"TS.model.all_im_ids: "+TS.model.all_im_ids)}resolve()},function(err){reject(err)})});return _ensure_im_ids_p},promiseToHaveAllRelevantGroupIds:function(){_ensure_group_ids_p=_ensure_group_ids_p||new Promise(function(resolve,reject){TS.api.callImmediately("groups.list",{no_sort:true}).then(function(resp){if(resp.data&&resp.data.groups&&resp.data.groups.length){resp.data.groups.forEach(function(group){TS.utility.ensureInArray(TS.model.all_group_ids,group.id)});TS.log(528,"TS.model.all_group_ids: "+TS.model.all_group_ids)}resolve()},function(err){reject(err)})});return _ensure_group_ids_p},ensureModelObsArePresent:function(c_ids){if(!c_ids||!c_ids.length){return Promise.resolve()}var promises=c_ids.map(function(c_id,i){return TS.shared.ensureModelObIsPresent(c_id).reflect()});return Promise.all(promises).then(function(results){var rejection_reasons=[];results.forEach(function(result){if(result.isFulfilled())return;rejection_reasons.push(result.reason())});if(rejection_reasons.length){return Promise.reject(new Error("some ensureModelObsArePresent c_ids failed:\n"+rejection_reasons.join("\n")))}else{return Promise.resolve()}})},ensureModelObsInDataArePresent:function(data,source){var c_ids=TS.utility.extractAllModelObIds(data,source);return TS.shared.ensureModelObsArePresent(c_ids)},fetchInitialModelObData:function(c_id){return new Promise(function(resolve,reject){var method="channels.view";if(TS.boot_data.feature_web_lean_all_users){if(c_id.charAt(0)==="C"){method="channels.info"}else if(c_id.charAt(0)==="G"){method="groups.info"}else{method="im.info"}}return TS.api.callImmediately(method,{channel:c_id}).then(function(resp){var model_ob_data=resp.data.channel||resp.data.im||resp.data.mpim||resp.data.group;var model_ob;if(model_ob_data.is_channel){model_ob=TS.channels.upsertChannel(model_ob_data)}else if(model_ob_data.is_im){model_ob=TS.ims.upsertIm(model_ob_data)}else if(model_ob_data.is_mpim){model_ob=TS.mpims.upsertMpim(model_ob_data)}else if(model_ob_data.is_group){model_ob=TS.groups.upsertGroup(model_ob_data)}if(resp.data.history)model_ob._prefetched_history=resp.data.history;if(resp.data.users){resp.data.users.forEach(function(m){TS.members.upsertMember(m)})}if(resp.data.self)TS.members.upsertMember(resp.data.self);resolve()},function(){reject(Error("fetchChannelView api call failed: "+method+" channel:"+c_id))})})},updateHotnessForAll:function(){return _updateHotness()},updateHotnessByIdThrottled:function(c_id){return _updateHotness(c_id)},getHistoryApiMethodForModelOb:function(model_ob){if(model_ob.is_mpim)return"mpim.history";if(model_ob.is_group&&(!model_ob.is_private&&!_.startsWith(model_ob.id,"C")))return"groups.history";if(model_ob.is_im)return"im.history";return"channels.history"},addMsg:function(model_ob,msg){return _addMsgsWorker(model_ob,[msg])},addMsgs:function(model_ob,msgs){if(_addMsgsWorker(model_ob,msgs)){var and_mark=false;var controller=TS.shared.getControllerForModelOb(model_ob);if(_.isFunction(controller.calcUnreadCnts))controller.calcUnreadCnts(model_ob,and_mark);TS.utility.msgs.maybeTruncateMsgs(model_ob);if(TS.client){if(TS.model.active_cid!==model_ob.id){if(TS.pri)TS.log(58,'Got message(s) for "'+model_ob.id+'" "'+model_ob.name+'", but not active_cid "'+TS.model.active_cid+'" (yet.) NOT rebuilding.')}else{if(TS.pri)TS.log(58,"Got messages on active channel, rebuilding.");TS.client.msg_pane.rebuildMsgsWithReason("addMsgs: got messages on active channel #"+model_ob.name)}}return true}return false},kickMember:function(model_ob,member_id){var is_kickable_model_ob=model_ob.is_channel||model_ob.is_group&&!model_ob.is_mpim;if(!is_kickable_model_ob)return;if(model_ob.is_group){if(!TS.members.canUserKickFromGroups())return}else{if(!TS.members.canUserKickFromChannels())return}var member=TS.members.getMemberById(member_id);if(!member)return;var escaped=true;var include_at_sign=true;var member_display_name=TS.boot_data.feature_name_tagging_client?TS.members.getMemberFullName(member):TS.members.getMemberDisplayName(member,escaped,include_at_sign);var model_ob_display_name=TS.shared.getDisplayNameForModelOb(model_ob);if(model_ob.members.indexOf(member.id)==-1){TS.generic_dialog.alert("<b>"+member_display_name+"</b> is not a member of "+model_ob_display_name+".");return}var confirm_msg;if(model_ob.is_group){confirm_msg="<p>If you remove <b>"+member_display_name+"</b> from "+model_ob_display_name+", they will no longer be able to see any of its messages. To rejoin the private channel, they will have to be re-invited.</p><p>Are you sure you wish to do this?</p>"}else{confirm_msg="<p>Are you sure you wish to remove <b>"+member_display_name+"</b> from "+model_ob_display_name+"?</p>"}var api_endpoint=model_ob.is_group?"groups.kick":"channels.kick";TS.generic_dialog.start({title:"Remove "+member_display_name,body:confirm_msg,go_button_text:"Yes, remove them",onGo:function(){TS.api.call(api_endpoint,{channel:model_ob.id,user:member_id}).catch(function(resp){TS.info("Removing user failed; api="+api_endpoint+"; error="+resp.data.error);setTimeout(function(){var account_type=member.is_ultra_restricted?"Single-channel guests":TS.templates.builders.raLabel("Restricted accounts");if(resp.data.error=="cant_kick_from_last_channel"&&TS.model.user.is_admin){TS.generic_dialog.start({title:"Removing "+member_display_name+" failed",body:"<p>"+account_type+" (like <b>"+member_display_name+"</b>) cant be removed from channels.</p><p>If <b>"+member_display_name+"</b> should no longer have access to your Slack team, we suggest deactivating their account.",go_button_text:"Manage Team Members",show_cancel_button:true,onGo:function(){TS.utility.openInNewTab("/admin#restricted",TS.templates.builders.newWindowName())}});return}var err_str;switch(resp.data.error){case"cant_kick_from_last_channel":err_str="<p>"+account_type+" (like <b>"+member_display_name+"</b>) cant be removed from channels.</p><p>Please contact a Team Admin if <b>"+member_display_name+"</b> should no longer have access to your Slack team.</p>";break;case"restricted_action":err_str="<p>Hmm, looks like you dont have permission to kick from channels.</p><p>Please contact a Team Admin if <b>"+member_display_name+"</b> should no longer have access to your Slack team.</p>";break;default:err_str="<p>Somethings gone wrong, and we couldnt remove <b>"+member_display_name+"</b> from "+model_ob_display_name+". We suspect this is only temporary. Try again in a bit?</p>"}TS.generic_dialog.alert(err_str,"Removing "+member_display_name+" failed")},500)})}})},maybeResetHistoryFetchedOnAll:function(){if(!TS.client)return;if(TS.pri)TS.log(58,"maybeResetHistoryFetchedOnAll()");function reset(item){TS.shared.maybeResetHistoryFetched(item)}_.forEach(TS.model.channels,reset);_.forEach(TS.model.ims,reset);_.forEach(TS.model.mpims,reset);_.forEach(TS.model.groups,reset)},maybeResetHistoryFetched:function(model_ob){if(!TS.client)return;if(!model_ob){TS.warn("maybeResetHistoryFetched: WTF no model_ob",model_ob);return}if(!model_ob._history_fetched_since_last_connect)return;if(TS.pri&&model_ob._history_fetched_since_last_connect)TS.log(58,'resetting history_fetched_since_last_connect for "'+model_ob.id+'" "'+model_ob.name+'"');model_ob._history_fetched_since_last_connect=false},maybeClearHasAutoScrolled:function(){var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&active_model_ob._has_auto_scrolled){if(TS.pri)TS.log(58,'resetting _has_auto_scrolled for "'+active_model_ob.id+'" "'+active_model_ob.name+'"');active_model_ob._has_auto_scrolled=false}},setPriorityForDev:function(model_ob){if(!TS.boot_data.feature_sli_channel_priority)return;if(TS.boot_data.version_ts!="dev")return;if(model_ob.priority||model_ob.priority===0)return;model_ob.priority=TS.utility.strToApparentlyRndPerc(model_ob.id)},isSharedModelOb:function(model_ob){if(!model_ob||!TS.model||!TS.model.team)return false;return!!(TS.boot_data.page_needs_enterprise&&TS.model&&TS.model.team&&TS.model.team.enterprise_id&&(model_ob.is_shared||model_ob.is_org_shared))},isRelevantTeam:function(){var is_relevant=true;if(!TS.boot_data.page_needs_enterprise||!TS.model.team||!TS.model.team.enterprise_id||!TS.boot_data.other_accounts)return is_relevant;if(!window.winssb)return is_relevant;if(TS.pri)TS.log(ncc,"isRelevantTeam()");var enterprise_teams=TS.model.enterprise_teams;if(enterprise_teams.length===1)return is_relevant;var team_ids=_.map(enterprise_teams,function(item){return item.id});var relevant_team_ids=TSSSB.call("getLastActiveTeamIdForTeamIds",team_ids);var most_relevant_team_id;var ncc=1701;if(TS.pri)TS.log(ncc,"isRelevantTeam(): Got relevant team IDs from SSB",relevant_team_ids);if(relevant_team_ids instanceof Array&&relevant_team_ids.length){most_relevant_team_id=relevant_team_ids[0];if(TS.pri)TS.log(ncc,"isRelevantTeam(): Array case - taking the first relevant team id",most_relevant_team_id,relevant_team_ids)}else{if(TS.pri)TS.log(ncc,"isRelevantTeam(): relevant_team_ids is not an array, OR, is empty?",relevant_team_ids);TS.log(ncc,"isRelevantTeam(): Electron did not provide any matches for the given team_ids",team_ids)}if(!most_relevant_team_id){if(TS.pri)TS.log(ncc,"Invalid response from SSB lastActiveTeamIdForTeamIds() call? Exiting.");return is_relevant}if(TS.pri)TS.log(ncc,"comparing most_relevant_team_id ( "+most_relevant_team_id+") -> TS.model.team_id ("+TS.model.team.id+")");if(most_relevant_team_id===TS.model.team.id){if(TS.pri)TS.log(ncc,"isRelevantTeam(): "+TS.model.team.id+" is relevant. Including.")}else{if(TS.pri)TS.log(ncc,"isRelevantTeam(): "+TS.model.team.id+" is NOT relevant. Excluding.");is_relevant=false}return is_relevant},isRelevantTeamForSharedModelOb:function(model_ob){var is_relevant=true;if(!model_ob)return is_relevant;if(!window.winssb)return is_relevant;if(!TS.boot_data.page_needs_enterprise||!TS.model.team||!TS.model.team.enterprise_id||!TS.boot_data.other_accounts)return is_relevant;if(!model_ob.is_org_shared&&!model_ob.is_shared)return is_relevant;var enterprise_team_ids;var ncc=1701;if(TS.pri)TS.log(ncc,"isRelevantTeamForSharedModelOb(): #"+model_ob.name);if(model_ob.shares){enterprise_team_ids=_.map(model_ob.shares,function(item){return item.id});if(enterprise_team_ids.indexOf(TS.model.team.id)===-1){console.warn('WTF, TS.model.team.id of "'+TS.model.team.id+'" is not in enterprise_team_ids from model_ob.shares on #'+model_ob.name+"?",model_ob.shares)}}else{if(TS.pri)TS.log(ncc,"no model_ob.shares on # "+model_ob.name+", model ob is "+(!model_ob.is_org_shared?"NOT ":"")+"org_shared");enterprise_team_ids=_.map(TS.model.enterprise_teams,function(item){return item.id})}if(!enterprise_team_ids){if(TS.pri)TS.log(ncc,"Could not find shared team IDs for #"+model_ob.name+"? Exiting.");return is_relevant}var relevant_team_ids=TSSSB.call("getLastActiveTeamIdForTeamIds",enterprise_team_ids);var most_relevant_team_id;if(TS.pri)TS.log(ncc,"Got relevant team IDs from SSB",relevant_team_ids);if(relevant_team_ids instanceof Array&&relevant_team_ids.length){most_relevant_team_id=relevant_team_ids[0];if(TS.pri)TS.log(ncc,"Array case - taking the first relevant team id",most_relevant_team_id,relevant_team_ids)}else{if(TS.pri)TS.log(ncc,"WTF relevant_team_ids is not an array, OR, is empty?",relevant_team_ids);if(TS.pri)TS.log(ncc,"relevant_team_ids is not an array, OR, is empty?",relevant_team_ids);if(enterprise_team_ids&&enterprise_team_ids.length){if(TS.pri)TS.log(ncc,"we have enterprise_team_ids, looking there and taking the first item.",enterprise_team_ids);most_relevant_team_id=enterprise_team_ids[0]}else{if(TS.pri)TS.log(ncc,"WTF no enterprise_team_ids, either?")}}if(!most_relevant_team_id){if(TS.pri)TS.log(ncc,"Invalid response from SSB lastActiveTeamIdForTeamIds() call on #"+model_ob.name+"? Exiting.");return is_relevant}if(TS.pri)TS.log(ncc,"comparing most_relevant_team_id ( "+most_relevant_team_id+") -> TS.model.team_id ("+TS.model.team.id+")");if(most_relevant_team_id===TS.model.team.id){if(TS.pri)TS.log(ncc,"Shared channel #"+model_ob.name+" is relevant for this team ("+TS.model.team.id+"). Including.")}else{if(TS.pri)TS.log(ncc,"Shared channel #"+model_ob.name+" is NOT relevant for this team ("+TS.model.team.id+"). Excluding.");is_relevant=false}return is_relevant},checkDisplayEmailAddressPref:function(){if(!TS.boot_data.feature_hide_email_pref||!TS.client||!TS.model.team||!TS.model.team.prefs)return;var email_count=0;var bots_count=0;var potential_emails=0;var min_email_threshold=.5;if(TS.model.members){_.each(TS.model.members,function(member){if(member.is_bot)bots_count++;if(!member||!member.profile||!member.profile.email)return;if(member.id===TS.model.user.id)return;email_count++})}potential_emails=TS.model.members.length-bots_count;if(!TS.model.team.prefs.display_email_addresses){if(email_count){TS.info("Email display hidden for this team, but found "+email_count+" email fields in TS.model.members.");TS.shared.onDisplayEmailAddressesPrefChanged()}else{TS.info("Email display hidden for this team. Client model OK. ")}}else{if(!email_count){TS.info("Email display allowed for this team, but no email fields found in TS.model.members.");TS.shared.onDisplayEmailAddressesPrefChanged()}else if(email_count/potential_emails<min_email_threshold){TS.warn("Email display allowed for this team, but < "+min_email_threshold*100+"% of non-bot members ("+email_count+"/"+potential_emails+") in model have email fields. Dumping LS cache to correct inconsistency.");TS.shared.onDisplayEmailAddressesPrefChanged()}}},onDisplayEmailAddressesPrefChanged:function(){if(!TS.boot_data.feature_hide_email_pref||!TS.model||!TS.model.team||!TS.model.team.prefs)return;TS.info('Team pref "display_email_addresses" -> '+TS.model.team.prefs.display_email_addresses);var email_count=0;if(TS.model.members){TS.model.members=_.map(TS.model.members,function(member){if(!member.profile||!member.profile.email)return member;if(member.id===TS.model.user.id)return member;email_count++;if(!TS.model.team.prefs.display_email_addresses)member.profile.email=undefined;return member})}if(!TS.model.team.prefs.display_email_addresses){if(email_count){TS.info("display_email_addresses check: found and cleared "+email_count+" email fields from TS.model.members.")}else{TS.info("display_email_addresses check: TS.model.members is already clear of email fields. ")}}else{if(!email_count){TS.info("display_email_addresses check: pref enabled, but 0 email fields found in TS.model.members.")}}if(TS.storage){TS.info("display_email_addresses check: clearing members from LS, disabling member/bot cache for remainder of session.");TS.storage.clearBufferAndCache();var members=[];TS.storage.storeMembers(members);TS.storage.disableMemberBotCache()}if(TS.client&&TS.client.ui&!TS.model.ms_logged_in_once)TS.client.ui.rebuildAll()}});var _ensure_im_ids_p;var _ensure_group_ids_p;var _addMsgsWorker=function(model_ob,msgs){var added_any=false;if(!model_ob._history_fetched_since_last_connect){var log_prefix;if(TS.pri)log_prefix='Defer case: First new message on "'+model_ob.id+'" "'+model_ob.name+'" - ';if(!msgs||!msgs.length)TS.warn("_addMsgsWorker(#"+model_ob.id+"): WTF no msgs to add?");if(model_ob.history_is_being_fetched||!model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,log_prefix+"queueing msgs to merge on history fetch for #"+model_ob.name,msgs);model_ob._msgs_to_merge_on_history=(model_ob._msgs_to_merge_on_history||[]).concat(msgs)}if(model_ob.msgs.length){if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,log_prefix+"some history, history fetch is already underway - queueing "+msgs.length+" message(s) to be merged with history call, as they are unlikely to be in the history response.",msgs)}else if(!model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,log_prefix+"some history, have not fetched history since last reconnect - attaching new messages to model for merging when the history call returns.",msgs);TS.shared.maybeFetchHistoryAndThenCheckConsistency(model_ob)}}else{if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,log_prefix+"no history in model, but history is already pending - queueing "+msgs.length+" message(s) for merging with history call",msgs)}else if(!model_ob._history_fetched_since_last_connect){if(TS.pri)TS.log(58,log_prefix+"no history in model, no history call yet - fetching, and queueing "+msgs.length+" message(s) for merging with history call",msgs);TS.shared.maybeFetchHistoryAndThenCheckConsistency(model_ob)}else{if(TS.pri)TS.log(58,log_prefix+"Edge case - new message(s) to add, but no history and we have called history, too?",msgs)}}}msgs=_.filter(msgs,function(msg){var exists=msg.ts&&TS.utility.msgs.getMsg(msg.ts,model_ob.msgs);if(exists)TS.log(58,"Not adding duplicate message "+msg.ts+", already in "+model_ob.id+" #"+model_ob.name);return!exists});if(!msgs.length){if(TS.pri)TS.log(58,"No messages to add to "+model_ob.id+" #"+model_ob.name+" - exiting.");return false}if(TS.pri)TS.log(58,"Adding "+(msgs.length>1?"messages":"message")+" to "+model_ob.id+" #"+model_ob.name,msgs);msgs.forEach(function(msg){if(TS.utility.msgs.validateMsg(model_ob.id,msg,model_ob.msgs)){added_any=true;TS.utility.msgs.appendMsg(model_ob.msgs,msg)}});if(!added_any)return false;TS.utility.msgs.sortMsgs(model_ob.msgs);TS.utility.msgs.maybeSetOldestMsgsTsAfterMsgAdded(model_ob);return true};var _getModelObByIdFromModelOrApi=function(c_id){if(typeof c_id!=="string"){return Promise.reject(Error('c_id: "'+c_id+'" is not a String'))}TS.log(529,'_getModelObByIdFromModelOrApi c_id: "'+c_id+'"');var model_ob=TS.shared.getModelObById(c_id);if(model_ob){return Promise.resolve(model_ob)}if(c_id.charAt(0)==="C"){return _getModelObByIdFromApi(c_id)}else if(c_id.charAt(0)==="G"){return TS.shared.promiseToHaveAllRelevantGroupIds().then(function(){if(TS.model.all_group_ids.indexOf(c_id)==-1){TS.maybeWarn(528,"c_id:"+c_id+" is not in TS.model.all_group_ids, not calling the API");return Promise.resolve()}else{return _getModelObByIdFromApi(c_id)}}).catch(function(err){if(err&&err.method=="groups.list"){return _getModelObByIdFromApi(c_id)}else{return Promise.reject(err)}})}else{return TS.shared.promiseToHaveAllRelevantImIds().then(function(){if(TS.model.all_im_ids.indexOf(c_id)==-1){TS.maybeWarn(528,"c_id:"+c_id+" is not in TS.model.all_im_ids, not calling the API");return Promise.resolve()}else{return _getModelObByIdFromApi(c_id)}}).catch(function(err){if(err&&err.method=="im.list"){return _getModelObByIdFromApi(c_id)}else{return Promise.reject(err);
}})}};var _getModelObByIdFromApi=function(c_id){TS.log(529,'_getModelObByIdFromApi c_id: "'+c_id+'"');return new Promise(function(resolve,reject){var tries=TS.model.incrementUnknownIdHandled(c_id);if(c_id.charAt(0)==="C"){TS.api.callImmediately("channels.info",{channel:c_id}).then(function(resp){resolve(TS.channels.upsertChannel(resp.data.channel));TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){if(TS.boot_data.page_needs_enterprise&&ret.data&&ret.data.error&&ret.data.error==="channel_not_found"){TS.maybeWarn(98765,"_getModelObByIdFromApi called for a channel but it is not found for enterprise. Channel:",c_id);resolve();TS.model.reportResultOfUnknownIdHandled(c_id,true);return}reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling channels.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}else if(c_id.charAt(0)==="G"){TS.api.callImmediately("groups.info",{channel:c_id}).then(function(resp){if(resp.data.group.is_mpim){resolve(TS.mpims.upsertMpim(resp.data.group))}else{resolve(TS.groups.upsertGroup(resp.data.group))}TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling groups.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}else{TS.api.callImmediately("im.info",{channel:c_id}).then(function(resp){resolve(TS.ims.upsertIm(resp.data.im));TS.model.reportResultOfUnknownIdHandled(c_id,true)},function(ret){reject(Error((ret.data&&ret.data.error||"unknown error")+" try #"+tries+" calling im.info with channel:"+c_id));TS.model.reportResultOfUnknownIdHandled(c_id,false)})}})};var _isModelObRelevantToHotness=function(model_ob){if(model_ob.is_archived)return false;if(!model_ob.msgs)return false;if(!model_ob.msgs.length)return false;return true};var _isMsgRelevantToHotness=function(msg){if(msg.is_ephemeral)return false;if(TS.utility.msgs.isTempMsg(msg))return false;return true};var _setHotness=function(model_ob,hotness){if(model_ob._hotness==hotness)return;model_ob._hotness=hotness;TS.shared.model_ob_hotness_changed_sig.dispatch(model_ob)};var _updateHotness=function(c_id){if(!TS.model.prefs.hotness)return;var hotness_secs=60*2;var model_obs=TS.shared.getAllModelObsForUser();var model_ob=TS.shared.getModelObById(c_id);if(model_ob&&!_isModelObRelevantToHotness(model_ob))return;var mark_label="start_updated_hotness_all";TS.metrics.mark(mark_label);(model_ob&&[model_ob]||model_obs).forEach(function(model_ob){var hotness=0;var msg;if(_isModelObRelevantToHotness(model_ob)){for(var i=0;i<model_ob.msgs.length;i++){msg=model_ob.msgs[i];if(parseInt(TS.utility.date.makeTsStamp())-parseInt(msg.ts)>hotness_secs)break;if(_isMsgRelevantToHotness(msg))hotness+=1}}_setHotness(model_ob,hotness)});if(TS.shouldLog(752)){model_obs.sort(function compare(a,b){if(a._hotness<b._hotness)return 1;if(a._hotness>b._hotness)return-1;var a_srt=TS.shared.getDisplayNameForModelObNoSigns(a);var b_srt=TS.shared.getDisplayNameForModelObNoSigns(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0});model_obs.slice(0,10).forEach(function(model_ob,i){if(!_isModelObRelevantToHotness(model_ob))return;TS.info(i+" "+model_ob._hotness+" "+TS.templates.makeHotnessIconDomClasses(model_ob)+" "+TS.shared.getDisplayNameForModelOb(model_ob))})}if(!c_id)TS.metrics.measureAndClear("updated_hotness_all",mark_label)};var _logChannelSwitch=function(){var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&active_model_ob.id){var id=active_model_ob.id;TS.clog.track("CHANNEL_SWITCHED",{channel_id:id,channel_type:id.charAt(0)})}}})();(function(){"use strict";TS.registerModule("members",{status_changed_sig:new signals.Signal,presence_changed_sig:new signals.Signal,ds_presence_changed_sig:new signals.Signal,user_color_changed_sig:new signals.Signal,joined_team_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_real_name_sig:new signals.Signal,changed_deleted_sig:new signals.Signal,changed_profile_sig:new signals.Signal,changed_tz_sig:new signals.Signal,changed_account_type_sig:new signals.Signal,changed_admin_perms_sig:new signals.Signal,changed_self_sig:new signals.Signal,lazily_added_sig:new signals.Signal,batch_upserted_sig:new signals.Signal,is_in_bulk_upsert_mode:false,members_for_user_changed_sig:new signals.Signal,onStart:function(){_storeMembersThrottled=TS.utility.throttleFunc(_storeMembersThrottled,20)},getMemberById:function(id){if(!_.isString(id))return null;if(id&&id.charAt(0)=="@")id=id.substring(1);if(TS.model.submodel)return TS.model.submodel.getMemberById(id);var members=TS.model.members;var member=_id_map[id];if(member){return member}if(!members){TS.warn("Trying to look up member by id ("+id+") but TS.model.members is not present.")}if(TS.members.is_in_bulk_upsert_mode){return null}for(var i=0;i<members.length;i++){member=members[i];if(member.id==id||member.enterprise_user&&member.enterprise_user.id==id){TS.warn(id+" not in _id_map");_id_map[id]=member;return member}}return null},getMemberByName:function(name){name=_.toLower(name);if(TS.model.submodel)return TS.model.submodel.getMemberByName(name);var members=TS.model.members;var member=_name_map[name];if(member){return member}for(var i=0;i<members.length;i++){member=members[i];if(member._name_lc==name||"@"+member._name_lc==name){TS.error(name+" not in _name_map?");_name_map[member._name_lc]=member;_name_map["@"+member._name_lc]=member;return member}}return null},getMemberByEmail:function(email){email=_.toLower(email);if(TS.model.submodel)return TS.model.submodel.getMemberByEmail(email);var members=TS.model.members;var member;for(var i=0;i<members.length;i++){member=members[i];if(!member.profile)continue;if(!member.profile.email)continue;if(_.toLower(member.profile.email)==email)return member}return null},upsertAndSignal:function(member){if(TS.viewmodel&&TS.viewmodel.teamdirectory){TS.viewmodel.teamdirectory.upsertModelOb(_.cloneDeep(member))}var upsert=TS.members.upsertMember(member);if(upsert.status=="ADDED"&&TS.lazyLoadMembersAndBots()){TS.members.lazily_added_sig.dispatch(upsert.member)}else if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("profile")!=-1){TS.members.changed_profile_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("is_restricted")!=-1||upsert.what_changed.indexOf("is_ultra_restricted")!=-1){TS.members.changed_account_type_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("real_name")!=-1){TS.members.changed_real_name_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("name")!=-1){TS.members.changed_name_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("tz")!=-1){TS.members.changed_tz_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("deleted")!=-1){TS.members.changed_deleted_sig.dispatch(upsert.member);var im=TS.ims.getImByMemberId(upsert.member.id);if(im)TS.ims.calcUnreadCnts(im,true);TS.channels.calcActiveMembersForAllChannels();TS.groups.calcActiveMembersForAllGroups()}if(upsert.what_changed.indexOf("presence")!=-1){TS.members.presence_changed_sig.dispatch(upsert.member)}if(upsert.what_changed.indexOf("is_admin")!=-1){TS.members.changed_admin_perms_sig.dispatch(upsert.member)}if(member.is_self){TS.members.changed_self_sig.dispatch(upsert.member);TS.model.makeYouRegex()}}return upsert},upsertMember:function(member,log){var members=TS.model.members;var existing_member=TS.members.getMemberById(member.id);var status="NOOP";var what_changed=[];if(member.is_ultra_restricted){member.is_restricted=true}if(existing_member){if(TS.pri)TS.log(4,'updating existing member "'+member.id+'"');var upsert_status=_processExistingMemberForUpserting(existing_member,member);status=upsert_status.status;what_changed=upsert_status.what_changed;member=existing_member}else if(member.id){status="ADDED";_processNewMemberForUpserting(member);if(TS.pri)TS.log(4,'adding member "'+member.id+'" color:'+member.color+" member_color:"+member.member_color);_id_map[member.id]=member;_name_map[member._name_lc]=member;_name_map["@"+member._name_lc]=member;members.push(member)}else{TS.error("bad error, no member.id")}if(member.is_self&&member.deleted){TS.info("calling TS.reload() because member.is_self && member.deleted");TS.reload(null,"TS.reload() because member.is_self && member.deleted");return}if(!TS.members.is_in_bulk_upsert_mode){TS.utility.rAF(_logIncompleteMembers);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.members.invalidateActiveMembersArrayCaches()}member._has_files_or_we_dont_know=TS.boot_data.feature_no_has_files||member.has_files;if(status=="ADDED"||status=="CHANGED")TS.members.maybeStoreMembers();return{status:status,member:member,what_changed:what_changed}},processExistingMemberForUpserting:function(existing_member,member){return _processExistingMemberForUpserting(existing_member,member)},processNewMemberForUpserting:function(member){_processNewMemberForUpserting(member)},setMemberUserColor:function(member,color){color=TS.utility.htmlEntities(color);member.member_color=color||member.color;if(color&&color!=member.color){TS.model.user_colors[member.id]=color}else{delete TS.model.user_colors[member.id]}TS.members.user_color_changed_sig.dispatch(member)},setUserStatus:function(txt){TS.api.call("status.set",{status:txt},TS.members.onUserStatusSet)},onUserStatusSet:function(ok,data){if(!ok){return}},toggleUserPresence:function(){var new_presence=TS.model.user.presence=="away"?"active":"away";var args={presence:new_presence};return TS.api.call("presence.set",args)},usernameChanged:function(member){delete _name_map[member._name_lc];delete _name_map["@"+member._name_lc];member._name_lc=_.toLower(member.name);_name_map[member._name_lc]=member;_name_map["@"+member._name_lc]=member;_setImAndMpimNames(member)},getMyChannelsThatThisMemberIsNotIn:function(id){var A=[];var member=TS.members.getMemberById(id);if(!member)return A;var channel;var channels=TS.model.channels;channel_loop:for(var i=0;i<channels.length;i++){channel=channels[i];if(!channel.is_member)continue;for(var m=0;m<channel.members.length;m++){if(channel.members[m]==id)continue channel_loop}A.push(channel)}return A},getActiveMembersWithSelfAndNotSlackbot:function(){var A=_active_members_with_self_and_not_slackbot;if(!A.length){var include_self=true;var include_slackbot=false;A=_active_members_with_self_and_not_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),include_self,include_slackbot)}return A},getActiveMembersExceptSelfAndSlackbot:function(){var A=_active_members_except_self_and_slackbot;if(!A.length){var include_self=false;var include_slackbot=false;A=_active_members_except_self_and_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),include_self,include_slackbot)}return A},getActiveMembersExceptSelfAndBots:function(){var A=_active_members_except_self_and_bots;if(!A.length){var include_self=false;var include_slackbot=false;var exclude_bots=true;A=_active_members_except_self_and_bots=_getActiveMembersWorker(A,TS.members.getMembersForUser(),include_self,include_slackbot,exclude_bots)}return A},getActiveMembersWithSelfAndSlackbot:function(){var A=_active_members_with_self_and_slackbot;if(!A.length){var include_self=true;var include_slackbot=true;A=_active_members_with_self_and_slackbot=_getActiveMembersWorker(A,TS.members.getMembersForUser(),include_self,include_slackbot)}return A},getActiveMembersWithSlackbotAndNotSelf:function(){var A=_active_members_with_slackbot_and_not_self;if(!A.length){var include_self=false;var include_slackbot=true;A=_active_members_with_slackbot_and_not_self=_getActiveMembersWorker(A,TS.members.getMembersForUser(),include_self,include_slackbot)}return A},getMembersForUser:function(){if(TS.model.submodel)return TS.model.submodel.getMembersForUser();if(!TS.model.user.is_restricted)return TS.model.members;if(_members_for_user.length)return _members_for_user;var user_id_map={};TS.shared.getAllModelObsForUser().forEach(function(model_ob){if(model_ob.is_group&&!model_ob.is_archived){model_ob.members.forEach(function(user_id){user_id_map[user_id]=true})}else if(model_ob.is_channel&&model_ob.is_member){model_ob.members.forEach(function(user_id){user_id_map[user_id]=true})}else if(model_ob.is_im){user_id_map[model_ob.user]=true}});var is_partially_booted=TS.isPartiallyBooted();_members_for_user=Object.keys(user_id_map).map(TS.members.getMemberById).filter(function(user){if(!user&&is_partially_booted){return false}if(!user){if(TS.boot_data.feature_tinyspeck)TS.warn("getMembersForUser: Could not find a user - returning false.");return false}return!user.deleted});return _members_for_user},canUserSeeMember:function(member){if(!TS.model.user.is_restricted){return true}else if(member.is_self){return true}else if(member.is_slackbot){return true}return TS.members.getMembersForUser().indexOf(member)>=0},shouldDisplayRealNames:function(){var override=TS.model.prefs.display_real_names_override;return TS.model.team.prefs.display_real_names&&override!=-1||override==1},shouldDisplayPreferredNames:function(){if(!TS.boot_data.feature_name_tagging_preferred_name_pref)return true;return TS.model.prefs.display_preferred_names},getMemberDisplayNameById:function(id,should_escape,include_at_sign){var member=TS.members.getMemberById(id);return member?TS.members.getMemberDisplayName(member,should_escape,include_at_sign):id},getMemberDisplayName:function(member,should_escape,include_at_sign){if(!member)return"NO MEMBER??";var unescaped_display_name=function(){if(TS.boot_data.feature_name_tagging_client){var display_name=TS.members.getMemberFullName(member);if(TS.members.shouldDisplayPreferredNames()){display_name=TS.members.getMemberPreferredName(member)||display_name}return display_name}else{if(!TS.model.team)return member.name;var username_prefix=include_at_sign?"@":"";if(TS.members.shouldDisplayRealNames()){if(member.profile&&member.profile.real_name&&member.profile.real_name.length){return member.profile.real_name}else{return username_prefix+member.name}}return username_prefix+member.name}}();return should_escape?TS.utility.htmlEntities(unescaped_display_name):unescaped_display_name},getMemberDisplayNameLowerCase:function(member,should_escape){if(!member)return"NO MEMBER??";if(!TS.model.team)return member._name_lc;if(TS.members.shouldDisplayRealNames()){if(member.profile&&member.profile.real_name){if(should_escape)return TS.utility.htmlEntities(member._real_name_lc);return member._real_name_lc}}return member._name_lc},getMemberRealName:function(member_or_id){return _getMemberNameHelper(member_or_id,"real_name")},getMemberFullName:function(member_or_id){return _getMemberNameHelper(member_or_id,"full_name")},getMemberFullNameLowerCase:function(member_or_id){return _getMemberNameHelper(member_or_id,"_full_name_normalized_lc")},getMemberPreferredName:function(member_or_id){return _getMemberNameHelper(member_or_id,"preferred_name")},getMemberPreferredNameLowerCase:function(member_or_id){return _getMemberNameHelper(member_or_id,"_preferred_name_normalized_lc")},getMemberCurrentStatus:function(member_or_id){if(!TS.boot_data.feature_user_custom_status)return"";var member=_.isString(member_or_id)?TS.members.getMemberById(member_or_id):member_or_id;return member&&member.profile&&member.profile.current_status?member.profile.current_status:""},invalidateMembersUserCanSeeArrayCaches:function(no_signal){if(!TS.model.user||!TS.model.user.is_restricted)return;var was_length=_members_for_user.length;if(!was_length)return;_members_for_user.length=0;TS.members.invalidateActiveMembersArrayCaches();if(no_signal)return;var A=TS.members.getMembersForUser();if(A.length!==was_length){TS.members.members_for_user_changed_sig.dispatch()}},invalidateActiveMembersArrayCaches:function(){_active_members_with_self_and_not_slackbot.length=0;_active_members_except_self_and_slackbot.length=0;_active_members_except_self_and_bots.length=0;_active_members_with_self_and_slackbot.length=0;_active_members_with_slackbot_and_not_self.length=0;_active_local_members_with_slackbot_and_not_self.length=0;_active_local_members_with_self_and_slackbot.length=0},canMemberPostInModelOb:function(member,model_ob){if(model_ob.is_general){return TS.members.canMemberPostInGeneral(member)}else if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared){return TS.members.canMemberPostInChannel(model_ob)}return true},canMemberPostInGeneral:function(user){if(!user){return false}if(user.is_restricted){return TS.model.team.prefs.who_can_post_general=="ra"}if(TS.model.team.prefs.who_can_post_general=="ra")return true;if(TS.model.team.prefs.who_can_post_general=="regular")return true;if(TS.model.team.prefs.who_can_post_general=="admin")return!!user.is_admin;if(TS.model.team.prefs.who_can_post_general=="owner")return!!user.is_owner;return true},canMemberPostInChannel:function(model_ob){if(!TS.boot_data.feature_shared_channels_settings)return true;return!TS.channels.read_only.isReadOnly(model_ob.id)},canUserAtEveryone:function(){if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_at_everyone=="ra"}if(TS.model.team.prefs.who_can_at_everyone=="ra")return true;if(TS.model.team.prefs.who_can_at_everyone=="regular")return true;if(TS.model.team.prefs.who_can_at_everyone=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_at_everyone=="owner")return!!TS.model.user.is_owner;return true},canUserAtChannelOrAtGroup:function(){if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_at_channel=="ra"}if(TS.model.team.prefs.who_can_at_channel=="ra")return true;if(TS.model.team.prefs.who_can_at_channel=="regular")return true;if(TS.model.team.prefs.who_can_at_channel=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_at_channel=="owner")return!!TS.model.user.is_owner;return true},canUserCreateChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_create_channels=="regular")return true;if(TS.model.team.prefs.who_can_create_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_channels=="owner")return!!TS.model.user.is_owner;return true},canUserCreateSharedChannels:function(){var is_enabled=TS.boot_data.page_needs_enterprise&&(TS.model.enterprise&&TS.model.enterprise.id)||TS.boot_data.feature_external_shared_channels_ui;if(!is_enabled)return false;if(TS.model.user.is_restricted)return false;if(TS.boot_data.feature_shared_channels_settings){if(TS.model.team.prefs.who_can_create_shared_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_shared_channels=="owner")return!!TS.model.user.is_owner}else{if(TS.model.user.enterprise_user&&TS.model.user.enterprise_user.is_owner)return true}return false},canUserCreateConvertSharedChannels:function(){if(!TS.boot_data.page_needs_enterprise)return false;if(TS.model.user.enterprise_user&&TS.model.user.enterprise_user.is_owner)return true;if(TS.boot_data.feature_shared_channels_settings)return TS.members.canUserManageSharedChannels();return false},canUserManageSharedChannels:function(){if(!TS.boot_data.feature_shared_channels_settings)return true;if(!TS.model.team.prefs.who_can_manage_shared_channels)return true;if(!TS.boot_data.page_needs_enterprise)return false;var user=TS.model.user;if(user.is_restricted)return false;if(TS.model.team.prefs.can_user_manage_shared_channels!==undefined)return TS.model.team.prefs.can_user_manage_shared_channels;var type=TS.model.team.prefs.who_can_manage_shared_channels.type[0];if(type==="regular")return true;if(type==="admin")return user.is_admin||user.is_owner||user.enterprise_user&&(user.enterprise_user.is_admin||user.enterprise_user.is_owner);if(type==="owner"){if(user.enterprise_user&&(user.enterprise_user.is_admin||user.enterprise_user.is_owner))return true;if(TS.model.team.prefs.who_can_manage_shared_channels.user&&TS.model.team.prefs.who_can_manage_shared_channels.user.indexOf(TS.model.user.id)>-1)return true;return false}return false},canUserArchiveChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_archive_channels=="regular")return true;if(TS.model.team.prefs.who_can_archive_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_archive_channels=="owner")return!!TS.model.user.is_owner;return true},canUserCreateGroups:function(){if(TS.model.user.is_ultra_restricted)return false;if(TS.model.user.is_restricted){return TS.model.team.prefs.who_can_create_groups=="ra"}if(TS.model.team.prefs.who_can_create_groups=="ra")return true;if(TS.model.team.prefs.who_can_create_groups=="regular")return true;if(TS.model.team.prefs.who_can_create_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_groups=="owner")return!!TS.model.user.is_owner;return true},canUserCreateMpims:function(){if(TS.model.user.is_ultra_restricted)return false;if(TS.boot_data.feature_mpim_restrictions&&TS.model.team.prefs.who_can_create_mpdm==="off")return false;return true},canUserCreateAndDeleteUserGroups:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_create_delete_user_groups=="regular")return true;if(TS.model.team.prefs.who_can_create_delete_user_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_create_delete_user_groups=="owner")return!!TS.model.user.is_owner;return true},canUserEditUserGroups:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_edit_user_groups=="regular")return true;if(TS.model.team.prefs.who_can_edit_user_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_edit_user_groups=="owner")return!!TS.model.user.is_owner;return true},canUserPostInGeneral:function(){return TS.members.canMemberPostInGeneral(TS.model.user)},canUserKickFromChannels:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_kick_channels=="regular")return true;if(TS.model.team.prefs.who_can_kick_channels=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_kick_channels=="owner")return!!TS.model.user.is_owner;return true},canUserKickFromGroups:function(){if(TS.model.user.is_restricted)return false;if(TS.model.team.prefs.who_can_kick_groups=="regular")return true;if(TS.model.team.prefs.who_can_kick_groups=="admin")return!!TS.model.user.is_admin;if(TS.model.team.prefs.who_can_kick_groups=="owner")return!!TS.model.user.is_owner;return true},memberSorterByActive:function(a,b){if(a.presence!=b.presence){if(a.presence=="active")return-1;if(b.presence=="active")return 1}if(TS.boot_data.feature_name_tagging_client){var a_srt=TS.members.getMemberFullNameLowerCase(a);var b_srt=TS.members.getMemberFullNameLowerCase(b)}else{var a_srt=TS.members.getMemberDisplayNameLowerCase(a);var b_srt=TS.members.getMemberDisplayNameLowerCase(b)}if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},memberSorterByActiveWithBotsLast:function(a,b){if(a.presence!=b.presence){if(a.presence=="active")return-1;if(b.presence=="active")return 1}var a_bot=a.is_bot||a.is_slackbot;var b_bot=b.is_bot||b.is_slackbot;if(a_bot!==b_bot){if(!a_bot)return-1;if(!b_bot)return 1}if(TS.boot_data.feature_name_tagging_client){var a_srt=TS.members.getMemberFullNameLowerCase(a);var b_srt=TS.members.getMemberFullNameLowerCase(b)}else{var a_srt=TS.members.getMemberDisplayNameLowerCase(a);var b_srt=TS.members.getMemberDisplayNameLowerCase(b)}if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},memberSorterByName:function(a,b){var a_srt=TS.members.getMemberNameForSort(a);var b_srt=TS.members.getMemberNameForSort(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0},getMemberNameForSort:function(member){if(TS.boot_data.feature_name_tagging_client){return TS.members.getMemberFullNameLowerCase(member)}else{return TS.members.getMemberDisplayNameLowerCase(member)}},prepareMembersForLS:function(){var new_members=[];var new_member;var member;var k;var i;for(i=0;i<TS.model.members.length;i++){member=TS.model.members[i];if(!member){TS.warn("prepareMembersForLS: no member at offset "+i+"??");continue}if(!member._is_local)continue;new_member={};new_members.push(new_member);for(k in member){if(k=="files")continue;if(k=="activity")continue;if(k=="stars")continue;if(k=="mentions")continue;if(k.indexOf("_")===0)continue;new_member[k]=member[k]}if(TS.boot_data.feature_canonical_avatars_web_client){new_member.profile=_omitImagesFromProfile(new_member.profile)}}return new_members},maybeStoreMembers:function(force){if(!TS.storage.isUsingMemberBotCache())return;if(TS.members.is_in_bulk_upsert_mode)return;_storeMembersThrottled(force||false)},clearMemberMaps:function(){_id_map={};_name_map={}},ensureMembersInDataArePresent:function(data,source,channel_id){var ret=TS.utility.extractAllMemberIds(data,source,channel_id);return TS.members.ensureMembersArePresent(ret.m_ids,ret.c_ids,ret.t_ids)},ensureMemberIsPresent:function(m_id,c_id,t_id){if(!m_id)return Promise.resolve();if(typeof m_id!=="string")return Promise.resolve();return _getMemberByIdFromModelOrApi(m_id,c_id,t_id)},getMemberIdsNotPresent:function(m_ids,c_ids,t_ids){var new_m_ids=[];var new_c_ids=[];var new_t_ids=[];m_ids.forEach(function(m_id,i){if(!TS.members.getMemberById(m_id)){new_m_ids.push(m_id);new_c_ids.push(c_ids[i]);new_t_ids.push(t_ids[i])}});return{m_ids:new_m_ids,c_ids:new_c_ids,t_ids:new_t_ids}},ensureMembersArePresentBatch:function(m_ids){if(!m_ids)return Promise.resolve();if(!Array.isArray(m_ids))return Promise.reject(Error("m_ids is not an array"));return _getMembersByIdFromModelOrApi(m_ids)},ensureMembersArePresent:function(m_ids,c_ids,t_ids){if(!m_ids||!m_ids.length){return Promise.resolve()}c_ids=c_ids||new Array(m_ids.length);t_ids=t_ids||new Array(m_ids.length);var known_unique_m_ids=_(m_ids).uniq().filter(TS.members.getMemberById).value();var unknown_unique_m_ids=_.difference(m_ids,known_unique_m_ids);var batch_size=TS.lazyLoadMembersAndBots()?_flannel_max_users:_users_info_api_max_users;var promises=_(unknown_unique_m_ids).chunk(batch_size).map(function(batch){return TS.members.ensureMembersArePresentBatch(batch).reflect()}).value();return Promise.all(promises).then(function(results){var rejection_reasons=[];results.forEach(function(result){if(result.isFulfilled())return;rejection_reasons.push(result.reason())});if(rejection_reasons.length){return Promise.reject(new Error("some ensureMembersArePresent m_ids failed:\n"+rejection_reasons.join("\n")))}else{return Promise.resolve()}})},ensureMembersArePresentInSharedModelObs:function(model_obs){model_obs=model_obs.filter(function(model_ob){return!!model_ob.is_shared});return TS.members.ensureMembersArePresentInModelObs(model_obs)},ensureMembersArePresentInModelObs:function(model_obs){var m_ids=[];var c_ids=[];if(TS.boot_data.page_needs_enterprise&&TS.boot_data.exlude_org_members)return Promise.resolve();model_obs.forEach(function(model_ob){if(model_ob.is_im){m_ids.push(model_ob.user);c_ids.push(model_ob.id)}else if(model_ob.is_mpim){m_ids.push.apply(m_ids,model_ob.members||[]);c_ids.push.apply(c_ids,_.fill(Array(model_ob.members&&model_ob.members.length||0),model_ob.id))}else if(model_ob.is_channel){}else if(model_ob.is_group){m_ids.push.apply(m_ids,model_ob.members||[]);c_ids.push.apply(c_ids,_.fill(Array(model_ob.members&&model_ob.members.length||0),model_ob.id))}else{TS.warn("ensureMembersArePresentInModelObs found an unexpected model_ob type")}});if(!m_ids.length)return Promise.resolve();return TS.members.ensureMembersArePresent(m_ids,c_ids)},getExternalTeamIdForMemberById:function(id){var member=TS.members.getMemberById(id);return member&&member._is_external&&member.team_id},isMemberInDnd:function(member){return!!member._is_in_dnd},startBatchUpsert:function(){if(TS.members.is_in_bulk_upsert_mode)return false;TS.members.is_in_bulk_upsert_mode=true;return true},finishBatchUpsert:function(){if(!TS.members.is_in_bulk_upsert_mode)return false;TS.members.is_in_bulk_upsert_mode=false;TS.utility.rAF(_logIncompleteMembers);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.members.invalidateActiveMembersArrayCaches();TS.members.maybeStoreMembers();TS.members.batch_upserted_sig.dispatch();return true},allocateTeamListMembers:function(members_for_user){var member;var members=[];var disabled_members=[];var deleted_bots=[];var bots=[];var restricted_members=[];var ultra_restricted_members=[];if(TS.boot_data.feature_name_tagging_client){members_for_user.sort(function(a,b){var a_name=a._full_name_lc||a._name_lc;var b_name=b._full_name_lc||b._name_lc;return a_name>b_name?1:b_name>a_name?-1:0})}else{members_for_user.sort(function(a,b){var a_name=a._real_name_lc||a._name_lc;var b_name=b._real_name_lc||b._name_lc;return a_name>b_name?1:b_name>a_name?-1:0})}for(var i=0;i<members_for_user.length;i++){member=members_for_user[i];if(member.deleted){if(member.is_bot){deleted_bots.push(member)}else{disabled_members.push(member)}}else if(member.is_ultra_restricted){ultra_restricted_members.push(member)}else if(member.is_restricted){restricted_members.push(member)}else if(member.is_bot||member.is_slackbot){bots.push(member)}else{members.push(member)}}return{members:members,disabled_members:disabled_members,deleted_bots:deleted_bots,bots:bots,restricted_members:restricted_members,ultra_restricted_members:ultra_restricted_members}},promiseToSearchMembers:function(maybe_searcher_p){if(!TS.boot_data.page_needs_enterprise&&!TS.lazyLoadMembersAndBots())return Promise.reject(new Error("API search not yet enabled"));return Promise.resolve(maybe_searcher_p).then(function(searcher){if(!searcher)return Promise.reject(new Error("No search parameters provided"));searcher.query=searcher.query&&searcher.query.trim()||"";searcher.include_org=!!TS.boot_data.page_needs_enterprise&&!!searcher.include_org;searcher.org_team_ids=searcher.include_org&&Array.isArray(searcher.org_team_ids)?searcher.org_team_ids:[];searcher=_readyMemberSearcher(searcher,_isNewMemberSearch(searcher));if(searcher._is_new||searcher.num_remaining>0)return _promiseToSearchMembers(searcher);return Promise.resolve(searcher)})},isLocalTeamMember:function(member){if(!member){TS.warn("isLocalTeamMember: No member provided?");return}if(member._is_local)return member._is_local;return member.team_id===TS.model.team.id},isNewMemberSearch:function(searcher){return _isNewMemberSearch(searcher)},readyMemberSearcher:function(searcher,is_new){return _readyMemberSearcher(searcher,is_new)},buildPromiseToSearchMembersArguments:function(searcher){return _buildPromiseToSearchMembersArguments(searcher)},haveAllMembersForModelOb:function(model_ob){if(!TS.lazyLoadMembersAndBots())return true;var model_ob_members=model_ob.members||[model_ob.user];var available_members=_.map(TS.model.members,"id");return!_.difference(model_ob_members,available_members).length},test:function(){var test={};Object.defineProperty(test,"_maybeSetDeletedStatus",{get:function(){return _maybeSetDeletedStatus},set:function(v){_maybeSetDeletedStatus=v}});Object.defineProperty(test,"_maybeSetTeamId",{get:function(){return _maybeSetTeamId},set:function(v){_maybeSetTeamId=v}});Object.defineProperty(test,"_maybeSetLocality",{get:function(){return _maybeSetLocality},set:function(v){_maybeSetLocality=v}});Object.defineProperty(test,"_setImAndMpimNames",{get:function(){return _setImAndMpimNames},set:function(v){_setImAndMpimNames=v}});Object.defineProperty(test,"_setLowerCaseNamesForMember",{get:function(){return _setLowerCaseNamesForMember},set:function(v){_setLowerCaseNamesForMember=v}});Object.defineProperty(test,"_setImagesForMember",{get:function(){return _setImagesForMember},set:function(v){_setImagesForMember=v}});Object.defineProperty(test,"_logIncompleteMembers",{get:function(){return _logIncompleteMembers},set:function(v){_logIncompleteMembers=v}});return test}});var _id_map={};var _name_map={};var _active_members_with_self_and_not_slackbot=[];var _active_members_except_self_and_slackbot=[];var _active_members_except_self_and_bots=[];var _active_members_with_self_and_slackbot=[];var _active_members_with_slackbot_and_not_self=[];
var _active_local_members_with_slackbot_and_not_self=[];var _active_local_members_with_self_and_slackbot=[];var _members_for_user=[];var _users_info_api_max_users=250;var _flannel_max_users=100;var _maybeSetDeletedStatus=function(member){if(!TS.boot_data.page_needs_enterprise)return;if(TS.lazyLoadMembersAndBots()&&TS.flannel.isMemberDeleted(member)){member.deleted=true;return}if(member.enterprise_user&&member.enterprise_user.teams&&member.enterprise_user.teams.length>0){if(TS.boot_data.app==="web"){if(member.enterprise_user.teams.indexOf(TS.model.team.id)>-1)member.deleted=false}else{member.deleted=false}}};var _maybeSetTeamId=function(member){if(member.team_id)return;if(member.enterprise_user&&member.id===member.enterprise_user.id){member.team_id=member.enterprise_user.teams[0];return}member.team_id=TS.model.team.id};var _maybeSetLocality=function(member){if(!member){TS.warn("_maybeSetLocality: No member provided?");return}member._is_local=member.team_id===TS.model.team.id;if(TS.boot_data.page_needs_enterprise){if(TS.boot_data.app!=="web"){member._is_local=member.enterprise_user&&member.enterprise_user.teams&&member.enterprise_user.teams.indexOf(TS.model.team.id)>-1}member._is_from_org=!member._is_local&&!!member.enterprise_user&&TS.model.enterprise&&TS.model.enterprise.id===member.enterprise_user.enterprise_id;member._is_external=!member._is_local&&!member._is_from_org}};var _setImAndMpimNames=function(member){TS.ims.setNameFromMember(member);TS.mpims.setNamesFromMember(member)};var _getActiveMembersWorker=function(A,members,include_self,include_slackbot,exclude_bots){A.length=0;var member;for(var m=0;m<members.length;m++){member=members[m];if(member.deleted)continue;if(!include_slackbot&&member.is_slackbot)continue;if(!include_self&&member.is_self)continue;if(exclude_bots&&member.is_bot)continue;A.push(member)}return A};var _getMembersByIdFromFlannel=function(m_ids){if(!Array.isArray(m_ids))return Promise.reject(new Error("m_ids is not an array"));TS.log(1989,"Flannel: fetching members",m_ids);return TS.flannel.fetchAndUpsertObjectsByIds(m_ids).then(function(members){if(members.length!==_.uniq(m_ids).length){var e=new Error("Did not receive all of the members we asked for");e.requested_ids=m_ids;e.missing_ids=_.difference(m_ids,_.map(members,"id"));TS.log(1989,"Flannel: falling back to the API because we asked for "+m_ids.length+" members but only got "+members.length+" back; missing "+e.missing_ids);throw e}var id_name_map={};m_ids.forEach(function(id){id_name_map[id]=_.get(_.find(members,{id:id}),"name")});TS.log(1989,"Flannel: fetched",m_ids.length,"members on-the-fly :sunglasses:",id_name_map);return members}).catch(function(err){var always_use_api=true;return _getMembersByIdFromModelOrApi(m_ids,always_use_api)})};var _getMembersByIdFromModelOrApi=function(m_ids,always_use_api){if(TS.ms.is_flannel&&!always_use_api){return _getMembersByIdFromFlannel(m_ids)}if(!Array.isArray(m_ids))return Promise.reject(Error("m_ids is not an array"));var calling_args={users:m_ids};if(TS.lazyLoadMembersAndBots()){calling_args.custom_fields_mode="user"}return new Promise(function(resolve,reject){TS.api.callImmediately("users.info",calling_args).then(function(response){var members=[];response.data.users.forEach(function(user){members.push(TS.members.upsertAndSignal(user).member)});resolve(members)},function(ret){reject(Error(ret.data&&ret.data.error||"unknown error"))})})};var _getMemberByIdFromModelOrApi=function(m_id,c_id,t_id){if(typeof m_id!=="string"){return Promise.reject(Error('m_id: "'+m_id+'" is not a String'))}c_id=c_id||"";t_id=t_id||"";if(TS.pri)TS.log(529,'_getMemberByIdFromModelOrApi m_id: "'+m_id+'" c_id: "'+c_id+'" t_id: "'+t_id+'"');var member=TS.members.getMemberById(m_id);if(member){return Promise.resolve(member)}var unknown_id=m_id+"_"+c_id+"_"+t_id;var tries=TS.model.incrementUnknownIdHandled(unknown_id);var user_p;if(TS.lazyLoadMembersAndBots()){user_p=_getMembersByIdFromFlannel([m_id]).then(function(members){return members[0]})}else{var calling_args={user:m_id};if(c_id)calling_args.shared_channel=c_id;if(!c_id&&t_id)calling_args.team=t_id;user_p=TS.api.callImmediately("users.info",calling_args).then(function(resp){return TS.members.upsertAndSignal(resp.data.user).member})}return user_p.tap(function(){TS.model.reportResultOfUnknownIdHandled(unknown_id,true)}).catch(function(resp){TS.model.reportResultOfUnknownIdHandled(unknown_id,false);var call_type=TS.lazyLoadMembersAndBots()?"Flannel":"API";var error_message=_.get(resp,"data.error","unknown error")+" try #"+tries+" calling "+call_type+" with user:"+m_id+" channel:"+c_id;return new Error(error_message)})};var _getMemberNameHelper=function(member_or_id,type){var member=_.isString(member_or_id)?TS.members.getMemberById(member_or_id):member_or_id;if(!member)return"NO MEMBER??";if(!member.profile){if(member.is_bot&&member.name){return member.name}else{return"NO MEMBER??"}}if(member.profile[type])return member.profile[type];if(member[type])return member[type];if(member.profile[type+"_normalized"]){return member.profile[type+"_normalized"]}return""};var _storeMembersThrottled=function(force){var members=TS.members.prepareMembersForLS();var existing=!force&&TS.storage.fetchMembers();if(force||!existing||!TS.utility.areSimpleObjectsEqual(existing,members)){TS.storage.storeMembers(members)}};var _isNewMemberSearch=function(searcher){return searcher._last_query!==searcher.query||searcher._last_include_org!==searcher.include_org||_.xor(searcher._last_org_team_ids,searcher.org_team_ids).length};var _readyMemberSearcher=function(searcher,is_new){searcher=searcher||{};if(searcher.hasOwnProperty("_searcher_p")&&is_new)searcher._searcher_p.cancel();if(!searcher.hasOwnProperty("_cursor_mark")||is_new)searcher._cursor_mark="";if(!searcher.hasOwnProperty("full_profile_filter"))searcher.full_profile_filter=true;if(!searcher.hasOwnProperty("include_bots"))searcher.include_bots=true;if(!searcher.hasOwnProperty("include_deleted"))searcher.include_deleted=false;if(!searcher.hasOwnProperty("include_self"))searcher.include_self=false;if(!searcher.hasOwnProperty("include_slackbot"))searcher.include_slackbot=true;if(!searcher.hasOwnProperty("items")||is_new)searcher.items=[];if(!searcher.hasOwnProperty("not_member_of"))searcher.not_member_of=[];if(!searcher.hasOwnProperty("member_of"))searcher.member_of=[];if(!searcher.hasOwnProperty("num_found")||is_new)searcher.num_found=0;if(!searcher.hasOwnProperty("num_remaining")||is_new)searcher.num_remaining=0;if(!searcher.hasOwnProperty("num_new")||is_new)searcher.num_new=0;if(!searcher.hasOwnProperty("max_api_results"))searcher.max_api_results=100;if(is_new){searcher._last_query=searcher.query;searcher._last_include_org=searcher.include_org;searcher._last_org_team_ids=searcher.org_team_ids}searcher._is_new=!!is_new;return searcher};var _promiseToSearchMembers=function(searcher){var promiseToSearch=function(){return _promiseToSearchMembersWorker(searcher)};if(searcher._is_new){searcher._searcher_p=promiseToSearch()}else{searcher._searcher_p=searcher._searcher_p.then(promiseToSearch)}return searcher._searcher_p};var _buildPromiseToSearchMembersArguments=function(searcher){var matchers=[TS.utility.search.makeClause("is","user")];if(searcher._last_query){var query_matchers=searcher._last_query.split(/\s*,\s*|\s+/).map(function(q){return q.charAt("0")==="@"?q.substring(1):q}).filter(function(q){return!!q}).map(function(query){if(query.length===1||!searcher.full_profile_filter){if(TS.boot_data.feature_name_tagging_client){return TS.utility.search.makeConjunction("OR",[TS.utility.search.makeClause("full_name",query),TS.utility.search.makeClause("preferred_name",query)])}else{return TS.utility.search.makeConjunction("OR",[TS.utility.search.makeClause("name",query),TS.utility.search.makeClause("real_name",query)])}}else{return TS.utility.search.makeClause("fuzzy",query)}});matchers=matchers.concat(query_matchers)}if(searcher.not_member_of&&searcher.not_member_of.length){var not_member_of_matchers=searcher.not_member_of.map(function(id){return TS.utility.search.makeClause("not_member_of",id)});matchers.push(not_member_of_matchers.length>1?TS.utility.search.makeConjunction("OR",not_member_of_matchers):not_member_of_matchers[0])}if(searcher.member_of&&searcher.member_of.length){var member_of_matchers=searcher.member_of.map(function(id){return TS.utility.search.makeClause("member_of",id)});matchers.push(member_of_matchers.length>1?TS.utility.search.makeConjunction("OR",member_of_matchers):member_of_matchers[0])}if(searcher._last_include_org&&searcher._last_org_team_ids.length){var org_matchers=searcher._last_org_team_ids.map(function(id){return TS.utility.search.makeClause("belongs_to_team_id",id)});matchers.push(org_matchers.length>1?TS.utility.search.makeConjunction("OR",org_matchers):org_matchers[0])}var query=matchers.length>1?TS.utility.search.makeConjunction("AND",matchers):matchers[0];var calling_args={query:query,count:searcher.max_api_results,include_bots:searcher.include_bots,include_deleted:searcher.include_deleted,raw_query:searcher.query};if(searcher._last_include_org)calling_args.all_of_org=searcher._last_include_org;if(searcher._cursor_mark)calling_args.cursor_mark=searcher._cursor_mark;return calling_args};var _promiseToSearchMembersWorker=function(searcher){var calling_args=_buildPromiseToSearchMembersArguments(searcher);searcher.num_new=0;return TS.utility.search.promiseToSearch(calling_args).then(function(response){if(!response.data.items.length)return Promise.resolve(searcher);if(!searcher.num_remaining){searcher.num_remaining=response.data.num_found;searcher.num_found=response.data.num_found}searcher.num_remaining-=response.data.items.length;searcher._cursor_mark=response.data.next_cursor_mark;var matches=response.data.items.map(function(member){var full_member=TS.members.getMemberById(member.id);if(!full_member){if(searcher._last_include_org&&member.team_id!==TS.model.team.id){member.is_primary_owner=false;member.is_owner=false;member.is_admin=false}full_member=TS.members.upsertMember(member).member}return full_member}).filter(function(member){if(member.is_self&&!searcher.include_self||member.is_slackbot&&!searcher.include_slackbot){searcher.num_found--;return false}return true});searcher.num_new=matches.length;searcher.items.push.apply(searcher.items,matches);return Promise.resolve(searcher)})};var _omitImagesFromProfile=function(profile){return _.omitBy(profile,function(value,key){return key.indexOf("image_")===0})};var _processExistingMemberForUpserting=function(existing_member,member){var status="NOOP";var what_changed=[];_setPresenceForMemberAlwaysActive(existing_member,member);for(var k in member){if(k=="profile"){if(TS.boot_data.feature_canonical_avatars_web_client){var old_profile=_omitImagesFromProfile(existing_member.profile);var new_profile=_omitImagesFromProfile(member.profile)}else{var old_profile=existing_member.profile;var new_profile=member.profile}if(_.isObject(new_profile)&&!_.isEqual(old_profile,new_profile)){var name_changed=_.some(["real_name","full_name","preferred_name"],function(name_type){return new_profile[name_type]!=old_profile[name_type]});if(!_.isUndefined(old_profile["fields"])&&_.isUndefined(new_profile["fields"])){if(!TS.calls){TS.warn("So uh, yeah, we just tried to overwrite the `fields` value. Keeping what we have instead. User: "+member["id"])}new_profile["fields"]=old_profile["fields"]}if(TS.boot_data.feature_canonical_avatars_web_client){existing_member["profile"]=_.assign(existing_member["profile"],new_profile)}else{existing_member["profile"]=new_profile}if(name_changed){_setLowerCaseNamesForMember(existing_member)}var image_changed=old_profile["avatar_hash"]!=new_profile["avatar_hash"];if(image_changed)_setImagesForMember(existing_member);status="CHANGED";what_changed.push(k)}}else if(k=="enterprise_user"){if(existing_member[k]){for(var l in member[k]){if(!_.isEqual(existing_member[k][l],member[k][l])){existing_member[k][l]=member[k][l];status="CHANGED";what_changed.push(k)}}}else{existing_member[k]=member[k];status="CHANGED";what_changed.push(k)}}else if(k=="id"){var maybe_replace_id=existing_member.id!=member.id&&existing_member.enterprise_user&&member.enterprise_user;if(maybe_replace_id){var existing_is_canonical=existing_member.enterprise_user.id==existing_member.id;var change_to_local=member.id!=member.enterprise_user.id;if(existing_is_canonical&&change_to_local){existing_member.id=member.id;status="CHANGED";what_changed.push(k)}}}else if(existing_member[k]!=member[k]){if(member[k]&&!TS.utility.isScalar(member[k])){existing_member[k]=member[k];TS.warn(k+" is not scalar! it needs to be handled by upsertMember specifically to test if it has changed! "+typeof member[k])}else if(typeof member[k]!="boolean"||!member[k]!=!existing_member[k]){what_changed.push(k);existing_member[k]=member[k];status="CHANGED";if(k=="name"){TS.members.usernameChanged(existing_member)}else if(k=="real_name"){existing_member._real_name_lc=_.toLower(existing_member.profile.real_name)}}}}_maybeSetDeletedStatus(existing_member);_maybeSetTeamId(existing_member);_maybeSetLocality(existing_member);return{status:status,what_changed:what_changed}};var _processNewMemberForUpserting=function(member){if(!member.profile||typeof member.profile!=="object"){member.profile={}}if(member.id=="USLACKBOT"){member.is_slackbot=true}member.member_color=member.color;if(TS.model.user_colors[member.id]){TS.members.setMemberUserColor(member,TS.model.user_colors[member.id])}_maybeSetDeletedStatus(member);_maybeSetTeamId(member);_maybeSetLocality(member);member._first_name_lc="";member._last_name_lc="";member._real_name_normalized_lc="";if(TS.boot_data.feature_name_tagging_client){member._preferred_name_lc="";member._preferred_name_normalized_lc="";member._full_name_lc="";member._full_name_normalized_lc=""}_setLowerCaseNamesForMember(member);_setImagesForMember(member);member.files=[];member.activity=[];member.stars=[];member.mentions=[];_setPresenceForNewMember(member);_setImAndMpimNames(member)};var _setLowerCaseNamesForMember=function(member){if("name"in member)member._name_lc=_.toLower(member.name);if(!_.isObject(member.profile))return;if("first_name"in member.profile)member._first_name_lc=_.toLower(member.profile.first_name);if("last_name"in member.profile)member._last_name_lc=_.toLower(member.profile.last_name);if("real_name"in member.profile)member._real_name_lc=_.toLower(member.profile.real_name);if("real_name_normalized"in member.profile)member._real_name_normalized_lc=_.toLower(member.profile.real_name_normalized);if(TS.boot_data.feature_name_tagging_client){if("preferred_name"in member.profile)member._preferred_name_lc=_.toLower(member.profile.preferred_name);if("preferred_name_normalized"in member.profile)member._preferred_name_normalized_lc=_.toLower(member.profile.preferred_name_normalized);if("full_name"in member.profile)member._full_name_lc=_.toLower(member.profile.full_name);if("full_name_normalized"in member.profile)member._full_name_normalized_lc=_.toLower(member.profile.full_name_normalized)}};var _setImagesForMember=function(member){if(!TS.boot_data.feature_canonical_avatars_web_client||!_.isObject(member.profile))return;_maybeSetTeamId(member);var image_url=TS.model.team.avatar_base_url+member.team_id+"-"+member.id+"-"+member.profile.avatar_hash+"-";_.forEach(["24","32","48","72","192","512","1024"],function(size){member.profile["image_"+size]=image_url+size});delete member.profile.image_original};var _setPresenceForMemberAlwaysActive=function(existing_member,member){if(!TS.boot_data.feature_always_active_bots)return;if(_.get(existing_member,"profile.always_active")!==_.get(member,"profile.always_active")){member.presence=member["profile"]["always_active"]?"active":"away"}};var _setPresenceForNewMember=function(member){if(!member.presence&&!_.isEmpty(TS.model.online_users)){var index=TS.model.online_users.indexOf(member.id);if(index>-1){member.presence="active";TS.model.online_users.splice(index,1)}}member.presence=member.presence=="active"?"active":"away";if(!TS.boot_data.feature_always_active_bots)return;if(_.get(member,"profile.always_active")){member.presence="active"}};var _already_tried_to_fix_incomplete_members=false;var _logIncompleteMembers=function(){if(!TS.client)return;var incomplete=_.filter(TS.model.members,function(member){return!_.isObject(member.profile)||!member.profile.image_24||!member.profile.avatar_hash});if(incomplete.length>0){TS.metrics.count("incomplete_model_members");var profiles=_.filter(incomplete,function(member){return!_.isObject(member.profile)});var images=_.difference(incomplete,profiles);images=_.filter(images,function(member){return!member.profile.image_24});var avatars=_.difference(incomplete,profiles);avatars=_.filter(avatars,function(member){return!member.profile.avatar_hash});incomplete=_.map(incomplete,"id");profiles=_.map(profiles,"id");images=_.map(images,"id");avatars=_.map(avatars,"id");var desc="missing";if(profiles.length>0)desc+=" profiles";if(images.length>0)desc+=" images";if(avatars.length>0)desc+=" avatars";TS.logError({profiles:profiles,images:images,avatar:avatars,try_to_fix:!_already_tried_to_fix_incomplete_members},desc,"incomplete_model_members");if(!_already_tried_to_fix_incomplete_members){_already_tried_to_fix_incomplete_members=true;TS.members.startBatchUpsert();incomplete=_.chunk(incomplete,10);var promises=_.map(incomplete,function(member_ids){return TS.api.call("users.info",{users:member_ids.join(",")}).then(function(resp){resp.data.users.forEach(TS.members.upsertAndSignal)})});Promise.all(promises).then(TS.members.finishBatchUpsert)}}}})();(function(){"use strict";TS.registerModule("pending_users",{sanitizeNameFields:function(invitee){if(!invitee.invite_prefs||invitee.invite_prefs.full_name)return;var prefs=invitee.invite_prefs;if(prefs.first_name&&prefs.last_name){prefs.full_name=[prefs.first_name,prefs.last_name].join(" ").trim()}else if(prefs.first_name){prefs.full_name=prefs.first_name}else if(prefs.last_name){prefs.full_name=prefs.last_name}},getUserNameForSort:function(invitee){if(invitee.invite_prefs&&invitee.invite_prefs.full_name){return invitee.invite_prefs.full_name.toLowerCase()}else{return invitee.email}},filterOutURAs:function(invitees){return invitees.filter(function(invitee){if(invitee.invite_prefs&&invitee.invite_prefs.type==="ultra_restricted"){return false}return true})},checkUserMatch:function(invitee,regex){return invitee.invite_prefs&&invitee.invite_prefs.full_name&&invitee.invite_prefs.full_name.match(regex)||invitee.email.match(regex)},invitePendingUsersToChannel:function(invitees,channel_id){if(!channel_id||!invitees||!invitees.length)return;var all_emails=invitees.map(function(user){return user.email});while(all_emails.length){var emails=all_emails.splice(0,30).join(",");TS.api.call("channels.invitePendingUsers",{channel:channel_id,emails:emails})}},usersSorterByName:function(a,b){var a_name=a.member?TS.members.getMemberNameForSort(a.member):TS.pending_users.getUserNameForSort(a);var b_name=b.member?TS.members.getMemberNameForSort(b.member):TS.pending_users.getUserNameForSort(b);if(a_name<b_name)return-1;if(a_name>b_name)return 1;return 0}})})();(function(){"use strict";TS.registerModule("team",{team_profile_changed_sig:new signals.Signal,team_plan_changed_sig:new signals.Signal,team_email_domain_changed_sig:new signals.Signal,team_domain_changed_sig:new signals.Signal,team_name_changed_sig:new signals.Signal,onStart:function(){if(TS.ms)TS.ms.connected_sig.add(_getTeamProfileOnNextRequest,TS.team);_maybeSetupTeamModel()},upsertAndSignal:function(team){if(!team)return;var upsert=TS.team.upsertTeam(team);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("profile")!=-1){TS.team.team_profile_changed_sig.dispatch(upsert.team)}if(upsert.what_changed.indexOf("email_domain")!=-1){TS.team.team_email_domain_changed_sig.dispatch(upsert.team)}if(upsert.what_changed.indexOf("domain")!=-1){TS.team.team_domain_changed_sig.dispatch(upsert.team)}}return upsert},upsertTeam:function(team,log){_maybeSetupTeamModel();var existing_team=TS.model.team;var status="NOOP";var what_changed=[];if(team){TS.log(4,'updating team "'+team.id+'"');for(var k in team){if(k=="profile"){if(team.profile.fields&&team.profile.fields.length){if(typeof team.profile.fields[0]==="object"){_mergeFields(team.profile.fields)}else if(typeof team.profile.fields[0]==="string"){_deleteFields(team.profile.fields)}what_changed.push(k);status="CHANGED"}}else if(k=="icon"||k=="prefs"){existing_team[k]=team[k]}else if(existing_team[k]!=team[k]){if(team[k]&&!TS.utility.isScalar(team[k])){existing_team[k]=team[k];TS.warn(k+" is not scalar! it needs to be handled by upsertTeam specifically to test if it has changed! "+typeof team[k])}else if(typeof team[k]!="boolean"||!team[k]!=!existing_team[k]){existing_team[k]=team[k];what_changed.push(k);status="CHANGED"}}}}return{status:status,team:existing_team,what_changed:what_changed}},ensureTeamProfileFields:function(){if(_promise_to_get_team_profile)return _promise_to_get_team_profile;_promise_to_get_team_profile=TS.api.call("team.profile.get").then(function(response){TS.team.upsertTeam({profile:response.data.profile});return null});return _promise_to_get_team_profile},getTeamProfileFieldById:function(id){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getTeamProfileFieldById");for(var i=0;i<TS.model.team.profile.fields.length;i++){if(TS.model.team.profile.fields[i].id===id)return TS.model.team.profile.fields[i]}return null},getVisibleTeamProfileFields:function(){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getVisibleTeamProfileFields");return TS.model.team.profile.fields.filter(function(field){return!field.is_hidden})},getHiddenTeamProfileFields:function(){if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getHiddenTeamProfileFields");return TS.model.team.profile.fields.filter(function(field){return field.is_hidden})},sortTeamProfileFieldsByOrdering:function(){if(!TS.model.team.profile.fields.length)return void TS.warn("Ensure profile fields exist before calling sortTeamProfileFieldsByOrdering");TS.model.team.profile.fields.sort(function(this_field,that_field){return this_field.ordering-that_field.ordering})},getVisibleTeamProfileFieldsForMember:function(member,include_empty_member_fields){if(!(member&&member.profile))return[];if(!TS.model.team.profile.fields.length)TS.warn("Ensure profile fields exist before calling getVisibleTeamProfileFieldsForMember");return TS.model.team.profile.fields.map(function(field){if((include_empty_member_fields||_.get(member.profile,["fields",field.id,"value"]))&&!field.is_hidden){return $.extend(true,{value:_.get(member.profile,["fields",field.id,"value"]),alt:_.get(member.profile,["fields",field.id,"alt"])},field)}}).filter(function(field){return!!field})},ensureEntireTeamLoaded:function(){if(_entire_team_loaded)return Promise.resolve();if(_fetch_all_members_p)return _fetch_all_members_p;_fetch_all_members_p=TS.flannel.fetchAndUpsertAllMembersOnTeam().then(function(){TS.log(1989,"Flannel: setting _entire_team_loaded to true");_entire_team_loaded=true}).finally(function(){TS.log(1989,"Flannel: unsetting _fetch_all_members_p");_fetch_all_members_p=undefined});return _fetch_all_members_p},isEntireTeamLoaded:function(){return _entire_team_loaded},getBestEffortTotalTeamSize:function(){if(TS.lazyLoadMembersAndBots()){var general=TS.channels.getGeneralChannel();if(general){return general.members.length}else{return _(TS.channels.getChannelsForUser()).map(function(channel){return channel.members.length}).max()}}return TS.model.members.length}});var _entire_team_loaded=false;var _fetch_all_members_p;var _promise_to_get_team_profile;var _getTeamProfileOnNextRequest=function(){_promise_to_get_team_profile=null};var _isEmpty=function(fields){if(fields&&fields.length)_.remove(fields,function(field){return!field});return!(fields&&fields.length)};var _maybeSetupTeamModel=function(){if(_.get(window,"TS.model.team.profile.fields"))return;TS.model.team=TS.model.team||{};TS.model.team.profile=TS.model.team.profile||{};TS.model.team.profile.fields=TS.model.team.profile.fields||[]};var _mergeFields=function(fields){if(_isEmpty(fields))return;var sort=false;var upsert_members=false;var map=TS.model.team.profile.fields.reduce(function(accumulator,field){accumulator[field.id]=field;return accumulator},{});fields.forEach(function(field){var existing_field=map[field.id];if(existing_field){upsert_members=upsert_members||_mustUpsertMembersAfterMerge(existing_field,field);sort=sort||existing_field.ordering!==field.ordering;$.extend(true,existing_field,field)}else{TS.model.team.profile.fields.push(field);if(TS.model.members&&field.type==="options_list")upsert_members=true}});if(sort)TS.team.sortTeamProfileFieldsByOrdering();if(upsert_members)_upsertMembers(fields)};var _deleteFields=function(fields){if(_isEmpty(fields))return;_.remove(TS.model.team.profile.fields,function(field){return fields.indexOf(field.id)!==-1});_upsertMembers(fields)};var _upsertMembers=function(fields){if(!fields||!fields.length)return;if(!TS.model.members)return;fields.forEach(function(field){TS.model.members.forEach(function(member){if(member.profile.fields&&member.profile.fields[field.id||field]){if(field.id){if(field.type!=="options_list")return;var value_is_valid=field.possible_values.indexOf(member.profile.fields[field.id].value)!==-1;if(value_is_valid)return}var member_to_upsert=$.extend(true,{},member);delete member_to_upsert.profile.fields[field.id||field];TS.members.upsertMember(member_to_upsert)}})})};var _mustUpsertMembersAfterMerge=function(old_field,new_field){if(TS.model.members&&new_field.type==="options_list"){return new_field.possible_values.some(function(value){return old_field.possible_values.indexOf(value)===-1})}return false}})();(function(){"use strict";TS.registerModule("apps",{onStart:function(){var always_wait=true;_resetUpAppsThrottled=TS.utility.throttleFunc(_resetUpAppsThrottled,3e3,always_wait)},resetUpApps:function(){TS.storage.storeApps("");_resetUpAppsThrottled()},setUp:function(){return TS.apps.fetchApps()},ingestApp:function(app){if(!app||!app.id)return;TS.model.apps[app.id]=app;TS.storage.storeApps({data:TS.model.apps,cache_ts:TS.model.apps_cache_ts})},ingestApps:function(apps){if(typeof apps!=="object"||!apps)return;TS.storage.storeApps({data:apps,cache_ts:TS.model.apps_cache_ts});TS.model.apps={};_.forEach(apps,function(app){TS.model.apps[app.id]=app})},fetchApps:function(){var ls_apps=TS.storage.fetchApps();if(ls_apps&&TS.model.apps_cache_ts==ls_apps.cache_ts){TS.model.did_we_load_with_app_cache=true;TS.apps.ingestApps(ls_apps.data);return Promise.resolve()}return TS.api.call("apps.list").then(function(res){TS.model.apps_cache_ts=res.data.cache_ts;TS.apps.ingestApps(res.data.apps)}).catch(_.noop)},getAppById:function(app_id){if(!_.isString(app_id))return null;var apps=TS.model.apps;if(!apps){TS.warn("Trying to look up app by id ("+app_id+") but TS.model.apps is not present.");return null}var app=_.find(TS.model.apps,{id:app_id});if(app){return app}else{TS.warn("Trying to look up app by id ("+app_id+") but it is not present.")}return null},promiseToGetFullAppProfile:function(app_id,bot_id){if(!_.isString(app_id))return null;if(!_.isString(bot_id))return null;return new Promise(function(resolve,reject,onCancel){var apps_profile_promise=TS.api.call("apps.profile.get",{bot:bot_id}).then(function(res){if(res.data.ok&&res.data.app_profile){var app=res.data.app_profile;TS.apps.ingestApp(app);resolve(app)}else{reject(res.data.error);TS.warn("Trying to look up app by bot id ("+bot_id+") but it failed.")}});onCancel(function(){apps_profile_promise.cancel()})})},sortNames:function(names){return names.slice().sort(TS.apps.compareNames)},compareNames:function(a,b){if(!a||!b)return!a?-1:1;return a.localeCompare(b)}});var _resetUpAppsThrottled=function(){TS.apps.setUp()}})();(function(){"use strict";TS.registerModule("bots",{added_sig:new signals.Signal,changed_name_sig:new signals.Signal,changed_deleted_sig:new signals.Signal,changed_icons_sig:new signals.Signal,changed_during_bulk_upsert_sig:new signals.Signal,is_in_bulk_upsert_mode:false,onStart:function(){_storeBotsThrottled=TS.utility.throttleFunc(_storeBotsThrottled,20)},getBotById:function(id){if(TS.model.submodel)return TS.model.submodel.getBotById(id);if(_id_map[id])return _id_map[id];var bots=TS.model.bots;var bot;for(var i=0;i<bots.length;i++){bot=bots[i];if(bot.id==id){TS.warn(id+" not in _id_map");_id_map[id]=bot;return bot}}return null},getBotByName:function(name){if(TS.model.submodel)return TS.model.submodel.getBotByName(name);var bots=TS.model.bots;var bot;if(typeof name==="undefined"){return null}for(var i=0;i<bots.length;i++){bot=bots[i];if(bot.name.toLowerCase()==name.toLowerCase())return bot}return null},getBotInfoByMsg:function(msg){var member=TS.members.getMemberById(msg.user);var bot_id=msg.bot_id||_.get(member,"profile.bot_id");var bot=TS.bots.getBotById(bot_id);if(bot_id&&!bot&&TS.lazyLoadMembersAndBots()){TS.info(1989,"Flannel: failed to find a bot ("+bot_id+") whilst lazy loading bots")}var app_id=_.get(member,"profile.api_app_id")||_.get(bot,"app_id");if(!app_id&&!bot_id){TS.warn("Unable to get bot info for message",msg);return null}return{bot_id:bot_id,app_id:app_id}},upsertAndSignal:function(bot){var upsert=TS.bots.upsertBot(bot);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("icons")!=-1){TS.bots.changed_icons_sig.dispatch(upsert.bot)}if(upsert.what_changed.indexOf("name")!=-1){TS.bots.changed_name_sig.dispatch(upsert.bot)}if(upsert.what_changed.indexOf("deleted")!=-1){TS.bots.changed_deleted_sig.dispatch(upsert.bot)}}return upsert},upsertBot:function(bot,log){var bots=TS.model.bots;var existing_bot=TS.bots.getBotById(bot.id);var status="NOOP";var what_changed=[];if(existing_bot){if(TS.pri)TS.log(5,'updating existing bot "'+bot.id+'"');for(var k in bot){if(k=="icons"){if(bot[k]&&!TS.utility.areSimpleObjectsEqual(bot[k],existing_bot[k],"bot:"+bot.id+" "+bot.name)){existing_bot["icons"]=bot["icons"];status="CHANGED";what_changed.push(k)}}else if(existing_bot[k]!=bot[k]){if(bot[k]&&!TS.utility.isScalar(bot[k])){existing_bot[k]=bot[k];TS.warn(k+" is not scalar! it needs to be handled by upsertBot specifically to test if it has changed! "+typeof bot[k])}else if(typeof bot[k]!="boolean"||!bot[k]!=!existing_bot[k]){what_changed.push(k);existing_bot[k]=bot[k];status="CHANGED"}}}bot=existing_bot}else{status="ADDED";if(TS.pri)TS.log(5,'adding bot "'+bot.id+'"');TS.bots.processNewBotForUpserting(bot);bots.push(bot);_id_map[bot.id]=bot}if(status=="ADDED"||status=="CHANGED"){_bots_changed_during_bulk_upsert=true;TS.bots.maybeStoreBots()}return{status:status,bot:bot,what_changed:what_changed}},processNewBotForUpserting:function(bot){},prepareBotsForLS:function(){var new_bots=[];var new_bot;var bot;var k;var i;for(i=0;i<TS.model.bots.length;i++){bot=TS.model.bots[i];new_bot={};new_bots.push(new_bot);for(k in bot){new_bot[k]=bot[k]}}return new_bots},maybeStoreBots:function(force){if(!TS.storage.isUsingMemberBotCache())return;if(TS.bots.is_in_bulk_upsert_mode)return;_storeBotsThrottled(force||false)},configureUrl:function(member){if(!member.is_bot)return;var url;var app_id=_getBotAppId(member);if(app_id){url="/apps/"+app_id}else if(member.profile.bot_id){url="/services/"+member.profile.bot_id}return url},startBatchUpsert:function(){if(TS.bots.is_in_bulk_upsert_mode)return false;TS.bots.is_in_bulk_upsert_mode=true;_bots_changed_during_bulk_upsert=false;return true},finishBatchUpsert:function(){if(!TS.bots.is_in_bulk_upsert_mode)return false;TS.bots.is_in_bulk_upsert_mode=false;TS.bots.maybeStoreBots();if(_bots_changed_during_bulk_upsert){TS.bots.changed_during_bulk_upsert_sig.dispatch()}return true},ensureBotsInDataArePresent:function(data){var bot_ids=TS.utility.extractAllBotIds(data);return TS.bots.ensureBotsArePresent(bot_ids);
},ensureBotsArePresent:function(bot_ids){var missing_bot_ids=_.reject(bot_ids,TS.bots.getBotById);if(!missing_bot_ids.length)return Promise.resolve();return TS.flannel.fetchAndUpsertObjectsByIds(missing_bot_ids)}});var _bots_changed_during_bulk_upsert;var _id_map={};var _getBotAppId=function(member){var app_id=member.profile.api_app_id;if(!app_id&&TS.model.apps&&TS.model.apps.length){var bot_app=_.find(TS.model.apps,function(app){return app.name.toLowerCase()==member.name.toLowerCase()});if(bot_app)app_id=bot_app.id}return app_id};var _storeBotsThrottled=function(force){var bots=TS.bots.prepareBotsForLS();var existing=!force&&TS.storage.fetchBots();if(force||!existing||!TS.utility.areSimpleObjectsEqual(existing,bots)){TS.storage.storeBots(bots)}}})();(function(){"use strict";TS.registerModule("members.view",{team_filter_changed_sig:new signals.Signal,filter_timer:null,onStart:function(){_is_web_admin_page=TS.web&&TS.web.admin},switchTabs:function(tab_name){if(_is_web_admin_page&&TS.web.admin.view=="invites"){$("#"+tab_name+"_invites_tab").trigger("click")}else{if(TS.client){$("#"+tab_name+"_members_tab").find("a").trigger("click")}else{$("#"+tab_name+"_members_tab").trigger("click")}}},bindTeamFilter:function(filter_container_id,scroller_id,full_profile_filter,is_long_list_view,include_bots,include_deleted){var $div=$(filter_container_id);var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");var include_org=TS.boot_data.page_needs_enterprise;_storeFilterArgumentsByScrollerId(scroller_id,full_profile_filter,is_long_list_view,include_org,include_bots,include_deleted);_query_for_match=null;if(full_profile_filter&&!is_long_list_view){$input.on("focus",function(){TS.team.ensureTeamProfileFields()})}$input.bind("keyup update-team-filter",function(e){var new_query=$input.val();if(TS.members.view.filter_timer){window.clearTimeout(TS.members.view.filter_timer)}var search=function(){if(new_query.trim().toLocaleLowerCase()!==_query_for_match){TS.members.view.filterTeam(new_query,filter_container_id,scroller_id,full_profile_filter).then(function(){if(TS.view)TS.view.rebuildUserGroupList()})}$icon_close.toggleClass("hidden",!new_query.trim())};if(is_long_list_view){search()}else{TS.members.view.filter_timer=window.setTimeout(search,TS.members.getMembersForUser().length>500?250:50)}});$icon_close.bind("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id);if(TS.view)TS.view.rebuildUserGroupList();_query_for_match=null;setTimeout(function(){$input.focus()},0)})},filterTeam:function(new_query,filter_container_id,scroller_id,full_profile_filter){var args=_getFilterArgumentsByScrollerId(scroller_id);if(full_profile_filter||args&&args.full_profile_filter){return TS.team.ensureTeamProfileFields().then(function(){if(TS.boot_data.feature_roster_changes){if(scroller_id=="#team_list_scroller"){return _promiseToFilterTeam(new_query,filter_container_id,scroller_id,args.full_profile_filter,args.include_org,args.include_bots,args.include_deleted)}}else{if(TS.boot_data.page_needs_enterprise&&args&&args.is_long_list_view){if(scroller_id=="#team_list_scroller"){return _promiseToFilterTeam(new_query,filter_container_id,scroller_id,args.full_profile_filter,args.include_org,args.include_bots,args.include_deleted)}}else{_filterTeam(new_query,filter_container_id,scroller_id,full_profile_filter);return Promise.resolve()}}})}else{_filterTeam(new_query,filter_container_id,scroller_id);return Promise.resolve()}},getTeamFilter:function(){return _query_for_match},selectMatch:function(filter_container_id){var $div=$(filter_container_id);var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item");var $active_items=$list_items.filter(".active");if($active_items.length==1){var $active_item=$active_items.first();var member_id=$active_item.data("member-id");if(member_id){TS.ims.startImByMemberId(member_id);TS.menu.end()}}},clearFilter:function(filter_container_id,scroller_id){var args=_getFilterArgumentsByScrollerId(scroller_id);var $div=$(filter_container_id);var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item");_query_for_match="";TS.storage.storeFilterState(_query_for_match);if(TS.members.view.filter_timer){window.clearTimeout(TS.members.view.filter_timer);TS.members.view.filter_timer=null}$input.val("");$icon_close.addClass("hidden");if(TS.boot_data.feature_roster_changes){if(scroller_id=="#team_list_scroller"){TS.members.view.filterTeam(_query_for_match,filter_container_id,scroller_id,args.full_profile_filter)}}else{if(TS.boot_data.page_needs_enterprise&&args&&args.is_long_list_view){if(scroller_id=="#team_list_scroller"){TS.members.view.filterTeam(_query_for_match,filter_container_id,scroller_id,args.full_profile_filter)}}else{$(".restricted_header, .bot_header, .ra_invite_prompt, .restricted_info").removeClass("hidden");$list_items_container.find(".no_results").addClass("hidden");$list_items.addClass("active");if(_lazy_clones[scroller_id]){_lazy_clones[scroller_id].detachEvents();delete _lazy_clones[scroller_id]}$list_items_container.find(".member_item.clone").remove();$list_items_container.find(".filter_header").remove();TS.members.view.team_filter_changed_sig.dispatch("",TS.members.getMembersForUser().length);if(TS.client&&scroller_id){var $scroller=$(scroller_id);$scroller.trigger("resize-immediate");TS.ui.utility.updateClosestMonkeyScroller($scroller)}}}},onTeamDirectoryItemClick:function(e){if($(e.target).closest("a").length)return;var $item=$(this);var member_id=$item.data("member-id");if(!(TS.viewmodel&&TS.viewmodel.teamdirectory)){var member=TS.members.getMemberById(member_id);if(!member)return}if(TS.client)TS.client.ui.previewMember(member_id)},findMatchesInMemberList:function(members,query,include_profile_fields){return _findMatchesInMemberList(members,query,include_profile_fields)},getHeaderLabelForMatchKey:function(key){return _getHeaderLabelForMatchKey(key)}});var _query_for_match="";var _lazy_clones={};var _label_map={};var _arguments_map={};var _filters={members:{},restricted:{},deleted:{}};var _FILTER_API_COUNT=100;var _APPROXIMATE_ITEM_HEIGHT=TS.client?92:116;var _storeFilterArgumentsByScrollerId=function(scroller_id,full_profile_filter,is_long_list_view,include_org,include_bots,include_deleted){_arguments_map[scroller_id]={full_profile_filter:!!full_profile_filter,is_long_list_view:!!is_long_list_view,include_org:!!include_org,include_bots:!!include_bots,include_deleted:!!include_deleted}};var _getFilterArgumentsByScrollerId=function(scroller_id){var args=_arguments_map[scroller_id];if(args)return args;TS.error("Missing arguments for a bound filter")};var _updateTabCounts=function(){if(TS.boot_data.feature_searchable_member_list)return;var members_count=_filters.members.filter_num_found-_filters.filtered_items.bots.length;var restricted_count=_filters.restricted.filter_num_found||0;var deleted_count=_filters.deleted.filter_num_found||0;var $restricted_members_tab=$("#restricted_members_tab");if(0===restricted_count){$restricted_members_tab.addClass("hidden")}else{$restricted_members_tab.removeClass("hidden")}var $disabled_members_tab=$("#disabled_members_tab");if(0===deleted_count){$disabled_members_tab.addClass("hidden")}else{$disabled_members_tab.removeClass("hidden")}$("#disabled_members_count_value").text(deleted_count);$("#restricted_members_count_value").text(restricted_count);$("#active_members_count_value").text(Math.max(0,members_count-restricted_count))};var _startSpinner=function(filter_container_id){var $icon=$(filter_container_id).find(".ts_icon_search");if($icon.next().is(filter_container_id+"_spinner"))return;var spinner='<svg id="'+filter_container_id.substring(1)+'_spinner" class="ts_icon ts_icon_spin ts_icon_spinner"><use xlink:href="/img/starburst.svg#starburst_svg"/></svg>';$icon.after(spinner);$icon.addClass("hidden")};var _stopSpinner=function(filter_container_id){$(filter_container_id).find(".ts_icon_search").removeClass("hidden");$(filter_container_id+"_spinner").remove()};var _cleanUpPromiseToFilterTeam=function(scroller_id){if(_filters.filter_p)_filters.filter_p.cancel();if(_filters.filtered_items)_filters.filtered_items={};_filters.filter_last_query=null;_filters.filter_last_include_org=null;_filters.members.filter_cursor_mark="";_filters.members.filter_num_remaining=0;_filters.members.filter_num_found=0;_filters.members.filter_scroll_mark=0;_filters.restricted.filter_cursor_mark="";_filters.restricted.filter_num_remaining=0;_filters.restricted.filter_num_found=0;_filters.restricted.filter_scroll_mark=0;_filters.deleted.filter_cursor_mark="";_filters.deleted.filter_num_remaining=0;_filters.deleted.filter_num_found=0;_filters.deleted.filter_scroll_mark=0;if(TS.client){$(scroller_id).off("scroll.filter").scrollTop(0)}else if(TS.web){$("#active_members_list").off("scroll.filter").scrollTop(0);$("#restricted_members_list").off("scroll.filter").scrollTop(0);$("#deleted_members_list").off("scroll.filter").scrollTop(0)}};var _promiseToFilterTeam=function(raw_query,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted){var query_for_display=raw_query.trim();_query_for_match=query_for_display.toLocaleLowerCase();TS.storage.storeFilterState(_query_for_match);var new_query=_filters.filter_last_query!==_query_for_match||_filters.filter_last_include_org!==include_org;if(new_query){_cleanUpPromiseToFilterTeam(scroller_id);_filters.filter_last_query=_query_for_match;_filters.filter_last_include_org=include_org}_startSpinner(filter_container_id);var promiseToFilter=function(){return Promise.resolve().then(function(){if(scroller_id!=="#team_list_scroller")return Promise.reject();if(TS.lazyLoadMembersAndBots()&&TS.boot_data.feature_searchable_member_list){var current_filter=TS.client.ui.searchable_member_list.getCurrentFilter();return TS.members.promiseToSearchMembers({query:_query_for_match,include_org:true,full_profile_filter:full_profile_filter,include_bots:include_bots,include_deleted:current_filter=="disabled_members"})}return _promiseToSearchAndCombineResults(_filters,new_query,_query_for_match,full_profile_filter,include_org,include_bots,include_deleted)}).then(function(response){var items=TS.lazyLoadMembersAndBots()&&TS.boot_data.feature_searchable_member_list?response.items:response;_displayPromiseToSearchResults(items,_filters,new_query,_query_for_match,query_for_display,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted);_stopSpinner(filter_container_id)}).finally(function(){TS.utility.rAF(function(){if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($(scroller_id))})})};if(new_query){_filters.filter_p=promiseToFilter()}else{_filters.filter_p=_filters.filter_p.then(promiseToFilter)}return _filters.filter_p};var _promiseToSearchAndCombineResults=function(filters,new_query,query_for_match,full_profile_filter,include_org,include_bots,include_deleted){var need_more_m=new_query||TS.model.ui_state.tab_name=="active_members"&&filters.members.filter_num_remaining;var need_more_r=new_query||TS.model.ui_state.tab_name=="restricted_members"&&filters.restricted.filter_num_remaining;var need_more_d=new_query||TS.model.ui_state.tab_name=="disabled_members"&&filters.members.filter_num_remaining;if(!need_more_m&&!need_more_r&&!need_more_d){_updateTabCounts();return Promise.resolve(filters.filtered_items)}filters.members.filter_p=need_more_m?_promiseToSearch(filters.members,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,false):Promise.resolve([]);filters.restricted.filter_p=need_more_r?_promiseToSearch(filters.restricted,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,true):Promise.resolve([]);var include_only_deleted=2;filters.deleted.filter_p=need_more_d?_promiseToSearch(filters.deleted,query_for_match,full_profile_filter,include_org,include_bots,include_only_deleted,false):Promise.resolve([]);return Promise.join(filters.members.filter_p,filters.restricted.filter_p,filters.deleted.filter_p,function(members,restricted,deleted){var matches=TS.members.allocateTeamListMembers(members.concat(restricted,deleted));matches.members=_.uniqBy(matches.members,function(member){return member.id});matches.disabled_members=_.uniqBy(matches.disabled_members,function(member){return member.id});matches.restricted_members=_.uniqBy(matches.restricted_members,function(member){return member.id});matches.ultra_restricted_members=_.uniqBy(matches.ultra_restricted_members,function(member){return member.id});if(new_query){filters.filtered_items=matches}else{filters.filtered_items.members.push.apply(filters.filtered_items.members,matches.members);filters.filtered_items.disabled_members.push.apply(filters.filtered_items.disabled_members,matches.disabled_members);filters.filtered_items.deleted_bots.push.apply(filters.filtered_items.deleted_bots,matches.deleted_bots);filters.filtered_items.bots.push.apply(filters.filtered_items.bots,matches.bots);filters.filtered_items.restricted_members.push.apply(filters.filtered_items.restricted_members,matches.restricted_members);filters.filtered_items.ultra_restricted_members.push.apply(filters.filtered_items.ultra_restricted_members,matches.ultra_restricted_members)}return Promise.resolve(filters.filtered_items)})};var _displayPromiseToSearchResults=function(items,filters,new_query,query_for_match,query_for_display,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted){if(!items)return;_updateTabCounts();if(!TS.boot_data.feature_searchable_member_list||!TS.lazyLoadMembersAndBots()){var team_list_items;if(TS.client){team_list_items=TS.view.buildLongListTeamListItems(items,!!query_for_match)}else{team_list_items=TS.web.members.buildLongListTeamListItems(items,!!query_for_match)}}if(TS.boot_data.feature_searchable_member_list){var current_filter=TS.client.ui.searchable_member_list.getCurrentFilter();if(!TS.lazyLoadMembersAndBots()){var filtered_members=team_list_items[current_filter+"_list_items"];if(current_filter==="disabled_members")filtered_members=team_list_items.deleted_members_list_items}else{var filtered_members=items}if(filtered_members.length>0){TS.client.ui.searchable_member_list.getLongListView().longListView("setItems",filtered_members,true)}else{TS.client.ui.searchable_member_list.resetInitialState()}return}var need_to_reset_current_subtab=false;if("disabled_members"===TS.model.ui_state.tab_name&&0===(_filters.deleted.filter_num_found||0))need_to_reset_current_subtab=true;if("restricted_members"===TS.model.ui_state.tab_name&&0===(_filters.restricted.filter_num_found||0))need_to_reset_current_subtab=true;var user_groups=TS.model.user_groups.filter(function(ug){return!ug.date_delete});if("user_groups"===TS.model.ui_state.tab_name&&0===user_groups.length)need_to_reset_current_subtab=true;if(need_to_reset_current_subtab){TS.model.ui_state.tab_name="active_members";TS.storage.storeUIState(TS.model.ui_state);$("#active_members_tab").trigger("click")}var $active_members_list=$("#active_members_list");if($active_members_list.length){$active_members_list.longListView("setItems",team_list_items.active_members_list_items);if(new_query)$active_members_list.longListView("scrollToTop")}var $restricted_members_list=$("#restricted_members_list");if($restricted_members_list.length){$restricted_members_list.longListView("setItems",team_list_items.restricted_members_list_items);if(new_query)$restricted_members_list.longListView("scrollToTop")}var $deleted_members_list=$("#deleted_members_list");if($deleted_members_list.length){$deleted_members_list.longListView("setItems",team_list_items.deleted_members_list_items);if(new_query)$deleted_members_list.longListView("scrollToTop")}var active_matches=items.members.concat(items.bots);var restricted_matches=items.restricted_members.concat(items.ultra_restricted_members);var disabled_matches=items.disabled_members.concat(items.deleted_bots);var tabs=[{name:"active",label:"full team members",matches:active_matches},{name:"restricted",label:TS.templates.builders.raLabel("restricted accounts"),matches:restricted_matches},{name:"disabled",label:"deactivated accounts",matches:disabled_matches}];tabs.forEach(function(tab){var $no_results=$("#"+tab.name+"_no_results");function noMatchesCase(){var template_args={query:query_for_display,tab:tab,active_matches:active_matches,show_active_matches:tab.name!="active"&&active_matches.length>0,restricted_matches:restricted_matches,show_restricted_matches:tab.name!="restricted"&&restricted_matches.length>0,disabled_matches:disabled_matches,show_disabled_matches:tab.name!="disabled"&&disabled_matches.length>0};var html=TS.templates.team_list_no_results(template_args);$no_results.removeClass("hidden").html(html);$no_results.find(".clear_members_filter").one("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id)})}if(tab.matches.length>0||!query_for_match){$no_results.addClass("hidden").empty()}else{noMatchesCase()}});if(new_query){if(scroller_id==="#team_list_scroller"){if(TS.client){var $scrollable=$(scroller_id);var $list=$scrollable.find("#team_list_members_wrapper");$scrollable.on("scroll.filter",function(e){var maybe_scroll_mark=$scrollable.scrollTop()+$scrollable.height()+_APPROXIMATE_ITEM_HEIGHT;var list_items_height;if(TS.model.ui_state.tab_name=="active_members"){if(maybe_scroll_mark<=filters.members.filter_scroll_mark)return;list_items_height=$list.height();if(maybe_scroll_mark>list_items_height&&filters.members.filter_p&&filters.members.filter_p.isResolved()){_promiseToFilterTeam(query_for_match,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted);filters.members.filter_scroll_mark=maybe_scroll_mark}}if(TS.model.ui_state.tab_name=="restricted_members"){if(maybe_scroll_mark<=filters.restricted.filter_scroll_mark)return;list_items_height=$list.height();if(maybe_scroll_mark>list_items_height&&filters.restricted.filter_p&&filters.restricted.filter_p.isResolved()){_promiseToFilterTeam(query_for_match,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted);filters.restricted.filter_scroll_mark=maybe_scroll_mark}}})}else if(TS.web){var scroll=function($el,filter){if(!$el.length)return;$el.on("scroll.filter",function(e){var maybe_scroll_mark=$el.scrollTop()+$el.height()+_APPROXIMATE_ITEM_HEIGHT;var list_items_height;if(maybe_scroll_mark<=filters.members.filter_scroll_mark)return;list_items_height=$el.find(".list_items").height();if(maybe_scroll_mark>list_items_height&&filters.members.filter_p&&filters.members.filter_p.isResolved()){_promiseToFilterTeam(query_for_match,filter_container_id,scroller_id,full_profile_filter,include_org,include_bots,include_deleted);filters.members.filter_scroll_mark=maybe_scroll_mark}})};scroll($("#active_members_list"),filters.members);scroll($("#restricted_members_list"),filters.restricted);scroll($("#deleted_members_list"),filters.deleted)}}var count_for_query=(filters.members.filter_num_found||0)+(filters.restricted.filter_num_found||0)+(filters.deleted.filter_num_found||0);TS.members.view.team_filter_changed_sig.dispatch(query_for_display,count_for_query)}};var _buildPromiseToSearchArguments=function(filter,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,restricted){var matchers=[];if(query_for_match){matchers=query_for_match.split(/\s*,\s*|\s+/).map(function(q){return q.charAt("0")==="@"?q.substring(1):q}).filter(function(q){return!!q}).map(function(query){if(query.length===1||!full_profile_filter){if(TS.boot_data.feature_name_tagging_client){var is_full_name_match=TS.utility.search.makeClause("full_name",query);var is_preferred_name_match=TS.utility.search.makeClause("preferred_name",query);var is_full_name_or_preferred_name_match=TS.utility.search.makeConjunction("OR",[is_full_name_match,is_preferred_name_match]);return is_full_name_or_preferred_name_match}else{var is_name_match=TS.utility.search.makeClause("name",query);var is_real_name_match=TS.utility.search.makeClause("real_name",query);var is_name_or_real_name_match=TS.utility.search.makeConjunction("OR",[is_name_match,is_real_name_match]);return is_name_or_real_name_match}}else{return TS.utility.search.makeClause("fuzzy",query)}})}matchers.push(TS.utility.search.makeClause("is","user"));if(restricted){var restricted_matcher=TS.utility.search.makeClause("level","restricted");var ultra_restricted_matcher=TS.utility.search.makeClause("level","ultra_restricted");matchers.push(TS.utility.search.makeConjunction("OR",[restricted_matcher,ultra_restricted_matcher]))}var query=matchers.length>1?TS.utility.search.makeConjunction("AND",matchers):matchers[0];var calling_args={query:query,count:_FILTER_API_COUNT,include_bots:include_bots,include_deleted:include_deleted};if(include_org)calling_args.all_of_org=include_org;if(filter.filter_cursor_mark)calling_args.cursor_mark=filter.filter_cursor_mark;return calling_args};var _promiseToSearch=function(filter,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,restricted){var calling_args=_buildPromiseToSearchArguments(filter,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,restricted);if(TS.lazyLoadMembersAndBots()){calling_args.raw_query=query_for_match}return TS.utility.search.promiseToSearch(calling_args).then(function(response){if(!filter.filter_num_remaining){filter.filter_num_remaining=response.data.num_found;filter.filter_num_found=response.data.num_found}filter.filter_num_remaining-=response.data.items.length;filter.filter_cursor_mark=response.data.next_cursor_mark;if(!response.data.items.length)return Promise.resolve([]);var matches=response.data.items.map(function(member){var full_member=TS.members.getMemberById(member.id);if(!full_member){if(include_org&&member.team_id!==TS.model.team.id){member.is_primary_owner=false;member.is_owner=false;member.is_admin=false}full_member=TS.members.upsertMember(member).member}return full_member});if(!restricted){matches=matches.filter(function(member){return!member.is_restricted})}if(matches.length)return Promise.resolve(matches);if(filter.filter_num_remaining)return _promiseToSearch(filter,query_for_match,full_profile_filter,include_org,include_bots,include_deleted,restricted);return Promise.resolve([])})};var _filterTeam=function(new_query,filter_container_id,scroller_id,full_profile_filter){var $div=$(filter_container_id);var query_for_display=new_query.trim();_query_for_match=query_for_display.toLocaleLowerCase();var list_items_id=$div.data("list-items-id");var $list_items_container=$(list_items_id);var $list_items=$list_items_container.find(".member_item:not(.clone)");var $list_items_active=$list_items.filter(".active");var $list_items_cloned=$list_items_container.find(".member_item.clone");var $list_items_cloned_header=$list_items_container.find(".filter_header");var lazy_load=!TS.web&&filter_container_id==="#team_filter";var node_hash={};var $parent_node;var $last_focused_node;var matches;TS.storage.storeFilterState(_query_for_match);var can_use_fast_detach=false;var $display_toggle_element;if(_is_web_admin_page&&filter_container_id==="#team_filter"){$display_toggle_element=$list_items_container.find(".tab_pane.selected")}if(!$display_toggle_element&&!TS.web&&filter_container_id==="#team_filter"){$display_toggle_element=$("#team_list_members")}if($display_toggle_element&&$display_toggle_element.length){$display_toggle_element.addClass("hidden")}if(can_use_fast_detach){$parent_node=$list_items.parent();$last_focused_node=document.activeElement?$(document.activeElement):null;$list_items.detach()}if(_lazy_clones[scroller_id]){_lazy_clones[scroller_id].detachEvents();delete _lazy_clones[scroller_id]}$list_items_cloned.remove();$list_items_cloned_header.remove();$list_items_active.removeClass("active");$list_items_container.find(".no_results").addClass("hidden");if(can_use_fast_detach){$parent_node.append($list_items);if($last_focused_node){$last_focused_node.focus()}}var tabs;if(_is_web_admin_page&&TS.web.admin.view=="invites"){var all_matches=[];var pending_matches=[];var accepted_matches=[];$.each($list_items,function(i,item){var id;item=$(item);id=item.data("invite-id");node_hash[id]=item});pending_matches=_findMatchesInMemberList(TS.web.admin.pending_invites,_query_for_match).name||[];accepted_matches=_findMatchesInMemberList(TS.web.admin.accepted_invites,_query_for_match).name||[];all_matches=pending_matches.concat(accepted_matches);if(all_matches.length>0){$.each(all_matches,function(i,invite){if(invite&&invite.member&&invite.member.id&&node_hash[invite.member.id]){node_hash[invite.member.id].addClass("active")}});if(scroller_id)$(scroller_id).trigger("resize")}tabs=[{name:"pending",label:"pending invitations",matches:pending_matches},{name:"accepted",label:"accepted invitations",matches:accepted_matches}];tabs.forEach(function(tab){var $no_results=$("#"+tab.name+"_no_results");if(tab.matches.length>0){$no_results.addClass("hidden").empty();return}else{var template_args={query:query_for_display,tab:tab,pending_matches:pending_matches,show_pending_matches:tab.name!="pending"&&pending_matches.length>0,accepted_matches:accepted_matches,show_accepted_matches:tab.name!="accepted"&&accepted_matches.length>0};var html=TS.templates.team_list_no_results(template_args);$no_results.removeClass("hidden").html(html);$no_results.find(".clear_members_filter").on("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id)})}});matches=all_matches}else{var all_members;var active_matches=[];var restricted_matches=[];var disabled_matches=[];if(_is_web_admin_page){if(!new_query.length){all_members=TS.web.admin.getMembersForUser()}else{all_members=TS.members.getMembersForUser()}}else{all_members=TS.members.getMembersForUser()}$(".restricted_header, .bot_header, .ra_invite_prompt, .restricted_info").toggleClass("hidden",!!_query_for_match);$.each($list_items,function(i,item){var id;item=$(item);id=item.data("member-id");node_hash[id]=item});var all_matches=_findMatchesInMemberList(all_members,_query_for_match,full_profile_filter);var keys=Object.keys(all_matches);if(keys.length>0){_displayMatches(all_matches,keys,node_hash,disabled_matches,restricted_matches,active_matches,lazy_load?scroller_id:"");if(scroller_id){var $scroller=$(scroller_id);$scroller.trigger("resize");TS.ui.utility.updateClosestMonkeyScroller($scroller)}}else if(filter_container_id=="#file_member_filter"){$list_items_container.find(".query").text(query_for_display);$list_items_container.find(".no_results").removeClass("hidden")}if(filter_container_id=="#team_filter"){tabs=[{name:"active",label:"full team members",matches:active_matches},{name:"restricted",label:TS.templates.builders.raLabel("restricted accounts"),matches:restricted_matches},{name:"disabled",label:"deactivated accounts",matches:disabled_matches}];tabs.forEach(function(tab){var $no_results=$("#"+tab.name+"_no_results");function noMatchesCase(){var template_args={query:query_for_display,tab:tab,active_matches:active_matches,show_active_matches:tab.name!="active"&&active_matches.length>0,restricted_matches:restricted_matches,show_restricted_matches:tab.name!="restricted"&&restricted_matches.length>0,disabled_matches:disabled_matches,show_disabled_matches:TS.web&&tab.name!="disabled"&&disabled_matches.length>0};var html=TS.templates.team_list_no_results(template_args);$no_results.removeClass("hidden").html(html);$no_results.find(".clear_members_filter").on("click",function(){TS.members.view.clearFilter(filter_container_id,scroller_id)})}if(tab.matches.length>0){$no_results.addClass("hidden").empty();return}else{noMatchesCase()}})}matches=active_matches.concat(restricted_matches,disabled_matches)}if($display_toggle_element&&$display_toggle_element.length){$display_toggle_element.removeClass("hidden")}TS.ui.utility.updateClosestMonkeyScroller($(scroller_id));TS.members.view.team_filter_changed_sig.dispatch(query_for_display,matches.length)};var _getHeaderLabelForMatchKey=function(key){return _label_map[key]||key};var _getFilterHeader=function(label,values){var header=document.createElement("div");var header_label=document.createElement("strong");header.classList.add("filter_header");header_label.appendChild(document.createTextNode(label));if(values.length)header_label.appendChild(document.createTextNode(": "));header.appendChild(header_label);values.forEach(function(value,index){header.appendChild(value);if(index<values.length-1)header.appendChild(document.createTextNode(", "))});return header};var _getHighlightedValue=function(value,match){var highlighted_value=document.createElement("span");var strong_value=document.createElement("strong");var parts=value.split(match);strong_value.appendChild(document.createTextNode(match));highlighted_value.appendChild(document.createTextNode(parts.shift()));highlighted_value.appendChild(strong_value);highlighted_value.appendChild(document.createTextNode(parts.join(match)));return highlighted_value};var _displayMatches=function(matches,keys,node_hash,disabled_matches,restricted_matches,active_matches,lazy_id){var $lazy=$(lazy_id);var parent_disabled_fragment=document.createDocumentFragment();var parent_restricted_fragment=document.createDocumentFragment();var parent_active_fragment=document.createDocumentFragment();var $disabled_parent;var $restricted_parent;var $active_parent;var is_admin_subset_case=_is_web_admin_page&&TS.web.admin.isSubsetCase();keys.sort(function(keyA,keyB){return _label_map[keyA].localeCompare(_label_map[keyB])}).forEach(function(key){var disabled_fragment=document.createDocumentFragment();var restricted_fragment=document.createDocumentFragment();var active_fragment=document.createDocumentFragment();var disabled_matches_values=[];var restricted_matches_values=[];var active_matches_values=[];var disabled_matches_value_map={};var restricted_matches_value_map={};var active_matches_value_map={};if(is_admin_subset_case){if(!$active_parent){$active_parent=$("#active_members > div:first-of-type");$restricted_parent=$("#restricted_members > div:first-of-type");$disabled_parent=$("#disabled_members > div:first-of-type")}}matches[key].forEach(function(match){var member=match.member;var node;var node_created=false;if(member&&member.id){node=node_hash[member.id];if(!node&&is_admin_subset_case){node=$(TS.web.admin.buildMemberHTML(member,false,false));node_created=true}if(node){if(key==="name"&&!node_created){node.addClass("active")}else{if(member.deleted){if(!$disabled_parent)$disabled_parent=node.parent();if(match.value&&!disabled_matches_value_map[match.value])disabled_matches_value_map[match.value]=disabled_matches_values.push(_getHighlightedValue(match.value,match.match));disabled_fragment.appendChild(node.clone().addClass("active clone").get(0))}else if(member.is_restricted){if(!$restricted_parent)$restricted_parent=node.parent();if(match.value&&!restricted_matches_value_map[match.value])restricted_matches_value_map[match.value]=restricted_matches_values.push(_getHighlightedValue(match.value,match.match));restricted_fragment.appendChild(node.clone().addClass("active clone").get(0))}else{if(!$active_parent)$active_parent=node.parent();if(match.value&&!active_matches_value_map[match.value])active_matches_value_map[match.value]=active_matches_values.push(_getHighlightedValue(match.value,match.match));active_fragment.appendChild(node.clone().addClass("active clone").get(0))}}}if(member.deleted){disabled_matches.push(member)}else if(member.is_restricted){restricted_matches.push(member)}else{active_matches.push(member)}}});if(disabled_fragment.childNodes&&disabled_fragment.childNodes.length){parent_disabled_fragment.appendChild(_getFilterHeader(_getHeaderLabelForMatchKey(key),disabled_matches_values));
parent_disabled_fragment.appendChild(disabled_fragment)}if(restricted_fragment.childNodes&&restricted_fragment.childNodes.length){parent_restricted_fragment.appendChild(_getFilterHeader(_getHeaderLabelForMatchKey(key),restricted_matches_values));parent_restricted_fragment.appendChild(restricted_fragment)}if(active_fragment.childNodes&&active_fragment.childNodes.length){parent_active_fragment.appendChild(_getFilterHeader(_getHeaderLabelForMatchKey(key),active_matches_values));parent_active_fragment.appendChild(active_fragment)}disabled_fragment=null;restricted_fragment=null;active_fragment=null;disabled_matches_values=null;restricted_matches_values=null;active_matches_values=null;disabled_matches_value_map=null;restricted_matches_value_map=null;active_matches_value_map=null});if($disabled_parent)$disabled_parent.append(parent_disabled_fragment);if($restricted_parent)$restricted_parent.append(parent_restricted_fragment);if($active_parent)$active_parent.append(parent_active_fragment);if($lazy.length){var $clones=$lazy.find(".member_item.clone");_lazy_clones[lazy_id]=$clones.find(".lazy").lazyload({container:$lazy,ignore_when_hidden_element:$lazy,all_images_same_size:true});$clones.one("remove",function(){if(_lazy_clones[lazy_id]){_lazy_clones[lazy_id].detachEvents();delete _lazy_clones[lazy_id]}})}if(is_admin_subset_case){if(TS.web.admin.lazyload&&TS.web.admin.lazyload.detachEvents){TS.web.admin.lazyload.detachEvents();TS.web.admin.lazyload=null}if(!TS.web.admin.lazyload){TS.web.admin.lazyload=$("#admin_list").find(".lazy").lazyload()}}parent_disabled_fragment=null;parent_restricted_fragment=null;parent_active_fragment=null;$disabled_parent=null;$restricted_parent=null;$active_parent=null};var _is_web_admin_page;var _findMatchesInMemberList=function(members,query,include_profile_fields){var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");var matches={};var team_fields=include_profile_fields&&query?TS.team.getVisibleTeamProfileFields():[];_label_map={title:"What I Do",name:"Name"};members.forEach(function(member){if(TS.boot_data.feature_name_tagging_client){var match=member._full_name_lc&&(member._full_name_lc.match(start_regex)||member._full_name_lc.match(suffix_regex))||member.email&&(member.email.match(start_regex)||member.email.match(suffix_regex))||member.profile&&member.profile.email&&(member.profile.email.match(start_regex)||member.profile.email.match(suffix_regex))||member.profile&&member.profile.full_name_normalized&&(member.profile.full_name_normalized.match(start_regex)||member.profile.full_name_normalized.match(suffix_regex))||member.profile&&member.profile.full_name&&(member.profile.full_name.match(start_regex)||member.profile.full_name.match(suffix_regex))||member.profile&&member.profile.preferred_name_normalized&&(member.profile.preferred_name_normalized.match(start_regex)||member.profile.preferred_name_normalized.match(suffix_regex))||member.profile&&member.profile.preferred_name&&(member.profile.preferred_name.match(start_regex)||member.profile.preferred_name.match(suffix_regex))}else{var match=member.name&&(member.name.match(start_regex)||member.name.match(suffix_regex))||member.first_name&&(member.first_name.match(start_regex)||member.first_name.match(suffix_regex))||member.last_name&&(member.last_name.match(start_regex)||member.last_name.match(suffix_regex))||member._real_name_lc&&(member._real_name_lc.match(start_regex)||member._real_name_lc.match(suffix_regex))||member.email&&(member.email.match(start_regex)||member.email.match(suffix_regex))||member.profile&&member.profile.email&&(member.profile.email.match(start_regex)||member.profile.email.match(suffix_regex))||member.profile&&member.profile.real_name_normalized&&(member.profile.real_name_normalized.match(start_regex)||member.profile.real_name_normalized.match(suffix_regex))||member.profile&&member.profile.real_name&&(member.profile.real_name.match(start_regex)||member.profile.real_name.match(suffix_regex))}if(match){if(!matches["name"])matches["name"]=[];matches["name"].push({member:member})}if(include_profile_fields&&query){match=member.profile&&member.profile.title&&(member.profile.title.match(start_regex)||member.profile.title.match(suffix_regex));if(match){if(!matches["title"])matches["title"]=[];matches["title"].push({member:member})}}if(team_fields.length&&member.profile&&member.profile.fields){team_fields.forEach(function(team_field){var field=member.profile.fields[team_field.id];if(!field)return;match=null;if(team_field.type==="user"){if(field.value){var value="";field.value.split(/\s*\,\s*/).some(function(id){value=TS.members.getMemberDisplayNameById(id,false);match=value.match(start_regex)||value.match(suffix_regex);if(match)return true});if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:value,match:match[0]})}}}else{match=field.value&&(field.value.match(start_regex)||field.value.match(suffix_regex));if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:field.value,match:match[0]})}else{match=field.alt&&(field.alt.match(start_regex)||field.alt.match(suffix_regex));if(match){if(!matches[team_field.id])matches[team_field.id]=[];matches[team_field.id].push({member:member,value:field.alt,match:match[0]})}}}if(match&&!_label_map[team_field.id])_label_map[team_field.id]=team_field.label})}});return matches}})();(function(){"use strict";TS.registerModule("prefs",{highlight_words_changed_sig:new signals.Signal,seen_welcome_2_changed_sig:new signals.Signal,emoji_mode_changed_sig:new signals.Signal,obey_inline_img_limit_changed_sig:new signals.Signal,messages_theme_changed_sig:new signals.Signal,expand_inline_imgs_changed_sig:new signals.Signal,expand_internal_inline_imgs_changed_sig:new signals.Signal,expand_non_media_attachments_changed_sig:new signals.Signal,webapp_spellcheck_changed_sig:new signals.Signal,color_names_in_list_changed_sig:new signals.Signal,search_only_my_channels_changed_sig:new signals.Signal,search_exclude_channels_changed_sig:new signals.Signal,search_exclude_bots_changed_sig:new signals.Signal,search_only_current_team_changed_sig:new signals.Signal,box_enabled_changed_sig:new signals.Signal,dropbox_enabled_changed_sig:new signals.Signal,read_changed_sig:new signals.Signal,push_changed_sig:new signals.Signal,time24_changed_sig:new signals.Signal,sidebar_behavior_changed_sig:new signals.Signal,dtop_notif_changed_sig:new signals.Signal,muted_channels_changed_sig:new signals.Signal,mac_speak_changed_sig:new signals.Signal,mac_ssb_bullet_changed_sig:new signals.Signal,team_hide_referers_changed_sig:new signals.Signal,team_require_at_for_mention_changed_sig:new signals.Signal,sidebar_theme_changed_sig:new signals.Signal,no_invites_widget_in_sidebar_changed_sig:new signals.Signal,no_omnibox_in_channels_changed_sig:new signals.Signal,k_key_omnibox_auto_hide_count_changed_sig:new signals.Signal,display_preferred_names_changed_sig:new signals.Signal,display_real_names_override_changed_sig:new signals.Signal,team_display_real_names_changed_sig:new signals.Signal,team_perms_pref_changed_sig:new signals.Signal,privacy_policy_seen_changed_sig:new signals.Signal,two_factor_update_seen_changed_sig:new signals.Signal,compliance_export_start_changed_sig:new signals.Signal,team_disallow_public_file_urls_changed_sig:new signals.Signal,msg_preview_changed_sig:new signals.Signal,mentions_exclude_at_channels_changed_sig:new signals.Signal,mentions_exclude_at_user_groups_changed_sig:new signals.Signal,team_auth_mode_changed_sig:new signals.Signal,team_sso_auth_restrictions_changed_sig:new signals.Signal,team_posts_migrating_changed_sig:new signals.Signal,preferred_skin_tone_changed_sig:new signals.Signal,msg_replies_changed_sig:new signals.Signal,separate_private_channels_changed_sig:new signals.Signal,whats_new_read_changed_sig:new signals.Signal,team_dnd_enabled_changed_sig:new signals.Signal,team_dnd_start_hour_changed_sig:new signals.Signal,team_dnd_end_hour_changed_sig:new signals.Signal,team_invites_only_admins_changed_sig:new signals.Signal,tz_changed_sig:new signals.Signal,team_allow_calls_changed_sig:new signals.Signal,team_calling_app_name_changed_sig:new signals.Signal,team_calling_app_id_changed_sig:new signals.Signal,team_handy_rxns_changed_sig:new signals.Signal,channel_handy_rxns_changed_sig:new signals.Signal,hotness_changed_sig:new signals.Signal,frecency_jumper_changed_sig:new signals.Signal,jumbomoji_changed_sig:new signals.Signal,attachments_with_borders_changed_sig:new signals.Signal,channel_sort_changed_sig:new signals.Signal,show_memory_instrument_changed_sig:new signals.Signal,enable_unread_view_changed_sig:new signals.Signal,measure_css_usage_changed_sig:new signals.Signal,team_disable_file_editing_changed_sig:new signals.Signal,team_disable_file_deleting_changed_sig:new signals.Signal,team_display_email_addresses_changed_sig:new signals.Signal,all_unreads_sort_order_changed_sig:new signals.Signal,a11y_font_size_changed_sig:new signals.Signal,a11y_animations_changed_sig:new signals.Signal,onStart:function(){if(TS.client)TS.client.login_sig.add(TS.prefs.onLogin,TS.prefs)},onLogin:function(ok,data){if(!TS.boot_data.feature_server_side_emoji_counts){setInterval(_maybeSaveEmojiUse,1e3*60*10);TS.ui.window_unloaded_sig.add(_maybeSaveEmojiUse)}},setPrefs:function(prefs){TS.model.prefs=prefs;TS.prefs.mergeEmojiUse(TS.model.prefs.emoji_use);TS.prefs.mergeFrecencyJumper(TS.ui.frecency.isEnterprise()?TS.model.prefs.frecency_ent_jumper:TS.model.prefs.frecency_jumper);TS.prefs.setUserColors(TS.model.prefs.user_colors);TS.prefs.setLoudChannels(TS.model.prefs.loud_channels);TS.prefs.setSuppressedChannels(TS.model.prefs.at_channel_suppressed_channels);TS.prefs.setPushSuppressedChannels(TS.model.prefs.push_at_channel_suppressed_channels);TS.prefs.setNeverChannels(TS.model.prefs.never_channels);TS.prefs.setMutedChannels(TS.model.prefs.muted_channels);TS.prefs.setLoudChannelsSet(TS.model.prefs.loud_channels_set);TS.prefs.setPushLoudChannels(TS.model.prefs.push_loud_channels);TS.prefs.setPushMentionChannels(TS.model.prefs.push_mention_channels);TS.prefs.setPushLoudChannelsSet(TS.model.prefs.push_loud_channels_set);TS.prefs.setSearchExcludeChannels(TS.model.prefs.search_exclude_channels);TS.prefs.setChannelSort(TS.model.prefs.channel_sort);TS.prefs.setSidebarThemeCustomValues(TS.utility.parseJSONOrElse(TS.model.prefs.sidebar_theme_custom_values,undefined));TS.emoji.setEmojiMode();TS.prefs.setTheme();TS.model.prefs.emoji_autocomplete_big=false;TSSSB.call("runFromTray",!!TS.model.prefs.winssb_run_from_tray);TSSSB.call("windowFlashBehavior",TS.model.prefs.winssb_window_flash_behavior);if(TS.boot_data.feature_name_tagging_client){if(!TS.model.prefs.require_at){TS.model.prefs.require_at=true}if(!TS.model.team.prefs.require_at_for_mention){TS.model.team.prefs.require_at_for_mention=true}}},setChannelSort:function(channel_sort){if(!TS.boot_data.feature_sli_channel_priority)channel_sort=null;var channel_sort_ob=TS.utility.parseJSONOrElse(channel_sort||null)||{is_custom_sorted:false,priority_display:false,priority_type:"",sorts:[]};TS.model.channel_sort=channel_sort_ob},setHighlightWords:function(highlight_words){TS.model.prefs.highlight_words=highlight_words;if(TS.boot_data.feature_name_tagging_client){TS.model.highlight_words=[]}else{TS.model.highlight_words=["@"+TS.model.user.name];if(!TS.model.team.prefs.require_at_for_mention){TS.model.highlight_words.push(TS.model.user.name)}}TS.model.highlight_words.push("<@"+TS.model.user.id);if(highlight_words&&typeof highlight_words=="string"){TS.model.highlight_words=TS.model.highlight_words.concat(highlight_words.split(","))}TS.model.highlight_words_regex=null},setSuppressedChannels:function(at_channel_suppressed_channels){TS.model.prefs.at_channel_suppressed_channels=at_channel_suppressed_channels;TS.model.at_channel_suppressed_channels=[];if(at_channel_suppressed_channels&&typeof at_channel_suppressed_channels=="string"){TS.model.at_channel_suppressed_channels=TS.model.at_channel_suppressed_channels.concat(at_channel_suppressed_channels.split(","))}},setPushSuppressedChannels:function(push_at_channel_suppressed_channels){TS.model.prefs.push_at_channel_suppressed_channels=push_at_channel_suppressed_channels;TS.model.push_at_channel_suppressed_channels=[];if(push_at_channel_suppressed_channels&&typeof push_at_channel_suppressed_channels=="string"){TS.model.push_at_channel_suppressed_channels=TS.model.push_at_channel_suppressed_channels.concat(push_at_channel_suppressed_channels.split(","))}},setLoudChannels:function(loud_channels){TS.model.prefs.loud_channels=loud_channels;TS.model.loud_channels=[];if(loud_channels&&typeof loud_channels=="string"){TS.model.loud_channels=TS.model.loud_channels.concat(loud_channels.split(","))}},setNeverChannels:function(never_channels){TS.model.prefs.never_channels=never_channels;TS.model.never_channels=[];if(never_channels&&typeof never_channels=="string"){TS.model.never_channels=TS.model.never_channels.concat(never_channels.split(","))}},setMutedChannels:function(muted_channels){if(TS.model.prefs.muted_channels!==muted_channels||!_has_set_muted_channels_before){TS.model.prev_muted_channels=TS.model.prefs.muted_channels&&typeof TS.model.prefs.muted_channels=="string"?TS.model.prefs.muted_channels.split(","):[];TS.model.prefs.muted_channels=muted_channels}else{return}_has_set_muted_channels_before=true;var i;var model_ob;TS.model.muted_channels=[];TS.model.newly_muted_channels=[];TS.model.newly_unmuted_channels=[];if(muted_channels&&typeof muted_channels=="string"){TS.model.muted_channels=TS.model.muted_channels.concat(muted_channels.split(","));TS.model.newly_unmuted_channels=_.difference(TS.model.prev_muted_channels,TS.model.muted_channels);TS.model.newly_muted_channels=_.difference(TS.model.muted_channels,TS.model.prev_muted_channels)}for(i=0;i<TS.model.muted_channels.length;i++){model_ob=TS.shared.getModelObById(TS.model.muted_channels[i]);if(!model_ob)continue;if(!model_ob.unread_cnt)continue;model_ob._show_in_list_even_though_no_unreads=true}for(i=0;i<TS.model.channels.length;i++){model_ob=TS.model.channels[i];if(TS.notifs.isCorGMuted(model_ob.id))continue;model_ob._show_in_list_even_though_no_unreads=false}for(i=0;i<TS.model.groups.length;i++){model_ob=TS.model.groups[i];if(TS.notifs.isCorGMuted(model_ob.id))continue;model_ob._show_in_list_even_though_no_unreads=false}},setLoudChannelsSet:function(loud_channels_set){TS.model.prefs.loud_channels_set=loud_channels_set;TS.model.loud_channels_set=[];if(loud_channels_set&&typeof loud_channels_set=="string"){TS.model.loud_channels_set=TS.model.loud_channels_set.concat(loud_channels_set.split(","))}},setPushLoudChannels:function(push_loud_channels){TS.model.prefs.push_loud_channels=push_loud_channels;TS.model.push_loud_channels=[];if(push_loud_channels&&typeof push_loud_channels=="string"){TS.model.push_loud_channels=TS.model.push_loud_channels.concat(push_loud_channels.split(","))}},setPushMentionChannels:function(push_mention_channels){TS.model.prefs.push_mention_channels=push_mention_channels;TS.model.push_mention_channels=[];if(push_mention_channels&&typeof push_mention_channels=="string"){TS.model.push_mention_channels=TS.model.push_mention_channels.concat(push_mention_channels.split(","))}},setPushLoudChannelsSet:function(push_loud_channels_set){TS.model.prefs.push_loud_channels_set=push_loud_channels_set;TS.model.push_loud_channels_set=[];if(push_loud_channels_set&&typeof push_loud_channels_set=="string"){TS.model.push_loud_channels_set=TS.model.push_loud_channels_set.concat(push_loud_channels_set.split(","))}},setSearchExcludeChannels:function(search_exclude_channels){TS.model.prefs.search_exclude_channels=search_exclude_channels;TS.model.search_exclude_channels=[];if(search_exclude_channels&&typeof search_exclude_channels=="string"){TS.model.search_exclude_channels=TS.model.search_exclude_channels.concat(search_exclude_channels.split(","))}},recordEmojiUse:function(str){if(TS.boot_data.feature_server_side_emoji_counts)return;var added=TS.utility.msgs.recordEmojiInHash(str,TS.model.emoji_use);if(!added)return;TS.emoji.maybeRemakeMenuListsIfFrequentsChanged();_emoji_use_dirty_cnt++;if(_emoji_use_dirty_cnt>10){TS.prefs.saveEmojiUse()}else{TS.storage.storeEmojiUse(TS.model.emoji_use)}},saveEmojiUse:function(){if(TS.boot_data.feature_server_side_emoji_counts)return;TS.dir(777,TS.model.emoji_use,"saving emoji_use pref");_emoji_use_dirty_cnt=0;TS.storage.storeEmojiUse(TS.model.emoji_use);TS.prefs.setPrefByAPI({name:"emoji_use",value:JSON.stringify(TS.model.emoji_use)})},mergeFrecencyJumper:function(frecency_jumper){if(!frecency_jumper||typeof frecency_jumper!=="object"){frecency_jumper=TS.utility.parseJSONOrElse(frecency_jumper||null)||{}}TS.model.frecency_jumper=frecency_jumper;return true},mergeEmojiUse:function(emoji_use){if(!emoji_use||typeof emoji_use!=="object"){emoji_use=TS.utility.parseJSONOrElse(emoji_use||null)||{};emoji_use=_.pickBy(emoji_use,function(count,name){return _.includes(TS.model.emoji_names,name)})}var something_changed=false;for(var k in emoji_use){if(!TS.model.emoji_use.hasOwnProperty(k)||emoji_use[k]>TS.model.emoji_use[k]){TS.model.emoji_use[k]=emoji_use[k];something_changed=true}}if(!something_changed){TS.log(777,"mergeEmojiUse TS.model.emoji_use unchanged");return false}TS.dir(777,TS.model.emoji_use,"mergeEmojiUse TS.model.emoji_use set to:");return true},setUserColors:function(user_colors){TS.model.prefs.user_colors=user_colors;var parse=user_colors?JSON.parse(user_colors):{};TS.model.user_colors=parse||{}},setTheme:function(theme){if(TS.model.prefs.messages_theme=="default"){TS.model.prefs.messages_theme="light_with_avatars"}TS.model.prefs.theme="light";TS.model.prefs.avatars=true;if(TS.model.prefs.messages_theme=="dense"){TS.model.prefs.theme="dense";TS.model.prefs.avatars=false}else if(TS.model.prefs.messages_theme=="light"){TS.model.prefs.theme="light";TS.model.prefs.avatars=false}else if(TS.model.prefs.messages_theme=="light_with_avatars"){TS.model.prefs.theme="light";TS.model.prefs.avatars=true}},onTeamPrefChanged:function(imsg){if(imsg.name=="msg_edit_window_mins"){TS.model.team.prefs.msg_edit_window_mins=imsg.value}else if(imsg.name=="allow_message_deletion"){TS.model.team.prefs.allow_message_deletion=!!imsg.value}else if(imsg.name=="hide_referers"){TS.model.team.prefs.hide_referers=!!imsg.value;TS.prefs.team_hide_referers_changed_sig.dispatch()}else if(imsg.name=="require_at_for_mention"){if(!TS.boot_data_feature_name_tagging_client){TS.model.team.prefs.require_at_for_mention=!!imsg.value;TS.prefs.setHighlightWords(TS.model.prefs.highlight_words);TS.prefs.team_require_at_for_mention_changed_sig.dispatch()}}else if(imsg.name=="display_real_names"){TS.model.team.prefs.display_real_names=!!imsg.value;TS.prefs.team_display_real_names_changed_sig.dispatch()}else if(imsg.name=="display_email_addresses"){TS.model.team.prefs.display_email_addresses=!!imsg.value;TS.prefs.team_display_email_addresses_changed_sig.dispatch()}else if(imsg.name.indexOf("who_can_")===0){if(TS.model.team.prefs[imsg.name]!=imsg.value){TS.model.team.prefs[imsg.name]=imsg.value;TS.prefs.team_perms_pref_changed_sig.dispatch(imsg.name)}}else if(imsg.name=="compliance_export_start"){if(TS.model.team.prefs.compliance_export_start!=imsg.value){TS.model.team.prefs.compliance_export_start=imsg.value;TS.prefs.compliance_export_start_changed_sig.dispatch()}}else if(imsg.name=="disallow_public_file_urls"){TS.model.team.prefs.disallow_public_file_urls=!!imsg.value;TS.prefs.team_disallow_public_file_urls_changed_sig.dispatch()}else if(imsg.name=="auth_mode"){TS.model.team.prefs.auth_mode=imsg.value;TS.prefs.team_auth_mode_changed_sig.dispatch()}else if(imsg.name=="sso_auth_restrictions"){TS.model.team.prefs.sso_auth_restrictions=imsg.value;TS.prefs.team_sso_auth_restrictions_changed_sig.dispatch()}else if(imsg.name=="posts_migrating"){TS.model.team.prefs.posts_migrating=imsg.value;TS.prefs.team_posts_migrating_changed_sig.dispatch()}else if(imsg.name=="dnd_enabled"){TS.model.team.prefs.dnd_enabled=imsg.value;TS.prefs.team_dnd_enabled_changed_sig.dispatch()}else if(imsg.name=="dnd_start_hour"){TS.model.team.prefs.dnd_start_hour=imsg.value;TS.prefs.team_dnd_start_hour_changed_sig.dispatch()}else if(imsg.name=="dnd_end_hour"){TS.model.team.prefs.dnd_end_hour=imsg.value;TS.prefs.team_dnd_end_hour_changed_sig.dispatch()}else if(imsg.name=="invites_only_admins"){TS.model.team.prefs.invites_only_admins=imsg.value;TS.prefs.team_invites_only_admins_changed_sig.dispatch()}else if(imsg.name=="allow_calls"){TS.model.team.prefs.allow_calls=imsg.value;TS.prefs.team_allow_calls_changed_sig.dispatch()}else if(TS.boot_data.feature_platform_calls&&imsg.name=="calling_app_id"){TS.model.team.prefs.calling_app_id=imsg.value;TS.prefs.team_calling_app_id_changed_sig.dispatch()}else if(TS.boot_data.feature_platform_calls&&imsg.name=="calling_app_name"){TS.model.team.prefs.calling_app_name=imsg.value;TS.prefs.team_calling_app_name_changed_sig.dispatch()}else if(imsg.name=="team_handy_rxns"){TS.rxns.clearHandyRxnsDisplayDataCache();TS.model.team.prefs.team_handy_rxns=imsg.value;TS.prefs.team_handy_rxns_changed_sig.dispatch()}else if(imsg.name=="channel_handy_rxns"){TS.rxns.clearHandyRxnsDisplayDataCache();TS.model.team.prefs.channel_handy_rxns=imsg.value;TS.prefs.channel_handy_rxns_changed_sig.dispatch()}else if(imsg.name=="disable_file_editing"){TS.model.team.prefs.disable_file_editing=imsg.value;TS.prefs.team_disable_file_editing_changed_sig.dispatch()}else if(imsg.name=="disable_file_deleting"){TS.model.team.prefs.disable_file_deleting=imsg.value;TS.prefs.team_disable_file_deleting_changed_sig.dispatch()}else if(imsg.name=="who_can_post_general"){TS.model.team.prefs[imsg.name]=imsg.value;var general_id=TS.channels.getGeneralChannel().id;if(TS.members.canMemberPostInGeneral()){TS.channels.read_only.removeChannelFromList(general_id)}else{TS.channels.read_only.addChannelToList(general_id)}}else{TS.model.team.prefs[imsg.name]=imsg.value}},updateTeamPrefCanUserManageSharedChannels:function(imsg){TS.model.team.prefs.can_user_manage_shared_channels=imsg.can_manage},onPrefChanged:function(imsg){switch(imsg.name){case"flannel_server_pool":TS.model.prefs.flannel_server_pool=imsg.value;break;case"color_names_in_list":TS.model.prefs.color_names_in_list=!!imsg.value;TS.prefs.color_names_in_list_changed_sig.dispatch();break;case"display_real_names_override":TS.model.prefs.display_real_names_override=imsg.value;TS.prefs.display_real_names_override_changed_sig.dispatch();break;case"display_preferred_names":TS.model.prefs.display_preferred_names=imsg.value;TS.prefs.display_preferred_names_changed_sig.dispatch();break;case"growls_enabled":TS.model.prefs.growls_enabled=!!imsg.value;TS.prefs.dtop_notif_changed_sig.dispatch();break;case"sidebar_theme":if(TS.model.prefs.sidebar_theme!==imsg.value){TS.model.prefs.sidebar_theme=imsg.value;TS.prefs.sidebar_theme_changed_sig.dispatch()}break;case"sidebar_theme_custom_values":if(TS.model.prefs.sidebar_theme_custom_values!==imsg.value){TS.prefs.setSidebarThemeCustomValues(JSON.parse(imsg.value));TS.prefs.sidebar_theme_changed_sig.dispatch()}break;case"expand_inline_imgs":TS.model.prefs.expand_inline_imgs=!!imsg.value;TS.prefs.expand_inline_imgs_changed_sig.dispatch();break;case"webapp_spellcheck":TS.model.prefs.webapp_spellcheck=!!imsg.value;TS.prefs.webapp_spellcheck_changed_sig.dispatch();break;case"expand_internal_inline_imgs":TS.model.prefs.expand_internal_inline_imgs=!!imsg.value;TS.prefs.expand_internal_inline_imgs_changed_sig.dispatch();break;case"expand_non_media_attachments":TS.model.prefs.expand_non_media_attachments=!!imsg.value;TS.prefs.expand_non_media_attachments_changed_sig.dispatch();break;case"messages_theme":TS.model.prefs.messages_theme=imsg.value;TS.prefs.setTheme();TS.prefs.messages_theme_changed_sig.dispatch();break;case"highlight_words":TS.prefs.setHighlightWords(imsg.value);TS.prefs.highlight_words_changed_sig.dispatch();break;case"at_channel_suppressed_channels":TS.prefs.setSuppressedChannels(imsg.value);TS.prefs.dtop_notif_changed_sig.dispatch();break;case"push_at_channel_suppressed_channels":TS.prefs.setPushSuppressedChannels(imsg.value);TS.prefs.push_changed_sig.dispatch();break;case"loud_channels":TS.prefs.setLoudChannels(imsg.value);break;case"never_channels":TS.prefs.setNeverChannels(imsg.value);break;case"muted_channels":TS.prefs.setMutedChannels(imsg.value);TS.prefs.muted_channels_changed_sig.dispatch();break;case"loud_channels_set":TS.prefs.setLoudChannelsSet(imsg.value);TS.prefs.dtop_notif_changed_sig.dispatch();break;case"push_loud_channels":TS.prefs.setPushLoudChannels(imsg.value);break;case"push_mention_channels":TS.prefs.setPushMentionChannels(imsg.value);break;case"push_loud_channels_set":TS.prefs.setPushLoudChannelsSet(imsg.value);TS.prefs.push_changed_sig.dispatch();break;case"emoji_use":if(TS.prefs.mergeEmojiUse(imsg.value)){TS.emoji.maybeRemakeMenuListsIfFrequentsChanged()}break;case"user_colors":var member;var member_id;for(member_id in TS.model.user_colors){member=TS.members.getMemberById(member_id);if(member)TS.members.setMemberUserColor(member,member.color)}TS.prefs.setUserColors(imsg.value);for(member_id in TS.model.user_colors){member=TS.members.getMemberById(member_id);if(member)TS.members.setMemberUserColor(member,TS.model.user_colors[member_id])}break;case"graphic_emoticons":TS.rxns.clearHandyRxnsDisplayDataCache();TS.model.prefs.graphic_emoticons=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();break;case"ss_emojis":TS.model.prefs.ss_emojis=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();TS.emoji.makeMenuLists();break;case"emoji_mode":TS.rxns.clearHandyRxnsDisplayDataCache();TS.model.prefs.emoji_mode=imsg.value;TS.emoji.setEmojiMode();TS.prefs.emoji_mode_changed_sig.dispatch();TS.emoji.makeMenuLists();break;case"obey_inline_img_limit":TS.model.prefs.obey_inline_img_limit=imsg.value;TS.prefs.obey_inline_img_limit_changed_sig.dispatch();break;case"search_only_my_channels":TS.model.prefs.search_only_my_channels=!!imsg.value;TS.prefs.search_only_my_channels_changed_sig.dispatch();break;case"search_only_current_team":TS.model.prefs.search_only_current_team=!!imsg.value;TS.prefs.search_only_current_team_changed_sig.dispatch();break;case"search_exclude_channels":TS.prefs.setSearchExcludeChannels(imsg.value);TS.prefs.search_exclude_channels_changed_sig.dispatch();break;case"search_exclude_bots":TS.model.prefs.search_exclude_bots=!!imsg.value;TS.prefs.search_exclude_bots_changed_sig.dispatch();break;case"mac_speak_voice":if(TS.model.prefs.mac_speak_voice!=imsg.value){TS.model.prefs.mac_speak_voice=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"mac_speak_speed":if(TS.model.prefs.mac_speak_speed!=imsg.value){TS.model.prefs.mac_speak_speed=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"speak_growls":if(TS.model.prefs.speak_growls!==imsg.value){TS.model.prefs.speak_growls=imsg.value;TS.prefs.mac_speak_changed_sig.dispatch()}break;case"has_uploaded":TS.model.prefs.has_uploaded=!!imsg.value;break;case"has_invited":TS.model.prefs.has_invited=!!imsg.value;break;case"has_created_channel":TS.model.prefs.has_created_channel=!!imsg.value;break;case"no_joined_overlays":TS.model.prefs.no_joined_overlays=!!imsg.value;break;case"no_created_overlays":TS.model.prefs.no_created_overlays=!!imsg.value;break;case"seen_welcome_2":TS.model.prefs.seen_welcome_2=!!imsg.value;TS.prefs.seen_welcome_2_changed_sig.dispatch();break;case"box_enabled":TS.model.prefs.box_enabled=!!imsg.value;TS.prefs.box_enabled_changed_sig.dispatch();break;case"dropbox_enabled":TS.model.prefs.dropbox_enabled=!!imsg.value;TS.prefs.dropbox_enabled_changed_sig.dispatch();break;case"mark_msgs_read_immediately":if(TS.model.prefs.mark_msgs_read_immediately!==!!imsg.value){TS.model.prefs.mark_msgs_read_immediately=!!imsg.value;TS.prefs.read_changed_sig.dispatch()}break;case"start_scroll_at_oldest":if(TS.model.prefs.start_scroll_at_oldest!==!!imsg.value){TS.model.prefs.start_scroll_at_oldest=!!imsg.value;TS.prefs.read_changed_sig.dispatch()}break;case"mac_ssb_bullet":if(TS.model.prefs.mac_ssb_bullet!==!!imsg.value){TS.model.prefs.mac_ssb_bullet=!!imsg.value;TS.prefs.mac_ssb_bullet_changed_sig.dispatch()}break;case"all_channels_loud":if(TS.model.prefs.all_channels_loud!==!!imsg.value){TS.model.prefs.all_channels_loud=!!imsg.value;TS.prefs.dtop_notif_changed_sig.dispatch()}break;case"push_everything":if(TS.model.prefs.push_everything!==!!imsg.value){TS.model.prefs.push_everything=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"push_mention_alert":if(TS.model.prefs.push_mention_alert!==!!imsg.value){TS.model.prefs.push_mention_alert=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"push_dm_alert":if(TS.model.prefs.push_dm_alert!==!!imsg.value){TS.model.prefs.push_dm_alert=!!imsg.value;TS.prefs.push_changed_sig.dispatch()}break;case"time24":if(TS.model.prefs.time24!==!!imsg.value){TS.model.prefs.time24=!!imsg.value;TS.prefs.time24_changed_sig.dispatch()}break;case"sidebar_behavior":if(TS.model.prefs.sidebar_behavior!=imsg.value){TS.model.prefs.sidebar_behavior=imsg.value;TS.prefs.sidebar_behavior_changed_sig.dispatch()}break;case"two_factor_update_seen":if(TS.model.two_factor_update_seen!=imsg.value){TS.mode.prefs.two_factor_update_seen=imsg.value;TS.prefs.two_factor_update_seen_changed_sig.dispatch()}break;case"privacy_policy_seen":if(TS.model.prefs.privacy_policy_seen!=imsg.value){TS.model.prefs.privacy_policy_seen=imsg.value;TS.prefs.privacy_policy_seen_changed_sig.dispatch()}break;case"last_seen_at_channel_warning":if(TS.model.prefs.last_seen_at_channel_warning!=imsg.value){TS.model.prefs.last_seen_at_channel_warning=imsg.value}break;case"msg_preview":if(TS.model.prefs.msg_preview!=imsg.value){TS.model.prefs.msg_preview=imsg.value;TS.prefs.msg_preview_changed_sig.dispatch()}break;case"msg_preview_persistent":if(TS.model.prefs.msg_preview_persistent!=imsg.value){TS.model.prefs.msg_preview_persistent=imsg.value;TS.prefs.msg_preview_changed_sig.dispatch()}break;case"winssb_run_from_tray":if(TS.model.prefs.winssb_run_from_tray!=imsg.value){TS.model.prefs.winssb_run_from_tray=imsg.value;TSSSB.call("runFromTray",!!TS.model.prefs.winssb_run_from_tray)}break;case"winssb_window_flash_behavior":if(TS.model.prefs.winssb_window_flash_behavior!=imsg.value){TS.model.prefs.winssb_window_flash_behavior=imsg.value;TSSSB.call("windowFlashBehavior",TS.model.prefs.winssb_window_flash_behavior)}break;case"mentions_exclude_at_channels":if(TS.model.prefs.mentions_exclude_at_channels!=imsg.value){TS.model.prefs.mentions_exclude_at_channels=imsg.value;TS.prefs.mentions_exclude_at_channels_changed_sig.dispatch()}break;case"mentions_exclude_at_user_groups":if(TS.model.prefs.mentions_exclude_at_user_groups!=imsg.value){TS.model.prefs.mentions_exclude_at_user_groups=imsg.value;TS.prefs.mentions_exclude_at_user_groups_changed_sig.dispatch()}break;case"no_invites_widget_in_sidebar":if(TS.model.prefs.no_invites_widget_in_sidebar!=imsg.value){TS.model.prefs.no_invites_widget_in_sidebar=imsg.value;TS.prefs.no_invites_widget_in_sidebar_changed_sig.dispatch()}break;case"no_omnibox_in_channels":if(TS.model.prefs.no_omnibox_in_channels!=imsg.value){TS.model.prefs.no_omnibox_in_channels=imsg.value;TS.prefs.no_omnibox_in_channels_changed_sig.dispatch();if(TS.model.prefs.no_omnibox_in_channels){TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"quick_switcher_pref_changed",action:"button_hidden"})}else{TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"quick_switcher_pref_changed",action:"button_shown"})}}break;case"k_key_omnibox_auto_hide_count":if(TS.model.prefs.k_key_omnibox_auto_hide_count!=imsg.value){TS.model.prefs.k_key_omnibox_auto_hide_count=imsg.value;TS.prefs.k_key_omnibox_auto_hide_count_changed_sig.dispatch()}
break;case"preferred_skin_tone":if(TS.model.prefs.preferred_skin_tone!=imsg.value){TS.rxns.clearHandyRxnsDisplayDataCache();TS.model.prefs.preferred_skin_tone=imsg.value;TS.prefs.preferred_skin_tone_changed_sig.dispatch()}break;case"msg_replies":if(TS.model.prefs.msg_replies!=imsg.value){TS.model.prefs.msg_replies=imsg.value;TS.prefs.msg_replies_changed_sig.dispatch()}break;case"separate_private_channels":if(TS.model.prefs.separate_private_channels!=imsg.value){TS.model.prefs.separate_private_channels=imsg.value;TS.prefs.separate_private_channels_changed_sig.dispatch()}break;case"whats_new_read":if(TS.model.prefs.whats_new_read!=imsg.value){TS.model.prefs.whats_new_read=imsg.value;TS.prefs.whats_new_read_changed_sig.dispatch()}break;case"tz":if(TS.model.prefs.tz!=imsg.value){TS.model.prefs.tz=imsg.value;TS.prefs.tz_changed_sig.dispatch()}break;case"hotness":if(TS.model.prefs.hotness!=imsg.value){TS.model.prefs.hotness=imsg.value;TS.prefs.hotness_changed_sig.dispatch()}break;case"frecency_jumper":if(TS.ui.frecency.isEnterprise())break;if(TS.prefs.mergeFrecencyJumper(imsg.value)){TS.prefs.frecency_jumper_changed_sig.dispatch()}break;case"frecency_ent_jumper":TS.log(666,"Received a pref_change event for frecency_ent_jumper.");if(TS.prefs.mergeFrecencyJumper(imsg.value)){TS.prefs.frecency_jumper_changed_sig.dispatch()}break;case"jumbomoji":if(TS.model.prefs.jumbomoji!=imsg.value){TS.model.prefs.jumbomoji=imsg.value;TS.prefs.jumbomoji_changed_sig.dispatch()}break;case"a11y_font_size":if(TS.model.prefs.a11y_font_size!==imsg.value){TS.model.prefs.a11y_font_size=imsg.value;TS.prefs.a11y_font_size_changed_sig.dispatch()}break;case"a11y_animations":if(TS.model.prefs.a11y_animations!==imsg.value){TS.model.prefs.a11y_animations=imsg.value;TS.prefs.a11y_animations_changed_sig.dispatch();if(TS.client){TS.clog.track("PREF_USER_CLIENT_UPDATE",{a11y_animations:TS.model.prefs.a11y_animations})}}break;case"attachments_with_borders":if(TS.model.prefs.attachments_with_borders!==imsg.value){TS.model.prefs.attachments_with_borders=imsg.value;TS.prefs.attachments_with_borders_changed_sig.dispatch()}break;case"show_memory_instrument":if(TS.model.prefs.show_memory_instrument!==imsg.value){TS.model.prefs.show_memory_instrument=imsg.value;TS.prefs.show_memory_instrument_changed_sig.dispatch()}break;case"channel_sort":if(TS.model.prefs.channel_sort!==imsg.value){TS.model.prefs.channel_sort=imsg.value;TS.prefs.setChannelSort(TS.model.prefs.channel_sort);TS.prefs.channel_sort_changed_sig.dispatch()}break;case"enable_unread_view":if(TS.model.prefs.enable_unread_view!==imsg.value){TS.model.prefs.enable_unread_view=imsg.value;TS.prefs.enable_unread_view_changed_sig.dispatch()}break;case"measure_css_usage":if(TS.model.prefs.measure_css_usage!==imsg.value){TS.model.prefs.measure_css_usage=imsg.value;TS.prefs.measure_css_usage_changed_sig.dispatch()}break;case"client_logs_pri":TS.model.prefs[imsg.name]=imsg.value;TS.console.setAppropriatePri();break;default:TS.model.prefs[imsg.name]=imsg.value}},hex_regex:new RegExp(/^#?([0-9a-f]{6})$/i),setSidebarThemeCustomValues:function(ob){var good_values=false;if(ob&&typeof ob==="object"&&ob.length===undefined){for(var k in ob){good_values=false;if(!ob[k])break;if(!ob[k].substr)break;ob[k]=ob[k].substr(0,7);if(!ob[k].match(TS.prefs.hex_regex))break;good_values=true}}if(good_values){TS.model.prefs.sidebar_theme_custom_values=JSON.stringify(ob)}else{TS.model.prefs.sidebar_theme="default";TS.model.prefs.sidebar_theme_custom_values=JSON.stringify(TS.sidebar_themes.default_themes["default_theme"])}},setMultiPrefsByAPI:function(prefs,handler){var value="";for(var k in prefs){value+="&"+encodeURIComponent(k)+"="+encodeURIComponent(prefs[k])}if(!value){TS.error(" no prefs to set?");return}var args={prefs:value};return TS.prefs.setPrefByAPI(args,handler)},setPrefByAPI:function(args,handler){var localHandler=function(ok,data,args){if(!ok){var desc;if(args.hasOwnProperty("name")){desc="pref name: "+args.name}else if(args.prefs){desc="(multiple prefs)"}TS.logError(desc,"TS.prefs.setPrefByAPI call got a not ok rsp","API response error");setTimeout(function(){if(args.prefs){TS.error("multi preferences setting failed.")}else{TS.error('"'+args.name+'" preference setting failed.')}},0)}if(handler){handler(ok,data,args)}};var func=TS.model.window_unloading?TS.api.callSynchronously:TS.api.callImmediately;return func("users.prefs.set",args,localHandler)},setTeamPrefByAPI:function(prefs,onError){var func=TS.model.window_unloading?TS.api.callSynchronously:TS.api.callImmediately;var d=$.Deferred();func("team.prefs.set",{prefs:JSON.stringify(prefs)},function(ok,data,args){var pref_name;if(ok){if(TS.web){for(pref_name in prefs){if(prefs.hasOwnProperty(pref_name)&&data.prefs.hasOwnProperty(pref_name)){TS.prefs.onTeamPrefChanged({name:pref_name,value:data.prefs[pref_name]})}}}d.resolve(data.prefs)}else{d.reject(data);if(onError)onError(data)}});return d},saveHighlightWords:function(val,callback,force){var highlight_words_new=_cleanHighlightWords(val);if(force||TS.model.prefs.highlight_words!=highlight_words_new){return TS.prefs.setPrefByAPI({name:"highlight_words",value:highlight_words_new},callback)}else{return Promise.resolve()}},getReadStateTrackingPref:function(){var val="default";if(TS.model.prefs.mark_msgs_read_immediately&&TS.model.prefs.start_scroll_at_oldest){val="immediate_scroll"}else if(TS.model.prefs.mark_msgs_read_immediately){val="immediate"}return val},setReadStateTrackingPref:function(val,handler){var prefs={};if(val=="immediate_scroll"||val=="immediate"){prefs.mark_msgs_read_immediately=true;TS.model.prefs.mark_msgs_read_immediately=true;if(val=="immediate_scroll"){prefs.start_scroll_at_oldest=true;TS.model.prefs.start_scroll_at_oldest=true}else{prefs.start_scroll_at_oldest=false;TS.model.prefs.start_scroll_at_oldest=false}}else{prefs.mark_msgs_read_immediately=false;TS.model.prefs.mark_msgs_read_immediately=false;prefs.start_scroll_at_oldest=false;TS.model.prefs.start_scroll_at_oldest=false}TS.prefs.setMultiPrefsByAPI(prefs,handler)},test:function(){return{_cleanHighlightWords:_cleanHighlightWords}}});var _emoji_use_dirty_cnt=0;var _has_set_muted_channels_before=false;var _maybeSaveEmojiUse=function(){if(TS.boot_data.feature_server_side_emoji_counts)return;if(!_emoji_use_dirty_cnt)return;TS.prefs.saveEmojiUse()};var _cleanHighlightWords=function(val){if(!_.isString(val))return"";val=TS.format.replaceUnicodeDoppelgangers(val);return _(val).split(",").map(_.trim).compact().join(",")}})();(function(){"use strict";TS.registerModule("search",{search_dispatched_sig:new signals.Signal,quick_search_results_fetched_sig:new signals.Signal,all_search_results_fetched_sig:new signals.Signal,message_search_results_fetched_sig:new signals.Signal,file_search_results_fetched_sig:new signals.Signal,autosuggest_search_results_fetched_sig:new signals.Signal,search_filter_set_sig:new signals.Signal,search_filetype_filter_set_sig:new signals.Signal,search_sort_set_sig:new signals.Signal,search_channel_set_sig:new signals.Signal,search_group_set_sig:new signals.Signal,search_member_set_sig:new signals.Signal,message_search_more_results_fetched_sig:new signals.Signal,query:"",query_string:"",last_search_query:"",previous_query:"",sort:"timestamp",filter:"messages",filetype:"all",results:{},submit_tim:0,delay:500,suggestions:[],input:"",from_regex:/from:[@*\-.\w]+/gi,member:null,from:null,in_regex:/in:[#*\-.\w]+/gi,channel:null,group:null,im:null,per_page:-1,keyword_modifiers:["after","before","bot","during","from","to","has","in","on"],keyword_modifier_pair_regex:null,keyword_modifier_extract_regex:null,search_query_max_length:250,onStart:function(){TS.search.keyword_modifier_pair_regex=new RegExp("^("+TS.search.keyword_modifiers.join("|")+"):S+$");TS.search.keyword_modifier_extract_regex=new RegExp("^("+TS.search.keyword_modifiers.join("|")+"):w*");TS.search.per_page=parseInt(TS.qs_args["search_count"])||20;if(TS.client)TS.search.delay=10;if(TS.client){TS.client.login_sig.add(TS.search.loggedIn,TS.search)}else if(TS.web){TS.web.login_sig.add(TS.search.loggedIn,TS.search)}TS.search.search_channel_set_sig.add(TS.search.searchAll,TS.search);TS.search.search_group_set_sig.add(TS.search.searchAll,TS.search);TS.search.search_member_set_sig.add(TS.search.searchAll,TS.search);TS.prefs.search_only_my_channels_changed_sig.add(TS.search.searchAll,TS.search);TS.prefs.search_only_current_team_changed_sig.add(TS.search.searchAll,TS.search);TS.prefs.search_exclude_bots_changed_sig.add(TS.search.searchAll,TS.search);TS.files.team_file_changed_sig.add(_teamFileChanged);if(TS.qs_args["delay"])TS.search.delay=TS.qs_args["delay"];TS.search.input=$("#search_terms");TSSSB.call("inputFieldCreated",TS.search.input.get(0))},loggedIn:function(){var pref=TS.model.prefs.search_sort;if(pref==="model"&&!$("#search_sort_model").length){pref="score"}TS.search.sort=pref=="score"||pref=="timestamp"||pref=="model"?pref:TS.search.sort},startSearchTimer:function(query,count,callback){clearTimeout(TS.search.submit_tim);TS.search.submit_tim=setTimeout(TS.search.dispatchSearch,TS.search.delay,query,count,callback);TS.search.search_dispatched_sig.dispatch()},getNextPageOfSearchResults:function(query,page){TS.search.dispatchSearch(query,TS.search.per_page,TS.search.onSearchAll,page)},getNextPageOfMessageResults:function(query,page){_callSearchPerSe("search.messages",query,TS.search.per_page,page,_onSearchMessages)},getNextPageOfFileResults:function(query,page){_callSearchPerSe("search.files",query,TS.search.per_page,page,_onSearchFiles)},extractNonModifierSearchTxt:function(txt){var ret="";var A=txt.split(" ");A.forEach(function(m){if(m.match(TS.search.keyword_modifier_extract_regex))return;ret+=" "+m});ret=$.trim(ret);return ret},dispatchSearch:function(query,count,callback,page){if(TS.isPartiallyBooted()){if(!_pending_dispatch_search_args){var this_context=this;TS.ms.connected_sig.addOnce(function(){TS.search.dispatchSearch.apply(this_context,_pending_dispatch_search_args);_pending_dispatch_search_args=undefined})}_pending_dispatch_search_args=arguments;return}if(!page||page==1){var system_find_str=TS.search.extractNonModifierSearchTxt(query);if(system_find_str)TSSSB.call("writeFindString",system_find_str)}if(TS.search.separateMessagesAndFiles()){if(!page||page==1)TS.search.results[query]=null;var response_tracker=_makeSearchCallbackTracker();_callSearchPerSe("search.messages",query,count,page,response_tracker.msgs);_callSearchPerSe("search.files",query,count,page,response_tracker.files)}else{_callSearchPerSe("search.all",query,count,page,callback)}},setFilter:function(filter){TS.search.filter=filter;TS.search.search_filter_set_sig.dispatch()},setFiletypeFilter:function(filter){TS.search.filetype=filter;TS.search.search_filetype_filter_set_sig.dispatch()},setSort:function(sort){if(TS.search.sort==sort)return;$(".search_toggle").toggleClass("active");TS.search.sort=sort;TS.search.search_sort_set_sig.dispatch();if(sort!=="score"&&sort!=="model"){sort="timestamp"}TS.prefs.setPrefByAPI({name:"search_sort",value:sort})},setChannel:function(id){var channel=TS.channels.getChannelById(id);if(channel){TS.search.channel=channel;TS.search.group=null;TS.search.im=null}else{TS.search.channel=null}TS.search.search_channel_set_sig.dispatch()},setGroup:function(id){var group=TS.groups.getGroupById(id);if(group){TS.search.group=group;TS.search.channel=null;TS.search.im=null}else{TS.search.group=null}TS.search.search_group_set_sig.dispatch()},setMember:function(id){var member=TS.members.getMemberById(id);if(member){TS.search.member=member}else{TS.search.member=null;TS.search.from=null;var input_val=$.trim(TS.search.input.val());var from_matches=input_val.match(TS.search.from_regex);if(from_matches){$.each(from_matches,function(i,match){input_val=$.trim(input_val.replace(match,""))});TS.search.input.val(input_val)}}TS.search.search_member_set_sig.dispatch()},buildQueryString:function(query,set_params){var from_matches=query.match(TS.search.from_regex);if(from_matches){var from_matched=false;$.each(from_matches,function(i,match){if(from_matched){query=$.trim(query.replace(match,""))}else{var from_str=match.replace("from:","");if(from_str.toLowerCase()=="me"){if(set_params)TS.search.member=TS.model.user;TS.search.from=null;from_matched=true}else{var member=TS.members.getMemberByName(from_str);if(member){if(set_params)TS.search.member=member;TS.search.from=null;from_matched=true}else{if(set_params){TS.search.from=from_str;TS.search.member=null}else if(TS.search.member){TS.search.from=null}from_matched=true}}if(from_matched)query=$.trim(query.replace(match,""))}})}else{if(TS.search.filter=="messages"){TS.search.member=null;TS.search.from=null}}var in_matches=query.match(TS.search.in_regex);if(in_matches){var in_matched=false;$.each(in_matches,function(i,match){if(in_matched){query=$.trim(query.replace(match,""))}else{var match_name=match.replace("in:","");var channel=TS.channels.getChannelByName(match_name);var group=TS.groups.getGroupByName(match_name);var im=TS.ims.getImByUsername(match_name);if(channel){in_matched=true;if(set_params){TS.search.channel=channel;TS.search.group=null;TS.search.im=null}}else if(group){in_matched=true;if(set_params){TS.search.group=group;TS.search.channel=null;TS.search.im=null}}else if(im){in_matched=true;if(set_params){TS.search.im=im;TS.search.channel=null;TS.search.group=null}}else{TS.info("Unable to filter search results by channel, group, or IM named '"+match_name+"'")}in_matched=true}if(in_matched)query=$.trim(query.replace(match,""))})}else{TS.search.channel=null;TS.search.group=null;TS.search.im=null}if(!from_matches){if(TS.search.previous_query==TS.search.query&&set_params){TS.search.member=null;TS.search.from=null}}if(!in_matches){if(TS.search.previous_query==TS.search.query&&set_params){TS.search.channel=null;TS.search.group=null;TS.search.im=null}}TS.search.query=$.trim(query);TS.search.query_string=TS.search.query;if(TS.search.member!==null)TS.search.query_string+=" from:"+TS.search.member.name;if(TS.search.from!==null)TS.search.query_string+=" from:"+TS.search.from;if(TS.search.channel!==null)TS.search.query_string+=" in:"+TS.search.channel.name;if(TS.search.group!==null)TS.search.query_string+=" in:"+TS.search.group.name;if(TS.search.im!==null)TS.search.query_string+=" in:"+TS.search.im.name;TS.search.query_string=$.trim(TS.search.query_string)},quickSearch:function(query){TS.search.query=query;TS.search.buildQueryString(query);var count=5;TS.search.startSearchTimer(query,count,TS.search.onQuickSearch)},onQuickSearch:function(ok,data,args){if(!ok){return}TS.search.quick_search_results_fetched_sig.dispatch(data)},searchAll:function(query){if(!TS.client){clearTimeout(TS.search.widget.key_tim)}TS.search.previous_query=TS.search.query;if(query){TS.search.query=query}else{TS.search.query=$.trim(TS.search.input.val())}TS.search.query=$.trim(TS.search.query);TS.search.query_string=TS.search.query;if(TS.search.query_string){TS.search.startSearchTimer(TS.search.query_string,TS.search.per_page,TS.search.onSearchAll)}else{TS.search.view.updateOptions();if(TS.client){TS.search.autocomplete.stopSpinner()}else{TS.search.widget.stopSpinner()}}},onSearchAll:function(ok,data,args){if(TS.qs_args["force_search_fail"]=="1"){window.failed_once=true;ok=false;data={ok:false,error:"solr_failed"}}if(!ok){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.messages=data.messages||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]};data.files=data.files||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}TS.search.last_search_query=args.query;if(TS.client)TS.search.upsertFiles(data);TS.search.expandChannelsAndCheckForMsgsInModel(data);if(args.page==1){TS.search.results[args.query]=data;TS.search.results[args.query]["_time_of_search"]=Date.now();TS.search.all_search_results_fetched_sig.dispatch(data,args);TS.search.getNextPageOfSearchResults(args.query,2)}else{var existing=TS.search.results[args.query];if(existing.messages.matches)data.messages.matches=existing.messages.matches.concat(data.messages.matches);if(existing.files.matches)data.files.matches=existing.files.matches.concat(data.files.matches);TS.search.results[args.query]=data;TS.search.all_search_results_fetched_sig.dispatch(data,args)}},searchSuggest:function(query){TS.api.call("search.autocomplete",{query:query},TS.search.onSearchSuggest)},onSearchSuggest:function(ok,data,args){if(!TS.client){if(TS.search.widget.suppress_suggestions){TS.search.widget.suppress_suggestions=false;return}}if(!ok){return}TS.search.suggestions=[];if(data.suggestions[0]==TS.search.query&&data.suggestions.length==1){TS.search.suggestions=[]}else{$.each(data.suggestions,function(i,value){TS.search.suggestions[i]={value:value,highlighted:TS.search.highlightSuggestion(TS.utility.htmlEntities(value))}})}TS.search.autosuggest_search_results_fetched_sig.dispatch(data,args)},highlightSuggestion:function(value){var highlighted=value.replace(new RegExp("("+TS.utility.preg_quote(TS.search.input.val())+")","gi"),"<b>$1</b>");return highlighted},expandChannelsAndCheckForMsgsInModel:function(results){var match;var model_ob;if(!results.messages||!results.messages.matches)return;var existing_rxns;for(var i=0;i<results.messages.matches.length;i++){match=results.messages.matches[i];if(!match)continue;var c_id=match.channel.id;_ingestMsgSearchResultExtras(match,c_id);_nextprev_names.forEach(function(name){if(!match[name])return;_ingestMsgSearchResultExtras(match[name],c_id)});existing_rxns=TS.rxns.getExistingRxnsByKey(match._rxn_key);if(existing_rxns&&!match.reactions){TS.warn("msg:"+match.ts+" has reactions in local model, but we got an object in search results that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(match._rxn_key,match.reactions)}model_ob=TS.shared.getModelObById(c_id);if(model_ob){if(match.type=="im"&&!TS.ims.isImWithDeletedMember(model_ob)){match.im_exists=true}if(model_ob.msgs){match.is_loaded=!!TS.utility.msgs.getMsg(match.ts,model_ob.msgs)}else if(TS.client){TS.warn(model_ob.name+" has no msgs")}match.channel=model_ob;if(!match.permalink)match.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,match.ts)}}},upsertFiles:function(data){if(!data.files||!data.files.matches)return;for(var i=0;i<data.files.matches.length;i++){if(data.files.matches[i].preview){data.files.matches[i].preview_search=data.files.matches[i].preview;delete data.files.matches[i].preview}data.files.matches[i]=TS.files.upsertFile(data.files.matches[i]).file}},getResultsByQuery:function(query){return TS.search.results[query]},getMatchByQueryAndTs:function(query,ts){return TS.search.getMatchByQueryByThings(query,ts)},getMatchByQueryAndChannelAndTs:function(query,channel_id,ts){return TS.search.getMatchByQueryByThings(query,ts,channel_id)},getMatchByQueryByThings:function(query,ts,channel_id){var results=TS.search.getResultsByQuery(query);if(!results){TS.error("WTF no results?");return null}return TS.search.getMatchFromResultsByThings(true,results,ts,channel_id)},getMatchFromResultsByThings:function(return_ob,results,ts,channel_id){if(!results){TS.error("WTF no results?");return null}if(!results.messages){TS.error("WTF no results.messages?");return null}if(!results.messages.matches){TS.error("WTF no results.messages.matches?");return null}var match;for(var i=0;i<results.messages.matches.length;i++){match=results.messages.matches[i];if(!match){TS.error("WTF no match?");continue}if((!channel_id||match.channel.id==channel_id)&&match.ts==ts){if(return_ob){return{match:match,index:i}}else{return match}}}return null},truncateQuery:function(q){if(q.length>TS.search.search_query_max_length){return q.substring(0,TS.search.search_query_max_length)}return q},resetSearchOptions:function(){TS.search.channel=null;TS.search.group=null;TS.search.im=null;TS.search.member=null;TS.search.from=null;TS.search.searchAll()},saveSearch:function(params,callback){if(!params.terms)return;params.terms=$.trim(params.terms);if(TS.search.keyword_modifier_pair_regex.test(params.terms))return;TS.api.call("search.save",params,callback)},separateMessagesAndFiles:function(){return!!TS.client},setInputVal:function(txt){TS.search.input.val(txt).focus()},appendToInputAndSelect:function(txt){var current=TS.search.input.val();if(current&&!/\s$/.test(current))current+=" ";TS.search.input.val(current+txt);TS.search.input.textrange("set",current.length,current.length+txt.length)},submitSearch:function(){TS.search.input.closest("form").trigger("submit")},debugQuery:function(team_id,user_id){var uri="/mc/search_eval_query.php"+"?team_id="+team_id+"&user_id="+user_id+"&query="+encodeURIComponent(TS.search.query_string);window.open(uri)}});var _nextprev_names=["next","next_2","previous","previous_2"];var _ingestMsgSearchResultExtras=function(ob,c_id){ob._rxn_key=TS.rxns.getRxnKey("message",ob.ts,c_id);TS.utility.msgs.processAttachments(ob.attachments);TS.ui.handy_rxns.decorateMsg(ob,TS.format.replaceHighlightMarkers(ob.text));if(ob.extracts&&ob.extracts.length){ob.extracts.forEach(function(extract){extract._rxn_key=ob._rxn_key;TS.ui.handy_rxns.decorateMsg(extract,TS.format.replaceHighlightMarkers(extract.text))})}};var _pending_dispatch_search_args;var _callSearchPerSe=function(method,query,count,page,callback){var args={query:query,highlight:true,count:count,types:[TS.search.filetype],sort:TS.search.sort,page:page||1,extracts:1,extra_message_data:1,max_extract_len:150,highlight_attachments:1,active_cid:TS.model.active_cid};if(method==="search.all")args.no_posts=1;if(method!=="search.files")args.more_matches=true;if(TS.boot_data.feature_enterprise_search_ui&&TS.boot_data.page_needs_enterprise&&TS.boot_data.enterprise_api_token){args.enterprise_token=TS.boot_data.enterprise_api_token;if(method==="search.messages")args.team=TS.model.team.id}TS.api.call(method,args,callback)};var _onSearchMessages=function(ok,data,args,request_id){if(!ok||!data.messages){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.messages=data.messages||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}if(TS.search.last_search_query!==args.query){delete TS.search.results[TS.search.last_search_query]}TS.search.last_search_query=args.query;TS.search.last_request_id=request_id;TS.search.expandChannelsAndCheckForMsgsInModel(data);var existing=TS.search.results[args.query];if(args.page==1){if(!existing){TS.search.results[args.query]=data;existing=data}else{$.extend(existing,data)}existing.initial_messages_total=data.messages.total;existing["_time_of_search"]=Date.now();TS.search.message_search_results_fetched_sig.dispatch(existing,args)}else{if(existing.messages&&existing.messages.matches){data.messages.matches=existing.messages.matches.concat(data.messages.matches)}$.extend(existing,data);TS.search.message_search_results_fetched_sig.dispatch(existing,args)}};var _onSearchFiles=function(ok,data,args){if(!ok||!data.files){var err_str=data&&data.error?data.error:"unknown_error";if(!data){data={ok:false,error:err_str}}data.query=data.query||args.query;data.files=data.files||{total:0,paging:{count:TS.search.per_page,total:0,page:1,pages:0},matches:[]}}if(args.query!=TS.search.query_string){if(!TS.search.results[args.query]||!TS.search.results[args.query].error){return}}if(TS.search.last_search_query!==args.query){delete TS.search.results[TS.search.last_search_query]}TS.search.last_search_query=args.query;if(TS.client)TS.search.upsertFiles(data);var existing=TS.search.results[args.query];if(args.page==1){if(!existing){TS.search.results[args.query]=data;existing=data}else{$.extend(existing,data)}existing.initial_files_total=data.files.total;existing["_time_of_search"]=Date.now();TS.search.file_search_results_fetched_sig.dispatch(existing,args)}else{if(existing.files&&existing.files.matches){data.files.matches=existing.files.matches.concat(data.files.matches)}$.extend(existing,data);TS.search.file_search_results_fetched_sig.dispatch(existing,args)}};var _makeSearchCallbackTracker=function(){var msgs_fetched=false;var files_fetched=false;var after=function(){if(msgs_fetched&&files_fetched){TS.search.all_search_results_fetched_sig.dispatch()}};return{msgs:function(){msgs_fetched=true;_onSearchMessages.apply(this,arguments);after()},files:function(){files_fetched=true;_onSearchFiles.apply(this,arguments);after()}}};var _teamFileChanged=function(file){TS.files.updateFileListItem(file,$("#search_results_items"))}})();(function(){"use strict";TS.registerModule("ms",{fast_reconnects_enabled:true,last_pong_time:0,sent_map:{},connected_sig:new signals.Signal,disconnected_sig:new signals.Signal,trouble_sig:new signals.Signal,reconnecting_sig:new signals.Signal,pong_sig:new signals.Signal,on_msg_sig:new signals.Signal,reconnect_requested_sig:new signals.Signal,num_times_connected:0,is_flannel:false,errors:{BAD_TOKEN:1,CONNECTION_TROUBLE:1006,RATE_LIMIT:-1,UNKNOWN:0},onStart:function(){if(!window.WebSocket){window.WebSocket=window.MozWebSocket;if(!window.WebSocket){alert("Your browser does not support WebSockets.");return}}_setPongTimeoutMs(TS.model.ui.is_window_focused||false);TS.ui.window_focus_changed_sig.add(_setPongTimeoutMs);setInterval(function(){if(!TS.model.ms_connected)return;if(TS.model.rtm_start_throttler<1)return;TS.model.rtm_start_throttler--},1e3*60);var ping_pong_measurement_percentage=10;_measure_ping_pong_latency=TS.boot_data.feature_tinyspeck||TS.utility.enableFeatureForUser(ping_pong_measurement_percentage);_time_since_last_ping_pong_metric=Date.now();if(!TS.boot_data.feature_tinyspeck){_maybeClearImsgLog=_.noop;_maybeAddToImsgLog=_.noop;_maybePrintImsgLog=_.noop}},send:function(msg,handler,temp_ts){msg.id=++_msg_id;TS.ms.sent_map[msg.id.toString()]={msg:msg,handler:handler,ts:Date.now(),temp_ts:temp_ts};if(msg.type=="ping"||msg.type=="pong"){TS.log(2,"MS sending "+msg.type);TS.dir(2,msg)}else{TS.model.last_net_send=Date.now();TS.log(2,"sending "+msg.type);TS.dir(2,msg)}_websocket.send(JSON.stringify(msg));return msg.id},sendTyping:function(c_id){var msg_str='{"type":"typing", "channel":"'+c_id+'"}';_websocket.send(msg_str)},sendTickle:function(){TS.model.last_net_send=Date.now();var msg_str='{"type":"tickle"}';_websocket.send(msg_str)},handleMsg:function(imsg){var is_reconnect_reply=imsg.reply_to&&!("ok"in imsg)&&imsg.type=="message";var sent;if(imsg.reply_to){if(imsg.reply_to.toString()in TS.ms.sent_map){sent=_processReplyMessage(imsg)}else{if(!is_reconnect_reply){TS.error('received msg "'+imsg.reply_to+'" with type "'+imsg.type+'" but we have no record of it in sent_map')}}}else{if(imsg.event_ts&&!imsg._from_evt_log){TS.ms.storeLastEventTS(imsg.event_ts,"handleMsg")}if(TS.storage.isUsingMemberBotCache()&&imsg.cache_ts){TS.storage.rememberLastCacheTS(imsg.cache_ts)}}var onPong=function(){if(_log_next_pong){_log_next_pong=false;TS.info("Got pong from MS")}TS.ms.last_pong_time=Date.now();TS.ms.pong_sig.dispatch();_check_last_pong_time=false;_maybeClearImsgLog()};if(imsg.type=="ping"||imsg.type=="pong"){if(sent&&sent.ts){TS.log(2,"MS msg "+imsg.type+" time: "+(Date.now()-sent.ts)+" ms")}else{TS.log(2,"MS msg "+imsg.type+" time: "+Date.now()+" ms (no sent.ts)")}if(_measure_ping_pong_latency){if(Date.now()-_time_since_last_ping_pong_metric>_ping_pong_measurement_interval){TS.metrics.measureAndClear("ms_ping_pong_latency","ms_ping_sent");_time_since_last_ping_pong_metric=Date.now()}else{TS.metrics.clearMarks("ms_ping_sent")}}onPong();TS.dir(2,imsg)}else{var time_since_last_pong=Date.now()-TS.ms.last_pong_time;if(_check_last_pong_time&&time_since_last_pong>_implicit_pong_interv_ms){TS.log(2,"MS msg being used as an implicit pong due to excessive delay ("+time_since_last_pong+"ms)");onPong();if(_measure_ping_pong_latency){TS.metrics.clearMarks("ms_ping_sent")}}else{_maybeAddToImsgLog(imsg)}if(sent){var type=imsg.type?imsg.type:imsg.SENT_MSG.type?imsg.SENT_MSG.type:"";TS.log(2,"msg "+(type?'"'+type+'" ':"")+"rsp time "+(Date.now()-sent.ts)+"ms")}else{TS.log(2,'msg "'+imsg.type+'"')}TS.dir(2,imsg)}if(imsg.type=="error"){_onErrorMsg(imsg)}else if(imsg.type=="hello"){_onHello(imsg)}else if(!imsg.reply_to){TS.ms.on_msg_sig.dispatch(imsg)}if(sent){if(!imsg.ok&&imsg.type=="flannel"){imsg.ok=true}if(!imsg.ok){imsg.error=imsg.error||{code:TS.ms.errors.UNKNOWN,msg:"unknown error (not specified by MS)"}}if(is_reconnect_reply){imsg.ok=true}if(sent.handler){sent.handler(imsg.ok,imsg)}}},storeLastEventTS:function(ts,whence){if(!ts)return;var last_event_ts=TS.storage.fetchLastEventTS();if(last_event_ts&&ts<=last_event_ts)return;if(!whence)whence="???";_whence_last_event_ts=whence+" at "+Date.now()/1e3;TS.storage.storeLastEventTS(ts)},onFailure:function(reason_str){TS.warn("TS.ms.onFailure reason_str:"+reason_str);if(reason_str)_reportDisconnect("You got disconnected, so here are some details:\n>>>"+reason_str);_check_last_pong_time=false;_deprecateCurrentSocket();if(TS.model.ms_connected){TS.info("Disconnected from MS, TS.model.rtm_start_throttler:"+TS.model.rtm_start_throttler);TS.ms.logConnectionFlow("on_connected_failure");TS.model.ms_reconnect_ms=100}else{TS.ms.logConnectionFlow("on_notconnected_failure");var ms=TS.model.ms_reconnect_ms=(TS.model.ms_reconnect_ms+1e3)*2;if(TS.model.ms_reconnect_ms>4e3){TS.model.ms_reconnect_ms=_.random(ms,ms+ms/2)}TS.model.ms_reconnect_ms=Math.min(TS.model.ms_reconnect_ms,3e5)}if(TS.model.rtm_start_throttler>5){var min_ms=2e3*TS.model.rtm_start_throttler;if(TS.model.ms_reconnect_ms<min_ms){TS.info("because TS.model.rtm_start_throttler:"+TS.model.rtm_start_throttler+" we are increasing time until next login call");TS.model.ms_reconnect_ms=min_ms}}if(TS.model.ms_connected){TS.model.ms_connected=false;TS.ms.disconnected_sig.dispatch()}delete TS.ms.is_flannel;clearInterval(_check_ping_interv);clearInterval(_send_ping_interv);if(TS.model.ms_asleep){TS.warn("NOT doing startReconnection(), we are asleep");return}if(TS.api.isPaused()){TS.warn("NOT doing startReconnection() because TS.api.isPaused()");return}TS.ms.startReconnection()},startReconnection:function(){TS.model.ms_reconnect_time=Date.now()+TS.model.ms_reconnect_ms;TS.info("Attempting to reconnect in "+TS.model.ms_reconnect_ms+"ms");clearInterval(_reconnect_interv);_reconnect_interv=setInterval(_onReconnectInterval,_reconnect_interv_ms);_onReconnectInterval();clearTimeout(_auto_reconnect_tim);_auto_reconnect_tim=setTimeout(function(){if(!TS.model.window_unloading){TS.ms.startReconnectionImmediately()}},TS.model.ms_reconnect_ms)},startReconnectionImmediately:function(){clearTimeout(_auto_reconnect_tim);if(TS.model.attempting_fast_reconnect&&_isReconnectUrlValid()){TS.ms.fastReconnect()}else{if(TS.model.attempting_fast_reconnect)_clearReconnectUrl();TS.ms.reconnect_requested_sig.dispatch()}},manualReconnectNow:function(){TS.ms.logConnectionFlow("manual_reconnect");clearTimeout(_auto_reconnect_tim);clearInterval(_reconnect_interv);clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(!TS.model.window_unloading){TS.ms.reconnect_requested_sig.dispatch();TS.ms.reconnecting_sig.dispatch(0)}},disconnect:function(){if(_websocket&&TS.model.ms_connected){TS.ms.logConnectionFlow("disconnect");_websocket.close()}else{TS.warn("TS.ms.disconnect called, but _websocket="+_websocket+" TS.model.ms_connected="+TS.model.ms_connected)}},logConnectionFlow:function(name){var ms_conn_log=TS.model.ms_conn_log;var time=Date.now();ms_conn_log.push({name:name,time:time,delta:ms_conn_log.length?time-ms_conn_log[ms_conn_log.length-1].time:0});TS.log(2,"logConnectionFlow "+name+" "+ms_conn_log[ms_conn_log.length-1].delta)},getConnectionFlowLog:function(){
var ms_conn_log=TS.model.ms_conn_log;var args=[];for(var i=0;i<ms_conn_log.length;i++){args.push(encodeURIComponent(ms_conn_log[i].name+"-"+(ms_conn_log[i].delta?Math.round(ms_conn_log[i].delta/1e3):0)+"-"+Math.round(ms_conn_log[i].time/1e3)))}TS.dir(2,TS.model.ms_conn_log);var log="_x_connection_log="+args.join(",");return log},connectImmediately:function(url){if(!url)url=TS.model.team.url;if(!url){throw new Error("No WebSocket URL for us to connect to! ")}url=_addQueryParamsToLoginUrl(url);_connect(url);_initSocketHandlersImmediate()},connectProvisionally:function(url){_connect(url);_initSocketHandlersProvisional()},connectProvisionallyAndFetchRtmStart:function(url){if(!url)url=TS.model.team.url;url=_addQueryParamsToLoginUrl(url);_connect(url);return _initSocketHandlersProvisionalRtmStart()},hasProvisionalConnection:function(){return!!_did_make_provisional_connection},hasOpenWebSocket:function(){return _.get(_websocket,"readyState")==WebSocket.OPEN},promiseToHaveOpenWebSocket:function(){if(TS.ms.hasOpenWebSocket())return Promise.resolve();if(!_open_websocket_p){_open_websocket_p=new Promise(function(resolve){_open_websocket_p_resolve=resolve})}return _open_websocket_p},finalizeProvisionalConnection:function(){return _finalizeProvisionalConnection()},fastReconnect:function(){TS.info("Trying fast reconnect");TS.model.calling_test_fast_reconnect=true;TS.api.callImmediately("rtm.checkFastReconnect").then(function(response){var data=response.data;if(TS.reloadIfVersionsChanged(data))return;TS.ms.connectImmediately(_reconnect_url)},function(response){var data=response.data;var error=data&&data.error;if(error&&error!=="_http_error")_clearReconnectUrl();TS.ms.onFailure("rtm.checkFastReconnect returned not-OK. error: "+error)}).finally(function(){TS.model.calling_test_fast_reconnect=false})},setReconnectUrl:function(url){_reconnect_url=url;_reconnect_url_received_at=Date.now()},getReconnectUrl:function(){return _reconnect_url},sleep:function(){if(TS.model.ms_asleep)return;if(!TS.model.ms_connected)return;TS.model.ms_asleep=true;TS.ms.disconnect()},wake:function(){if(!TS.model.ms_asleep)return;TS.model.ms_asleep=false;TS.ms.startReconnection()},showConnectionTroubleDialog:function(){TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection.</p>				<p>We've seen this problem clear up with a restart of your browser, 				a solution which we suggest to you now only with great regret and self-loathing.</p>",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true})}});var _open_websocket_p;var _open_websocket_p_resolve;var _log_next_pong;var _have_sent_ping=false;var _measure_ping_pong_latency;var _time_since_last_ping_pong_metric;var _ping_pong_measurement_interval=5*60*1e3;var _check_ping_interv=0;var _check_ping_interv_ms=3e3;var _send_ping_interv=0;var _send_ping_interv_ms=1e4;var _implicit_pong_interv_ms=7e3;var _connect_timeout_tim=0;var _connect_timeout_tim_ms=0;var _connect_ws_timeout_tim_ms=1e4;var _connect_flash_timeout_tim_ms=2e4;var _hello_timeout_tim=0;var _hello_timeout_tim_ms=1e4;var _rtm_start_timeout_tim_ms=9e4;var _disconnect_timeout_tim=0;var _disconnect_timeout_tim_ms=5e3;var _reconnect_interv=0;var _reconnect_interv_ms=1e3;var _auto_reconnect_tim=0;var _websocket=null;var _msg_id=0;var _check_last_pong_time=false;var _pong_timeout_ms=0;var _away_limit_ms=3e5;var _connect_timeout_count=0;var _last_slack_broadcast_imsg=null;var _eventlog_per_page=2e3;var _reconnect_url=null;var _reconnect_url_received_at=null;var _last_connect_was_fast=false;var _reconnect_url_limit_ms=3e5;var _whence_last_event_ts;var _setPongTimeoutMs=function(has_focus){if(has_focus){_pong_timeout_ms=1e4}else{_pong_timeout_ms=6e4}_pong_timeout_ms+=_send_ping_interv_ms;TS.log(2,"MS _pong_timeout_ms set to:"+_pong_timeout_ms+" has_focus:"+has_focus)};var _onMsg=function(e){var data=e.data;if(data.charCodeAt(data.length-1)===0){var null_index=data.indexOf("\x00");if(null_index>=0){data=data.slice(0,null_index)}}var imsg=JSON.parse(data);TS.ms.handleMsg(imsg)};var _onConnect=function(e){clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(TS.model.attempting_fast_reconnect){_clearReconnectUrl();TS.metrics.measureAndClear("ms_fast_reconnect","ms_websocket_create");_last_connect_was_fast=true}else{TS.metrics.measureAndClear("ms_connect","ms_websocket_create");_last_connect_was_fast=false}if(_did_make_tokenless_connection){TS.ms.send({type:"mp_command",subtype:"login",url:_addQueryParamsToLoginUrl(TS.model.team.url)})}_maybeResolveOpenWebSocketPromise();_websocket.onmessage=_onMsg;TS.model.ms_conn_log.length=0;TSConnLogger.log("ms_connected","_onConnect (took "+(Date.now()-TS.ms.last_start_ms)+"ms)");TS.info("MS WS connected!");TS.ms.logConnectionFlow("on_connect");clearTimeout(_hello_timeout_tim);_hello_timeout_tim=setTimeout(_onHelloTimeout,_hello_timeout_tim_ms)};var _finishedProcessingEventLog=function(){if(TS.client)TS.shared.maybeFetchHistoryAndThenCheckConsistency(TS.shared.getActiveModelOb())};var _onEventLogError=function(resp){var args=resp.args;var data=resp.data;TS.error("_onEventLogError "+data);if(TS.client&&data&&data.error=="timestamp_too_old"){TS.storage.completelyEmptyAllStorageAndReset();var msg="TS.reload() after a TS.storage.completelyEmptyAllStorageAndReset() because data.error: <code>timestamp_too_old</code>";if(data.reason){msg+=" data.reason: <code>"+data.reason+"</code>"}if(args)delete args.token;try{msg+=" args: <pre>"+JSON.stringify(args,null,"	")+"</pre>"}catch(err){}msg+="<p><b>Tell #dhtml about this, please!</b></p>";setTimeout(function(){TS.reload(null,msg)},1);return null}_finishedProcessingEventLog();return null};var _onEventLogOK=function(resp){var data=resp.data;if(!data.events){TS.error("_onEventLogOK missing events");_finishedProcessingEventLog();return null}if(TS.client&&data.has_more){if(TS.boot_data.feature_ms_eventlog_changes){}else{TS.storage.completelyEmptyAllStorageAndReset()}TS.info("going to call TS.reload() after a TS.storage.completelyEmptyAllStorageAndReset() because data.has_more:"+data.has_more+")");setTimeout(function(){TS.reload(null,"TS.reload() after a TS.storage.completelyEmptyAllStorageAndReset() because data.has_more:"+data.has_more+")")},1);return null}var last_eventlog_ts;var imsgs_to_handle=[];var uniques_handled={};var unique_str;var _handleEvent=function(imsg){imsg._from_evt_log=true;unique_str=null;last_eventlog_ts=last_eventlog_ts||imsg.event_ts;if(imsg.type=="file_change"&&imsg.file&&imsg.file.id){unique_str=imsg.type+imsg.file.id}else if(imsg.type=="user_change"&&imsg.user&&imsg.user.id){unique_str=imsg.type+imsg.user.id}else if(imsg.type=="emoji_changed"){unique_str=imsg.type}else if(imsg.type=="channel_history_changed"&&imsg.channel){TS.info("eventlog: channel_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}else if(imsg.type=="group_history_changed"&&imsg.channel){TS.info("eventlog: group_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}else if(imsg.type=="im_history_changed"&&imsg.channel){TS.info("eventlog: im_history_changed for "+imsg.channel);unique_str=imsg.type+imsg.channel}if(unique_str){if(uniques_handled[unique_str])return;uniques_handled[unique_str]=true;imsgs_to_handle.unshift(imsg)}else if(imsg.type=="slack_broadcast"){if(!imsg.reload)return;var last=_last_slack_broadcast_imsg;if(last){if(!last.force_reload&&imsg.force_reload){_last_slack_broadcast_imsg=imsg}}else{_last_slack_broadcast_imsg=imsg}}else{imsgs_to_handle.unshift(imsg)}};_.forEachRight(data.events,_handleEvent);imsgs_to_handle.forEach(function(imsg){try{TS.ms.handleMsg(imsg)}catch(e){}});if(last_eventlog_ts){TS.ms.storeLastEventTS(last_eventlog_ts,"eventlog")}if(_last_slack_broadcast_imsg){try{TS.ms.handleMsg(_last_slack_broadcast_imsg)}catch(e){}_last_slack_broadcast_imsg=null}_finishedProcessingEventLog();return null};var _checkPings=function(){if(!_check_last_pong_time)return;var since_last_pong_ms=Date.now()-TS.ms.last_pong_time;TS.log(2,"MS since_last_pong_ms:"+since_last_pong_ms+" pong_timeout_ms:"+_pong_timeout_ms);if(since_last_pong_ms<_pong_timeout_ms)return;TS.warn("since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms);_maybePrintImsgLog();_maybeClearImsgLog();TS.warn("calling disconnect(), expect to get an onDisconnect() callback");TS.ms.logConnectionFlow("on_ping_timeout");TS.ms.trouble_sig.dispatch();_check_last_pong_time=false;_reportDisconnect("You are on team Tiny Speck, so here are some pong details:\n>>>"+"since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms+" ... calling disconnect(), expect to get an onDisconnect() callback");try{TS.ms.disconnect();clearTimeout(_disconnect_timeout_tim);_disconnect_timeout_tim=setTimeout(function(){TS.info("called disconnect, no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now");_onDisconnect(null,"since_last_pong_ms too long! then called disconnect, but no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now")},_disconnect_timeout_tim_ms)}catch(err){TS.info("since_last_pong_ms too long! then an error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now");TS.warn(err);_onDisconnect(null,"error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now")}};var _sendPing=function(){TS.ms.send({type:"ping"});if(_check_last_pong_time&&_have_sent_ping){TS.info("Sent another ping to MS; prior ping was never replied to");_log_next_pong=true}if(_measure_ping_pong_latency)TS.metrics.mark("ms_ping_sent");_check_last_pong_time=true;_have_sent_ping=true};var _onDisconnect=function(e,reason_str){reason_str=reason_str||"_onDisconnect called with event:"+e;TS.info("MS WS disconnected");TS.ms.logConnectionFlow("on_disconnect");clearTimeout(_disconnect_timeout_tim);clearTimeout(_hello_timeout_tim);clearTimeout(_connect_timeout_tim);_did_make_tokenless_connection=false;_did_make_provisional_connection=false;if(e){TS.info("_onDisconnect event.code:"+e.code);if(e.code==TS.ms.errors.CONNECTION_TROUBLE&&false){TS.generic_dialog.start({title:"Connection trouble error #1006",body:"Apologies, we're having some trouble with your connection. The particular error code indicates that restarting the application might fix it.",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}else{TS.info("no event")}if(_isReconnectUrlValid()){TS.model.attempting_fast_reconnect=true}TS.ms.onFailure(reason_str)};var _reportDisconnect=function(reason_str){return};var _deprecateCurrentSocket=function(){if(!_websocket)return;_websocket.onclose=null;_websocket.onerror=null;_websocket.onmessage=null;_websocket.onopen=null;try{_websocket.close()}catch(err){TS.info("Problem while deprecating current socket: "+err)}_websocket=undefined;_did_make_provisional_connection=false;TS.model.ms_connecting=false};var _onReconnectInterval=function(){var ms=TS.model.ms_reconnect_time-Date.now();var secs=Math.round(ms/1e3);if(secs>=0){TS.ms.reconnecting_sig.dispatch(secs)}if(TS.model.window_unloading){clearInterval(_reconnect_interv)}};var _onHelloTimeout=function(){var desc="socket received no hello msg "+_hello_timeout_tim_ms+"ms after connection";TS.warn(desc);TS.ms.logConnectionFlow("_onHelloTimeout");TS.ms.onFailure(desc)};var _onConnectTimeout=function(){_connect_timeout_count++;var desc="socket not connected "+_connect_timeout_tim_ms+"ms after creation. _connect_timeout_count:"+_connect_timeout_count;TS.warn(desc);TS.ms.logConnectionFlow("_onConnectTimeout");if(_connect_timeout_count==3){if(TS.model.is_chrome_desktop){TS.ms.showConnectionTroubleDialog()}else{TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection.</p>					<p>We've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 					a solution which we suggest to you now only with great regret and self-loathing.</p>					",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true})}return}else if(_connect_timeout_count==2){if(window.WEB_SOCKET_USING_FLASH){}else if(TS.model.is_chrome_desktop){_connect_ws_timeout_tim_ms=2e4;return}}TS.ms.onFailure(desc)};var _onError=function(e){var err_str="";if(e){if(e.name)err_str+=" e.name="+e.name;if(e.message)err_str+=" e.message="+e.message;if(e.data)err_str+=" e.data="+e.data}TS.warn("_onError err_str: "+err_str);TS.dir(0,e)};var _onErrorMsg=function(imsg){if(imsg.error){if(imsg.error.code==TS.ms.errors.BAD_TOKEN){TS.ms.logConnectionFlow("msg_error_code_1");_clearReconnectUrl()}else{if(imsg.error.code==TS.ms.errors.RATE_LIMIT){TS.client.activateMsgRateLimit({notify_user:true});TS.ms.connected_sig.addOnce(TS.client.deactivateMsgRateLimit)}TS.info("_onErrorMsg imsg.msg: "+imsg.msg+", imsg.code: "+imsg.code);TS.ms.onFailure("_onErrorMsg imsg.error:"+imsg.error)}}else{TS.info("_onErrorMsg imsg: "+(imsg?JSON.stringify(imsg):"no imsg?"))}};var _onHello=function(imsg){clearTimeout(_hello_timeout_tim);TS.ms.is_flannel=!!imsg.flannel;TSConnLogger.log("ms_hello","_onHello (took "+(Date.now()-TS.ms.last_start_ms)+"ms)");var since_last_pong_ms=Date.now()-TS.ms.last_pong_time;TS.info("Hello msg recvd, since_last_pong_ms:"+since_last_pong_ms);TS.ms.logConnectionFlow("on_hello");if(TS.client&&since_last_pong_ms>_away_limit_ms&&!_last_connect_was_fast){TS.client.ui.maybePromptForSetActive()}clearInterval(_reconnect_interv);_check_last_pong_time=true;TS.ms.last_pong_time=Date.now();clearInterval(_check_ping_interv);_check_ping_interv=setInterval(_checkPings,_check_ping_interv_ms);clearInterval(_send_ping_interv);_send_ping_interv=setInterval(_sendPing,_send_ping_interv_ms);TS.model.ms_connecting=false;TS.model.ms_connected=true;var last_event_ts=TS.storage.fetchLastEventTS();var should_consistency_check=true;if(TS.boot_data.feature_ms_eventlog_changes){should_consistency_check=!!TS.ms.num_times_connected}if(should_consistency_check){if(last_event_ts&&!_last_connect_was_fast){TS.info("calling eventlog.history with start:"+last_event_ts+" (from TS.storage.fetchLastEventTS())");if(_whence_last_event_ts)TS.info("last_event_ts is from "+_whence_last_event_ts);TS.api.callImmediately("eventlog.history",{start:last_event_ts,count:_eventlog_per_page,no_payload_if_has_more:true,batch_deleted_files:!!TS.boot_data.feature_batch_file_deleted_event}).then(_onEventLogOK).catch(_onEventLogError).finally(_.noop)}else{if(TS.client)TS.shared.maybeFetchHistoryAndThenCheckConsistency(TS.shared.getActiveModelOb())}}TS.ms.connected_sig.dispatch(_last_connect_was_fast);TS.ms.num_times_connected++;_sendPing()};var _isReconnectUrlValid=function(){if(!TS.ms.fast_reconnects_enabled)return false;if(!_reconnect_url)return false;var now=Date.now();var reconnect_url_age=now-_reconnect_url_received_at;if(reconnect_url_age<_reconnect_url_limit_ms)return true;_clearReconnectUrl();return false};var _clearReconnectUrl=function(){TS.model.attempting_fast_reconnect=false;_reconnect_url=null;_reconnect_url_received_at=null};var _onConnectProvisional;var _onDisconnectProvisional;var _onErrorProvisional;var _onMsgProvisional;var _did_make_provisional_connection;var _did_make_tokenless_connection;var _makeBufferHandler=function(fn){var buf=[];var handler=function(){if(typeof fn=="function"){var should_buffer=fn.apply(this,arguments);if(should_buffer===false)return}buf.push({this_arg:this,args:arguments})};handler.replay=function(handler){buf.forEach(function(invocation){handler.apply(invocation.this_arg,invocation.args)});buf.length=0};return handler};var _startConnectTimeout=function(){_connect_timeout_tim_ms=window.WEB_SOCKET_USING_FLASH?_connect_flash_timeout_tim_ms:_connect_ws_timeout_tim_ms;clearTimeout(_connect_timeout_tim);_connect_timeout_tim=setTimeout(_onConnectTimeout,_connect_timeout_tim_ms)};var _addQueryParamsToLoginUrl=function(url){url=TS.utility.url.setUrlQueryStringValue(url,"version_uid",TS.boot_data.version_uid);url=TS.utility.appendLogToUrlWithLimit(url,TS.ms.getConnectionFlowLog());url=TS.utility.url.setUrlQueryStringValue(url,"batch_presence_aware",1);return url};var _pong_log=[];var _maybePrintImsgLog=function(){TS.info("Previous imsg events:\n========"+_pong_log.join("\n")+"========")};var _maybeClearImsgLog=function(){_pong_log.length=0};var _maybeAddToImsgLog=function(imsg){imsg=imsg.SENT_MSG||imsg;var msg_desc=imsg.subtype?imsg.type+"."+imsg.subtype:imsg.type;_pong_log.push(TS.makeLogDate()+msg_desc)};var _handleConnectAfterProvisionalConnection=function(){if(_websocket.readyState!=WebSocket.OPEN){_startConnectTimeout()}_onConnectProvisional.replay(_onConnect);_onDisconnectProvisional.replay(_onDisconnect);_onErrorProvisional.replay(_onError);_onMsgProvisional.replay(_onMsg);_websocket.onopen=_onConnect;_websocket.onclose=_onDisconnect;_websocket.onerror=_onError;_onConnectProvisional=undefined;_onDisconnectProvisional=undefined;_onErrorProvisional=undefined;_onMsgProvisional=undefined};var _createNewSocket=function(url){if(TS.lazyLoadMembersAndBots()){url=TS.utility.url.setUrlQueryStringValue(url,"flannel",1);url=TS.utility.url.setUrlQueryStringValue(url,"token",TS.boot_data.api_token);if(TS.boot_data.version_ts==="dev"&&TS.boot_data.should_use_flannel){url=TS.utility.url.setUrlQueryStringValue(url,"api_url",TS.boot_data.flannel_api_url)}if(_shouldUseFlannelCanary()){url=TS.utility.url.setUrlQueryStringValue(url,"canary",1)}TS.log(1989,"Connecting to Flannel..."+url)}TS.ms.logConnectionFlow("connect");TS.info("Connecting to: "+url);clearTimeout(_connect_timeout_tim);TS.ms.last_url=url;TS.ms.last_start_ms=Date.now();TS.metrics.mark("ms_websocket_create");try{_websocket=new WebSocket(url)}catch(error){TS.warn("failed to create new WebSocket");TS.error(error);TS.ms.onFailure("failed to create new WebSocket");return false}return true};var _initSocketHandlersProvisional=function(){_did_make_provisional_connection=true;_did_make_tokenless_connection=true;_onConnectProvisional=_makeBufferHandler();_onDisconnectProvisional=_makeBufferHandler();_onErrorProvisional=_makeBufferHandler();_onMsgProvisional=_makeBufferHandler();_websocket.onclose=_onDisconnectProvisional;_websocket.onerror=_onErrorProvisional;_websocket.onmessage=_onMsgProvisional;_websocket.onopen=_onConnectProvisional};var _initSocketHandlersProvisionalRtmStart=function(){_did_make_provisional_connection=true;var rtm_start_p=new Promise(function(resolve,reject){var abortRtmStartAttempt=function(err){TS.warn("Giving up on rtm.start-over-MS attempt");clearTimeout(rtm_start_timeout);rtm_start_timeout=undefined;TS.ms.fast_reconnects_enabled=true;if(rtm_start_p&&!rtm_start_p.isPending()){TS.warn("Timeout fired after promise has been rejected; this is a programming error.");return}reject(err);_deprecateCurrentSocket()};var rtm_start_timeout=setTimeout(function(){abortRtmStartAttempt(new Error("Waited "+_rtm_start_timeout_tim_ms+" ms for rtm.start response but didn't get one"))},_rtm_start_timeout_tim_ms);_onConnectProvisional=_makeBufferHandler(_maybeResolveOpenWebSocketPromise);_onDisconnectProvisional=_makeBufferHandler(function(){if(rtm_start_p&&rtm_start_p.isPending()){abortRtmStartAttempt(new Error("WebSocket got disconnected"))}});_onErrorProvisional=_makeBufferHandler(function(e){if(rtm_start_p&&rtm_start_p.isPending()){var err=new Error("WebSocket got error");err.event=e;abortRtmStartAttempt(err)}});_onMsgProvisional=_makeBufferHandler(function(e){var imsg=JSON.parse(e.data);if(imsg.type=="flannel"&&imsg.subtype=="query_response"){if(!imsg.reply_to){TS.error("Received a pre-connection Flannel query response without a reply_to field: "+e.data);return}else if(!TS.ms.sent_map[imsg.reply_to.toString()]){TS.error("Received a pre-connection Flannel query response for a query we did not send: "+e.data);return}var original_sent_msg=_processReplyMessage(imsg);if(original_sent_msg&&_.isFunction(original_sent_msg.handler)){original_sent_msg.handler(imsg.ok,imsg)}return false}if(rtm_start_p&&rtm_start_p.isPending()){if(imsg.type=="hello"){clearTimeout(rtm_start_timeout);rtm_start_timeout=undefined;if(imsg.flannel&&imsg.start){var rtm_start_data=imsg.start;resolve(rtm_start_data)}else{abortRtmStartAttempt(new Error("`hello` imsg did not include rtm.start data"))}}}});_websocket.onclose=_onDisconnectProvisional;_websocket.onerror=_onErrorProvisional;_websocket.onmessage=_onMsgProvisional;_websocket.onopen=_onConnectProvisional}).catch(function(err){TS.logError(err,"rtm-start-over-MS error","Flannel error");throw err});return rtm_start_p};var _initSocketHandlersImmediate=function(){_websocket.onopen=_onConnect;_websocket.onclose=_onDisconnect;_websocket.onerror=_onError;_startConnectTimeout()};var _processReplyMessage=function(imsg){if(!imsg.reply_to)return;var sent=TS.ms.sent_map[imsg.reply_to];if(!sent)return;imsg.SENT_MSG=sent.msg;delete TS.ms.sent_map[imsg.reply_to];return sent};var _shouldUseFlannelCanary=function(){var canary_pref=_.get(TS,"model.prefs.flannel_server_pool",TS.boot_data.flannel_server_pool);switch(canary_pref){case"canary":return true;case"random":return _.random(0,1)==0;case"production":default:return false}};var _finalizeProvisionalConnection=function(connection_type){if(_did_make_provisional_connection&&!_websocket){_did_make_provisional_connection=false;TS.warn("TS.ms.connect called while _did_make_provisional_connection flag is true, but there is no _websocket. This is a programming error.")}if(_did_make_provisional_connection){_did_make_provisional_connection=false;if(connection_type!==undefined)return;_handleConnectAfterProvisionalConnection();return true}return false};var _connect=function(url){TSConnLogger.log("ms_connecting","TS.ms.connect "+url);if(_websocket&&_websocket.readyState==WebSocket.OPEN){TS.warn("TS.ms has an open WebSocket but we are trying to connect; TS.model.ms_connected = "+TS.model.ms_connected+"; TS.model.ms_connecting = "+TS.model.ms_connecting);throw new Error("TS.ms.connect called but we are already connected. This is a programming error.")}var did_create=_createNewSocket(url);if(!did_create){throw new Error("Error creating WebSocket for URL "+url)}TS.model.ms_connecting=true};var _maybeResolveOpenWebSocketPromise=function(){if(!_open_websocket_p_resolve)return;_open_websocket_p_resolve();_open_websocket_p=undefined;_open_websocket_p_resolve=undefined}})();(function(){"use strict";TS.registerModule("ms.msg_handlers",{onStart:function(){TS.ms.on_msg_sig.add(TS.ms.msg_handlers.msgReceived)},msgReceivedFromParentWindow:function(imsg){TS.ms.msg_handlers.msgReceived(imsg)},msgReceived:function(imsg){if(TS.boot_data.feature_tinyspeck&&imsg.user==="USLACKBOT"&&REMINDER_REGEXP.test(imsg.text)){TS.info("Reminder debug message for bug #24000:",imsg)}if(imsg.reply_to)return;if(!TS.ms.msg_handlers[imsg.type])return;_addToQ(imsg)},message:function(imsg){if(!TS.client)return;TS.log(2,"recved message type "+imsg.type);if(imsg.is_ephemeral&&!imsg.ts){imsg.ts=TS.utility.date.makeTsStamp()}var subtype_method_name="subtype__"+imsg.subtype;if(subtype_method_name in TS.ms.msg_handlers){if(TS.boot_data.feature_channel_eventlog_client){if(imsg.subtype=="message_changed"||imsg.subtype=="message_deleted"||imsg.subtype=="channel_history_changed"||imsg.subtype=="group_history_changed"||imsg.subtype=="im_history_changed"||imsg.subtype=="mpim_history_changed"||imsg.subtype=="message_replied"){imsg.type=imsg.subtype;delete imsg.subtype;TS.ms.msg_handlers[imsg.type](imsg);return}if(imsg.hidden){console.error("WE SHOULD NOT BE GETTING ANY HIDDEN MESSAGES ANYMORE");console.dir(0,imsg)}}TS.ms.msg_handlers[subtype_method_name](imsg)}var msg=TS.utility.msgs.processImsg(imsg,imsg.channel);if(TS.ims.getImById(imsg.channel)){if(imsg.text=="start_profile_AAAAAA"){TS.model.profiling_keys=true}else if(imsg.text=="end_profile_AAAAAA"){TS.model.profiling_keys=false;if(TS.model.profiling_key_times){TS.files.upload({text:JSON.stringify(TS.model.profiling_key_times,null,"	"),title:"auto profile",filetype:"javascript",channels:[imsg.channel],initial_comment:""});delete TS.model.profiling_key_times}}TS.ims.addMsg(imsg.channel,msg)}else if(TS.mpims.getMpimById(imsg.channel)){TS.mpims.addMsg(imsg.channel,msg)}else if(TS.groups.getGroupById(imsg.channel)){TS.groups.addMsg(imsg.channel,msg)}else{TS.channels.addMsg(imsg.channel,msg)}var model_ob=TS.shared.getModelObById(imsg.channel);var member=TS.members.getMemberById(msg.user);if(TS.typing&&member&&model_ob)TS.typing.memberEnded(model_ob,member)},subtype__file_share:function(imsg){if(!imsg.file)return;if(imsg.file.id==TS.files.polling_file_id){TS.files.uploadProcessingOver(true,imsg.file.id)}},message_changed:function(imsg){TS.log(2,"recved message type "+imsg.type);TS.ms.msg_handlers.message_changed_worker(imsg)},subtype__message_changed:function(imsg){TS.log(2,"recved subtype "+imsg.subtype);if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.message_changed_worker(imsg)},message_changed_worker:function(imsg){if(!imsg.message){TS.error("no message?");return}TS.mentions.replaceMsg(imsg.message);var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error("unknown imsg.channel:"+imsg.channel);return}if(TS.pins){TS.pins.replaceMsg(imsg.message,model_ob)}if(imsg.message.imgs||TS.utility.msgs.hasImgs(imsg.message)){TS.model.show_inline_img_size_pref_reminder=true}var might_not_exist=true;TS.utility.msgs.replaceMsg(model_ob,imsg.message,might_not_exist)},message_deleted:function(imsg){TS.log(2,"recved message type "+imsg.type);TS.ms.msg_handlers.message_deleted_worker(imsg)},subtype__message_deleted:function(imsg){TS.log(2,"recved subtype "+imsg.subtype);if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.message_deleted_worker(imsg)},message_deleted_worker:function(imsg){if(!imsg.deleted_ts){TS.error("no deleted_ts?");return}TS.mentions.removeMsg(imsg.deleted_ts);var channel=TS.channels.getChannelById(imsg.channel);var im;var group;var mpim;if(!channel)im=TS.ims.getImById(imsg.channel);if(!channel&&!im)mpim=TS.mpims.getMpimById(imsg.channel);if(!channel&&!im&&!mpim)group=TS.groups.getGroupById(imsg.channel);if(!im&&!channel&&!mpim&&!group){TS.error("unknown imsg.channel:"+imsg.channel);return}var model_ob=im||channel||mpim||group;if(TS.pins){TS.pins.removeMsg(imsg.deleted_ts,model_ob)}var original_msg=TS.utility.msgs.getMsg(imsg.deleted_ts,model_ob.msgs);if(!original_msg&&model_ob._archive_msgs){original_msg=TS.utility.msgs.getMsg(imsg.deleted_ts,model_ob._archive_msgs)}if(TS.boot_data.feature_unread_view&&!original_msg){original_msg=TS.client.unread.getMessage(model_ob,imsg.deleted_ts)}if(TS.boot_data.feature_message_replies&&!original_msg){original_msg=TS.ui.replies.getActiveMessage(model_ob,imsg.deleted_ts)}if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing&&!original_msg){original_msg=TS.client.threads.getMessage(model_ob,imsg.deleted_ts)}if(!original_msg){return}if(im){TS.ims.removeMsg(model_ob.id,original_msg)}else if(channel){TS.channels.removeMsg(model_ob.id,original_msg)}else if(mpim){TS.mpims.removeMsg(model_ob.id,original_msg)}else if(group){TS.groups.removeMsg(model_ob.id,original_msg)}},subtype__sh_room_created:function(imsg){if(!TS.boot_data.feature_calls)return;if(!imsg.room)return;TS.dir(441,imsg)},subtype__sh_room_shared:function(imsg){if(!TS.boot_data.feature_calls)return;if(!imsg.room)return;TS.dir(441,imsg)},channel_left:function(imsg){TS.info("You left channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}channel.is_member=false;if(TS.model.active_channel_id==imsg.channel&&!channel.was_archived_this_session){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.channels.calcUnreadCnts(channel,true);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.left_sig.dispatch(channel)},subtype__channel_leave:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" left channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);if(channel){for(var i=0;i<channel.members.length;i++){if(channel.members[i]==member.id){channel.members.splice(i,1);TS.channels.calcActiveMembersForChannel(channel);break}}}TS.members.invalidateMembersUserCanSeeArrayCaches();if(channel)TS.channels.member_left_sig.dispatch(channel,member)},member_left_channel:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(channel&&channel.is_shared)TS.ms.msg_handlers.subtype__channel_leave(imsg)},channel_joined:function(imsg){TS.info("You joined channel "+imsg.channel.name);var channel=TS.channels.upsertChannel(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.channels.joined_sig.dispatch(channel)},channel_created:function(imsg){if(TS.model.user.is_restricted)return;TS.info("created channel "+imsg.channel.name);var channel=TS.channels.upsertChannel(imsg.channel);TS.channels.created_sig.dispatch(channel)},channel_converted_to_shared:function(imsg){if(!imsg.channel||!imsg.channel.id){TS.error("No channel info sent");return}var channel=TS.channels.getChannelById(imsg.channel.id);if(!channel){TS.error('unknown channel: "'+imsg.channel.id);return}if(_.isUndefined(imsg.channel.is_member))imsg.channel.is_member=false;imsg.channel.is_member=false;if(channel.is_member)imsg.channel.is_member=true;TS.channels.upsertChannel(imsg.channel);if(channel._name_lc!==_.toLower(imsg.channel.name))TS.channels.channelRenamed(imsg.channel);if(TS.client)TS.client.channel_pane.rebuild("channels");var current_ob=TS.shared.getActiveModelOb();if(current_ob.id===channel.id){TS.channels.converted_to_shared_sig.dispatch(channel)}},group_converted_to_shared:function(imsg){if(!imsg.group||!imsg.group.id){TS.error("No group info sent");return}var group=TS.groups.getGroupById(imsg.group.id);if(!group){TS.error('unknown group: "'+imsg.group.id);return}if(group.is_member)imsg.group.is_member=true;TS.groups.upsertGroup(imsg.group);if(TS.client)TS.client.channel_pane.rebuild("channels");var current_ob=TS.shared.getActiveModelOb();if(current_ob.id===group.id){TS.groups.converted_to_shared_sig.dispatch(group)}},teams_joined_shared_channel:function(imsg){if(!TS.boot_data.page_needs_enterprise){TS.error("shared channel event sent to non-enterprise team:"+imsg.channel);return}var channel=TS.channels.getChannelById(imsg.channel);if(!channel)channel=TS.groups.getGroupById(imsg.channel);if(!channel){TS.error('unknown channel or group: "'+imsg.channel);return}if(!channel.is_shared){TS.error("shared channel event sent for non-shared channel:"+imsg.channel);return}TS.enterprise.addTeamsToSharedForChannel(channel,imsg.teams);var current_ob=TS.shared.getActiveModelOb();if(!current_ob.id===channel.id)return;if(channel.is_group){TS.groups.shared_teams_updated_sig.dispatch(channel)}else{TS.channels.shared_teams_updated_sig.dispatch(channel)}},teams_left_shared_channel:function(imsg){if(!TS.boot_data.page_needs_enterprise){TS.error("shared channel event sent to non-enterprise team:"+imsg.channel);return}var channel=TS.channels.getChannelById(imsg.channel);if(!channel)channel=TS.groups.getGroupById(imsg.channel);if(!channel){TS.error('unknown channel or group: "'+imsg.channel);return}if(!channel.is_shared){TS.error("shared channel event sent for non-shared channel:"+imsg.channel);return}TS.enterprise.updateSharesForChannel(channel,imsg.teams);var current_ob=TS.shared.getActiveModelOb();if(!current_ob.id===channel.id)return;if(channel.is_group){TS.groups.shared_teams_updated_sig.dispatch(channel)}else{TS.channels.shared_teams_updated_sig.dispatch(channel);
}},enterprise_rename:function(imsg){TS.model.enterprise.name=imsg.name;var $slack_menu=$(".team_menu.slack_menu");$slack_menu.find(".slack_menu_header .current_team_name").text(TS.model.enterprise.name);$slack_menu.find(".menu_list .enterprise_logout_url a strong").text(TS.model.enterprise.name);$(".enterprise-name").text(TS.model.enterprise.name)},channel_deleted:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}TS.info("deleted channel "+imsg.channel);TS.channels.removeChannel(channel)},channel_archive:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}if(channel.is_archived){return}TS.info("archived channel "+imsg.channel);channel.members.length=0;TS.channels.calcActiveMembersForChannel(channel);channel.is_archived=true;if(!TS.model.user.is_restricted){if(channel.is_member){channel.was_archived_this_session=true}}TS.channels.archived_sig.dispatch(channel)},channel_unarchive:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}if(!channel.is_archived){return}TS.info("unarchived channel "+imsg.channel);if(channel.was_archived_this_session){var in_background=true;TS.channels.join(channel.name,null,in_background)}channel.is_archived=false;channel.was_archived_this_session=false;TS.channels.unarchived_sig.dispatch(channel)},channel_rename:function(imsg){var channel=TS.channels.getChannelById(imsg.channel.id);if(!channel){TS.error('unknown channel: "'+imsg.channel);return}TS.info("renamed channel "+imsg.channel.id+" to "+imsg.channel.name);TS.channels.channelRenamed(imsg.channel)},subtype__channel_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" joined channel "+imsg.channel);var channel=TS.channels.getChannelById(imsg.channel);var existing_member_id;if(channel){for(var i=0;i<channel.members.length;i++){if(channel.members[i]==member.id){existing_member_id=channel.members[i];break}}}if(!existing_member_id&&channel){channel.members.push(member.id);TS.channels.calcActiveMembersForChannel(channel)}if(member.is_self&&imsg.inviter){channel.needs_invited_message=true;channel.inviter=imsg.inviter}TS.members.invalidateMembersUserCanSeeArrayCaches();if(channel)TS.channels.member_joined_sig.dispatch(channel,member)},member_joined_channel:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(channel&&channel.is_shared)TS.ms.msg_handlers.subtype__channel_join(imsg)},channel_marked:function(imsg){if(!TS.client)return;var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}channel.needs_invited_message=false;delete TS.model.last_reads_set_by_client[channel.id+"_"+imsg.ts];if(TS.boot_data.feature_tinyspeck&&channel.last_read!==imsg.ts)TS.info("channel_marked for "+channel.id+", "+channel.last_read+" -> "+imsg.ts);TS.channels.setLastRead(channel,imsg.ts)},subtype__channel_topic:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed topic for channel "+imsg.channel+" to "+imsg.topic);TS.channels.topicChanged(channel,member.id,imsg.ts,imsg.topic)},subtype__channel_purpose:function(imsg){var channel=TS.channels.getChannelById(imsg.channel);if(!channel){TS.error('unknown channel: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed purpose for channel "+imsg.channel+" to "+imsg.purpose);TS.channels.purposeChanged(channel,member.id,imsg.ts,imsg.purpose)},channel_history_changed:function(imsg){TS.ms.msg_handlers.channel_history_changed_worker(imsg)},subtype__channel_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.channel_history_changed_worker(imsg)},channel_history_changed_worker:function(imsg){TS.info("channel_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.channels)},mpim_joined:function(imsg){var existing_mpim=TS.mpims.getMpimById(imsg.channel.id);if(existing_mpim){return}var mpim=TS.mpims.upsertMpim(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.mpims.joined_sig.dispatch(mpim);if(TS.client)TS.shared.checkInitialMsgHistory(mpim,TS.mpims)},subtype__mpim_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" joined mpim "+imsg.channel);return},mpim_open:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error("unknown mpim! "+imsg.channel);return}mpim.is_open=true;if(TS.model.requested_mpim_opens[imsg.channel]){TS.mpims.displayMpim(mpim.id,false,TS.model.requested_mpim_opens[imsg.channel].and_send_txt);delete TS.model.requested_mpim_opens[imsg.channel]}mpim.opened_this_session=true;TS.mpims.opened_sig.dispatch(mpim);if(TS.client)TS.shared.checkInitialMsgHistory(mpim,TS.mpims)},mpim_close:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error('unknown mpim: "'+imsg.channel+'"');return}mpim.is_open=false;var converted_to=imsg.converted_to;if(converted_to&&TS.groups.getGroupById(converted_to)){mpim.latest=null;TS.shared.moveLastMsgInput(mpim,TS.groups.getGroupById(converted_to))}if(TS.model.active_mpim_id==imsg.channel){if(TS.client&&converted_to&&TS.groups.getGroupById(converted_to)){TS.groups.displayGroup(converted_to)}else if(TS.client){TS.client.activeChannelDisplayGoneAway()}}TS.mpims.closed_sig.dispatch(mpim)},mpim_marked:function(imsg){if(!TS.client)return;var mpim=TS.mpims.getMpimById(imsg.channel);if(!mpim){TS.error('unknown mpim: "'+imsg.channel+'"');return}mpim.needs_invited_message=false;delete TS.model.last_reads_set_by_client[mpim.id+"_"+imsg.ts];TS.mpims.setLastRead(mpim,imsg.ts)},mpim_history_changed:function(imsg){TS.ms.msg_handlers.mpim_history_changed_worker(imsg)},subtype__mpim_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.mpim_history_changed_worker(imsg)},mpim_history_changed_worker:function(imsg){TS.info("mpim_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.mpims)},group_left:function(imsg){TS.info("You left group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}TS.groups.removeGroup(group);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.left_sig.dispatch(group)},subtype__group_leave:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" left group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);if(group){for(var i=0;i<group.members.length;i++){if(group.members[i]==member.id){group.members.splice(i,1);TS.groups.calcActiveMembersForGroup(group);break}}}TS.members.invalidateMembersUserCanSeeArrayCaches();if(group)TS.groups.member_left_sig.dispatch(group,member)},member_left_group:function(imsg){TS.ms.msg_handlers.subtype__group_leave(imsg)},group_joined:function(imsg){TS.info("You joined group "+imsg.channel.name);if(imsg.channel.is_mpim)return;var existing_group=TS.groups.getGroupById(imsg.channel.name);if(existing_group){TS.error("should not be getting a group_joined message if we already know about the group: "+imsg.channel.name+" "+imsg.channel.id);return}var group=TS.groups.upsertGroup(imsg.channel);TS.members.invalidateMembersUserCanSeeArrayCaches();TS.groups.joined_sig.dispatch(group);if(TS.client)TS.shared.checkInitialMsgHistory(group,TS.groups)},group_deleted:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}TS.info("deleted group "+imsg.channel);TS.groups.removeGroup(group)},group_archive:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}if(group.is_archived){return}TS.info("archived group "+imsg.channel);group.is_archived=true;if(group.is_open){group.was_archived_this_session=true}TS.groups.archived_sig.dispatch(group)},group_unarchive:function(imsg){var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel);return}if(!group.is_archived){return}TS.info("unarchived group "+imsg.channel);group.is_archived=false;group.was_archived_this_session=false;TS.groups.unarchived_sig.dispatch(group)},group_rename:function(imsg){var group=TS.groups.getGroupById(imsg.channel.id);if(!group){TS.error('unknown group: "'+imsg.channel.id);return}TS.info("renamed group "+imsg.channel.id+" to "+imsg.channel.name);TS.groups.groupRenamed(imsg.channel)},subtype__group_join:function(imsg){var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}if(imsg.is_mpim)return;TS.info(member.name+" joined group "+imsg.channel);var group=TS.groups.getGroupById(imsg.channel);var existing_member_id;if(group){for(var i=0;i<group.members.length;i++){if(group.members[i]==member.id){existing_member_id=group.members[i];break}}}if(!existing_member_id&&group){group.members.push(member.id);TS.groups.calcActiveMembersForGroup(group)}if(member.is_self&&imsg.inviter){group.needs_invited_message=true;group.inviter=imsg.inviter}TS.members.invalidateMembersUserCanSeeArrayCaches();if(group)TS.groups.member_joined_sig.dispatch(group,member)},member_joined_group:function(imsg){TS.ms.msg_handlers.subtype__group_join(imsg)},group_open:function(imsg){if(TS.mpims.getMpimById(imsg.channel)){return TS.ms.msg_handlers.mpim_open(imsg)}var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error("unknown group! "+imsg.channel);return}group.is_open=true;if(TS.model.requested_group_opens[imsg.channel]){TS.groups.displayGroup(group.id,false,TS.model.requested_group_opens[imsg.channel].and_send_txt);delete TS.model.requested_group_opens[imsg.channel]}group.opened_this_session=true;TS.groups.opened_sig.dispatch(group);if(TS.client)TS.shared.checkInitialMsgHistory(group,TS.groups)},group_marked:function(imsg){if(!TS.client)return;if(TS.mpims.getMpimById(imsg.channel)){return TS.ms.msg_handlers.mpim_marked(imsg)}var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}group.needs_invited_message=false;delete TS.model.last_reads_set_by_client[group.id+"_"+imsg.ts];TS.groups.setLastRead(group,imsg.ts)},group_close:function(imsg){if(TS.mpims.getMpimById(imsg.channel))return;var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}group.is_open=false;if(TS.model.active_group_id==imsg.channel){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.groups.closed_sig.dispatch(group)},subtype__group_topic:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(mpim)return;var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed topic for group "+imsg.channel+" to "+imsg.topic);TS.groups.topicChanged(group,member.id,imsg.ts,imsg.topic)},subtype__group_purpose:function(imsg){var mpim=TS.mpims.getMpimById(imsg.channel);if(mpim)return;var group=TS.groups.getGroupById(imsg.channel);if(!group){TS.error('unknown group: "'+imsg.channel+'"');return}var user_id=imsg.user;var member=TS.members.getMemberById(user_id);if(!member){TS.error('unknown member: "'+user_id+'"');return}TS.info(member.name+" changed purpose for group "+imsg.channel+" to "+imsg.purpose);TS.groups.purposeChanged(group,member.id,imsg.ts,imsg.purpose)},group_history_changed:function(imsg){TS.ms.msg_handlers.group_history_changed_worker(imsg)},subtype__group_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.group_history_changed_worker(imsg)},group_history_changed_worker:function(imsg){if(imsg.is_mpim)return;TS.info("group_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.groups)},im_created:function(imsg){var im=TS.ims.getImById(imsg.channel.id);if(im){TS.warn("we already have an im for this user: "+imsg.user);return}TS.ims.upsertIm(imsg.channel);im=TS.ims.getImById(imsg.channel.id);if(!im){TS.error("WTF why can we not find this im: "+imsg.channel.id);return}var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}TS.members.invalidateMembersUserCanSeeArrayCaches();if(im.is_open){if(TS.model.requested_im_opens[member.id]){TS.ims.displayIm(im.id,false,TS.model.requested_im_opens[member.id].and_send_txt);delete TS.model.requested_im_opens[member.id]}TS.ims.opened_sig.dispatch(im)}im.opened_this_session=true},im_open:function(imsg){var im=TS.ims.getImById(imsg.channel);if(!im){TS.error("unknown im! "+imsg.channel);return}im.is_open=true;var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(TS.model.requested_im_opens[member.id]){TS.ims.displayIm(im.id,false,TS.model.requested_im_opens[member.id].and_send_txt);delete TS.model.requested_im_opens[member.id]}im.opened_this_session=true;TS.ims.opened_sig.dispatch(im);if(TS.client)TS.shared.checkInitialMsgHistory(im,TS.ims)},im_marked:function(imsg){if(!TS.client)return;var im=TS.ims.getImById(imsg.channel);if(!im){TS.error('unknown im: "'+imsg.channel+'"');return}delete TS.model.last_reads_set_by_client[im.id+"_"+imsg.ts];TS.ims.setLastRead(im,imsg.ts)},im_close:function(imsg){var im=TS.ims.getImById(imsg.channel);if(!im){TS.error('unknown im: "'+imsg.channel+'"');return}if(!im.is_open)return;im.is_open=false;if(TS.model.active_im_id==imsg.channel){if(TS.client)TS.client.activeChannelDisplayGoneAway()}TS.ims.closed_sig.dispatch(im)},im_history_changed:function(imsg){TS.ms.msg_handlers.im_history_changed_worker(imsg)},subtype__im_history_changed:function(imsg){if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.im_history_changed_worker(imsg)},im_history_changed_worker:function(imsg){TS.info("im_history_changed for "+imsg.channel);return _sharedHistoryChangedWorker(imsg,TS.ims)},manual_presence_change:function(imsg){var user=TS.model.user;if(imsg.presence!="away"&&imsg.presence!="active"){TS.error('unknown presence: "'+imsg.presence+'"');return}user.manual_presence=imsg.presence;TS.members.presence_changed_sig.dispatch(user)},presence_change:function(imsg){imsg.team=imsg.team||TS.model.team.id;if(imsg.hasOwnProperty("users")&&_.isArray(imsg.users)){imsg.users.forEach(function(member_id){_setMemberPresence(member_id,imsg.presence)})}else{_setMemberPresence(imsg.user,imsg.presence)}},status_change:function(imsg){var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(member.status==imsg.status)return;member.status=imsg.status;TS.members.status_changed_sig.dispatch(member)},user_can_manage_shared_channels:function(imsg){TS.prefs.updateTeamPrefCanUserManageSharedChannels(imsg)},pref_change:function(imsg){TS.prefs.onPrefChanged(imsg)},team_pref_change:function(imsg){TS.prefs.onTeamPrefChanged(imsg)},user_read_only_channels:function(imsg){TS.channels.read_only.updateList(imsg.channel_ids)},team_profile_change:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_profile_reorder:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_profile_delete:function(imsg){TS.team.upsertAndSignal({profile:imsg.profile})},team_plan_change:function(imsg){TS.team.team_plan_changed_sig.dispatch(imsg)},file_created:function(imsg){var was_file=TS.files.getFileById(imsg.file.id);if(was_file){TS.warn("we already know about this file, which probably means the files.upload response came in before this message (so np) "+imsg.file.id)}else{TS.files.upsertAndSignal(imsg.file)}},file_public:function(imsg){TS.files.upsertAndSignal(imsg.file)},file_deleted:function(imsg){var ids=imsg.file_ids||[imsg.file_id];ids.forEach(function(file_id){TS.files.removeFile(file_id)})},file_private:function(imsg){TS.files.fetchFileInfo(imsg.file_id)},file_change:function(imsg){TS.files.upsertAndSignal(imsg.file);TS.files.fileWasMaybeRefreshed(imsg.file)},file_shared:function(imsg){TS.files.upsertAndSignal(imsg.file);TS.files.team_file_shared_sig.dispatch(imsg.file)},file_unshared:function(imsg){TS.files.upsertAndSignal(imsg.file)},file_comment_added:function(imsg){var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}if(!TS.files.editCommentOnFile(imsg.comment,was_file)){TS.files.addCommentToFile(imsg.comment,was_file)}TS.files.upsertFile(imsg.file)},file_comment_edited:function(imsg){var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}TS.files.editCommentOnFile(imsg.comment,was_file);TS.files.upsertFile(imsg.file)},file_comment_deleted:function(imsg){var was_file=TS.files.getFileById(imsg.file.id);if(!was_file){return}TS.files.deleteCommentOnFile(imsg.comment,was_file);TS.files.upsertFile(imsg.file)},hello:function(imsg){},goodbye:function(imsg){if(!TS.boot_data.feature_flannel_fe)return;TS.ms.disconnect()},team_join:function(imsg){var member=imsg.user;TS.info(member.name+" joined the team");TS.members.upsertMember(member);member=TS.members.getMemberById(member.id);if(!member){TS.error("team_join: wtf no member "+member.id+"?");return}TS.members.joined_team_sig.dispatch(member);if(TS.client)TS.view.showProperTeamPaneFiller()},user_change:function(imsg){var member=TS.members.getMemberById(imsg.user.id);if(TS.lazyLoadMembersAndBots()){if(_.has(imsg,"user.id")&&_.has(imsg,"user.deleted")){var did_change_deleted_status=TS.flannel.setMemberDeletedStatus(imsg.user.id,!!imsg.user.deleted);if(did_change_deleted_status&&TS.client){var model_ob=TS.shared.getActiveModelOb();if(!member&&model_ob&&_.includes(model_ob.members,imsg.user.id)){if(!_did_queue_rebuild_member_list_toggle){_did_queue_rebuild_member_list_toggle=true;TS.utility.rAF(function(){_did_queue_rebuild_member_list_toggle=false;TS.client.ui.rebuildMemberListToggle()})}}}}if(!member){TS.log(1989,"Flannel: user_change for member not in model; ignoring");return}}if(!member){TS.error("user_change: wtf no member "+imsg.user.id+"?");return}if(imsg.user&&imsg.user.id===TS.model.user.id){if(TS.boot_data.feature_hide_email_pref&&TS.model.team&&TS.model.team.prefs&&!TS.model.team.prefs.display_email_addresses&&imsg.user.profile&&!imsg.user.profile.email){var local_email=member.profile&&member.profile.email;if(local_email){TS.info("user_change: email hidden via team pref. appending email from model for local user, so it is not lost in upsert.");imsg.user.profile.email=local_email}}}TS.members.upsertAndSignal(imsg.user)},star_added:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(!member.is_self)return;TS.stars.userStarStatusHasChanged(true,imsg.item,imsg.type);TS.stars.maybeUpdateUserStarredList({delta:1})},star_removed:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}if(!member.is_self)return;TS.stars.userStarStatusHasChanged(false,imsg.item,imsg.type);TS.stars.maybeUpdateUserStarredList()},reaction_added:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}TS.rxns.changeRxnsFromIMsg(imsg)},reaction_removed:function(imsg){if(!imsg.item){TS.error(imsg.type+" has no item");return}TS.rxns.changeRxnsFromIMsg(imsg)},email_domain_changed:function(imsg){TS.team.upsertAndSignal({email_domain:imsg.email_domain});if(TS.client)TS.view.showProperTeamPaneFiller()},team_domain_change:function(imsg){TS.team.upsertAndSignal({domain:imsg.domain});TS.model.last_team_domain=TS.model.team.domain;TSSSB.call("teamDomainChanged",imsg.url)},slack_broadcast:function(imsg){var onGo=null;var title=imsg.title||"Broadcast message";var body=imsg.body||"";var body_plus="";var go_button_text=imsg.button||(imsg.reload?"Reload":"OK");var do_reload=false;if(!!imsg.reload){if(!!imsg.force_reload){TS.info("reloading because imsg.force_reload");do_reload=true}else if(!TS.boot_data.version_ts){TS.info("reloading because we dont have an version_ts");do_reload=true}else if(imsg.version_ts=="dev"){TS.info("reloading because dev");do_reload=true}else if(parseInt(TS.boot_data.version_ts)<parseInt(imsg.version_ts)){TS.info("reloading because "+TS.boot_data.version_ts+" < "+imsg.version_ts);do_reload=true}if(!do_reload)return;onGo=function(){if(TS.client)TS.reload()}}if(do_reload){var secs=_.random(10,20);body_plus='<p class="top_margin">(You will be auto reloaded in <span id="auto_secs">'+secs+"</span> seconds.)</p>";setTimeout(function(){if(TS.client)TS.reload()},secs*1e3);setInterval(function(){secs--;if(secs<1)return;$("#auto_secs").text(secs)},1e3)}TS.generic_dialog.start({title:TS.format.formatNoHighlightsNoSpecials(title),body:TS.format.formatNoHighlightsNoSpecials(body)+body_plus,go_button_text:go_button_text,show_cancel_button:false,esc_for_ok:true,onGo:onGo})},team_rename:function(imsg){$("#team_name").text(imsg.name);document.title=document.title.replace(TS.model.last_team_name,imsg.name);if(TS.ui.growls.original_document_title){TS.ui.growls.original_document_title=TS.ui.growls.original_document_title.replace(TS.model.last_team_name,imsg.name)}TS.model.last_team_name=TS.model.team.name=imsg.name;TS.team.team_name_changed_sig.dispatch(TS.model.team);TSSSB.call("teamNameChanged",imsg.name)},team_icon_change:function(imsg){if(!imsg.icon)return;TS.model.team.icon=imsg.icon;if(TS.client)TS.client.updateTeamIcon()},bot_added:function(imsg){var bot=imsg.bot;TS.info(bot.name+" was added");TS.bots.upsertBot(bot);bot=TS.bots.getBotById(bot.id);if(!bot){TS.error("wtf no bot "+bot.id+"?");return}TS.bots.added_sig.dispatch(bot)},bot_changed:function(imsg){var bot=TS.bots.getBotById(imsg.bot.id);if(!bot&&TS.lazyLoadMembersAndBots()){TS.log(1989,"Flannel: bot_changed for member not in model; ignoring");return}if(!bot){TS.error("wtf no bot "+imsg.bot.id+"?");return}TS.bots.upsertAndSignal(imsg.bot)},bot_removed:function(imsg){var bot=TS.bots.getBotById(imsg.bot.id);if(!bot&&TS.lazyLoadMembersAndBots()){TS.log(1989,"Flannel: bot_removed for bot not in model; ignoring");return}if(!bot){TS.error("wtf no bot "+imsg.bot.id+"?");return}TS.bots.upsertAndSignal(imsg.bot)},error:function(imsg){},user_typing:function(imsg){if(!TS.typing)return;var member=TS.members.getMemberById(imsg.user);if(!member){TS.error("unknown imsg.user:"+imsg.user);return}var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error("unknown imsg.channel:"+imsg.channel);return}TS.typing.memberStarted(model_ob,member)},issue_change:function(imsg){TS.help.onIssueChange(imsg.issue)},emoji_changed:function(imsg){switch(imsg.subtype){case"add":if(!imsg.hasOwnProperty("name")||!imsg.hasOwnProperty("value")){TS.warn("Bad emoji_changed__add event; expected `name` and `value` to be present");return}TS.emoji.addCustomEmoji(imsg.name,imsg.value,imsg.event_ts);break;case"remove":if(!_.isArray(imsg.names)){TS.warn("Bad emoji_changed__remove event; expected `names` to be an array");return}imsg.names.forEach(function(name){TS.emoji.removeCustomEmoji(name,imsg.event_ts)});break;default:_handleGenericChangeEvent("emoji_changed",imsg.event_ts,function(event_ts){if(event_ts)TS.model.emoji_cache_ts=event_ts;TS.emoji.resetUpEmoji()})}},commands_changed:function(imsg){if(!imsg.commands_removed&&!imsg.commands_updated){_handleGenericChangeEvent("commands_changed",imsg.event_ts,function(event_ts){if(event_ts)TS.model.commands_cache_ts=event_ts;TS.cmd_handlers.resetUpCmds()});return}if(_.isArray(imsg.commands_removed)){imsg.commands_removed.forEach(function(command){TS.cmd_handlers.removeCommand(command.name,imsg.event_ts)})}if(_.isArray(imsg.commands_updated)){imsg.commands_updated.forEach(function(command){TS.cmd_handlers.updateCommand(command,imsg.event_ts)})}},accounts_changed:function(){setTimeout(TS.refreshTeams,1e3)},pin_added:function(imsg){var model_ob=TS.shared.getModelObById(imsg.channel_id);if(model_ob){TS.pins.pinStatusHasChanged(true,imsg.item,imsg.item.type,model_ob);model_ob.has_pins=true}},pin_removed:function(imsg){var model_ob=TS.shared.getModelObById(imsg.channel_id);if(model_ob){TS.pins.pinStatusHasChanged(false,imsg.item,imsg.item.type,model_ob);if(imsg.has_pins===false)model_ob.has_pins=false}},sh_room_join:function(imsg){if(!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},sh_room_leave:function(imsg){if(!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},sh_room_update:function(imsg){if(!TS.boot_data.feature_calls)return;TS.dir(441,imsg);TS.rooms.upsertAndSignal(imsg.room)},subteam_updated:function(imsg){TS.user_groups.upsertUserGroupAndSignal(imsg.subteam);TS.user_groups.getUserGroupMembers(imsg.subteam.id)},subteam_created:function(imsg){TS.user_groups.upsertUserGroupAndSignal(imsg.subteam)},subteam_deleted:function(imsg){TS.user_groups.removeUserGroupAndSignal(imsg.subteam)},subteam_self_added:function(imsg){TS.user_groups.upsertSelfUserGroup(imsg.subteam_id)},subteam_self_removed:function(imsg){TS.user_groups.removeSelfUserGroup(imsg.subteam_id)},apps_changed:function(imsg){if(imsg.event_ts)TS.model.apps_cache_ts=imsg.event_ts;TS.apps.ingestApp(imsg.app)},dnd_override:function(imsg){TS.dnd.dndOverride(imsg.channel,imsg.timestamp)},dnd_updated:function(imsg){var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}TS.dnd.updateUserPropsAndSignal(member.id,imsg.dnd_status)},dnd_updated_user:function(imsg){var member=TS.members.getMemberById(imsg.user);if(!member){TS.error('unknown member: "'+imsg.user+'"');return}TS.dnd.updateUserPropsAndSignal(member.id,imsg.dnd_status)},reconnect_url:function(imsg){if(!TS.ms.fast_reconnects_enabled)return;var url=imsg.url;TS.ms.setReconnectUrl(url)},message_replied:function(imsg){if(!TS.boot_data.feature_message_replies)return;var message=imsg.message;var last_reply_ts;if(message&&message.replies){last_reply_ts=_.maxBy(message.replies,"ts").ts}var model_ob=TS.shared.getModelObById(imsg.channel);if(last_reply_ts&&model_ob&&model_ob.msgs){var msg=TS.utility.msgs.findMsg(message.ts,model_ob.id);if(msg&&msg.replies){var prev_last_reply=_.maxBy(msg.replies,"ts").ts;if(last_reply_ts<prev_last_reply){TS.warn("Not processing older message_replied event, "+last_reply_ts+" < "+prev_last_reply+", in "+imsg.channel);return}}}TS.ms.msg_handlers.message_changed_worker(imsg)},subtype__message_replied:function(imsg){if(!TS.boot_data.feature_message_replies)return;TS.log(2,"recved subtype "+imsg.subtype);if(TS.boot_data.feature_channel_eventlog_client){TS.warn("feature_channel_eventlog_client=1 so we should never be getting subtype "+imsg.subtype)}TS.ms.msg_handlers.message_changed_worker(imsg)},mentions_badge_set:function(imsg){if(!TS.boot_data.feature_message_replies)return;var count=parseInt(imsg.count,10);TS.replies.setMentionsBadgeCount(count)},thread_subscribed:function(imsg){if(!TS.boot_data.feature_message_replies)return;var subscription=imsg.subscription;if(!subscription||subscription.type!=="thread")return;if(!subscription.channel||!subscription.thread_ts)return;TS.replies.threadSubscribed(subscription.channel,subscription.thread_ts,subscription)},thread_unsubscribed:function(imsg){if(!TS.boot_data.feature_message_replies)return;var subscription=imsg.subscription;if(!subscription||subscription.type!=="thread")return;if(!subscription.channel||!subscription.thread_ts)return;TS.replies.threadUnsubscribed(subscription.channel,subscription.thread_ts,subscription)},thread_marked:function(imsg){if(!TS.boot_data.feature_message_replies)return;var subscription=imsg.subscription;if(!subscription||subscription.type!=="thread")return;if(!subscription.channel||!subscription.thread_ts)return;TS.replies.threadMarked(subscription.channel,subscription.thread_ts,subscription.last_read,subscription.unread_count)},user_added_to_team:function(imsg){if(!TS.boot_data.feature_user_added_to_team)return;TS.info("TS.ms.msg_handlers.user_added_to_team, team_id = "+imsg.team_id);if(TS.client)TS.client.user_added_to_team_sig.dispatch(imsg.team_id)},user_removed_from_team:function(imsg){if(!TS.boot_data.feature_user_removed_from_team)return;TS.info("TS.ms.msg_handlers.user_removed_from_team, team_id = "+imsg.team_id);if(TS.client)TS.client.user_removed_from_team_sig.dispatch(imsg.team_id)},update_thread_state:function(imsg){if(!TS.boot_data.feature_message_replies||!TS.boot_data.feature_message_replies_threads_view)return;if(!TS.client)return;TS.client.threads.setThreadsUnreadData(imsg.has_unreads,imsg.mention_count)}});var _did_queue_rebuild_member_list_toggle=false;var REMINDER_REGEXP=/^Reminder:+\s/;var _isFileMsgRelevant=function(imsg,file_id){if(!file_id)return false;if(TS.web&&TS.web.space&&!TS.web.space.isFileRelevant(file_id))return false;if(imsg.type=="file_created"&&imsg.user_id==TS.model.user.id)return true;return!!TS.files.getFileById(file_id)};var _Q=[];var _q_grew_from_event_log=false;var _addToQ=function(imsg){if(imsg._from_evt_log)_q_grew_from_event_log=true;_Q.push(imsg);if(_Q.length==1){_nextFromQ()}else{TS.log(2,imsg.type+" is Qed and not being handled immediately _Q.length:"+_Q.length);if(_q_grew_from_event_log){if(_Q.length>100){}}else if(_Q.length>10){}}};var _nextFromQ=function(){if(!_Q.length)return;_ensureFileObjectsOnMsgAndProceed(_Q[0])};var _ensureFileObjectsOnMsgAndProceed=function(imsg){if(imsg.type=="message")return _ensureModelObsAndMembersAndProceed(imsg);var ob_with_file=imsg;var file_id=imsg.file&&imsg.file.id||imsg.file_id;if(!file_id&&imsg.item){file_id=imsg.item.file&&imsg.item.file.id||imsg.item.file_id;if(file_id)ob_with_file=imsg.item}if(!file_id)return _ensureModelObsAndMembersAndProceed(imsg);if(imsg.type=="file_deleted")return _ensureModelObsAndMembersAndProceed(imsg);if(imsg.type=="file_private")return _ensureModelObsAndMembersAndProceed(imsg);if(!_isFileMsgRelevant(imsg,file_id)){TS.maybeWarn(552,imsg.type+" referenced an irrelevant file: "+file_id);return Promise.resolve().then(function(){return _afterMsgHandled()})}TS.dir(552,imsg,imsg.type+" -> _ensureFileObjectsOnMsgAndProceed()");if(!file_id){TS.maybeWarn(552,imsg.type+" referenced a relevant file but there is no file_id");return _ensureModelObsAndMembersAndProceed(imsg)}TS.log(552,imsg.type+" referenced a relevant file and we have to look it up via the API: "+file_id);TS.files.fetchFileInfoRaw(file_id,function(id,file){if(!file){TS.maybeWarn(552,imsg.type+" file fetch failed (or the file has been deleted)");return Promise.resolve().then(function(){return _afterMsgHandled()})}ob_with_file.file=file;TS.log(552,imsg.type+" now has a file definition");return _ensureModelObsAndMembersAndProceed(imsg)})};var _ensureModelObsAndMembersAndProceed=function(imsg){TS.log(2,imsg.type+" is now being handled");
var full_type="type:"+imsg.type+(imsg.subtype?" subtype:"+imsg.subtype:"");var c_ids=TS.utility.extractAllModelObIds(imsg,full_type);var m_ids=TS.utility.extractAllMemberIds(imsg,full_type);var missing_c_ids=TS.shared.getModelObIdsNotPresent(c_ids);var missing_m_ids=TS.members.getMemberIdsNotPresent(m_ids.m_ids,m_ids.c_ids,m_ids.t_ids);var ensureModelObs=function(){return TS.shared.ensureModelObsArePresent(missing_c_ids).then(function(){return ensureMembers()},function(err){if(imsg.channel&&typeof imsg.channel=="string"&&!TS.shared.getModelObById(imsg.channel)){TS.error(full_type+" could not be handled because imsg.channel could not be fetched. full err: "+err.message);TS.log(0,"imsg.ts:"+imsg.ts+", imsg.channel:"+imsg.channel);return _afterMsgHandled()}else{TS.maybeWarn(794,full_type+" held some references to model_obs we could not fetch, but we have imsg.channel (or there was no imsg.channel) so we can still proceed");TS.log(794,"imsg.ts:"+imsg.ts+", missing c ids:"+JSON.stringify(missing_c_ids));if(missing_m_ids.m_ids.length){return ensureMembers()}return proceedWithImsg()}})};var ensureMembers=function(){return TS.members.ensureMembersArePresent(missing_m_ids.m_ids,missing_m_ids.c_ids,missing_m_ids.t_ids).then(function(){return proceedWithImsg()},function(err){if(imsg.user&&typeof imsg.user=="string"&&!TS.members.getMemberById(imsg.user)||imsg.channel&&typeof imsg.channel=="object"&&imsg.channel.user&&typeof imsg.channel.user=="string"&&!TS.members.getMemberById(imsg.channel.user)){TS.error(full_type+" could not be handled because imsg.user or imsg.channel.user could not be fetched. full err: "+err.message);TS.log(0,"imsg.ts:"+imsg.ts+", imsg.user:"+imsg.user+", imsg.channel.user:"+imsg.channel&&imsg.channel.user);return _afterMsgHandled()}else{TS.maybeWarn(794,full_type+" held some references to members we could not fetch, but we have imsg.user and imsg.channel.user (or they did not exist) so we can still proceed");TS.log(794,"imsg.ts:"+imsg.ts+", missing_m_ids:"+JSON.stringify(missing_m_ids));return proceedWithImsg()}})};var proceedWithImsg=function(){try{_handleMsg(imsg)}catch(err){TS.error(full_type+" errored out when being handled, with err: "+err.message,err)}return _afterMsgHandled()};if(missing_c_ids.length){ensureModelObs()}else if(missing_m_ids.m_ids.length){ensureMembers()}else{Promise.resolve().then(function(){return proceedWithImsg()})}};var _afterMsgHandled=function(){if(!_Q.length)return Promise.resolve();_Q.shift();if(!_Q.length)_q_grew_from_event_log=false;_nextFromQ();return Promise.resolve()};var _handleMsg=function(imsg){TS.ms.msg_handlers[imsg.type](imsg);if(TS.client&&TS.model.is_our_app){TS.dir(236,imsg,"calling TS.client.windows.distributeMsgToWins");TS.client.windows.distributeMsgToWins(imsg)}};var _sharedHistoryChangedWorker=function(imsg,controller){var model_ob=TS.shared.getModelObById(imsg.channel);if(!model_ob){TS.error('unknown model_ob: "'+imsg.channel+'"');return}model_ob.history_changed=true;controller.fetchHistory(model_ob,{channel:model_ob.id,latest:imsg.latest,inclusive:true,count:_.clamp(model_ob.msgs.length,TS.model.initial_msgs_cnt,1e3)},function(ok,data,args){if(!ok){TS.error("could not retrieve history for "+model_ob.id)}else{TS.info("_history_changed: dumping old messages for "+model_ob.id);model_ob.is_limited=false;TS.utility.msgs.resetOldestMsgsTs(model_ob);TS.warn("imsg.latest: "+imsg.latest);for(var i=model_ob.msgs.length-1;i>-1;i--){var msg=model_ob.msgs[i];if(msg.ts<imsg.latest)continue;data.messages.unshift(msg)}model_ob.msgs.length=0}controller.onHistory(ok,data,args);if(!model_ob.latest){TS.info("history_changed: latest not set for "+model_ob.id,imsg,model_ob);var latest=TS.shared.getLatestMsgTs(model_ob);if(!latest){TS.warn("history_changed: could not find latest via TS.shared.getLatestMsgTs(), using live msgs");latest=model_ob&&model_ob.msgs.length?model_ob.msgs[model_ob.msgs.length-1]:null}if(!latest){TS.warn("history_changed: still no latest ts for "+model_ob.id+"?",latest)}else{if(latest){TS.info("history_changed: assigning latest of "+latest+" to model_ob",latest,model_ob);model_ob.latest=latest}}}delete model_ob.history_changed})};var _setMemberPresence=function(member_id,presence){if(presence!="away"&&presence!="active"){TS.error('unknown presence: "'+presence+'"');return}var member=TS.members.getMemberById(member_id);if(!member){if(TS.lazyLoadMembersAndBots()){}else{TS.error('unknown member: "'+member_id+'"')}return}if(member.presence==presence)return;if(TS.boot_data.feature_always_active_bots&&member.profile.always_active)presence="active";if(member.is_self){member._presence_last_changed=new Date}member.presence=presence;TS.members.presence_changed_sig.dispatch(member)};var _pending_events={};var _handleGenericChangeEvent=function(event_name,cache_ts,callback){_pending_events[event_name]=_pending_events[event_name]||{};var pending_event=_pending_events[event_name];if(cache_ts)pending_event.cache_ts=cache_ts;if(pending_event.timer){return}var delay=_.random(0,5e3);TS.info("Waiting "+delay+" ms before handling "+event_name+" event");pending_event.timer=setTimeout(function(){delete _pending_events[event_name];callback(pending_event.cache_ts)},delay)}})();(function(){"use strict";TS.registerModule("ds",{last_pong_time:0,sent_map:{},connected_sig:new signals.Signal,disconnected_sig:new signals.Signal,trouble_sig:new signals.Signal,reconnecting_sig:new signals.Signal,pong_sig:new signals.Signal,on_msg_sig:new signals.Signal,reconnect_requested_sig:new signals.Signal,onStart:function(){_setPongTimeoutMs(TS.model.ui.is_window_focused||false);TS.ui.window_focus_changed_sig.add(_setPongTimeoutMs);setInterval(function(){if(!TS.model.ds_connected)return;if(TS.model.rtd_start_throttler<1)return;TS.model.rtd_start_throttler--},1e3*60)},send:function(msg,handler,temp_ts){msg.id=++_msg_id;TS.ds.sent_map[msg.id.toString()]={msg:msg,handler:handler,ts:Date.now(),temp_ts:temp_ts};if(msg.type=="ping"||msg.type=="pong"){TS.log(2,"DS TS.ds ping -->\n"+JSON.stringify(msg,null,"  "))}else{TS.model.last_net_send=Date.now();TS.log(2,"TS.ds -->\n"+JSON.stringify(msg,null,"  "))}if(_websocket&&TS.model.ds_connected){_websocket.send(JSON.stringify(msg))}else{TS.ds.Q.push(msg)}return msg.id},Q:[],sendTyping:function(c_id){var msg_str='{"type":"typing", "channel":"'+c_id+'"}';_websocket.send(msg_str)},handleMsg:function(imsg){var is_reconnect_reply=imsg.reply_to&&!("ok"in imsg)&&imsg.type=="message";var sent;if(imsg.reply_to){if(imsg.reply_to.toString()in TS.ds.sent_map){sent=TS.ds.sent_map[imsg.reply_to];imsg.SENT_MSG=sent.msg;delete TS.ds.sent_map[imsg.reply_to]}else{if(!is_reconnect_reply){TS.error('received msg "'+imsg.reply_to+'" with type "'+imsg.type+'" but we have no record of it in sent_map')}}}if(imsg.type=="ping"||imsg.type=="pong"){TS.log(2,"DS msg "+imsg.type+" time: "+(Date.now()-sent.ts)+"ms");TS.log(2,"DS TS.ds ping <--\n"+JSON.stringify(imsg,null,"  "));TS.ds.last_pong_time=Date.now();TS.ds.pong_sig.dispatch();_check_last_pong_time=false}else{if(sent){var type=imsg.type?imsg.type:imsg.SENT_MSG.type?imsg.SENT_MSG.type:"";TS.log(2,"msg "+(type?'"'+type+'" ':"")+"rsp time "+(Date.now()-sent.ts)+"ms")}TS.log(2,"TS.ds <-- \n"+JSON.stringify(imsg,null," "))}if(imsg.type=="error"){_onErrorMsg(imsg)}else if(!imsg.reply_to){TS.ds.on_msg_sig.dispatch(imsg);if(imsg.type=="hello"){_onHello(imsg)}}if(sent){if(!imsg.ok){imsg.error=imsg.error||{code:0,msg:"unknown error (not specified by MS)"}}if(is_reconnect_reply){imsg.ok=true}if(sent.handler){sent.handler(imsg.ok,imsg)}}},onFailure:function(reason_str){if(reason_str)_reportDisconnect("You got disconnected, so here are some details:\n>>>"+reason_str);_check_last_pong_time=false;_deprecateCurrentSocket();if(TS.model.ds_connected){TS.info("Disconnected from DS, TS.model.rtd_start_throttler:"+TS.model.rtd_start_throttler);TS.ds.logConnectionFlow("on_connected_failure");TS.model.ds_reconnect_ms=100;TS.ds.disconnect()}else{TS.ds.logConnectionFlow("on_notconnected_failure");var ms=TS.model.ds_reconnect_ms=(TS.model.ds_reconnect_ms+1e3)*1.3;if(TS.model.ds_reconnect_ms>4e3){TS.model.ds_reconnect_ms=_.random(ms,ms+ms/3)}TS.model.ds_reconnect_ms=Math.min(TS.model.ds_reconnect_ms,3e5)}if(TS.model.rtd_start_throttler>5){var min_ms=2e3*TS.model.rtd_start_throttler;if(TS.model.ds_reconnect_ms<min_ms){TS.info("because TS.model.rtd_start_throttler:"+TS.model.rtd_start_throttler+" we are increasing time until next login call");TS.model.ds_reconnect_ms=min_ms}}if(TS.model.ds_connected){TS.model.ds_connected=false;TS.ds.disconnected_sig.dispatch()}TS.model.ds_connected=false;clearInterval(_send_ping_interv);clearInterval(_check_ping_interv);if(TS.model.ds_asleep){TS.warn("NOT doing startReconnection(), we are asleep");return}TS.ds.startReconnection()},startReconnection:function(){TS.model.ds_reconnect_time=Date.now()+TS.model.ds_reconnect_ms;TS.info("Attempting to reconnect in "+TS.model.ds_reconnect_ms+"ms");clearInterval(_reconnect_interv);_reconnect_interv=setInterval(_onReconnectInterval,_reconnect_interv_ms);_onReconnectInterval();clearTimeout(_auto_reconnect_tim);_auto_reconnect_tim=setTimeout(function(){if(!TS.model.window_unloading){TS.ds.reconnect_requested_sig.dispatch()}},TS.model.ds_reconnect_ms)},manualReconnectNow:function(){TS.ds.logConnectionFlow("manual_reconnect");clearTimeout(_auto_reconnect_tim);clearInterval(_reconnect_interv);clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(!TS.model.window_unloading){TS.ds.reconnect_requested_sig.dispatch();TS.ds.reconnecting_sig.dispatch(0)}},disconnect:function(){if(_websocket&&TS.model.ds_connected){TS.ds.logConnectionFlow("disconnect");_websocket.close()}else{TS.warn("TS.ds.disconnect called, but _websocket="+_websocket+" TS.model.ds_connected="+TS.model.ds_connected)}},logConnectionFlow:function(name){var ds_conn_log=TS.model.ds_conn_log;var time=Date.now();ds_conn_log.push({name:name,time:time,delta:ds_conn_log.length?time-ds_conn_log[ds_conn_log.length-1].time:0});TS.log(2,"logConnectionFlow "+name+" "+ds_conn_log[ds_conn_log.length-1].delta)},getConnectionFlowLog:function(){var ds_conn_log=TS.model.ds_conn_log;var args=[];for(var i=0;i<ds_conn_log.length;i++){args.push(encodeURIComponent(ds_conn_log[i].name+"-"+(ds_conn_log[i].delta?Math.round(ds_conn_log[i].delta/1e3):0)+"-"+Math.round(ds_conn_log[i].time/1e3)))}TS.dir(2,TS.model.ds_conn_log);var log="_x_connection_log="+args.join(",");return log},connect:function(){TSConnLogger.log("ds_connecting","TS.ds.connect "+TS.web.space.login_data.ws);if(!window.WebSocket){window.WebSocket=window.MozWebSocket}if(window.WebSocket){var url;try{TS.ds.logConnectionFlow("connect");url=TS.web.space.login_data.ws;var special_str=TS.qs_args["simulate_old_token"]==1?"&TRIGGER_OLD_TOKEN=1":"";url+="?version_uid="+TS.boot_data.version_uid+special_str;url=TS.utility.appendLogToUrlWithLimit(url,TS.ds.getConnectionFlowLog());TS.info("Connecting to: "+url);if(TS.qs_args["simulate_first_connect_failure"]==1&&!window.already_simulated_first_connect_failure){url=url.replace("e","w");TS.info("simulate_first_connect_failure url:"+url);window.already_simulated_first_connect_failure=true}_connect_timeout_tim_ms=window.WEB_SOCKET_USING_FLASH?_connect_flash_timeout_tim_ms:_connect_ws_timeout_tim_ms;clearTimeout(_connect_timeout_tim);_connect_timeout_tim=setTimeout(_onConnectTimeout,_connect_timeout_tim_ms);TS.ds.last_url=url;TS.ds.last_start_ms=Date.now();_deprecateCurrentSocket();_websocket=new WebSocket(url)}catch(error){TS.warn("failed to create new WebSocket");TS.error(error);TS.ds.onFailure("failed to create new WebSocket");return}TS.model.ds_connecting=true;if(TS.qs_args["simulate_first_connect_timeout"]==1&&_connect_timeout_count<1){TS.info("simulate_first_connect_timeout url:"+url)}else{_websocket.onopen=_onConnect}_websocket.onclose=_onDisconnect;_websocket.onerror=_onError}else{alert("Your browser does not support Web Sockets.")}},sleep:function(){if(TS.model.ds_asleep)return;if(!TS.model.ds_connected)return;TS.model.ds_asleep=true;TS.ds.disconnect()},wake:function(){if(!TS.model.ds_asleep)return;TS.model.ds_asleep=false;TS.ds.startReconnection()}});var _check_ping_interv=0;var _check_ping_interv_ms=3e3;var _send_ping_interv=0;var _send_ping_interv_ms=1e4;var _connect_timeout_tim=0;var _connect_timeout_tim_ms=0;var _connect_ws_timeout_tim_ms=1e4;var _connect_flash_timeout_tim_ms=2e4;var _hello_timeout_tim=0;var _hello_timeout_tim_ms=1e4;var _disconnect_timeout_tim=0;var _disconnect_timeout_tim_ms=5e3;var _reconnect_interv=0;var _reconnect_interv_ms=1e3;var _auto_reconnect_tim=0;var _websocket=null;var _msg_id=0;var _check_last_pong_time=false;var _pong_timeout_ms=0;var _connect_timeout_count=0;var _setPongTimeoutMs=function(has_focus){if(has_focus){_pong_timeout_ms=1e4}else{_pong_timeout_ms=6e4}_pong_timeout_ms+=_send_ping_interv_ms;TS.log(2,"DS _pong_timeout_ms set to:"+_pong_timeout_ms+" has_focus:"+has_focus)};var _onMsg=function(e){var imsg=JSON.parse(e.data);TS.ds.handleMsg(imsg)};var _onConnect=function(e){clearTimeout(_connect_timeout_tim);_connect_timeout_count=0;if(TS.qs_args["simulate_hello_timeout"]==1&&!window.already_simulated_hello_timeout){TS.info("simulate_hello_timeout");window.already_simulated_hello_timeout=true}else{_websocket.onmessage=_onMsg}TS.model.ds_conn_log.length=0;TSConnLogger.log("ds_connected","_onConnect (took "+(Date.now()-TS.ds.last_start_ms)+"ms)");TS.info("DS WS connected!");TS.ds.logConnectionFlow("on_connect");clearTimeout(_hello_timeout_tim);_hello_timeout_tim=setTimeout(_onHelloTimeout,_hello_timeout_tim_ms)};var _checkPings=function(){if(!_check_last_pong_time)return;var since_last_pong_ms=Date.now()-TS.ds.last_pong_time;TS.log(2,"DS MS since_last_pong_ms:"+since_last_pong_ms+" pong_timeout_ms:"+_pong_timeout_ms);if(since_last_pong_ms<_pong_timeout_ms)return;TS.warn("since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms);TS.warn("calling disconnect(), expect to get an onDisconnect() callback");TS.ds.logConnectionFlow("on_ping_timeout");TS.ds.trouble_sig.dispatch();_check_last_pong_time=false;_reportDisconnect("You are on team Tiny Speck, so here are some pong details:\n>>>"+"since_last_pong_ms too long! "+since_last_pong_ms+" > "+_pong_timeout_ms+" ... calling disconnect(), expect to get an onDisconnect() callback");try{TS.ds.disconnect();clearTimeout(_disconnect_timeout_tim);_disconnect_timeout_tim=setTimeout(function(){TS.info("called disconnect, no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now");_onDisconnect(null,"since_last_pong_ms too long! then called disconnect, but no onDisconnect callback happened in "+_disconnect_timeout_tim_ms+"ms, so calling _onDisconnect() manually now")},_disconnect_timeout_tim_ms)}catch(err){TS.info("since_last_pong_ms too long! then an error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now");TS.warn(err);_onDisconnect(null,"error calling disconnect, going to assume it is because it is already closed, calling _onDisconnect() manually now")}};var _sendPing=function(){TS.ds.send({type:"ping"});_check_last_pong_time=true};var _onDisconnect=function(e,reason_str){reason_str=reason_str||"_onDisconnect called with event:"+e;TS.info("DS WS disconnected");TS.ds.logConnectionFlow("on_disconnect");clearTimeout(_disconnect_timeout_tim);clearTimeout(_hello_timeout_tim);clearTimeout(_connect_timeout_tim);if(e){TS.info("_onDisconnect event.code:"+e.code);if(e.code=="1006"&&false){TS.generic_dialog.start({title:"Connection trouble error #1006",body:"Apologies, we're having some trouble with your connection. The particular error code indicates that restarting the application might fix it.",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}else{TS.info("no event")}TS.ds.onFailure(reason_str)};var _reportDisconnect=function(reason_str){TS.warn("_reportDisconnect reason_str:"+reason_str)};var _deprecateCurrentSocket=function(){if(!_websocket)return;_websocket.onmessage=null;_websocket.onopen=null;_websocket.onerror=null;_websocket.onclose=null;try{_websocket.close()}catch(err){}if(false){var old_socket=_websocket;_websocket.onclose=function(e){TS.ds.logConnectionFlow("old_socket_closed");if(!TS.model.ds_connected&&!TS.model.ds_connecting){TS.warn("Our last socket just fired a close event, and we are not yet connected or connecting again, so let us jump start the connection process with manualReconnectNow()");TS.ds.manualReconnectNow()}old_socket.onclose=null}}};var _onReconnectInterval=function(){var ms=TS.model.ds_reconnect_time-Date.now();var secs=Math.round(ms/1e3);if(secs>=0){TS.ds.reconnecting_sig.dispatch(secs)}if(TS.model.window_unloading){clearInterval(_reconnect_interv)}};var _onHelloTimeout=function(){var desc="socket received no hello msg "+_hello_timeout_tim_ms+"ms after connection";TS.warn(desc);TS.ds.logConnectionFlow("_onHelloTimeout");TS.ds.onFailure(desc)};var _onConnectTimeout=function(){_connect_timeout_count++;var desc="socket not connected "+_connect_timeout_tim_ms+"ms after creation. _connect_timeout_count:"+_connect_timeout_count;TS.warn(desc);TS.ds.logConnectionFlow("_onConnectTimeout");if(_connect_timeout_count==3){if(TS.model.is_chrome_desktop){TS.ms.showConnectionTroubleDialog()}else{TS.generic_dialog.start({title:"Connection trouble",body:"<p>Apologies, we're having some trouble with your web socket connection.</p>					<p>We've seen this problem clear up with a restart of "+(TS.model.is_our_app?"Slack":"your browser")+", 					a solution which we suggest to you now only with great regret and self-loathing.</p>					",show_cancel_button:false,go_button_text:"OK",esc_for_ok:true})}return}else if(_connect_timeout_count==2){if(window.WEB_SOCKET_USING_FLASH){}else if(TS.model.is_chrome_desktop){_connect_ws_timeout_tim_ms=2e4;return}}TS.ds.onFailure(desc)};var _onError=function(e){var err_str="";if(e){if(e.name)err_str+=" e.name="+e.name;if(e.message)err_str+=" e.message="+e.message;if(e.data)err_str+=" e.data="+e.data}TS.warn("_onError err_str: "+err_str);TS.dir(0,e)};var _onErrorMsg=function(imsg){if(imsg.error){if(imsg.error.code==1){TS.ds.logConnectionFlow("msg_error_code_1")}else{TS.info("_onErrorMsg websocket is connected but we got an error message: "+JSON.stringify(imsg));TS.ds.onFailure("_onErrorMsg imsg.error:"+imsg.error)}}else{TS.info("_onErrorMsg: "+(imsg?JSON.stringify(imsg):"no imsg?"))}};var _onHello=function(){clearTimeout(_hello_timeout_tim);TSConnLogger.log("ds_hello","_onHello (took "+(Date.now()-TS.ds.last_start_ms)+"ms)");var since_last_pong_ms=Date.now()-TS.ds.last_pong_time;TS.info("Hello msg recvd, since_last_pong_ms:"+since_last_pong_ms);TS.ds.logConnectionFlow("on_hello");clearInterval(_reconnect_interv);_check_last_pong_time=true;TS.ds.last_pong_time=Date.now();clearInterval(_check_ping_interv);_check_ping_interv=setInterval(_checkPings,_check_ping_interv_ms);clearInterval(_send_ping_interv);_send_ping_interv=setInterval(_sendPing,_send_ping_interv_ms);TS.model.ds_connecting=false;TS.model.ds_connected=true;var msg;for(var i=0;i<TS.ds.Q.length;i++){msg=TS.ds.Q.shift();TS.log(2,"TS.ds (Q) -->\n"+JSON.stringify(msg,null,"  "));_websocket.send(JSON.stringify(msg))}TS.ds.connected_sig.dispatch();_sendPing()}})();(function(){"use strict";TS.registerModule("templates",{onStart:function(){_load();if(TS.members){TS.members.user_color_changed_sig.add(TS.templates.memberUserColorChanged,TS.templates)}if(TS.prefs){TS.prefs.sidebar_behavior_changed_sig.add(TS.templates.sidebarBehaviorPrefChanged,TS.templates)}TS.environment.retina_changed_sig.add(_redrawRetinaAssets)},makeUnreadMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_messages_"+item.id)},makeRxnKeyDomClass:function(rxn_key){return TS.utility.makeSafeForDomId("rxns_key_"+rxn_key)},makeUnreadGroupMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_group_messages_"+item.id)},makeUnreadDmsDomId:function(item){return TS.utility.makeSafeForDomId("activity_unread_dms_"+item.id)},makeSentMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_messages_"+item.id)},makeSentGroupMessagesDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_group_messages_"+item.id)},makeIssueListDomId:function(id){return"issue_list_"+id},makeSentDmsDomId:function(item){return TS.utility.makeSafeForDomId("activity_sent_dms_"+item.id)},makeMsgDomId:function(ts){return TS.utility.makeSafeForDomId("msg_"+ts)},makeMsgLabelDomId:function(ts){return TS.utility.makeSafeForDomId("msg_"+ts+"_label")},makeMsgAttachmentTextExpanderDomId:function(ts,index){return TS.utility.makeSafeForDomId("msg_rest_text_expander_"+ts+"_"+index)},makeMSRDomId:function(match){return TS.utility.makeSafeForDomId("MSR_"+match.channel.id+"_"+match.ts)},makeSHRoomClass:function(room_id){return TS.utility.makeSafeForDomId("screenhero_room_"+room_id)},makeChannelDomId:function(channel){return"channel_"+channel.id},makeDayDividerDomId:function(ts){return TS.utility.makeSafeForDomId("day_divider_"+ts)},makeGroupDomId:function(group){return"group_"+group.id},makePriorityIconDomId:function(model_ob){return"priority_"+model_ob.id},makeStarredIconDomId:function(model_ob){return"starred_"+model_ob.id},makeMutedIconDomId:function(model_ob){return"muted_"+model_ob.id},makeHotnessIconDomId:function(model_ob){return"hotness_"+model_ob.id},makeHotnessIconDomClasses:function(model_ob){var hotness_class="";if(TS.model.prefs.hotness){if(model_ob._hotness>0)hotness_class="warm";if(model_ob._hotness>2)hotness_class="warmer";if(model_ob._hotness>4)hotness_class="hot";if(model_ob._hotness>6)hotness_class="hotter";if(model_ob._hotness>8)hotness_class="hottest"}else{hotness_class="hidden"}return"hotness_icon "+hotness_class},makeMemberDomId:function(member){if(!member)return;return TS.templates.makeMemberDomIdById(member.id)},makeMemberDomIdById:function(id){if(!id)return;return"member_"+id},makeMpimDomId:function(mpim){return"mpim_"+mpim.id},makeChannelListDomId:function(channel){return"channel_"+channel.id+"_member_list"},makeFileDomId:function(file){return"file_"+file.id},makeFileCommentsDomId:function(file){return"file_comments_"+file.id},makeFileContentsDomId:function(file){return"file_contents_"+file.id},makeUnreadMsgsDomId:function(parent){return"unread_msg_"+parent.id},makeUnreadHighlightDomId:function(parent){if(!parent)return;return"unread_highlight_"+parent.id},makeMemberPresenceDomClass:function(member_id){return"member_presence_"+member_id},makeMemberPresenceStateClass:function(member){var presence=member.presence;if(TS.members.isMemberInDnd(member))presence+=" dnd";return presence},makeMemberPresenceStateAriaLabel:function(member){var presence=member.presence;var aria_label="";if(presence==="active"){aria_label+="active"}else if(presence==="away"){aria_label+="away"}if(TS.members.isMemberInDnd(member)){aria_label+=", do not disturb"}return aria_label},makeMemberPresenceIcon:function(member){var presence_class=TS.templates.makeMemberPresenceDomClass(member.id);var presence_icon_class="ts_icon_presence";if(member.is_ultra_restricted){presence_class+=" ura";presence_icon_class="ts_icon_presence_ura"}else if(member.is_restricted){presence_class+=" ra";presence_icon_class="ts_icon_presence_ra"}else if(member.is_slackbot){presence_icon_class="ts_icon_heart"}var presence_icon='<i aria-hidden="true" class="ts_icon '+presence_icon_class+' presence_icon"></i>';var presence=TS.templates.makeMemberPresenceStateClass(member);var html='<span data-member-presence="'+member.id+'" class="presence '+presence+" "+presence_class+'" title="'+member.presence+'">'+presence_icon+"</span>";return html},makeMemberStatusDomClass:function(member_id){return"member_status_"+member_id},memberUserColorChanged:function(member){var cls="color_"+member.id;if(member.color==member.member_color){var style_id="color_rule_"+cls;var $style=$("#"+style_id);$style.remove();return}TS.templates.makeUserColorRule(member)},makeUserColorRule:function(member){var cls="color_"+member.id;var color="#"+TS.utility.htmlEntities(member.member_color);var rule;if(TS.client){rule="				."+cls+":not(.nuc), 				#col_channels ul li:not(.active):not(.away) > ."+cls+":not(.nuc) {					color:"+color+";				}				"}else{rule="			."+cls+":not(.nuc) {				color:"+color+";			}			"}var style_id="color_rule_"+cls;var $style=$("#"+style_id);if($style.length){$style.text(rule)}else{$('<style type="text/css" id="'+style_id+'">'+rule+"</style>").appendTo("body")}},sidebarBehaviorPrefChanged:function(){TS.templates.makeSidebarBehaviorRule()},makeSidebarBehaviorRule:function(){var rule;var style_id="sidebar_behavior";var $style=$("#"+style_id);if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){rule="				.channels_list_holder ul li:not(.unread):not(.active):not(.show_in_list_even_though_no_unreads) {					display: none;			}"}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"){rule="				.channels_list_holder div:not(#starred_div)>ul li:not(.unread):not(.active):not(.is_starred):not(.show_in_list_even_though_no_unreads) {					display: none;			}"}else if(TS.model.prefs.sidebar_behavior=="shrink_left_column"){rule="				.real_names .im_name, .real_names .mpim_name, .feature_name_tagging_client .im_name, .feature_name_tagging_client .mpim_name {					font-size: 0.7rem;				}				.channels_list_holder ul li a {					height: auto;				}				.channels_list_holder ul li {					height: auto;					font-size: .7rem;					line-height: .8rem;				}				.channels_list_holder .section_holder {					margin: .3rem 0 .4rem;				}				.channels_list_holder ul li.group .prefix:before {					font-size: 0.7rem !important;				}				.channels_list_holder ul li.channel .prefix {					margin-top: -2px;				}				.channels_list_holder ul li.channel .prefix:before {					font-size: 0.8rem !important;				}				.channels_list_holder ul li.mpim .prefix {					margin-top: -2px;				}				.channels_list_holder ul li.mpim .prefix:before {					font-size: 0.8rem !important;				}				.channels_list_holder ul li .prefix.ts_icon_archived_channel {					margin-top: -2px !important;				}				.channels_list_holder ul li .prefix.ts_icon_archived_channel.prefix:before {					font-size: 0.8rem !important;				}				.channels_list_holder .unread_highlights {					background: none repeat scroll 0 0 #eb4d5c;					font-size: 0.5rem;					font-weight: 400;					line-height: 10px;					padding: 0 4px;					margin-top: -2px;					margin-right: -2px;				}				.channels_list_holder .presence {   					margin-right: -.2rem !important;				}				.channels_list_holder .presence_icon:before {   					font-size: 14px !important;					margin-top: 3px;				}				#col_channels ul li .priority_icon {					font-size: .6rem;					top: 0;				}				#col_channels ul li .hotness_icon .emoji-sizer {					font-size: .9rem;					margin-left: 1px;				}				.channels_list_holder h2, .list_more {					font-size: .6rem;			}"}if(rule){if($style.length){$style.text(rule)}else{$('<style type="text/css" id="'+style_id+'">'+rule+"</style>").appendTo("head")}}else{$("#"+style_id).remove()}},makeMsgDomIdInConversation:function(ts){return TS.templates.makeMsgDomId(ts)+"_conversation"},makeMsgDomIdInSearch:function(ts,main_msg){return TS.templates.makeMsgDomId(ts)+"_"+TS.templates.makeMSRDomId(main_msg)},makeMsgDomIdInUnreadView:function(ts){return TS.templates.makeMsgDomId(ts)+"_unread_view"},makeMsgDomIdInThreadsView:function(ts){return TS.templates.makeMsgDomId(ts)+"_threads_view"},promiseToRenderAsync:function(template,maybe_args_p){if(!template)return Promise.reject(new Error("No template to render"));return Promise.resolve(maybe_args_p).then(function(args){return template(args)})}});var _redrawRetinaAssets=function(){var id,size,omit_link,$el;$(".member_image").each(function(){$el=$(this);id=$el.data("member-id");size=$el.data("thumb-size");omit_link=!$el.is("a");if(id&&size)$(this).replaceWith(TS.templates.builders.makeMemberPreviewLinkImage(id,size,false,omit_link))});$el=null};var _load=function(){Object.keys(TS.raw_templates).forEach(function(template_name){TS.templates[template_name]=_compile(template_name,TS.raw_templates[template_name]);Handlebars.registerPartial(template_name,TS.templates[template_name])});delete TS.raw_templates};var _compile=function(name,html){if(!html){TS.warn(name+" was passed no html");return null}return Handlebars.compile(html)}})();(function(){"use strict";TS.registerModule("templates.builders",{debug_items:{},debug_items_index:0,fileHTML:function(file,config){config=config||{};var member=_getEntityFromFile(file);var actions=TS.files.getFileActions(file);var html;var template_args={member:member,file:file,for_search:config.for_search,is_enterprise:config.is_enterprise,for_files_list:TS.boot_data.feature_files_list&&!config.for_share_dialog,icon_class:TS.utility.getImageIconClass(file,"thumb_80"),is_email:file.mode=="email",is_space:file.mode=="space",is_post:file.mode=="post",is_snippet:file.mode=="snippet",is_hosted_or_external:file.mode=="hosted"||file.mode=="external",can_share:!!actions.share};if(TS.client){template_args.info_pane_visible=TS.model.ui_state.flex_name==="details"}template_args.supports_line_clamp=TS.environment.supports_line_clamp;if(file.mode=="external")template_args.external_filetype_html=TS.templates.builders.makeExternalFiletypeHTML(file);if(file.mode=="email"){template_args.to_more_count=file.to.length-1;template_args.cc_more_count=file.cc.length-1}html=TS.templates.file_list_item(template_args);return html},buildMsgHTML:function(args,log){if(TS.boot_data.feature_refactor_buildmsghtml){return TS.templates.builders.buildMsgHTMLNew(args)}if(log)TS.dir(0,args);try{var dont_show_dupe_bot_users=true;var msg=args.msg;if(false&&msg.text){msg=_.cloneDeep(msg);msg.text+=" <slack-action://BSLACKBOT/help/files/D026MK7NF|testing>"}var model_ob=args.model_ob;var prev_msg=args.prev_msg;var highlight=!!args.highlight;var no_attachments=!!args.no_attachments;var standalone=!!args.standalone;var hide_actions=!!args.hide_actions;var full_date=!!args.full_date;if(TS.model.prefs.fuller_timestamps&&!full_date)full_date=!TS.utility.date.sameDay(TS.utility.date.toDateObject(msg.ts),new Date);var jump_link=args.jump_link?new Handlebars.SafeString(args.jump_link):"";var starred_items_list=!!args.starred_items_list;var starred_items_actions=args.starred_items_actions;var container_id_with_hash=args.container_id?"#"+args.container_id:"";var enable_slack_action_links=!!args.enable_slack_action_links;var theme=args.theme;if(!theme)theme=TS.model.prefs.theme;var html="";var member=_getEntityFromMessage(msg);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_in_conversation=replies_enabled&&!!args.is_in_conversation;var is_threads_view=replies_enabled&&!!args.is_threads_view;var show_user=true;var show_divider=!standalone&&!is_in_conversation;var first_in_block=false;var unread=false;var msg_date=TS.utility.date.toDateObject(msg.ts);var new_day=false;var last_time_divider=false;var unprocessed=!!msg.rsp_id;var hide_user_name=false;var current_speaker=msg.user;var is_ephemeral=msg.is_ephemeral;if(!current_speaker&&dont_show_dupe_bot_users)current_speaker=TS.templates.builders.getBotIdentifier(msg);var is_bot=TS.utility.msgs.shouldHaveBotLabel(msg,member);var app_id;var bot_id;if(TS.boot_data.feature_app_cards_and_profs_frontend&&is_bot){var bot_info=TS.bots.getBotInfoByMsg(msg);if(bot_info){app_id=bot_info.app_id;bot_id=bot_info.bot_id}}var prev_speaker;if(prev_msg){prev_speaker=prev_msg.subtype=="file_comment"&&prev_msg.comment?prev_msg.comment.user:prev_msg.user;if(!prev_speaker&&dont_show_dupe_bot_users){prev_speaker=TS.templates.builders.getBotIdentifier(prev_msg)}}if(!msg.no_display&&!standalone){if(prev_msg){var last_rendered_msg_date=TS.utility.date.toDateObject(prev_msg.ts);if(model_ob.last_read<=prev_msg.ts)unread=true;if(msg.subtype&&msg.subtype=="file_comment"&&msg.comment){
current_speaker=msg.comment.user}if(TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)!=-1){show_divider=true;show_user=true}else if(prev_speaker==current_speaker&&TS.utility.msgs.automated_subtypes.indexOf(prev_msg.subtype)===-1){if(!msg.subtype&&prev_msg.subtype&&prev_msg.subtype=="file_comment"){show_divider=true;show_user=true}else{if(theme=="light"&&msg.subtype=="file_share"||msg.subtype=="file_mention"){show_divider=true}else{show_divider=false}if(!prev_msg.subtype||TS.templates.builders.getBotIdentifier(prev_msg)&&dont_show_dupe_bot_users){if(replies_enabled){var prev_thread_ts=prev_msg.thread_ts||prev_msg.ts;var is_part_of_same_convo=msg.thread_ts==prev_thread_ts;var neither_are_part_of_convo=!msg.thread_ts&&!prev_msg.thread_ts;if(is_part_of_same_convo||neither_are_part_of_convo){show_user=false}}else{show_user=false}}if(TS.utility.msgs.isTempMsg(msg)&&(msg.type=="bot_message"||msg.user=="USLACKBOT")){show_user=true}}}if(!unprocessed&&!TS.utility.date.sameDay(msg_date,last_rendered_msg_date)&&!is_in_conversation){new_day=true;var $dividers=$(container_id_with_hash+" div.day_divider");if($dividers.length>0){var new_messages_day_divider_html;var $last_divider=$($dividers[$dividers.length-1]);if($last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $last_divider.data('ts'):"+$last_divider.data("ts");TS.info("Problem with TS.templates.messages_day_divider 2.1: "+JSON.stringify(err))}$last_divider.replaceWith(new_messages_day_divider_html)}if($dividers.length>1){var $second_last_divider=$($dividers[$dividers.length-2]);if($second_last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$second_last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $second_last_divider.data('ts'):"+$second_last_divider.data("ts");TS.info("Problem with TS.templates.messages_day_divider 3.1: "+JSON.stringify(err))}$second_last_divider.replaceWith(new_messages_day_divider_html)}}}}if(!unprocessed&&TS.utility.date.distanceInMinutes(msg_date,last_rendered_msg_date)>TS.model.msg_activity_interval){last_time_divider=true;model_ob.last_time_divider=msg_date}}else if(!is_in_conversation){last_time_divider=true;model_ob.last_time_divider=msg_date}}if(last_time_divider){show_user=true;first_in_block=true}if(msg.type!="message")show_user=true;if(msg.subtype=="bot_message"){if(TS.templates.builders.getBotIdentifier(msg)){if(!dont_show_dupe_bot_users)show_user=true}else{show_user=false}}if(msg.subtype=="me_message"||prev_msg&&prev_msg.subtype=="me_message"){show_user=true;show_divider=true}var do_inline_imgs=true;if(standalone)do_inline_imgs=false;var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var show_actions_cog=false;if(actions.edit_msg||actions.delete_msg||actions.pin_msg||actions.unpin_msg||actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){show_actions_cog=true}var has_rxns=false;var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns)has_rxns=true;if(args.for_mention_rxn_display)show_user=false;var highlight_as_new=!!(args&&args.highlight_as_new);var msg_dom_id=TS.templates.makeMsgDomId(msg.ts);if(TS.boot_data.feature_message_replies||TS.boot_data.feature_unread_view){msg_dom_id=args.msg_dom_id||msg_dom_id}var template_args={msg:msg,actions:actions,show_actions_cog:show_actions_cog,member:member,show_user:show_user,hide_user_name:hide_user_name,show_divider:show_divider,first_in_block:first_in_block,unread:unread,unprocessed:unprocessed,highlight:highlight,model_ob:model_ob,do_inline_imgs:do_inline_imgs,msg_dom_id:msg_dom_id,standalone:standalone,hide_actions:standalone||hide_actions,full_date:full_date,jump_link:jump_link,show_resend_controls:msg.ts in TS.model.display_unsent_msgs,starred_items_list:starred_items_list,starred_items_actions:starred_items_actions,theme:theme,no_attachments:no_attachments,is_ephemeral:is_ephemeral,enable_slack_action_links:enable_slack_action_links,is_bot:is_bot,bot_id:bot_id,app_id:app_id,highlight_as_new:highlight_as_new,show_star:!starred_items_list&&!is_ephemeral,has_rxns:has_rxns,for_mention_display:args.for_mention_display,for_mention_rxn_display:args.for_mention_rxn_display,for_search_display:args.for_search_display,ts_tip_delay_class:"ts_tip_delay_600",is_root_msg:args.is_root_msg,is_in_conversation:is_in_conversation,is_threads_view:is_threads_view,file_title_only:msg.subtype==="file_reaction",is_slackbot_response:msg.subtype==="slackbot_response"};if(actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){template_args.show_rxn_action=true}template_args.star_components=_buildStarComponents("message",msg,model_ob);if(TS.boot_data.feature_message_replies){var selectable=true;if(standalone)selectable=false;if(TS.utility.msgs.isFileMsg(msg))selectable=false;template_args.selectable=selectable;if(is_in_conversation){template_args.msg_dom_id=TS.templates.makeMsgDomIdInConversation(msg.ts)}if(is_in_conversation||is_threads_view){template_args.show_jump_action=!!TS.client&&(!msg.thread_ts||msg.thread_ts==msg.ts)}if(TS.utility.msgs.isMsgReply(msg)){template_args.show_reply_action=false}else{template_args.show_reply_action=TS.replies.canReplyToMsg(model_ob,msg)&&!args.is_root_msg;if(!template_args.show_reply_action&&TS.utility.msgs.isFileMsg(msg)&&msg.file)template_args.show_comment_action=true}if(TS.boot_data.feature_message_replies_off&&template_args.show_reply_action)template_args.show_reply_action=!!msg.reply_count;var is_root_msg=msg.ts==msg.thread_ts;if((is_root_msg||!msg.thread_ts)&&is_in_conversation&&TS.client){template_args.format_for_thread_root=true;if(model_ob.is_im||model_ob.is_mpim){template_args.model_ob_name="Direct message"}else{template_args.model_ob_name="in "+TS.shared.getDisplayNameForModelOb(model_ob)}}if(is_root_msg&&msg.reply_count&&!is_in_conversation&&!standalone&&!args.for_search_display&&!args.is_threads_view){template_args.show_reply_bar=true}template_args.is_tombstone=msg.subtype==="tombstone"}if(TS.boot_data.feature_pin_update){var item;if(msg.subtype==="file_share"||msg.subtype==="file_mention"){item=msg.file}else if(msg.subtype==="file_comment"){item=msg.comment}else{item=msg}if(item&&item.pinned_to&&item.pinned_to.length>0){template_args.is_pinned=_.some(item.pinned_to,function(id){return id===model_ob.id})}else{template_args.is_pinned=false}if(template_args.is_pinned){template_args.pin_html=TS.templates.builders.buildPinInfoHtml(msg)}else{template_args.pin_html=""}}if(TS.boot_data.feature_sli_recaps){var recap_item;if(msg.subtype==="file_share"||msg.subtype==="file_mention"){recap_item=msg.file}else if(msg.subtype==="file_comment"){recap_item=msg.comment}else{recap_item=msg}if(recap_item&&recap_item.recap){template_args.is_recap=recap_item.recap}else{template_args.is_recap=false}}if(!msg.subtype&&args.for_search_display&&msg.file){if(msg.comment){template_args.star_components=_buildStarComponents("file_comment",msg.comment,msg.file)}else{template_args.star_components=_buildStarComponents("file",msg.file,null)}}if(!TS.utility.msgs.isTempMsg(msg)&&!msg.is_ephemeral){template_args.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts);template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts)}if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_reaction"){if(msg.file){template_args.file=msg.file;template_args.edit=TS.files.getFileActions(msg.file).edit;template_args.download=!(msg.file.mode==="snippet"||(msg.file.mode==="post"||msg.file.mode==="space")||msg.file.is_external);template_args.new_window=!template_args.edit&&!template_args.download;template_args.abs_permalink=msg.file.permalink;if(!starred_items_list){template_args.star_components=_buildStarComponents("file",msg.file,null)}template_args.lightbox=false;if(msg.file.thumb_360_w==360||msg.file.thumb_360_h==360){template_args.lightbox=true}$.extend(template_args,TS.files.getFileTemplateArguments(msg.file,360));template_args.is_message=true;template_args.image_lazyload=!!TS.client;template_args.lightbox=true;if(msg.subtype=="file_share"&&msg.upload){if(msg.file.mode=="email")template_args.is_added=true;template_args.icon_class=TS.utility.getImageIconClass(msg.file,"thumb_80")}else if(msg.file.user!=msg.user){template_args.uploader=_getEntityFromFile(msg.file);template_args.is_not_welcome_post=!_isWelcomePostToTeamOwner(msg)}if(msg.subtype=="file_mention"){template_args.share_verb="mentioned"}else if(msg.subtype=="file_share"&&msg.upload){template_args.share_verb="uploaded";if(/(snippet)/.test(msg.file.mode))template_args.share_verb="added";if(msg.file.initial_comment){template_args.share_verb+=" and commented on";template_args.show_initial_comment=true}}else{template_args.share_verb="shared"}template_args.share_determiner="a";template_args.share_noun="file";if(/(snippet)/.test(msg.file.mode)){template_args.share_noun=msg.file.pretty_type+" snippet";var needs_an=["A","E","O","X"];var snowflakes=["HTML snippet","R snippet"];if(needs_an.indexOf(template_args.share_noun.charAt(0))>-1||snowflakes.indexOf(template_args.share_noun)>-1){template_args.share_determiner="an"}}if(/(email)/.test(msg.file.mode)){template_args.share_determiner="an";template_args.share_noun="email"}if(/(post|space)/.test(msg.file.mode))template_args.share_noun="post";if((msg.file.thumb_360||msg.file.thumb_360_gif)&&!(msg.file.external_type==="gdrive"&&msg.file.mimetype.indexOf("image/")<0)){template_args.share_determiner="an";template_args.share_noun="image"}html+=TS.templates.message(template_args)}}else if(msg.subtype=="file_comment"){if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){template_args["show_divider"]=false;if(!new_day)template_args["is_file_convo_continuation"]=true}template_args["show_comment_quote_icon"]=true;if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){if(prev_msg.subtype=="file_share"&&prev_msg.upload&&prev_msg.file.initial_comment){if(!new_day)template_args["show_comment_quote_icon"]=false}if(prev_msg.subtype=="file_comment"){if(!new_day)template_args["show_comment_quote_icon"]=false}}template_args["file"]=msg.file;template_args["icon_class"]=TS.utility.getImageIconClass(msg.file,"thumb_40");template_args["comment"]=msg.comment;template_args["member"]=_getEntityFromMessage(msg);if(msg.file&&msg.file.user!=msg.comment.user){template_args["uploader"]=_getEntityFromFile(msg.file)}if(!starred_items_list){template_args.star_components=_buildStarComponents("file_comment",msg.comment,msg.file)}html+=TS.templates.message(template_args)}else{html+=TS.templates.message(template_args)}html=TS.format.replaceHighlightMarkers(html);return html}catch(err){var extra="";if(msg){extra="msg.ts:"+msg.ts;delete args.model_ob;try{args.msg=_.cloneDeep(msg);args.msg.text="REDACTED";extra+=" "+JSON.stringify(args,null,"  ")}catch(err_again){}}if(!err.message)err.message="";err.message+=" "+extra;TS.info("Problem in buildMsgHTML with args: "+JSON.stringify(err.message));return""}},buildMsgHTMLNew:function(args){try{var msg=args.msg;var model_ob=args.model_ob;var prev_msg=args.prev_msg;var highlight=!!args.highlight;var no_attachments=!!args.no_attachments;var standalone=!!args.standalone;var hide_actions=!!args.hide_actions;var full_date=!!args.full_date;if(TS.model.prefs.fuller_timestamps&&!full_date)full_date=!TS.utility.date.sameDay(TS.utility.date.toDateObject(msg.ts),new Date);var jump_link=args.jump_link?new Handlebars.SafeString(args.jump_link):"";var starred_items_list=!!args.starred_items_list;var starred_items_actions=args.starred_items_actions;var container_id_with_hash=args.container_id?"#"+args.container_id:"";var html="";var member=_getEntityFromMessage(msg);var show_user=true;var msg_date=TS.utility.date.toDateObject(msg.ts);var new_day=false;var last_time_divider=false;var unprocessed=!!msg.rsp_id;var current_speaker=msg.user;var is_ephemeral=msg.is_ephemeral;if(!current_speaker)current_speaker=TS.templates.builders.getBotIdentifier(msg);var is_bot=TS.utility.msgs.shouldHaveBotLabel(msg,member);var msg_dom_id=TS.templates.makeMsgDomId(msg.ts);var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_in_conversation=replies_enabled&&!!args.is_in_conversation;var highlight_as_new=!!(args&&args.highlight_as_new);if(TS.boot_data.feature_message_replies||TS.boot_data.feature_unread_view){msg_dom_id=args.msg_dom_id||msg_dom_id}var prev_speaker;if(prev_msg){prev_speaker=prev_msg.subtype=="file_comment"&&prev_msg.comment?prev_msg.comment.user:prev_msg.user;if(!prev_speaker){prev_speaker=TS.templates.builders.getBotIdentifier(prev_msg)}}if(!msg.no_display&&!standalone){if(prev_msg){var last_rendered_msg_date=TS.utility.date.toDateObject(prev_msg.ts);if(msg.subtype&&msg.subtype=="file_comment"&&msg.comment){current_speaker=msg.comment.user}if(TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)!=-1){show_user=true}else if(prev_speaker==current_speaker&&TS.utility.msgs.automated_subtypes.indexOf(prev_msg.subtype)===-1){if(!msg.subtype&&prev_msg.subtype&&prev_msg.subtype=="file_comment"){show_user=true}else{if(!prev_msg.subtype||TS.templates.builders.getBotIdentifier(prev_msg)){if(replies_enabled){var prev_thread_ts=prev_msg.thread_ts||prev_msg.ts;var is_part_of_same_convo=msg.thread_ts==prev_thread_ts;var neither_are_part_of_convo=!msg.thread_ts&&!prev_msg.thread_ts;if(is_part_of_same_convo||neither_are_part_of_convo){show_user=false}}else{show_user=false}}if(TS.utility.msgs.isTempMsg(msg)&&(msg.type=="bot_message"||msg.user=="USLACKBOT")){show_user=true}}}if(!unprocessed&&!TS.utility.date.sameDay(msg_date,last_rendered_msg_date)&&!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.info("Problem with TS.templates.messages_day_divider 1.1: "+JSON.stringify(err))}}new_day=true;var $dividers=$(container_id_with_hash+" div.day_divider");if($dividers.length>0){var new_messages_day_divider_html;var $last_divider=$($dividers[$dividers.length-1]);if($last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $last_divider.data('ts'):"+$last_divider.data("ts");TS.info("Problem with TS.templates.messages_day_divider 2.1: "+JSON.stringify(err))}$last_divider.replaceWith(new_messages_day_divider_html)}if($dividers.length>1){var $second_last_divider=$($dividers[$dividers.length-2]);if($second_last_divider.length){new_messages_day_divider_html="";try{new_messages_day_divider_html=TS.templates.messages_day_divider({ts:$second_last_divider.data("ts")})}catch(err){if(!err.message)err.message="";err.message+=" $second_last_divider.data('ts'):"+$second_last_divider.data("ts");TS.info("Problem with TS.templates.messages_day_divider 3.1: "+JSON.stringify(err))}$second_last_divider.replaceWith(new_messages_day_divider_html)}}}}if(!unprocessed&&TS.utility.date.distanceInMinutes(msg_date,last_rendered_msg_date)>TS.model.msg_activity_interval){last_time_divider=true;model_ob.last_time_divider=msg_date}}else if(!is_in_conversation){if(!$(container_id_with_hash+' div.day_divider[data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'"]').length){try{html+=TS.templates.messages_day_divider({ts:msg.ts})}catch(err){if(!err.message)err.message="";err.message+=" msg.ts:"+(msg?msg.ts:"no msg?");TS.info("Problem with TS.templates.messages_day_divider 4.1: "+JSON.stringify(err))}}last_time_divider=true;model_ob.last_time_divider=msg_date}}if(last_time_divider){show_user=true}if(msg.type!="message")show_user=true;if(msg.subtype=="bot_message"){show_user=false}if(msg.subtype=="me_message"||prev_msg&&prev_msg.subtype=="me_message"){show_user=true}var do_inline_imgs=true;if(standalone)do_inline_imgs=false;var has_rxns=false;var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns)has_rxns=true;if(args.for_mention_rxn_display)show_user=false;var template_args={msg:msg,model_ob:model_ob,member:member,actions:actions,show_user:show_user,unprocessed:unprocessed,highlight:highlight,do_inline_imgs:do_inline_imgs,msg_dom_id:msg_dom_id,standalone:standalone,hide_actions:standalone||hide_actions,full_date:full_date,jump_link:jump_link,show_resend_controls:msg.ts in TS.model.display_unsent_msgs,starred_items_list:starred_items_list,starred_items_actions:starred_items_actions,no_attachments:no_attachments,is_ephemeral:is_ephemeral,enable_slack_action_links:!!args.enable_slack_action_links,is_bot:is_bot,highlight_as_new:highlight_as_new,show_star:!starred_items_list&&!is_ephemeral,has_rxns:has_rxns,for_mention_display:args.for_mention_display,for_mention_rxn_display:args.for_mention_rxn_display,for_search_display:args.for_search_display,ts_tip_delay_class:"ts_tip_delay_600",is_root_msg:args.is_root_msg,is_in_conversation:is_in_conversation,is_slackbot_response:msg.subtype==="slackbot_response"};if(actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn){template_args.show_rxn_action=true}template_args.star_components=_buildStarComponents("message",msg,model_ob);if(TS.boot_data.feature_message_replies){var selectable=true;if(standalone)selectable=false;if(TS.utility.msgs.isFileMsg(msg))selectable=false;template_args.selectable=selectable;if(is_in_conversation){template_args.show_reply_action=false;template_args.show_jump_action=!!TS.client;template_args.show_jump_action=!!TS.client&&(!msg.thread_ts||msg.thread_ts==msg.ts);template_args.msg_dom_id=TS.templates.makeMsgDomIdInConversation(msg.ts)}else{template_args.show_reply_action=TS.replies.canReplyToMsg(model_ob,msg)&&!args.is_root_msg;if(!template_args.show_reply_action&&TS.utility.msgs.isFileMsg(msg)&&msg.file)template_args.show_comment_action=true}var is_root_msg=msg.ts==msg.thread_ts;if((is_root_msg||!msg.thread_ts)&&is_in_conversation&&TS.client){template_args.format_for_thread_root=true;if(model_ob.is_im||model_ob.is_mpim){template_args.model_ob_name="Direct message"}else{template_args.model_ob_name="in "+TS.shared.getDisplayNameForModelOb(model_ob)}}if(is_root_msg&&msg.reply_count&&!is_in_conversation&&!standalone&&!args.for_search_display){template_args.show_reply_bar=true}template_args.is_tombstone=msg.subtype==="tombstone"}if(TS.boot_data.feature_pin_update){var item;if(msg.subtype==="file_share"||msg.subtype==="file_mention"){item=msg.file}else if(msg.subtype==="file_comment"){item=msg.comment}else{item=msg}if(item&&item.pinned_to&&item.pinned_to.length>0){template_args.is_pinned=_.some(item.pinned_to,function(id){return id===model_ob.id})}else{template_args.is_pinned=false}if(template_args.is_pinned){template_args.pin_html=TS.templates.builders.buildPinInfoHtml(msg)}else{template_args.pin_html=""}}if(TS.boot_data.feature_sli_recaps){var recap_item;if(msg.subtype==="file_share"||msg.subtype==="file_mention"){recap_item=msg.file}else if(msg.subtype==="file_comment"){recap_item=msg.comment}else{recap_item=msg}if(recap_item&&recap_item.recap){template_args.is_recap=recap_item.recap}else{template_args.is_recap=false}}if(!msg.subtype&&args.for_search_display&&msg.file){if(msg.comment){template_args.star_components=_buildStarComponents("file_comment",msg.comment,msg.file)}else{template_args.star_components=_buildStarComponents("file",msg.file,null)}}if(!TS.utility.msgs.isTempMsg(msg)&&!msg.is_ephemeral){template_args.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts);template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts)}if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_reaction"){if(msg.file){template_args.file=msg.file;template_args.edit=TS.files.getFileActions(msg.file).edit;template_args.download=!(msg.file.mode==="snippet"||(msg.file.mode==="post"||msg.file.mode==="space")||msg.file.is_external);template_args.new_window=!template_args.edit&&!template_args.download;template_args.abs_permalink=msg.file.permalink;if(!starred_items_list){template_args.star_components=_buildStarComponents("file",msg.file,null)}template_args.file_viewer=false;if(msg.file.thumb_360_w==360||msg.file.thumb_360_h==360){template_args.file_viewer=true}$.extend(template_args,TS.files.getFileTemplateArguments(msg.file,360));template_args.is_message=true;template_args.image_lazyload=!!TS.client;template_args.file_viewer=true;if(msg.subtype=="file_share"&&msg.upload){if(msg.file.mode=="email")template_args.is_added=true;template_args.icon_class=TS.utility.getImageIconClass(msg.file,"thumb_80")}else if(msg.file.user!=msg.user){template_args.uploader=_getEntityFromFile(msg.file);template_args.is_not_welcome_post=!_isWelcomePostToTeamOwner(msg)}if(msg.subtype=="file_mention"){template_args.share_verb="mentioned"}else if(msg.subtype=="file_share"&&msg.upload){template_args.share_verb="uploaded";if(/(snippet)/.test(msg.file.mode))template_args.share_verb="added";if(msg.file.initial_comment){template_args.share_verb+=" and commented on";template_args.show_initial_comment=true}}else{template_args.share_verb="shared"}template_args.share_determiner="a";template_args.share_noun="file";if(/(snippet)/.test(msg.file.mode)){template_args.share_noun=msg.file.pretty_type+" snippet";var needs_an=["A","E","O","X"];var snowflakes=["HTML snippet","R snippet"];if(needs_an.indexOf(template_args.share_noun.charAt(0))>-1||snowflakes.indexOf(template_args.share_noun)>-1){template_args.share_determiner="an"}}if(/(email)/.test(msg.file.mode)){template_args.share_determiner="an";template_args.share_noun="email"}if(/(post|space)/.test(msg.file.mode))template_args.share_noun="Post";if((msg.file.thumb_360||msg.file.thumb_360_gif)&&!(msg.file.external_type==="gdrive"&&msg.file.mimetype.indexOf("image/")<0)){template_args.share_determiner="an";template_args.share_noun="image"}html+=TS.templates.message(template_args)}}else if(msg.subtype=="file_comment"){if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){if(!new_day)template_args["is_file_convo_continuation"]=true}template_args["show_comment_quote_icon"]=true;if(prev_msg&&!prev_msg.no_display&&prev_msg.file&&msg.file&&msg.file.id==prev_msg.file.id){if(prev_msg.subtype=="file_share"&&prev_msg.upload&&prev_msg.file.initial_comment){if(!new_day)template_args["show_comment_quote_icon"]=false}if(prev_msg.subtype=="file_comment"){if(!new_day)template_args["show_comment_quote_icon"]=false}}template_args["file"]=msg.file;template_args["icon_class"]=TS.utility.getImageIconClass(msg.file,"thumb_40");template_args["comment"]=msg.comment;template_args["member"]=_getEntityFromMessage(msg);if(msg.file&&msg.file.user!=msg.comment.user){template_args["uploader"]=_getEntityFromFile(msg.file)}if(!starred_items_list){template_args.star_components=_buildStarComponents("file_comment",msg.comment,msg.file)}html+=TS.templates.message(template_args)}else{html+=TS.templates.message(template_args)}html=TS.format.replaceHighlightMarkers(html);return html}catch(err){var extra="";if(msg){extra="msg.ts:"+msg.ts;delete args.model_ob;try{args.msg=_.cloneDeep(msg);args.msg.text="REDACTED";extra+=" "+JSON.stringify(args,null,"  ")}catch(err_again){}}if(!err.message)err.message="";err.message+=" "+extra;TS.info("Problem in buildMsgHTML with args: "+JSON.stringify(err.message));return""}},buildReplyBarHTML:function(msg,model_ob){if(!TS.boot_data.feature_message_replies)return"";var template_args={msg:msg,model_ob:model_ob,conversation_permalink:TS.utility.msgs.constructConversationPermalink(model_ob,msg.thread_ts)};var replies=msg.replies;if(replies&&replies.length){template_args.num_replies=replies.length;var unique_repliers=_.chain(replies).map(function(reply){return TS.members.getMemberById(reply.user)}).compact().uniq().value();template_args.first_repliers=_.take(unique_repliers,5);template_args.additional_reply_count=unique_repliers.length-template_args.first_repliers.length;var last_ts=_.last(replies).ts;var last_date=TS.utility.date.toDateObject(last_ts);if(TS.utility.date.sameDay(last_date,new Date)){if(template_args.num_replies===1){template_args.last_reply_at="Today at "+TS.utility.date.toTime(last_ts,true)}else{template_args.last_reply_at="Last reply today at "+TS.utility.date.toTime(last_ts,true)}}else{if(template_args.num_replies===1){template_args.last_reply_at=TS.utility.date.toTimeAgo(last_ts)}else{template_args.last_reply_at="Last reply "+TS.utility.date.toTimeAgo(last_ts)}}}return TS.templates.message_reply_bar(template_args)},formatSoundUrl:function(attachment,msg){return""},buildAttachmentActions:function(attachment,disable_buttons){var rendered_actions=attachment.actions.map(function(action){switch(action.type){case"button":return TS.templates.builders.buildAttachmentActionButtonHTML(action,disable_buttons);case"select":if(TS.boot_data.feature_message_menus){return TS.templates.builders.buildAttachmentActionSelectHTML(action,disable_buttons)}break}});var actions_html=rendered_actions.join("");return actions_html},buildAttachmentHTML:function(args){var msg_dom_id=TS.templates.makeMsgDomId(args.msg.ts);if(TS.boot_data.feature_message_replies){msg_dom_id=args.msg_dom_id||msg_dom_id}var attachment=args.attachment;var model_ob=args.model_ob||TS.shared.getActiveModelOb();if(TS.templates.builders.shouldDoSimpleAttachment(attachment,args.msg)){if(attachment.video_html){return TS.templates.builders.buildInlineVideoTogglerAndDiv(attachment.from_url,msg_dom_id)}else if(attachment.image_url){return TS.templates.builders.buildInlineImgTogglerAndDiv(attachment.from_url,msg_dom_id,args)}else if(attachment.audio_url){return" "+TS.templates.builders.formatSoundUrl(attachment,args.msg)}}if(attachment.color){if(typeof attachment.color=="number")attachment.color=attachment.color.toString();if(!attachment.color.indexOf){TS.warn("msg "+args.msg.ts+" has an invalid (non string) color:"+attachment.color+" (removed in client)");delete attachment.color}else{if(attachment.color.indexOf("#")!=-1){TS.warn("msg "+args.msg.ts+" has an invalid color:"+attachment.color+" (fixed in client)")}attachment.color=attachment.color.replace(/\#/g,"")}}var short_fields=[];var long_fields=[];if(attachment.fields){var f;var new_row;var last;for(var i=0;i<attachment.fields.length;i++){new_row=true;f=attachment.fields[i];if(last&&f["short"]&&last["short"]&&last._new_row){new_row=false}f._new_row=new_row;last=f;if(f["short"]){short_fields.push(f)}else{long_fields.push(f)}}}var should_expand=!attachment._always_expand&&attachment._short_text&&!TS.inline_attachments.shouldExpandText(TS.templates.makeMsgAttachmentTextExpanderDomId(args.msg.ts,attachment._index));var has_more=!!attachment.more;var ts_link=attachment.from_url||attachment.ts_link||attachment.title_link||attachment.author_link;var is_broadcast=_.get(args.msg,"subtype")==="reply_broadcast";var thumb_link=attachment.thumb_link||ts_link;var can_delete=false;if(!model_ob){TS.warn("need to get model_ob passed in here somehow! for expanding messages in activity feed")}else if(args.can_delete!==false){can_delete=(attachment.id||attachment.id===0)&&(attachment.from_url||args.msg.text)&&(TS.model.user.is_admin&&!model_ob.is_im||TS.model.user.id==args.msg.user)&&(args.msg.subtype!=="pinned_item"&&!is_broadcast)}var small_thumb=attachment.thumb_url&&!attachment.image_url&&!attachment.video_html&&!attachment.audio_html;var small_thumb_url=small_thumb?attachment.proxied_thumb_url||attachment.thumb_url:null;if(TS.boot_data.feature_pin_update){if(attachment.is_msg_unfurl){var attached_msg=TS.utility.msgs.getMsg(attachment.ts,model_ob.msgs);if(attached_msg&&attached_msg.pinned_to&&attached_msg.pinned_to.length>0){attachment.is_pinned=_.some(attached_msg.pinned_to,function(id){return id===model_ob.id});if(attachment.is_pinned){attachment.pin_html=TS.templates.builders.buildPinInfoHtml(attached_msg)}else{attachment.pin_html=""}}}}var meta=false;if(is_broadcast){var ampm=true;if(attachment.ts){meta=TS.utility.date.toTime(attachment.ts,ampm)}else{meta=TS.utility.date.toTime(args.msg.ts,ampm)}}var clickable=attachment.from_url&&args.has_container;if(is_broadcast)clickable=true;var attachment_args={is_text_collapsed:should_expand,has_more:has_more,attachment:attachment,attachment_meta:meta,short_fields:short_fields,long_fields:long_fields,msg:args.msg,msg_dom_id:msg_dom_id,real_src:TS.utility.attachments.getMediaSource(attachment),is_standalone:!args.msg.text||args.msg.ignore_if_attachments_supported||!attachment.pretext,show_fields_table:TS.qs_args["show_fields_table"]!="0",can_delete:can_delete,thumb_link:thumb_link,small_thumb_url:small_thumb_url,show_fallback:TS.model.show_attachment_fallback,enable_slack_action_links:args.enable_slack_action_links===true};if(!args.from_post){attachment_args=_.assign(attachment_args,{attachment:attachment,has_actions:!!(!_.isEmpty(attachment.actions)||!_.isEmpty(attachment.legacy_actions)),has_source:_.some(attachment._source),has_border:args.has_border,has_container:args.has_container,has_media:args.show_media_caret,has_text_content:!!(attachment.text||attachment.title),has_thumb:!!small_thumb,has_footer:!!(attachment.footer||attachment.footer_icon||attachment.ts)&&!is_broadcast,disable_buttons:TS.boot_data.app==="web"||args.enable_slack_action_links!==true,border_color:attachment.color&&"#"+attachment.color||null,break_border:args.break_border,caret_location:TS.utility.attachments.getMediaCaretLocation(attachment)});attachment_args.applied_classes=TS.utility.getAppliedClasses({inline_attachment:true,standalone:attachment_args.is_standalone,has_thumb:attachment_args.has_thumb,can_delete:attachment_args.can_delete,clickable:clickable,message_unfurl:attachment._unfurl_type_message,reply_broadcast:is_broadcast,is_pinned:TS.boot_data.feature_pin_update&&attachment.is_pinned});return TS.templates.message_attachment(attachment_args)}else{var expand_it=true;var caret_html="";if(args.show_initial_caret||args.show_media_caret){var media_type=TS.utility.attachments.getMediaType(attachment);switch(media_type){case"video":var inline_video=TS.model.inline_videos[attachment.from_url||attachment.thumb_url];if(inline_video){var no_title_in_toggler=true;caret_html=TS.templates.builders.buildInlineVideoToggler(attachment.from_url||attachment.thumb_url,msg_dom_id,no_title_in_toggler);expand_it=TS.inline_videos.shouldExpand(msg_dom_id,inline_video)}break;case"audio":var inline_audio=TS.model.inline_audios[attachment.audio_html||attachment.audio_url];if(inline_audio){caret_html=TS.templates.builders.buildInlineAudioToggler(attachment.audio_html||attachment.audio_url,msg_dom_id);expand_it=TS.inline_audios.shouldExpand(msg_dom_id,inline_audio)}break;case"other":var inline_other=TS.model.inline_others[attachment.other_html];if(inline_other){caret_html=TS.templates.builders.buildInlineOtherToggler(attachment.other_html,msg_dom_id);expand_it=TS.inline_others.shouldExpand(msg_dom_id,inline_other)}break;case"image":var inline_img=TS.model.inline_imgs[attachment.from_url||attachment.image_url];if(inline_img){var no_bytes_in_toggler=!args.show_media_caret;caret_html=TS.templates.builders.buildInlineImgToggler(attachment.from_url||attachment.image_url,msg_dom_id,no_bytes_in_toggler);expand_it=TS.inline_imgs.shouldExpand(msg_dom_id,inline_img)}break;default:var inline_attachment=TS.model.inline_attachments[attachment.from_url];if(inline_attachment){caret_html=TS.templates.builders.buildInlineAttachmentToggler(attachment.from_url,msg_dom_id);expand_it=TS.inline_attachments.shouldExpand(msg_dom_id,inline_attachment)}else{TS.warn("no inline_attachment for "+attachment.from_url)}break}}_.assign(attachment_args,{
initial_caret_html:args.show_initial_caret?new Handlebars.SafeString(caret_html):"",media_caret_html:args.show_media_caret?new Handlebars.SafeString(caret_html):"",expand_media:args.show_media_caret?expand_it:true,expand_it:args.show_initial_caret?expand_it:true,bg_color:attachment.color||"e3e4e6",thumb_at_top:!window.attach_thumb_align_title,ts_link:ts_link,small_thumb:small_thumb,max_width_class:small_thumb?"right_thumb_max_w":"",show_action_links:args.enable_slack_action_links===true,has_content:args.has_content});return TS.templates.spaces_attachment(attachment_args)}},buildAttachmentActionButtonHTML:function(action,disable_buttons){disable_buttons=disable_buttons===true;var button_defaults={_disabled:disable_buttons,_loading:false,id:"",name:"",style:"default",text:"",value:""};var style_to_class={"default":"",primary:"btn_primary",danger:"btn_danger"};var current_text=action.clicked&&action.clicked_text?action.clicked_text:action.text;var formatted_text=TS.emoji.graphicReplace(current_text);var button_model=_.merge({},button_defaults,action,{btn_class:style_to_class[action.style],current_text:new Handlebars.SafeString(formatted_text)});return TS.templates.attachment_actions_button(button_model)},buildAttachmentActionSelectHTML:function(action,disable_buttons){var model=TS.attachment_actions.select.getActionModel(action,disable_buttons);return TS.templates.attachment_actions_select(model)},shouldDoSimpleAttachment:function(attachment,msg){var do_simple=false;if(msg.standalone_attachment)return false;if((attachment.image_url||attachment.audio_url)&&attachment.from_url){if(msg&&msg.text){if(msg.text.indexOf(attachment.from_url)!=-1){do_simple=true}if(TS.model.ampersands_are_inconsistent_in_from_urls){if(msg.text.indexOf(attachment.from_url.replace(/\&/g,"&amp;"))!=-1){do_simple=true}}}if(attachment.service_name||attachment.title)do_simple=false}return do_simple},formatAttachments:function(msg,model_ob,enable_slack_action_links,msg_dom_id){if(!msg.attachments)return"";var html="";var attachment_groups=[];var attachment;var attachments_to_be_shown=msg.attachments.length;var ATTACHMENTS_LIMIT=20;if(msg.attachments.length>=ATTACHMENTS_LIMIT){if(!msg._shown_attachments){msg._shown_attachments=ATTACHMENTS_LIMIT}attachments_to_be_shown=msg._shown_attachments}for(var i=0;i<attachments_to_be_shown;i++){attachment=msg.attachments[i];if(attachment.pretext||i==0){attachment_groups.push([])}_.last(attachment_groups).push(attachment)}for(var i=0;i<attachment_groups.length;i++){html+=TS.templates.builders.formatAttachmentGroup(attachment_groups[i],msg,enable_slack_action_links,msg_dom_id,model_ob)}if(msg._shown_attachments<msg.attachments.length){html+=TS.templates.builders.getShowMoreAttachmentHTML(msg)}return html},formatAttachmentGroup:function(attachments,msg,enable_slack_action_links,msg_dom_id,model_ob){enable_slack_action_links=enable_slack_action_links===true;var html="";attachments=attachments.map(function(attachment){return TS.utility.attachments.getDecoratedAttachment(attachment,msg)});var is_broadcast=msg&&msg.subtype==="reply_broadcast";var has_container=!!TS.model.prefs.attachments_with_borders;if(is_broadcast)has_container=true;var use_shrink_wrap=has_container&&_.some(attachments,TS.utility.attachments.getMediaType);var has_border=has_container?_.some(attachments,"color"):true;var has_link=_.some(attachments,"from_url");var preamble=false;if(is_broadcast){preamble=TS.templates.reply_broadcast_preamble(attachments[0]);preamble=new Handlebars.SafeString(preamble)}var attachment;for(var i=0;i<attachments.length;i++){attachment=attachments[i];if(!attachment){TS.info("formatAttachments bad attach");TS.dir(0,msg);continue}if(attachment.from_url&&(TS.boot_data.feature_attachments_inline||TS.templates.builders.shouldDoSimpleAttachment(attachment,msg))){html+="";continue}if(attachment.ts){attachment.ts_link=TS.utility.msgs.constructMsgPermalink(model_ob,attachment.ts.toString())}if(!TS.inline_attachments.shouldShow(attachment,msg)){html+="";continue}if(attachment.actions&&attachment.actions.length){var ACTION_TYPE_WHITELIST=["button"];if(TS.boot_data.feature_message_menus){ACTION_TYPE_WHITELIST.push("select")}var action;var legacy_actions=[];var new_actions=[];for(var j=0;j<attachment.actions.length;j++){action=attachment.actions[j];if(_.includes(ACTION_TYPE_WHITELIST,action.type)){new_actions.push(action)}else{legacy_actions.push(action)}}if(legacy_actions.length){attachment.legacy_actions=legacy_actions}if(new_actions.length){attachment.actions=new_actions}}var has_content=TS.utility.attachments.hasContent(attachment,["pretext"]);if(has_content){var next_attachment=attachments[i+1];html+=TS.templates.builders.buildAttachmentHTML({model_ob:model_ob,attachment:attachment,has_border:has_border,has_container:has_container,break_border:has_border&&next_attachment&&attachment.color!=next_attachment.color,url:null,msg:msg,msg_dom_id:TS.boot_data.feature_message_replies&&msg_dom_id,show_initial_caret:TS.templates.builders.shouldDoSimpleAttachment(attachment,msg),show_media_caret:attachment.video_html||attachment.image_url||attachment.audio_html||attachment.audio_url||attachment.other_html,enable_slack_action_links:enable_slack_action_links,has_content:has_content})}if(is_broadcast&&i===0){html+=TS.templates.reply_broadcast_count(attachment)}}if(html||attachment.pretext){return TS.templates.attachment_group({model_ob:model_ob,first_attachment:attachments[0],preamble:preamble,msg:msg,has_border:has_border,has_container:has_container,has_link:has_link,use_shrink_wrap:use_shrink_wrap,attachments_html:html&&new Handlebars.SafeString(html)})}else{return html}},getShowMoreAttachmentHTML:function(msg){var difference=msg.attachments.length-msg._shown_attachments;var btn_text="";var ts=msg.ts;var model_ob=TS.shared.getActiveModelOb();var clickable_show_more_link=false;if(TS.client&&!(model_ob.is_channel&&!model_ob.is_member)){clickable_show_more_link=true;if(msg.attachments.length-msg._shown_attachments>20){btn_text="Show next 20 items"}else{if(difference==1){btn_text="Show remaining 1 item"}else{btn_text="Show remaining "+difference.toString()+" items"}}}else{if(difference==1){btn_text="1 more attachment"}else{btn_text=difference.toString()+" more attachments"}}return TS.templates.show_more_attachment({ts:ts,btn_text:btn_text,clickable_show_more_link:clickable_show_more_link})},formatMessageAsAttachment:function(msg,model_ob){var author,user_id,bot_id;if(msg.user){user_id=msg.user}else if(msg.subtype==="file_comment"&&msg.comment&&msg.comment.user){user_id=msg.comment.user}else if(msg.bot_id){bot_id=msg.bot_id}if(!msg.text&&msg.attachments&&msg.attachments.length>=1&&msg.attachments[0].is_share){author={author_name:msg.attachments[0].author_name,author_subname:msg.attachments[0].author_subname,author_icon:msg.attachments[0].author_icon,author_link:msg.attachments[0].author_link}}else if(user_id){var member=TS.members.getMemberById(user_id);author={author_name:TS.boot_data.feature_name_tagging_client?TS.members.getMemberFullName(member):TS.members.getMemberRealName(member),author_subname:TS.boot_data.feature_name_tagging_client?TS.members.getMemberPreferredName(member):member.name,author_icon:member.profile.image_24,author_link:TS.boot_data.feature_name_tagging_client?"/team/"+user_id:"/team/"+TS.utility.htmlEntities(member.name)}}else if(bot_id){var bot=TS.bots.getBotById(bot_id);author={author_subname:msg.username||bot.name,author_icon:bot.icons.image_48,author_link:"/services/"+bot.id};if(msg.icons&&msg.icons.emoji&&msg.icons.image_64)author.author_icon=msg.icons.image_64}if(!author){TS.error("no author for msg "+msg.ts);return""}var fake_attachment=_.extend({},author,{is_msg_unfurl:true,id:1,ts:msg.ts,from_url:TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts)});if(msg.text){fake_attachment.text=msg.text;fake_attachment.mrkdwn_in_hash={text:true}}else if(msg.attachments&&msg.attachments.length>=1){var first_attachment=msg.attachments[0];fake_attachment.text=first_attachment.text||first_attachment.pretext}TS.inline_attachments.massageAttachment(fake_attachment,0);fake_attachment=TS.utility.attachments.getDecoratedAttachment(fake_attachment,msg);fake_attachment.from_url=null;var msg_html=TS.templates.builders.buildAttachmentHTML({attachment:fake_attachment,msg:msg,can_delete:false,has_content:true,has_border:true});msg_html=TS.templates.attachment_group({msg:msg,attachments_html:new Handlebars.SafeString(msg_html)});return msg_html},buildJoinLeaveRollUpStr:function(ob){var str="";if(ob.is_in){if(ob.joined&&ob.left){str="left and rejoined"}else{str="joined"}}else{if(ob.joined&&ob.left){str="joined and left"}else{str="left"}}return str},buildSHRoomAttachment:function(room){if(!TS.boot_data.feature_calls)return"<div>The Calls feature is not turned on</div>";var participants=room.participants.map(function(participant_id){return TS.members.getMemberById(participant_id)});var is_creator=room.created_by===TS.model.user.id;var dm_member=TS.model.active_im_id?TS.members.getMemberById(TS.ims.getImById(TS.model.active_im_id).user):null;var dm_member_name;if(TS.boot_data.feature_name_tagging_client){dm_member_name=dm_member?TS.members.getMemberFullName(dm_member):""}else{dm_member_name=dm_member?TS.members.getMemberDisplayName(dm_member):""}var duration=room.date_end?room.date_end-room.date_start:0;var title="Shared a call";if(room.channels&&room.channels[0]===TS.model.active_cid){title="Started a call"}var description="";if(room.date_end){if(room.is_dm_call&&room.was_missed){var name=is_creator?dm_member_name:"You";if(room.was_rejected){description=name+" declined the call"}else{description=name+" missed the call"}}else if(!room.is_dm_call&&room.name){description=new Handlebars.SafeString('<span class="room_name">'+TS.utility.htmlEntities(room.name)+"</span> call has ended")}else{description="This call has ended"}}else{if(TS.model.is_our_app&&!!TS.model.lin_ssb_version&&!TS.boot_data.feature_calls_linux){description="The calls feature is not yet available for Linux"}else if(!room.is_dm_call){description=room.participants.indexOf(TS.model.user.id)!=-1?"You are on this call":"Join this call"}else if(room.participants.length===2){description="On a call with "+dm_member_name}else{description=is_creator?"Calling "+dm_member_name:dm_member_name+" is calling you"}}return TS.templates.message_screenhero_attachment({room:room,participants:participants,room_url:TS.utility.calls.getUrlForRoom(room),room_name:room.name?room.name+" call":"Untitled",title:title,description:description,show_description_ellipsis:room.participants.length===2,show_room_link:!room.date_end&&!(TS.model.is_our_app&&!!TS.model.lin_ssb_version&&!TS.boot_data.feature_calls_linux),expand_it:TS.inline_room_previews.shouldExpand(room.id),duration:duration})},formatMessageByType:function(msg,do_inline_imgs,enable_slack_action_links,model_ob,starred_items_list){var html="";var txt;if(msg.ignore_if_attachments_supported){return html}do_inline_imgs=do_inline_imgs===true;enable_slack_action_links=enable_slack_action_links===true;var channel,group,inviter,room;if((msg.hasOwnProperty("_jl_rollup_hash")||msg.hasOwnProperty("_jl_rolled_up_in"))&&_jl_rollup_limit_reached){return html}else{_jl_rollup_limit_reached=false}if(msg._jl_rollup_hash&&msg.user in msg._jl_rollup_hash.users){channel=model_ob;inviter=TS.members.getMemberById(msg.inviter);var user_ob=msg._jl_rollup_hash.users[msg.user];var str=TS.templates.builders.buildJoinLeaveRollUpStr(user_ob);str+=channel?" #"+channel.name:" the channel";if(user_ob.is_in&&inviter){str+=" by invitation from <@"+inviter.id+"|"+inviter.name+">"}var alsoA=[];var otherA=[];var also_str="along with";var ob;var count=0;for(var k in msg._jl_rollup_hash.users){if(k==msg.user)continue;if(count==_JL_ROLLUP_LIMIT){_jl_rollup_limit_reached=true;break}ob=msg._jl_rollup_hash.users[k];if(ob.is_in===user_ob.is_in){if(ob.is_in){if(ob.inviter==msg.user)also_str="and invited";if(ob.inviter&&(ob.inviter==user_ob.inviter||ob.inviter==msg.user)){alsoA.push("<@"+k+">")}else{otherA.push("<@"+k+"> "+TS.templates.builders.buildJoinLeaveRollUpStr(ob))}}else{alsoA.push("<@"+k+">")}}else{otherA.push("<@"+k+"> "+TS.templates.builders.buildJoinLeaveRollUpStr(ob))}count++}if(alsoA.length){str+=", "+also_str+" "+alsoA.join(", ");html=TS.format.formatNoHighlightsNoSpecials(str);if(_jl_rollup_limit_reached)html+=' and <a onclick="TS.client.channel_page.showMemberSectionAndHighlight();">some others</a>.';if(otherA.length){var other_str=". Also, "+otherA.join(", ");html+=TS.format.formatNoHighlightsNoSpecials(other_str);if(_jl_rollup_limit_reached)html+=' along with <a onclick="TS.client.channel_page.showMemberSectionAndHighlight();">some others</a>';html+="."}}else if(otherA.length){str+=". Also, "+otherA.join(", ");html=TS.format.formatNoHighlightsNoSpecials(str);if(_jl_rollup_limit_reached)html+=' along with <a onclick="TS.client.channel_page.showMemberSectionAndHighlight();">some others</a>';html+="."}else{html=TS.format.formatNoHighlightsNoSpecials(str)}}else if(msg.subtype=="channel_join"){channel=model_ob;inviter=TS.members.getMemberById(msg.inviter);if(inviter){txt="joined"+(channel?" #"+channel.name:" the channel")+" from an invitation by <@"+inviter.id+"|"+inviter.name+">";html=TS.format.formatNoHighlightsNoSpecials(txt,msg)}else{html="joined"+(channel?" #"+channel.name:" the channel")}}else if(msg.subtype=="channel_leave"){channel=model_ob;html="left"+(channel?" #"+channel.name:" the channel")}else if(msg.subtype=="channel_name"){html='renamed the channel from "'+msg.old_name+'" to "'+msg.name+'"'}else if(msg.subtype=="channel_topic"){if(!msg.topic){html="cleared the channel topic"}else{var formatted_topic=TS.format.formatWithOptions(msg.topic,msg,{no_highlights:true});html='set the channel topic: <span class="topic no_jumbomoji">'+formatted_topic+"</span>"}}else if(msg.subtype=="channel_purpose"){if(!msg.purpose){html="cleared the channel purpose"}else{var formatted_purpose=TS.format.formatWithOptions(msg.purpose,msg,{no_highlights:true});html='set the channel purpose: <span class="purpose no_jumbomoji">'+formatted_purpose+"</span>"}}else if(msg.subtype=="group_join"){group=model_ob;inviter=TS.members.getMemberById(msg.inviter);if(inviter){txt="joined"+(group?" "+TS.model.group_prefix+group.name:" the private channel")+" from an invitation by <@"+inviter.id+"|"+inviter.name+">";html=TS.format.formatNoHighlightsNoSpecials(txt,msg)}else{html="joined"+(group?" "+TS.model.group_prefix+group.name:" the private channel")}}else if(msg.subtype=="group_leave"){group=model_ob;html="left"+(group?" "+TS.model.group_prefix+group.name:" the private channel")}else if(msg.subtype=="group_name"){html='renamed the private channel from "'+msg.old_name+'" to "'+msg.name+'"'}else if(msg.subtype=="group_topic"){if(!msg.topic){html="cleared the channel topic"}else{var formatted_topic=TS.format.formatWithOptions(msg.topic,msg,{no_highlights:true});html='set the channel topic: <span class="no_jumbomoji">'+formatted_topic+"</span>"}}else if(msg.subtype=="group_purpose"){if(!msg.purpose){html="cleared the channel purpose"}else{var formatted_purpose=TS.format.formatWithOptions(msg.purpose,msg,{no_highlights:true});html='set the channel purpose: <span class="no_jumbomoji">'+formatted_purpose+"</span>"}}else if(msg.subtype=="group_archive"){group=model_ob;html="archived"+(group?" "+TS.model.group_prefix+group.name:" the private channel");if(TS.client&&group&&group.is_archived){if(TS.model.archive_view_is_showing){html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+group.name+'?force-browser=1">archives</a>.'}else{var method="TS.shared.closeArchivedChannel";html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+group.name+'?force-browser=1">archives</a>. 						It can also be un-archived at any time. To close it now, <a onclick="'+method+"('"+group.id+"')\">click here</a>."}}}else if(msg.subtype=="group_unarchive"){group=model_ob;html="un-archived"+(group?" "+TS.model.group_prefix+group.name:" the private channel")}else if(msg.subtype=="channel_archive"){channel=model_ob;html="archived"+(channel?" #"+channel.name:" the channel");if(TS.client&&channel&&channel.is_archived){if(TS.model.archive_view_is_showing){html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+channel.name+'?force-browser=1">archives</a>.'}else{html+='. The contents will still be available in search and browsable in the <a target="_blank" href="/archives/'+channel.name+'?force-browser=1">archives</a>. 						It can also be un-archived at any time. To close it now, <a onclick="TS.channels.closeArchivedChannel(\''+channel.id+"')\">click here</a>."}}}else if(msg.subtype=="channel_unarchive"){channel=model_ob;html="un-archived"+(channel?" #"+channel.name:" the channel")}else if(msg.subtype=="me_message"){html="<i>"+TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs})+"</i>"}else if(msg.subtype=="play_sound"){html='played "'+msg.sound+'"'}else if(msg.subtype=="sh_room_shared"||msg.subtype=="sh_room_created"){if(msg.subtype=="sh_room_shared"){}else{}if(starred_items_list){html+="<span>Shared a call</span>"}else if(msg._room_id&&(room=TS.rooms.getRoomById(msg._room_id))){html+=TS.templates.builders.buildSHRoomAttachment(room)}else{}}else if(msg.subtype==="bot_add"||msg.subtype==="bot_enable"||msg.subtype==="bot_updated"||msg.subtype==="bot_disable"||msg.subtype==="bot_remove"){html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links,no_highlights:true})}else if(msg.subtype==="reminder_add"||msg.subtype==="reminder_delete"){html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links,no_highlights:true})}else if(msg.subtype==="pinned_item"&&!msg.no_display){if(msg.item_type==="F"){var uploader=_getEntityFromFile(msg.item);html=TS.templates.message_pinned_file({file:msg.item,own_file:!!msg.item&&msg.item.user===msg.user,theme:TS.model.prefs.theme,uploader:uploader,model_ob:model_ob,display_name:TS.members.getMemberDisplayName(uploader)})}else if(msg.item_type==="Fc"){html=TS.templates.message_pinned_comment({theme:TS.model.prefs.theme,model_ob:model_ob});var commenter;if(msg.item)commenter=TS.members.getMemberById(msg.item.user);if(commenter&&msg.item.comment){html+=TS.templates.builders.buildAttachmentHTML({attachment:{author_icon:commenter.profile.image_24,author_name:commenter.profile.real_name,author_subname:commenter.name,color:"D0D0D0",ts:msg.item.timestamp,text:msg.item.comment,mrkdwn_in_hash:{text:true}},msg:msg})}}else if(msg.item_type==="C"||msg.item_type==="G"||msg.item_type==="D"){html=TS.templates.message_pinned_message({theme:TS.model.prefs.theme,model_ob:model_ob});var author;if(msg.item)author=TS.members.getMemberById(msg.item.user);if(author&&msg.item.text){html+=TS.templates.builders.buildAttachmentHTML({attachment:{author_icon:author.profile.image_24,author_name:author.profile.real_name,author_subname:author.name,color:"D0D0D0",ts:msg.item.ts,text:msg.item.text,mrkdwn_in_hash:{text:true}},msg:msg})}}}else{html=TS.format.formatWithOptions(msg.text,msg,{do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links})}if(!html&&html!==""){TS.warn("no html msg.subtype:"+msg.subtype);return""}html=TS.utility.msgs.handleSearchHighlights(html);return html},msgHtmlForSearch:function(msg,model_ob,result_type,main_msg,prev_msg){if(msg.subtype!=="bot_message"){msg.subtype=null}var html="";if(result_type==="extract"){html+='<div class="search_result_with_extract">';html+='<div class="extract_expand_icons"><i class="ts_icon ts_icon_chevron_up up_arrow"></i><i class="ts_icon ts_icon_chevron_down down_arrow"></i></div>'}else if(result_type==="context"){html+='<div class="search_result_for_context">'}else{html+='<div class="search_result_for_extra_context">'}html+=TS.templates.builders.buildMsgHTML({msg:msg,msg_dom_id:TS.boot_data.feature_message_replies&&TS.templates.makeMsgDomIdInSearch(msg.ts,main_msg),model_ob:model_ob,container_id:"search_message_results",standalone:true,for_search_display:true,search_result_type:result_type,prev_msg:TS.boot_data.feature_message_replies&&prev_msg});html+="</div>";return html},buildMsgHTMLForSearch:function(main_msg){var model_ob=main_msg.channel;var html="";var messages=[];if(main_msg.previous_2)messages.push(main_msg.previous_2);if(main_msg.previous)messages.push(main_msg.previous);messages.push(main_msg);if(main_msg.next)messages.push(main_msg.next);if(main_msg.next_2)messages.push(main_msg.next_2);if(messages.length>1&&!TS.search.view.resultHasExtracts(main_msg)){main_msg.force_extract_type="extract";if(main_msg.previous)main_msg.previous.force_extract_type="context";if(main_msg.next)main_msg.next.force_extract_type="context"}var prev_msg;messages.forEach(function(msg,inx){var result_type;if(msg.force_extract_type){result_type=msg.force_extract_type}else{result_type=TS.search.view.determineMessageResultType(messages,inx)}html+=TS.templates.builders.msgHtmlForSearch(msg,model_ob,result_type,main_msg,prev_msg);prev_msg=msg});return html},search_ellipsis:'<span class="extract_ellipsis">&hellip;</span>',buildStar:function(type,ob,parent_ob){var star_components=_buildStarComponents(type,ob,parent_ob);if(star_components==="")return"";if(TS.boot_data.feature_refactored_message_template){return TS.templates.star(star_components)}var attributes=star_components.attributes;var class_names=star_components.class_names;return"<span "+attributes.join(" ")+' class="'+class_names.join(" ")+'"></span>'},buildStarWithTip:function(type,ob,parent_ob){var star_components=_buildStarComponents(type,ob,parent_ob);if(star_components==="")return"";if(TS.boot_data.feature_refactored_message_template){return TS.templates.star_with_tip(star_components)}var attributes=star_components.attributes;var class_names=star_components.class_names;var tip_class_names=["ts_tip","ts_tip_float","ts_tip_hidden"];var position_class=TS.boot_data.feature_move_star_in_channel_header?"ts_tip_bottom":"ts_tip_top";tip_class_names.push(position_class);var star_cta="Star this ";var unstar_cta="Unstar this ";class_names=class_names.concat(tip_class_names);var star_tip_text=star_cta+type;var star_toggle_tip=unstar_cta+type;if(type==="file_comment"){star_tip_text=star_cta+"file comment";star_toggle_tip=unstar_cta+"file comment"}else if(type==="im"||type==="mpim"){star_tip_text=star_cta+"direct message";star_toggle_tip=unstar_cta+"direct message"}else if(type==="group"){star_tip_text=star_cta+"channel";star_toggle_tip=unstar_cta+"channel"}if(ob.is_starred){var tmp=star_tip_text;star_tip_text=star_toggle_tip;star_toggle_tip=tmp}var star_tip='<span class="ts_tip_tip" data-tip-toggle-auto="'+star_toggle_tip+'">'+star_tip_text+"</span>";return"<button "+attributes.join(" ")+' class="'+class_names.join(" ")+' btn_unstyle">'+star_tip+"</button>"},buildMentionHTML:function(mention){var msg=mention.message;var html="";if(!msg)return html;if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"||msg.subtype=="file_reaction"){if(!msg.file)return html}var model_ob=TS.shared.getModelObById(mention.channel);if(!model_ob)return html;var rxns;var max_rxns_to_display=4;var rxns_to_display=[];var others="";var jump_link="";var msg_html="";var for_mention_rxn_display=mention.type=="reaction";jump_link=TS.templates.builders.strBuilder('<a class="msg_right_link msg_jump" data-cid="${cid}">Jump</a>',{cid:model_ob.id});msg_html=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true,jump_link:jump_link,no_attachments:!!msg.text,for_mention_display:true,for_mention_rxn_display:for_mention_rxn_display});html=msg_html;if(for_mention_rxn_display){var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);rxns=TS.rxns.getExistingRxnsByKey(rxn_key);if(!rxns)return"";var newest_rxn=rxns[rxns.length-1];var newest_rxn_member_id=newest_rxn.users[newest_rxn.users.length-1];if(!TS.rxns.getRxnFromRxns(rxns,newest_rxn.name))return"";var all_rxners_but_newest=TS.rxns.getAllUniqueRxners(rxns,newest_rxn_member_id);var total_count=all_rxners_but_newest.length+1;if(total_count==2){var other_member=TS.members.getMemberById(all_rxners_but_newest[0]);others=" & "+TS.templates.builders.makeMemberPreviewLink(other_member)}else if(total_count>2){var should_escape=true;var include_at_sign=true;var tooltip_names=all_rxners_but_newest.map(function(member_id){return TS.members.getMemberDisplayNameById(member_id,should_escape,include_at_sign)});others=' & <span class="ts_tip ts_tip_multiline ts_tip_lazy ts_tip_top" title="'+TS.utility.concatNames(tooltip_names)+'">'+(total_count-1)+" "+(total_count==2?"other":"others")+"</span>"}rxns_to_display=rxns.filter(function(rxn){return TS.emoji.isValidName(rxn.name)}).slice(0,max_rxns_to_display).map(function(rxn){return new Handlebars.SafeString(TS.emoji.graphicReplace(":"+rxn.name+":"))});var newest_member=TS.members.getMemberById(newest_rxn_member_id);html=TS.templates.mentions_rxn({ts:msg.ts,rxns_to_display:rxns_to_display,msg_html:new Handlebars.SafeString(msg_html),rxn_members:new Handlebars.SafeString(TS.templates.builders.makeMemberPreviewLink(newest_member,true)+others),jump_link_html:new Handlebars.SafeString(jump_link),is_file_reaction:msg.subtype==="file_reaction"})}return html},buildThreadMentionHTML:function(mention){var reply=mention.message;var thread=mention.thread;var model_ob=TS.shared.getModelObById(mention.channel);var replier=_getEntityFromMessage(reply);var thread_author=_getEntityFromMessage(thread);var reply_msg_html=new Handlebars.SafeString(TS.templates.builders.formatMessageByType(reply,false,false,model_ob));var original_msg=thread;var thread_permalink=TS.utility.msgs.constructConversationPermalink(model_ob,thread.ts);var jump_permalink=TS.utility.msgs.constructMsgPermalink(model_ob,thread.ts);var rolled_up=mention.replies_rolled_up&&mention.replies_rolled_up.length;var n_others=0;var reply_max=9;var additional_reply_count=0;var repliers=rolled_up&&mention.replies_rolled_up.map(_getEntityFromMessage);if(repliers){repliers.unshift(replier);repliers=_.uniqBy(repliers,"id");repliers=_.reject(repliers,"is_self");n_others=Math.max(0,repliers.length-1);additional_reply_count=Math.max(0,repliers.length-reply_max);repliers=_.take(repliers,reply_max);repliers=_.reverse(repliers);if(repliers.length===1&&repliers[0]===replier){repliers=[];rolled_up=false}}var thread_author_name=thread.username;if(thread_author&&!thread.bot_id)thread_author_name=thread_author.is_self?"you":TS.members.getMemberDisplayName(thread_author);if(!n_others&&replier===thread_author)thread_author_name="their message";var template_args={model_ob:model_ob,reply_ts:reply.ts,thread_ts:thread.ts,replier:replier,thread_author:thread_author,thread_author_name:thread_author_name,thread_username:thread.username,reply_msg_html:reply_msg_html,original_msg:original_msg,thread_permalink:thread_permalink,jump_permalink:jump_permalink,rolled_up:rolled_up,n_others:n_others,repliers:repliers,additional_reply_count:additional_reply_count};var html=TS.templates.mentions_reply(template_args);return html},buildMentions:function(){TS.mentions.weaveInRxnRecords();var html="";var prev_mention=null;var member=TS.model.user;if(!member.mentions||!member.mentions.length)return html;var mentions=[];if(TS.boot_data.feature_message_replies){member.mentions.forEach(function(mention){var prev_mention=_.last(mentions);if(prev_mention&&prev_mention.type==="thread"&&prev_mention.message.thread_ts===mention.message.thread_ts){if(!prev_mention.replies_rolled_up)prev_mention.replies_rolled_up=[];prev_mention.replies_rolled_up.push(mention.message)}else{mentions.push(mention);if(mention.replies_rolled_up)delete mention.replies_rolled_up}})}else{mentions=member.mentions}$.each(mentions,function(i,mention){var h;try{if(TS.boot_data.feature_message_replies&&mention.type==="thread"){h=TS.templates.builders.buildThreadMentionHTML(mention)}else{h=TS.templates.builders.buildMentionHTML(mention)}}catch(e){TS.error("Problem building mention html for "+mention.message.ts+" in "+mention.channel);TS.error(e)}if(!h)return;var before_html="";var model_ob=TS.shared.getModelObById(mention.channel);var msg=mention.message;var showing_day_divider=!prev_mention;if(prev_mention&&!TS.utility.date.sameDay(TS.utility.date.toDateObject(prev_mention.rxn_ts||prev_mention.message.ts),TS.utility.date.toDateObject(mention.rxn_ts||msg.ts))){showing_day_divider=true}if(showing_day_divider){if(prev_mention){before_html="</div>"}before_html+='<div class="mention_day_container_div">'+TS.templates.messages_day_divider({ts:mention.rxn_ts||msg.ts})}else{if(!TS.boot_data.feature_message_replies)before_html+='<hr class="spacer">'}var prev_cid=prev_mention&&prev_mention.channel;if(model_ob&&(model_ob.is_channel||model_ob.is_mpim||model_ob.is_group)){if(prev_cid!=model_ob.id||showing_day_divider){before_html+=TS.templates.mentions_item({model_ob:model_ob})}}html+=before_html+h;prev_mention=mention});if(html){html+="</div>"}return html},buildStarredItemHTML:function(star){var html="<div class='star_item'>";var template_args={star:star,current_user_id:TS.model.user.id};var model_ob;if(star.type=="message"){var msg=star.message;var im_with_disabled_user=false;model_ob=TS.shared.getModelObById(star.channel);if(!model_ob){TS.warn("channel "+star.channel+" for this starred message was probably deleted");return""}if(model_ob.is_im){var recipient=TS.members.getMemberById(model_ob.user);star["message"]["recipient"]=recipient;if(TS.ims.isImWithDeletedMember(model_ob)){im_with_disabled_user=true}}var jump_link="";if(!im_with_disabled_user){if(TS.boot_data.feature_files_list){jump_link=TS.templates.builders.strBuilder('<a class="star_jump msg_right_link btn btn_outline" data-cid="${cid}">Jump</a>',{cid:model_ob.id})}else{jump_link=TS.templates.builders.strBuilder('<a class="star_jump msg_right_link" data-cid="'+model_ob.id+'">Jump</a>',{cid:model_ob.id})}}if(!TS.boot_data.feature_files_list){var subtype=msg.subtype;if(subtype==="file_share"||subtype==="file_mention"||subtype==="file_comment"){html+=TS.templates.builders.buildStar("message",msg,model_ob)}}html+=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true,starred_items_list:true,starred_items_actions:TS.boot_data.feature_files_list,jump_link:jump_link,no_attachments:!!msg.text,full_date:true})}else if(star.type=="file"){if(!TS.boot_data.feature_files_list){html+=TS.templates.builders.buildStar("file",star.file)}html+=TS.templates.builders.fileHTML(star.file)}else if(star.type=="channel"||star.type=="group"){model_ob=TS.channels.getChannelById(star.channel);if(!model_ob)model_ob=TS.groups.getGroupById(star.channel);if(!model_ob){TS.warn("channel or group "+star.channel+" was probably deleted");return""}template_args["model_ob"]=model_ob;html+=TS.templates.star_item(template_args)}else{template_args.from_starred_item=TS.boot_data.feature_files_list;html+=TS.templates.star_item(template_args)}html+="</div>";return html},buildPinInfoHtml:function(msg){var template_args={};var pin_data=TS.pins.getPinData(msg);if(pin_data&&pin_data.created_by&&pin_data.created){var user=TS.members.getMemberById(pin_data.created_by);template_args.user=user;template_args.ts=pin_data.created;template_args.complete_data=template_args.user&&template_args.ts}else{template_args.complete_data=false}var html=TS.templates.pinned_message_info(template_args);return new Handlebars.SafeString(html)},buildInlineImgTogglerAndDiv:function(key,container_id,args){var inline_img=TS.model.inline_imgs[key];if(!inline_img)return"";return TS.templates.builders.buildInlineImgToggler(key,container_id)+" "+TS.templates.builders.buildInlineImgDiv(key,container_id,args)},buildInlineImgToggler:function(key,container_id,no_bytes){
var inline_img=TS.model.inline_imgs[key];if(!inline_img){console.warn("buildInlineImgToggler did not find anything in TS.model.inline_imgs for key:"+key);return""}var expand_it=TS.inline_imgs.shouldExpand(container_id,inline_img);var link_url=inline_img.link_url||key;var too_many_b=inline_img.bytes&&inline_img.bytes>TS.model.inline_img_byte_limit;var too_many_px=inline_img.width&&inline_img.height&&inline_img.width*inline_img.height>TS.model.inline_img_pixel_limit;var show_expander=!too_many_px;var too_large_explain="";if(!expand_it&&(!TS.model.prefs.obey_inline_img_limit||too_many_b)||too_many_px){var would_expand=!inline_img.internal_file_id&&TS.model.prefs.expand_inline_imgs&&TS.model.expandable_state["img_"+container_id+inline_img.src]!==false;if(would_expand&&too_many_px){show_expander=false;too_large_explain='<span class="too_large_for_auto_expand"> (Not automatically expanded because '+inline_img.width+"x"+inline_img.height+" is too large to display inline.</span>"}else if(would_expand&&too_many_b){too_large_explain='<span class="too_large_for_auto_expand"> (Not automatically expanded because '+TS.utility.convertFilesize(inline_img.bytes)+' is too large. You can <a class="cursor_pointer too_large_but_expand_anyway" data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'">expand it anyway</a> or <a '+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="Open original in new tab">open it in a new window</a>.';if(TS.model.show_inline_img_size_pref_reminder&&!TS.model.shown_inline_img_size_pref_reminder_once){too_large_explain+=" You can also <a class=\"cursor_pointer\" onclick=\"TS.ui.prefs_dialog.start('messages_media', '#prefs_inline_media')\">change your preferences</a> to allow images of any file size to auto expand.";TS.model.shown_inline_img_size_pref_reminder_once=true}too_large_explain+=")</span>"}}var bytes=inline_img.bytes&&no_bytes!==true?'<span class="inline_img_bytes '+(too_large_explain?"hidden":"")+'"> ('+TS.utility.convertFilesize(inline_img.bytes)+")</span>":"";return bytes+too_large_explain+(show_expander?'<i data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="msg_inline_img_collapser ts_icon ts_icon_caret_down '+(expand_it?"":"hidden")+'"></i>'+'<i data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="msg_inline_img_expander ts_icon ts_icon_caret_right '+(expand_it?"hidden":"")+'"></i>':"")},buildInlineImgDiv:function(key,container_id,args){args=args||{};var inline_img=TS.model.inline_imgs[key];if(!inline_img)return"";var expand_it=TS.inline_imgs.shouldExpand(container_id,inline_img);var link_url=inline_img.link_url||key;var preserve_aspect_ratio=!args.flush_with_attachment&&inline_img.width>0&&inline_img.height>0;var file;if(inline_img.internal_file_id)file=TS.files.getFileById(inline_img.internal_file_id);var hide_by_default=!!TS.client;var html="";var div_class="clear_both msg_inline_img_holder msg_inline_holder";if(!expand_it)div_class+=" hidden";var overflow_buttons_height=inline_img.height<50;var overflow_buttons_width=inline_img.width<200;var overflow_buttons=overflow_buttons_width||overflow_buttons_height;if(overflow_buttons){div_class+=" overflow_preview_actions";if(overflow_buttons_width){div_class+=" overflow_preview_actions_width"}}if(file){div_class+=" file_container"}div_class+=" msg_inline_holder_rounded";if(!preserve_aspect_ratio)div_class+=" file_container_fixed_dimensions";html+='<div data-real-src="'+TS.utility.htmlEntities(inline_img.src)+'" class="'+div_class+'" ';if(inline_img.internal_file_id)html+='data-file-id="'+inline_img.internal_file_id+'" ';if(preserve_aspect_ratio)html+='style="width:'+inline_img.width+'px;" ';html+=">";var cmd_key="ctrl";if(TS.model.is_mac)cmd_key="cmd";var may_show_file_viewer=args&&args.hasOwnProperty("maybe_show_file_viewer")?args.maybe_show_file_viewer:true;var show_file_viewer_link;if(inline_img.internal_file_id){if(file&&file.mimetype.indexOf("image/")===0){show_file_viewer_link=may_show_file_viewer;if(file.external_type=="dropbox"||file.external_type=="gdrive"||file.external_type=="box"||file.external_type=="onedrive"){var file_to_show=file.thumb_720?file.thumb_720:file.thumb_360;html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="cmd+click to open original in new tab" class="file_viewer_external_link" data-src="'+TS.utility.htmlEntities(file_to_show)+'"data-link-url="'+link_url+'">'}else{if(show_file_viewer_link){html+='<a href="'+link_url+'" target="_blank" class="file_viewer_channel_link file_viewer_link" data-file-id="'+inline_img.internal_file_id+'">'}else{html+='<a href="'+link_url+'" target="_blank" title="'+cmd_key+'+click to open original in new tab" class="file_preview_link thumbnail_link" data-file-id="'+inline_img.internal_file_id+'">'}}}else{html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" class="'+file.filetype+'">'}}else{var img_class="";var img_title="";if(may_show_file_viewer){img_class="file_viewer_external_link"}else{img_title="Click to open original in new tab"}html+="<a "+TS.utility.makeRefererSafeLink(link_url)+' target="_blank" title="'+img_title+'" class="'+img_class+'" data-src="'+TS.utility.htmlEntities(inline_img.src)+'" data-link-url="'+inline_img.link_url+'"';if(inline_img.width)html+=' data-width="'+TS.utility.htmlEntities(inline_img.width)+'"';if(inline_img.height)html+=' data-height="'+TS.utility.htmlEntities(inline_img.height)+'"';if(inline_img.rotation)html+=' data-rotation="'+TS.utility.htmlEntities(inline_img.rotation)+'"';if(inline_img.content_type)html+=' data-content-type="'+TS.utility.htmlEntities(inline_img.content_type)+'"';html+=">"}if(preserve_aspect_ratio)html=html.replace("<a ",'<a style="width:'+inline_img.width+'px;" ');html+='<div class="msg_inline_img_container">';html+='<div class="file_preview_preserve_aspect_ratio" ';if(preserve_aspect_ratio){if(!file||!overflow_buttons){var css_calc_string="calc("+inline_img.height+" / "+inline_img.width+" * 100% )";html+='style="padding-top: -moz-'+css_calc_string+"; padding-top: -webkit-"+css_calc_string+"; padding-top: "+css_calc_string+';" '}else{html+='style="padding-top: '+inline_img.height+'px;" '}}else{var MAX_WIDTH=574;var MAX_HEIGHT=300;var MAX_RES=MAX_WIDTH/MAX_HEIGHT;var img_width=inline_img.display_w||inline_img.width;var img_height=inline_img.display_h||inline_img.height;var img_res=img_width/img_height;var reserved_width;var reserved_height;if(img_width<=MAX_WIDTH&&img_height<=MAX_HEIGHT){reserved_width=img_width;reserved_height=img_height}else if(MAX_RES>img_res){reserved_width=img_width*MAX_HEIGHT/img_height;reserved_height=MAX_HEIGHT}else{reserved_width=MAX_WIDTH;reserved_height=img_height*MAX_WIDTH/img_width}html+='style="width: '+Math.round(reserved_width)+"px; height: "+Math.round(reserved_height)+'px;"'}html+=">";if(TS.boot_data.feature_a11y_pref_no_animation){inline_img.proxied_src=TS.utility.getImgProxyURLWithOptions(inline_img.src,{})}var src=TS.utility.htmlEntities(inline_img.proxied_src||inline_img.src);var figure_class=hide_by_default?"msg_inline_img msg_inline_child hidden":"msg_inline_img msg_inline_child";var figure_attr=hide_by_default?'data-real-background-image="'+src+'"':'style="background-image:url('+src+');"';var img_attr=hide_by_default?'data-real-src="'+src+'"':'src="'+src+'"';html+='<figure class="'+figure_class+'" '+figure_attr+">";html+="<img "+img_attr+" />";html+="</figure>";html+="</div>";html+="</div>";html+="</a>";if(file){html+=TS.templates.message_file_preview_actions({file:file,download:file.mode==="hosted",new_window:true})}html+="</div>";return html},buildInlineEmailDiv:function(file_id,container_id){var file=TS.files.getFileById(file_id);if(!file)return"";var template_args={file:file,is_message:true,to_more_count:file.to.length-1,cc_more_count:file.cc.length-1,msg_dom_id:container_id};return TS.templates.file_email(template_args)},buildInlineAttachmentToggler:function(key,container_id){var inline_attachment=TS.model.inline_attachments[key];if(!inline_attachment)return"";var expand_it=TS.inline_attachments.shouldExpand(container_id,inline_attachment);var template_args={real_src:inline_attachment.from_url,expand_it:expand_it};var html=TS.templates.inline_attachment_toggler({inline_attachment:template_args});return html},buildInlineRoomPreviewToggler:function(room_id){var expand_it=TS.inline_room_previews.shouldExpand(room_id);var hide_title_when_expanded=true;return" "+'<i class="msg_inline_room_preview_collapser ts_icon ts_icon_caret_down'+(expand_it?"":" hidden")+(hide_title_when_expanded?" title_hidden":"")+'"></i>'+'<i class="msg_inline_room_preview_expander ts_icon ts_icon_caret_right'+(expand_it?" hidden":"")+'"></i>'},makeMemberImage:function(id,size,lazy,with_title){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";lazy=lazy===true;with_title=with_title===true;var img_src,img_class;switch(size){case 16:img_src=member.profile.image_24;img_class="thumb_16";break;case 20:img_src=member.profile.image_24;img_class="thumb_20";break;case 24:img_src=member.profile.image_24;img_class="thumb_24";break;case 32:img_src=member.profile.image_32;img_class="thumb_32";break;case 36:img_src=member.profile.image_48;img_class="thumb_36";break;case 48:img_src=member.profile.image_48;img_class="thumb_48";break;case 72:img_src=member.profile.image_72;img_class="thumb_72";break;case 192:img_src=member.profile.image_192;img_class="thumb_192";break;default:img_src=member.profile.image_48;img_class="thumb_48";break}var title=with_title?'title="'+TS.members.getMemberDisplayName(member,true)+'"':"";var html;if(lazy){html='<img data-original="'+img_src+'" class="lazy member_image '+img_class+' member_preview_image" data-member-id="'+member.id+'" '+title+" />"}else{html='<img src="'+img_src+'" class="member_image '+img_class+' member_preview_image" data-member-id="'+member.id+'" '+title+" />"}return html},buildInlineAudioToggler:function(key,container_id){var inline_audio=TS.model.inline_audios[key];if(!inline_audio)return"";return TS.templates.attachment_inline_media_toggler({is_expanded:TS.inline_audios.shouldExpand(container_id,inline_audio),src:inline_audio.src,media_type:"audio"})},buildInlineAudioDiv:function(key,container_id,content){var inline_audio=TS.model.inline_audios[key];if(!inline_audio)return"";var expand_it=TS.inline_audios.shouldExpand(container_id,inline_audio);var template_args={src:inline_audio.src,expand_it:expand_it,content:content};var html=TS.templates.attachment_inline_audio_div({inline_audio:template_args});return html},buildInlineOtherToggler:function(key,container_id){var inline_other=TS.model.inline_others[key];if(!inline_other)return"";return TS.templates.attachment_inline_media_toggler({is_expanded:TS.inline_others.shouldExpand(container_id,inline_other),src:inline_other.src,media_type:"other"})},buildInlineOtherDiv:function(key,container_id,content){var inline_other=TS.model.inline_others[key];if(!inline_other)return"";var expand_it=TS.inline_others.shouldExpand(container_id,inline_other);return'<div data-real-src="'+TS.utility.htmlEntities(inline_other.src)+'" class="clear_both msg_inline_other_holder msg_inline_holder '+(expand_it?"":"hidden")+'">'+content+"</div>"},buildInlineVideoTogglerAndDiv:function(key,container_id){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";return TS.templates.builders.buildInlineVideoToggler(key,container_id)+" "+TS.templates.builders.buildInlineVideoDiv(key,container_id)},buildInlineVideoToggler:function(key,container_id,no_title){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";return TS.templates.attachment_inline_media_toggler({is_expanded:TS.inline_videos.shouldExpand(container_id,inline_video),src:inline_video.src,title:no_title?"":inline_video.title,media_type:"video"})},buildInlineVideoDiv:function(key,container_id){var inline_video=TS.model.inline_videos[key];if(!inline_video)return"";var expand_it=TS.inline_videos.shouldExpand(container_id,inline_video);var link_url=inline_video.link_url||key;var hide_by_default=!!TS.client;var show_play=true;if(!inline_video.html){show_play=false}var template_args={real_src:inline_video.src,data_url:key,referrer_safe_url_attributes:TS.utility.makeRefererSafeLink(link_url),hide_by_default:hide_by_default,show_play:show_play,proxied_src_or_src:inline_video.proxied_src||inline_video.src,display_w:inline_video.display_w,display_h:inline_video.display_h,expand_it:expand_it};var html=TS.templates.message_inline_video({inline_video:template_args});return html},buildComments:function(file){var comments=file.comments;var html="";for(var i=0;i<comments.length;i++){html+=TS.templates.builders.buildCommentHTML({file:file,comment:comments[i],show_comment_actions:true})}return html},buildCommentHTML:function(template_args){return TS.templates.comment(template_args)},buildCommentStandalone:function(comment,file){var entity=_getEntityFromFile(file);return TS.templates.comment_standalone({comment:comment,file:file,entity:entity,current_user_id:TS.model.user.id})},buildTeamListHTML:function(all_members,is_long_list_view,is_lazy){var team_list_members=TS.members.allocateTeamListMembers(all_members);var members=team_list_members.members;var disabled_members=team_list_members.disabled_members;var deleted_bots=team_list_members.deleted_bots;var bots=team_list_members.bots;var restricted_members=team_list_members.restricted_members;var ultra_restricted_members=team_list_members.ultra_restricted_members;var show_bots=false;if(bots.length||deleted_bots.length){show_bots=true}var show_restricted_members=false;if(restricted_members.length||ultra_restricted_members.length||is_lazy){show_restricted_members=true}var show_disabled_members=false;if(disabled_members.length||is_lazy){show_disabled_members=true}var show_user_groups=false;var show_user_groups_help=false;var user_groups;show_user_groups=TS.model.team.plan!==""&&!TS.model.user.is_restricted;user_groups=TS.model.user_groups.filter(function(ug){return!ug.date_delete});show_user_groups_help=!user_groups.length;var $team_tabs=$("#team_tabs");var show_user_groups_edit=TS.members.canUserEditUserGroups();var show_user_groups_add=TS.members.canUserCreateAndDeleteUserGroups();$team_tabs.html(TS.templates.user_group_tabs({show_members:!!members.length,members:is_lazy?[]:members,show_restricted_members:show_restricted_members,restricted_members:is_lazy?[]:restricted_members.concat(ultra_restricted_members),show_disabled_members:show_disabled_members,disabled_members:is_lazy?[]:disabled_members,show_user_groups:show_user_groups,user_groups:user_groups,show_user_groups_edit:show_user_groups_edit,show_user_groups_add:show_user_groups_add,is_enterprise:TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise}));var include_bots=true;var include_deleted=false;TS.members.view.bindTeamFilter("#team_filter","#team_list_scroller",true,is_long_list_view,include_bots,include_deleted);$("#team_filter input").bind("focus",function(){$("#team_filter .icon_search").addClass("indifferent_grey")}).bind("blur",function(){$("#team_filter .icon_search").removeClass("indifferent_grey")});if(show_user_groups){var $team_tab_actions=$team_tabs.find(".tab_action:not(#search)");var $team_block=$("#team_block");$team_tabs.find("li a").on("click",function(){var action=$(this).data("action");var show_user_groups_edit=TS.members.canUserEditUserGroups();var show_user_groups_add=TS.members.canUserCreateAndDeleteUserGroups();$team_tab_actions.addClass("hidden");if(action==="user_group_edit"){if(!show_user_groups_edit&&!show_user_groups_add)return;$team_tab_actions.removeClass("hidden");$team_block.addClass("hidden")}else{$team_block.removeClass("hidden")}$team_tabs.find("#"+action).removeClass("hidden")})}$("#team_tabs").find("li.tab").on("click",function(e){var target_name=$(e.currentTarget).find("a").data("name");TS.model.ui_state.tab_name=target_name;TS.storage.storeUIState(TS.model.ui_state);var $search=$("#search");if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($("#team_list_members"));if(TS.web&&TS.web.members&&TS.web.members.lazyload){TS.web.members.lazyload.trigger("resize")}$("#team_list_members").trigger("resize");if(target_name=="user_groups"){TS.view.rebuildUserGroupList();$search.toggleClass("hidden",!TS.model.user_groups.length)}else{$search.removeClass("hidden")}});return TS.templates.team_list({members:members,bots:bots,show_bots:show_bots,show_restricted_members:show_restricted_members,restricted_members:restricted_members,ultra_restricted_members:ultra_restricted_members,show_disabled_members:show_disabled_members,disabled_members:disabled_members,deleted_bots:deleted_bots,show_user_groups:show_user_groups,user_groups:user_groups,show_user_groups_help:show_user_groups_help,is_long_list_view:is_long_list_view})},buildUserGroupHTML:function(user_group,is_flexpane){return TS.templates.user_group_list_item({user_group:user_group,is_flexpane:is_flexpane})},buildUserGroupListHTML:function(all_user_groups,is_flexpane){var user_group;var user_groups=[];var disabled_user_groups=[];var show_delete=TS.boot_data.feature_subteams_hard_delete;var show_toggle=TS.members.canUserCreateAndDeleteUserGroups();for(var i=0;i<all_user_groups.length;i++){user_group=all_user_groups[i];if(user_group.date_delete){user_group.can_delete=!user_group.auto_type&&!user_group.is_external;disabled_user_groups.push(user_group)}else{user_groups.push(user_group)}}var show_user_groups_help=!is_flexpane&&!user_groups.length&&!disabled_user_groups.length||is_flexpane&&!user_groups.length;return TS.templates.user_group_list({user_groups:user_groups,disabled_user_groups:disabled_user_groups,show_delete:show_delete,show_toggle:show_toggle,is_flexpane:is_flexpane,show_user_groups_help:show_user_groups_help})},makeInternalChannelLink:function(channel){if(!channel)return"ERROR: MISSING CHANNEL";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+channel.name+'"':"";return'<a href="/archives/'+channel.name+'" '+target+' class="internal_channel_link" data-channel-id="'+channel.id+'"><span class="normal">#</span>'+channel.name+"</a>"},makeInternalGroupLink:function(group){if(!group)return"ERROR: MISSING GROUP";var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+group.name+'"':"";return'<a href="/archives/'+group.name+'" '+target+'" class="internal_group_link" data-group-id="'+group.id+'">'+TS.model.group_prefix+group.name+"</a>"},makeChannelLink:function(channel,omit_prefix){if(!channel)return"ERROR: MISSING CHANNEL";var shared_icon="";if(TS.boot_data.page_needs_enterprise&&channel.is_shared){shared_icon='<ts-icon class="ts_icon_shared_channel"></ts-icon>'}var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+channel.name+'"':"";return'<a href="/archives/'+channel.name+'" '+target+' class="channel_link" data-channel-id="'+channel.id+'">'+(omit_prefix?"":'<span class="normal">#</span>')+channel.name+shared_icon+"</a>"},makeChannelLinkAriaLabelSafe:function(channel){if(!channel)TS.warn("No valid channel to make channel link aria label");var name=TS.utility.htmlEntities(channel.name);var active_or_regular_channel=TS.model.active_channel_id===channel.id?"active channel":"channel";var unread_message=_getUnreadMessageLabelText(channel);var aria_label=name+", "+active_or_regular_channel+(unread_message?", "+unread_message:"");return new Handlebars.SafeString(aria_label)},makeGroupLink:function(group,omit_prefix){if(!group)return"ERROR: MISSING GROUP";var shared_icon="";if(TS.boot_data.page_needs_enterprise&&group.is_shared){shared_icon='<ts-icon class="ts_icon_shared_channel"></ts-icon>'}var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+group.name+'"':"";return'<a href="/archives/'+group.name+'" '+target+' class="group_link" data-group-id="'+group.id+'">'+(omit_prefix?"":TS.model.group_prefix)+group.name+shared_icon+"</a>"},makeGroupLinkAriaLabelSafe:function(group){if(!group)TS.warn("No valid group to make private channel link aria label");var name=TS.utility.htmlEntities(group.name);var active_or_regular_channel=TS.model.active_group_id===group.id?"active channel":"channel";var unread_message=_getUnreadMessageLabelText(group);var aria_label=name+", "+active_or_regular_channel+(unread_message?", "+unread_message:"");return new Handlebars.SafeString(aria_label)},makeTeamsThatHaveComplianceExportsBlurb:function(teams){if(!teams||!teams.length){return""}var blurb="";var exports_teams=teams.filter(function(team){return team.team.has_compliance_export});exports_teams.forEach(function(team,index){if(index>0){if(exports_teams.length>2)blurb+=", ";if(index===exports_teams.length-1)blurb+=" and "}blurb+=team.name});if(exports_teams.length>1){blurb+=" have"}else{blurb+=" has"}blurb+=' <a href="https://get.slack.help/hc/en-us/articles/204897248-Understanding-Slack-data-exports" target="_blank">Compliance Exports</a> enabled which allows their Team Owners to export communication history.';return new Handlebars.SafeString(blurb)},makeMpimLink:function(mpim,with_title){if(!mpim)return"ERROR: MISSING MPIM";var target;var title;var href=TS.mpims.getMpimArchivesPath(mpim);if(TS.utility.shouldLinksHaveTargets())target=TS.mpims.getMpimArchivesPath(mpim);if(with_title)title=TS.mpims.getTooltipText(mpim);return TS.templates.mpim_link({target:target,href:href,title:title,mpim:mpim})},makeMemberPreviewLink:function(member,show_you_for_current_user){if(!member)return"";if(show_you_for_current_user!==true)show_you_for_current_user=false;var safe_name=TS.utility.htmlEntities(member.name);var class_extras=TS.templates.builders.makeMemberColorClass(member);var html;var target;if(member.is_service){target=TS.utility.shouldLinksHaveTargets()?'target="/services/'+member.id+'"':"";if(TS.boot_data.feature_app_cards_and_profs_frontend)class_extras+=" app_preview_link";html='<a href="/services/'+member.id+'" '+target+' class="message_sender service_link '+class_extras+'">'}else{target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+safe_name+'"':"";class_extras+=TS.boot_data.feature_app_cards_and_profs_frontend&&member.is_bot?" app_preview_link":" member member_preview_link";class_extras+=" "+TS.templates.builders.makeMemberTypeBadgeClass(member);html='<a href="/team/'+safe_name+'" '+target+' class="message_sender '+class_extras+'" data-member-id="'+member.id+'">'}if(show_you_for_current_user&&member.id==TS.model.user.id){html+="You"}else{if(TS.boot_data.feature_name_tagging_client){html+=TS.utility.htmlEntities(TS.members.getMemberFullName(member))}else{html+=TS.members.getMemberDisplayName(member,true)}}html+=TS.templates.builders.makeMemberTypeBadgeCompact(member,false);html+="</a>";if(member.is_bot||member.is_service){html+='<span class="bot_label">BOT</span>'}return html},makeProfileImage:function(entity,options){if(!entity){return false}var is_lazy=options.hash.is_lazy||false;var image_set=entity.profile||entity.icons||{};var default_size;if(image_set.emoji){default_size="64"}else{default_size="48"}var desired_size=options.hash.size||default_size;var size=Object.keys(TS.constants.avatar_size_map).reduce(function(carry_size,current_size){if(current_size===desired_size&&_getImage(image_set,current_size)){return current_size}else{return carry_size}},default_size);var template_data={entity:entity,size:desired_size,css_classes:_getClasses(entity,desired_size),image:_formatImageURI(entity,_getImage(image_set,size)),is_lazy:is_lazy,is_targettable:TS.utility.shouldLinksHaveTargets()};function _formatImageURI(entity,image){var image_uri=[];if(entity.is_restricted||entity.is_ultra_restricted){if(TS.environment.is_retina){image_uri.push("url('"+cdn_url+"/0180/img/avatar_overlays_@2x.png"+"')")}else{image_uri.push("url('"+cdn_url+"/0180/img/avatar_overlays.png"+"')")}}image_uri.push("url('"+image+"')");return image_uri.join(",")}function _getImage(imageset,size){var key="image_"+size;if(imageset.hasOwnProperty(key)){if(TS.environment.is_retina){return imageset[TS.constants.avatar_size_map[size].retina]||imageset[TS.constants.avatar_size_map[size].standard]}else{return imageset[TS.constants.avatar_size_map[size].standard]}}else{return false}}function _getClasses(entity,size){var classes=[];classes.push("thumb_"+size);if(entity.is_bot){classes.push("is_bot");classes.push(TS.boot_data.feature_app_cards_and_profs_frontend?"app_preview_link":"member_preview_link")}else{classes.push("member_preview_link")}return classes.join(" ")}return new Handlebars.SafeString(TS.templates.member_profile_image(template_data))},makeMemberPreviewLinkImage:function(id_or_member_ob,size,lazy,omit_link,omit_badge,omit_restricted_overlay,slackbot_feels){var member;if(typeof id_or_member_ob==="object"){member=id_or_member_ob}else{member=TS.members.getMemberById(id_or_member_ob)}if(!member||!member.profile)return"";lazy=lazy===true;omit_link=omit_link===true;omit_badge=omit_badge===true;omit_restricted_overlay=omit_restricted_overlay===true;slackbot_feels=typeof slackbot_feels==="string"?slackbot_feels:false;if(id_or_member_ob==="USLACKBOT"&&slackbot_feels){member=TS.utility.slackbot.getWithFeels(slackbot_feels)}var img_src,avatar_class,badge_html;var bg_img_style,bg_img_urls;badge_html="";bg_img_style="background-image: ";bg_img_urls=[];switch(size){case 20:if(TS.environment.is_retina){img_src=member.profile.image_48}else{img_src=member.profile.image_24}avatar_class="thumb_20";break;case 24:if(TS.environment.is_retina){img_src=member.profile.image_48}else{img_src=member.profile.image_24}avatar_class="thumb_24";break;case 32:if(TS.environment.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_32}avatar_class="thumb_32";break;case 36:if(TS.environment.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_36";break;case 48:if(TS.environment.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_48";break;case 72:if(TS.environment.is_retina){img_src=member.profile.image_192}else{img_src=member.profile.image_72}avatar_class="thumb_72";break;case 192:if(TS.environment.is_retina){img_src=member.profile.image_512||member.profile.image_192}else{img_src=member.profile.image_192}avatar_class="thumb_192";break;case 512:if(TS.environment.is_retina){img_src=member.profile.image_1024||member.profile.image_512||member.profile.image_192}else{img_src=member.profile.image_512||member.profile.image_192}avatar_class="thumb_512";break;default:if(TS.environment.is_retina){img_src=member.profile.image_72}else{img_src=member.profile.image_48}avatar_class="thumb_48";break}if(TS.boot_data.page_needs_enterprise){if(!omit_badge){var badge_size;switch(size){case 20:case 24:badge_size=10;break;case 32:case 36:case 48:badge_size=16;break;case 72:badge_size=24;break;case 192:badge_size=48;break;case 512:badge_size=96;break;default:badge_size=16}badge_html=TS.templates.builders.makeMemberTypeBadge(member,badge_size,false,false)}}else{if(member.is_restricted&&!omit_restricted_overlay){if(TS.environment.is_retina){bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays_@2x.png"+"')")}else{bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays.png"+"')")}}if(member.is_ultra_restricted&&!omit_restricted_overlay){avatar_class+=" ura"}else if(member.is_restricted&&!omit_restricted_overlay){avatar_class+=" ra"}else if(member.is_bot){avatar_class+=" bot"}}var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+member.name+'"':"";bg_img_urls.push("url('"+img_src+"')");if(size===512){var pre_bg_img_src=TS.environment.is_retina?member.profile.image_72:member.profile.image_48;bg_img_urls.push("url('"+pre_bg_img_src+"')")}if(lazy){bg_img_style=bg_img_urls.length?bg_img_urls.join(", "):""}else{bg_img_style=bg_img_urls.length?bg_img_style+bg_img_urls.join(", "):""}var template_data={omit_link:omit_link,lazy:lazy,avatar_class:avatar_class,member:member,size:size,bg_img_style:bg_img_style,badge_html:new Handlebars.SafeString(badge_html),target:new Handlebars.SafeString(target)};return TS.templates.member_preview_link_image(template_data)},makeMemberPreviewCardLinkImage:function(id){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";var bg_img=TS.templates.builders.makeMemberPreviewCardLinkImageBackground(id);var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+member.name+'"':"";return['<a href="/team/',member.name,'" ',target,' class="member_preview_link member_image thumb_512" data-member-id="',member.id,'" data-thumb-size="512" style="background-image: ',bg_img,'" aria-hidden="true"></a>'].join("")},makeMemberPreviewCardLinkImageBackground:function(id){var member=TS.members.getMemberById(id);if(!member||!member.profile)return"";var img_src;if(TS.environment.is_retina){img_src=member.profile.image_1024||member.profile.image_512||member.profile.image_192}else{img_src=member.profile.image_512||member.profile.image_192}var pre_bg_img_src=TS.environment.is_retina?member.profile.image_72:member.profile.image_48;var gradient_prefix=TS.model.mac_version==10.7||TS.model.mac_version==10.8?"-webkit-":"";var bg_img_components=[gradient_prefix+"linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0) 34%, rgba(0,0,0,0.2) 66%, rgba(0,0,0,0.2) 83%, rgba(0,0,0,0.6))","url('"+img_src+"')","url('"+pre_bg_img_src+"')"];return bg_img_components.join(", ")},makeMemberLinkAriaLabelSafe:function(direct_message){if(!direct_message)TS.warn("No valid direct message object to make member link aria label");var member=direct_message.member;var im=direct_message.im;var aria_label="";if(member&&im){var name=TS.utility.htmlEntities(TS.ims.getDisplayNameOfUserForIm(im));var active_or_regular_direct_message=TS.model.active_im_id===member.id?"active direct message":"direct message";var presence_state=TS.templates.makeMemberPresenceStateAriaLabel(member);var unread_message=_getUnreadMessageLabelText(im);aria_label=name+", "+active_or_regular_direct_message+", "+presence_state+(unread_message?", "+unread_message:"")}return new Handlebars.SafeString(aria_label)},makePendingUserImage:function(user,size){if(!user||!size)return"";var img_classes=[];var bg_img_urls=[];var img_size;if(user.invite_prefs&&user.invite_prefs.type==="restricted"){if(TS.environment.is_retina){bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays_@2x.png"+"')")}else{bg_img_urls.push("url('"+cdn_url+"/0180/img/avatar_overlays.png"+"')")}img_classes.push("ra")}switch(size){case 24:img_size=48;break;case 36:img_size=72;break;default:img_size=48}var img_src="/img/new_channel_modal/airplane_"+img_size.toString()+".png";bg_img_urls.push("url('"+vvv(img_src)+"')");var bg_img_url_str=bg_img_urls.join(",");var template_data={img_classes:img_classes.join(" "),bg_img_urls:bg_img_url_str,size:size};return TS.templates.pending_user_image(template_data)},newWindowName:function(text){if(TS.boot_data.app=="web"||TS.boot_data.app=="calls"){return"_self"}return"new_"+_session_ms.toString()},getBotIdentifier:function(msg){if(!msg.bot_id&&!msg.username)return null;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;var name=!msg.username&&bot&&bot.name?bot.name:msg.username;var id=bot?bot.id:"NOBOTID";return id+"_"+name},getBotName:function(msg){var username=msg.username;if(!username){var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(bot&&bot.name){username=bot.name}}return username},getBotNameWithLink:function(msg){var username=msg.username;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);if(!username){if(bot&&bot.name){username=bot.name}}return bot_link.start_a+TS.utility.htmlEntities(username)+bot_link.end_a},makeBotLink:function(bot,username){var start_a="";var end_a="";var app_class_extras=TS.boot_data.feature_app_cards_and_profs_frontend?"app_preview_link ":"";if(bot&&!bot.deleted){start_a='<a class="'+app_class_extras+'" target="/services/'+bot.id+'" href="/services/'+bot.id+'">';end_a="</a>"}else if(TS.boot_data.feature_app_cards_and_profs_frontend){
start_a='<a class="'+app_class_extras+'">';end_a="</a>"}return{start_a:start_a,end_a:end_a}},makeFiletypeHTML:function(file){if(file.external_type)return TS.templates.builders.makeExternalFiletypeHTML(file);var html="";html+='<a href="'+file.url_private_download+'" ';html+='target="'+file.url_private_download+'" ';html+='title="Download this file" ';html+='data-file-id="'+file.id+'" ';html+='class="subtle_silver file_ssb_download_link">';html+=TS.utility.convertFilesize(file.size)+" ";html+="<span>"+file.pretty_type+"</span>";if(file.mode==="snippet")html+=" snippet";html+="</a>";return html},makeExternalFiletypeHTML:function(file){if(!file.is_external)return;var external_filetype_html="";switch(file.external_type){case"gdrive":switch(file.filetype){case"gsheet":external_filetype_html="Spreadsheet";break;case"gdoc":external_filetype_html="Document";break;case"gpres":external_filetype_html="Presentation";break;case"gdraw":external_filetype_html="Drawing";break;default:external_filetype_html=["<span>","</span>"].join(file.pretty_type)}external_filetype_html+=" from Google Drive";break;case"dropbox":external_filetype_html=["<span>","</span> from Dropbox"].join(file.pretty_type);break;case"box":external_filetype_html=["<span>","</span> from Box"].join(file.pretty_type);break;case"onedrive":external_filetype_html=["<span>","</span> from OneDrive"].join(file.pretty_type);break;default:external_filetype_html="File"}return external_filetype_html},makeUnshareLink:function(channel_or_group,file){var title=channel_or_group.is_channel?"Unshare from #"+channel_or_group.name:"Unshare from "+channel_or_group.name;return'<a class="unshare_link ts_tip ts_tip_top ts_tip_float ts_tip_unshare_link" onclick="TS.files.promptForFileUnshare(\''+file.id+"', '"+channel_or_group.id+'\')"><span class="ts_tip_tip">'+title+'</span><i class="ts_icon ts_icon_minus_circle_small"></i></a>'},updateFileShareLabels:function(file){var labels=$('.file_share_label[data-file-id="'+file.id+'"]');labels.each(function(){$(this).replaceWith(TS.templates.builders.makeFileShareLabel(file))});if(file.is_shared){$('.file_share_shared_label[data-file-id="'+file.id+'"]').removeClass("hidden");$('.file_share_unshared_label[data-file-id="'+file.id+'"]').addClass("hidden")}else{$('.file_share_shared_label[data-file-id="'+file.id+'"]').addClass("hidden");$('.file_share_unshared_label[data-file-id="'+file.id+'"]').removeClass("hidden")}if(file.is_public){$('.file_share_private_label[data-file-id="'+file.id+'"]').addClass("hidden");$('.file_share_public_label[data-file-id="'+file.id+'"]').removeClass("hidden")}else{$('.file_share_private_label[data-file-id="'+file.id+'"]').removeClass("hidden");$('.file_share_public_label[data-file-id="'+file.id+'"]').addClass("hidden")}},makeFileShareLabel:function(file){var html='<span class="file_share_label" data-file-id="'+file.id+'">';var share_list=TS.templates.builders.makeFileGroupChannelList(file);if(!share_list.length){if(!file.is_public&&file.user!==TS.model.user.id){html+="shared with you"}}else{html+="in "+share_list}html+="</span>";return html},makeFileGroupChannelList:function(file){var linksA=[];var html;var channel,i;for(i=0;i<file.channels.length;i++){channel=TS.channels.getChannelById(file.channels[i]);if(!channel)continue;html='<span class="no_wrap">';html+=TS.templates.builders.makeChannelLink(channel,file);html+="&nbsp;"+TS.templates.builders.makeUnshareLink(channel,file);html+="</span>";linksA.push(html)}var group;for(i=0;i<file.groups.length;i++){group=TS.groups.getGroupById(file.groups[i]);if(!group)continue;html='<span class="no_wrap">';html+=TS.templates.builders.makeGroupLink(group,file);html+="&nbsp;"+TS.templates.builders.makeUnshareLink(group,file);html+="</span>";linksA.push(html)}if(!linksA.length)return"";return linksA.join(", ")},makeFileCommentHelpText:function(file){if(file&&file.is_public&&file.channels.length){var channel_names=[];for(var i=0;i<file.channels.length;i++){var channel=TS.channels.getChannelById(file.channels[i]);if(!channel)continue;channel_names.push("#"+channel.name)}return"Commenting in "+channel_names.join(", ")}else{return""}},makeMessageShareLabelSafe:function(model_ob){var html='<span class="message_share_label">';if(model_ob.is_channel){html+="in "+TS.templates.builders.makeChannelLink(model_ob)}else if(model_ob.is_group){html+="in "+TS.templates.builders.makeGroupLink(model_ob)}html+="</span>";return new Handlebars.SafeString(html)},makeMessageLinkLabelSafe:function(url){var html="From URL: "+"<a "+TS.utility.makeRefererSafeLink(url)+' class="external_link"'+'title="'+url+'"'+'target="_blank">'+TS.utility.htmlEntities(url)+"</a>";return new Handlebars.SafeString(html)},makeSHRoomParticipantList:function(room){var participants=room.date_end?room.participant_history:room.participants;return _.compact(participants.map(function(participant){var member=TS.members.getMemberById(participant);if(member){if(TS.boot_data.feature_name_tagging_client){return TS.members.getMemberFullName(member)}else{return TS.members.getMemberDisplayName(member)}}})).join(", ")},makeSHRoomSharedList:function(room){if(!room.channels||!room.channels.length)return"";var linksA=[];var html;var member;var model_ob;for(var i=0;i<room.channels.length;i++){model_ob=TS.shared.getModelObById(room.channels[i]);if(!model_ob)continue;if(model_ob.is_channel){html=TS.templates.builders.makeChannelLink(model_ob)}else if(model_ob.is_group){html=TS.templates.builders.makeGroupLink(model_ob)}else if(model_ob.is_im){member=TS.members.getMemberById(model_ob.user);if(!member)continue;html=TS.templates.builders.makeMemberPreviewLink(member)}else{continue}linksA.push(html)}if(!linksA.length)return"";return linksA.join(", ")},buildFileSharingControls:function(file,hide_checkbox,comment,has_title,selection){var share_context;var model_ob;if(TS.client){model_ob=TS.shared.getActiveModelOb()}else if(TS.web&&TS.web.space){model_ob=TS.shared.getModelObById(TS.web.space.getOriginChannel())}if(!model_ob||model_ob.is_channel){share_context="channel"}else if(model_ob.is_im){share_context="im"}else if(model_ob.is_mpim){share_context="mpim"}else if(model_ob.is_group){share_context="group"}if(model_ob&&model_ob.is_general&&!TS.members.canUserPostInGeneral()){model_ob={}}var channels=[];var groups=[];var members=[];if(share_context=="group"&&(groups&&!groups.length))share_context="channel";comment=comment||"";$("#file_sharing_div").remove();var is_owner=false;if(!file){is_owner=true}else if(file.user===TS.model.user.id){is_owner=true}var file_sharing_notice="Files are private until they are shared in a public channel.";if(file){if(file.is_public){file_sharing_notice="Files you share into a channel are visible to all team members."}if(file.type&&file.type.indexOf("application/vnd.google-apps")!=-1){file_sharing_notice="Anyone"+(TS.model.team.name?" at "+TS.model.team.name:"")+" with the link will be able to edit this Google "+_.capitalize(file.type.replace("application/vnd.google-apps",""))}}var enable_collab_editing=TS.web&&TS.web.space&&is_owner&&!TS.model.team.prefs.disable_file_editing&&!file.channels.concat(file.groups).concat(file.ims).length;return TS.templates.file_sharing({share_context:share_context,channels:channels,groups:groups,members:members,model_ob:model_ob,file:file,file_sharing_notice:file_sharing_notice,is_owner:is_owner,has_title:has_title,hide_checkbox:hide_checkbox,comment:comment,selection:selection,show_channel_join_note:model_ob&&model_ob.is_channel&&!model_ob.is_member&&!model_ob.is_archived,enable_collab_editing:enable_collab_editing})},buildNonDefaultNotificationBlock:function(classes){classes=classes||"";var html="";var i;var ob=TS.notifs.getCorGsNotUsingGlobalNotificationSetting();if(ob.everything.length){html+='<div class="'+classes+'">Set to notify for <b>all activity</b>:';for(i=0;i<ob.everything.length;i++)html+=" "+(ob.everything[i].id.charAt(0)==="C"?"#":"")+ob.everything[i].name+(i!=ob.everything.length-1?",":"");html+="</div>"}if(ob.mentions.length){html+='<div class="'+classes+'">Set to notify only for <b>Highlight Words</b>:';for(i=0;i<ob.mentions.length;i++)html+=" "+(ob.mentions[i].id.charAt(0)==="C"?"#":"")+ob.mentions[i].name+(i!=ob.mentions.length-1?",":"");html+="</div>"}if(ob.nothing.length){html+='<div class="'+classes+'">Set to <b>never notify</b>:';for(i=0;i<ob.nothing.length;i++)html+=" "+(ob.nothing[i].id.charAt(0)==="C"?"#":"")+ob.nothing[i].name+(i!=ob.nothing.length-1?",":"");html+="</div>"}return html},strBuilder:function(str,args){return str.replace(/\${([a-z_]+)}/g,function(m,$1){if($1.indexOf("_html")>-1)return args[$1];return TS.utility.htmlEntities(args[$1])})},buildRxnTitle:function(args){var handy_title=TS.rxns.getHandyRxnsTitleForEmojiByRxnKey(args.name,args.rxn_key);if(args.is_handy||args.is_poll&&!args.count){if(args.is_poll)return"Vote for "+TS.utility.htmlEntities(handy_title||args.name)+"";if(handy_title)return"Say "+TS.utility.htmlEntities(handy_title)+"";return"Add reaction :"+TS.utility.htmlEntities(args.name)+":"}var should_escape=false;var include_at_sign=true;var subtitle;if(args.is_poll){subtitle="voted for "+TS.utility.htmlEntities(handy_title||args.name)+""}else if(handy_title){subtitle="said "+TS.utility.htmlEntities(handy_title)+""}else{subtitle="reacted with :"+TS.utility.htmlEntities(args.name)+":"}if(!TS.emoji.isValidName(args.name))subtitle+=" (emoji has been removed)";subtitle=' <span class="subtle_silver">'+subtitle+"</span>";if(args.count==1){if(args.user_reacted){if(TS.boot_data.feature_thanks)return"You"+subtitle;return"You (click to remove)"+subtitle}else if(TS.boot_data.feature_name_tagging_client){return TS.utility.htmlEntities(TS.members.getMemberFullName(args.member_ids[0]))+subtitle}else{return TS.utility.htmlEntities(TS.members.getMemberDisplayNameById(args.member_ids[0],should_escape,include_at_sign))+subtitle}}var final_name;var was_already_truncated=args.member_ids.length!=args.count;var names=args.member_ids.map(function(id,index){var name;if(TS.model.user.id===id){name=index===0?"You":"you"}else if(TS.boot_data.feature_name_tagging_client){name=TS.members.getMemberFullName(id)}else{name=TS.members.getMemberDisplayNameById(id,should_escape,include_at_sign)}return name});final_name=was_already_truncated?"others":names.pop();return TS.utility.htmlEntities(names.join(", ")+" and "+final_name)+subtitle},buildRxnHtml:function(args){var emoji_html;if(TS.emoji.isValidName(args.name)){var suffix=args.is_handy&&TS.emoji.isNameSkinToneModifiable(args.name)?TS.emoji.getChosenSkinToneModifier():"";emoji_html=TS.emoji.graphicReplace(":"+args.name+":"+suffix,{no_skin_tone_squares:args.is_handy})}else{emoji_html='<span class="emoji-outer emoji-sizer emoji-missing" style="background-image: url('+cdn_url+"/ecf3e/img/emoji_missing.png"+');"></span>'}var title=TS.templates.builders.buildRxnTitle(args);var css_classes=[];if(args.user_reacted)css_classes.push("user_reacted");if(args.is_handy)css_classes.push("is_handy");if(args.is_hidden)css_classes.push("hidden");return TS.templates.rxns_rxn({name:args.name,css_classes:css_classes.join(" "),emoji_html:new Handlebars.SafeString(emoji_html),title:title,count:args.count,is_handy:!!args.is_handy})},updateRxnHtml:function($rxn_panel,args){var $rxn=$rxn_panel.children('.rxn[data-emoji="'+args.name+'"]');if($rxn.length){$rxn.find(".emoji_rxn_count").attr("aria-label",args.count);$rxn.toggleClass("user_reacted",args.user_reacted);var title=TS.templates.builders.buildRxnTitle(args);var existing_title;var $tip_el=$rxn.find(".ts_tip_tip_inner");if(!$tip_el.length)$tip_el=$rxn.find(".ts_tip_multiline_inner");if($tip_el.length){existing_title=$tip_el.html();if(existing_title!=title){TS.tips.updateTipTitle($rxn,title)}}else{existing_title=$rxn.prop("title");if(existing_title!=title){TS.tips.updateTipTitle($rxn,title)}}if(args.animate_it_dramatically){setTimeout(args.animate_callback,0)}else if(args.animate_it){setTimeout(args.animate_callback,0)}}else{$rxn_panel.children(".rxn_hover_container").before($(TS.templates.builders.buildRxnHtml(args)));$rxn=$rxn_panel.children('.rxn[data-emoji="'+args.name+'"]');if(args.animate_it_dramatically){$rxn.css("opacity",0).transition({opacity:1},300,args.animate_callback)}else if(args.animate_it){$rxn.css("opacity",0).transition({opacity:1},300,args.animate_callback)}}},updateRxnPanels:function(rxn_key,changed_rxn_name,actor_id){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var $rxn_panels=$("."+TS.templates.makeRxnKeyDomClass(rxn_key));var handy_rxns_dd=TS.boot_data.feature_thanks?TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key):{};var updatePoll=function($rxn_panel){for(var k in handy_rxns_dd.items){var rxn=TS.rxns.getRxnFromRxns(rxns,k);TS.templates.builders.updateRxnHtml($rxn_panel,{name:k,count:rxn&&rxn.count||0,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,k),member_ids:rxn&&rxn.users||[],rxn_key:rxn_key,is_poll:true})}};var updateNormal=function($rxn_panel){var animate_it;var animate_it_dramatically;if(rxns){rxns.forEach(function(rxn){animate_it=rxn.name==changed_rxn_name;animate_it_dramatically=animate_it&&actor_id==TS.model.user.id;TS.templates.builders.updateRxnHtml($rxn_panel,{animate_it:animate_it,animate_it_dramatically:animate_it_dramatically,name:rxn.name,count:rxn.count,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name),member_ids:rxn.users,rxn_key:rxn_key})})}var $actuals=$rxn_panel.children(".rxn");$actuals.each(function(i,el){var $rxn=$(el);var name=String($rxn.data("emoji"));if(!TS.rxns.doesRxnsHaveRxn(rxns,name)){$rxn.addClass("going_away");$rxn.transition({opacity:0},300,function(){$rxn.remove()})}});TS.ui.messages.maybeUpdateMessageHoverContainer($rxn_panel.closest("ts-message"));var $handys=$rxn_panel.children(".rxn_hover_container").find(".rxn.is_handy");$handys.each(function(i,el){var $rxn=$(el);var name=String($rxn.data("emoji"));$rxn.toggleClass("hidden",TS.rxns.doesRxnsHaveSkinlessRxn(rxns,name))})};$rxn_panels.each(function(i,el){var $div=$(el);if(!rxns&&!handy_rxns_dd.is_poll){$div.empty();TS.ui.messages.maybeUpdateMessageHoverContainer($div.closest("ts-message"));return}if(!$div.children().length){$div=$(TS.templates.builders.rxnPanel(rxn_key)).replaceAll($div)}if(handy_rxns_dd.is_poll){updatePoll($div)}else{updateNormal($div)}})},rxnPanel:function(rxn_key){if(!rxn_key)return;var classesA=[];var handy_rxns_dd=TS.boot_data.feature_thanks?TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key):{};var handy_rxns_html="";var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var rxns_html="";var buildPoll=function(){classesA.push("handy_rxns_poll");rxns_html='<span class="handy_rxns_poll_label">Poll:</span> ';for(var k in handy_rxns_dd.items){var rxn=TS.rxns.getRxnFromRxns(rxns,k);rxns_html+=TS.templates.builders.buildRxnHtml({name:k,count:rxn&&rxn.count||0,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,k),member_ids:rxn&&rxn.users||[],rxn_key:rxn_key,is_poll:true})}};var buildNormal=function(){if(rxns){rxns=_.sortBy(rxns,function(rxn){return TS.emoji.isValidName(rxn.name)?0:1});rxns.forEach(function(rxn){rxns_html+=TS.templates.builders.buildRxnHtml({name:rxn.name,count:rxn.count,user_reacted:TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name),member_ids:rxn.users,rxn_key:rxn_key})})}for(var k in handy_rxns_dd.items){handy_rxns_html+=TS.templates.builders.buildRxnHtml({name:k,is_handy:true,is_hidden:TS.rxns.doesRxnsHaveSkinlessRxn(rxns,k),rxn_key:rxn_key})}};if(handy_rxns_dd.is_poll){buildPoll()}else{buildNormal()}return TS.templates.rxns_panel({css_classes:classesA.join(" "),rxn_key:rxn_key,rxns_html:new Handlebars.SafeString(rxns_html),handy_rxns_html:new Handlebars.SafeString(handy_rxns_html),show_adder:!handy_rxns_dd.restrict,id_class:TS.templates.makeRxnKeyDomClass(rxn_key),has_hovers:!handy_rxns_dd.is_poll})},updateRxnPanelsAndHandyRxns:function(rxn_key){if(!rxn_key)return;if(!TS.boot_data.feature_thanks)return;var $rxn_panels=$("."+TS.templates.makeRxnKeyDomClass(rxn_key));if(!$rxn_panels.length)return;TS.templates.builders.updateRxnPanels(rxn_key);var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var handy_rxns_dd=TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key);var handy_rxns_html="";for(var k in handy_rxns_dd.items){handy_rxns_html+=TS.templates.builders.buildRxnHtml({name:k,is_handy:true,is_hidden:TS.rxns.doesRxnsHaveSkinlessRxn(rxns,k),rxn_key:rxn_key})}$rxn_panels.each(function(i,el){var $rxn_hover_container=$(el).find(".rxn_hover_container");var $menu_rxn=$rxn_hover_container.find(".menu_rxn");$menu_rxn.toggleClass("hidden",handy_rxns_dd.restrict);$rxn_hover_container.html(handy_rxns_html).prepend($menu_rxn)})},buildHistoryNavBtnHtml:function(){var hide_quick_switcher_btn=TS.model.prefs.no_omnibox_in_channels;var hide_prev_next_btn=false;var num_col=0;if(!hide_prev_next_btn){num_col+=2}if(!hide_quick_switcher_btn){num_col+=1}var left_btn_html=TS.templates.footer_nav_btn({col:num_col,ts_icon_type:"ts_icon_arrow_large_left",ts_tip_name:"Previous",ts_tip_shortcut:TS.model.is_mac?" ":"Alt + "});var right_btn_html=TS.templates.footer_nav_btn({col:num_col,ts_icon_type:"ts_icon_arrow_large_right",ts_tip_name:"Next",ts_tip_shortcut:TS.model.is_mac?" ":"Alt + "});var quick_switcher_btn_html=TS.templates.footer_nav_btn({col:num_col,ts_icon_type:"ts_icon_filter",ts_tip_name:"Quick Switcher",ts_tip_shortcut:TS.model.is_mac?" K":"Alt + K"});var html="";if(!hide_prev_next_btn){html+=left_btn_html+right_btn_html}if(!hide_quick_switcher_btn){html+=quick_switcher_btn_html}return html},filePreviewBackIcon:function(){return'<i class="ts_icon ts_icon_chevron_medium_left back_icon"></i>'},buildQuickSwitcherBtnHtml:function(){var html=!TS.model.is_mac&&(TS.model.is_our_app||TS.model.prefs.k_key_omnibox)?'<i class="ts_icon ts_icon_filter"></i><span id="quick_switcher_label" class="quick_switcher_label_windows_alignment">Quick Switcher</span>':'<i class="ts_icon ts_icon_filter"></i><span id="quick_switcher_label">Quick Switcher</span>';if(TS.model.is_our_app||TS.model.prefs.k_key_omnibox){return[html,'<span id="quick_switcher_shortcut">',TS.model.is_mac?"&#8984K":"Ctrl+K","</span>"].join("")}return html},raLabel:function(old_label){var new_label=old_label;switch(old_label){case"Restricted Account":new_label="Multi-Channel Guest";break;case"restricted account":new_label="multi-channel guest";break;case"Restricted account":new_label="Multi-channel guest";break;case"Restricted Accounts":new_label="Multi-Channel Guests";break;case"restricted accounts":new_label="multi-channel guests";break;case"Restricted accounts":new_label="Multi-channel guests";break;case"guest and restricted accounts":new_label="guest accounts";break;case"Restricted Accounts & Single-Channel Guests":case"Guest or Restricted Accounts":new_label="guest accounts";break;case"Restricted & Guest Accounts":new_label="Guest Accounts";break}return new_label},makeMemberTypeBadge:function(member,size,is_standalone,with_tooltip){if(!TS.boot_data.page_needs_enterprise)return"";size=parseInt(size,10);if(isNaN(size))size=16;if(typeof is_standalone!=="boolean")is_standalone=false;if(typeof with_tooltip!=="boolean")with_tooltip=false;var args={size:"member_type_badge_"+size,big:size>=20,is_standalone:is_standalone,with_tooltip:with_tooltip};if(member._is_external)return TS.templates.member_type_external_badge(args);if(member.is_ultra_restricted)return TS.templates.member_type_guest_badge(args);if(member.is_restricted)return TS.templates.member_type_restricted_badge(args);return""},makeMemberTypeBadgeClass:function(member){if(!TS.boot_data.page_needs_enterprise)return"";if(!member._is_external&&!member.is_restricted)return"";return"has_member_type_badge"},makeMemberColorClass:function(member){var color_class="color_";if(member){color_class+=member.id+" color_"+member.color}else{color_class+="unknown"}return color_class},makeMemberTypeBadgeCompact:function(member,with_tooltip){if(!TS.boot_data.page_needs_enterprise)return"";if(typeof with_tooltip!=="boolean")with_tooltip=false;var args={icon_class:"",with_tooltip:with_tooltip,tooltip:{member_type:"",type_description:""}};var directory_name=TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise?"organization directory":"team directory";if(member._is_external){args.icon_class="ts_icon_external_channel";args.tooltip.member_type="External Guests";args.tooltip.type_description="are not on your team and can only see a partial "+directory_name+", messages, and files of the shared channels they are in.";return TS.templates.member_type_icon(args)}else if(member.is_ultra_restricted){args.icon_class="ts_icon_single_channel_guest";args.tooltip.member_type="Single-Channel Guests";args.tooltip.type_description="see a partial "+directory_name+" and can only access messages and files from the channel they belong to.";return TS.templates.member_type_icon(args)}else if(member.is_restricted){args.icon_class="ts_icon_restricted_user";args.tooltip.member_type=TS.templates.builders.raLabel("Restricted Accounts");args.tooltip.type_description="see only a partial "+directory_name+" and can only access messages and files from selected channels.";return TS.templates.member_type_icon(args)}else{return""}},getMemberTypeClass:function(member){var type_class="";if(TS.boot_data.page_needs_enterprise)type_class="page_needs_enterprise";if(member._is_external)type_class+=" ext";if(member.is_restricted)type_class+=" ra";return type_class},makeTeamlabel:function(team_id){if(!team_id)return"ERROR: MISSING TEAM ID";var html="";var matching_team_data;var teams_info=TS.model.enterprise_teams;if(teams_info){matching_team_data=_.find(teams_info,function(team_info){return team_info.id===team_id})}else{return"ERROR: UNABLE TO GET TEAMS INFO"}html='<span class="org_team_tag_name">'+matching_team_data.name+"</span>";return html},loadingHTML:function(){var url_2x=cdn_url+"/f85a/img/loading_hash_animation_@2x.gif";var url_1x=cdn_url+"/272a/img/loading_hash_animation.gif";return'<div class="loading_hash_animation"><img src="'+url_2x+'" alt="Loading" srcset="'+url_1x+" 1x, "+url_2x+' 2x" /><br />loading...</div>'},test:function(){var test_ob={};Object.defineProperty(test_ob,"_buildStarComponents",{get:function(){return _buildStarComponents},set:function(v){_buildStarComponents=v}});return test_ob}});var _JL_ROLLUP_LIMIT=8;var _jl_rollup_limit_reached=false;function _getEntityFromMessage(message){if(!message){return false}var member;if(message.user==="USLACKBOT"&&message.file&&message.file.bot_id){member=_getEntityFromFile(message.file)}else{member=message.comment?TS.members.getMemberById(message.comment.user):TS.members.getMemberById(message.user)}return member}function _getEntityFromFile(file){if(!file){return false}var member;if(file.user==="USLACKBOT"&&file.bot_id){member=TS.bots.getBotById(file.bot_id);if(!member)member={};member.is_bot=true;member.is_service=true}else{member=TS.members.getMemberById(file.user)}return member}function _getUnreadMessageLabelText(channel){var unread_message="";var unread_highlight_cnt=channel.unread_highlight_cnt;var unread_cnt=channel.unread_cnt;if(unread_highlight_cnt&&!channel.is_im){unread_message+=unread_highlight_cnt+" unread highlight "}else if(unread_cnt){unread_message+=unread_cnt+" unread "}if(unread_cnt){unread_message+=unread_cnt===1?"message":"messages"}return unread_message}function _buildStarComponents(type,ob,parent_ob){if(!type)return"";if(type==="channel"&&ob&&typeof ob==="string"){ob=TS.channels.getChannelById(ob)}else if(type==="group"&&ob&&typeof ob==="string"){ob=TS.groups.getGroupById(ob)}else if(type==="im"&&ob&&typeof ob==="string"){ob=TS.ims.getImById(ob)}else if(type==="mpim"&&ob&&typeof ob==="string"){ob=TS.mpims.getMpimById(ob)}if(!ob)return"";if(type==="message"&&parent_ob&&typeof parent_ob==="string"){var c_id=parent_ob;parent_ob=TS.channels.getChannelById(c_id);if(!parent_ob)parent_ob=TS.ims.getImById(c_id);if(!parent_ob)parent_ob=TS.groups.getGroupById(c_id)}var html_attrs={};var attributes=[];var class_names=[];class_names=["star","ts_icon","ts_icon_star_o","ts_icon_inherit"];var position_class=TS.boot_data.feature_move_star_in_channel_header?"ts_tip_bottom":"ts_tip_top";class_names.push(position_class);var id=ob.id||ob.ts;var parent_id=parent_ob?parent_ob.id:null;if(type==="message"){if(!parent_id)return"";html_attrs["data-msg-id"]=id;html_attrs["data-c-id"]=parent_id;if(TS.utility.msgs.isTempMsg(ob)){class_names.push("hidden")}}else if(type==="file"){html_attrs["data-file-id"]=id}else if(type==="file_comment"){html_attrs["data-comment-id"]=id;html_attrs["data-file-id"]=parent_id;class_names.push("star_comment")}else if(type==="channel"){html_attrs["data-channel-id"]=id}else if(type==="group"){html_attrs["data-group-id"]=id}else if(type==="im"){html_attrs["data-im-id"]=id}else if(type==="mpim"){html_attrs["data-mpim-id"]=id}else{TS.error("buildStar needs to handle star item type:"+type);return""}if(ob.is_starred){class_names.push("starred","ts_icon_star");class_names.splice(class_names.indexOf("ts_icon_star_o"),1)}class_names.push("star_"+type);$.each(html_attrs,function(key,value){attributes.push(key+'="'+value+'"')});var readable_type=type;if(type==="file_comment"){readable_type="file comment"}else if(type==="im"||type==="mpim"){readable_type="direct message"}else if(type==="group"){readable_type="channel"}return{attributes:attributes,class_names:class_names,html_attrs:html_attrs,readable_type:readable_type,is_starred:ob.is_starred}}function _isWelcomePostToTeamOwner(msg){return msg.file.name===TS.utility.welcome_post.WELCOME_POST_NAME&&msg.user==="USLACKBOT"&&msg.file.user===TS.model.user.id}var _session_ms=Date.now()})();(function(){"use strict";TS.registerModule("templates.helpers",{onStart:function(){TS.templates.helpers.register()},register:function(){Handlebars.registerHelper("i18n_ns",function(namespace,options){this._i18n_ns=namespace});Handlebars.registerHelper("t",function(options){var key=options.fn();var ns;if(options.hash.ns!==undefined){ns=options.hash.ns}else if(this._i18n_ns!==undefined){ns=this._i18n_ns}else{ns=options.data.root&&options.data.root._i18n_ns?options.data.root._i18n_ns:""}var data=this;if(!_.isObject(data)){data={"this":data}}var modified_items={};var item;for(item in options.hash){modified_items[item]=data[item];data[item]=Handlebars.Utils.escapeExpression(options.hash[item])}var tokens=key.match(/{[\S]+}/g);if(tokens&&tokens.length){var getValue=function(namespace){var parts=namespace.split(".");if(parts.length>1){var i=0;var l=parts.length;var obj=data;for(i;i<l;i++){obj=obj[parts[i]];if(obj===undefined)return}return obj}return data[namespace]};var value;var i=0;var l=tokens.length;for(i;i<l;i++){item=tokens[i].substr(1,tokens[i].length-2);if(options.hash[item]===undefined){value=getValue(item);if(value!==undefined){modified_items[item]=data[item];data[item]=Handlebars.Utils.escapeExpression(value)}}}}if(options.hash.debug){TS.info("debug handlerbars t helper");TS.info(this)}var str=TS.i18n.t(key,ns)(data);for(item in modified_items){data[item]=modified_items[item]}return str});Handlebars.registerHelper("convertTimestampToMilliseconds",function(ts){return ts*1e3});Handlebars.registerHelper("listify",function(array,options){if(options.hash.map)array=_.map(array,options.hash.map);if(!options.hash.strong)return TS.i18n.listify(array).join("");var list=TS.i18n.listify(array);if(options.hash.strong){var wrap_start="<strong>";var wrap_end="</strong>";list=list.map(function(s,i){if(i%2===0){return wrap_start+Handlebars.Utils.escapeExpression(s)+wrap_end}else{return s}})}return new Handlebars.SafeString(list.join(""))});Handlebars.registerHelper("isClient",function(options){if(TS.boot_data.app=="client"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isChrome",function(options){if(TS.model.is_chrome_desktop||TS.model.is_chrome_mobile){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isFF",function(options){if(TS.model.is_FF){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isSafariDesktop",function(options){if(TS.model.is_safari_desktop){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isWeb",function(options){if(TS.boot_data.app=="web"||TS.boot_data.app=="space"||TS.boot_data.app=="calls"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isMac",function(options){if(TS.model.is_mac){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isOurApp",function(options){if(TS.model.is_our_app){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("unlessOurApp",function(options){return Handlebars.helpers["isOurApp"].call(this,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("supportsSpeech",function(options){if(TS.ui.growls.canSpeak()){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("feature",function(options){var flag=options.hash.flag;if(TS.qs_args[flag]==1||TS.boot_data[flag]==1){return options.fn(this)}return options.inverse(this)});Handlebars.registerHelper("pageNeedsEnterprise",function(options){if(TS.boot_data.page_needs_enterprise){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("comments",function(file){return new Handlebars.SafeString(TS.templates.builders.buildComments(file))});Handlebars.registerHelper("comment_standalone",TS.templates.builders.buildCommentStandalone);Handlebars.registerHelper("star",function(type,ob,parent_ob){return new Handlebars.SafeString(TS.templates.builders.buildStar(type,ob,parent_ob))});Handlebars.registerHelper("starWithTip",function(type,ob,parent_ob){return new Handlebars.SafeString(TS.templates.builders.buildStarWithTip(type,ob,parent_ob))});Handlebars.registerHelper("inlineRoomPreviewToggler",TS.templates.builders.buildInlineRoomPreviewToggler);Handlebars.registerHelper("isInlineFilePreviewExpanded",function(options){var container_id=options.hash.container_id;var file_id=options.hash.file_id;var max_image_size=360;var should_expand=false;var src=_inlineImgSrcForFile(file_id,max_image_size);if(src){should_expand=TS.inline_imgs.shouldExpand(container_id,TS.model.inline_imgs[src])}else{should_expand=TS.inline_file_previews.shouldExpand(container_id,file_id)}if(should_expand){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("shouldTruncateInlineFilePreview",function(file,options){if(typeof file==="string")file=TS.files.getFileById(file);if(file&&TS.inline_file_previews.shouldTruncate(file)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("shouldNotTruncateInlineFilePreview",function(file,options){return Handlebars.helpers["shouldTruncateInlineFilePreview"].call(this,file,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("isInlineFilePreviewTruncated",function(container_id,file,options){if(typeof file==="string")file=TS.files.getFileById(file);if(file&&TS.inline_file_previews.isTruncated(container_id,file)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isInlineFilePreviewNotTruncated",function(container_id,file,options){return Handlebars.helpers["isInlineFilePreviewTruncated"].call(this,container_id,file,{fn:options.inverse,inverse:options.fn,hash:options.hash})});Handlebars.registerHelper("formatActionLink",function(action,msg,enable_slack_action_links){if(!action)return"";var text="<"+action.url+"|"+action.title+">";var html=TS.format.formatWithOptions(text,msg,{no_highlights:true,no_specials:true,enable_slack_action_links:enable_slack_action_links===true});return new Handlebars.SafeString(html)});Handlebars.registerHelper("ellipsize",function(str,len){TS.info("len"+len);return TS.utility.ellipsize(str,len)});Handlebars.registerHelper("stripWhitespace",function(str){return str.replace(/\s+/g,"")});Handlebars.registerHelper("pluralize",function(number,singular,plural){
return TS.utility.pluralize(number,singular,plural)});Handlebars.registerHelper("pluralCount",function(number,singular,plural){return number+" "+Handlebars.helpers.pluralize.apply(this,arguments)});Handlebars.registerHelper("cash",function(options){var all_digits=options.hash.all_digits||false;var neg=false;var val=parseInt(options.hash.value);if(val<0){neg=true;val=0-val}var dollars=(val/100).toString();var out=(neg?"-":"")+"$"+dollars;if(!all_digits&&out.substring(-3)===".00"){out=out.substring(0,-3)}else if(_REGEX_CASH_DECIMAL_FORMATTING.test(dollars)){out=out+"0"}return out});Handlebars.registerHelper("possessive",function(str){if(_.endsWith(str,"s")){return""}else{return"s"}});Handlebars.registerHelper("possessiveForMemberById",function(id){var member=TS.members.getMemberById(id);if(!member)return"";return Handlebars.helpers.possessiveForMember(member)});Handlebars.registerHelper("possessiveForMember",function(member){var str=TS.members.getMemberDisplayName(member);if(_.endsWith(str,"s")){return""}else{return"s"}});Handlebars.registerHelper("concatStr",function(){return Array.prototype.slice.call(arguments,0,arguments.length-1).join("")});Handlebars.registerHelper("initialsSafe",function(team_name){if(typeof team_name!=="string")return"";var words=team_name.split(" ").slice(0,2);var initials="";for(var i=0;i<words.length;i++){initials+=words[i][0]}return new Handlebars.SafeString(initials)});Handlebars.registerHelper("json",function(obj){if(typeof obj==="object"&&obj!==null&&obj.name==="json"){return JSON.stringify(this)}else{return JSON.stringify(obj)}});Handlebars.registerHelper("currentTeamName",function(){return TS.model.team.name||""});Handlebars.registerHelper("currentTeamHostSafe",function(){return new Handlebars.SafeString(window.location.hostname)});Handlebars.registerHelper("canUserCreateGroups",function(options){return TS.members.canUserCreateGroups()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserCreateMpims",function(options){return TS.members.canUserCreateMpims()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserKickFromChannels",function(options){return TS.members.canUserKickFromChannels()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("canUserKickFromGroups",function(options){return TS.members.canUserKickFromGroups()?options.fn(this):options.inverse(this)});Handlebars.registerHelper("numberWithMax",function(number,max){if(number>=max){return max-1+"+"}else{return number}});Handlebars.registerHelper("convertFilesize",function(size){return TS.utility.convertFilesize(size)});Handlebars.registerHelper("toDate",function(ts){return TS.utility.date.toDate(ts)});Handlebars.registerHelper("toCalendarDate",function(ts){return TS.utility.date.toCalendarDate(ts)});Handlebars.registerHelper("toCalendarDateWords",function(ts){return TS.utility.date.toCalendarDateWords(ts)});Handlebars.registerHelper("toCalendarDateShort",function(ts){return TS.utility.date.toCalendarDate(ts,true)});Handlebars.registerHelper("toCalendarDateOrNamedDay",function(ts){return TS.utility.date.toCalendarDateOrNamedDay(ts)});Handlebars.registerHelper("toCalendarDateOrNamedDayWords",function(ts){return TS.utility.date.toCalendarDateOrNamedDayWords(ts)});Handlebars.registerHelper("toCalendarDateIfYesterdayOrToday",function(ts){return TS.utility.date.toCalendarDateIfYesterdayOrToday(ts)});Handlebars.registerHelper("toCalendarDateOrNamedDayShort",function(ts){return TS.utility.date.toCalendarDateOrNamedDayShort(ts)});Handlebars.registerHelper("toTime",function(ts,ampm,seconds){return TS.utility.date.toTime(ts,ampm!==false,seconds===true)});Handlebars.registerHelper("toTimeWords",function(ts,ampm,seconds){return TS.utility.date.toTimeWords(ts,ampm!==false,seconds===true)});Handlebars.registerHelper("toTimeAgo",function(ts){return TS.utility.date.toTimeAgo(ts)});Handlebars.registerHelper("toTimeDuration",function(ts){return TS.utility.date.toTimeDuration(ts)});Handlebars.registerHelper("msgTsTitle",function(msg){var title=(TS.utility.date.toCalendarDateOrNamedDayShort(msg.ts)+" at "+TS.utility.date.toTime(msg.ts,true,true)).replace(/\s/g,"&nbsp;");var ephemeral_or_temp=msg.is_ephemeral||TS.utility.msgs.isTempMsg(msg);if(TS.client&&!ephemeral_or_temp)title='Open in archives<br><span class="subtle_silver">'+title+"</span>";return new Handlebars.SafeString(title)});Handlebars.registerHelper("toHour",function(ts){return TS.utility.date.toHour(ts)});Handlebars.registerHelper("timezoneLabel",function(member,include_local_time){return TS.utility.date.timezoneLabel(member,include_local_time)});Handlebars.registerHelper("memberLocalTime",function(member){return new Handlebars.SafeString(TS.utility.date.memberLocalTime(member))});Handlebars.registerHelper("memberUTCOffset",function(member){return TS.utility.date.memberUTCOffset(member)});Handlebars.registerHelper("isInDifferentTimeZone",function(member,options){if(member.tz_offset!==TS.model.user.tz_offset)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("isToday",function(member,options){if(TS.utility.date.isToday(TS.utility.date.toDateObject(member)))return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_equal",function(context,options){options=_optionsFnInverseBooleanHelper(options);if(context==options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_not_equal",function(context,options){options=_optionsFnInverseBooleanHelper(options);if(context!=options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_gt",function(context,options){if(context>options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("if_lt",function(context,options){if(context<options.hash.compare)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("or",function(a,b,options){options=_optionsFnInverseBooleanHelper(options);if(a||b){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("and",function(a,b,options){options=_optionsFnInverseBooleanHelper(options);if(a&&b){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("foreach",function(arr,options){if(options.inverse&&!arr.length)return options.inverse(this);return arr.map(function(item,index){var obj={index:index,value:item,length:arr.length};obj.first=index===0;obj.last=index===arr.length-1;return options.fn(obj)}).join("")});Handlebars.registerHelper("repeat",function(n,block){var accum="";for(var i=0;i<n;i++){accum+=block.fn(i)}return accum});Handlebars.registerHelper("makeDayDividerDomId",function(ts){return TS.templates.makeDayDividerDomId(ts)});Handlebars.registerHelper("formatFileTitle",function(file){if(!file||!file.title)return"";return TS.format.formatWithOptions(file.title,null,{no_specials:true})});Handlebars.registerHelper("formatMessageByType",TS.templates.builders.formatMessageByType);Handlebars.registerHelper("formatAttachments",TS.templates.builders.formatAttachments);Handlebars.registerHelper("formatMessage",function(text,msg){return TS.format.formatDefault(text,msg)});Handlebars.registerHelper("formatNoHighlightsNoSpecials",function(text,msg){return TS.format.formatNoHighlightsNoSpecials(text,msg)});Handlebars.registerHelper("formatMessageAttachmentPartEscaped",TS.utility.attachments.formatMessageAttachmentPart);Handlebars.registerHelper("formatMessageAttachmentPart",function(text,msg,do_highlighting,do_specials,enable_slack_action_links){return new Handlebars.SafeString(TS.utility.attachments.formatMessageAttachmentPart(text,msg,do_highlighting,do_specials,enable_slack_action_links))});Handlebars.registerHelper("formatMessageAttachmentSlackFooter",function(text){var html=TS.format.formatJustText(TS.format.cleanMsg(text));return new Handlebars.SafeString(html)});Handlebars.registerHelper("formatTopicOrPurpose",function(text){return new Handlebars.SafeString(TS.utility.formatTopicOrPurpose(text))});Handlebars.registerHelper("unFormatMessage",function(text,msg){return TS.format.unFormatMsg(text,msg)});Handlebars.registerHelper("formatMessageResult",function(text){text=TS.format.formatJustText(text);text=TS.utility.msgs.handleSearchHighlights(text);return text});Handlebars.registerHelper("formatStarredMessageAndTruncate",function(msg,length){var text=msg.text;if(msg.subtype=="channel_topic"){if(msg.text){text="channel topic: "+msg.text}else{text="channel topic cleared"}}else if(msg.subtype=="channel_purpose"){if(msg.text){text="channel purpose: "+msg.text}else{text="channel purpose cleared"}}else if(msg.subtype=="channel_join"){text="joined channel"}else if(msg.subtype=="channel_leave"){text="left channel"}else if(msg.subtype=="group_topic"){if(msg.text){text="group topic: "+msg.text}else{text="group topic cleared"}}else if(msg.subtype=="group_purpose"){if(msg.text){text="group purpose: "+msg.text}else{text="group purpose cleared"}}else if(msg.subtype=="group_join"){text="joined group"}else if(msg.subtype=="group_leave"){text="left group"}else if(msg.subtype=="group_archive"){text="archived group"}else if(msg.subtype=="group_unarchive"){text="un-archived group"}else if(msg.subtype=="channel_archive"){text="archived channel"}else if(msg.subtype=="channel_unarchive"){text="un-archived channel"}var truncated_msg=truncate(TS.format.formatDefault(text,msg),length);if(msg.permalink){var read_more_link=' <a target="'+TS.templates.builders.newWindowName()+'" href="'+msg.permalink+'" class="normal tiny">read more</a>';return truncated_msg+read_more_link}else{return truncated_msg}});Handlebars.registerHelper("formatMessageExcerpt",function(msg,length){length=length||80;var ellipsis="&hellip;";var text=msg.text;if(TS.boot_data.feature_message_replies){text=TS.format.formatNoHighlightsNoInlineImgs(text,msg)}else{text=TS.format.unFormatMsg(text,msg);text=TS.utility.htmlEntities(text);text=TS.emoji.graphicReplace(text)}var truncated=truncate(text,length,{ellipsis:ellipsis});if(truncated.length!==text.length){var regex=/&[a-z]*&hellip;$/;var match=regex.exec(truncated);if(match&&match.index){truncated=truncated.substring(0,match.index)+ellipsis}}return new Handlebars.SafeString(truncated)});Handlebars.registerHelper("rxnPanel",function(rxn_key){var panel_html=TS.templates.builders.rxnPanel(rxn_key);if(!panel_html){return""}else{return new Handlebars.SafeString(panel_html)}});Handlebars.registerHelper("fileActionsCog",function(file){return'<a class="file_actions file_actions_cog ts_icon ts_icon_cog" data-file-id="'+file.id+'"></a>'});Handlebars.registerHelper("fileActionsBtn",function(file){return'<a class="file_actions ts_icon ts_icon_chevron_medium_down" data-file-id="'+file.id+'"></a>'});Handlebars.registerHelper("fileActionsLink",function(file){return'<a class="file_actions file_actions_link" data-file-id="'+file.id+'">Actions <i class="ts_icon ts_icon_caret_down ts_icon_inherit"></i></a>'});Handlebars.registerHelper("makeRefererSafeLink",function(options){if(typeof options.hash.url!=="string")return"";return new Handlebars.SafeString(TS.utility.makeRefererSafeLink(options.hash.url))});Handlebars.registerHelper("makeSafeForDomId",TS.utility.makeSafeForDomId);Handlebars.registerHelper("makeMsgAttachmentTextExpanderDomId",TS.templates.makeMsgAttachmentTextExpanderDomId);Handlebars.registerHelper("makeMsgDomId",TS.templates.makeMsgDomId);Handlebars.registerHelper("makeMsgLabelDomId",TS.templates.makeMsgLabelDomId);Handlebars.registerHelper("makeMSRDomId",TS.templates.makeMSRDomId);Handlebars.registerHelper("makeSHRoomClass",TS.templates.makeSHRoomClass);Handlebars.registerHelper("makeMsgSubtypeDomClass",function(msg){var dom_class="";if(!msg.subtype)return dom_class;if(msg.subtype=="channel_join"||msg.subtype=="group_join"){dom_class+="joined automated"}else if(msg.subtype=="channel_leave"||msg.subtype=="group_leave"){dom_class+="left automated"}else if(msg.subtype=="channel_topic"||msg.subtype=="group_topic"){dom_class+="topic automated"}else if(msg.subtype=="channel_name"||msg.subtype=="group_name"){dom_class+="rename automated"}else if(msg.subtype=="channel_purpose"||msg.subtype=="group_purpose"){dom_class+="purpose automated"}else if(msg.subtype=="channel_archive"||msg.subtype=="group_archive"){dom_class+="archived automated"}else if(msg.subtype=="channel_unarchive"||msg.subtype=="group_unarchive"){dom_class+="unarchived automated"}else if(msg.subtype=="bot_message"){dom_class+="bot_message"}else if(msg.subtype==="pinned_item"){dom_class+="pinned"}else if(msg.subtype==="sh_room_shared"){dom_class+="sh_shared automated"}else if(msg.subtype==="sh_room_created"){dom_class+="sh_created automated"}else if(msg.subtype==="bot_add"||msg.subtype==="bot_remove"||msg.subtype==="bot_enable"||msg.subtype==="bot_disable"){dom_class+="bot_change automated"}else if(msg.subtype==="reminder_add"||msg.subtype==="reminder_delete"){dom_class+="reminder_change automated"}return dom_class});Handlebars.registerHelper("buildMsgHTMLForSearch",function(){var html=TS.templates.builders.buildMsgHTMLForSearch.apply(this,arguments);return new Handlebars.SafeString(html)});Handlebars.registerHelper("ifExtracts",function(msg,options){if(msg.previous||msg.previous_2||msg.next||msg.next_2){return options.fn(this)}return options.inverse(this)});Handlebars.registerHelper("willForceExtracts",function(msg,options){if(!msg.previous&&!msg.next||TS.search.view.resultHasExtracts(msg))return options.inverse(this);var query=TS.search.query_string;var words=query.split(" ");var i,word;var has_search_term=false;for(i=0;i<words.length;i++){word=$.trim(words[i]);if(word.length>0&&!TS.search.keyword_modifier_pair_regex.test(word)){has_search_term=true;break}}if(!has_search_term)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("formatAttachmentExtracts",function(attachment,message){var bg_color=attachment.color||"e3e4e6";return TS.templates.search_attachment_extracts({attachment:attachment,message:message,bg_color:bg_color})});Handlebars.registerHelper("getAttachmentAuthorMemberId",function(attachment){var decorated=TS.utility.attachments.getDecoratedAttachment(attachment);if(!decorated)return"";return decorated._slack_author_id||""});Handlebars.registerHelper("concatMsgExtracts",function(message){if(!message.extracts||message.extracts.length===0)return"";var extract_texts=message.extracts.map(function(extract){if(extract.text)extract.text=extract.text.replace(/&&gt;t;>&gt;/g,"&gt;&gt;&gt;");var cleaned_extract=TS.format.replaceHighlightMarkers(extract.text);if(TSF.jumbomoji_rx.match(cleaned_extract)){return TS.format.formatDefault(cleaned_extract,message)}var formatted_msg=TS.format.formatDefault(extract.text,message);formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);return formatted_msg});var ellipsis=TS.templates.builders.search_ellipsis;var html=extract_texts.join(ellipsis);if(message.extracts[0].truncated_head)html=ellipsis+html;if(message.extracts[message.extracts.length-1].truncated_tail)html+=ellipsis;return html});Handlebars.registerHelper("concatAttachmentExtracts",function(attachment,message){var extract_texts=[];var extracts=attachment.extracts;var last_extract;var ellipsis=TS.templates.builders.search_ellipsis;if(!extracts)return"";["title","text"].forEach(function(key){if(extracts[key]){extracts[key].forEach(function(extract){var formatted_msg=TS.format.formatDefault(extract.text,message);formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);if(extract_texts.length===0&&extract.truncated_head)formatted_msg=ellipsis+formatted_msg;last_extract=extract;extract_texts.push(formatted_msg)})}});var concatenated=extract_texts.join(ellipsis);if(concatenated&&last_extract&&last_extract.truncated_tail)concatenated+=ellipsis;if(!concatenated&&extracts.fields&&!extracts.fallback){extracts.fields.forEach(function(field){var value=TS.utility.htmlEntities(field.value.text);value=TS.utility.msgs.handleSearchHighlights(value);if(field.value.truncated_head)value=ellipsis+value;if(field.value.truncated_tail)value+=ellipsis;concatenated+="<strong>"+TS.utility.htmlEntities(field.title)+"</strong> &bull; "+value+"<br>"})}if(!concatenated&&attachment.fallback){var fallback_text=attachment.fallback;if(extracts.fallback&&extracts.fallback.length>0)fallback_text=extracts.fallback[0].text;var fallback=TS.format.formatDefault(fallback_text,message);fallback=TS.utility.msgs.handleSearchHighlights(fallback);return fallback}return concatenated});Handlebars.registerHelper("newWindowName",TS.templates.builders.newWindowName);Handlebars.registerHelper("nl2br",function(text){if(!text)return text;text=TS.utility.htmlEntities(text);return text.replace(/\n/g,"<br />").replace(/&amp;#95;/g,"_")});Handlebars.registerHelper("smartnl2br",function(text){if(!text)return text;text=TS.utility.htmlEntities(text);text=text.replace(/\n\r\n\r/g,'<span class="para_break"><br /></span>');text=text.replace(/\n\r\n/g,'<span class="para_break"><br /></span>');text=text.replace(/\n\n/g,'<span class="para_break"><br /></span>');text=text.replace(/\n/g,"<br />");return new Handlebars.SafeString(text.replace(/&amp;#95;/g,"_"))});Handlebars.registerHelper("truncate",function(text,length){var truncated_text=truncate(text,length);return truncated_text.replace(/&#64;/g,"@")});Handlebars.registerHelper("truncateToNearestWordBoundary",TS.utility.truncateToNearestWordBoundary);Handlebars.registerHelper("proxyImgUrls",function(html){var $html=$("<div>"+html+"</div>");$html.find("img").each(function(){var original_src=$(this).attr("src");var original_w=$(this).attr("width");var original_h=$(this).attr("height");var proxied_url;if(original_w&&original_h){proxied_url=TS.utility.getImgProxyURL(original_src,original_w,original_h)}else{proxied_url=TS.utility.getImgProxyURL(original_src)}$(this).attr("src",proxied_url)});return $html.html()});Handlebars.registerHelper("generalName",function(){var chan=TS.channels.getGeneralChannel();return chan?chan.name:""});Handlebars.registerHelper("makeChannelDomId",function(channel){return TS.templates.makeChannelDomId(channel)});Handlebars.registerHelper("firstListedChannel",function(){var channel=TS.channels.getChannelsForUser()[0];if(channel)return"#"+channel.name});Handlebars.registerHelper("ChannelNameMaxLength",function(channel){return TS.model.channel_name_max_length});Handlebars.registerHelper("ChannelPurposeMaxLength",function(){return TS.model.channel_purpose_max_length});Handlebars.registerHelper("ChannelTopicMaxLength",function(){return TS.model.channel_topic_max_length});Handlebars.registerHelper("makeUnreadMsgsDomId",function(channel){return TS.templates.makeUnreadMsgsDomId(channel)});Handlebars.registerHelper("getCorGNameWithPrefixById",function(id,hide_unknown_groups){var channel=TS.channels.getChannelById(id);if(channel)return"#"+channel.name;var group=TS.groups.getGroupById(id);if(group)return TS.model.group_prefix+group.name;if(hide_unknown_groups){return}else{return id}});Handlebars.registerHelper("makeChannelLink",function(channel){return new Handlebars.SafeString(TS.templates.builders.makeChannelLink(channel))});Handlebars.registerHelper("makeChannelLinkById",function(id){var channel=TS.channels.getChannelById(id);if(channel)return TS.templates.builders.makeChannelLink(channel)});Handlebars.registerHelper("makeChannelLinkAriaLabelSafe",TS.templates.builders.makeChannelLinkAriaLabelSafe);Handlebars.registerHelper("makeUnreadHighlightDomId",function(channel){return TS.templates.makeUnreadHighlightDomId(channel)});Handlebars.registerHelper("makeChannelDomClass",function(channel){var dom_class="";if(TS.model.active_channel_id==channel.id&&!TS.client.activeChannelIsHidden())dom_class+="active ";if(channel.unread_cnt>0)dom_class+="unread ";if(channel.unread_highlight_cnt>0)dom_class+="mention ";if(channel.is_starred)dom_class+="is_starred ";if(TS.notifs.isCorGMuted(channel.id))dom_class+="muted_channel ";if(channel._show_in_list_even_though_no_unreads)dom_class+="show_in_list_even_though_no_unreads ";return dom_class});Handlebars.registerHelper("makeChannelOrGroupLinkById",function(id,omit_prefix){var ob=TS.shared.getModelObById(id);var html="";if(ob.is_channel){html=TS.templates.builders.makeChannelLink(ob,omit_prefix)}else if(ob.is_mpim){html=TS.templates.builders.makeMpimLink(ob,false)}else if(ob.is_group){html=TS.templates.builders.makeGroupLink(ob,omit_prefix)}return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeChannelOrGroupSSBLinkById",function(id){var ob=TS.shared.getModelObById(id);if(!ob)return;var text;var url="slack://channel?team="+TS.model.team.id+"&id="+id;if(ob.is_channel){var channel=TS.channels.getChannelById(id);text="#"+channel.name;return"<a href="+url+">"+text+"</a>"}else if(ob.is_group){text=TS.model.group_prefix+ob.name;return"<a href="+url+">"+text+"</a>"}});Handlebars.registerHelper("makeInternalChannelOrGroupLinkById",function(id){var ob=TS.shared.getModelObById(id);if(!ob)return;if(ob.is_channel){return TS.templates.builders.makeInternalChannelLink(ob)}else if(ob.is_group){return TS.templates.builders.makeInternalGroupLink(ob)}});Handlebars.registerHelper("isTeamInOrg",function(team,options){if(!TS.boot_data.external_shared_channels_ui||!TS.boot_data.page_needs_enterprise)return options.inverse(this);var is_in_org=TS.model.enterprise_teams.some(function(enterprise_team){return enterprise_team.id===team.id});return is_in_org?options.fn(this):options.inverse(this)});Handlebars.registerHelper("isThereComplianceExportsTeam",function(channel,options){if(!TS.boot_data.page_needs_enterprise)return options.inverse(this);var does_a_team=false;if(channel.is_shared){does_a_team=channel.shares.some(function(team){return team.team.has_compliance_export})}return does_a_team?options.fn(this):options.inverse(this)});Handlebars.registerHelper("makeTeamsThatHaveComplianceExportsBlurb",TS.templates.builders.makeTeamsThatHaveComplianceExportsBlurb);Handlebars.registerHelper("isEnterpriseTeam",function(options){return TS.boot_data.page_needs_enterprise?options.fn(this):options.inverse(this)});Handlebars.registerHelper("isLocalTeam",function(team_id,options){options=_optionsFnInverseBooleanHelper(options);if(!TS.boot_data.feature_enterprise_search_ui||!TS.boot_data.page_needs_enterprise)return options.inverse(this);if(team_id==TS.model.team.id){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentEnterpriseName",function(){if(!TS.boot_data.page_needs_enterprise)return"";return TS.model.enterprise.name||""});Handlebars.registerHelper("makeTeamlabel",function(team_id,teams_info){var html=TS.templates.builders.makeTeamlabel(team_id,teams_info);return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeGroupDomId",function(group){return TS.templates.makeGroupDomId(group)});Handlebars.registerHelper("groupPrefix",function(group){return new Handlebars.SafeString(TS.model.group_prefix)});Handlebars.registerHelper("makeGroupLink",function(){var group_link=TS.templates.builders.makeGroupLink.apply(this,arguments);return new Handlebars.SafeString(group_link)});Handlebars.registerHelper("makeGroupLinkById",function(id){var group=TS.groups.getGroupById(id);if(group)return TS.templates.builders.makeGroupLink(group)});Handlebars.registerHelper("makeGroupLinkAriaLabelSafe",TS.templates.builders.makeGroupLinkAriaLabelSafe);Handlebars.registerHelper("makeGroupDomClass",function(group){var dom_class="";if(TS.model.active_group_id==group.id&&!TS.client.activeChannelIsHidden())dom_class+="active ";if(group.unread_cnt>0)dom_class+="unread ";if(group.unread_highlight_cnt>0)dom_class+="mention ";if(group.is_starred)dom_class+="is_starred ";if(TS.notifs.isCorGMuted(group.id))dom_class+="muted_channel ";if(group._show_in_list_even_though_no_unreads)dom_class+="show_in_list_even_though_no_unreads ";return dom_class});Handlebars.registerHelper("mpimMemberCount",function(mpim){return TS.mpims.getMemberCount(mpim)});Handlebars.registerHelper("mpimDisplayName",function(mpim,for_header,show_last_initial){for_header=for_header===true;var name=TS.mpims.getDisplayName(mpim,for_header,show_last_initial===true);if(for_header){return new Handlebars.SafeString(name)}else{return name}});Handlebars.registerHelper("makeMpimDomClass",function(mpim){var dom_class="";if(!mpim)return dom_class;if(mpim.id===TS.model.active_mpim_id&&!TS.client.activeChannelIsHidden())dom_class+="active ";if(mpim.unread_cnt>0||mpim.unread_highlight_cnt>0)dom_class+="unread mention ";if(TS.notifs.isCorGMuted(mpim.id))dom_class+="muted_channel ";if(mpim.is_starred)dom_class+="is_starred ";return dom_class});Handlebars.registerHelper("makeMpimDomId",function(mpim){return TS.templates.makeMpimDomId(mpim)});Handlebars.registerHelper("makeMpimLink",function(mpim,with_title){var mpim_link=TS.templates.builders.makeMpimLink(mpim,with_title);return new Handlebars.SafeString(mpim_link)});Handlebars.registerHelper("mpimArchivesPath",function(mpim){return TS.mpims.getMpimArchivesPath(mpim)});Handlebars.registerHelper("isCorGMuted",function(id,options){if(TS.notifs.isCorGMuted(id)){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserId",function(){return TS.model.user.id});Handlebars.registerHelper("makeMemberDomId",function(member){return TS.templates.makeMemberDomId(member)});Handlebars.registerHelper("makeChannelListDomId",function(channel){return TS.templates.makeChannelListDomId(channel)});Handlebars.registerHelper("makeMemberPresenceDomClass",function(member){return TS.templates.makeMemberPresenceDomClass(member.id)});Handlebars.registerHelper("makeMemberPresenceIcon",function(member){return new Handlebars.SafeString(TS.templates.makeMemberPresenceIcon(member))});Handlebars.registerHelper("makeMemberTypeBadge",function(){var html=TS.templates.builders.makeMemberTypeBadge.apply(this,arguments);return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeMemberTypeBadgeCompact",function(){var html=TS.templates.builders.makeMemberTypeBadgeCompact.apply(this,arguments);return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeMemberStatusDomClass",function(member){return TS.templates.makeMemberStatusDomClass(member.id)});Handlebars.registerHelper("makeMemberDomClass",function(member){var dom_class="";if(!member)return dom_class;if(!member.is_self&&member.presence=="away")dom_class+="away ";if(TS.model.active_im_id){var active_im=TS.ims.getImById(TS.model.active_im_id);if(active_im.user==member.id&&!TS.client.activeChannelIsHidden())dom_class+="active "}var im=TS.ims.getImByMemberId(member.id);if(im){if(im.unread_cnt>0||im.unread_highlight_cnt>0)dom_class+="unread mention ";if(im.is_starred)dom_class+="is_starred "}return dom_class});Handlebars.registerHelper("makeMemberListDomClass",function(member){var dom_class="member ";if(member.presence=="away")dom_class+="away ";return dom_class});Handlebars.registerHelper("makeMemberPreviewLink",function(){var html=TS.templates.builders.makeMemberPreviewLink.apply(this,arguments);return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeMemberPreviewLinkById",function(id,show_you_for_current_user){if(show_you_for_current_user!==true)show_you_for_current_user=false;var member=TS.members.getMemberById(id)||TS.bots.getBotById(id);if(!member)return new Handlebars.SafeString(id);return new Handlebars.SafeString(TS.templates.builders.makeMemberPreviewLink(member,show_you_for_current_user))});Handlebars.registerHelper("makeMemberPreviewLinkImage",function(){return new Handlebars.SafeString(TS.templates.builders.makeMemberPreviewLinkImage.apply(this,arguments))});Handlebars.registerHelper("makeMemberPreviewCardLinkImage",function(){return new Handlebars.SafeString(TS.templates.builders.makeMemberPreviewCardLinkImage.apply(this,arguments))});Handlebars.registerHelper("makeProfileImage",TS.templates.builders.makeProfileImage);Handlebars.registerHelper("makePendingUserImage",function(){return new Handlebars.SafeString(TS.templates.builders.makePendingUserImage.apply(this,arguments))});Handlebars.registerHelper("emojiGraphicReplace",function(emoji,force_style){var options={};if(force_style&&typeof force_style=="string"){options.force_style=force_style}else{options.obey_emoji_mode_pref=true}return new Handlebars.SafeString(TS.emoji.graphicReplace(emoji,options))});Handlebars.registerHelper("emojiGraphicReplaceByName",function(name){return TS.emoji.graphicReplace(":"+name+":")});Handlebars.registerHelper("makeMemberImage",TS.templates.builders.makeMemberImage);Handlebars.registerHelper("makeUsernameImage",function(msg,size){var img_src,size_class,emoji_str,default_img_src;var bot_icons;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(msg.icons){bot_icons=msg.icons}else if(bot&&bot.icons){bot_icons=bot.icons}if(bot_icons){if(bot_icons.image_36&&!TS.environment.is_retina){img_src=bot_icons.image_36}else if(bot_icons.image_72&&TS.environment.is_retina){img_src=bot_icons.image_72}else if(bot_icons.image_48){img_src=bot_icons.image_48}else if(bot_icons.emoji&&bot_icons.emoji.substr(0,1)==":"&&bot_icons.emoji.substr(bot_icons.emoji.length-1,1)==":"){emoji_str=bot_icons.emoji}}var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);var member_for_default=msg&&msg.is_ephemeral&&msg.username=="slackbot"?TS.members.getMemberById("USLACKBOT"):null;switch(size){case 24:size_class="thumb_24";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-24.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_24}break;case 32:size_class="thumb_32";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-32.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_32}break;case 36:size_class="thumb_36";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-48.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_48}break;case 72:size_class="thumb_72";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-72.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_72}break;case 192:size_class="thumb_192";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-192.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_192}break;default:size_class="thumb_48";default_img_src="https://i0.wp.com/slack-assets2.s3-us-west-2.amazonaws.com/8390/img/avatars/ava_0002-48.png?ssl=1";if(member_for_default){default_img_src=member_for_default.profile.image_48}break}var html;if(img_src){html=bot_link.start_a+'<img style="border: 0" src="'+img_src+'" class="member_image '+size_class+'" />'+bot_link.end_a}else if(emoji_str){html=bot_link.start_a+'<div style="border: 0" class="member_image '+size_class+'">'+TS.emoji.graphicReplace(TS.utility.htmlEntities(emoji_str))+"</div>"+bot_link.end_a}else{if(member_for_default){html=bot_link.start_a+'<img src="'+default_img_src+'" class="member_image '+size_class+'" />'+bot_link.end_a}else{html=bot_link.start_a+'<img src="'+default_img_src+'" class="member_image bot_icon_default '+size_class+'" />'+bot_link.end_a}}return new Handlebars.SafeString(html)});Handlebars.registerHelper("getMemberNameById",function(id){var member=TS.members.getMemberById(id);return member?member.name:id});Handlebars.registerHelper("getMemberDisplayNameById",function(id){return TS.members.getMemberDisplayNameById(id)});Handlebars.registerHelper("getMemberDisplayName",function(member,should_escape,include_at_sign){return TS.members.getMemberDisplayName(member,should_escape===true,include_at_sign===true)});if(TS.boot_data.feature_name_tagging_client){Handlebars.registerHelper("getMemberPreferredName",function(member_or_id){
return TS.members.getMemberPreferredName(member_or_id)});Handlebars.registerHelper("getMemberFullName",function(member_or_id){return TS.members.getMemberFullName(member_or_id)})}Handlebars.registerHelper("getMemberRealName",function(member){return TS.members.getMemberRealName(member)});Handlebars.registerHelper("getMemberUsernameAndRealNameInCorrectOrder",function(member){var display_name=TS.members.getMemberDisplayName(member);var names_in_correct_order_html="";if(display_name===member.name){names_in_correct_order_html="<span class='member_username'>"+TS.utility.htmlEntities(member.name)+"</span>";if(member.is_self){names_in_correct_order_html+="<span class='member_real_name'>"+"(you)"+"</span>"}else if(member.profile.real_name&&member.profile.real_name!==member.name){names_in_correct_order_html+="<span class='member_real_name'>"+TS.utility.htmlEntities(member.profile.real_name)+"</span>"}}else{if(member.profile.real_name&&member.profile.real_name!==member.name)names_in_correct_order_html="<span class='member_real_name'>"+TS.utility.htmlEntities(member.profile.real_name)+"</span>";var name=member.is_self?"(you)":TS.utility.htmlEntities(member.name);names_in_correct_order_html+="<span class='member_username'>"+name+"</span>"}return new Handlebars.SafeString(names_in_correct_order_html)});Handlebars.registerHelper("getMemberFullNameAndPreferredNameInOrder",function(member){var full_name_and_preferred_name_html="";full_name_and_preferred_name_html="<span class='member_full_name'>"+TS.utility.htmlEntities(TS.members.getMemberFullName(member))+"</span>";if(member.is_self){full_name_and_preferred_name_html+="<span class='member_preferred_name'>"+"(you)"+"</span>"}else if(member.profile.preferred_name){full_name_and_preferred_name_html+="<span class='member_preferred_name'>"+TS.utility.htmlEntities(TS.members.getMemberPreferredName(member))+"</span>"}return new Handlebars.SafeString(full_name_and_preferred_name_html)});Handlebars.registerHelper("getMemberCurrentStatus",function(member){return TS.members.getMemberCurrentStatus(member)});Handlebars.registerHelper("getDisplayNameOfUserForIm",function(im){if(!im)return"MISSING_IM";return TS.ims.getDisplayNameOfUserForIm(im)});Handlebars.registerHelper("getIMIdByMemberId",function(member_id){var im=TS.ims.getImByMemberId(member_id);return im?im.id:""});Handlebars.registerHelper("memberHasIm",function(options){var member=options.hash.member;var has_im=false;if(member){if(TS.ims.getImByMemberId(member.id))has_im=true}if(has_im){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberHasImUnreadCount",function(options){var member=options.hash.member;var has_unreads=false;if(member){var im=TS.ims.getImByMemberId(member.id);if(im&&im.unread_cnt)has_unreads=true}if(has_unreads){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getUnreadCountForIMByMemberId",function(id){var im=TS.ims.getImByMemberId(id);if(im){return im.unread_cnt}else{return""}});Handlebars.registerHelper("makeMemberLinksWithDisplayNames",function(member_ids_string){if(!member_ids_string)return"";return member_ids_string.split(/\s*\,\s*/).map(function(id){return TS.templates.builders.makeMemberPreviewLink(TS.members.getMemberById(id))}).join(", ")});function makeIMLink(im){var member=TS.members.getMemberById(im.user);var template_args={im_exists:!TS.ims.isImWithDeletedMember(im),im_name:im.name,im_id:im.id,member_color:"color_"+(member?member.id+" color_"+member.color:"unknown")};if(TS.utility.shouldLinksHaveTargets()){var target=TS.ims.isImWithDeletedMember(im)?TS.templates.builders.newWindowName():"/messages/@"+im.name;template_args.target=target}return TS.templates.search_im_link(template_args)}Handlebars.registerHelper("makeIMLink",function(im){return new Handlebars.SafeString(makeIMLink(im))});Handlebars.registerHelper("makeIMLinkById",function(id){var im=TS.ims.getImById(id);if(im)return new Handlebars.SafeString(makeIMLink(im))});function getBotNameAndIcon(msg){var username=TS.utility.htmlEntities(msg.username);var bot_icons;var bot=msg.bot_id?TS.bots.getBotById(msg.bot_id):null;if(msg.icons){bot_icons=msg.icons}else{if(bot&&bot.icons){bot_icons=bot.icons}else{}}if(!username&&bot&&bot.name){username=TS.utility.htmlEntities(bot.name)}var bot_link=TS.templates.builders.makeBotLink(bot,msg.username);if(!bot_icons){return bot_link.start_a+username+bot_link.end_a}var html;if(bot_icons.emoji&&bot_icons.emoji.substr(0,1)==":"&&bot_icons.emoji.substr(bot_icons.emoji.length-1,1)==":"){html=bot_link.start_a+TS.emoji.graphicReplace(TS.utility.htmlEntities(bot_icons.emoji))+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_36&&!TS.environment.is_retina){html=bot_link.start_a+'<img src="'+bot_icons.image_36+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_72&&TS.environment.is_retina){html=bot_link.start_a+'<img src="'+bot_icons.image_72+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else if(bot_icons.image_48){html=bot_link.start_a+'<img src="'+bot_icons.image_48+'" class="inline_bot_icon">'+bot_link.end_a+" "+bot_link.start_a+username+bot_link.end_a}else{html=bot_link.start_a+username+bot_link.end_a}return html}Handlebars.registerHelper("getBotNameAndIcon",getBotNameAndIcon);Handlebars.registerHelper("getBotName",TS.templates.builders.getBotName);Handlebars.registerHelper("getBotNameWithLink",TS.templates.builders.getBotNameWithLink);function getBotColorClassByUserName(username){if(!username)return"color_unknown";return"color_bot_"+TS.utility.makeSafeForDomClass(username)}Handlebars.registerHelper("getBotColorClassByUserName",getBotColorClassByUserName);function getMemberColorClassById(id){var member=TS.members.getMemberById(id);if(!member)return"color_unknown";return"color_"+member.id+" color_"+member.color}Handlebars.registerHelper("getMemberColorClassById",getMemberColorClassById);Handlebars.registerHelper("getMemberColorClassByImId",function(im_id){var im=TS.ims.getImById(im_id);if(!im)return"color_unknown";return getMemberColorClassById(im.user)});Handlebars.registerHelper("makeMemberLinkAriaLabelSafe",TS.templates.builders.makeMemberLinkAriaLabelSafe);Handlebars.registerHelper("msgIsFromSelf",function(options){var msg=options.hash.msg;var id=msg.user;if(!id&&msg.subtype=="file_comment"&&msg.comment)id=msg.comment.user;var member=TS.members.getMemberById(id);if(!member)return options.inverse(this);if(member.is_self){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberIsSelf",function(options){var member=TS.members.getMemberById(options.hash.id);if(!member)return options.inverse(this);if(member.is_self){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("memberIsAdmin",function(options){var member=TS.members.getMemberById(options.hash.id);if(!member)return options.inverse(this);if(member.is_admin){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsAdmin",function(options){if(TS.model.user.is_admin){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsOwner",function(options){if(TS.model.user.is_owner){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsRA",function(options){if(TS.model.user.is_restricted){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("currentUserIsURA",function(options){if(TS.model.user.is_ultra_restricted){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("tinyspeck",function(options){if(TS.boot_data.feature_tinyspeck){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("slackbotHelpEnabled",function(options){if(TS.boot_data.slackbot_help_enabled){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("makeUnshareLinkById",function(id){var file=TS.files.getFileById(TS.web.file.file_id);var ob=TS.shared.getModelObById(id);if(ob)return TS.templates.builders.makeUnshareLink(ob,file)});Handlebars.registerHelper("makeUnshareLink",function(ob){var file=TS.files.getFileById(TS.web.file.file_id);return TS.templates.builders.makeUnshareLink(ob,file)});Handlebars.registerHelper("makeFileDomId",function(file){return TS.templates.makeFileDomId(file)});Handlebars.registerHelper("makeFileCommentsDomId",function(file){return TS.templates.makeFileCommentsDomId(file)});Handlebars.registerHelper("makeFileContentsDomId",function(file){return TS.templates.makeFileContentsDomId(file)});Handlebars.registerHelper("makeFileCommentHelpText",function(file){return TS.templates.builders.makeFileCommentHelpText(file)});Handlebars.registerHelper("makeFileHeader",function(file,member){var args=TS.files.getFileActions(file);args.file=file;args.is_post=file.mode=="space"||file.mode=="post";args.download=file.mode==="hosted";args.member=member;return TS.templates.file_header(args)});Handlebars.registerHelper("makeFilePreviewHeader",function(file,member){var args=TS.files.getFileActions(file);args.file=file;args.member=member;args.download=file.mode==="hosted";args.edit_link=file.mode=="post"?file.edit_link:file.permalink;args.is_post=file.mode=="space"||file.mode=="post";args.is_snippet=file.mode=="snippet";args.preview=true;return new Handlebars.SafeString(TS.templates.file_header(args))});Handlebars.registerHelper("makeFileSize",function(file){return TS.utility.convertFilesize(file.size)+" "+file.pretty_type});Handlebars.registerHelper("formatSpaceHtml",function(html){function replace_emoji(root_node){if(root_node.childNodes){for(var i=0;i<root_node.childNodes.length;i++){replace_emoji(root_node.childNodes[i])}}if(root_node.nodeType==Node.TEXT_NODE){var safe_text_content=TS.utility.htmlEntities(root_node.textContent);var emojified_html=TS.emoji.graphicReplace(TS.emoji.replaceEmoticons(safe_text_content),{include_title:true,include_text:false});if(emojified_html!==safe_text_content){var emojified_node=$("<span>").html(emojified_html)[0];[].slice.apply(emojified_node.childNodes).forEach(function(new_node){root_node.parentNode.insertBefore(new_node,root_node)});root_node.parentNode.removeChild(root_node)}}}var $container=$("<div>").html(html);replace_emoji($container[0]);if(TS.client&&TS.client.ui){TS.client.ui.unfurlPlaceholders($container)}return new Handlebars.SafeString($container.html())});Handlebars.registerHelper("fileIsImage",function(options){var file=TS.files.getFileById(options.hash.id);if(!file)return options.inverse(this);if(file.mimetype&&file.mimetype.indexOf("image/")===0){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("mimeTypeIsImage",function(options){if(options.hash.type&&options.hash.type.indexOf("image/")===0){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("fileDefaultIsNewWindow",function(options){options=_optionsFnInverseBooleanHelper(options);var file=TS.files.getFileById(options.hash.id);if(!file)return options.inverse(this);var new_window_for_mimetype=file.mimetype&&file.mimetype.indexOf("image/")===0&&file.mimetype.indexOf("svg")===-1;var new_window_for_filetype=file.filetype==="pdf";if(new_window_for_mimetype||new_window_for_filetype){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("fileIconTypeDownload",function(){var args=Array.prototype.slice.call(arguments);var options=_optionsFnInverseBooleanHelper(args.pop());var file=args[0];if(typeof file==="string")file=TS.files.getFileById(file);if(!file)return options.inverse(this);var new_window_for_mode=file.mode==="external";var new_window_for_mimetype=file.mimetype&&file.mimetype.indexOf("image/")===0&&file.mimetype.indexOf("svg")===-1;var new_window_for_filetype=file.filetype==="pdf";if(new_window_for_mode||new_window_for_mimetype||new_window_for_filetype){return options.inverse(this)}else{return options.fn(this)}});Handlebars.registerHelper("nonImageCanUseFSFV",function(file,options){if(!file)return options.inverse(this);if(TS.boot_data.feature_pdf_viewer&&TS.model.pdf_viewer_enabled&&file.mode==="hosted"&&TS.files.fileIsPDF(file)&&file.size<=5e7)return options.fn(this);return options.inverse(this)});Handlebars.registerHelper("makeFilePrivacyLabel",function(file){var label="";if(file.is_public){label="Shared"}else{if(file.groups.length>0||file.ims.length>0){label="Private"}else{label="Draft"}}return label});Handlebars.registerHelper("makeExternalFiletypeHTML",function(file){return TS.templates.builders.makeExternalFiletypeHTML(file)});Handlebars.registerHelper("makeFileShareLabel",function(file){return new Handlebars.SafeString(TS.templates.builders.makeFileShareLabel(file))});Handlebars.registerHelper("makeFileGroupChannelList",function(file){return TS.templates.builders.makeFileGroupChannelList(file)});Handlebars.registerHelper("nl2brAndHighlightSearchMatches",function(text){if(!text)return;text=TS.utility.htmlEntities(text);text=text.replace(/\n/g,"<br />");return new Handlebars.SafeString(TS.utility.msgs.handleSearchHighlights(text))});Handlebars.registerHelper("maybeGetIconForTeamProfileField",function(label){var icons=["slack","apple","android","twitter","github","google","windows","youtube","skype","facebook","asana","linkedin","tumblr","instagram","soundcloud","flickr","pinterest","tripit","hangouts","viber","line"];label=label.toLowerCase();if(~icons.indexOf(label))return'<i class="ts_icon ts_icon_'+label+'"></i>'});Handlebars.registerHelper("getVisibleTeamProfileFieldsForMember",function(member){var fields=TS.team.getVisibleTeamProfileFieldsForMember(member);return TS.templates.team_profile_fields({fields:fields})});Handlebars.registerHelper("isSkypeTeamProfileField",function(field,options){if(field.type==="text"&&field.label.toLocaleLowerCase()==="skype"){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getSafeSkypeURLComponent",function(name){var match=name.match(/^[a-zA-Z][a-zA-Z0-9\.,\-_]{5,31}/);return match?match[0]:""});Handlebars.registerHelper("highlightSearchMatches",function(text){if(!text)return;text=TS.utility.htmlEntities(text);return TS.utility.msgs.handleSearchHighlights(text)});Handlebars.registerHelper("highlightSearchMatchesInSpacesHtml",function(html){if(!html)return;var formatted_html=Handlebars.helpers.formatSpaceHtml(html);return new Handlebars.SafeString(TS.utility.msgs.handleSearchHighlights(formatted_html))});Handlebars.registerHelper("highlightSearchMatchesInFileTitle",function(text){if(!text)return;text=TS.emoji.graphicReplace(text);return new Handlebars.SafeString(TS.utility.msgs.handleSearchHighlights(text))});Handlebars.registerHelper("searchFilter",function(){if(!TS.search.filter)return;return TS.search.filter});Handlebars.registerHelper("searchSort",function(){if(!TS.search.sort)return;return TS.search.sort});Handlebars.registerHelper("makeUnreadMessagesDomId",function(item){return TS.templates.makeUnreadMessagesDomId(item)});Handlebars.registerHelper("makeUnreadGroupMessagesDomId",function(item){return TS.templates.makeUnreadGroupMessagesDomId(item)});Handlebars.registerHelper("makeUnreadDmsDomId",function(item){return TS.templates.makeUnreadDmsDomId(item)});Handlebars.registerHelper("makeSentMessagesDomId",function(item){return TS.templates.makeSentMessagesDomId(item)});Handlebars.registerHelper("makeSentGroupMessagesDomId",function(item){return TS.templates.makeSentGroupMessagesDomId(item)});Handlebars.registerHelper("makeSentDmsDomId",function(item){return TS.templates.makeSentDmsDomId(item)});Handlebars.registerHelper("makeIssueListDomId",function(date_str){return TS.templates.makeIssueListDomId(date_str)});Handlebars.registerHelper("addIndefiniteArticle",function(word_str){if(typeof word_str!=="string"){return word_str}var vowels=["a","e","i","o","u"];var first_letter=word_str.charAt(0).toLowerCase();var starts_with_vowel=vowels.some(function(vowel){return first_letter===vowel});return starts_with_vowel?"an "+word_str:"a "+word_str});Handlebars.registerHelper("math",function(lvalue,operator,rvalue,options){if(arguments.length<4){options=rvalue;rvalue=operator;operator="+"}lvalue=parseFloat(lvalue);rvalue=parseFloat(rvalue);return{"+":lvalue+rvalue,"-":lvalue-rvalue,"*":lvalue*rvalue,"/":lvalue/rvalue,"%":lvalue%rvalue}[operator]});Handlebars.registerHelper("loadingHTML",function(){return new Handlebars.SafeString(TS.templates.builders.loadingHTML())});Handlebars.registerHelper("versioned_loading_animation",function(){return cdn_url+"/272a/img/loading.gif"});Handlebars.registerHelper("versioned_loading_hash_animation",function(){return cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"});Handlebars.registerHelper("versioned_mac_dock_badge",function(){return cdn_url+"/9135/img/prefs_mac_dock_badge@2x.png"});Handlebars.registerHelper("versioned_prefs_messages_clean",function(){return cdn_url+"/e5d8/img/prefs_messages_clean@2x.png"});Handlebars.registerHelper("versioned_prefs_messages_compact",function(){return cdn_url+"/e5d8/img/prefs_messages_compact@2x.png"});Handlebars.registerHelper("versioned_services_box_32",function(){return cdn_url+"/2fac/plugins/box/assets/service_32.png"});Handlebars.registerHelper("versioned_services_gdrive_16",function(){return cdn_url+"/66f9/img/services/gdrive_16.png"});Handlebars.registerHelper("versioned_services_onedrive_32",function(){return cdn_url+"/2fac/plugins/onedrive/assets/service_32.png"});Handlebars.registerHelper("versioned_slackbot_48",function(){return cdn_url+"/2fac/plugins/slackbot/assets/service_48.png"});Handlebars.registerHelper("versioned_slackbot_72",function(){return cdn_url+"/0180/img/slackbot_72.png"});Handlebars.registerHelper("versioned_theme_thumb_brinjal",function(){return cdn_url+"/d7a0/img/themes/brinjal@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_chocolate",function(){return cdn_url+"/d7a0/img/themes/chocolate@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_default",function(){return cdn_url+"/d7a0/img/themes/aubergine@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_hoth",function(){return cdn_url+"/d7a0/img/themes/hoth@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_monument",function(){return cdn_url+"/d7a0/img/themes/monument@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_ocean",function(){return cdn_url+"/d7a0/img/themes/ochin@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_solanum",function(){return cdn_url+"/d7a0/img/themes/solanum@2x.png"});Handlebars.registerHelper("versioned_theme_thumb_workhard",function(){return cdn_url+"/d7a0/img/themes/workhard@2x.png"});Handlebars.registerHelper("versioned_twitter_64",function(){return cdn_url+"/66f9/img/services/twitter_64.png"});Handlebars.registerHelper("versioned_upload_file_icon",function(res){if(res==="1x"){return cdn_url+"/a079/img/upload_file_icon.png"}else if(res==="2x"){return cdn_url+"/a079/img/upload_file_icon@2x.png"}});Handlebars.registerHelper("versioned_default_application_icon",function(){return cdn_url+"/ca27/img/apps/default_new_app_icon.png"});Handlebars.registerHelper("versioned_join_shared_channel",function(res){if(res==="1x"){return cdn_url+"/742c/img/join-channel/join_shared_channel.png"}else if(res==="2x"){return cdn_url+"/742c/img/join-channel/join_shared_channel@2x.png"}});Handlebars.registerHelper("versioned_join_team_channel",function(res){if(res==="1x"){return cdn_url+"/742c/img/join-channel/join_team_channel.png"}else if(res==="2x"){return cdn_url+"/742c/img/join-channel/join_team_channel@2x.png"}});Handlebars.registerHelper("versioned_slack_logo_240",function(){return cdn_url+"/66f9/img/slack_logo_240.png"});Handlebars.registerHelper("versioned_file_drop_blue",function(){return cdn_url+"/c3881/img/file-drop-blue@2x.png"});Handlebars.registerHelper("pinnedFileType",function(file){if(!file)return"file";if(file.mode==="space")return"post";if(file.mode==="snippet")return"text snippet";if(file.mode==="post")return"post";if(file.mode==="external"){var external_type=TS.templates.builders.makeExternalFiletypeHTML(file);if(external_type)return new Handlebars.SafeString(external_type)}return"file"});Handlebars.registerHelper("pinToLabel",function(model_ob){var text="";if(model_ob.is_channel)text+="#";if(model_ob.is_im||model_ob.is_mpim){text+="this conversation"}else{text+=TS.utility.htmlEntities(model_ob.name)}return new Handlebars.SafeString(text)});Handlebars.registerHelper("preventWidow",function(str){var words=str.split(" ");if(words.length>1){words[words.length-2]+="&nbsp;"+words[words.length-1];words.pop();str=words.join(" ")}return new Handlebars.SafeString(str)});Handlebars.registerHelper("seeAllPinsLink",function(model_ob){var channel_type="channel";if(model_ob.is_im||model_ob.is_mpim){channel_type="conversation"}return new Handlebars.SafeString(TS.templates.see_all_pins_link({channel_type:channel_type}))});Handlebars.registerHelper("numberWithCommas",function(num){return TS.utility.numberWithCommas(num)});Handlebars.registerHelper("makeModelObHotnessIconSafe",function(model_ob){var html='<div class="'+TS.templates.makeHotnessIconDomClasses(model_ob)+'" id="'+TS.templates.makeHotnessIconDomId(model_ob)+'">'+TS.emoji.graphicReplace(":fire:")+"</div>";return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeModelObMutedIconSafe",function(model_ob){if(!TS.boot_data.feature_sli_channel_priority)return"";if(model_ob.is_im)return"";var html='<a class="muted_icon" data-c-id="'+model_ob.id+'" id="'+TS.templates.makeMutedIconDomId(model_ob)+'"><ts-icon class="ts_icon_bell_slash"></ts-icon></a>';return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeModelObStarredIconSafe",function(model_ob){if(!TS.boot_data.feature_sli_channel_priority)return"";var html='<a class="starred_icon" data-c-id="'+model_ob.id+'" id="'+TS.templates.makeStarredIconDomId(model_ob)+'"><ts-icon class="ts_icon_star"></ts-icon></a>';return new Handlebars.SafeString(html)});Handlebars.registerHelper("makeModelObPriorityIconSafe",function(model_ob){if(!TS.boot_data.feature_sli_channel_priority)return"";if(!TS.model.prefs||!TS.model.channel_sort.priority_display)return"";if(!TS.client)return"";var priority=TS.client.channel_pane.getPriorityForModelOb(model_ob);if(!priority)return"";var priority_display=11-Math.ceil(priority*10);var html='<div class="priority_icon" id="'+TS.templates.makePriorityIconDomId(model_ob)+'">'+priority_display+"</div>";return new Handlebars.SafeString(html)});Handlebars.registerHelper("buildReplyBarHTML",function(msg,model_ob){return new Handlebars.SafeString(TS.templates.builders.buildReplyBarHTML(msg,model_ob))});Handlebars.registerHelper("makeSHRoomParticipantList",TS.templates.builders.makeSHRoomParticipantList);Handlebars.registerHelper("makeSHRoomSharedList",TS.templates.builders.makeSHRoomSharedList);Handlebars.registerHelper("raLabel",function(old_label){return TS.templates.builders.raLabel(old_label)});Handlebars.registerHelper("renderAttachmentActions",function(attachment,disable_buttons){return new Handlebars.SafeString(TS.templates.builders.buildAttachmentActions(attachment,disable_buttons))});Handlebars.registerHelper("renderAttachmentMedia",function(attachment,msg_dom_id){var html;var media_type=TS.utility.attachments.getMediaType(attachment);switch(media_type){case"other":if(attachment.other_html){html=TS.templates.builders.buildInlineOtherDiv(attachment.other_html,msg_dom_id,attachment.safe_other_html)}break;case"video":if(attachment.video_html&&attachment.thumb_url){var url=attachment.from_url||attachment.thumb_url;html=TS.templates.builders.buildInlineVideoDiv(url,msg_dom_id)}break;case"image":if(attachment.image_url){var url=attachment.from_url||attachment.image_url;var args={};args.flush_with_attachment=true;html=TS.templates.builders.buildInlineImgDiv(url,msg_dom_id,args)}break;case"audio":if(attachment.audio_html){html=TS.templates.builders.buildInlineAudioDiv(attachment.audio_html,msg_dom_id,attachment.safe_audio_html)}else if(attachment.audio_url){html=TS.templates.builders.formatSoundUrl(attachment)}break}if(html)return new Handlebars.SafeString(html)});Handlebars.registerHelper("getMemberTypeClass",TS.templates.builders.getMemberTypeClass);Handlebars.registerHelper("inlineSaver",function(args){var html=TS.templates.inline_saver({hide_text:args.hash.hide_text,target:args.hash.target});return new Handlebars.SafeString(html)});Handlebars.registerHelper("dangerouslyRenderHTML",function(html){return new Handlebars.SafeString(html)});Handlebars.registerHelper("attachmentMediaCaret",function(attachment,msg_dom_id){var caret_html="";var media_type=TS.utility.attachments.getMediaType(attachment);switch(media_type){case"video":var src=attachment.from_url||attachment.thumb_url;caret_html=TS.templates.builders.buildInlineVideoToggler(src,msg_dom_id,true);break;case"audio":var src=attachment.audio_html||attachment.audio_url;caret_html=TS.templates.builders.buildInlineAudioToggler(src,msg_dom_id);break;case"other":caret_html=TS.templates.builders.buildInlineOtherToggler(attachment.other_html,msg_dom_id);break;case"image":var src=attachment.from_url||attachment.image_url;caret_html=TS.templates.builders.buildInlineImgToggler(src,msg_dom_id,false);break;default:caret_html=TS.templates.builders.buildInlineAttachmentToggler(attachment.from_url,msg_dom_id);break}caret_html='<span class="media_caret">'+caret_html+"</span>";return new Handlebars.SafeString(caret_html)});Handlebars.registerHelper("isMsgReply",function(options){if(!TS.boot_data.feature_message_replies)return options.inverse(this);var msg=options.hash.msg;var is_reply=TS.utility.msgs.isMsgReply(msg);if(is_reply){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("constructConversationPermalink",function(model_ob,thread_ts){if(_.isString(model_ob))model_ob=TS.shared.getModelObById(model_ob);if(!model_ob)return"";if(!_.isString(thread_ts))return"";return TS.utility.msgs.constructConversationPermalink(model_ob,thread_ts)});Handlebars.registerHelper("literalNumbers",function(number,max_literal){var numbers=["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen","twenty"];max_literal=max_literal?max_literal:20;if(number>max_literal){return number}else{return numbers[number]}});Handlebars.registerHelper("buildMsgHTMLForThreadsView",function(msg,model_ob){var html=TS.client.ui.threads.buildThreadMsgHTML(msg,model_ob);return new Handlebars.SafeString(html)});Handlebars.registerHelper("commaSeparatedList",function(items_array,options){var conjunction=!options.hash.conjunction||!_.isString(options.hash.conjunction)?"and":options.hash.conjunction;var html;if(items_array.length>2){html=options.hash.bold_items?_(items_array).dropRight().map(TS.utility.enterprise.wrapWithStrongTags).join(", ")+", "+conjunction+" "+TS.utility.enterprise.wrapWithStrongTags(_.last(items_array)):_(items_array).dropRight().join(", ")+", "+conjunction+" "+_.last(items_array)}else if(items_array.length===2){html=options.hash.bold_items?TS.utility.enterprise.wrapWithStrongTags(items_array[0])+" "+conjunction+" "+TS.utility.enterprise.wrapWithStrongTags(items_array[1]):items_array[0]+" "+conjunction+" "+items_array[1]}else if(items_array.length===1){html=options.hash.bold_items?TS.utility.enterprise.wrapWithStrongTags(items_array[0]):items_array[0]}else{html=""}return new Handlebars.SafeString(html)})},test:function(){return{_optionsFnInverseBooleanHelper:_optionsFnInverseBooleanHelper,_inlineImgSrcForFile:_inlineImgSrcForFile}}});var _REGEX_CASH_DECIMAL_FORMATTING=/\.\d{1}$/;var _optionsFnInverseBooleanHelper=function(options){if(typeof options.fn!=="function"){options.fn=function(){return true}}if(typeof options.inverse!=="function"){options.inverse=function(){return false}}return options};var _inlineImgSrcForFile=function(file,max_image_size){if(typeof file==="string")file=TS.files.getFileById(file);if(!file)return false;if(!TS.files.fileIsImage(file))return false;if(!max_image_size)max_image_size=480;return TS.files.getThumbSrcForFile(file,{max_size:max_image_size})}})();(function(){"use strict";TS.registerModule("utility.date",{month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"],really_short_month_names:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],day_names:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ones_digit_names:["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],tens_digit_names:["twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],ones_digit_ordinal_names:["zeroth","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth","eleventh","twelveth"],toDateObject:function(ts){var date;if(ts&&typeof ts=="string"&&ts.indexOf("-")>-1){var A=ts.split("-");if(A.length>=3){date=new Date(A[0],A[1]-1,A[2])}else{date=new Date(0)}}else{var ts_string=(ts||"0").toString();if(ts_string.indexOf(".")!=-1){date=new Date(ts_string.split(".")[0]*1e3)}else{date=new Date(ts*1e3)}}return date},toTime:function(ts,ampm,seconds){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var minutes=date.getMinutes();var secs=date.getSeconds();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(minutes<10){minutes="0"+minutes}var secs_string="";if(seconds){if(secs<10){secs_string=":0"+secs}else{secs_string=":"+secs}}var formatted_time=hours+":"+minutes+secs_string;if(ampm&&!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toTimeDuration:function(seconds){var time=TS.utility.date.toTimeAmount(Math.floor(seconds/60));time.s=seconds%60;var str="";if(time.w){var week_str=time.w===1?" week ":" weeks ";str+=time.w+week_str}if(time.d){var day_str=time.d===1?" day ":" days ";str+=time.d+day_str}if(time.h){var hour_str=time.h===1?" hour ":" hours ";str+=time.h+hour_str}if(time.mi)str+=time.mi+" min ";if(time.s||str.length===0)str+=time.s+" sec ";str=str.trim();return str},toTimeAmount:function(minutes){var time={w:TS.utility.date.toWeekAmount(minutes),d:TS.utility.date.toDayAmount(minutes)-TS.utility.date.toWeekAmount(minutes)*7,h:TS.utility.date.toHourAmount(minutes)-TS.utility.date.toDayAmount(minutes)*24,mi:minutes%60};return time},toWeekAmount:function(minutes){return Math.floor(minutes/10080)},toDayAmount:function(minutes){return Math.floor(minutes/1440)},toHourAmount:function(minutes){return Math.floor(minutes/60)},toDate:function(ts,exclude_time){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(day<10){day="0"+day}if(minutes<10){minutes="0"+minutes}month=("0"+(month+1)).slice(-2);var formatted_time=year+"-"+month+"-"+day;if(exclude_time)return formatted_time;formatted_time+=", "+hours+":"+minutes;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toHumanReadableDateAndTime:function(ts){var relative_day=TS.utility.date.maybeGetRelativeDay(ts);if(relative_day){var include_ampm=true;var time=TS.utility.date.toTime(ts,include_ampm);
return relative_day+" at "+time}return TS.utility.date.toCalendarDateOrNamedDayShort(ts)},shouldExcludeYear:function(ts){var date=TS.utility.date.toDateObject(ts);var now=new Date;var a_month=31*24*60*60*1e3;return date.getFullYear()==now.getFullYear()||now-date<=a_month},toCalendarDateOrNamedDayShort:function(ts){var exclude_year=TS.utility.date.shouldExcludeYear(ts);return TS.utility.date.toCalendarDateOrNamedDay(ts,true,exclude_year)},do24hrTime:function(){if(TS.model.user&&TS.model.prefs&&TS.model.prefs.time24){return true}return false},toFilenameFriendlyDate:function(ts){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var pm=false;if(!TS.utility.date.do24hrTime()){if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}if(day<10){day="0"+day}if(hours<10){hours="0"+hours}if(minutes<10){minutes="0"+minutes}month=("0"+(month+1)).slice(-2);var formatted_time=year+"_"+month+"_"+day+" "+hours+"_"+minutes;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return formatted_time},toCalendarDate:function(ts,min,exclude_year,very_min,exclude_day){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var formatted_time;if(very_min){if(exclude_day){formatted_time=TS.utility.date.really_short_month_names[month]}else{formatted_time=TS.utility.date.really_short_month_names[month]+" "+day}}else if(min){if(exclude_day){formatted_time=TS.utility.date.short_month_names[month]}else{formatted_time=TS.utility.date.short_month_names[month]+" "+TS.utility.ordinalNumber(day)}}else{if(exclude_day){formatted_time=TS.utility.date.month_names[month]}else{formatted_time=TS.utility.date.month_names[month]+" "+TS.utility.ordinalNumber(day)}}if(!exclude_year&&!exclude_day)formatted_time+=", "+year;if(!exclude_year&&exclude_day)formatted_time+=" "+year;return formatted_time},maybeGetRelativeDay:function(ts){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);if(TS.utility.date.sameDay(date,today)){return"Today"}else if(TS.utility.date.sameDay(date,yesterday)){return"Yesterday"}},toCalendarDateOrNamedDay:function(ts,min,exclude_year){var formatted_time;var relative_day=TS.utility.date.maybeGetRelativeDay(ts);exclude_year=exclude_year||TS.utility.date.shouldExcludeYear(ts);if(relative_day){formatted_time=relative_day}else{formatted_time=TS.utility.date.toCalendarDate(ts,min,exclude_year)}return formatted_time},toCalendarDateIfYesterdayOrToday:function(ts,min){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);var formatted_time="";if(TS.utility.date.sameDay(date,today)){formatted_time=TS.utility.date.toCalendarDate(ts,min)}else if(TS.utility.date.sameDay(date,yesterday)){formatted_time=TS.utility.date.toCalendarDate(ts,min)}return formatted_time},toHour:function(ts){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var pm=false;if(TS.utility.date.do24hrTime()){if(hours<10){hours="0"+hours}}else{if(hours>=12){if(hours>12)hours=hours-12;pm=true}else if(hours===0){hours=12}}var formatted_time=hours;if(!TS.utility.date.do24hrTime()){if(pm){formatted_time+=" PM"}else{formatted_time+=" AM"}}return""+formatted_time},toDayOfTheWeek:function(ts){var date=TS.utility.date.toDateObject(ts);return TS.utility.date.day_names[date.getDay()]},toTimeAgo:function(ts){var date=TS.utility.date.toDateObject(ts);var today=new Date;var raw_seconds=TS.utility.date.distanceInSeconds(today,date);var is_future=raw_seconds<0;var seconds=Math.abs(raw_seconds);var minutes=seconds/60;var hours=minutes/60;var days=hours/24;var months=days/(365/12);var years=days/365;var output="",prefix="",suffix="";if(seconds<45){output="less than a minute"}else if(seconds<90){output="about a minute"}else if(minutes<45){output=Math.round(minutes)+" minutes"}else if(minutes<90){output="about an hour"}else if(hours<24){output="about "+Math.round(hours)+" hours"}else if(hours<42){output="a day"}else if(days<30){output=Math.round(days)+" days"}else if(days<45){output="about a month"}else if(days<365){output=Math.round(months)+" months"}else if(years<1.5){output="about a year"}else{output=Math.round(years)+" years"}is_future?prefix="in ":suffix=" ago";return prefix+output+suffix},timezoneLabel:function(member,include_local_time){var tz_label="Pacific Standard Time";var tz_offset=-28800;if(typeof member.tz_label!="undefined")tz_label=member.tz_label;if(typeof member.tz_offset!="undefined")tz_offset=member.tz_offset;var tz_label_html="<span title='"+tz_label+"'><i class='ts_icon ts_icon_clock_o'></i> ";if(member.id==TS.model.user.id){if(TS.client){tz_label_html+=tz_label+" (<a href='/account/settings' target='new'>change</a>)"}else{tz_label_html+=tz_label+" (<a href='/account/settings'>change</a>)"}}else{var hours_offset_from_user=(TS.model.user.tz_offset-tz_offset)/60/60;if(include_local_time){tz_label_html+=TS.utility.date.memberLocalTime(member)+" / "}if(hours_offset_from_user===0){tz_label_html+="in your timezone"}else{tz_label_html+=Math.abs(hours_offset_from_user)+" hour";if(Math.abs(hours_offset_from_user)!=1)tz_label_html+="s"}if(hours_offset_from_user>0){tz_label_html+=" behind you"}else if(hours_offset_from_user<0){tz_label_html+=" ahead of you"}tz_label_html+=" "+TS.utility.date.memberUTCOffset(member)}tz_label_html+="</span>";return tz_label_html},memberLocalTime:function(member,as_text){var date=new Date;var local_time;var tz_offset;var local_time_str;if(_has_Intl){var now=Date.now();try{if(_cache_date&&_cache_date>=now-3e4){local_time=_cache_local_time}else{var tz=member&&member.tz?member.tz:"America/Los_Angeles";var date_options={timeZone:tz,hour:"numeric",minute:"numeric",hour12:!TS.utility.date.do24hrTime()};local_time=Intl.DateTimeFormat.call(null,_page_lang,date_options).format(date);_cache_local_time=local_time;_cache_date=now}}catch(e){tz_offset=_memberTzOffset(member);local_time=_calculateLocalTime(date,tz_offset)}}else{if(_dst_offsets){tz_offset=member&&member.tz&&_.isObject(_dst_offsets[member.tz])?_dst_offsets[member.tz].tz_offset:_dst_offsets["America/Los_Angeles"].tz_offset;tz_offset=parseInt(tz_offset,10)}else{tz_offset=_memberTzOffset(member)}local_time=_calculateLocalTime(date,tz_offset)}if(as_text){local_time_str=local_time}else{local_time_str='<span class="timezone_value">'+local_time+"</span> local time"}return local_time_str},memberUTCOffset:function(member){var tz_offset=_memberTzOffset(member);var hours_offset_from_utc=tz_offset/60/60;var html="";if(hours_offset_from_utc===0){html+="(UTC)"}else if(hours_offset_from_utc<0){html+="(UTC"+hours_offset_from_utc+")"}else if(hours_offset_from_utc>0){html+="(UTC+"+hours_offset_from_utc+")"}return html},fake_ts_unique_padder:"x",makeTsStamp:function(d,padder,unique_num){d=d||Date.now();padder=padder||TS.utility.date.fake_ts_unique_padder;unique_num=unique_num===undefined||unique_num===null?_getNewFakeTsUniquePart():unique_num;var unixtime=Math.floor(d/1e3).toString();var unique_str=_.padStart(unique_num,6,padder);return unixtime+"."+unique_str},sameDay:function(date_a,date_b){return date_a.getFullYear()==date_b.getFullYear()&&date_a.getMonth()==date_b.getMonth()&&date_a.getDate()==date_b.getDate()},sameHour:function(date_a,date_b){return date_a.getFullYear()==date_b.getFullYear()&&date_a.getMonth()==date_b.getMonth()&&date_a.getDate()==date_b.getDate()&&date_a.getHours()==date_b.getHours()},distanceInSeconds:function(date_a,date_b){var diff_in_seconds=Math.round(date_a.getTime()/1e3)-Math.round(date_b.getTime()/1e3);return diff_in_seconds},distanceInMinutes:function(date_a,date_b){var diff_in_mins=TS.utility.date.distanceInSeconds(date_a,date_b)/60;return diff_in_mins},isToday:function(date_a){var today=new Date;return TS.utility.date.sameDay(date_a,today)},isYesterday:function(date_a){var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);return TS.utility.date.sameDay(date_a,yesterday)},getNextActivityDayStamp:function(day_stamp){var date=TS.utility.date.toDateObject(day_stamp);var next_date=new Date(date.getTime()+864e5);var new_stamp=next_date.getFullYear()+"-"+_.padStart(next_date.getMonth()+1,2,"0")+"-"+_.padStart(next_date.getDate(),2,"0");return new_stamp},getPrevActivityDayStamp:function(day_stamp){var date=TS.utility.date.toDateObject(day_stamp);var next_date=new Date(date.getTime()-864e5);var new_stamp=next_date.getFullYear()+"-"+_.padStart(next_date.getMonth()+1,2,"0")+"-"+_.padStart(next_date.getDate(),2,"0");return new_stamp},toTimeWords:function(ts,ampm,seconds){var date=TS.utility.date.toDateObject(ts);var hours=date.getHours();var minutes=date.getMinutes();var secs=date.getSeconds();var pm=hours>=12;var oclock=minutes===0;var hours_words="";var minutes_words="";var minutes_prefix="";var seconds_words="";var ampm_words="";if(oclock&&(secs===0||!seconds)){if(hours===0)return"midnight";if(hours===12)return"noon"}if(!TS.utility.date.do24hrTime()){if(hours>=12){hours=hours-12}else if(hours===0){hours=12}}hours_words=TS.utility.date.numberToWords(hours);if(oclock){if(hours>12&&TS.utility.date.do24hrTime()){hours_words+=" hundred"}else{hours_words+=" o'clock"}}if(minutes!==0){minutes_prefix=" ";if(minutes<10)minutes_prefix+="oh-";minutes_words=TS.utility.date.numberToWords(minutes)}if(seconds&&secs!==0)seconds_words=" and "+TS.utility.date.numberToWords(secs)+" second"+(secs===1?"":"s");if(ampm&&!TS.utility.date.do24hrTime()){ampm_words=pm?" PM":" AM"}if(TS.utility.date.do24hrTime()&&hours===0){return minutes_words+" minute"+(minutes===1?"":"s")+seconds_words+" past midnight"}return hours_words+minutes_prefix+minutes_words+seconds_words+ampm_words},toCalendarDateWords:function(ts,exclude_year){var date=TS.utility.date.toDateObject(ts);var year=date.getFullYear();var month=date.getMonth();var day=date.getDate();var day_words=TS.utility.date.numberToWords(day,true);var month_words=TS.utility.date.month_names[month];var year_words="";if(!exclude_year){year_words=", ";if(year%1e3===0){year_words+=TS.utility.date.numberToWords(year/1e3)+"-thousand"}else if(year%100===0){year_words+=TS.utility.date.numberToWords(year/100)+" hundred"}else if(year%1e3<10){year_words+=TS.utility.date.numberToWords((year-year%1e3)/1e3)+"-thousand and "+TS.utility.date.numberToWords(year%1e3)}else{year_words+=TS.utility.date.numberToWords((year-year%100)/100)+" "+(year%100<10?"oh-":"")+TS.utility.date.numberToWords(year%100)}}return month_words+" "+day_words+year_words},toCalendarDateOrNamedDayWords:function(ts,exclude_year){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date;yesterday.setDate(today.getDate()-1);var formatted_time;if(TS.utility.date.sameDay(date,today)){formatted_time="Today"}else if(TS.utility.date.sameDay(date,yesterday)){formatted_time="Yesterday"}else{formatted_time=TS.utility.date.toCalendarDateWords(ts,exclude_year)}return formatted_time},numberToWords:function(num,ordinal){var tens,ones,result="";if(ordinal){if(num<TS.utility.date.ones_digit_ordinal_names.length){result=TS.utility.date.ones_digit_ordinal_names[num]}else{tens=Math.floor(num/10);ones=num%10;if(num<TS.utility.date.ones_digit_names.length){result=TS.utility.date.ones_digit_names[num]+"th"}else if(tens<=9){if(ones===0){result=TS.utility.date.tens_digit_names[tens-2].replace(/y$/,"ieth")}else{result=TS.utility.date.tens_digit_names[tens-2];result+="-"+TS.utility.date.ones_digit_ordinal_names[ones]}}}}else{if(num<TS.utility.date.ones_digit_names.length){result=TS.utility.date.ones_digit_names[num]}else{tens=Math.floor(num/10);ones=num%10;if(tens<=9){result=TS.utility.date.tens_digit_names[tens-2];if(ones>0){result+="-"+TS.utility.date.ones_digit_names[ones]}}}}return result},formatDate:function(string,unix_time,fallback_string){var date_obj=new Date(unix_time*1e3);var today=new Date;var ts=TS.utility.date.makeTsStamp(date_obj);var distance_in_minutes=TS.utility.date.distanceInMinutes(date_obj,today);var exclude_year=distance_in_minutes>-182*24*60&&distance_in_minutes<182*24*60;var capitalize=false,invalid_token_found=false;if(!fallback_string)fallback_string=string;if(isNaN(date_obj.getTime()))return fallback_string;string=string.replace(/{(.*?)}/g,function(match,token){var replacement;switch(token){case"date_num":return TS.utility.date.toDate(ts,true);case"date_long":return TS.utility.date.toDayOfTheWeek(ts)+", "+TS.utility.date.toCalendarDate(ts,false,exclude_year);case"date_long_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toDayOfTheWeek(ts)+", "+TS.utility.date.toCalendarDate(ts,false,exclude_year));if(!capitalize&&string.indexOf("{date_long_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"date":return TS.utility.date.toCalendarDate(ts,false,exclude_year);case"date_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toCalendarDate(ts,false,exclude_year));if(!capitalize&&string.indexOf("{date_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"date_short":return TS.utility.date.toCalendarDate(ts,true,exclude_year,true);case"date_short_pretty":replacement=TS.utility.date.prettifyDateString(ts,TS.utility.date.toCalendarDate(ts,true,exclude_year,true));if(!capitalize&&string.indexOf("{date_short_pretty}")===0&&["today","yesterday","tomorrow"].indexOf(replacement)!==-1)capitalize=true;return replacement;case"time":return TS.utility.date.toTime(ts,true);case"time_secs":return TS.utility.date.toTime(ts,true,true);case"ago":replacement=TS.utility.date.toTimeAgo(ts);if(!capitalize&&string.indexOf("{ago}")===0)capitalize=true;return replacement;default:invalid_token_found=true;return""}});if(invalid_token_found)return fallback_string;if(capitalize)string=string.charAt(0).toUpperCase()+string.slice(1);return string},prettifyDateString:function(ts,fallback_date_string){var date=TS.utility.date.toDateObject(ts);var today=new Date;var yesterday=new Date((new Date).valueOf()-1e3*60*60*24);var tomorrow=new Date((new Date).valueOf()+1e3*60*60*24);if(TS.utility.date.sameDay(date,today))return"today";if(TS.utility.date.sameDay(date,yesterday))return"yesterday";if(TS.utility.date.sameDay(date,tomorrow))return"tomorrow";return fallback_date_string},millisecondsToPrettifiedTime:function(milliseconds){var s=Math.floor(milliseconds/1e3);var hours=Math.floor(s/3600);var minutes=Math.floor((s-hours*3600)/60);var seconds=s-hours*3600-minutes*60;var time="";if(hours!==0)time=hours+":";time+=minutes<10?"0"+minutes:String(minutes);time+=":";time+=seconds<10?"0"+seconds:String(seconds);return time},daysToYearsPretty:function(d){var days=parseInt(d);if(days<365&&days>1||days===0)return days+" days";if(days===1)return"1 day";var years,output="";if(days%365===0){years=days/365;days=0}else{years=Math.floor(days/365);days=days%365}output=years>1?years+" years":years+" year";if(days>1){output+=", "+days+" days"}else if(days===1){output+=", 1 day"}return output},test:function(){return{_getPageLanguage:_getPageLanguage,_has_Intl:_has_Intl}}});var _fake_ts_unique_incrementer=1;var _getPageLanguage=function(){return $("html").attr("lang")||"en-US"};var _page_lang=_page_lang?_page_lang:_getPageLanguage();var _has_Intl=false;var _dst_offsets=TS.boot_data.dst_offsets||null;var _cache_date;var _cache_local_time;var _memberTzOffset=function(member){var tz_offset=-28800;if(member&&member.tz_offset&&typeof member.tz_offset!=="undefined"||member.tz_offset===0){tz_offset=member.tz_offset}return tz_offset};var _getNewFakeTsUniquePart=function(){_fake_ts_unique_incrementer++;if(_fake_ts_unique_incrementer>=1e5)_fake_ts_unique_incrementer=1;return _fake_ts_unique_incrementer};var _calculateLocalTime=function(date,tz_offset){var utc=date.getTime()+date.getTimezoneOffset()*6e4;var member_date=new Date(utc+36e5*(tz_offset/3600));return TS.utility.date.toTime(member_date/1e3,!TS.utility.date.do24hrTime())}})();(function(){"use strict";TS.registerModule("utility.msgs",{automated_subtypes:["channel_join","channel_leave","channel_topic","channel_purpose","channel_archive","channel_unarchive","group_join","group_leave","group_topic","group_purpose","group_archive","group_unarchive","group_name","channel_name","play_sound","pinned_item","unpinned_item","sh_room_shared","sh_room_created","bot_enable","bot_disable","bot_add","bot_remove","reminder_add","reminder_delete"],file_subtypes:["file_comment","file_mention","file_share","file_upload"],allowed_embed_attributes:["class","name","id","src","width","oldwidth","height","oldheight","frameborder","title","scrolling","allowtransparency","allowfullscreen","oallowfullscreen","msallowfullscreen","webkitallowfullscreen","mozallowfullscreen","controls","autoplay","loop","muted","poster","preload","webkit-playsinline","type"],ephemeral_msgs_map:{},onStart:function(){},messageIncludesMember:function(member,msg){if(!member){TS.warn("messageIncludesMember: WTF no member?");return}if(!msg){TS.warn("messageIncludesMember: WTF no msg?");return}if(msg.user&&msg.user==member.id)return true;var txt=msg.text;var opts=TS.format.calculateOptions(msg,{});var tokens=TSF.getTokensArray($.trim(txt),opts.tsf_mode,{jumbomoji:!opts.no_jumbomoji});var item;for(var i=0,j=tokens.length;i<j;i++){item=tokens[i];if(item.indexOf("<")===0&&item.indexOf("<@")===0){var guts=item.replace(/<|>/g,"");var id=TS.utility.msgs.getMemberIdFromMemberMarkup(guts);if(id&&id==member.id)return true}}return false},allUnknownUsersInMessage:function(msg){var rtn=[];var txt=msg.text;var opts=TS.format.calculateOptions(msg,{});var A=TSF.getTokensArray($.trim(txt),opts.tsf_mode,{jumbomoji:!opts.no_jumbomoji});for(var i=0;i<A.length;i++){var item=A[i];if(item.indexOf("<")===0&&item.indexOf("<@")===0){var guts=item.replace(/<|>/g,"");var id=TS.utility.msgs.getMemberIdFromMemberMarkup(guts);var m=TS.members.getMemberById(id);if(!m)m=TS.members.getMemberByName(id);if(!m){if(rtn.indexOf(id)<0)rtn.push(id)}}}return rtn},appendMsg:function(msgs,msg){msgs.unshift(TS.utility.msgs.makeSureMsgObIsValid(msg))},setMsgs:function(model_ob,msgs){for(var i=0;i<msgs.length;i++){msgs[i]=TS.utility.msgs.makeSureMsgObIsValid(msgs[i])}TS.utility.msgs.sortMsgs(msgs);model_ob.msgs=msgs;return model_ob.msgs},spliceMsg:function(msgs,msg){var i=msgs.indexOf(msg);if(i>-1){msgs.splice(i,1)}},getNonTempMsgFromUserMatchingText:function(text,user_id,msgs){if(!text&&text!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.user!=user_id)continue;if(TS.utility.msgs.isTempMsg(msg))continue;if(msg.text==text)return msg}return null},getMsgByProp:function(name,value,msgs){if(!value&&value!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg[name]==value)return msg}return null},getEditableMsgByProp:function(name,value,msgs){if(!value&&value!==0)return null;var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.subtype&&msg.subtype!="me_message")continue;if(msg[name]==value)return msg}return null},sortMsgs:function(msgs){function compare(a,b){if(a.ts<b.ts)return 1;if(a.ts>b.ts)return-1;return 0}msgs.sort(compare)},isMsgRolledUp:function(msg){if(!msg._jl_rolled_up_in)return false;return msg._jl_rolled_up_in!==msg.ts},isMsgHidden:function(msg){if(msg.no_display)return true;if(TS.boot_data.feature_message_replies&&msg._hidden_reply)return true;return false},getPrevDisplayedMsg:function(ts,msgs){var msg;var return_next_displayable_msg=false;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(return_next_displayable_msg){if(!TS.utility.msgs.isMsgHidden(msg)&&!TS.utility.msgs.isMsgRolledUp(msg)){return msg}}else if(msg.ts==ts){return_next_displayable_msg=true}}return null},getDisplayedMsgs:function(msgs){var A=[];var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(!TS.utility.msgs.isMsgHidden(msg)&&!TS.utility.msgs.isMsgRolledUp(msg)){A.push(msg)}}return A},getDisplayedMsgAfterTS:function(ts,msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(msg.ts>ts){if(!TS.utility.msgs.isMsgHidden(msg)&&!TS.utility.msgs.isMsgRolledUp(msg)){return msg}}}return null},getDisplayedMsgBeforeTS:function(ts,msgs){var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(msg.ts<ts){if(!TS.utility.msgs.isMsgHidden(msg)&&!TS.utility.msgs.isMsgRolledUp(msg)){return msg}}}return null},getUnreadCountableMsgAfterTS:function(ts,msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(msg.ts>ts){if(TS.utility.msgs.msgCanCountAsUnread(msg)){return msg}}}return null},getMarkMsgTSForUnreadPoint:function(id,msgs,model_ob){var mark_msg_ts,prev_msg;if(model_ob.oldest_msg_ts&&id==model_ob.oldest_msg_ts){mark_msg_ts="0000000000.000000"}else{var prev_msg=TS.utility.msgs.getPrevDisplayedMsg(id,msgs)||TS.utility.msgs.getMsg(id,msgs);if(prev_msg)mark_msg_ts=prev_msg.ts}if(!mark_msg_ts)return null;while(mark_msg_ts&&!TS.utility.msgs.getUnreadCountableMsgAfterTS(mark_msg_ts,msgs)){prev_msg=TS.utility.msgs.getPrevDisplayedMsg(mark_msg_ts,msgs);if(prev_msg){mark_msg_ts=prev_msg.ts}else{mark_msg_ts=null}}if(!mark_msg_ts)return null;return mark_msg_ts},getMsg:function(id,msgs){if(!msgs)return null;return TS.utility.msgs.getMsgByProp("ts",id,msgs)},getMsgByRspId:function(rsp_id,msgs){if(!msgs)return null;return TS.utility.msgs.getMsgByProp("rsp_id",rsp_id,msgs)},canEditMsg:function(msg,model_ob){if(msg.user!==TS.model.user.id)return false;if(TS.utility.msgs.isAutomatedMsg(msg))return false;if(TS.utility.msgs.isFileMsg(msg))return false;if(msg&&msg.subtype==="reply_broadcast")return false;if(model_ob&&model_ob.is_self_im)return true;if(TS.model.team.prefs.msg_edit_window_mins>-1&&(Date.now()-TS.utility.date.toDateObject(msg.ts))/6e4>TS.model.team.prefs.msg_edit_window_mins){return false}return true},isAutomatedMsg:function(msg){return TS.utility.msgs.automated_subtypes.indexOf(msg.subtype)>=0},isFileMsg:function(msg){return msg&&TS.utility.msgs.file_subtypes.indexOf(msg.subtype)>=0},getMsgActions:function(msg,model_ob){if(!msg)return;model_ob=model_ob||TS.shared.getActiveModelOb();var actions={edit_msg:TS.utility.msgs.canEditMsg(msg,model_ob),delete_msg:true};var msg_belongs_to_user=false;if(msg.user==TS.model.user.id)msg_belongs_to_user=true;if(msg.file&&msg.file.mode==="email"){actions.open_original=true}if(!TS.model.team.prefs.allow_message_deletion){if(!TS.model.user.is_admin){actions.delete_msg=false}else if(TS.model.active_im_id){if(!msg_belongs_to_user&&msg.user!="USLACKBOT"&&msg.subtype!="bot_message"){actions.delete_msg=false}}}else{if(TS.model.active_im_id){if(!msg_belongs_to_user&&msg.user!="USLACKBOT"&&msg.subtype!="bot_message"){actions.delete_msg=false}}else if(!msg_belongs_to_user){if(!TS.model.user.is_admin){actions.delete_msg=false}}else if(TS.utility.msgs.isAutomatedMsg(msg)){if(!TS.model.user.is_admin&&msg.subtype!=="pinned_item"&&msg.subtype!=="sh_room_created"&&msg.subtype!=="sh_room_shared"){actions.delete_msg=false}}}if(msg.is_ephemeral){actions.delete_msg=true}else{if(TS.client&&msg.subtype!=="pinned_item"&&msg.subtype!=="unpinned_item"&&msg.subtype!=="sh_room_created"&&msg.subtype!=="sh_room_shared"){if(TS.pins.canUserPinHere(model_ob)){if(TS.pins.isMessagePinned(msg,model_ob)){actions.unpin_msg=true}else{actions.pin_msg=true}}}if(msg.subtype=="file_comment"){actions.add_file_comment_rxn=true}else if(TS.utility.msgs.isFileMsg(msg)){actions.add_file_rxn=true}else{var handy_rxns_dd=TS.rxns.getHandyRxnsDisplayDataByRxnKey(msg._rxn_key);actions.add_rxn=!handy_rxns_dd.restrict}if(TS.clipboard.canWriteText()){actions.copy_link=true}}if(TS.client)actions.mark_unread=true;if(TS.boot_data.feature_message_replies&&TS.replies&&TS.replies.isEnabled()){var is_root=!msg.thread_ts||msg.thread_ts==msg.ts;actions.jump_to_original=true;if(TS.replies.canReplyToMsg(model_ob,msg)){actions.reply=true}actions.jump_to_original=is_root;if(actions.mark_unread&&!is_root)actions.mark_unread=false}if(TS.boot_data.feature_reminders_v3){var allowed_subtypes=["bot_message","file_share","file_mention","file_comment","me_message"];if(!msg.is_ephemeral&&(!msg.subtype||allowed_subtypes.indexOf(msg.subtype)!==-1)){actions.remind_me=true}if(actions.jump_to_original||actions.copy_link||actions.mark_unread||actions.remind_me){actions.has_private_actions=true}if(actions.copy_link||actions.add_rxn||actions.add_file_rxn||actions.add_file_comment_rxn||actions.pin_msg||actions.unpin_msg){actions.has_public_actions=true}}if(!msg.is_ephemeral&&!TS.utility.msgs.isTempMsg(msg)){if(msg.subtype==="file_share"||msg.subtype==="file_mention"){actions.share_file=true}else{actions.share_message=!model_ob.is_archived||model_ob.is_channel}}return actions},validateMsg:function(id,msg,msgs){if(!msg.ts){TS.error("msg lacks a ts ("+id+")");TS.dir(0,msg);return false}if(TS.utility.msgs.getMsg(msg.ts,msgs)){TS.warn("msg "+msg.ts+" already exists! ("+id+")");TS.dir(0,msg);return false}return true},findMsg:function(ts,c_id){var model_ob=TS.shared.getModelObById(c_id);var msg=model_ob&&model_ob.msgs&&TS.utility.msgs.getMsg(ts,model_ob.msgs);if(msg)return msg;msg=model_ob&&model_ob._archive_msgs&&TS.utility.msgs.getMsg(ts,model_ob._archive_msgs);if(msg)return msg;if(TS.boot_data.feature_message_replies&&TS.ui.replies){msg=model_ob&&TS.ui.replies.getActiveMessage(model_ob,ts);if(msg)return msg}if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing){msg=TS.client.threads.getMessage(model_ob,ts);if(msg)return msg}if(!msg&&TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){msg=TS.client.unread.getMessage(model_ob,ts);if(msg)return msg}var mention=TS.mentions.getMentionByMsgId(ts);if(mention)return mention.message;return null},replaceMsg:function(model_ob,new_msg,might_not_exist){var original_msg=TS.utility.msgs.getMsg(new_msg.ts,model_ob.msgs);if(!original_msg&&model_ob._archive_msgs){original_msg=TS.utility.msgs.getMsg(new_msg.ts,model_ob._archive_msgs)}if(TS.boot_data.feature_message_replies&&!original_msg&&TS.ui.replies){original_msg=TS.ui.replies.getActiveMessage(model_ob,new_msg.ts)}if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing&&!original_msg){original_msg=TS.client.threads.getMessage(model_ob,new_msg.ts)}if(TS.boot_data.feature_unread_view&&!original_msg){original_msg=TS.client.unread.getMessage(model_ob,new_msg.ts)}if(!original_msg){if(!might_not_exist)TS.error("unknown msg:"+new_msg.ts+" in "+model_ob.id);return}new_msg._rxn_key=original_msg._rxn_key;if(!new_msg.pinned_to){new_msg.pinned_to=original_msg.pinned_to}if(!("is_starred"in new_msg)){new_msg.is_starred=original_msg.is_starred}var comment=null;if(new_msg.comment&&new_msg.file){var file=TS.files.getFileById(new_msg.file.id);if(file){TS.files.editCommentOnFile(new_msg.comment,file);comment=TS.files.getFileCommentById(file,new_msg.comment.id)}}new_msg=TS.utility.msgs.processImsg(new_msg,model_ob.id);if(comment)new_msg.comment=comment;var changed_keys=_.union(Object.keys(new_msg),Object.keys(original_msg)).filter(function(key){return new_msg[key]!=original_msg[key]});if(!changed_keys.length){TS.info("Not signalling message change because it doesn't look like anything has changed for "+new_msg.ts+" in "+model_ob.id);return}if(new_msg._handy_rxns_poll_data){TS.rxns.clearHandyRxnsDisplayDataCache()}var k;for(k in original_msg){delete original_msg[k]}for(k in new_msg){original_msg[k]=new_msg[k]}if(TS.boot_data.feature_message_replies){if(model_ob.is_channel){TS.channels.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_im){TS.ims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_group&&model_ob.is_mpim){TS.mpims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.groups.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}}else{if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,original_msg,changed_keys)}}},removeEphemeralMsg:function(c_id,ephemeral_msg_ts){var model_ob=TS.groups.getGroupById(c_id)||TS.channels.getChannelById(c_id);if(!model_ob)return;if(model_ob.is_channel){TS.channels.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}else if(model_ob.is_mpim){TS.mpims.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}else if(model_ob.is_group){TS.groups.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}},getMemberFromMemberMarkup:function(match){var id=TS.utility.msgs.getMemberIdFromMemberMarkup(match);var m=TS.members.getMemberById(id);if(!m)m=TS.members.getMemberByName(id);return m},getMemberIdFromMemberMarkup:function(match){var id=match.substr(1);if(id)id=id.split("|")[0];return id},makeSureMsgObIsValid:function(ob){return ob},api_url_prefix:"api::",doApiUrl:function(url){if(!TS.client){alert("This link will not work in the archives.");return}url=url.replace(TS.utility.msgs.api_url_prefix,"");var A=url.split("?");var method=A[0];var args={};if(A.length>1){var pairs=A[1].split("&");for(var i=0;i<pairs.length;i++){var p=pairs[i].indexOf("=");if(p!=-1){var name=pairs[i].substring(0,p);var value=pairs[i].substring(p+1);args[name]=unescape(value)}}}TS.api.call(method,args)},new_api_url_prefix:"slack-action://",doNewApiUrl:function(url){if(!TS.client){alert("This link will not work in the archives.");return}var parts=url.replace(TS.utility.msgs.new_api_url_prefix,"").split("/");var bot=parts.shift();var payload=parts.join("/");TS.api.call("chat.action",{bot:bot,payload:decodeURIComponent(payload)})},getHighlightWordsRegex:function(){if(!TS.model.highlight_words_regex){TS.utility.msgs.makeHighlightWordsRegex()}return TS.model.highlight_words_regex},makeHighlightWordsRegex:function(){var word;var words=[];for(var i=0;i<TS.model.highlight_words.length;i++){word=TS.format.swapOutAts(TS.model.highlight_words[i]);word=TS.utility.regexpEscape(word);if(word=="don")word+="(?![']t)";words.push(word)}TS.model.highlight_words_regex=new RegExp("(\\b|_|\\s|^)("+words.join("|")+")(\\b|_|\\s|$)","i")},msgContainsMention:function(msg,ignore_at_here_mentions){var highlight_rx=TS.utility.msgs.getHighlightWordsRegex();var dont_check_highlight_words=msg.subtype=="bot_message";function check(txt){if(!txt)return false;if(TS.model.you_regex.test(txt))return true;if(TS.model.here_regex.test(txt)&&!ignore_at_here_mentions)return true;if(TS.model.everyone_regex.test(txt))return true;if(TS.model.channel_regex.test(txt))return true;if(TS.model.group_regex.test(txt))return true;for(var k in TS.model.your_user_group_regex){if(TS.model.your_user_group_regex[k].test(txt)){return true}}if(dont_check_highlight_words)return false;txt=txt.replace(/<\!subteam\^(\w+\d+)\|@(.+)>/g,"");txt=TS.format.swapOutAts(txt);if(highlight_rx.test(txt))return true;return false}if(msg.subtype=="pinned_item")return false;if(!msg.ignore_if_attachments_supported&&check(msg.text))return true;var attachment;var field;if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(attachment.from_url)continue;if(check(attachment.title))return true;if(check(attachment.pretext))return true;if(check(attachment.text))return true;if(check(attachment.footer))return true;if(!attachment.fields||!attachment.fields.length)continue;for(var m=0;m<attachment.fields.length;m++){field=attachment.fields[m];if(check(field.value))return true}}}return false},getMsgMentionData:function(msg){var ret={mentions:false,non_channel_mentions:false};var highlight_rx=TS.utility.msgs.getHighlightWordsRegex();
var dont_check_highlight_words=msg.subtype=="bot_message";function check(txt){if(checkNonChannelMentions(txt)){ret.non_channel_mentions=true;ret.mentions=true;return true}if(checkChannelMentions(txt)){ret.mentions=true}return false}function checkNonChannelMentions(txt){if(!txt)return false;if(TS.model.you_regex.test(txt))return true;if(dont_check_highlight_words)return false;txt=TS.format.swapOutAts(txt);if(highlight_rx.test(txt))return true;return false}function checkChannelMentions(txt){if(!txt)return false;if(TS.model.everyone_regex.test(txt))return true;if(TS.model.channel_regex.test(txt))return true;if(TS.model.group_regex.test(txt))return true;return false}if(!msg.ignore_if_attachments_supported&&check(msg.text))return ret;var attachment;var field;if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(attachment.from_url)continue;if(check(attachment.title))return ret;if(check(attachment.pretext))return ret;if(check(attachment.text))return ret;if(check(attachment.footer))return ret;if(!attachment.fields||!attachment.fields.length)continue;for(var m=0;m<attachment.fields.length;m++){field=attachment.fields[m];if(check(field.value))return ret}}}return ret},msgCanCountAsUnread:function(msg){if(TS.utility.msgs.isMsgHidden(msg))return false;if(msg.subtype=="channel_join"&&msg.inviter&&msg.user==TS.model.user.id)return true;if(msg.subtype=="group_join"&&msg.inviter&&msg.user==TS.model.user.id)return true;if(msg.user==TS.model.user.id)return false;if(msg.subtype=="channel_join")return false;if(msg.subtype=="channel_leave")return false;if(msg.subtype=="group_join")return false;if(msg.subtype=="group_leave")return false;if(msg.subtype=="mpim_notify_disabled")return false;if(msg.comment&&msg.comment.user==TS.model.user.id)return false;if(msg.dnd_suppressed)return false;return true},countAllUnreads:function(){if(_is_in_bulk_unread_calc_mode)return;TS.model.all_unread_highlights_cnt=0;TS.model.all_unread_cnt=0;TS.model.all_unread_cnt_to_exclude=0;TS.model.all_unread_highlights_cnt_to_exclude=0;var i;var im;var channel;var group;var mpim;var unread;var highlight;var channels=TS.channels.getChannelsForUser();for(i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived&&!channel.was_archived_this_session||TS.notifs.isCorGMuted(channel.id))continue;unread=parseInt(channel.unread_cnt,10)||0;highlight=parseInt(channel.unread_highlight_cnt,10)||0;TS.model.all_unread_cnt+=unread;TS.model.all_unread_highlights_cnt+=highlight;TS.utility.msgs.maybeExcludeUnreads(channel,unread,highlight)}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived&&!group.was_archived_this_session||TS.notifs.isCorGMuted(group.id))continue;unread=parseInt(group.unread_cnt,10)||0;highlight=parseInt(group.unread_highlight_cnt,10)||0;TS.model.all_unread_cnt+=unread;TS.model.all_unread_highlights_cnt+=highlight;TS.utility.msgs.maybeExcludeUnreads(group,unread,highlight)}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];unread=parseInt(im.unread_cnt,10)||0;highlight=parseInt(im.unread_cnt,10)||0;TS.model.all_unread_cnt+=unread;TS.model.all_unread_highlights_cnt+=highlight;TS.utility.msgs.maybeExcludeUnreads(im,unread,highlight)}for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];unread=parseInt(mpim.unread_cnt,10)||0;highlight=parseInt(mpim.unread_cnt,10)||0;TS.model.all_unread_cnt+=unread;TS.model.all_unread_highlights_cnt+=highlight;TS.utility.msgs.maybeExcludeUnreads(mpim,unread,highlight)}},maybeExcludeUnreads:function(model_ob,unread_cnt,highlight_cnt){if(!model_ob)return;if(!unread_cnt&&!highlight_cnt)return;if(!TS.shared.isSharedModelOb(model_ob))return;if(!TS.shared.isRelevantTeamForSharedModelOb(model_ob)){if(TS.pri)TS.log(67,"Excluding unread of "+unread_cnt+" and highlight of "+highlight_cnt+" for shared channel #"+model_ob.name+" because this is NOT the relevant team.");TS.model.all_unread_cnt_to_exclude+=unread_cnt;TS.model.all_unread_highlights_cnt_to_exclude+=highlight_cnt}else{if(TS.pri)TS.log(67,"Using unread of "+unread_cnt+" and highlight of "+highlight_cnt+" for shared channel #"+model_ob.name+" because this IS the relevant team.")}},doesMsgHaveRxnFromUser:function(msg,name){return TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(msg._rxn_key),name)},doesMsgHaveRxn:function(msg,name){return TS.rxns.doesRxnsHaveRxn(TS.rxns.getExistingRxnsByKey(msg._rxn_key),name)},recordEmojiInHash:function(str,hash){if(!str)return false;if(!hash)return false;var unique=true;var A=TS.utility.findAllTeamEmojiInStr(str,unique);if(!A.length)return false;var added=false;var name;for(var i=0;i<A.length;i++){name=TS.emoji.isValidName(A[i]);if(!name){TS.error(A[i]+" invalid");continue}if(!parseInt(hash[name])){hash[name]=0}hash[name]++;added=true}return added},populateEmojiUsePrefFromExistingMsgs:function(){if(TS.boot_data.feature_server_side_emoji_counts)return;TS.model.emoji_use={};TS.utility.msgs.countAllExistingEmoji(TS.shared.getAllModelObsForUser(),TS.model.emoji_use,TS.model.user.id,{});TS.dir(888,TS.model.emoji_use,"TS.model.emoji_use is now:");TS.api.callFuncWhenApiQisEmpty(TS.prefs.saveEmojiUse)},populateEmojiUsePrefFromAllHistory:function(){TS.model.emoji_use={};var user_id=TS.model.user.id;var after_ts=TS.utility.date.makeTsStamp(TS.model.user.created*1e3);var deduper_map={};var model_ob_deduper_map={};var total_count=0;var per_user_count=0;var per_model_ob_count=0;var model_ob_count=0;var getModelOb=function(){per_model_ob_count=0;model_ob_count++;var model_obs=TS.shared.getAllModelObsForUser();for(var i=0;i<model_obs.length;i++){if(model_ob_deduper_map[model_obs[i].id])continue;model_ob_deduper_map[model_obs[i].id]=true;return model_obs[i]}return null};var getHistoryInABit=function(model_ob,latest){setTimeout(getHistory,parseInt(TS.qs_args.delay)||3e3,model_ob,latest)};var getHistory=function(model_ob,latest){if(!model_ob){TS.log(888,"done getting all messages");return}TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),{channel:model_ob.id,count:1e3,latest:latest||""},function(ok,data,args){if(!ok||!data||!data.messages){TS.error("failed to get history");getHistoryInABit(getModelOb());return}if(window.stahp){TS.error("stahp");return}data.messages.forEach(function(msg){total_count++;per_model_ob_count++;if(user_id&&msg.user!=user_id)return;var id=model_ob.id+"_"+msg.ts;if(deduper_map){if(deduper_map[id])return;deduper_map[id]=true}TS.prefs.recordEmojiUse(msg.text);per_user_count++});TS.log(888,"getHistory ["+model_ob_count+" of "+TS.shared.getAllModelObsForUser().length+"] "+model_ob.name+" model_ob:"+per_model_ob_count+" total:"+total_count+" user:"+per_user_count);if(!data.messages.length){TS.error("no data.messages? so moving on");getHistoryInABit(getModelOb())}else{var oldest_ts=data.messages[data.messages.length-1].ts;if(oldest_ts<after_ts){TS.log(888,"oldest_ts:"+oldest_ts+" < after_ts:"+after_ts+" so moving on");getHistoryInABit(getModelOb())}else if(data.has_more){getHistoryInABit(model_ob,oldest_ts)}else{getHistoryInABit(getModelOb())}}})};getHistoryInABit(getModelOb())},countAllExistingEmoji:function(model_obs,hash,member_id,deduper_map){model_obs=model_obs||TS.channels.getChannelsForUser();hash=hash||{};model_obs.forEach(function(model_ob){if(!model_ob.msgs)return;model_ob.msgs.forEach(function(msg){var id=model_ob.id+"_"+msg.ts;if(deduper_map){if(deduper_map[id])return;deduper_map[id]=true}var rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(rxns){rxns.forEach(function(rxn){if(member_id&&TS.rxns.doesRxnsHaveRxnFromMember(rxns,rxn.name,member_id))return;TS.utility.msgs.recordEmojiInHash(rxn.name,hash)})}if(member_id&&msg.user!=member_id)return;TS.utility.msgs.recordEmojiInHash(msg.text,hash)})});return hash},reCalcAndCountSomeUnreads:function(c_ids){if(!c_ids||!c_ids.length)return;var i;var controller;var model_ob;for(i=0;i<c_ids.length;i++){model_ob=TS.shared.getModelObById(c_ids[i]);if(!model_ob){TS.warn("reCalcAndCountSomeUnreads: WTF no model_ob for id "+c_ids[i]);continue}controller=TS.shared.getControllerForModelOb(model_ob);if(!controller){TS.warn("reCalcAndCountSomeUnreads: WTF no controller for model_ob.id "+model_ob.id);continue}if(!controller.calcUnreadCnts){TS.warn("reCalcAndCountSomeUnreads: WTF no calcUnreadCnts on controller for model_ob.id "+model_ob.id);continue}controller.calcUnreadCnts(model_ob)}},reCalcAndCountAllUnreads:function(){var i;var im;var mpim;var channel;var group;var channels=TS.channels.getChannelsForUser();var defer_api_check=true;TS.utility.msgs.startBatchUnreadCalc();for(i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived&&!channel.was_archived_this_session)continue;if(defer_api_check&&channel._did_defer_initial_msg_history)delete channel._did_defer_initial_msg_history;TS.channels.calcUnreadCnts(channel)}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.is_archived&&!group.was_archived_this_session)continue;if(defer_api_check&&group._did_defer_initial_msg_history)delete group._did_defer_initial_msg_history;TS.groups.calcUnreadCnts(group)}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(defer_api_check&&im._did_defer_initial_msg_history)delete im._did_defer_initial_msg_history;TS.ims.calcUnreadCnts(im)}for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(defer_api_check&&mpim._did_defer_initial_msg_history)delete mpim._did_defer_initial_msg_history;TS.mpims.calcUnreadCnts(mpim)}TS.utility.msgs.finishBatchUnreadCalc()},startBatchUnreadCalc:function(){if(TS.qs_args["unread_batch"]=="0")return;_is_in_bulk_unread_calc_mode=true},finishBatchUnreadCalc:function(){_is_in_bulk_unread_calc_mode=false;TS.utility.msgs.countAllUnreads()},whatisunread:function(){var i;var im;var mpim;var channel;var group;var A=[];for(i=0;i<TS.model.channels.length;i++){channel=TS.model.channels[i];if(channel.unread_cnt)A.push("C:"+channel.name+" "+channel.unread_cnt)}for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.unread_cnt)A.push("G:"+group.name+" "+group.unread_cnt)}for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.unread_cnt)A.push("D:"+im.name+" "+im.unread_cnt)}for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(mpim.unread_cnt)A.push("G:"+mpim.name+" "+mpim.unread_cnt)}TS.info("unreads: "+A.join(","))},maybeSetOldestMsgsTsAfterMsgAdded:function(model_ob){if(model_ob.oldest_msg_ts)return;if(model_ob.latest)return;TS.utility.msgs.setOldestMsgsTs(model_ob)},setOldestMsgsTs:function(model_ob){var oldest_valid_ts=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(oldest_valid_ts){model_ob.oldest_msg_ts=oldest_valid_ts;TS.storage.storeOldestTs(model_ob.id,model_ob.oldest_msg_ts);if(model_ob._latest_via_users_counts)delete model_ob._latest_via_users_counts}},resetOldestMsgsTs:function(model_ob){model_ob.oldest_msg_ts=null;TS.storage.storeOldestTs(model_ob.id,null)},getOlderMsgsStatus:function(model_ob){var msgs=model_ob.msgs;var oldest_msg_ts=model_ob.oldest_msg_ts;var latest_msg_ts=TS.shared.getLatestMsgTs(model_ob)||null;var have_oldest_msg=false;var text="ERROR";var can_fetch_more=false;var code=0;if(oldest_msg_ts&&TS.utility.msgs.getMsg(oldest_msg_ts,msgs)){have_oldest_msg=true}if(!latest_msg_ts){if(msgs.length){can_fetch_more=false;code=1;text="There are NOT older messages than these."}else{can_fetch_more=false;code=2;text="THIS IS A BRAND NEW CHANNEL SAY SOMETHING"}}else{if(have_oldest_msg||model_ob.is_limited){can_fetch_more=false;code=3;text="We have the oldest msg: "+oldest_msg_ts+". is_limited:"+model_ob.is_limited}else{can_fetch_more=true;code=4;if(oldest_msg_ts){text="There are older messages than these. oldest_msg_ts: "+oldest_msg_ts}else{text="There are older messages than these. oldest_msg_ts: unknown"}}}return{text:text,more:can_fetch_more,code:code,is_limited:model_ob.is_limited}},getMostRecentValidTs:function(model_ob){if(!model_ob)return null;var msg;var msgs=model_ob.msgs||[];for(var i=0;i<msgs.length;i++){msg=msgs[i];if(!TS.utility.msgs.isTempMsg(msg))return msg.ts}return TS.shared.getLatestMsgTs(model_ob)||null},getOldestValidTs:function(msgs){var msg;for(var i=msgs.length-1;i>-1;i--){msg=msgs[i];if(!TS.utility.msgs.isTempMsg(msg)){return msg.ts}}return null},getHistoryFetchJobKey:function(latest,oldest){var key=latest;if(oldest){key+="_"+oldest}return key},processImsg:function(imsg,c_id){TS.utility.msgs._slurpExtraData(imsg,c_id);return TS.utility.msgs._makeInternalMsgObject(imsg,c_id)},processImsgFromHistory:function(imsg,c_id){var msg=TS.utility.msgs.processImsg(imsg,c_id);imsg.channel=c_id;if(imsg.subtype=="message_deleted"){TS.ms.msg_handlers.subtype__message_deleted(imsg)}else if(imsg.subtype=="message_changed"){TS.ms.msg_handlers.subtype__message_changed(imsg)}return msg},_makeInternalMsgObject:function(imsg,c_id){var new_msg={type:"message",ts:imsg.ts};if(imsg.user==="USLACKBOT"&&imsg.slackbot_feels){new_msg.slackbot_feels=imsg.slackbot_feels}if(TS.boot_data.feature_message_replies&&imsg.thread_ts){new_msg.thread_ts=imsg.thread_ts;if(imsg.parent_ts)new_msg.parent_ts=imsg.parent_ts;if(imsg.parent_user_id)new_msg.parent_user_id=imsg.parent_user_id;if(imsg.hasOwnProperty("reply_count")){new_msg.reply_count=parseInt(imsg.reply_count,10)}if(imsg.thread_ts!==imsg.ts){new_msg._hidden_reply=true}}if(TS.boot_data.feature_message_replies){if(imsg.replies)new_msg.replies=imsg.replies;if(imsg.hasOwnProperty("subscribed"))new_msg._subscribed=imsg.subscribed;if(imsg.hasOwnProperty("unread_count"))new_msg._unread_count=imsg.unread_count;if(imsg.last_read)new_msg._last_read=imsg.last_read;if(imsg.subtype==="tombstone"&&imsg.hidden&&imsg.replies&&imsg.replies.length>0)delete imsg.hidden}if(imsg.type=="channel_topic"||imsg.type=="channel_purpose"||imsg.type=="channel_join"||imsg.type=="channel_leave"){imsg.subtype=imsg.type}if(imsg.subtype=="group_join"||imsg.subtype=="group_purpose"||imsg.subtype=="group_topic"){var model_ob=TS.shared.getModelObById(c_id);if(model_ob&&model_ob.is_mpim){new_msg.no_display=true}}if(imsg.inviter){new_msg.inviter=imsg.inviter}if(imsg.hidden){new_msg.hidden=imsg.hidden}if(imsg.no_notifications){new_msg.no_notifications=imsg.no_notifications}if(imsg.ignore_if_attachments_supported){new_msg.ignore_if_attachments_supported=imsg.ignore_if_attachments_supported}if(imsg.hidden||imsg.no_display){new_msg.no_display=true}if(imsg.ignore_if_attachments_supported&&(!imsg.attachments||!imsg.attachments.length)){new_msg.no_display=true}if(imsg.edited){new_msg.edited=imsg.edited}if(imsg.user){new_msg.user=imsg.user}if(imsg.attachments){new_msg.attachments=imsg.attachments}if(imsg.img_vids){new_msg.img_vids=imsg.img_vids}var url;if(imsg.imgs){new_msg.img_vids=new_msg.img_vids||{};var img;for(url in imsg.imgs){if(new_msg.img_vids[url])continue;img=imsg.imgs[url];img.img_vid_type="img";new_msg.img_vids[url]=img}}if(imsg.videos){new_msg.img_vids=new_msg.img_vids||{};var video;for(url in imsg.videos){if(new_msg.img_vids[url])continue;video=imsg.videos[url];video.img_vid_type="video";new_msg.img_vids[url]=video}}if(imsg.icons){new_msg.icons=imsg.icons}if(imsg.bot_id){new_msg.bot_id=imsg.bot_id}if(imsg.is_ephemeral){new_msg.is_ephemeral=imsg.is_ephemeral}if(imsg._alert_even_though_temp){new_msg._alert_even_though_temp=imsg._alert_even_though_temp}if(imsg.is_starred){new_msg.is_starred=imsg.is_starred}if(imsg.reactions){delete imsg.reactions}if(imsg._rxn_key){new_msg._rxn_key=imsg._rxn_key}if(imsg.pinned_to){new_msg.pinned_to=imsg.pinned_to}if(imsg.topic){new_msg.topic=imsg.topic}if(imsg.name){new_msg.name=imsg.name}if(imsg.old_name){new_msg.old_name=imsg.old_name}if(imsg.purpose){new_msg.purpose=imsg.purpose}if(imsg.text){if(_.isString(imsg.text)){new_msg.text=imsg.text}else{TS.error("ERROR: invalid imsg.text type: "+typeof imsg.text+" "+TS.utility.stringifyJSONOrElse(imsg.text,null,2,"(and it is not JSON.stringifiable)"))}}if(imsg.sound){new_msg.sound=imsg.sound}if("mrkdwn"in imsg){new_msg.mrkdwn=!!imsg.mrkdwn}if("hex_swatches"in imsg){new_msg.hex_swatches=!!imsg.hex_swatches}if(imsg.dnd_suppressed){new_msg.dnd_suppressed=imsg.dnd_suppressed}if(imsg.recap){new_msg.recap=imsg.recap}TS.ui.handy_rxns.decorateMsg(new_msg,imsg.text);if(imsg.subtype){new_msg.subtype=imsg.subtype;if(new_msg.subtype=="bot_message"){if(imsg.username){new_msg.username=imsg.username}}if(imsg.subtype=="sh_room_created"||imsg.subtype=="sh_room_shared"){if(imsg._room_id){new_msg._room_id=imsg._room_id}else if(imsg.room){var room=TS.rooms.getRoomById(imsg.room.id);if(room){new_msg._room_id=room.id}else{TS.error("no room, no_display = true "+new_msg.ts);new_msg.no_display=true}}else{new_msg.no_display=true}}if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"||imsg.subtype=="file_comment"){if(imsg.upload){new_msg.upload=true}if(imsg.file){var file=TS.files.getFileById(imsg.file.id);if(file){new_msg.file=file}else{TS.error("no file, no_display = true "+new_msg.ts);new_msg.no_display=true}}else{new_msg.no_display=true}if(imsg.subtype=="file_comment"){if(imsg.comment){if(new_msg.file){new_msg.comment=TS.files.addCommentToFile(imsg.comment,new_msg.file)}else{new_msg.comment=imsg.comment}}else{new_msg.no_display=true}}}if(imsg.subtype==="pinned_item"){if(imsg.item_type)new_msg.item_type=imsg.item_type;if(imsg.item_type==="F"){if(imsg.item){var file_item=TS.files.getFileById(imsg.item.id);new_msg.item=file_item}}else if(imsg.item_type==="Fc"||imsg.item_type==="C"||imsg.item_type==="G"||imsg.item_type==="D"){new_msg.item=imsg.item}else{new_msg.no_display=true}if(TS.boot_data.feature_pin_update)new_msg.no_display=true}}return new_msg},maybeFetchUserDataFromLS:function(model_ob){if(!model_ob){TS.warn("maybeFetchUserDataFromLS: WTF no model_ob?");return}if(model_ob._fetched_user_data_from_ls)return;if(!model_ob.last_msg_input){model_ob.last_msg_input=TS.storage.fetchLastMsgInput(model_ob.id);if(model_ob.last_msg_input&&TS.pri)TS.log(667,'Got last_msg_input for "'+model_ob.id+'" "'+model_ob.name+'": '+model_ob.last_msg_input)}model_ob._fetched_user_data_from_ls=true},processAttachments:function(attachments){if(!attachments)return;var attachment;for(var i=0;i<attachments.length;i++){attachment=attachments[i];if(!attachment){TS.warn("attachment is null!");continue}if(attachment.slack_file_id&&!attachment._slack_file_is_deleted){var file=TS.files.getFileById(attachment.slack_file_id);if(file){attachment._slack_file=file}else if(attachment._slack_file){attachment._slack_file=TS.files.upsertFile(attachment._slack_file).file}}if(attachment.mrkdwn_in&&_.isArray(attachment.mrkdwn_in)&&attachment.mrkdwn_in.length){attachment.mrkdwn_in_hash={};for(var k=0;k<attachment.mrkdwn_in.length;k++){attachment.mrkdwn_in_hash[attachment.mrkdwn_in[k]]=true}}if(!attachment.mrkdwn_in_hash)attachment.mrkdwn_in_hash={};delete attachment.mrkdwn_in;attachment.hex_swatches=!!attachment.hex_swatches;if(attachment.audio_html||attachment.audio_url){TS.inline_audios.makeInternalInlineAudio(attachment.audio_html||attachment.audio_url,attachment)}if(attachment.other_html){TS.inline_others.makeInternalInlineOther(attachment)}else if(attachment.video_html){var thumb_w=attachment.video_html_width&&parseInt(attachment.video_html_width)>parseInt(attachment.thumb_width)?attachment.video_html_width:attachment.thumb_width;var thumb_h=attachment.video_html_height&&parseInt(attachment.video_html_height)>parseInt(attachment.thumb_height)?attachment.video_html_height:attachment.thumb_height;TS.inline_videos.makeInternalInlineVideo(attachment.from_url||attachment.thumb_url,{title:attachment.title,html:TS.utility.msgs.filterHTMLForEmbeds(attachment.video_html),thumbnail:{url:attachment.thumb_url,width:thumb_w,height:thumb_h,link_url:attachment.from_url||attachment.title_url}})}else if(attachment.image_url){TS.inline_imgs.makeInternalInlineImg(attachment.from_url||attachment.image_url,{src:attachment.image_url,width:attachment.image_width,height:attachment.image_height,link_url:attachment.from_url||attachment.title_url||attachment.image_url,bytes:attachment.image_bytes,rotation:attachment.rotation,content_type:attachment.content_type})}TS.inline_attachments.massageAttachment(attachment,i)}},_slurpExtraData:function(imsg,c_id){TS.utility.msgs.processAttachments(imsg.attachments);imsg._rxn_key=TS.rxns.getRxnKey("message",imsg.ts,c_id);if(imsg.reactions){TS.rxns.upsertRxnsFromDataAndUpdateUI(imsg._rxn_key,imsg.reactions);delete imsg.reactions}var url;if(imsg.img_vids){var img_vid;for(url in imsg.img_vids){img_vid=imsg.img_vids[url];if(img_vid.img_vid_type=="img"){TS.inline_imgs.makeInternalInlineImg(url,img_vid)}else if(img_vid.img_vid_type=="video"){TS.inline_videos.makeInternalInlineVideo(url,img_vid)}}}if(imsg.imgs){for(url in imsg.imgs){imsg.imgs[url].from_url=url;TS.inline_imgs.makeInternalInlineImg(url,imsg.imgs[url])}}if(imsg.videos){for(url in imsg.videos){imsg.videos[url].from_url=url;TS.inline_videos.makeInternalInlineVideo(url,imsg.videos[url])}}if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"||imsg.subtype=="file_comment"){if(imsg.file&&!imsg.file.id){TS.error("WTF no file id on file in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}else if(imsg.file){TS.files.upsertAndSignal(imsg.file);if(imsg.subtype=="file_share"||imsg.subtype=="file_mention"){}if(imsg.subtype=="file_comment"){if(imsg.comment){var file=TS.files.getFileById(imsg.file.id);if(file){TS.files.addCommentToFile(imsg.comment,file)}else{TS.warn("WTF no file? id:"+imsg.file.id)}}else{TS.error("WTF no comment in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}}}else{}}if(imsg.subtype=="sh_room_created"||imsg.subtype=="sh_room_shared"){if(imsg.room&&!imsg.room.id){TS.error("WTF no room id on room in imsg.subtype:"+imsg.subtype+" "+imsg.ts)}else if(imsg.room){TS.rooms.upsertAndSignal(imsg.room)}else{TS.error("WTF no room on imsg.subtype:"+imsg.subtype+" "+imsg.ts)}}if(imsg.subtype=="pinned_item"){if(imsg.item_type==="F"&&imsg.item&&imsg.item.id&&!imsg.item.is_deleted)TS.files.upsertAndSignal(imsg.item)}},constructMsgPermalink:function(model_ob,ts){if(model_ob.is_im||model_ob.is_mpim){return"/archives/"+model_ob.id+"/p"+ts.replace(".","")}return"/archives/"+model_ob.name+"/p"+ts.replace(".","")},constructAbsoluteMsgPermalink:function(model_ob,ts){var abs_permalink=TS.boot_data.team_url.slice(0,-1)+TS.utility.msgs.constructMsgPermalink(model_ob,ts);return abs_permalink},constructConversationPermalink:function(model_ob,thread_ts){if(model_ob.is_im||model_ob.is_mpim){return"/conversation/"+model_ob.id+"/p"+thread_ts.replace(".","")}return"/conversation/"+model_ob.name+"/p"+thread_ts.replace(".","")},isTempMsg:function(msg){return!msg.ts||msg.ts.indexOf(TS.utility.date.fake_ts_unique_padder)>-1},shouldMarkUnreadsOnMessageFetch:function(model_ob){if(TS.qs_args["no_unread_marking_on_msgs_fetch"]=="1")return false;if(model_ob){var active_model_ob=TS.shared.getActiveModelOb();if(!active_model_ob||active_model_ob.id!==model_ob.id){if(TS.pri&&active_model_ob)TS.log(58,"shouldMarkUnreadsOnMessageFetch: returning FALSE because model_ob is #"+model_ob.name+" and not active of #"+active_model_ob.name);return false}}return true},ipsum:function(){var ipsum=["Build Something People Want","We know that we have built something which is genuinely useful: almost any team which adopts Slack as their central application for communication would be significantly better off than they were before.","That means we have something people want.","However, almost all of them have no idea that they want Slack.","How could they?","Theyve never heard of it.","And only a vanishingly small number will have imagined it on their own.","They think they want something different (if they think they want anything at all).","They definitely are not looking for Slack.","(But then no-one was looking for Post-it notes or GUIs either.)","Just as much as our job is to build something genuinely useful, something which really does make peoples working lives simpler, more pleasant and more productive, our job is also to understand what people think they want and then translate the value of Slack into their terms.","A good part of that is just marketing, but even the best slogans, ads, landing pages, PR campaigns, etc., will fall down if they are not supported by the experience people have when they hit our site, when they sign up for an account, when they first begin using the product and when they start using it day in, day out.","Therefore, understanding what people think they want and then translating the value of Slack into their terms is something we all work on.","It is the sum of the exercise of all our crafts.","We do it with copy accompanying signup forms, with fast-loading pages, with good welcome emails, with comprehensive and accurate search, with purposeful loading screens, and with thoughtfully implemented and well-functioning features of all kinds.","Marketing from Both Ends","Much has been written about product-market fit in the last few years, probably as a result of the popularity of the lean startup movement (though the idea has been around much longer).","The term refers to the degree to which a product could be successful, given sufficient promotion, appropriate pricing, adequate customer support and so on (before you find that fit, all the pushing in the world wont get you up the hill).","In this classic post on Marc Andreessens old blog, he calls getting to product-market fit the only thing that matters for startups and offers a way of thinking about the life of the startup that divides it into two distinct phases: before product-market fit and after.","Once the product fits the market, a company is able to step on the gas, spending to promote a product that will actually sell.","The things you need to do before are very different from the things you need to do after (generally test & iterate vs scale & optimize).","We are right in the middle of that first phase.","It seems we are doing well and there are many encouraging signs, but were definitely still in the first phase and it is very, very hard to tell how far we have to go to cross over into the promised land (the last 10% is 90% of the work, etc.)","So, we should be working carefully from both the product end and the market end:","Doing a better and better job of providing what people want (whether they know it or not)","Communicating the above more and more effectively (so that they know they want it)","In the best case, there is a dialectic at play here: the product itself and the way people use it should suggest new ways of articulating the valueand refinements to how we communicate the value should lead to principles which clarify decision-making around product features and design.","Our position is different than the one many new companies find themselves in: we are not battling it out in a large, well-defined market with clear incumbents (which is why we cant get away with Other group chat products are poisonous. Slack is toasted.).","Despite the fact that there are a handful of direct competitors and a muddled history of superficially similar tools, we are setting out to define a new market.","And that means we cant limit ourselves to tweaking the product; we need to tweak the market too.","Sell the innovation, not the product","The bestmaybe the only?real, direct measure of innovation is change in human behaviour.","In fact, it is useful to take this way of thinking as definitional: innovation is the sum of change across the whole system, not a thing which causes a change in how people behave.","No small innovation ever caused a large shift in how people spend their time and no large one has ever failed to do so.","By that measure, Slack is a real and large innovation.","It is not as eye-catching as self-driving cars or implantable chipsit is not basic research-y kind of stuff.","But, for organizations that adopt it, there will be a dramatic shift in how time is spent, how communication happens, and how the teams archives are utilized.","There will be changes in how team members relate to one another and, hopefully, significant changes in productivity.","We are unlikely to be able to sell a group chat system very well: there are just not enough people shopping for group chat system (and, as pointed out elsewhere, our current fax machine works fine).","Thats why what were selling is organizational transformation.","What we are selling is not the software productthe set of all the features, in their specific implementationbecause there are just not many buyers for this software product.","(People buy software to address a need they already know they have or perform some specific task they need to perform, whether that is tracking sales contacts or editing video.)","However, if we are selling a reduction in the cost of communication or zero effort knowledge management or making better decisions, faster or all your team communication, instantly searchable, available wherever you go or 75% less email or some other valuable result of adopting Slack, we will find many more buyers.","Thats why what were selling is organizational transformation.","The software just happens to be the part were able to build & ship (and the means for us to get our cut).","Were selling a reduction in information overload, relief from stress, and a new ability to extract the enormous value of hitherto useless corporate archives.","Were selling better organizations, better teams.","Thats a good thing for people to buy and it is a much better thing for us to sell in the long run.","We will be successful to the extent that we create better teams.","To see why, consider the hypothetical Acme Saddle Company.","They could just sell saddles, and if so, theyd probably be selling on the basis of things like the quality of the leather they use or the fancy adornments their saddles include; they could be selling on the range of styles and sizes available, or on durability, or on price.","Or, they could sell horseback riding.","Being successful at selling horseback riding means they grow the market for their product while giving the perfect context for talking about their saddles.","It lets them position themselves as the leader and affords them different kinds of marketing and promotion opportunities (e.g., sponsoring school programs to promote riding to kids, working on land conservation or trail maps).","It lets them think big and potentially be big.","Because the best possible way to find product-market fit is to define your own market.","This isnt a new idea.","There are many brands whose marketing activities or positioning has them selling something other than (and usually larger than) their product: Harley Davidson sells motorcycle riding, but it especially sells freedom and independence.","Most luxury brands sell something that comes down to being better than you are (richer, better looking, more attractive to those you find desirable, etc.)","My favorite recent example is Lululemon: when they started, there was not a large market for yoga-specific athletic wear and accessories.","They sold yoga like crazy: helping people find yoga studios near their homes, hosting free classes, sponsorships and scholarships, local ambassadors and training, etc.","And as a result, they sold just under $1.4 billion worth of yoga-specific athletic wear and accessories in their most recent fiscal year.","But going back to the Acme Saddle Company, the better analogy to what we are doing now is to imagine them selling horseback riding  about 4,000 years ago.","It is almost inevitable that centralized internal communication systems will gradually replace email for most organizations over the next 10-20 years and we should do what we can to accelerate the trend and own it.","We are at the beginning of a transition.","We have an opportunity to both define the category and push hard for the whole markets growth.","Wed be crazy not to take it, because the best possible way to find product-market fit is to define your own market."];return ipsum;
},removeFileSharesAndMentions:function(model_ob,file){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if((m.subtype=="file_share"||m.subtype=="file_mention")&&m.file&&m.file.id==file.id){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,m)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,m)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,m)}else{TS.ims.removeMsg(model_ob.id,m)}}}},removeFileComments:function(model_ob,file){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(m.subtype=="file_comment"&&m.file&&m.file.id==file.id){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,m)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,m)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,m)}else{TS.ims.removeMsg(model_ob.id,m)}}}},removeFileReferences:function(model_ob,file_id){if(!TS.client)return;var msgs=model_ob.msgs;var m;for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(m.attachments){var attach=TS.inline_attachments.getAttachmentBySlackFileId(m.attachments,file_id);if(attach&&!attach._slack_file_is_deleted){attach._slack_file_is_deleted=true;delete attach._slack_file;if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,m)}}}}},updateFileMsgs:function(model_ob,file){var msgs=model_ob.msgs;var is_using_archives=!(msgs&&msgs.length)||TS.model.archive_view_is_showing&&model_ob.is_channel&&model_ob.is_member===false;msgs=is_using_archives?model_ob._archive_msgs:msgs;if(!msgs||!msgs.length)return;var m;var msgHasFileReferenceAttachMent=function(m){if(!m)return false;if(!m.attachments)return false;if(!m.attachments.length)return false;if(TS.inline_attachments.getAttachmentBySlackFileId(m.attachments,file.id))return true;return false};for(var i=msgs.length-1;i>-1;i--){m=msgs[i];if(!file.is_deleted&&(m.subtype=="file_share"||m.subtype=="file_mention"||m.subtype=="file_comment")&&m.file&&m.file.id==file.id){}else if(msgHasFileReferenceAttachMent(m)){}else{continue}if(TS.boot_data.feature_update_message_file&&!file.is_tombstoned){if(file.mode==="hosted"||file.mode==="external"){if(file.comments.length||file.is_tombstoned==false){if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,m)}}else{continue}}if(TS.client){TS.view.rebuildMsgFile(m,file,is_using_archives)}else if(TS.web){TS.web.channel.rebuildMsgFile(m,file)}}else{if(model_ob.id==TS.model.active_im_id){TS.ims.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_channel_id){TS.channels.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_group_id){TS.groups.message_changed_sig.dispatch(model_ob,m)}else if(model_ob.id==TS.model.active_mpim_id){TS.mpims.message_changed_sig.dispatch(model_ob,m)}}}},updateCommentReferences:function(file){if(!file)return;var all_model_obs=TS.shared.getAllModelObsForUser();_.forEach(all_model_obs,function(model_ob){_.forEach(model_ob.msgs,function(msg){if(!msg.file||msg.file.id!==file.id)return;if(!msg.comment)return;var canonical_comment=_.find(file.comments,{id:msg.comment.id});if(canonical_comment)msg.comment=canonical_comment})})},tryToEditLastMsgFromShortcut:function(ob){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.sounds.play("beep");alert("Found no recent messages from you to edit :(");return}var text=TS.format.unFormatMsg(msg.text,msg);var new_text=TS.utility.msgs.wordReplace(text,ob);if(text==new_text){TS.sounds.play("beep");return}TS.msg_edit.commitEdit(msg,TS.shared.getActiveModelOb(),new_text)},getEditLastShortcutCmd:function(txt){var parts=txt.split("/");if(parts.length!=5&&parts.length!=4)return;if(parts[1]!="s")return;var str=parts[2];var rpl=parts[3];var g=parts.length==5&&(parts[4]=="g"||parts[4]=="gi"||parts[4]=="ig");var i=parts.length==5&&(parts[4]=="i"||parts[4]=="gi"||parts[4]=="ig");if(!str){return}return{str:str,rpl:rpl,g:g,i:i}},wordReplace:function(text,replace_object){if(!replace_object){return text}var rx_opts=(replace_object.g?"g":"")+(replace_object.i?"i":"");var word_delimiter="[\\s\\n\\r\\t.,'\"+!?\\-_|]";var escaped_word=TS.utility.regexpEscape(replace_object.str);var rx=new RegExp("(^|"+word_delimiter+"+)(?:"+escaped_word+")(?="+word_delimiter+"+|$)",rx_opts);return text.replace(rx,"$1"+replace_object.rpl)},maybeTruncateMsgs:function(model_ob){if(!model_ob)return;if(!model_ob.msgs)return;if(!model_ob.msgs.length)return;if(!TS.model.active_cid||!TS.shared.getActiveModelOb())return;var msg_limit=TS.model.initial_msgs_cnt+1;var max_msg_limit=Math.min(TS.model.hard_msg_limit,msg_limit*2);var scroll_top_limit=1e3;var ms_since_last_activated_limit=0;var ms_last_scrollback_history_load_limit=1e3*20;var msgs=model_ob.msgs;var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(msgs);var now=Date.now();var ms_since_last_scrollback_history_load=model_ob.has_fetched_history_after_scrollback?now-model_ob.fetched_history_after_scrollback_time:now;if(displayed_msgs.length>max_msg_limit&&(model_ob.id!=TS.shared.getActiveModelOb().id||model_ob.scroll_top<scroll_top_limit&&ms_since_last_scrollback_history_load>ms_last_scrollback_history_load_limit)){msg_limit=max_msg_limit}else{if(displayed_msgs.length-50<=msg_limit){return}if(model_ob.last_made_active){var ms_since_last_activated=now-model_ob.last_made_active;if(ms_since_last_activated<ms_since_last_activated_limit){return}}if(!TS.boot_data.feature_no_unread_counts){if(model_ob.unread_cnt&&model_ob.unread_count&&!model_ob.all_read_this_session_once){return}}if(model_ob.scroll_top!=-1){return}}if(model_ob.history_is_being_fetched){return}var msgs_to_remove_from_view=[];while(TS.utility.msgs.getDisplayedMsgs(msgs).length>msg_limit){msgs_to_remove_from_view.push(msgs.pop())}if(model_ob.is_limited){TS.info("Truncated "+model_ob.id+" and reset is_limited");model_ob.is_limited=false}if(model_ob.id==TS.shared.getActiveModelOb().id){TS.view.removeMsgsAfterTruncation(msgs_to_remove_from_view)}},checkForMsgsToTruncate:function(){if(!TS.model)return;if(!TS.model.channels)return;var channels=TS.model.channels;var channel;var i;for(i=0;i<channels.length;i++){channel=channels[i];if(channel.id==TS.model.active_channel_id)continue;if(!channel.is_member)continue;if(channel.is_archived)continue;TS.utility.msgs.maybeTruncateMsgs(channel)}var ims=TS.model.ims;var im;for(i=0;i<ims.length;i++){im=ims[i];if(im.id==TS.model.active_im_id)continue;TS.utility.msgs.maybeTruncateMsgs(im)}var groups=TS.model.groups;var group;for(i=0;i<groups.length;i++){group=groups[i];if(group.id==TS.model.active_group_id)continue;if(group.is_archived)continue;TS.utility.msgs.maybeTruncateMsgs(group)}var mpims=TS.model.mpims;var mpim;for(i=0;i<mpims.length;i++){mpim=mpims[i];if(mpim.id==TS.model.active_mpim_id)continue;TS.utility.msgs.maybeTruncateMsgs(mpim)}},getEphemeralMsgsByCidAndType:function(c_id,ephemeral_type){var msg;var ob;var A=[];var model_ob=TS.shared.getModelObById(c_id);if(!model_ob)return A;for(var ts in TS.utility.msgs.ephemeral_msgs_map){ob=TS.utility.msgs.ephemeral_msgs_map[ts];if(ob.ephemeral_type==ephemeral_type&&ob.c_id==c_id){msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(!msg)continue;A.push(msg)}}return A},removeAllEphemeralMsgsByType:function(ephemeral_type,c_id){var model_ob;var ob;var msg;for(var ts in TS.utility.msgs.ephemeral_msgs_map){ob=TS.utility.msgs.ephemeral_msgs_map[ts];if(ob.ephemeral_type==ephemeral_type){if(c_id&&c_id!=ob.c_id)continue;model_ob=TS.shared.getModelObById(ob.c_id);if(!model_ob)continue;msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(!msg)continue;if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}delete TS.utility.msgs.ephemeral_msgs_map[ts]}}},hasImgs:function(msg){if(!msg)return false;if(msg.img_vids){var img_vid;var url;for(url in msg.img_vids){img_vid=msg.img_vids[url];if(img_vid.img_vid_type=="img"){return true}}}else if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){if(msg.attachments[i].image_url){return true}}}return false},ingestMessagesFromBootData:function(model_ob){if(!TS.boot_data.msgs)return;var msgs=TS.boot_data.msgs[model_ob.id];var A=[];if(msgs){var imsg;for(var i=0;i<msgs.length;i++){imsg=msgs[i];if(!imsg.ts)continue;A.push(TS.utility.msgs.processImsg(imsg,model_ob.id))}}TS.utility.msgs.setMsgs(model_ob,A)},handleSearchHighlights:function(html){return TS.format.replaceHighlightMarkers(html,'<span class="match">',"</span>")},findAllMsgsBySubtype:function(subtype){var i;var m;var model_ob;var model_obs=TS.shared.getAllModelObsForUser();var results={};for(i=0;i<model_obs.length;i++){model_ob=model_obs[i];if(!model_ob.msgs)continue;for(m=0;m<model_ob.msgs.length;m++){if(subtype!=model_ob.msgs[m].subtype)continue;results[model_ob.name]=results[model_ob.name]||{id:model_ob.id};results[model_ob.name]["msg_index_"+m]=model_ob.msgs[m]}}TS.info(JSON.stringify(results,null,"	"))},handleFailedMsgSend:function(msg_id,model_ob,resend){var temp_msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);if(temp_msg){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,temp_msg);if(resend)TS.channels.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,temp_msg);if(resend)TS.mpims.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,temp_msg);if(resend)TS.groups.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}else{TS.ims.removeMsg(model_ob.id,temp_msg);if(resend)TS.ims.sendMsg(model_ob.id,TS.format.unFormatMsg(temp_msg.text,temp_msg))}delete TS.model.unsent_msgs[temp_msg.ts];delete TS.model.display_unsent_msgs[temp_msg.ts]}else{TS.error("no msg?: "+msg_id)}},msgMightBeRolledUp:function(msg){return msg.subtype&&TS.model.join_leave_subtypes.indexOf(msg.subtype)!=-1},msgRollUpWorker:function(i,msg,msgs,jl_rolled_up_msgs){delete msg._jl_rollup_hash;delete msg._jl_rolled_up_in;if(!TS.utility.msgs.msgMightBeRolledUp(msg))return;jl_rolled_up_msgs.push(msg);if(i!==0&&TS.utility.msgs.msgMightBeRolledUp(msgs[i-1])){return"continue"}else{var hash=jl_rolled_up_msgs[0]._jl_rollup_hash={msg_ids:[],users:{}};var jl_msg;for(var m=0;m<jl_rolled_up_msgs.length;m++){jl_msg=jl_rolled_up_msgs[m];var ob=hash.users[jl_msg.user]=hash.users[jl_msg.user]||{};hash.msg_ids.push(jl_msg.ts);jl_msg._jl_rolled_up_in=jl_rolled_up_msgs[0].ts;if(jl_msg.subtype=="channel_join"||jl_msg.subtype=="group_join"){ob.inviter=jl_msg.inviter;ob.joined=true;ob.is_in=true}else if(jl_msg.subtype=="channel_leave"||jl_msg.subtype=="group_leave"){ob.left=true;ob.is_in=false}}return"swap"}},shouldHaveBotLabel:function(msg,member){var is_bot_msg=msg.subtype&&msg.subtype=="bot_message"&&msg.user!=="USLACKBOT";var is_bot_member=member&&member.is_bot&&!member.is_slackbot;return is_bot_msg||is_bot_member},checkConsistencyViaApi:function(c_id){if(!TS.boot_data.feature_msg_consistency)return;if(!TS.model.ms_connected)return;var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||!model_ob.msgs||!model_ob.msgs.length)return;if(model_ob.is_archived)return;if(model_ob.history_is_being_fetched)return;if(model_ob._consistency_has_been_checked)return;if(model_ob._consistency_is_being_checked)return;var oldest_ts_we_have=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(!oldest_ts_we_have)return;var newest_ts_we_have=TS.utility.msgs.getMostRecentValidTs(model_ob);var log_prefix="checkConsistencyViaApi for: "+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob);model_ob._consistency_is_being_checked=true;var options={channel:model_ob.id,oldest:oldest_ts_we_have,count:1e3,inclusive:true};if(newest_ts_we_have)options.latest=newest_ts_we_have;TS.log(773,log_prefix+", range = "+options.oldest+" -> "+(options.latest||"now"));TS.api.call(TS.shared.getHistoryApiMethodForModelOb(model_ob),options).then(function(res){var was_inconsistent=TS.utility.msgs.checkConsistency(c_id,res.data.messages);if(was_inconsistent){TS.metrics.store("inconsistent_history_cnt",++_inconsistent_history_cnt,{is_count:true});TS.error(log_prefix+" NOT GOOD!")}else{model_ob._consistency_has_been_checked=true;TS.log(773,log_prefix+" all good!")}}).catch(function(err){TS.error(log_prefix+" err:"+err)}).finally(function(){delete model_ob._consistency_is_being_checked})},checkConsistency:function(c_id,from_msgs){var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||!model_ob.msgs||!model_ob.msgs.length)return;var missing_msgs=[];var log_prefix="checkConsistency for: "+c_id+" "+TS.shared.getDisplayNameForModelOb(model_ob);TS.log(773,log_prefix+" from_msgs.length:"+from_msgs.length+" model_ob.msgs.length:"+model_ob.msgs.length);from_msgs.forEach(function(msg,i){if(!TS.utility.msgs.getMsg(msg.ts,model_ob.msgs)){msg=TS.utility.msgs.processImsg(msg,c_id);missing_msgs.push(msg);TS.error(log_prefix+" found and fixed an inconsistency at i:"+i+", ts="+msg.ts)}});if(!missing_msgs.length)return false;if(missing_msgs.length==1){if(model_ob.is_channel){TS.channels.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_mpim){TS.mpims.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_group){TS.groups.addMsg(c_id,missing_msgs[0])}else if(model_ob.is_im){TS.ims.addMsg(c_id,missing_msgs[0])}}else{TS.shared.addMsgs(model_ob,missing_msgs)}return true},filterHTMLForEmbeds:function(html){if(!html)return html;var $good_tags;var parser=new DOMParser;var parsed=parser.parseFromString(html,"text/html")||parser.parseFromString(html,"text/xml");var result="";var $doc;if(parsed)$doc=$(parsed.body);if(!$doc)return html;if($doc){$good_tags=$doc.find(_allowed_tags_selector);if($good_tags.length){result=TS.utility.sanitizeHTML($good_tags.first()[0].outerHTML,_allowed_tags,TS.utility.msgs.allowed_embed_attributes)}else{}}else{}parser=null;parsed=null;$doc=null;$good_tags=null;return result},areMsgsSameDay:function(msg_a,msg_b){var date_a=TS.utility.date.toDateObject(msg_a.ts);var date_b=TS.utility.date.toDateObject(msg_b.ts);return TS.utility.date.sameDay(date_a,date_b)},maybeCalcUnreadCnts:function(model_ob){if(!TS.client||!TS.client._should_defer_initial_msg_history)return;if(!model_ob){TS.warn("maybeCalcUnreadCnts: WTF no model_ob?");return}if(model_ob._needs_unread_recalc&&model_ob.unread_cnt==1){var controller=TS.shared.getControllerForModelOb(model_ob);if(!controller){TS.warn("maybeCalcUnreadCnts: WTF no controller for id "+model_ob.id+"?");return}var and_mark=false;controller.calcUnreadCnts(model_ob,and_mark);model_ob._needs_unread_recalc=false}},maybeSetPrevLastRead:function(model_ob,ts){if(!model_ob)return;var most_valid_recent_ts=TS.utility.msgs.getMostRecentValidTs(model_ob);if(ts!=most_valid_recent_ts){TS.utility.msgs.setPrevLastRead(model_ob,ts)}else{TS.utility.msgs.setPrevLastRead(model_ob,model_ob.last_read)}},setPrevLastRead:function(model_ob,ts){if(!model_ob)return;if(!model_ob._prev_last_read&&model_ob.unread_cnt&&!TS.notifs.isCorGMuted(model_ob.id)){model_ob._prev_last_read=ts}else if(TS.boot_data.feature_pin_update){var mos_recent_ts=TS.utility.msgs.getMostRecentValidTs(model_ob);var most_recent_msg=TS.utility.msgs.getMsg(mos_recent_ts,model_ob.msgs);if(most_recent_msg&&most_recent_msg.subtype==="pinned_item")model_ob._prev_last_read=ts}},maybeClearPrevLastRead:function(model_ob){model_ob=model_ob||TS.shared.getActiveModelOb();if(model_ob&&model_ob._prev_last_read)delete model_ob._prev_last_read},maybeClearUsersCountsInfo:function(model_ob){if(!model_ob)return;if(model_ob.last_read>=model_ob.latest)TS.utility.msgs.maybeClearUsersCountsMentionCountDisplay(model_ob);if(!model_ob._users_counts_info)return;if(TS.pri)TS.log(888,"Deleting _users_counts_info on #"+model_ob.name);delete model_ob._users_counts_info},maybeClearUsersCountsMentionCountDisplay:function(model_ob){if(!model_ob||!TS.boot_data.feature_wait_for_all_mentions_in_client)return;if(model_ob._mention_count_display_via_users_counts){if(TS.pri)TS.log(888,"deleting _mention_count_display_via_users_counts on #"+model_ob.name);delete model_ob._mention_count_display_via_users_counts}},isMsgReply:function(msg){if(!TS.boot_data.feature_message_replies)return false;if(!msg)return false;return msg.thread_ts&&msg.thread_ts!=msg.ts}});var _is_in_bulk_unread_calc_mode=false;var _allowed_tags=["video","iframe","source"];var _allowed_tags_selector=_allowed_tags.join(",");var _inconsistent_history_cnt=0})();(function(){"use strict";TS.registerModule("utility.members",{checkMemberMatch:function(member,regex,names_only){if(TS.boot_data.feature_name_tagging_client){return!names_only&&member.profile&&member.profile.email&&member.profile.email.match(regex)||member.profile&&member.profile.full_name_normalized&&member.profile.full_name_normalized.match(regex)||member.profile&&member.profile.full_name&&member.profile.full_name.match(regex)||member.profile&&member.profile.preferred_name_normalized&&member.profile.preferred_name_normalized.match(regex)||member.profile&&member.profile.preferred_name&&member.profile.preferred_name.match(regex)}else{return member.name&&member.name.match(regex)||!names_only&&member.profile&&member.profile.email&&member.profile.email.match(regex)||member.profile&&member.profile.real_name_normalized&&member.profile.real_name_normalized.match(regex)||member.profile&&member.profile.real_name&&member.profile.real_name.match(regex)}},filterMembersByQuery:function(members,query){query=_.toString(query).trim().toLowerCase().replace(/^@/,"");if(!query)return members;var query_regexp=new RegExp(TS.utility.regexpEscape(query),"i");return members.filter(function(member){return TS.utility.members.checkMemberMatch(member,query_regexp)})},getBroadcastKeywordsForUser:function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return[];var everyone_keywords=[];var channel_keywords=[];if(model_ob.is_general&&TS.members.canUserAtEveryone()){everyone_keywords=_.filter(TS.model.BROADCAST_KEYWORDS,function(bk){return bk.id==="BKeveryone"||bk.id==="BKall"})}if(TS.members.canUserAtChannelOrAtGroup()&&(model_ob.is_channel||model_ob.is_group)&&(!model_ob.is_general||TS.members.canUserAtEveryone())){channel_keywords=_.filter(TS.model.BROADCAST_KEYWORDS,function(bk){return bk.id==="BKchannel"||bk.id==="BKgroup"||bk.id==="BKhere"})}return everyone_keywords.concat(channel_keywords)},isMemberOfChannel:function(member_id,model_ob){if(!member_id){TS.warn("TS.utility.members.isMemberOfChannel() requires a member_id arg");return}if(!model_ob){TS.warn("TS.utility.members.isMemberOfChannel() requires a model_ob arg");return}return model_ob.members&&model_ob.members.indexOf(member_id)!=-1},isMemberElement:function(el){if(el.hasAttribute("data-member-id"))return true;if(el.hasAttribute("data-member-name"))return true;if(el.classList.contains("internal_member_link"))return true;return false},isMemberNonBotNonDeletedNonSelf:function(member){var is_human=member&&!member.deleted&&!member.is_bot&&!member.is_slackbot;return is_human&&!member.is_self}})})();(function(){"use strict";TS.registerModule("utility",{onStart:function(){TS.utility.makeRefererSafeLink=_.memoize(TS.utility.makeRefererSafeLink);if(TS.ms)TS.ms.connected_sig.add(TS.utility.resetRefererSafeLinkCache);if(TS.prefs&&TS.prefs.team_hide_referers_changed_sig)TS.prefs.team_hide_referers_changed_sig.add(TS.utility.resetRefererSafeLinkCache)},keymap:{alt:18,ctrl:17,cmd_ff:224,cmd_other:91,cmd_right:93,esc:27,shift:16,tab:9,del:8,"delete":46,enter:13,left:37,up:38,right:39,down:40,pageup:33,pagedown:34,end:35,home:36,space:32,semicolon:59,equals_sign:187,minus_sign:189,comma:188,period:190,left_square_bracket:219,right_square_bracket:221,V:86,a:65,e:69,b:66,k:75,i:73,z:90,y:89,insert:45},email_regex:new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i"),regexpEscape:function(text,len_limit){text=text||"";len_limit=len_limit||5e5;len_limit=Math.min(len_limit,5e5);if(text.length>len_limit){text=text.substr(0,len_limit)}return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},ensureInArray:function(A,val){if(A.indexOf(val)>-1)return false;A.push(val);return true},compareVersions:function(version_a,version_b){if(!version_a.major)version_a.major=0;if(!version_a.minor)version_a.minor=0;if(!version_b.major)version_b.major=0;if(!version_b.minor)version_b.minor=0;if(version_a.major===version_b.major){if(version_a.minor==version_b.minor)return 0;return version_a.minor>version_b.minor?1:-1}return version_a.major>version_b.major?1:-1},makeComparableVersion:function(ver){var noBeta=ver.split("-")[0];return _.reduce(noBeta.split("."),function(acc,x){return acc*1e3+parseInt(x)},0)},compareSemanticVersions:function(version_a,version_b){var lhs=TS.utility.makeComparableVersion(version_a);var rhs=TS.utility.makeComparableVersion(version_b);if(lhs===rhs)return 0;return lhs>rhs?1:-1},doRectsOverlap:function(r1,r2){return!(r2.left>r1.right||r2.right<r1.left||r2.top>r1.bottom||r2.bottom<r1.top)},doesRectContainRect:function(r1,r2,tolerance,vertical_only){tolerance=tolerance||0;if(r2.top<r1.top-tolerance)return false;if(r2.bottom>r1.bottom+tolerance)return false;if(vertical_only)return true;if(r2.left<r1.left-tolerance)return false;if(r2.right>r1.right+tolerance)return false;return true},shouldLinksHaveTargets:function(){return!!(TS.client||TS.web&&TS.web.space)},parseJSONOrElse:function(json_str,fallback){if(json_str==="")return fallback;try{return JSON.parse(json_str)}catch(err){return fallback}},stringifyJSONOrElse:function(json_ob,replacer,space,fallback){try{return JSON.stringify(json_ob,replacer,space)}catch(err){if(typeof fallback=="function"){return fallback(err)}else{return fallback}}},ordinalNumber:function(number){number=number.toString();var suffix=number.substr(-Math.min(number.length,2))>3&&number.substr(-Math.min(number.length,2))<21?"th":["th","st","nd","rd","th"][Math.min(Number(number)%10,4)];return number+suffix},getChannelNameFromUrl:function(url){if(TS.boot_data.feature_unread_view){if(/.com\/+unreads/.test(url))return""}var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>0){return decodeURIComponent(pathA[0])}return""},getFlexNameFromUrl:function(url){var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>1){return decodeURIComponent(pathA[1])}return""},getFlexExtraFromUrl:function(url){var pathA=TS.utility._getPathAFromUrl(url);if(pathA&&pathA.length>2){var flex_extra=pathA[2];flex_extra=decodeURIComponent(flex_extra);flex_extra=flex_extra.replace(/%2F/g,"/");return flex_extra}return""},isUnreadViewPath:function(path){return path.indexOf("/unreads")===0},isThreadsViewPath:function(path){return path.indexOf("/threads")===0},_getPathAFromUrl:function(url){var splitter;if(url.indexOf("/messages/")!=-1){splitter="/messages/"}else if(url.indexOf("/archives/")!=-1){splitter="/archives/"}else if(TS.boot_data.feature_unread_view&&url.indexOf("/unreads/")!=-1){splitter="/unreads/"}if(!splitter){return null}var urlA=url.split(splitter);var restA=urlA[1].split("?");var pathA=restA[0].split("/");return pathA},refashionUrl:function(url,c_name,flex_name,flex_extra){if(TS.boot_data.feature_unread_view){return TS.utility._refashionUrlWorker({url:url,c_name:c_name,flex_name:flex_name,flex_extra:flex_extra})}var urlA=url.split(/\.com\/+messages/);var base=urlA[0]+".com";var restA=urlA[1].split("?");var pathA=restA[0].split("/");var qs=restA[1]?"?"+restA[1]:"";pathA.length=2;pathA[0]=c_name;pathA[1]=flex_name;if(flex_extra){pathA.length=3;pathA[2]=flex_extra}if(!pathA[1]){pathA.length=1}return base+"/messages/"+pathA.join("/")+"/"+qs},refashionUrlForUnreadView:function(url,flex_name,flex_extra){return TS.utility._refashionUrlWorker({unread_view:true,url:url,flex_name:flex_name,flex_extra:flex_extra})},refashionUrlForThreadsView:function(url,flex_name,flex_extra){return TS.utility._refashionUrlWorker({threads_view:true,url:url,flex_name:flex_name,flex_extra:flex_extra})},_refashionUrlWorker:function(args){var urlA=args.url.split(/\.com\/+(messages|unreads|threads)/);var base=urlA[0]+".com";var restA=urlA[2].split("?");var pathA=restA[0].split("/");var qs=restA[1]?"?"+restA[1]:"";pathA.length=2;pathA[0]=args.c_name;pathA[1]=args.flex_name;if(args.flex_extra){pathA.length=3;pathA[2]=args.flex_extra}if(!pathA[1]){pathA.length=1}if(args.unread_view||args.threads_view){var view_url=args.unread_view?"/unreads/":"/threads/";pathA.shift();if(pathA.length){return base+view_url+pathA.join("/")+"/"+qs}else{return base+view_url+qs}}return base+"/messages/"+pathA.join("/")+"/"+qs},dataURItoBlob:function(dataURI){return TS.utility.base64StrtoBlob(TS.utility.base64StrFromDataURI(dataURI))},base64StrFromDataURI:function(dataURI){return dataURI.split(",")[1]},base64StrtoBlob:function(str){var byteString=atob(str);var arrayBuffer=new ArrayBuffer(byteString.length);var _ia=new Uint8Array(arrayBuffer);for(var i=0;i<byteString.length;i++){_ia[i]=byteString.charCodeAt(i)}var dataView=new DataView(arrayBuffer);var blob=new Blob([dataView]);return blob},ellipsize:function(str,len){if(!str)return str;if(!len||!parseInt(len))len=50;if(str.length>len){var prefix=str.substr(0,len/2);var suffix=str.substr(-(len/2),str.length);str=prefix+"..."+suffix}return str},makeSafeForDomId:function(str){return String(str).replace(/\./g,"_")},makeSafeForDomClass:function(str){return str.replace(/\s/g,"_")},getImageIconClass:function(image,defaultClass){var icon_class=defaultClass;var max_width=80;var max_height=80;if(image&&(image.thumb_360_w<max_width||image.thumb_360_h<max_height)){if(image.thumb_360_w>image.thumb_360_h){icon_class="landscape"}else if(image.thumb_360_w<image.thumb_360_h){icon_class="portrait"}else{icon_class="square"}}return icon_class},getAppliedClasses:function(class_map){return _.reduce(class_map,function(result,value,key){if(!!value)result.push(key);return result},[]).join(" ")},convertFilesize:function(size){size=parseInt(size);if(size===0)return"0 bytes";var units=["b","KB","MB","GB"];var power=parseInt(Math.floor(Math.log(size)/Math.log(1024)));var calc_size=size/Math.pow(1024,power);var rounded_size=Math.round(calc_size,2);if(rounded_size>999){rounded_size=1;power++}return rounded_size+units[power]},numberWithCommas:function(x){if(x===undefined||x===null)return"";var parts=x.toString().split(".");parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return parts.join(".")},numberWithK:function(x){if(x>999){x=Math.round(x/1e3*10)/10;return TS.utility.numberWithCommas(x)+"K"}else{return TS.utility.numberWithCommas(x)}},cleanChannelName:function(name){name=name.toLowerCase();while(name.substr(0,1)=="#")name=name.substr(1);name=name.replace(/ /g,"-");name=name.replace(/[^a-z0-9-_]/g,"_");name=name.replace(/\-+/g,"-");name=name.replace(/\_+/g,"_");return name},openInNewTab:function(url,target){url=TS.utility.htmlEntities(url);if(url.indexOf("/")===0&&TS.boot_data.team_url){var team_url=TS.boot_data.team_url;team_url=team_url.substr(0,team_url.length-1);url=team_url+url}var action=url;var fields="";if(TS.utility.urlNeedsRefererHiding(url)){fields='<input type="hidden" name="url" value="'+TS.utility.htmlEntities(url)+'">';action=(TS.boot_data.feature_referer_policy?"https://":"http://")+TS.boot_data.redir_domain+"/link"}else{var queryIndex=action.indexOf("?");if(queryIndex!==-1){var query=action.substring(queryIndex+1,action.length);action=action.substring(0,queryIndex);if(query.length){var params=query.split("&amp;");for(var i=0;i<params.length;i++){var pair=params[i].split("=");fields+='<input type="hidden" name="'+TS.utility.htmlEntities(pair[0])+'" value="'+(pair.length>1?TS.utility.htmlEntities(pair[1]):"")+'">'}}}}$("<form>"+fields+"</form>").attr({method:"GET",action:action,target:target}).appendTo("body").submit().remove()},isScalar:function(mixed_var){return/boolean|number|string/.test(typeof mixed_var)},sanitizeHTML:function(html,valid_tags,valid_attrs,return_node_only){var _sanitizeNode=function(node){var tag_name=node.tagName.toLowerCase();if(valid_tags.indexOf(tag_name)<0){return null}Array.prototype.slice.apply(node.attributes).forEach(function(attr){if(valid_attrs.indexOf(attr.name)<0){node.attributes.removeNamedItem(attr.name)}});Array.prototype.slice.apply(node.children).forEach(function(childNode){var sanitized_child=_sanitizeNode(childNode);if(!sanitized_child){node.removeChild(childNode)}});return node};_parser=_parser||new DOMParser;var doc=_parser.parseFromString(html,"text/html")||_parser.parseFromString(html,"text/xml");var body=doc.body;if(body.children.length!=1){return""}var sanitized=_sanitizeNode(body.children[0]);body=null;doc=null;return sanitized?return_node_only?sanitized:sanitized.outerHTML:""},getChildTextNodes:function(el){var nodes=[];if(!el)return nodes;if(el instanceof Text){nodes.push(el);return nodes}var walker=document.createTreeWalker(el,NodeFilter.SHOW_TEXT,null,false);var node;while(node=walker.nextNode())nodes.push(node);return nodes},getAttributesFromHTMLString:function(html){_parser=_parser||new DOMParser;var doc=_parser.parseFromString(html,"text/html")||_parser.parseFromString(html,"text/xml");var body=doc.body;if(body.children.length!=1){return{}}var attrs={};[].slice.apply(body.children[0].attributes).forEach(function(attr){attrs[attr.name]=attr.value});body=null;doc=null;return attrs},findUrls:function(string){return string.match(URL_REGEXP)||[]},linkify:function(string,target,recognize_www,internal){if(!string)return string;string=string.replace(URL_REGEXP,function(match){var uri;if(match.toLowerCase().indexOf("www.")===0){if(!recognize_www){return match}uri="http://"+match}else{uri=match}if(internal){return"<"+uri+"|"+match+">"}else{return"<a "+TS.utility.makeRefererSafeLink(uri)+' target="'+(target||"")+'">'+match+"</a>"}});return string},linkifyInternal:function(string,recognize_www){return TS.utility.linkify(string,"",recognize_www,true)},getCursorPosition:function(selector){if(TS.boot_data.feature_texty){if(_.isString(selector))selector=$(selector);return TS.utility.contenteditable.cursorPosition(selector)}var el,pos,sel;if(selector instanceof HTMLElement){el=selector}else{el=$(selector).get(0)}pos={start:0,end:0,length:0};if("selectionStart"in el){pos.start=el.selectionStart;pos.end=el.selectionEnd;pos.length=Math.abs(el.selectionEnd-el.selectionStart)}else if("selection"in document){el.focus();sel=document.selection.createRange();pos.length=document.selection.createRange().text.length;sel.moveStart("character",-el.value.length);pos.start=sel.text.length-pos.length;pos.end=pos.start+pos.length}return pos},setCursorPosition:function(selector,pos,length){if(TS.boot_data.feature_texty){if(_.isString(selector))selector=$(selector);return TS.utility.contenteditable.cursorPosition(selector,pos,length)}var el,range;el=$(selector).get(0);if(el){if(el.setSelectionRange){el.focus();if(length){el.setSelectionRange(pos,pos+length)}else{el.setSelectionRange(pos,pos)}}else if(el.createTextRange){range=el.createTextRange();if(length){range.moveStart("character",pos);range.moveEnd("character",length-pos)}else{range.move("character",pos)}range.select()}}},htmlEntities:function(str){if(!str&&str!==0)return"";return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
},unHtmlEntities:function(str){if(!str&&str!==0)return"";return String(str).replace(/\&lt\;/g,"<").replace(/\&gt\;/g,">").replace(/\&amp\;/g,"&").replace(/\&quot;/g,'"')},preg_quote:function(str){return(str+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1")},getActiveElementProp:function(name){if(!document.activeElement)return"";if(name=="NODENAME"){if(!document.activeElement.nodeName)return"";return document.activeElement.nodeName.toUpperCase()}return document.activeElement[name]},isTabCompleteShowing:function(){if(!TS.utility.isFocusOnInput())return false;var $input=$(document.activeElement);if(!$input.tab_complete_ui)return false;if(!$input.tab_complete_ui("instance"))return false;if($input.tab_complete_ui("isShowing")||$input.tab_complete_ui("wasJustHidden")){return true}return false},isFocusOnInput:function(){var NODENAME=TS.utility.getActiveElementProp("NODENAME");if(NODENAME=="")return false;if(NODENAME=="INPUT")return true;if(NODENAME=="TEXTAREA")return true;if(NODENAME=="SELECT")return true;var content_editable=document.activeElement.getAttribute("contenteditable");if(content_editable=="true")return true;return false},formatTopicOrPurpose:function(txt,no_preformatted){txt=TS.format.unFormatMsg(txt);txt=TS.format.cleanMsg(txt);txt=TS.utility.linkifyInternal(txt,true);txt=TS.format.formatWithOptions(txt,{},{no_preformatted:!!no_preformatted});txt=txt.replace(/(<br[^>]*>)/,'<span class="hidden br_ellipsis"></span>$1');return txt},concatNames:function(names,conjunction){conjunction=conjunction||"and";if(!names||names.length===0)return"";if(names.length===1)return names[0];if(names.length===2)return names[0]+" "+conjunction+" "+names[1];var s=names.slice(0,names.length-1).join(", ");s+=", "+conjunction+" "+names[names.length-1];return s},populateInput:function(input,txt,cursor_pos){if(!txt)txt="";var $input=$(input);var should_use_html=TS.boot_data.feature_name_tagging_client&&TS.boot_data.feature_texty&&$input.is(TS.client.ui.$msg_input);if(should_use_html){var new_html=txt;if(TS.boot_data.feature_name_tagging_client_extras){var formatted=TS.format.formatSlugs(new_html,cursor_pos);new_html=formatted.html;cursor_pos=formatted.cursor.start}$input.html(new_html);$input.data("textchange_lastvalue",$input.html());TS.utility.queueRAF(function populateInputRAF(){$input.trigger("textchange")});TS.utility.contenteditable.cursorPosition($input,cursor_pos)}else{TS.utility.contenteditable.value($input,txt);if(_.isNumber(cursor_pos)){TS.utility.contenteditable.cursorPosition($input,cursor_pos)}$input.data("textchange_lastvalue",txt);TS.utility.queueRAF(function populateInputRAF(){$input.trigger("autosize").trigger("autosize-resize");$input.trigger("textchange")})}},urlNeedsRefererHiding:function(url){if(!url)return false;url=url.toLowerCase();if(url.indexOf("https://")!==0&&url.indexOf("http://")!==0)return false;url=url.replace(/^https:\/\//,"").replace(/^http:\/\//,"");var wl=getRefererHidingWhiteList();for(var i=0;i<wl.length;i++){if(url==wl[i]||url.indexOf(wl[i]+"/")===0)return false}return true},referer_safe_url_map:{},makeRefererSafeLink:function(url){if(typeof url!=="string"){TS.error("Expected url to be a string, got: "+typeof url);return}url=TS.format.replaceHighlightMarkers(url);var html_url=url.replace(/\&amp\;/g,"&");if(html_url.match(/javascript\:/gi)){html_url="#"}var get_raw_node=true;var sanitized_node=TS.utility.sanitizeHTML('<a href="'+html_url+'"></a>',["a"],["href"],get_raw_node)||null;if(sanitized_node){html_url=sanitized_node.href}html_url=TS.utility.htmlEntities(html_url);html_url=html_url.replace(/\&amp\;/g,"&");if(url&&url.lastIndexOf("/")!==url.length-1){if(html_url&&html_url.lastIndexOf("/")===html_url.length-1){html_url=html_url.slice(0,-1)}}html_url=html_url||"#";var html='href="'+html_url+'"';var on_method="onclick";var referer_policy=_getRefererPolicy();if(!TS.model||!TS.model.is_our_app){if(referer_policy&&referer_policy.rewrite_on_right_click){on_method="onmousedown"}}if(!TS.utility.urlNeedsRefererHiding(url))return html;if(TS.utility.externalURLsNeedRedirecting()){var encoded_url=encodeURIComponent(html_url);var proxy_url=(TS.boot_data.feature_referer_policy?"https://":"http://")+TS.boot_data.redir_domain+"/link?url="+encoded_url+(TS.boot_data.feature_referer_policy&&referer_policy&&referer_policy.redirect_type?"&v="+referer_policy.redirect_type:"");var map_key=TS.utility.htmlEntities(encoded_url);TS.utility.referer_safe_url_map[map_key]=html_url;html+=' data-referer-safe="1" '+on_method+'="this.href=&quot;'+proxy_url+'&quot;" onmouseover="this.href=TS.utility.referer_safe_url_map[&quot;'+map_key+'&quot;]" data-referer-original-href="'+html_url+'" rel="noreferrer"'}else{html+=' rel="noreferrer"'}return html},resetRefererSafeLinkCache:function(){if(TS.utility.makeRefererSafeLink&&TS.utility.makeRefererSafeLink.cache)TS.utility.makeRefererSafeLink.cache.clear()},makeSureAllExternalLinksAreRefererSafe:function($el){var start=Date.now();var bads=[];if(TS.utility.externalURLsNeedRedirecting()){$el.find("a[href]:not([data-referer-safe])").each(function(){var a=$(this);var href=a.attr("href");if(!TS.utility.urlNeedsRefererHiding(href))return;bads.push(this.outerHTML);a.removeAttr("href");var new_html=this.outerHTML.replace("<a",function(){return"<a "+TS.utility.makeRefererSafeLink(href)+" "});a.replaceWith(new_html);bads[bads.length-1]+="\n->\n"+new_html});if(TS.model&&TS.model.team&&TS.boot_data.feature_tinyspeck){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH EXT HREFS BUT NOT data-referer-safe! to fix it took "+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH EXT HREFS BUT NOT data-referer-safe! to check it took "+(Date.now()-start)+"ms")}}}else{$el.find("a[href]:not([rel])").each(function(){var a=$(this);var href=a.attr("href");if(href.indexOf("mailto")===0||href.indexOf("skype")===0)return;if(href&&href!="#"){if(TS.utility.urlNeedsRefererHiding(href)){bads.push(this.outerHTML);a.attr("rel","noreferrer");bads[bads.length-1]+="\n->\n"+this.outerHTML}}else{a.removeAttr("href")}});if(TS.model&&TS.model.team&&TS.boot_data.feature_tinyspeck){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+' LINKS WITH EXT HREFS BUT WITHOUT rel="noreferrer"! to add rel it took '+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+' LINKS WITH EXT HREFS BUT WITHOUT rel="noreferrer"! to check it took '+(Date.now()-start)+"ms")}}}},makeSureAllLinksHaveTargets:function($el){var start=Date.now();var bads=[];$el.find("a[href]:not([target])").each(function(){var a=$(this);var href=a.attr("href");if(href.indexOf("mailto")===0||href.indexOf("skype")===0)return;if(href&&href!="#"){bads.push(this.outerHTML);a.attr("target",href);bads[bads.length-1]+="\n->\n"+this.outerHTML}else{a.removeAttr("href")}});if(TS.model&&TS.model.team&&TS.boot_data.feature_tinyspeck){if(bads.length){TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH HREFS BUT WITHOUT TARGETS! to add targets it took "+(Date.now()-start)+"ms");TS.dir(365,bads)}else{TS.log(365,"#"+$el.attr("id")+" had "+bads.length+" LINKS WITH HREFS BUT WITHOUT TARGETS! to check it took "+(Date.now()-start)+"ms")}}TS.utility.makeSureAllExternalLinksAreRefererSafe($el)},sortTable:function(table,td_index,order,subsort_index,subsort_order){order=order=="desc"?"desc":"asc";subsort_order=subsort_order=="desc"?"desc":"asc";function sortFunc(index){return function(td1,td2){var a=getCellValue(td1,index);var b=getCellValue(td2,index);if($.isNumeric(a)&&$.isNumeric(b)){if(a==b&&subsort_index){a=getCellValue(td1,subsort_index);b=getCellValue(td2,subsort_index);if($.isNumeric(a)&&$.isNumeric(b)){if(subsort_order!=order){return b-a}else{return a-b}}else{if(subsort_order!=order){return b.localeCompare(a)}else{return a.localeCompare(b)}}}return a-b}else{return a.localeCompare(b)}}}function getCellValue(tr,index){return $(tr).children("td").eq(index).attr("data-sort-val")}var rows=table.find("tr:gt(0)").toArray().sort(sortFunc(td_index));if(order=="desc")rows=rows.reverse();for(var i=0;i<rows.length;i++){table.append(rows[i])}},getPercSmartly:function(x,y){if(!x||!y)return"0%";var perc=x/y*100;if(perc!=100&&Math.round(perc)==100)return"99%";if(perc<.7)return"<1%";return Math.round(perc)+"%"},isCursorWithinTBTs:function(input){var p=TS.utility.contenteditable.cursorPosition(input);var val=TS.utility.contenteditable.value(input);var text_before=val.substr(0,p.end);var tbt_before=text_before.match(/```/g);if(!tbt_before)return false;var tbt_before_cnt=tbt_before.length;if(tbt_before_cnt%2)return true;return false},hex2rgb:function(hex){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:undefined},rgb2hex:function(rgb){if(/^#[0-9A-F]{6}$/i.test(rgb))return rgb;var rgb_match=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(!rgb_match){rgb_match=rgb.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*(\d*\.?\d+)\)$/)}if(!rgb_match){return}function hex(x){return("0"+parseInt(x).toString(16)).slice(-2)}return"#"+hex(rgb_match[1])+hex(rgb_match[2])+hex(rgb_match[3])},setImmediate:function(fn){_set_immediate_fn(fn)},immediateDebounce:function(fn){var scheduled=false;return function(){if(scheduled){return}var self=this;var args=arguments;scheduled=true;_set_immediate_fn(function(){scheduled=false;fn.apply(self,args)})}},debounce:function(fn,delay){var timer;return function(){var self=this;var args=arguments;clearTimeout(timer);timer=setTimeout(function(){fn.apply(self,args)},delay)}},throttleFunc:function(func,ms,always_wait){var data={};var funcReplacement=function funcReplacement(){var args=Array.prototype.slice.apply(arguments);var has_complex_args=_.some(args,_.isObject);if(has_complex_args){TS.error("You're passing non-scalar arguments to a function throttled with TS.utility.throttleFunc; it will likely not work as you want")}var key="f-"+args.join("-");if(data[key]&&data[key].context!==this){throw new Error("Cannot use this function with different `this` contexts across different calls "+this+" "+data[key].context)}data[key]=data[key]||{requested:Date.now(),timeout:0,context:this};if(data[key].timeout||funcReplacement.always_wait){data[key].requested=Date.now()}else{func.apply(data[key].context,args)}if(data[key].timeout)return;data[key].timeout=setTimeout(function timerFunc(){var elapsed=Date.now()-data[key].requested;if(elapsed>=ms){func.apply(data[key].context,args);delete data[key]}else{data[key].timeout=setTimeout(timerFunc,ms-elapsed)}},ms)};funcReplacement.always_wait=!!always_wait;return funcReplacement},cmdKey:function(e){if(!e)return false;if(TS.model.is_mac){return!!e.metaKey}else{return!!e.ctrlKey}},looksLikeKeyboardShortcut:function(e){var has_modifier=e.ctrlKey||e.altKey||e.metaKey;if(!has_modifier)return false;if(e.keyCode===TS.utility.keymap.alt||e.keyCode===TS.utility.keymap.ctrl||e.keyCode===TS.utility.keymap.cmd_ff||e.keyCode===TS.utility.keymap.cmd_other||e.keyCode===TS.utility.keymap.cmd_right){return false}var char=String.fromCharCode(e.keyCode);if(/^(\w|[$-/:-?{-~!"^_`\[\]])$/i.test(char))return true;return true},isForwardDeleteKey:function(e){if(e.keyCode===TS.utility.keymap.delete)return true;if(TS.model.is_mac&&e.ctrlKey&&e.key==="d")return true;return false},isBoldKey:function(e){if(!e)return false;return e.keyCode===TS.utility.keymap.b&&TS.utility.cmdKey(e)},isItalicKey:function(e){if(!e)return false;return e.keyCode===TS.utility.keymap.i&&TS.utility.cmdKey(e)},throttle:function(){var defaults,data;defaults={delay:200,timer_group:"generic"};data={timers:{},queues:{}};function processQueue(timer_group){var i,j;if(data.timers[timer_group]){if(data.queues[timer_group]){for(i=0,j=data.queues[timer_group].length;i<j;i++){if(data.queues[timer_group][i]){data.queues[timer_group][i]()}}}data.queues[timer_group]=null;data.timers[timer_group]=null}}function method(func,timer_group,delay){if(!func){return false}timer_group=timer_group||defaults.timer_group;if(!data.timers[timer_group]){delay=delay||defaults.delay;data.timers[timer_group]=window.setTimeout(function(){processQueue(timer_group)},delay)}if(!data.queues[timer_group]){data.queues[timer_group]=[]}if(data.queues[timer_group].indexOf){if(data.queues[timer_group].indexOf(func)===-1){data.queues[timer_group].push(func)}}else{data.queues[timer_group].push(func)}}return{method:method}}(),getImgProxyURL:function(url,width,height){return TS.utility.getImgProxyURLWithOptions(url,{width:width,height:height})},getImgProxyURLWithOptions:function(url,opts){if(!url)return url;if(!TS.boot_data.image_proxy_url)return url;var image_proxy_url=TS.boot_data.image_proxy_url;if(url.indexOf(image_proxy_url)===0)return url;var i,j;var whitelist=getRefererHidingWhiteList();var test_url;if(!opts.emoji&&url.indexOf("https://")===0){test_url=url.replace(/^https:\/\//,"");for(i=0,j=whitelist.length;i<j;i++){if(test_url.indexOf(whitelist[i]+"/")===0){if(TS.boot_data.feature_a11y_pref_no_animation&&whitelist[i]==="slack-imgs.com"){var o1=TS.utility.url.urlQueryStringParse(test_url).o1;var value=TS.model.prefs.a11y_animations===false?o1?o1+".gu":"gu":o1&&o1.replace(/\.gu|gu/,"");return TS.utility.url.setUrlQueryStringValue(url,"o1",value)}return url}}}if(url.indexOf("/img/")===0){return url}image_proxy_url=TS.utility.url.setUrlQueryStringValue(image_proxy_url,"c","1");var optparts=[];var w=parseInt(opts.width);var h=parseInt(opts.height);if(w&&h){optparts.push("wi"+w);optparts.push("he"+h);if(opts.resize&&TS.boot_data.feature_use_imgproxy_resizing){optparts.push("si")}}if(opts.rotate){optparts.push("ro")}if(opts.render_svg){optparts.push("sv2")}if(opts.convert_ico){optparts.push("ip")}if(TS.boot_data.feature_a11y_pref_no_animation&&TS.model.prefs.a11y_animations==false){optparts.push("gu")}if(optparts.length>0){image_proxy_url=TS.utility.url.setUrlQueryStringValue(image_proxy_url,"o1",optparts.join("."))}return TS.utility.url.setUrlQueryStringValue(image_proxy_url,"url",url)},rAF:function(){var vendors=["ms","moz","webkit","o"];var requestAnimationFrame=window.requestAnimationFrame;var x;for(x=0;x<vendors.length&&!requestAnimationFrame;x++){requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"]}if(!requestAnimationFrame){var last_time=0;return function(callback){var curr_time=Date.now();var time_to_call=Math.max(0,16-(curr_time-last_time));var id=window.setTimeout(function(){callback(curr_time+time_to_call)},time_to_call);last_time=curr_time+time_to_call;return id}}return function(fn){return requestAnimationFrame.call(window,fn)}}(),cancelRAF:function(){var vendors=["ms","moz","webkit","o"];var cancelAnimationFrame=window.cancelAnimationFrame;var x;for(x=0;x<vendors.length&&!cancelAnimationFrame;x++){cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!cancelAnimationFrame){return function(id){clearTimeout(id)}}return function(id){cancelAnimationFrame.call(window,id)}}(),queueRAF:function(rafCallback){if(TS.boot_data&&TS.boot_data.feature_js_raf_queue){_rafQueue.add(rafCallback)}else{rafCallback()}},startAnimation:function(callback){return _animationManager.subscribe(callback)},getLocationHashString:function(doc){doc=doc||document;var hash=doc.location.hash;if(hash&&hash.length)return hash.substr(1);return hash},loadUrlInWindowIfOnline:function(url,doc){doc=doc||document;TS.api.call("api.test",{},function(ok,data,args){if(ok){$("body").addClass("hidden");doc.location=url}else{TS.generic_dialog.alert("You can't perform that action because you are not online :(")}})},externalURLsNeedRedirecting:function(){if(TS.boot_data.feature_no_redirects_in_ssb){if(TS.model.team&&TS.model.team.prefs&&TS.model.team.prefs.hide_referers&&!TS.model.is_our_app)return true}else{if(TS.model.team&&TS.model.team.prefs&&TS.model.team.prefs.hide_referers)return true}return false},swapInRedirUrlForIframe:function(html,referer_policy){referer_policy=referer_policy||_getRefererPolicy();if(!referer_policy)return html;if(!referer_policy.iframe_redirect_type)return html;var $html=$(html);var src=$html.attr("src");if(!src)return html;if(TS.qs_args["test_iframe_referers"]=="1"){src="https://"+document.location.host+"/referertester.html?"+Date.now()}src="https://"+TS.boot_data.redir_domain+"/link?v="+referer_policy.iframe_redirect_type+"&url="+encodeURIComponent(src);$html.attr("src",src);html=$html[0].outerHTML;if(TS.qs_args["test_iframe_referers"]=="1"){TS.info("html with redir:"+html)}return html},getPlaceholderHTMLFromIframe:function(html){html=html.replace(/<iframe/,"<div").replace(/<\/iframe/,"</div");var $html=$(html);$html.css("height",$html.attr("height")+"px").css("width",$html.attr("width")+"px").attr("data-real-src",$html.attr("src")).attr("src","").addClass("iframe_placeholder");html=$html[0].outerHTML;return html},getIframeHTMLFromPlaceholder:function(html){html=html.replace(/<div/,"<iframe").replace(/<\/div/,"</iframe");var $html=$(html);$html.attr("src",$html.data("real-src")).removeClass("iframe_placeholder");html=$html[0].outerHTML;return html},isArrowKey:function(which){var keymap=TS.utility.keymap;if(which==keymap.down)return true;if(which==keymap.up)return true;if(which==keymap.right)return true;if(which==keymap.left)return true;return false},isPageKey:function(which){var keymap=TS.utility.keymap;if(which==keymap.pageup)return true;if(which==keymap.pagedown)return true;if(which==keymap.home)return true;if(which==keymap.end)return true;return false},isNumericKey:function(which){if(which>=48&&which<=57)return true;return false},getFileIDFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));var files_url_parser=document.createElement("a");files_url_parser.href=TS.model.files_url;var files_url_hostname=files_url_parser.host;var input_url_parser=document.createElement("a");input_url_parser.href=url;var pathname=input_url_parser.pathname;while(pathname.indexOf("/")===0){pathname=pathname.substr(1)}var valid_hostnames=[files_url_hostname,"files.dev.slack.com","files.staging.slack.com","files.slack.com"];if(valid_hostnames.indexOf(input_url_parser.host)===-1){return null}var file_id;var pathname_parts;if(pathname.indexOf("files/")===0){pathname_parts=pathname.split("/");if(pathname_parts.length<3)return null;var member_name=pathname_parts[1];if(!member_name)return null;if(TS.boot_data.feature_file_id_from_url_update){if(!(TS.members.getMemberByName(member_name)||TS.members.getMemberById(member_name)))return null}else{if(!TS.members.getMemberByName(member_name))return null}file_id=pathname_parts[2]}else if(pathname.indexOf("files-pri/")===0){pathname_parts=pathname.split("/");if(pathname_parts.length<3)return null;var file_desc=pathname_parts[1];if(file_desc.indexOf("-")<0)return null;var file_desc_elems=file_desc.split("-");if(file_desc_elems.length!==2)return null;file_id=file_desc_elems[1]}else{return null}if(!file_id)return null;if(file_id.substr(0,1)!="F")return null;if(file_id.length<2)return null;if(file_id.length>15)return null;return file_id},getBotIDFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));url=url.replace("https://","").replace("http://","");var bots_url=TS.model.bots_url.replace("https://","").replace("http://","");if(url.indexOf(bots_url)===0){url=url.replace(bots_url,"services")}while(url.indexOf("/")===0){url=url.substr(1)}if(url.indexOf("services/")!==0)return null;var A=url.split("/");if(A.length<2)return null;var bot_id=A[1];if(!bot_id)return null;if(bot_id.substr(0,1)!="B")return null;if(bot_id.length<2)return null;if(bot_id.length>15)return null;return bot_id},getMemberIdFromURL:function(url){if(!url)return null;url=TS.utility.normalizeDevHost(String(url));url=url.replace("https://","").replace("http://","");var team_url=TS.model.team_url.replace("https://","").replace("http://","");if(url.indexOf(team_url)===0){url=url.replace(team_url,"team")}while(url.indexOf("/")===0){url=url.substr(1)}if(url.indexOf("team/")!==0)return null;var A=url.split("/");if(A.length<2)return null;var member_name=A[1];if(!member_name)return null;var member;if(TS.boot_data.feature_name_tagging_client){member=TS.members.getMemberById(member_name)||TS.members.getMemberByName(member_name)}else{member=TS.members.getMemberByName(member_name)}if(member)return member.id;return null},normalizeDevHost:function(url){return url.replace(/\.dev[0-9]*.slack.com/i,".dev.slack.com").replace(/\.staging.slack.com/i,".slack.com")},platformSupportsHtmlNotifications:function(){if(TS.model.win_ssb_version&&window.winssb){if(window.winssb.app.canShowHtmlNotifications){return window.winssb.app.canShowHtmlNotifications()}else{return window.winssb.app.willUseHwAcceleration!==false}}return false},platformSupportsImgEmojiInHtmlNotifications:function(){return TS.model.win_ssb_version&&(TS.model.win_ssb_version>.9||TS.model.win_ssb_version==.9&&TS.model.win_ssb_version_minor>=5)},findAllTeamEmojiInStr:function(str,unique){str=$.trim(str);var A=[];if(!str)return A;A=str.match(TS.emoji.getColonsRx())||A;var extras=[];A=A.filter(function(colon_name){if(TS.emoji.isValidName(colon_name)){return true}colon_name.split("::").forEach(function(partial_colon_name){var name=TS.emoji.isValidName(partial_colon_name);if(!name)return;extras.push(":"+name+":")});return false});A=A.concat(extras);if(unique)A=_.uniq(A);TS.dir(248,A);return A},areSimpleObjectsEqual:function recurse(x,y){if(x===y)return true;if(x===undefined&&y)return false;if(y===undefined&&x)return false;if(typeof x!==typeof y)return false;if(x===null&&y)return false;if(y===null&&x)return false;if(x.length!==y.length)return false;var p;for(p in y){if(typeof x[p]=="undefined"&&typeof y[p]!="undefined")return false;if(y[p]){switch(typeof y[p]){case"object":if(!recurse(x[p],y[p]))return false;break;case"function":if(String(y[p])!=String(x[p]))return false;break;default:if(y[p]!==x[p])return false}}else{if(x[p])return false}}for(p in x){if(typeof y[p]=="undefined"&&typeof x[p]!="undefined")return false}return true},deepDiffObjects:function(base,comparison){if(_.isEmpty(base)){return{}}else if(_.isEmpty(comparison)){return base}var result={};_.each(base,function(base_value,key){var comparison_value=comparison[key];if(comparison_value===base_value)return;if(typeof base_value!==typeof comparison_value){result[key]=base_value}else if(_.isArray(base_value)){result[key]=_.difference(base_value,comparison_value)}else if(_.isPlainObject(base_value)){var diff=TS.utility.deepDiffObjects(base_value,comparison_value);if(!_.isEmpty(diff)){result[key]=diff}}else{result[key]=base_value}});return result},appendLogToUrlWithLimit:function(url,log){if(!url)return url;url+=url.indexOf("?")==-1?"?":"&";if(!log)return url;var log_limit=2e3-url.length;return url+log.substr(0,log_limit)},makeWebWorker:function(worker_func_str,onmessage){var url=URL.createObjectURL(new Blob(["(",worker_func_str,")()"],{type:"application/javascript"}));var worker=new Worker(url);URL.revokeObjectURL(url);worker.onmessage=onmessage;return worker},extractAllModelObIds:function(ob,source){source=source&&String(source)||"";var is_search=source.substr(0,7)=="search.";var c_ids=[];var seens=[];var isPropertyAChannelIdThatNeedsChecking=function(name,parent_name){if(name=="channel")return true;if(name=="id"&&is_search&&parent_name=="channel")return true;return false};var worker=function(ob,parent_name){if(typeof ob!=="object")return;seens.push(ob);var k;var val;for(k in ob){val=ob[k];if(typeof val==="string"){if(isPropertyAChannelIdThatNeedsChecking(k,parent_name)){if(TS.utility.strLooksLikeAChannelId(val)){TS.utility.ensureInArray(c_ids,val)}}else{TS.format.extractIds(val).c_ids.forEach(function(id){TS.utility.ensureInArray(c_ids,id)})}}}for(k in ob){val=ob[k];if(typeof val==="object"){if(seens.indexOf(val)!=-1)continue;if(Array.isArray(val)&&(k==="channels"||k==="ims"||k==="groups")){val.forEach(function(c_id){if(typeof c_id==="string"){TS.utility.ensureInArray(c_ids,c_id)}})}else{worker(val,k)}}}};worker(ob,"_DATA");if(source==="search.messages"&&TS.boot_data.page_needs_enterprise&&TS.boot_data.feature_enterprise_search_ui){_excludeNonLocalModelObs(ob,c_ids)}if(TS.shouldLog("794")){_doubleCheckIdExtraction(ob,source,c_ids,_double_check_ids_channel_rx)}return c_ids},extractAllMemberIds:function(ob,source,channel_id){source=source&&String(source)||"";var m_ids=[];var c_ids=[];var t_ids=[];var seens=[];var isPropertyAMemberIdThatNeedsChecking=function(name,parent_name){if(name=="user")return true;if(name=="inviter")return true;if(name=="accepted_user")return true;return false};var worker=function(ob,parent_name){if(typeof ob!=="object")return;seens.push(ob);var k;var val;for(k in ob){val=ob[k];if(typeof val==="string"){if(isPropertyAMemberIdThatNeedsChecking(k,parent_name)){if(TS.utility.strLooksLikeAMemberId(val)){if(TS.utility.ensureInArray(m_ids,val)){c_ids.push(typeof ob.channel=="string"&&ob.channel||typeof ob.channel=="object"&&ob.channel&&ob.channel.id||channel_id||undefined);t_ids.push(typeof ob.team=="string"&&ob.team||typeof ob.team=="object"&&ob.team&&ob.team.id||undefined)}}}else{TS.format.extractIds(val).m_ids.forEach(function(id){if(TS.utility.ensureInArray(m_ids,id)){c_ids.push(undefined);t_ids.push(undefined)}})}}}for(k in ob){val=ob[k];if(typeof val==="object"){if(seens.indexOf(val)!=-1)continue;if(Array.isArray(val)&&(k==="members"||k==="users")){val.forEach(function(m_id){if(TS.utility.strLooksLikeAMemberId(m_id)){if(TS.utility.ensureInArray(m_ids,m_id)){c_ids.push(typeof ob.id=="string"&&ob.channel||channel_id||undefined);t_ids.push(typeof ob.team=="string"&&ob.team||typeof ob.team=="object"&&ob.team&&ob.team.id||undefined)}}})}else{worker(val,k)}}}};worker(ob,"_DATA");if(TS.shouldLog("794")){_doubleCheckIdExtraction(ob,source,m_ids,_double_check_ids_member_rx)}return{c_ids:c_ids,t_ids:t_ids,m_ids:m_ids}},extractAllBotIds:function(ob){var bot_ids=ob.bot_id?[ob.bot_id]:[];_.values(ob).forEach(function(val){if(_.isObject(val)){var new_bot_ids=TS.utility.extractAllBotIds(val);bot_ids.push(new_bot_ids)}else if(_.isString(val)){var new_bot_ids=_(TS.utility.findUrls(val)).map(TS.utility.getBotIDFromURL).compact().value();bot_ids.push(new_bot_ids)}});return _(bot_ids).flatten().uniq().value()},strLooksLikeAChannelId:function(str){if(typeof str!=="string"||str.length<9)return false;if(str&&TS.model.channel_id_prefixes.indexOf(str.charAt(0))>-1)return true;return false},strLooksLikeAMemberId:function(str){if(typeof str!=="string"||str.length<9)return false;if(str&&(str.charAt(0)=="U"||str.charAt(0)=="W"))return true;return false},truncateToNearestWordBoundary:function(str,len){if(str.length<=len)return str;var ellipsis="";var truncated_str=str.substring(0,len);var last_space_idx=truncated_str.lastIndexOf(" ");if(last_space_idx>0&&last_space_idx>len-5){return truncated_str.substring(0,last_space_idx)+ellipsis}return truncated_str.substring(0,truncated_str.length-1)+ellipsis},truncateAndEscape:function(str,len){if(str.length<=len)return TS.utility.htmlEntities(str);return TS.utility.htmlEntities(str.substring(0,len-1))+"&hellip;"},isSpaceClickEventSafe:function(e,check_only){if(e.target){var $link=$(e.target).closest("[href]");if(!$link[0])return true;if(!$link.closest(".post_body").length&&!$link.closest("ts-rocket").length)return true;var protocol=$link[0].protocol;if(protocol&&/^https?:$/.test(protocol)===false){TS.warn("not following bad link from a post preview");e.preventDefault();return false}if($link.data("original-href")){TS.warn("not following possibly spoofed link from a post preview");e.preventDefault();var url=$link.data("referer-original-href")||$link.attr("href");if(!check_only)_spaceUnsafeLinkDialog($link.data("original-href"),$link.attr("href"),url);return false}}return true},getCachedScript:function(url,options){options=$.extend(options||{},{dataType:"script",cache:true,url:url});return jQuery.ajax(options)},disableElement:function($el,disabled){$el=$($el);$el.attr("disabled",disabled);$el.attr("aria-disabled",disabled)},pluralize:function(number,singular,plural){number=parseInt(number);if(number===1){return singular}return typeof plural==="string"?plural:singular+"s"},strToApparentlyRndPerc:function(str){return parseFloat("."+TS.utility.strToApparentlyRndNum(str))},strToApparentlyRndNum:function(str){if(!str)return NaN;str=String(str);var middle=str.substr(Math.round(str.length/2),1);str=middle+str.split("middle").reverse().join();var digits="";for(var i=str.length-1;i>-1;i--){digits+=(str.charCodeAt(i)*(i+1)).toString().substr(-1,1)}return parseInt(digits)},enableFeatureForUser:function(percentage){if(percentage<0||percentage>100){TS.warn("TS.utility.enableFeatureForUser() expects a number between 0 and 100");return false}return _.random(0,100)<percentage},getA11yFontSizeMultiplier:function(){if(TS.model&&TS.model.prefs){if(TS.model.prefs.a11y_font_size==="110"){return 1.1}else if(TS.model.prefs.a11y_font_size==="125"){return 1.25}else if(TS.model.prefs.a11y_font_size==="150"){return 1.5}}return 1},roundToThree:function(num){return+(Math.round(num+"e+3")+"e-3")},convertBytesToMegabytes:function(bytes){return bytes/1024/1024},convertKilobytesToMegabytes:function(kilobytes){return kilobytes/1024},queryIsMaybeSelf:function(query){query=_.toLower(query);return query==="me"||query==="you"},test:{clearAndGetRefererPolicy:function(){_referer_policy=undefined;return _getRefererPolicy()},getRefererPolicy:function(){return _getRefererPolicy()},rafQueue:function(){return _rafQueue}}});var _parser;var _double_check_ids_channel_rx=/(?:"|<#)([CGD][0-9a-zA-Z]{8,10})(?:"|\||\>)/g;var _double_check_ids_member_rx=/(?:"|<@)([WU][0-9a-zA-Z]{8,10})(?:"|\||\>)/g;var _spaceUnsafeLinkDialog=function(originalUrl,actionUrl,safeUrl){var title="",body="";title+='<ts-icon class="ts_icon_warning yolk_orange small_right_margin"></ts-icon> ';title+="Caution: Tricky Link";body+="<p>";body+='  <span class="inline_block">The link you clicked (<strong>'+TS.utility.htmlEntities(safeUrl)+"</strong>) is tricky.</span>";body+='  <span class="inline_block">It has been formatted to look like another web address (<strong>'+TS.utility.htmlEntities(originalUrl)+"</strong>).</span>";body+="</p>";body+="<p>Are you sure you want to follow it?</p>";TS.generic_dialog.start({title:title,body:body,show_cancel_button:false,show_secondary_go_button:true,secondary_go_button_text:"Lets risk it",secondary_go_button_class:"btn_outline",onSecondaryGo:function(){window.open(actionUrl)},go_button_text:"Take me back to safety",esc_for_ok:true,enter_always_gos:true})};var _doubleCheckIdExtraction=function(ob,source,ids,rx){var trueMatches=function(str,rx){var A=[];var match;while(match=rx.exec(str)){A.push(match[1])}return A};var json_str=JSON.stringify(ob);var A=_.uniq(trueMatches(json_str,rx));if(A.length!=ids.length){TS.warn(source+"   A: "+A.join(", "));TS.info(source+" ids: "+ids.join(", "));if(A.length>ids.length){TS.info(source+" dif: "+_.difference(A,ids).join(", "))}else{TS.info(source+" dif: "+_.difference(ids,A).join(", "))}}};var _referer_policy;var _getRefererPolicy=function(){if(!_.isUndefined(_referer_policy))return _referer_policy;var data=window.boot_data;if(!data){TS.warn("window.boot_data not available");_referer_policy=null;return _referer_policy}if(!data.feature_referer_policy&&TS.qs_args["test_iframe_referers"]!="1"){_referer_policy=null;return _referer_policy}var def={iframe_redirect_type:4,redirect_type:3,rewrite_on_right_click:true};var can_warn=window.console!==undefined&&console.warn;if(!window.bowser){if(can_warn)console.warn("window.bowser undefined, defaulting to restrictive referrer policy");_referer_policy=def;return _referer_policy}if(bowser.chrome&&bowser.version>=4.1||bowser.opera&&bowser.version>=15){_referer_policy={iframe_redirect_type:4,redirect_type:null,rewrite_on_right_click:false};return _referer_policy}if(bowser.ie){_referer_policy={iframe_redirect_type:4,
redirect_type:3,rewrite_on_right_click:true};return _referer_policy}if(bowser.firefox){_referer_policy={iframe_redirect_type:bowser.version>=36?4:2,redirect_type:3,rewrite_on_right_click:bowser.version>=36?false:true};return _referer_policy}if(bowser.safari&&bowser.version>=5||navigator.userAgent.match(/(Slack_SSB)/g)){_referer_policy={iframe_redirect_type:2,redirect_type:null,rewrite_on_right_click:false};return _referer_policy}if(can_warn)console.warn("browser not recognized, defaulting to restrictive referrer policy");_referer_policy=def;return def};var _referer_hiding_whitelist=null;window.getRefererHidingWhiteList=function(){if(_referer_hiding_whitelist)return _referer_hiding_whitelist;_referer_hiding_whitelist=[TS.model.team.domain+".dev.slack.com",TS.model.team.domain+".staging.slack.com",TS.model.team.domain+".slack.com","files.staging.slack.com","files.dev.slack.com","files.slack.com","dev.slack-files.com","staging.slack-files.com","www.slack-files.com","slack-files.com","slack-imgs.com","dev.slack.com","slack.com",TS.boot_data.redir_domain,"my.slack.com","www.slack.com"];for(var i=0;i<205;i++){_referer_hiding_whitelist.push(TS.model.team.domain+".dev"+i+".slack.com");_referer_hiding_whitelist.push("files.dev"+i+".slack.com");_referer_hiding_whitelist.push("dev"+i+".slack-files.com");_referer_hiding_whitelist.push("dev"+i+".slack.com")}return _referer_hiding_whitelist};var URL_REGEXP=/((ftp|http|https)\:\/\/|\bw{3}\.)[a-z0-9\-\.]+[a-z]+(:[a-z0-9]*)?\/?([@a-z0-9\-\._\?\,\'\/\\\+&amp;%\:!$#\=~])*/gi;var _set_immediate_fn=window.setImmediate;if(!_set_immediate_fn){if(window.MutationObserver){var hiddenDiv=document.createElement("div");var callbacks=[];new MutationObserver(function(records){var cbList=callbacks.slice();callbacks.length=0;cbList.forEach(function(callback){callback()})}).observe(hiddenDiv,{attributes:true});_set_immediate_fn=function(callback){if(!callbacks.length){hiddenDiv.setAttribute("yes","no")}callbacks.push(callback)}}else{_set_immediate_fn=function(fn){setTimeout(fn,0)}}}var _rafQueue=function(){var items=[];var is_running=false;function processItems(){items.forEach(function(animation){animation()});items=[];is_running=false}function addItem(fn,allow_duplicate){if(allow_duplicate||items.indexOf(fn)===-1){items.push(fn)}if(!is_running&&items.length){is_running=true;TS.utility.rAF(processItems)}}return{add:addItem}}();var _animationManager=function(){var is_running=false;var subscribers=[];function redrawLoop(){if(!is_running){return}subscribers.forEach(function(animation){animation()});TS.utility.rAF(redrawLoop)}function subscribe(fn){var ret={start:function(){subscribers.push(fn);if(!is_running){is_running=true;TS.utility.rAF(redrawLoop)}},stop:function(){subscribers.splice(subscribers.indexOf(fn),1);if(!subscribers.length){is_running=false}}};ret.start();return ret}return{subscribe:subscribe,subscribers:subscribers,isRunning:function(){return is_running}}}();function _excludeNonLocalModelObs(ob,c_ids){var current_team_id=TS.model.team.id;_.remove(c_ids,function(c_id){var match=_.find(ob.messages.matches,function(o){return o.channel.id==c_id},this);var is_shared=_.get(match,"channel.is_shared")||_.get(match,"channel.is_org_shared");if(match&&_.get(match,"team")!=current_team_id&&_.startsWith(c_id,"C")&&!is_shared){return c_id}})}})();(function(){"use strict";TS.registerModule("utility.url",{setUrlQueryStringValue:function(url,key,value){var a=document.createElement("a");a.href=url;var qs=a.search?a.search.slice(1):"";a.search=TS.utility.url.setQueryStringValue(qs,key,value);return a.href},removeUrlQueryStringValue:function(url,key){var a=document.createElement("a");a.href=url;if(!a.search){return url}var qs=a.search.slice(1);a.search=TS.utility.url.removeQueryStringValue(qs,key);return a.href},urlQueryStringParse:function(url){var a=document.createElement("a");a.href=url;if(!a.search)return{};var qs=a.search?a.search.slice(1):"";return TS.utility.url.queryStringParse(qs)},queryStringParse:function(qs){var args={};var pairs;pairs=qs.split("&");for(var i=0;i<pairs.length;i++){var p=pairs[i].indexOf("=");if(p!=-1){var name=pairs[i].substring(0,p);var value=pairs[i].substring(p+1);args[name]=unescape(value)}}return args},setQueryStringValue:function(qs,key,value){var args=TS.utility.url.queryStringParse(qs);args[key]=value;return TS.utility.url.queryStringEncode(args)},removeQueryStringValue:function(qs,key){var args=TS.utility.url.queryStringParse(qs);if(!args.hasOwnProperty(key)){return qs}delete args[key];return TS.utility.url.queryStringEncode(args)},queryStringEncode:function(args){if(!args)return"";if(Object.keys(args).length==0)return"";var key_value_pairs=Object.keys(args).map(function(key){return encodeURIComponent(key)+"="+encodeURIComponent(args[key])});return"?"+key_value_pairs.join("&")}})})();(function(){"use strict";TS.registerModule("utility.process_nicely",{process:function(arr,fn,start_index,traverse_backwards){if(_.isUndefined(start_index)){start_index=traverse_backwards?arr.length-1:0}var end_index=traverse_backwards?-1:arr.length;var step=traverse_backwards?-1:1;return new Promise(function(resolve){var t0=performance.now();var max_processing_time_ms=10;var i;for(i=start_index;i!=end_index;i+=step){var item=arr[i];fn(item);var more_work_to_do=i+step!=end_index;var out_of_time=performance.now()-t0>max_processing_time_ms;if(more_work_to_do&&out_of_time){return TS.utility.rAF(function(){return TS.utility.process_nicely.process(arr,fn,i+1,traverse_backwards).then(resolve)})}}resolve()})},processRight:function(arr,fn,start_index){var traverse_backwards=true;return TS.utility.process_nicely.process(arr,fn,start_index,traverse_backwards)}})})();(function(){"use strict";TS.registerModule("utility.invites",{onStart:function(){},hideFullMemberInviteOption:function(){var team_in_enterprise_org=TS.boot_data.page_needs_enterprise;var is_saml_team=TS.model.team.prefs.auth_mode==="saml";var saml_settings_prevent_full_member_invites=TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1;if(team_in_enterprise_org)return false;return team_in_enterprise_org||is_saml_team&&saml_settings_prevent_full_member_invites}})})();(function(){"use strict";TS.registerModule("format",{hex_rx:/(\W|^)(#[A-Fa-f0-9]{6})(\b)/g,replaceUnicodeDoppelgangers:function(txt){if(!txt)return"";txt=txt.replace(_diacritics_rx,"");txt=txt.replace(/\u00A0/g," ");txt=txt.replace(/\u000D/g,"\n");txt=txt.replace(/\u000A/g,"\n");return txt},replaceHighlightMarkers:function(txt,start_replacement,end_replacement){if(!txt)return"";start_replacement=start_replacement||"";end_replacement=end_replacement||"";return txt.replace(/\ue000/g,start_replacement).replace(/\ue001/g,end_replacement)},hasOnlyValidMemberIds:function(txt){if(!_.isString(txt))return true;return _.every(txt.match(_at_mention_rx),TS.members.getMemberById)},hasMentions:function(txt){if(!_.isString(txt))return false;var txt_escaped=TS.utility.htmlEntities(txt);var has_mention=false;txt_escaped.replace(_at_mention_rx,function(match,boundry,at_member_id,member_id){var valid=_validateModelObByIdOrName(TS.members.getMemberById,member_id,TS.members.getMemberByName,at_member_id);if(!has_mention&&valid.model_ob)has_mention=true});return has_mention},formatSlugs:function(txt,cursor_pos){if(!_.isString(txt))txt="";if(!_.isInteger(cursor_pos))cursor_pos=0;var new_cursor_pos=cursor_pos;var txt_escaped=TS.utility.htmlEntities(txt);var new_html=txt_escaped.replace(_at_mention_rx,function(match,boundry,at_member_id,member_id,offset,string){var extra="";if(member_id.length>TS.model.member_id_length){extra=member_id.slice(TS.model.member_id_length);member_id=member_id.slice(0,TS.model.member_id_length);at_member_id="@"+member_id}var valid=_validateModelObByIdOrName(TS.members.getMemberById,member_id,TS.members.getMemberByName,at_member_id);var member=valid.model_ob;if(!member)return match;var slug=_getMemberSlug(member);var start=offset+boundry.length;if(start<cursor_pos){new_cursor_pos-=at_member_id.length-slug.txt.length}return boundry+slug.html+extra});return{cursor:{end:new_cursor_pos,length:0,start:new_cursor_pos},html:new_html}},cleanMsg:function(txt){return _cleanMsgText(txt,{do_specials:true})},cleanInternalMsg:function(txt){return _cleanMsgText(txt,{do_specials:false})},cleanCommandText:function(txt){if(!TS.boot_data.feature_name_tagging_client)return txt;return _cleanMsgText(txt,{do_specials:true,human_readable:true})},doEmoticonConversion:function(str){_emoticon_conversion_token_map.length=0;str=str.replace(_special_pre_rx,_emoticonConversionTokenReplacer);str=str.replace(_special_code_rx,_emoticonConversionTokenReplacer);str=str.replace(_special_quote_rx,_emoticonConversionTokenReplacer);str=TS.emoji.replaceEmoticons(str);str=TS.format.deTokenizeStr(_emoticon_conversion_token_map,str);return str},tokenizeStr:function(token_map,str,boundary){if(!str)return"";boundary=boundary||"";var nl=str.indexOf("\n")===0?"\n":"";var token=_encodeSpecialFormattingCharsAndColon(nl+_token_base+_token_cnt++ +Date.now());token=boundary+token+boundary;token_map.push({str:str,token:token});return token},deTokenizeStr:function(token_map,str){var item;var i=token_map.length-1;for(i;i>-1;i--){item=token_map[i];str=str.replace(item.token,item.str.replace(/\$/g,"$$$$"))}return str},unFormatMsg:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{for_edit:true})},formatJustText:function(txt){return TS.format.formatWithOptions(txt)},formatDefault:function(txt,msg){return TS.format.formatWithOptions(txt,msg)},formatNoHighlightsNoSpecials:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{no_highlights:true,no_specials:true})},formatNoHighlightsNoSpecialsNoInlineImgs:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{no_highlights:true,no_specials:true,do_inline_imgs:false})},formatNoHighlightsNoInlineImgs:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{do_inline_imgs:false,no_highlights:true})},formatNoSpecials:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{no_specials:true})},formatNotification:function(txt,msg){return TS.format.formatWithOptions(txt,msg,{for_growl:true})},extractIds:function(txt){var c_ids=[];var m_ids=[];var matches=txt.match(/<[#@]+(.*?)>/g);if(matches){matches.forEach(function(item){var guts;var id;if(item.indexOf("<@")===0){guts=item.replace(/<|>/g,"");id=TS.utility.msgs.getMemberIdFromMemberMarkup(guts);if(TS.utility.strLooksLikeAMemberId(id)){TS.utility.ensureInArray(m_ids,id)}}else{guts=item.replace(/<|>|#/g,"");id=guts.split("|")[0];if(TS.utility.strLooksLikeAChannelId(id)){TS.utility.ensureInArray(c_ids,id)}}})}return{c_ids:c_ids,m_ids:m_ids}},calculateOptions:function(msg,opts){return _calculateOptions(msg,opts)},formatWithOptions:function(txt,msg,opts){if(!$.trim(txt))return"";var format_options=_calculateOptions(msg,opts);var formatted=_format(txt,msg,format_options);return formatted},applyStringifyTransformsToChildren:function(container,options){if(!container)return false;if(!_.isObject(options))options={};if(!container.childElementCount)return false;var is_single_lonely_node=container.childNodes.length===1&&container.firstChild.nodeType===1&&container.firstChild.hasAttribute("data-stringify-requires-siblings");if(is_single_lonely_node)return;_.each(container.querySelectorAll("pre br"),function(br){br.parentElement.replaceChild(document.createTextNode("\n"),br)});var transformed_children=_.filter(container.querySelectorAll("*"),function(el){if(!_hasStringifyTransformations(el))return false;if(_.isFunction(options.excludeFn)&&options.excludeFn(el))return false;var new_text;if(_.isFunction(options.customFn)&&options.customFn(el)){new_text=options.customFn(el)}else{new_text=TS.format.stringifyNode(el)}var was_changed=new_text!==el.textContent;if(was_changed)el.textContent=new_text;return was_changed});return transformed_children.length>0},formatSelection:function(selection,options){if(!selection||!selection.rangeCount)return"";if(!_.isObject(options))options={};if(selection.rangeCount!==1){TS.info("TS.format.formatSelection: found "+selection.rangeCount+" ranges")}if(TS.boot_data.feature_better_msg_copying){var range=selection.getRangeAt(0);var selection_text;if(_.isElement(range.commonAncestorContainer)){var container_clone=range.commonAncestorContainer.cloneNode();container_clone.appendChild(range.cloneContents());container_clone.classList.add("offscreen","user_select_text");range.commonAncestorContainer.parentElement.appendChild(container_clone);if(container_clone.lastChild&&!container_clone.lastChild.textContent){container_clone.removeChild(container_clone.lastChild)}TS.format.applyStringifyTransformsToChildren(container_clone,options);var restore=TS.selection.snapshot();var selection=TS.selection.selectNodeContents(container_clone);selection_text=selection.toString();container_clone.parentElement.removeChild(container_clone);restore()}else{selection_text=selection.toString()}selection_text=TS.format.replaceUnicodeDoppelgangers(selection_text);selection_text=selection_text.replace(/^\n+/,"");selection_text=selection_text.replace(/\n+$/,"");return selection_text}var text=selection.toString();var range=selection.getRangeAt(0);var $start_node=$(range.startContainer);var $end_node=$(range.endContainer);_.each(_diacritic_map,function(def){var start_rx=new RegExp(def.start_mark,"g");text=text.replace(start_rx,def.start_symbol)});text=TS.format.replaceUnicodeDoppelgangers(text);var start_format_symbol=$start_node.data("format-symbol")||$start_node.parent().data("format-symbol");if(start_format_symbol&&!_.startsWith(text,start_format_symbol)){text=start_format_symbol+text}var end_format_symbol=$end_node.data("format-symbol")||$end_node.parent().data("format-symbol");if(end_format_symbol&&!_.endsWith(text,end_format_symbol)){text+=end_format_symbol}var is_single_formatted_block=_.some(_diacritic_map,function(def){var rx=new RegExp("\\"+def.start_symbol,"g");var matches=text.match(rx);return matches&&matches.length===2&&_.startsWith(text,matches[0])&&_.endsWith(text,matches[1])});if(is_single_formatted_block)return text.slice(1,-1);return text},formatSelectionAsHTML:function(selection){if(!selection||!selection.rangeCount)return"";if(selection.rangeCount!==1){TS.info("TS.format.formatSelection: found "+selection.rangeCount+" ranges")}var range=selection.getRangeAt(0);var placeholder=document.createElement("div");placeholder.appendChild(range.cloneContents());return placeholder.innerHTML},stringifyNode:function(node){if(!node)return"";if(!_hasStringifyTransformations(node))return node.textContent;var str=node.textContent;_.each(_stringify_transform_attrs,function(transformFn,attr){if(node.hasAttribute(attr))str=transformFn(node,str)});return str},swapInAts:function(txt){if(!txt)return txt;return txt.replace(new RegExp(_at_symbol_token,"g"),"@").replace(new RegExp(_dash_symbol_token,"g"),"-").replace(new RegExp(_underscore_symbol_token,"g"),"_")},swapOutAts:function(txt){if(!txt)return txt;return txt.replace(/@/g,_at_symbol_token).replace(/\-/g,_dash_symbol_token).replace(/\_/g,_underscore_symbol_token)},test:function(){var test_obj={encodeSpecialFormattingChars:_encodeSpecialFormattingChars,encodeSpecialFormattingCharsAndColon:_encodeSpecialFormattingCharsAndColon,getTokenMap:_getTokenMap};Object.defineProperty(test_obj,"_hasStringifyTransformations",{get:function(){return _hasStringifyTransformations},set:function(value){_hasStringifyTransformations=value}});return test_obj}});var _at_commands=["everyone","channel","group","here"];var _theme_rx=/((?:#[A-Fa-f0-9]{6} {0,}, {0,}){7})(#[A-Fa-f0-9]{6})(\b)/g;var _at_mention_rx=/(^|\s|\(|&gt;|\*|_|\/)(@([\w|.|-]+))/g;if(TS.boot_data.feature_wrapped_mention_parsing){_at_mention_rx=/(^|\s|\(|&gt;|&lt;|\*|_|\/|"|||')(@([\w|.|-]+))/g}var _special_pre_rx=/(^|\s|[_*\?\.,\-!\^;:{(\[%$#+=\u2000-\u206F\u2E00-\u2E7F"])```([\s\S]*?)?```(?=$|\s|[_*\?\.,\-!\^;:})\]%$#+=\u2000-\u206F\u2E00-\u2E7F"])/g;var _special_code_rx=/(^|\s|[\?\.,\-!\^;:{(\[%$#+=\u2000-\u206F\u2E00-\u2E7F"])\`([^`]*?\S *)?\`/g;var _special_quote_rx=/(^|\n)&gt;(?![\W_](?:&lt;|&gt;|[\|\/\\\[\]{}\(\)Dpb](?=\s|$)))(([^\n]*)(\n&gt;[^\n]*)*)/g;var _diacritic_inside="";var _diacritic_outside="\ufeff";var _diacritics_rx=new RegExp("("+_diacritic_outside+"|"+_diacritic_inside+")","g");var _diacritic_map={code:{start_mark:_diacritic_outside+_diacritic_inside+_diacritic_inside+_diacritic_inside+_diacritic_inside,start_symbol:"`",end_mark:_diacritic_inside+_diacritic_inside+_diacritic_inside+_diacritic_inside+_diacritic_outside,end_symbol:"`"},bold:{start_mark:_diacritic_outside+_diacritic_inside+_diacritic_inside+_diacritic_inside,start_symbol:"*",end_mark:_diacritic_inside+_diacritic_inside+_diacritic_inside+_diacritic_outside,end_symbol:"*"},italic:{start_mark:_diacritic_outside+_diacritic_inside+_diacritic_inside,start_symbol:"_",end_mark:_diacritic_inside+_diacritic_inside+_diacritic_outside,end_symbol:"_"},strike:{start_mark:_diacritic_outside+_diacritic_inside,start_symbol:"~",end_mark:_diacritic_inside+_diacritic_outside,end_symbol:"~"}};var _stringify_transform_attrs={"data-stringify-text":function(node,str){return node.getAttribute("data-stringify-text")},"data-stringify-prefix":function(node,str){return node.getAttribute("data-stringify-prefix")+str},"data-stringify-suffix":function(node,str){return str+node.getAttribute("data-stringify-suffix")}};var _getTokenMap=function(){var map={"<B:START>":'<b data-format-symbol="*">'+_diacritic_map.bold.start_mark,"<B:END>":"</b>"+_diacritic_map.bold.start_mark,"<STRIKE:START>":'<strike data-format-symbol="~">'+_diacritic_map.strike.start_mark,"<STRIKE:END>":"</strike>"+_diacritic_map.strike.start_mark,"<PRE:START>":'<pre class="special_formatting"><span class="copyonly">&#96;&#96;&#96;</span>',"<PRE:END>":'<span class="copyonly">&#96;&#96;&#96;</span></pre>',"<CODE:START>":'<code class="special_formatting" data-format-symbol="`">'+_diacritic_map.code.start_mark,"<CODE:END>":"</code>"+_diacritic_map.code.start_mark,"<I:START>":'<i data-format-symbol="_">'+_diacritic_map.italic.start_mark,"<I:END>":"</i>"+_diacritic_map.italic.start_mark,"<QUOTE:START>":'<div class="special_formatting_quote"><div class="quote_bar"><div class="shim"></div></div><div class="content dynamic_content_max_width">',"<QUOTE:PREFIX>":'<span class="copyonly">&gt;</span>',"<LONGQUOTE:PREFIX>":'<span class="copyonly">&gt;&gt;&gt;</span>',"<QUOTE:END>":"</div></div>","<LINK:END>":"</a>","<LINE:BREAK>":"<br>","<PARA:BREAK>":'<span class="para_break"><i class="copy_only"><br></i></span>',"<SPACE:HARD>":"&nbsp;"};if(TS.boot_data.feature_better_msg_copying){map["<B:START>"]='<b data-stringify-prefix="*" data-stringify-suffix="*" data-stringify-requires-siblings>';map["<B:END>"]="</b>";map["<STRIKE:START>"]='<strike data-stringify-prefix="~" data-stringify-suffix="~" data-stringify-requires-siblings>';map["<STRIKE:END>"]="</strike>";map["<CODE:START>"]='<code class="special_formatting" data-stringify-prefix="`" data-stringify-suffix="`" data-stringify-requires-siblings>';map["<CODE:END>"]="</code>";map["<I:START>"]='<i data-stringify-prefix="_" data-stringify-suffix="_" data-stringify-requires-siblings>';map["<I:END>"]="</i>";map["<PRE:START>"]='<pre class="special_formatting" data-stringify-prefix="```" data-stringify-suffix="```" data-stringify-requires-siblings>';map["<PRE:END>"]="</pre>"}return map};var _TSF_token_map=_getTokenMap();var _emoticon_conversion_token_map=[];var _token_cnt=0;var _token_base="^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}^$-+!?][{}".split("").sort(function(){return.5-Math.random()}).join("");var _at_symbol_token="thisreplacementtokenallowsustotreatatsymbolsasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join("");var _dash_symbol_token="thisreplacementtokenallowsustotreatdashesasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join("");var _underscore_symbol_token="thisreplacementtokenallowsustotreatdashesasiftheywerewordcharactersinregex".split("").sort(function(){return.5-Math.random()}).join("");var _emoticonConversionTokenReplacer=function(m,boundary){var match=m.slice(boundary.length);return boundary+TS.format.tokenizeStr(_emoticon_conversion_token_map,match)};var _doHighlighting=function(new_txt){var word;var rx;var A=TS.model.highlight_words.concat();A.sort(function compare(a,b){return b.length-a.length});var has_ats=false;if(new_txt.indexOf("@")!=-1){has_ats=true;new_txt=TS.format.swapOutAts(new_txt)}for(var i=0;i<A.length;i++){word=A[i];if(has_ats){word=TS.format.swapOutAts(A[i])}word=TS.utility.regexpEscape(word);if(word=="don")word+="(?![']t)";word=TS.utility.htmlEntities(word);if(has_ats){rx=new RegExp("(\\b(?!.)|_|\\s|^)("+word+")\\b((?!.)|_|\\s|$)","ig")}else{rx=new RegExp("(\\b|_|\\s|^)("+word+")(\\b|_|\\s|$)","ig")}var last_good_pos=0;new_txt=new_txt.replace(rx,function(m,$0,$1,$2,offset,str){if(str.substr(0,offset).match(/</)){for(var i=offset;i>=last_good_pos;i--){if(str.charAt(i)=="<"){return $0+$1+$2}if(str.charAt(i)==">"){break}}}last_good_pos=offset+m.length;return $0+'<span class="mention">'+$1+"</span>"+$2})}if(has_ats){return TS.format.swapInAts(new_txt)}else{return new_txt}};var _encodeSpecialFormattingChars=function(txt){if(!txt)return"";return txt.replace(/\*/g,"&ast;").replace(/\_/g,"&#95;").replace(/\`/g,"&#96;")};var _encodeSpecialFormattingCharsAndColon=function(txt){if(!txt)return"";return _encodeSpecialFormattingChars(txt).replace(/\:/g,"&#58;")};var _calculateOptions=function(msg,opts){opts=opts||{};var do_inline_imgs=!!opts.do_inline_imgs||undefined;var for_growl=!!opts.for_growl||undefined;var for_edit=!!opts.for_edit||undefined;var no_highlights=!!opts.no_highlights||undefined;var no_specials=!!opts.no_specials||undefined;var enable_slack_action_links=!!opts.enable_slack_action_links||undefined;var no_jumbomoji=!!opts.no_jumbomoji||undefined;var no_preformatted=!!opts.no_preformatted||undefined;if(no_jumbomoji!==true){no_jumbomoji=!TS.model.prefs.jumbomoji}no_highlights=msg&&"no_highlights"in msg?!!msg.no_highlights:!!no_highlights;if(no_specials===true||no_specials===false){no_specials=no_specials}else if(msg&&"mrkdwn"in msg){no_specials=msg.mrkdwn===false}else{no_specials=false}if(for_edit)no_specials=true;var no_emoji=msg&&msg.no_emoji;var no_hex_colors=!(do_inline_imgs&&(!msg||msg.subtype!="bot_message"));var do_theme_install_buttons=!no_hex_colors&&TS.client&&TS.model.team;var tsf_mode="NORMAL";if(no_specials)tsf_mode="NOMRKDWN";if(for_growl)tsf_mode="GROWL";if(for_edit)tsf_mode="EDIT";return{tsf_mode:tsf_mode,no_highlights:no_highlights,no_emoji:no_emoji,no_hex_colors:no_hex_colors,do_inline_imgs:do_inline_imgs,enable_slack_action_links:enable_slack_action_links,do_theme_install_buttons:do_theme_install_buttons,no_jumbomoji:no_jumbomoji,no_preformatted:no_preformatted}};var _format=function(txt,msg,opts){var tsf_mode=opts.tsf_mode;var no_highlights=opts.no_highlights;var no_emoji=opts.no_emoji;var no_hex_colors=opts.no_hex_colors;var do_inline_imgs=opts.do_inline_imgs;var enable_slack_action_links=opts.enable_slack_action_links;var do_theme_install_buttons=opts.do_theme_install_buttons;var no_jumbomoji=opts.no_jumbomoji;var no_preformatted=opts.no_preformatted;var map=_TSF_token_map;var html_token_map=[];if(do_theme_install_buttons){var total_themes_count=(txt.match(_theme_rx)||[]).length;var theme_install_btns=[];var curr_theme_index=0;txt=txt.replace(_theme_rx,function(m,$1,$2){curr_theme_index++;var theme_install_btn=total_themes_count>1?_getThemeInstallButtonHtml(m,curr_theme_index):_getThemeInstallButtonHtml(m);theme_install_btns.push(theme_install_btn);var theme_count_text=total_themes_count>1?" ("+curr_theme_index+")	":"";return $1+TS.format.tokenizeStr(html_token_map,"<nobr>",",")+$2+theme_count_text+TS.format.tokenizeStr(html_token_map,"</nobr>")});txt=txt+TS.format.tokenizeStr(html_token_map,_getThemeInstallButtonsHtml(theme_install_btns))}var A=TSF.getTokensArray($.trim(txt),tsf_mode,{jumbomoji:!no_jumbomoji});if(no_preformatted)A=A.map(_swapPreForCode);var str="";var c;var guts;var item;var i;var id;var m;var partsA;var target;var cmd;var cmd_label;var cmd_A;var cmd_args;var unix_time;var cmd_template;var cmd_url;var anchor_start;var anchor_end;var ug;if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){for(i=0;i<A.length;i++){item=A[i];if(item.indexOf("<")===0){if(map[item]){TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got something in the formatting map? '+item)}else if(item.indexOf("<!")===0){str+=_parseCommandToken(tsf_mode,item)}else if(item.indexOf("<@")===0){var username=_parseMemberToken(tsf_mode,item);if(username==="`...`")username='<span class="temp_ellipsis">. . .</span>';str+=username}else if(item.indexOf("<#")===0){str+=_parseChannelToken(tsf_mode,item)}else{TS.error('unexpected: mode == "GROWL" || "EDIT", and yet we got '+item)}}else if(item.indexOf("<")==-1){if(tsf_mode=="EDIT"){str+=TS.utility.unHtmlEntities(item)}else{if(TS.utility.platformSupportsHtmlNotifications()){if(TS.utility.platformSupportsImgEmojiInHtmlNotifications()){str+=TS.emoji.graphicReplace(item,{force_img:true})}}else{var safe_str=TS.utility.unHtmlEntities(item);safe_str=TS.emoji.maybeUnifiedReplace(safe_str);str+=safe_str}}}else{TS.error("token has a < in it but it is not the first character!\n"+item)}}}else{var attach_html="";var js_url;var display_name;var last_item_was_bot_url;for(i=0;i<A.length;i++){item=A[i];if(item.indexOf("<")===0){if(map[item]){str+=map[item];if(item==TSF.LINK_END){str+=attach_html;attach_html=""}}else if(item.indexOf("<!")===0){str+=_parseCommandToken(tsf_mode,item,no_highlights)}else if(item.indexOf("<@")===0){var username=_parseMemberToken(tsf_mode,item,no_highlights);if(username==="`...`")username='<span class="temp_ellipsis">. . .</span>';str+=username}else if(item.indexOf("<#")===0){str+=_parseChannelToken(tsf_mode,item)}else if(item.indexOf(TSF.LINK_START.split(" ")[0])===0){var url=function(item){var temp=$.trim(item.replace(TSF.LINK_START.split(" ")[0],""));return temp.substr(0,temp.length-1)}(item);var bot_id;var app_id="";var bot;if((bot_id=TS.utility.getBotIDFromURL(url))&&(bot=TS.bots.getBotById(bot_id))){last_item_was_bot_url=true;target=TS.utility.shouldLinksHaveTargets()?'target="'+url+'" ':"";display_name=no_highlights?bot.name:_doHighlighting(bot.name);if(A[i+1]&&A[i+1]==url)display_name=url;display_name=display_name.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(TS.boot_data.feature_app_cards_and_profs_frontend){if(bot.app_id){app_id=bot.app_id}}str+='<a href="'+url+'" '+target+'data-bot-id="'+bot_id+'" data-app-id="'+app_id+'" class="internal_bot_link app_preview_link">'+display_name}else if(url.indexOf(TS.utility.msgs.api_url_prefix+"chat.help")===0){if(enable_slack_action_links){js_url=TS.utility.htmlEntities(JSON.stringify(""+url));str+='<a onclick="TS.utility.msgs.doApiUrl('+js_url+')" class="api_url">'}else{str+='<a class="api_url muted">(Disabled) '}}else if(url.indexOf(TS.utility.msgs.new_api_url_prefix)===0){if(enable_slack_action_links){js_url=TS.utility.htmlEntities(JSON.stringify(""+url));str+='<a onclick="TS.utility.msgs.doNewApiUrl('+js_url+')" class="api_url">'}else{str+='<a class="api_url muted">(Disabled) '}}else if(url.indexOf("javascript:")===0){str+='<a onclick="TS.client.msg_pane.maybeClick(this)" data-maybe-click="'+url.replace("javascript:","")+'">'}else if(TS.client&&TS.client.core_url&&url.indexOf(TS.client.core_url)===0){str+='<a target="_self" href="'+url+'">'}else{var file_id=TS.utility.getFileIDFromURL(url);var css_class=file_id?' class="file_preview_link no_jumbomoji"':"";var data_file_id=file_id?' data-file-id="'+file_id+'"':"";str+="<a "+TS.utility.makeRefererSafeLink(url)+' target="_blank"'+css_class+data_file_id+">";if(attach_html){TS.error("WTF we should have no attach_html")}attach_html="";var attachment;if(msg&&msg.ts&&do_inline_imgs){attachment=TS.inline_attachments.getAttachmentByFromUrl(msg.attachments,url);if(attachment&&(TS.boot_data.feature_attachments_inline||TS.templates.builders.shouldDoSimpleAttachment(attachment,msg))){attach_html=TS.templates.builders.buildAttachmentHTML({attachment:attachment,url:url,msg:msg,show_initial_caret:true})}}}}else if(item.indexOf(TSF.JUMBOMOJI_COLONS.split(" ")[0])===0){str+=_parseEmojiToken(tsf_mode,item,no_emoji,!no_jumbomoji)}else if(item.indexOf(TSF.EMOJI_COLONS.split(" ")[0])===0){str+=_parseEmojiToken(tsf_mode,item,no_emoji,false)}else if(item.indexOf(TSF.HEX_BLOCK.split(" ")[0])===0){str+=_parseHexToken(tsf_mode,item,no_hex_colors)}else{TS.error("markup token not handled:"+item)}}else if(item.indexOf("<")==-1){if(last_item_was_bot_url){last_item_was_bot_url=false}else{if(no_highlights){str+=item}else{str+=_doHighlighting(item)}}}else{TS.error("token has a < in it but it is not the first character!\n"+item)}}}if(TS.boot_data.feature_calls&&msg&&(msg.subtype==="sh_room_created"||msg.subtype==="sh_room_shared")){var from_name=TS.ui.growls.extractFromNameFromCorGMessage(msg);if(from_name){if(tsf_mode!=="GROWL"||TS.utility.platformSupportsHtmlNotifications()){from_name=TS.utility.htmlEntities(from_name)}from_name=from_name+": "}str=msg.subtype==="sh_room_created"?from_name+"Started a call":from_name+"Shared a call"}str=TS.format.deTokenizeStr(html_token_map,str);return str};var _parseChannelToken=function(tsf_mode,item){var guts=item.replace(/<|>|#/g,"");var partsA=guts.split("|");var id=partsA[0];var channel=TS.channels.getChannelById(id);if(channel){if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){return"#"+channel.name}else{var target=TS.utility.shouldLinksHaveTargets()?'target="/archives/'+channel.name+'"':"";return'<a href="/archives/'+channel.name+'" '+target+' data-channel-name="'+channel.name+'" data-channel-id="'+channel.id+'" class="internal_channel_link">#'+channel.name+"</a>"}}if(partsA.length>1&&partsA[1]){return"#"+partsA[1]}else if(TS.model.user.is_restricted){return"#unknown-channel"}else{return"#deleted-channel"}};var _parseEmojiToken=function(tsf_mode,item,no_emoji,do_jumbomoji){var colons=item.split(" ")[1].replace(">","");if(no_emoji){return colons}var replaced=TS.emoji.graphicReplace(colons,{obey_emoji_mode_pref:true,include_title:true,include_text:true,jumbomoji:do_jumbomoji});if(replaced&&replaced.indexOf(">>")!==-1){TS.warn("TS.emoji.graphicReplace may be malformed: "+replaced)}return replaced};var _parseMemberToken=function(tsf_mode,item,no_highlights){var guts=item.replace(/<|>/g,"");var m=TS.utility.msgs.getMemberFromMemberMarkup(guts);if(!m){if(tsf_mode=="GROWL")return item;return"`...`"}if(TS.boot_data.feature_name_tagging_client){if(tsf_mode=="EDIT"){return"@"+m.name}var display_name=TS.members.getMemberDisplayName(m,true);if(tsf_mode=="GROWL"||!TS.members.canUserSeeMember(m)){return display_name}var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+m.id+'" ':"";var classes=["internal_member_link"];if(m.id==TS.model.user.id)classes.push("mention");return'<a href="/team/'+m.id+'" '+target+'data-member-id="'+m.id+'" data-member-name="'+m.name+'" data-stringify-text="@'+m.id+'" class="'+classes.join(" ")+'">@'+display_name+"</a>"}else{if(tsf_mode=="EDIT"||tsf_mode=="GROWL"){return"@"+m.name}var display_name="@"+m.name;if(TS.members.canUserSeeMember(m)){var target=TS.utility.shouldLinksHaveTargets()?'target="/team/'+m.name+'" ':"";if(!no_highlights)display_name=_doHighlighting(display_name);return'<a href="/team/'+m.name+'" '+target+'data-member-name="'+m.name+'" data-stringify-text="@'+m.id+'" class="internal_member_link">'+display_name+"</a>"}else{return display_name}}};var _parseCommandToken=function(tsf_mode,item,no_highlights){var guts=item.replace(/<|>/g,"");var cmd_A=guts.split("|");var cmd=cmd_A[0].substr(1);if(_.includes(_at_commands,cmd)){if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){return"@"+cmd}else{return'<b class="mention">@'+cmd+"</b>"}}var cmd_label=cmd_A[1]?cmd_A[1]:cmd;if(cmd.indexOf("^")!==-1){
var cmd_args=cmd.split("^");cmd=cmd_args.shift();if(cmd==="date"&&cmd_args.length>=2){var unix_time=cmd_args[0];var cmd_template=cmd_args[1];var formatted_date=TS.utility.date.formatDate(cmd_template,unix_time,cmd_label);var cmd_url=cmd_args.length>2?cmd_args[2]:"";if(tsf_mode=="GROWL"||tsf_mode=="EDIT"||!cmd_url){return formatted_date}else{return"<a "+TS.utility.makeRefererSafeLink(cmd_url)+' target="_blank">'+formatted_date+"</a>"}}else if(cmd==="subteam"&&cmd_args.length===1){var ug=TS.user_groups.getUserGroupsById(cmd_args[0]);if(ug&&ug.handle){if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){return"@"+ug.handle}else{var target=TS.utility.shouldLinksHaveTargets()?'target="/usergroups/'+ug.id+'" ':" ";var handle=TS.utility.htmlEntities(ug.handle);var display_name=no_highlights?"@"+handle:_doHighlighting("@"+handle);return'<a href="/usergroups/'+ug.id+'" '+target+'data-user-group-id="'+ug.id+'" class="internal_user_group_link">'+display_name+"</a>"}}else{if(tsf_mode!="GROWL"&&tsf_mode!="EDIT"){return cmd_label}}}else{if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){return"<"+cmd_label+">"}else{return"&lt;"+cmd_label+"&gt;"}}}else{if(tsf_mode=="GROWL"||tsf_mode=="EDIT"){return"<"+cmd_label+">"}else{return"&lt;"+cmd_label+"&gt;"}}return""};var _parseHexToken=function(tsf_mode,item,no_hex_colors){var hex=item.split(" ")[1].replace(">","");if(!no_hex_colors){return' <div class="inline_color_block" style="background:'+hex+';"></div>'}return""};var _getThemeInstallButtonHtml=function(theme,curr_theme_index){var inner_html="Switch sidebar theme";if(curr_theme_index)inner_html+=" ("+curr_theme_index+")";return'<a data-theme="'+TS.utility.htmlEntities(theme)+'" class="btn btn_small btn_outline very_small_top_margin very_small_bottom_margin tiny_right_margin theme_installer_btn">'+inner_html+"</a>"};var _getThemeInstallButtonsHtml=function(theme_install_btns){if(theme_install_btns&&theme_install_btns.length){return'<br/><span class="theme_install_btns">'+theme_install_btns.join(" ")+"</span>"}return""};function _isPartOfUrl(haystack,needle,offset){var last_prior_space=haystack.lastIndexOf(" ",offset);var start_index=last_prior_space!==-1?last_prior_space+1:0;var maybe_url=haystack.substring(start_index,offset+needle.length);var is_url=TS.utility.findUrls(maybe_url).length>0;return is_url}function _swapPreForCode(token){switch(token){case TSF.PRE_START:return TSF.CODE_START;case TSF.PRE_END:return TSF.CODE_END}return token}function _htmlToText(html){var el=document.createElement("div");el.innerHTML=html;return el.textContent}function _getMemberSlug(member){var member_name=TS.members.getMemberDisplayName(member);var member_name_escaped=TS.utility.htmlEntities(member_name);var slug_html=TS.templates.member_slug({member_username:member.name,member_id:member.id,member_name:new Handlebars.SafeString(member_name_escaped)}).trim();return{html:slug_html,txt:_htmlToText(slug_html)}}function _cleanMsgText(txt,options){if(!txt)return"";if(!options)options={};if(TS.boot_data.feature_texty){txt=TS.format.replaceUnicodeDoppelgangers(txt)}if(options.do_specials){txt=TSF.getTokensString(txt,"CLEAN",{jumbomoji:TS.model.prefs.jumbomoji})}txt=txt.replace(_at_mention_rx,function(match,boundry,at_member_id,member_id,offset){if(boundry==="/"&&_isPartOfUrl(txt,match,offset))return match;var extra="";var lc=at_member_id.toLowerCase();var cmd;if(/^@everyone[\.|\-|_]*$/.test(lc)){cmd="<!everyone>";extra=lc.substr("!everyone".length)}else if(/^@here[\.|\-|_]*$/.test(lc)){cmd="<!here|@here>";extra=lc.substr("!here".length)}else if(/^@channel[\.|\-|_]*$/.test(lc)){cmd="<!channel>";extra=lc.substr("!channel".length)}else if(/^@group[\.|\-|_]*$/.test(lc)){cmd="<!group>";extra=lc.substr("!group".length)}if(cmd){return boundry+cmd+extra}var valid=_validateModelObByIdOrName(TS.members.getMemberById,member_id,TS.members.getMemberByName,at_member_id);if(valid.model_ob){var member_identifier;if(options.human_readable){member_identifier="@"+valid.model_ob.name}else{member_identifier="<@"+valid.model_ob.id+">"}return boundry+member_identifier+valid.extra}valid=_validateModelObByIdOrName(TS.user_groups.getUserGroupsById,member_id,TS.user_groups.getUserGroupsByHandle,at_member_id);if(valid.model_ob){var usergroup_identifier;if(options.human_readable){usergroup_identifier="@"+valid.model_ob.handle}else{usergroup_identifier="<!subteam^"+valid.model_ob.id+"|@"+valid.model_ob.handle+">"}return boundry+usergroup_identifier+valid.extra}return boundry+at_member_id});txt=txt.replace(/(^|\s|\(|&gt;|\*|_|\/)(#([a-zA-Z0-9\-_]+))/g,function(match,boundry,hash_channel_id,channel_id,offset){if(boundry==="/"&&_isPartOfUrl(txt,match,offset))return match;var valid=_validateModelObByIdOrName(null,null,TS.channels.getChannelByName,hash_channel_id);if(valid.model_ob){var channel_identifier;if(options.human_readable){channel_identifier="#"+valid.model_ob.name}else{channel_identifier="<#"+valid.model_ob.id+"|"+valid.model_ob.name+">"}return boundry+channel_identifier+valid.extra}return boundry+hash_channel_id});if(TS.model.prefs.convert_emoticons&&TS.model.prefs.emoji_mode!="as_text"){txt=TS.format.doEmoticonConversion(txt)}return txt}function _validateModelObByIdOrName(lookupById,id,lookupByName,name){var stripped;var extra="";var model_ob;if(TS.boot_data.feature_name_tagging_client_extras&&_.isFunction(lookupById)&&_.isString(id)){stripped=id.substring(0,TS.model.member_id_length);model_ob=lookupById(stripped);if(model_ob)extra=id.substring(TS.model.member_id_length)}if(!model_ob){model_ob=lookupByName(name)}var specials=[".","..","...","....","-","--","_"];var i=0;while(!model_ob&&i<specials.length){var special=specials[i];if(name&&name.substr(name.length-special.length,special.length)==special){stripped=name.substr(0,name.length-special.length);model_ob=lookupByName(stripped);if(model_ob)extra=special}i++}return{model_ob:model_ob,extra:extra}}var _hasStringifyTransformations=function(node){if(!node||node instanceof Text)return false;return _.some(_stringify_transform_attrs,function(transformFn,attr){return node.hasAttribute(attr)})}})();(function(){"use strict";TS.registerModule("selection",{isAnyTextSelected:function(){return window.getSelection().toString().trim()!=""},selectNode:function(node){if(!node)return;if(!document.body.contains(node)){TS.warn("TS.selection.selectNode: node is not in DOM");return}var range=document.createRange();range.selectNode(node);var selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);return selection},selectNodeContents:function(node){if(!node)return;if(!document.body.contains(node)){TS.warn("TS.selection.selectNodeContents: node is not in DOM");return}var range=document.createRange();range.selectNodeContents(node);var selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);return selection},selectCharacters:function(input,start,end){if(!input)return;if(!document.body.contains(input)){TS.warn("TS.selection.selectCharacters: node is not in DOM");return}if(!_.isNumber(start))start=0;if(!_.isNumber(end))end=start;if("setSelectionRange"in input){input.focus();input.setSelectionRange(start,end);return}if(!input.childNodes.length)return;var index=0;var start_node;var start_offset=0;var end_node;var end_offset=0;var text_children=TS.utility.getChildTextNodes(input);_.each(text_children,function(node){var len=node.textContent.length;if(!start_node&&index+len>=start){start_node=node;start_offset=start-index}if(!end_node&&index+len>=end){end_node=node;end_offset=end-index}if(start_node&&end_node)return false;index+=len});if(!start_node||!end_node){TS.warn("TS.selection.selectCharacters: could not find start and end nodes");return}var range=document.createRange();range.setStart(start_node,start_offset);range.setEnd(end_node,end_offset);var selection=window.getSelection();selection.removeAllRanges();selection.addRange(range)},snapshot:function(){var selection=window.getSelection();var range;if(selection.rangeCount)range=selection.getRangeAt(0).cloneRange();return function(){var current=window.getSelection();current.removeAllRanges();if(range)current.addRange(range)}},toCharacterRange:function(node){var output={start:0,end:0};if(!node)return output;if(!document.body.contains(node)){TS.warn("TS.selection.toCharacterRange: node is not in DOM");return}var selection=rangy.getSelection();if(!selection.rangeCount)return output;var range=selection.getRangeAt(0);output=range.toCharacterRange(node);return output},insertAtCaret:function(str){if(!_.isString(str))str="";var selection=window.getSelection();if(!selection.rangeCount)TS.warn("TS.selection.insertAtCaret: no range");var range=selection.getRangeAt(0);range.deleteContents();var text_node=document.createTextNode(str);range.insertNode(text_node);range.setStartAfter(text_node);selection.removeAllRanges();selection.addRange(range)},removeNextChars:function(num){if(!_.isNumber(num)||!num)return;var selection=rangy.getSelection();var range=selection.getRangeAt(0);if(num>0){range.moveEnd("character",num)}else{range.moveStart("character",num)}range.deleteContents()}})})();(function(){"use strict";TS.registerModule("menu.emoji",{active_emoji_group:null,is_showing:false,is_dirty:true,onStart:function(){if(TS.boot_data.page_needs_emoji_menu){if(TS.web)TS.web.login_sig.add(_waitAndBuild)}TS.prefs.emoji_mode_changed_sig.add(_updateSkinButton);TS.prefs.emoji_mode_changed_sig.add(_buildDefaultRxns);TS.prefs.preferred_skin_tone_changed_sig.add(_skinTonePrefChanged);TS.prefs.preferred_skin_tone_changed_sig.add(_buildDefaultRxns);TS.prefs.team_handy_rxns_changed_sig.add(_buildDefaultRxns);TS.prefs.channel_handy_rxns_changed_sig.add(_buildDefaultRxns)},start:function(args){_start(args);TS.emoji.maybeCommitDeferredEmojiUsage()},setDirtyAndMaybeRender:function(){TS.menu.emoji.is_dirty=true;if(TS.menu.emoji.is_showing)return;if(!_is_built){_build();return}_render()},disableNames:function(names){_disabled_names.length=0;_$items_div.find("a.disabled").removeClass("disabled");if(!_.isArray(names))return;TS.emoji.spliceSkinToneVariationsIntoAnArrayOfEmojiNames(names);names.forEach(function(name){_disabled_names.push(name);_$items_div.find('a[data-name=":'+TS.emoji.nameToCanonicalName(name)+':"]').addClass("disabled")})}});var _default_emoji_group="grinning";var _input_to_fill="#message-input";var _input_to_fill_default="#message-input";var _first_load=true;var _in_search_mode=false;var _in_key_mode=false;var _key_mode_mouse_tracker;var _key_mode_last_el_over;var _$key_nav_els=null;var _key_nav_index=-1;var _scroll_tim=0;var _one_search_result=null;var _emoji_menu_appended=false;var _rxn_key=null;var _last_rxn_key=null;var _default_emo=":smile:";var _$trigger;var _$parent=TS.client?$("#client-ui"):$("body");var _$menu;var _$header;var _$items_div;var _$emoji_div_handy_rxns;var _$emoji_ul_handy_rxns;var _$footer;var _$input;var _$emoji_preview_text;var _$emoji_preview_img;var _$emoji_name;var _$emoji_aliases;var _$headers;var _$uls;var _$lis;var _$emoji_search_results_h3;var _$emoji_zero_results;var _$emoji_tip;var _$emoji_skin_picker;var _$emoji_skin_button_container;var _$emoji_skin_button;var _$emoji_skin_tip;var _$emoji_skin_picker_label;var _$scroller;var _disabled_names=[];var _name_to_li_map;var _cached_scroller_rect;var _reusable_top_scroller_rect={right:0,left:0};var _reusable_header_rect={right:0,left:0};var _header_ranges;var _header_ranges_map;var _callback;var _height_caches={normal:0,rxns:0};var _rect_caches={normal:null,rxns:null};var _getWrecked=function(for_rxns){var which_rect=for_rxns?"rxns":"normal";var rect=_rect_caches[which_rect]=_rect_caches[which_rect]||_$menu.dimensions_rect();rect.right=rect.left+rect.width;rect.bottom=rect.top+rect.height;return rect};var _getOuterHeight=function(for_rxns){var which_height=for_rxns?"rxns":"normal";_height_caches[which_height]=_height_caches[which_height]||_$menu.outerHeight();return _height_caches[which_height]};var _waitAndBuild=function(){setTimeout(function(){if(!_is_built)_build()},5e3)};var _buildDefaultRxns=function(){var handy_rxns_dd=TS.rxns.getHandyRxnsDisplayDataByRxnKey(_rxn_key);if(_is_built){_$emoji_ul_handy_rxns.html(TS.templates.emoji_menu_handy_rxns({handy_rxns:handy_rxns_dd}));_$emoji_div_handy_rxns.toggleClass("hidden",!_shouldShowHandyRxns())}};var _shouldShowHandyRxns=function(){if(!_isOpenForRxn())return false;var handy_rxns_dd=TS.rxns.getHandyRxnsDisplayDataByRxnKey(_rxn_key);return Object.keys(handy_rxns_dd.items).length>0};var _is_built=false;var _build=function(){_buildDefaultRxns();_is_built=true;_$parent.append(TS.templates.emoji_menu({handy_rxns:TS.rxns.getHandyRxnsDisplayDataByRxnKey(_rxn_key)}));_$menu=$("#emoji_menu");TS.menu.emoji.$menu=_$menu;_$scroller=_$menu.find("#emoji_menu_items_scroller");_bindEvents();_default_emo="";_default_emoji_group="mine";_$header=_$menu.find("#emoji_menu_header");_$items_div=_$menu.find("#emoji_menu_items_div");_$emoji_div_handy_rxns=_$menu.find("#emoji_div_handy_rxns");_$emoji_ul_handy_rxns=_$menu.find("#emoji_ul_handy_rxns");_$footer=_$menu.find("#emoji_menu_footer");_$emoji_preview_text=$("#emoji_preview_text");_$emoji_preview_img=$("#emoji_preview_img");_$emoji_name=$("#emoji_name");_$emoji_aliases=$("#emoji_aliases");_$emoji_skin_button_container=$("#emoji_skin_button_container");_$emoji_skin_button=$("#emoji_skin_button");_$emoji_skin_tip=$("#emoji_skin_tip");_$emoji_skin_picker=$("#emoji_skin_picker");_$emoji_skin_picker_label=$("#emoji_skin_picker_label");_$emoji_skin_tip.removeClass("hidden");if(_shouldShowSkinTonePickerLabel()){_$emoji_preview_text.addClass("is_shortened");_$emoji_skin_picker_label.removeClass("hidden")}_updateSkinButton();_$emoji_skin_button_container.removeClass("hidden");_updateSkinPicker();_$emoji_skin_picker.removeClass("hidden");_updateSkinClass();_render();_$menu.detach()};var _start=function(args){var e=args.e;_$trigger=$(e&&e.target);var closed=_closeIfNeeded(_$trigger,function(){TS.menu.emoji.start(args)});if(closed)return;_rxn_key=args.rxn_key;if(_rxn_key){_callback=function(name){var adding=!TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(args.rxn_key),name);TS.rxns.changeRxnsFromUserAction(args.rxn_key,name,adding);if(args.callback)args.callback()};_$trigger.closest(".menu_rxn").addClass("active");_$trigger.closest(".rxn_panel").addClass("active");_$trigger.closest("ts-message").addClass("active");_$trigger.addClass("active")}else{_callback=args.callback;_$trigger.closest("a.emo_menu").addClass("active");_$trigger.closest(".handy_rxns_row").addClass("active")}if(!_is_built){_build()}else if(_rxn_key&&_rxn_key!=_last_rxn_key){_buildDefaultRxns()}_input_to_fill=!_rxn_key&&(args.input_to_fill||_input_to_fill);if(TS.client&&TS.utility.contenteditable.isDisabled(TS.client.ui.$msg_input)&&_input_to_fill){var replies_enabled=TS.replies&&TS.replies.isEnabled();var triggered_from_inline_reply=replies_enabled&&$(_input_to_fill).closest("ts-conversation").length>0;if(!triggered_from_inline_reply){return}}TS.menu.emoji.active_emoji_group=TS.menu.emoji.active_emoji_group||_default_emoji_group;if(TS.menu.emoji.is_dirty){TS.info("TS.menu.emoji.is_dirty = true");_render()}_updateFooter(_default_emo);if(!_emoji_menu_appended){_$menu.appendTo(_$parent);_emoji_menu_appended=true}_$emoji_div_handy_rxns.toggleClass("hidden",!_shouldShowHandyRxns());var offset;var x,y;if(_$trigger&&(_$trigger.hasClass("ts_icon_add_reaction")||_$trigger.hasClass("add_rxn_menu_item"))){offset={top:e.clientY-20,left:e.clientX-20}}else if(_$trigger&&_$trigger.closest("#handy_rxns_controller").length){offset={top:e.clientY+$(window).scrollTop()+200,left:e.clientX+190}}else if(_$trigger&&TS.client&&(_$trigger.is(TS.client.ui.$msg_input)||$.contains(TS.client.ui.$msg_input.parent("form")[0],_$trigger[0]))){var prev_height=TS.boot_data.feature_texty?TS.view.last_input_height:TS.view.last_input_container_height+25;offset={top:window.innerHeight-prev_height,left:284};if(_$trigger.hasClass("ts_icon_happy_smile")){if(TS.model.ui_state.flex_visible){offset.left+=TS.view.last_msgs_div_width-132}else{offset.left+=TS.view.last_msgs_div_width-452}}}else{offset=_$trigger.offset()}if(offset){x=parseInt(offset.left-8);y=parseInt(offset.top-(_getOuterHeight(_isOpenForRxn())+6))}TS.menu.emoji.is_showing=true;_endSearchMode();_endKeyMode();_$menu.css({top:y,left:x});_$menu.css("opacity",1);var rect=_getWrecked(_isOpenForRxn());rect.top=y;rect.left=x;_keepInBounds();if(TS.view){TS.view.resize_sig.add(_keepInBounds)}else{$(window).bind("resize",_keepInBounds)}$(window.document).bind("keydown",_onKeyDown);$("html").bind("mousedown",_onMouseDown);if(_first_load){_first_load=false}TS.tips.hideAll();TS.menu.emoji.disableNames(args.disabled_names);setTimeout(_resetScrollCrap,20)};var _resetScrollCrap=function(){_$scroller.scrollTop(0);TS.ui.utility.updateClosestMonkeyScroller(_$scroller);_cached_scroller_rect=_$scroller.dimensions_rect();_reusable_top_scroller_rect.top=0;_reusable_top_scroller_rect.bottom=_cached_scroller_rect.height*.4;_calcHeaderRanges();if(!TS.model.supports_sticky_position){$("#emoji_h3_"+TS.menu.emoji.active_emoji_group).scrollintoview({offset:"top",px_offset:0,duration:0})}_$input.focus();_resetTab(true)};var _startKeyMode=function(key,from_input){if(_in_key_mode)return;_in_key_mode=true;_$menu.addClass("key_mode");_$input.blur();_$key_nav_els=_$lis.filter(":visible");if(!from_input&&_key_mode_last_el_over&&_$key_nav_els.index(_key_mode_last_el_over)>-1){_setKeySelectionIndex(_$key_nav_els.index(_key_mode_last_el_over));_changeKeyModeSelectionLiByArrow(key)}else{_animateScroll(0);_setKeySelectionIndex(0)}$("body").bind("mousedown.emoji_key_mode",function(){_endKeyMode()});_$scroller.bind("mousemove.emoji_key_mode",function(e){if(!_key_mode_mouse_tracker){_key_mode_mouse_tracker={x:e.pageX,y:e.pageY};return}if(Math.abs(e.pageX-_key_mode_mouse_tracker.x)>1||Math.abs(e.pageY-_key_mode_mouse_tracker.y)>1){_endKeyMode()}});_$emoji_div_handy_rxns.bind("mousemove.emoji_key_mode",function(e){_endKeyMode()})};var _changeKeyModeSelectionLiByArrow=function(key){if(_$key_nav_els.length==1)return;var keymap=TS.utility.keymap;var $li=_$key_nav_els.eq(_key_nav_index);var new_index;if(_$key_nav_els.length<=TS.model.emoji_menu_columns){if(key==keymap.up)key=keymap.left;if(key==keymap.down)key=keymap.right}if(key==keymap.up||key==keymap.down){if(key==keymap.up){new_index=_key_nav_index-TS.model.emoji_menu_columns}else{new_index=_key_nav_index+TS.model.emoji_menu_columns}if(_in_search_mode){if(new_index>=_$key_nav_els.length){var row_count=Math.ceil(_$key_nav_els.length/TS.model.emoji_menu_columns);var row_index=Math.ceil((_$key_nav_els.index($li)+1)/TS.model.emoji_menu_columns)-1;if(row_count==row_index+1){new_index=0}else{new_index=_$key_nav_els.length-1}}}else{var col=$li.data("col");var row=$li.data("row");var new_row_index=key==keymap.up?row-1:row+1;var $new_row=_$key_nav_els.filter('[data-row="'+new_row_index+'"]');var $new_li=$new_row.filter('[data-col="'+col+'"]');if($new_li.length){new_index=_$key_nav_els.index($new_li)}else{new_index=_$key_nav_els.index($new_row.last())}}}else if(key==keymap.right){new_index=_key_nav_index+1}else if(key==keymap.left){new_index=_key_nav_index-1}else{TS.error("invalid key passed to _changeKeyModeSelectionLiByArrow:"+key);return}if((key==keymap.up||key==keymap.left)&&new_index<0){new_index=_$key_nav_els.length-1}else if((key==keymap.down||key==keymap.right)&&(new_index==-1||new_index>=_$key_nav_els.length)){new_index=0}_setKeySelectionIndex(new_index)};var _setKeySelectionIndex=function(new_index){var last_key_nav_index=_key_nav_index;if(last_key_nav_index>-1){_$key_nav_els.eq(last_key_nav_index).removeClass("key_selection")}_key_nav_index=new_index;var $new_li=_$key_nav_els.eq(_key_nav_index);_updateFooter($new_li.data("name"),$new_li.data("names"));$new_li.addClass("key_selection").scrollintoview({offset:_key_nav_index<last_key_nav_index?"top":"bottom",px_offset:_key_nav_index<last_key_nav_index?26:-6,duration:100})};var _endKeyMode=function(){if(!_in_key_mode)return;_in_key_mode=false;_key_mode_mouse_tracker=null;_$menu.removeClass("key_mode");_$key_nav_els.removeClass("key_selection");_key_nav_index=-1;$("body").unbind("mousedown.emoji_key_mode");_$scroller.unbind("mousemove.emoji_key_mode");_$emoji_div_handy_rxns.unbind("mousemove.emoji_key_mode")};var _startSearchMode=function(){if(_in_search_mode)return;TS.metrics.mark("emoji_menu_start_search_mode_mark");_in_search_mode=true;if(TS.boot_data.feature_emoji_menu_tuning&&_.isEmpty(_name_to_li_map))_buildSearchMap();_endKeyMode();_$headers.addClass("hidden");_$emoji_search_results_h3.removeClass("hidden");_$uls.css("display","inline");$(".emoji_section_div").css("display","inline");_$emoji_tip.addClass("hidden");_$emoji_zero_results.addClass("hidden");if(TS.boot_data.feature_emoji_menu_tuning){TS.metrics.measureAndClear("emoji_menu_start_search_mode_tuned","emoji_menu_start_search_mode_mark")}else{TS.metrics.measureAndClear("emoji_menu_start_search_mode","emoji_menu_start_search_mode_mark")}};var _endSearchMode=function(){if(!_in_search_mode)return;TS.metrics.mark("emoji_menu_end_search_mode_mark");_in_search_mode=false;_one_search_result=null;_$headers.removeClass("hidden");_$emoji_search_results_h3.addClass("hidden");_$uls.css("display","block");$(".emoji_section_div").css("display","block");_$emoji_tip.removeClass("hidden");_$emoji_zero_results.addClass("hidden");_$input.val("");_$lis.removeClass("hidden");_$scroller.scrollTop(0);TS.ui.utility.updateClosestMonkeyScroller(_$scroller);_calcHeaderRanges();if(TS.boot_data.feature_emoji_menu_tuning){TS.metrics.measureAndClear("emoji_menu_end_search_mode_tuned","emoji_menu_end_search_mode_mark")}else{TS.metrics.measureAndClear("emoji_menu_end_search_mode","emoji_menu_end_search_mode_mark")}};var _calcHeaderRanges=function(){_header_ranges=[];_header_ranges_map={};var range;var next_range;var group_name;var index=-1;_$headers.each(function(i,h3){var $h3=$(h3);group_name=$h3.data("group-name");if(!TS.model.supports_sticky_position){$h3.css("top",0)}if($h3.hasClass("hidden"))return;index++;_header_ranges_map[group_name]=_header_ranges[index]={index:index,$el:$h3,id:$h3.attr("id"),group_name:group_name,rect:$h3.dimensions_rect(),vis:{top:0,bottom:0,max_top:0,set_top:0}}});for(var i=0;i<_header_ranges.length;i++){range=_header_ranges[i];next_range=_header_ranges[i+1];range.vis.top=range.rect.top-_cached_scroller_rect.top;range.vis.bottom=next_range?next_range.rect.top-_cached_scroller_rect.top:1e11;range.vis.max_top=range.vis.bottom-range.vis.top-range.rect.height;delete range.rect}};var _render=function(){TS.metrics.mark("emoji_menu_render_mark");TS.menu.emoji.is_dirty=false;_$header.html(TS.templates.emoji_header({emoji_groups:TS.model.emoji_groups,active_group:TS.menu.emoji.active_emoji_group}));_$items_div.html(TS.templates.menu_emoticons({emoji_groups:_getEmojiGroups(),active_group:TS.menu.emoji.active_emoji_group,can_add_emoji:_userCanAddEmoji()}));_$input=_$items_div.find("#emoji_input");_$headers=_$items_div.find("h3");_$uls=_$items_div.find(".emoji_ul");_$lis=_$uls.children();_$emoji_search_results_h3=_$items_div.find("#emoji_search_results_h3");_$emoji_zero_results=_$items_div.find("#emoji_zero_results");_$emoji_tip=_$items_div.find("#emoji_tip");_name_to_li_map={};if(!TS.boot_data.feature_emoji_menu_tuning)_buildSearchMap();if(TS.menu.emoji.is_showing){_calcHeaderRanges()}_$emoji_div_handy_rxns.removeClass("hidden");_getWrecked(true);_getOuterHeight(true);_$emoji_div_handy_rxns.addClass("hidden");_getWrecked(false);_getOuterHeight(false);if(TS.boot_data.feature_emoji_menu_tuning){TS.metrics.measureAndClear("emoji_menu_render_tuned","emoji_menu_render_mark")}else{TS.metrics.measureAndClear("emoji_menu_render","emoji_menu_render_mark")}};var _getEmojiGroups=function(){var num_colors=TS.model.emoji_menu_colors;var num_per_row=TS.model.emoji_menu_columns;var row_index=0;return _.map(TS.model.emoji_groups,function(group){var item_index=0;var actual_items=_.compact(group.items);var items=_.map(actual_items,function(item,i){var col_index=item_index%num_per_row;var color_index=item_index%num_colors;var prev_row_index=row_index;if(!item.is_skin||item.skin_tone_id==6){item_index++;if(item_index%num_per_row===0||i===group.items.length-1){row_index++}}return{html:item.html,is_skin:item.is_skin,name:item.name,names:item.names,skin_tone_id:item.skin_tone_id,row_index:prev_row_index,col_index:col_index,color_index:color_index}});return{display_name:group.display_name,items:items,name:group.name}})};var _bindEvents=function(){if(!_$menu||!_$menu.length){TS.warn("TS.menu.emoji: unable to bind menu events");return}_$menu.on("click.emoji_menu","#emoji_menu_header a.emoji_grouping_tab",_onHeaderClick);_$menu.on("input.emoji_menu","#emoji_input",_.throttle(_onInputTextchange,250,true));_$menu.on("click.emoji_menu",".emoji_li",_onEmoClick);_$menu.on("mouseenter.emoji_menu",".emoji_li",_onMouseEnterA);_$menu.on("mouseleave.emoji_menu",".emoji_li",_onMouseLeaveA);_$menu.on("click.emoji_menu","#emoji_skin_button_container",_startSkinPicker);_$menu.on("click.emoji_menu","#emoji_skin_picker > span",_handleSkinPicker);if(!_$scroller||!_$scroller.length){TS.warn("TS.menu.emoji: unable to bind scroller events");return}_$scroller.on("scroll.emoji_menu",_onScroll);if(!TS.environment.supports_custom_scrollbar)_$scroller.monkeyScroll()};var _handleSkinPicker=function(e){_endSkinPicker();var val=$(e.currentTarget).attr("skin-tone")||"1";TS.prefs.onPrefChanged({name:"preferred_skin_tone",value:val});TS.prefs.setPrefByAPI({name:"preferred_skin_tone",value:val});if(_in_search_mode)_onInputTextchange()};var _onScroll=function(e){if(!TS.model.supports_sticky_position){_getActiveGroupAndMaybePositionHeaders()}clearTimeout(_scroll_tim);_scroll_tim=setTimeout(_resetTab,50)};var _resetTab=function(force){var active_emoji_group=_getActiveGroupAndMaybePositionHeaders();if(force||active_emoji_group!=TS.menu.emoji.active_emoji_group){TS.menu.emoji.active_emoji_group=active_emoji_group;$(".emoji_grouping_tab").removeClass("active");$('.emoji_grouping_tab[data-group-name="'+TS.menu.emoji.active_emoji_group+'"]').addClass("active")}};var _getActiveGroupAndMaybePositionHeaders=function(){var sc=_$scroller.scrollTop();var range;var active_emoji_group;for(var i=0;i<_header_ranges.length;i++){range=_header_ranges[i];if(sc+i===0)active_emoji_group=range.group_name;if(sc>=range.vis.top&&sc<=range.vis.bottom){active_emoji_group=range.group_name;if(!TS.model.supports_sticky_position){range.set_top=Math.min(sc-range.vis.top,range.vis.max_top);range.$el.css("top",range.set_top)}}else if(range.set_top&&!TS.model.supports_sticky_position){range.set_top=0;range.$el.css("top",range.set_top)}_reusable_header_rect.top=range.vis.top-sc;_reusable_header_rect.bottom=_reusable_header_rect.top+25;if(sc>0&&TS.utility.doesRectContainRect(_reusable_top_scroller_rect,_reusable_header_rect,0,true)){active_emoji_group=range.group_name}else if(parseInt(_$scroller.css("height"))+sc+40>=_$scroller[0].scrollHeight){active_emoji_group=_header_ranges[_header_ranges.length-1].group_name}}return active_emoji_group};var _onInputTextchange=function(){var val=$.trim(_$input.val());var start=Date.now();TS.log(96,"--- _onInputTextchange ---");if(!val){_endSearchMode();return}TS.metrics.mark("emoji_menu_search_mark");_startSearchMode();TS.log(96,"after _startSearchMode "+(Date.now()-start));_$lis.addClass("hidden");TS.log(96,"after hiding all "+(Date.now()-start));var terms=val.split(" ");var term;var matches=[];var preview_emoji;var preview_names;var name;var rx;var rx_str;var i;if(TS.boot_data.feature_emoji_menu_tuning){matches=_.flatMap(terms,function(term){return _.filter(TS.model.emoji_names,function(name){var base_name=TS.emoji.nameToBaseName(name);return TS.emoji.substringMatchesName(base_name,term,_rxn_key)})})}else{names_loop:for(var m=0;m<TS.model.emoji_names.length;m++){name=TS.model.emoji_names[m].replace(/(\:skin-tone-[2-6])/,"");for(i=0;i<terms.length;i++){term=terms[i];if(term.substr(0,1)==":"){rx_str="^"+TS.utility.regexpEscape(TS.emoji.stripWrappingColons(term));if(term.length>1&&term.substr(-1,1)==":"){rx_str+="$"}}else{rx_str=TS.utility.regexpEscape(term)}rx=new RegExp(rx_str,"i");if(rx.test(name)){matches[matches.length]=name;continue names_loop}else{var handy_title=TS.rxns.getHandyRxnsTitleForEmojiByRxnKey(name,_rxn_key);if(handy_title&&rx.test(handy_title)){matches[matches.length]=name;continue names_loop}}}}}TS.log(96,"after regex "+(Date.now()-start));for(i=0;i<terms.length;i++){term=terms[i];if(term.substr(0,1)!=":"){TS.emoji.findByKeyword(terms[i]).forEach(function(name){TS.utility.ensureInArray(matches,name)})}}var item;var one_shown=false;var two_plus_shown=false;var skin_tone=TS.emoji.getChosenSkinTone();for(name in _name_to_li_map){if(matches.indexOf(name)===-1)continue;if(skin_tone&&TS.emoji.isNameSkinToneModifiable(name)){name+="::"+skin_tone}item=_name_to_li_map[name];if(!item){TS.error(name);continue}two_plus_shown=one_shown;one_shown=true;preview_emoji=":"+name+":";preview_names=item.names;item.$li.removeClass("hidden")}TS.log(96,"after show/hide "+(Date.now()-start));if(!TS.model.supports_sticky_position){_$emoji_search_results_h3.css("top",0);TS.log(96," after _$emoji_search_results_h3.css "+(Date.now()-start))}_$emoji_zero_results.toggleClass("hidden",one_shown);TS.log(96," after emoji_zero_results.toggleClass "+(Date.now()-start));if(!TS.boot_data.feature_emoji_menu_tuning||TS.model.is_FF||TS.model.is_IE){if(_$scroller[0]["scrollTop"])_$scroller[0]["scrollTop"]=0;TS.log(96,"after scroller[0].scrollTop = 0 "+(Date.now()-start))}if(!TS.environment.supports_custom_scrollbar){TS.utility.setImmediate(function(){TS.ui.utility.updateClosestMonkeyScroller(_$scroller)})}_one_search_result=null;if(two_plus_shown){preview_names=preview_emoji=_default_emo}else if(one_shown){_one_search_result=preview_emoji;preview_emoji=preview_emoji;preview_names=preview_names}else{preview_names=preview_emoji=":cry:"}_updateFooter(preview_emoji,preview_names);if(TS.boot_data.feature_emoji_menu_tuning){TS.metrics.measureAndClear("emoji_menu_search_tuned","emoji_menu_search_mark")}else{TS.metrics.measureAndClear("emoji_menu_search","emoji_menu_search_mark")}TS.log(96,"end "+(Date.now()-start))};var _updateFooter=function(colon_name,colon_names){if(colon_name){var title=TS.rxns.getHandyRxnsTitleForEmojiByRxnKey(colon_name,_rxn_key);title=title?'"'+title+'"':TS.emoji.stripWrappingColons(colon_name.replace(/(\:\:skin-tone-[2-6]\:)/g,":"));_$footer.addClass("previewing");_$emoji_preview_img.html(TS.emoji.graphicReplace(colon_name));_$emoji_name.html(title);_$emoji_aliases.html((colon_names||"").replace(/(\:\:skin-tone-[2-6]\:)/g,":").replace(/\: /g,":&nbsp;&nbsp;"))}else{_$footer.removeClass("previewing")}};var _selectionMade=function(emo,e){if(!TS.menu.emoji.is_showing){return}if(_disabled_names.indexOf(TS.emoji.stripWrappingColons(emo))!=-1){TS.sounds.play("beep");return}if(_callback){setTimeout(_callback,0,emo);if(!e||!e.shiftKey)_end();return}if(!_input_to_fill){TS.error("WTF no _input_to_fill?");return}var $input_to_fill=$(_input_to_fill);var current_pos=TS.utility.getCursorPosition($input_to_fill).start;var new_pos=current_pos+emo.length;var current_val=TS.utility.contenteditable.value($input_to_fill);var new_val=current_val.substr(0,current_pos)+emo+current_val.substr(current_pos);if(TS.boot_data.feature_texty){setTimeout(TS.utility.populateInput,0,_input_to_fill,new_val,new_pos);if(!e||!e.shiftKey)_end()}else{TS.utility.populateInput($input_to_fill,new_val);if(!e||!e.shiftKey){setTimeout(TS.utility.setCursorPosition,0,_input_to_fill,new_pos);_end()}}};var _onKeyDown=function(e){var keymap=TS.utility.keymap;if(_in_key_mode){if(TS.utility.isArrowKey(e.which)){_changeKeyModeSelectionLiByArrow(e.which);e.preventDefault();return}if(e.which==keymap.shift||e.which==keymap.alt||e.which==keymap.ctrl||e.which==keymap.cmd_ff||e.which==keymap.cmd_other||e.which==keymap.cmd_right){return}if(e.which==keymap.esc){
e.preventDefault();_endKeyMode();_end();return}if(e.which==keymap.enter){_selectionMade(_$key_nav_els.eq(_key_nav_index).data("name"),e);e.preventDefault();e.stopPropagation();return}_endKeyMode()}var focus_is_on_an_input=TS.utility.isFocusOnInput();var focus_is_on_our_input=focus_is_on_an_input&&_$input[0]===document.activeElement;var focus_is_on_other_input=focus_is_on_an_input&&!focus_is_on_our_input;if(focus_is_on_other_input){if(e.which==keymap.enter){_end();return}else if(e.which==keymap.semicolon&&e.shiftKey){_end();return}}else{if(focus_is_on_our_input){if(e.which==keymap.down){var cp=_$input.getCursorPosition();var tl=_$input.val().length;if(cp==tl){_startKeyMode(e.which,true);e.preventDefault();return}}if(!_$input.val()&&TS.utility.isArrowKey(e.which)){_startKeyMode(e.which);e.preventDefault()}if(TS.utility.isArrowKey(e.which)&&(e.metaKey||e.altKey||e.shiftKey)){return}}if(TS.utility.isArrowKey(e.which)){_startKeyMode(e.which);e.preventDefault();return}}if(focus_is_on_our_input){if(e.which==keymap.enter){if(_in_search_mode&&_one_search_result){_selectionMade(_one_search_result,e);e.preventDefault();e.stopPropagation()}return}}if(e.which==keymap.esc||e.which==keymap.tab){_end();e.preventDefault();return}if(!focus_is_on_an_input&&(!TS.client||TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden())&&!TS.utility.isArrowKey(e.which)&&!TS.utility.isPageKey(e.which)&&!e.metaKey&&!e.ctrlKey&&!e.altKey&&e.which!=keymap.shift){_$input.focus()}};var _keepInBounds=function(){var allowance_v=10;var allowance_h=18;var rect;var top;if(TS.web){rect=_$menu.dimensions_rect();top=_$menu.offset().top}else{rect=_getWrecked(_isOpenForRxn());top=rect.top}var allow_rect={top:0+allowance_v,right:window.innerWidth-allowance_h,bottom:window.innerHeight-(allowance_v+14),left:0+allowance_h};var all_good=TS.utility.doesRectContainRect(allow_rect,rect);if(all_good)return;if(rect.left<allow_rect.left){rect.left=parseInt(allow_rect.left);_$menu.css("left",rect.left)}else if(rect.right>allow_rect.right){rect.left=parseInt(Math.max(allow_rect.left,allow_rect.right-rect.width));_$menu.css("left",rect.left)}if(rect.top<allow_rect.top){rect.top=parseInt(top+(allow_rect.top-rect.top));_$menu.css("top",rect.top)}else if(rect.bottom>allow_rect.bottom){var diff=rect.bottom-Math.max(allow_rect.top,allow_rect.bottom-rect.width);rect.top=parseInt(top-diff);_$menu.css("top",rect.top)}};var _isOpenForRxn=function(){return!!_rxn_key};var _end=function(callback){TS.menu.emoji.is_showing=false;_last_rxn_key=_rxn_key||_last_rxn_key;_rxn_key=null;_$scroller.scrollTop(0);_getActiveGroupAndMaybePositionHeaders();_resetTab();_resetScrollCrap();TS.tips.unhideAll();_endSkinPicker();_$menu.stop().transition({opacity:0},150,function(){_$menu.detach();_emoji_menu_appended=false;_endSearchMode();_endKeyMode();TS.menu.emoji.disableNames();if(callback)callback()});_$input.blur();_disabled_names.length=0;_callback=null;_$trigger.closest("a.emo_menu").removeClass("active");_$trigger.closest(".handy_rxns_row").removeClass("active");_$trigger.closest(".menu_rxn").removeClass("active");_$trigger.closest(".rxn_panel").removeClass("active");_$trigger.closest("ts-message").removeClass("active");_$trigger.removeClass("active");_input_to_fill=_input_to_fill_default;if(TS.view){TS.view.resize_sig.remove(_keepInBounds)}else{$(window).unbind("resize",_keepInBounds)}$(window.document).unbind("keydown",_onKeyDown);$("html").unbind("mousedown",_onMouseDown);_$trigger=null};var _onMouseDown=function(e){var $target=$(e.target);var isClickOnEmojiMenuAffordance=function(){if($target.closest(".emo_menu").length!==0)return true;if($target.closest(".menu_rxn").length!==0)return true;if($target.closest('[data-action="reaction"]').length!==0)return true;return false};if($target.closest("#emoji_menu").length===0&&!isClickOnEmojiMenuAffordance()||$target.hasClass("popover_mask")){_end()}else if($target.closest("#emoji_skin_picker").length===0){_endSkinPicker()}};var _onEmoClick=function(e){var emo=$(this).data("name");_selectionMade(emo,e)};var _onMouseLeaveA=function(e){_key_mode_last_el_over=null;_updateFooter()};var _onMouseEnterA=function(e){var $a=$(this);var name=$a.data("name");var names=$a.data("names");_key_mode_last_el_over=$a.parent();_endSkinPicker();_updateFooter(name,names)};var _onHeaderClick=function(e){_activateTab($(this))};var _activateTab=function($tab){TS.menu.emoji.active_emoji_group=$tab.data("group-name");if(TS.menu.emoji.is_dirty){_render()}else{_endSearchMode()}var range=_header_ranges_map[TS.menu.emoji.active_emoji_group];if(range){var dest=range.index===0?0:range.vis.top;_animateScroll(dest)}$(".emoji_grouping_tab").removeClass("active");$tab.addClass("active")};var _animateScroll=function(dest){var diff=Math.abs(dest-_$scroller.scrollTop());var d=50*(diff/300);_$scroller.stop().animate({scrollTop:dest},d)};var _closeIfNeeded=function($trigger,reopener){if(TS.menu.emoji.is_showing){if(_$trigger&&_$trigger[0]===$trigger[0]){reopener=null}_end(reopener);return true}return false};var _startSkinPicker=function(){_updateSkinPicker();_$emoji_skin_picker.addClass("shown");_$emoji_skin_tip.addClass("shown")};var _endSkinPicker=function(){_$emoji_skin_picker.removeClass("shown");_$emoji_skin_tip.removeClass("shown")};var _skin_picker_base=":hand:";var _skin_picker_choices=function(){return[{id:1,colons:_skin_picker_base},{id:2,colons:_skin_picker_base+":skin-tone-2:"},{id:3,colons:_skin_picker_base+":skin-tone-3:"},{id:4,colons:_skin_picker_base+":skin-tone-4:"},{id:5,colons:_skin_picker_base+":skin-tone-5:"},{id:6,colons:_skin_picker_base+":skin-tone-6:"}]}();var _updateSkinClass=function(){if(!_$menu)return;_$menu.removeClass("skin_tone_1 skin_tone_2 skin_tone_3 skin_tone_4 skin_tone_5 skin_tone_6");var id=TS.model.prefs.preferred_skin_tone||"1";_$menu.addClass("skin_tone_"+id)};var _updateSkinButton=function(){var chosen=_skin_picker_base+TS.emoji.getChosenSkinToneModifier();chosen=TS.utility.htmlEntities(chosen);var options=_shouldForceEmojiStyle()?{force_style:"apple"}:{};_$emoji_skin_button.html(TS.emoji.graphicReplace(chosen,options))};var _shouldForceEmojiStyle=function(){return TS.model.prefs.emoji_mode!="apple"&&TS.model.prefs.emoji_mode!="twitter"};var _updateSkinPicker=function(){var chosen_id=TS.model.prefs.preferred_skin_tone||"1";var chosen;var choices=_skin_picker_choices.filter(function(item){if(item.id!=chosen_id)return true;chosen=item;return false});if(chosen){if(_shouldShowSkinTonePickerLabel()){choices.unshift(chosen)}else{choices.push(chosen)}}choices=choices.map(function(item){var preferred=item.id==TS.model.prefs.preferred_skin_tone;if(TS.model.prefs.preferred_skin_tone==""&&item.id==1)preferred=true;return'<span skin-tone="'+item.id+'" data-preferred="'+preferred+'">'+item.colons+"</span>"});var options=_shouldForceEmojiStyle()?{force_style:"apple"}:{};options.defer_usage_stat=true;_$emoji_skin_picker.html(TS.emoji.graphicReplace(choices.join(""),options))};var _skinTonePrefChanged=function(){_updateSkinButton();_updateSkinClass();_hideSkinTonePickerLabel();if(_$emoji_skin_picker&&_$emoji_skin_picker.hasClass("shown")){_updateSkinPicker()}if(_in_search_mode)_onInputTextchange()};var _hideSkinTonePickerLabel=function(){_$emoji_skin_picker_label.addClass("hidden")};var _shouldShowSkinTonePickerLabel=function(){return TS.model.prefs.preferred_skin_tone==""};var _userCanAddEmoji=function(){return!TS.model.user.is_restricted&&(!TS.model.team.prefs.emoji_only_admins||TS.model.user.is_admin)};var _buildSearchMap=function(){_name_to_li_map={};var $search_lis=_$items_div.find(".emoji_ul:not(#emoji_ul_mine) a[data-names]");var $li,names,namesA,name;for(var x=0;x<$search_lis.length;x++){$li=$search_lis.eq(x);names=$li.data("names");if(!names)return;namesA=names.split(" ");for(var i=0;i<namesA.length;i++){name=TS.emoji.stripWrappingColons(namesA[i]);if(!_name_to_li_map.hasOwnProperty(name)){_name_to_li_map[name]={$li:$li,names:names}}}}}})();(function(){"use strict";TS.registerModule("menu",{$menu:null,$submenu:null,$submenu_origin:null,$submenu_parent:null,$menu_header:null,$menu_items:null,$menu_list_container:null,$menu_list:null,$menu_footer:null,menu_lazy_load:null,user_group:null,end_tim:0,$target_element:null,$secondary_target_element:null,members_html_cache:null,large_list_trigger:1500,large_dom_trigger:500,watching_members_model:false,menu_items_hidden:true,has_submenu:false,menu_closed_sig:new signals.Signal,onStart:function(){},buildIfNeeded:_.once(function(){var $menu=TS.menu.$menu=$(TS.templates.menu());if(TS.boot_data.app!="mobile"&&TS.qs_args["new_scroll"]!="0"){if(TS.client){$menu.appendTo($("#client-ui"))}else{$menu.appendTo($("body"))}if(!TS.environment.supports_custom_scrollbar){var debug=TS.qs_args["debug_scroll"]=="1";$menu.find("#menu_items_scroller").monkeyScroll({debug:debug})}$menu.detach()}TS.menu.$menu_header=$menu.find("#menu_header");TS.menu.$menu_body=$menu.find(".menu_body");TS.menu.$menu_list_container=$menu.find("#menu_list_container");TS.menu.$menu_list=$menu.find("#menu_list");TS.menu.$menu_items=$menu.find("#menu_items");TS.menu.$menu_footer=$menu.find("#menu_footer")}),handleTopicKeydown:function(e){var keymap=TS.utility.keymap;if(e.which==keymap.enter&&!e.shiftKey&&!e.altKey){var input=$(e.target);var model_ob=TS.shared.getActiveModelOb();var new_val=$.trim(input.val());if(model_ob.topic.value===new_val){TS.menu.end();return}if(model_ob.is_group){TS.groups.setTopic(model_ob.id,new_val)}else if(model_ob.is_channel){TS.channels.setTopic(model_ob.id,new_val)}TS.menu.end()}},startWithList:function(e,$list,options){if(!$list||!$list.length)return;if(TS.menu.isRedundantClick(e))return;options=options||{};TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html($list.html());TS.menu.$menu.addClass(options.menu_class);if(options.close_on_click||options.onClick){TS.menu.$menu_items.on("click.menu","li",function(e){if(typeof options.onClick==="function")options.onClick(e);if(options.close_on_click)TS.menu.end()})}TS.menu.start(e,undefined,{onClose:options.onClose});var menu_gap=3;var $target=$(e.currentTarget);var left_offset=0;if(options.align_right){left_offset=$target.outerWidth()-TS.menu.$menu.outerWidth()}var top_offset=$target.outerHeight()+menu_gap;TS.menu.positionAt($target,left_offset,top_offset)},startWithDatePicker:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_date_picker_items());TS.menu.$menu_items.on("click.menu","li",TS.menu.onDatePickerItemClick);TS.menu.$menu.attr("data-qa","date_picker_menu");var $date_picker_container=$("#date_picker_cal_container");TS.ui.date_picker.startJumpToDatePicker($date_picker_container);TS.menu.$menu.addClass("date_picker")},onDatePickerItemClick:function(e){var id=$(this).attr("id");var model_ob=TS.shared.getActiveModelOb();if($(this).hasClass("disabled")){TS.menu.end();return}if(id=="date_picker_back_item"){e.preventDefault();_no_reposition=true;if(model_ob.is_channel){TS.menu.channel.startWithChannel(e,model_ob.id)}else if(model_ob.is_im){TS.menu.member.startWithMember(e,model_ob.user,false,false,true)}else if(model_ob.is_mpim){TS.menu.mpim.startWithMpim(e,model_ob.id)}else if(model_ob.is_group){TS.menu.group.startWithGroup(e,model_ob.id)}TS.menu.$menu.removeClass("date_picker");return}else{TS.warn("not sure what to do with clicked element id:"+id);return}},startWithMessageActions:function(e,msg_ts,msgs,model_ob){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var msg=TS.utility.msgs.getMsg(msg_ts,msgs);model_ob=model_ob||TS.shared.getActiveModelOb();if(!msg&&TS.boot_data.feature_message_replies&&TS.replies.isEnabledForModelOb(model_ob)){msg=TS.ui.replies.getActiveMessage(model_ob,msg_ts)}if(!msg&&TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing){msg=TS.client.threads.getMessage(model_ob,msg_ts)}if(!msg&&TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){msg=TS.client.unread.getMessage(model_ob,msg_ts)}var actions=TS.utility.msgs.getMsgActions(msg,model_ob);var is_unread_view=TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing;var allow_mark_unread=actions.mark_unread&&(TS.utility.msgs.getMarkMsgTSForUnreadPoint(msg_ts,msgs,model_ob)||is_unread_view)&&!TS.model.archive_view_is_showing&&!msg.is_ephemeral;actions.mark_unread=!!allow_mark_unread;if(TS.boot_data.feature_message_replies&&TS.boot_data.feature_message_replies_off&&actions.reply){actions.reply=!!msg.reply_count}var template_args={msg:msg,actions:actions,model_ob:model_ob,is_all_unreads_showing:TS.model.unread_view_is_showing};template_args.abs_permalink=TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts);if(msg.subtype=="file_share"||msg.subtype=="file_mention"){if(msg.file){template_args.abs_permalink=msg.file.permalink}}if(TS.replies&&TS.replies.isEnabled()){template_args.is_in_conversation=$(e.target).closest("ts-conversation").length>0;if(TS.boot_data.feature_message_replies){template_args.is_in_thread=TS.model.threads_view_is_showing||template_args.is_in_conversation}}TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_message_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onMessageActionClick);if(TS.boot_data.feature_reminders_v3){TS.log("enabled reminders msg action menu");TS.menu.has_submenu=true;var $remind_me=TS.menu.$menu_items.find("#remind_me");$remind_me.on("highlighted",function(){$remind_me.submenu({items_html:TS.templates.remind_me_items(),onclick:TS.menu.onMessageActionClick})}).on("unhighlighted",function(){if(TS.menu.$submenu&&!TS.menu.$submenu.hasClass("kb_active"))$remind_me.submenu("destroy")})}TS.menu.start(e);var $el=$(e.target);TS.menu.$target_element=$el.closest("[data-action]");TS.menu.$target_element.addClass("active");TS.menu.$secondary_target_element=$el.closest("ts-message");TS.menu.$secondary_target_element.addClass("active");var top_offset=0;var left_offset=$el.width()+10;if(TS.client&&!TS.model.ui_state.flex_visible)left_offset=-(TS.menu.$menu.width()+10);var $center_item=TS.menu.$menu.find("#edit_link");if($center_item.length===0)$center_item=TS.menu.$menu.find("#rxn_link");if($center_item.length>0){var menu_top=TS.menu.$menu.offset().top;var center_item_top=$center_item.offset().top;top_offset=-(center_item_top-menu_top+$center_item.height()/2-5)}TS.menu.positionAt($el,left_offset,top_offset);TS.menu.keepInBounds()},onMessageActionClick:function(e){e.preventDefault();if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}var $target=$(this);var id=$target.attr("id");var msg_ts=$target.data("msg-ts");var model_ob_id=$target.data("model-ob-id");var rxn_key=$target.data("rxn-key");var model_ob=model_ob_id?TS.shared.getModelObById(model_ob_id):TS.shared.getActiveModelOb();if(id=="edit_link"){var edit_state=$target.data("edit-state");TS.msg_edit.startEdit(msg_ts,model_ob,edit_state)}else if(id=="delete_link"){TS.msg_edit.startDelete(msg_ts,model_ob)}else if(id=="jump_to_original_link"){TS.client.ui.tryToJump(model_ob.id,msg_ts)}else if(id=="reply_link"){var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg&&TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){msg=TS.client.unread.getMessage(model_ob,msg_ts)}if(msg&&TS.replies&&TS.replies.canReplyToMsg(model_ob,msg)){var thread_ts=msg.thread_ts||msg.ts;TS.ui.replies.openConversation(model_ob,thread_ts)}}else if(id==="pin_link"){TS.pins.startPinMessage(msg_ts,model_ob)}else if(id==="unpin_link"){TS.pins.unPinMessage(msg_ts,model_ob)}else if(id==="rxn_link"){TS.menu.emoji.start({e:e,rxn_key:rxn_key})}else if(id==="mark_unread"){if(TS.model.unread_view_is_showing){TS.client.ui.unread.setUnreadPoint(msg_ts)}else{TS.info("setting unread point on "+model_ob.id+" due to message action click ("+msg_ts+")");TS.client.msg_pane.setUnreadPoint(msg_ts)}}else if(id==="copy_link"){TS.clipboard.writeText($(this).data("permalink"))}else if(id==="open_original_link"){}else if($(e.target).data("msg-action")==="remind"){TS.api.call("reminders.addFromMessage",{time:$(e.target).data("remind-length"),message_channel:model_ob.id,message_ts:$("#remind_me").data("msg-ts")},function(ok,data,args){})}else if(id==="share_message_link"){TS.ui.share_message_dialog.start(msg_ts,model_ob)}TS.menu.end()},startWithCommentActions:function(e,file_id,comment_id){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var file=TS.files.getFileById(file_id);if(!file)return;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment)return;var model_ob=TS.shared.getActiveModelOb();var actions=TS.files.getFileCommentActions(comment,file);TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_comment_action_items({model_ob:model_ob,file:file,comment:comment,actions:actions}));var $el=$(e.target);TS.menu.$menu_items.on("click.menu","li",function(menu_item_event){var $original_cog_clicked=$el.closest(".comment_actions");TS.menu.onCommentActionClick(menu_item_event,$original_cog_clicked)});TS.menu.start(e);var top_offset=0;var left_offset=-(TS.menu.$menu.width()+10);var $center_item=TS.menu.$menu.find("#edit_file_comment");if($center_item.length===0)$center_item=TS.menu.$menu.find("#rxn_file_comment");if($center_item.length>0){var menu_top=TS.menu.$menu.offset().top;var center_item_top=$center_item.offset().top;top_offset=-(center_item_top-menu_top+$center_item.height()/2-5)}TS.menu.positionAt($el,left_offset,top_offset);TS.menu.keepInBounds()},onCommentActionClick:function(e,$menu_target){e.preventDefault();var $target=$(e.target).closest("[id]");var id=$target.attr("id");var rxn_key=$target.data("rxn-key");var model_ob=TS.shared.getActiveModelOb();if(id=="edit_file_comment"){TS.ui.comments.startEdit($target.data("file-id"),$target.data("comment-id"),$menu_target)}else if(id=="delete_file_comment"){TS.ui.comments.startDelete($target.data("file-id"),$target.data("comment-id"))}else if(id=="rxn_file_comment"){TS.menu.emoji.start({e:e,rxn_key:rxn_key})}else if(id=="pin_comment"&&model_ob){TS.pins.startPinFileComment($target.data("comment-id"),$target.data("file-id"),model_ob)}else if(id=="unpin_comment"&&model_ob){TS.pins.unPinFileComment($target.data("comment-id"),$target.data("file-id"),model_ob)}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithSpaceWeb:function(e,file_id,user_id){var SPACING_BETWEEN_TARGET_AND_MENU=5;if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var file=TS.files.getFileById(file_id);if(!file)return;var actions=TS.files.getFileActions(file);var shared_in=file.channels.concat(file.groups).concat(file.ims);var can_enable_collab_editing=file.user==user_id&&shared_in.length&&file.state!=="uneditable";var template_args={file:file,actions:actions,can_write_to_clipboard:TS.clipboard.canWriteText(),can_enable_collab_editing:can_enable_collab_editing,collab_enabled:file.state!="locked"&&file.state!="uneditable"};TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_space_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onSpaceClickWeb);TS.kb_nav.setSubmitItemHandler(TS.menu.onSpaceClickWeb);TS.menu.start(e);var $menu_target=$(".space_btn_more");$("#toggle_input").bind("change",function(){e.preventDefault();var $menu_item=$("#toggle_collab_editing");var $checkbox=$(this);$menu_item.addClass("disabled");$checkbox.prop("disabled",true);TS.web.space.lockEditingPrivilegesWithCallback($checkbox.prop("checked"),function(response){var file=response&&response.data;var check=file?file.state!=="locked":!$checkbox.prop("checked");$menu_item.removeClass("disabled");$checkbox.prop("disabled",false);$checkbox.prop("checked",check)})});var x_offset=-TS.menu.$menu.outerWidth()+$menu_target.outerWidth();var y_offset=$menu_target.outerHeight()+SPACING_BETWEEN_TARGET_AND_MENU;TS.menu.positionAt($menu_target,x_offset,y_offset)},onSpaceClickWeb:function(e){var id=$(this).attr("id");var file=TS.files.getFileById($(this).data("file-id"));if(!file)return;if(id=="keyboard_shortcuts"){e.preventDefault();TS.ui.shortcuts_dialog.start(true)}else if(id=="learn_more"){}else if(id=="feedback"){e.preventDefault();TS.web.space.provideFeedback()}else if(id=="delete_space"){e.preventDefault();TS.web.file.deleteFile(file.id)}else if(id=="copy_space_link"){e.preventDefault();if(TS.clipboard.canWriteText()){TS.clipboard.writeText(file.permalink)}else{TS.warn("User clicked copy link, but we can't write to the clipboard right now")}}else if(id=="create_public_space_link"){e.preventDefault();TS.files.createPublicURL(file)}else if(id=="view_public_space_link"){e.preventDefault();TS.web.space.showPublicUrlDialog()}else if(id=="print_space"){window.print();e.preventDefault()}else if(id=="toggle_collab_editing"){return}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()},startWithTeamAndUser:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.submenu_template_args={};var is_tinyspeck=TS.model&&TS.model.team&&TS.boot_data.feature_tinyspeck;var is_dev=TS.boot_data.version_ts=="dev";var show_version_info=is_tinyspeck||is_dev;var template_args={user:TS.model.user,team:TS.model.team,team_name:TS.model.team.name,logout_url:TS.boot_data.logout_url,signin_url:TS.boot_data.signin_url,help_url:TS.boot_data.help_url,show_version_info:show_version_info,current_team_is_in_enterprise:false,current_team_gets_logout_url:true,show_customize_link:TS.model.user.is_admin||!TS.model.team.prefs.emoji_only_admins||!TS.model.team.prefs.slackbot_responses_only_admins||!TS.model.team.prefs.loading_only_admins,show_statistics_link:TS.model.user.is_admin||!TS.model.team.prefs.stats_only_admins,is_our_app:TS.model.is_our_app,show_team_subdivider:TS.model.user.is_admin,can_invite:TS.ui.admin_invites.canInvite()};function createLogoutURL(team_id){var el_a=document.createElement("a");el_a.href=TS.boot_data.logout_url;var logout_url=el_a.protocol+"//"+el_a.host+"/signout/"+team_id+el_a.search+el_a.hash;el_a=null;return logout_url}var other_accounts_length=Object.keys(TS.boot_data.other_accounts).length;if(other_accounts_length)template_args.other_accounts=TS.boot_data.other_accounts;if(TS.model.team.enterprise_id)template_args.current_team_is_in_enterprise=true;var signed_into_enterprise=false;var other_accounts_obj=TS.boot_data.other_accounts;var other_accounts_without_enterprise_teams={};for(var team in other_accounts_obj){if(other_accounts_obj[team]["enterprise_id"]){if(!template_args.other_enterprise_accounts){signed_into_enterprise=true;template_args.other_enterprise_accounts=_(other_accounts_obj).filter(function(item){return item.enterprise_id}).groupBy("enterprise_id").map(function(item){var ob={};ob.enterprise_id=item[0].enterprise_id;ob.enterprise_name=item[0].enterprise_name;if(TS.model.user.enterprise_user&&ob.enterprise_id===TS.model.user.enterprise_user.enterprise_id){var all_teams_in_enterprise=TS.model.enterprise_teams;var user_teams=[];TS.model.user.enterprise_user.teams.forEach(function(team_id,index){if(team_id===TS.model.team.id)return;var team=all_teams_in_enterprise.filter(function(t){return t.id===team_id})[0];user_teams.push({team_id:team_id,team_url:item[0].team_url.replace(/\/[a-z0-9]+\./i,"/"+team.domain+"."),team_name:team.name})});user_teams=user_teams.sort(function(a,b){if(a.team_name<b.team_name)return-1;if(a.team_name>b.team_name)return 1;return 0});ob.enterprise_teams=user_teams}else{ob.enterprise_teams=item}ob.is_currently_logged_into=false;if(ob.enterprise_id===TS.model.team.enterprise_id){ob.is_enterprise_currently_logged_into=true;if(template_args.current_team_is_in_enterprise){template_args.current_team_gets_logout_url=false}template_args.enterprise_logout_url=TS.boot_data.enterprise_logout_url;template_args.enterprise_domain=TS.boot_data.enterprise_url;if(item[0].team_id!==TS.model.team.id){}}else{ob.needs_other_enterprise_logout=true;ob.logout_url=createLogoutURL(ob.enterprise_id)}return ob}).value();if(TS.model.user.enterprise_user){template_args.other_enterprise_accounts=template_args.other_enterprise_accounts.sort(function(a,b){if(a.enterprise_id===TS.model.user.enterprise_user.enterprise_id)return-1;if(b.enterprise_id===TS.model.user.enterprise_user.enterprise_id)return 1;return 0})}}}else{other_accounts_obj[team].logout_url=createLogoutURL(other_accounts_obj[team].team_id);other_accounts_without_enterprise_teams[other_accounts_obj[team]["team_id"]]=other_accounts_obj[team]}}if(signed_into_enterprise){if(Object.keys(other_accounts_without_enterprise_teams).length){template_args.other_accounts=other_accounts_without_enterprise_teams}else if(Object.keys(template_args.other_enterprise_accounts).length){delete template_args.other_accounts}}if(template_args.current_team_is_in_enterprise){template_args.current_team_gets_logout_url=false;template_args.enterprise_logout_url=TS.boot_data.enterprise_logout_url;template_args.enterprise_domain=TS.boot_data.enterprise_url}if(TS.boot_data.page_needs_enterprise){if((signed_into_enterprise||template_args.current_team_is_in_enterprise)&&(template_args.other_enterprise_accounts&&Object.keys(template_args.other_enterprise_accounts).length||template_args.other_accounts&&Object.keys(template_args.other_accounts).length))template_args.show_switch_teams_submenu=true}TS.menu.$menu.addClass("team_menu slack_menu");TS.menu.$menu.attr("data-qa","team_menu");TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_body.html(TS.templates.menu_slack_menu(template_args));TS.menu.$menu_items.addClass("hidden");var $menu_content=TS.menu.$menu_body;$menu_content.on("click.menu","li",TS.menu.onTeamAndUserItemClick);$menu_content.on("click.menu",".member_preview_link",function(e){e.preventDefault();TS.client.ui.previewMember(TS.model.user.id)});$menu_content.on("mouseenter.section_header","> div.section_header",TS.kb_nav.clearHighlightedItem);TS.kb_nav.setSubmitItemHandler(TS.menu.onTeamAndUserItemClick);if(TS.boot_data.page_needs_enterprise){TS.menu.has_submenu=true;$menu_content.on("mouseenter","li:not(.divider)",TS.menu.onTeamAndUserItemMouseenter);TS.menu.submenu_template_args["administration"]={};TS.menu.submenu_template_args["switch_teams"]=template_args}var menu_offset_y=55;if(TS.boot_data.feature_electron_window_gripper&&TS.model.is_electron&&TS.model.is_mac&&TSSSB.call("isMainWindowFrameless")){menu_offset_y+=7}TS.menu.start(e);TS.menu.positionAt($("#team_menu"),10,menu_offset_y);TS.view.members.updateUserDisplayName();if(TS.boot_data.feature_user_custom_status)TS.view.members.updateUserCurrentStatus();TS.view.setFlexMenuSize()},onTeamAndUserItemMouseenter:function(e){if(TS.menu.$submenu&&TS.menu.$submenu_parent)TS.menu.$submenu_parent.submenu("destroy");if($(e.currentTarget).hasClass("has_submenu")){var subroutine=$(this).attr("id")||$(this).data("action");var $menu_content=TS.menu.$menu_body;var template_args={};if(TS.menu.submenu_template_args[subroutine])template_args=TS.menu.submenu_template_args[subroutine];switch(subroutine){case"administration":if(TS.model.user.enterprise_user&&(TS.model.user.enterprise_user.is_admin||TS.model.user.enterprise_user.is_owner)){template_args.show_org_settings=true;template_args.enterprise_domain=TS.boot_data.enterprise_url}TS.menu.$submenu_parent=$menu_content.find("#administration");TS.menu.$submenu_parent.submenu({items_html:TS.templates.administration_items(template_args),onclick:TS.menu.onTeamAndUserItemSubmenuClick});return;case"switch_teams":TS.menu.$submenu_parent=$menu_content.find("#switch_teams");TS.menu.$submenu_parent.submenu({items_html:TS.templates.switch_teams_items(template_args),onclick:TS.menu.onTeamAndUserItemSubmenuClick});return;default:break}}},onTeamAndUserItemSubmenuClick:function(e){var $closest_li=$(e.target).closest("li");var subroutine=$closest_li.attr("id")||$closest_li.data("action");switch(subroutine){case"team_settings":case"manage_team":case"switch_team":case"logout":case"enterprise_logout":case"org_settings":break;default:e.preventDefault();return}if(TS.menu.$submenu&&TS.menu.$submenu_parent)TS.menu.$submenu_parent.submenu("destroy");TS.menu.end()},onTeamAndUserItemClick:function(e){clearTimeout(TS.menu.end_time);var $this=$(this);if($this.is("[disabled]")||$this.hasClass("disabled")){e.preventDefault();return}var subroutine=$this.attr("id");if(!subroutine&&$this.hasClass("switch_team"))subroutine="switch_team";switch(subroutine){case"shared_channels":e.preventDefault();TS.ui.shared_channels_invites.start();break;case"version_info":e.preventDefault();TS.ui.showVersionInfo();break;case"member_account_item":e.preventDefault();TS.client.ui.previewMember(TS.model.user.id);break;case"team_settings":case"manage_team":case"team_billing":case"team_services":case"team_customize":case"team_statistics":break;case"team_apps":TS.metrics.count("team_menu_download_apps");break;case"team_invitations":e.preventDefault();TS.ui.admin_invites.start();var params=TS.clog.parseParams(this.getAttribute("data-clog-params"));TS.clog.track(this.getAttribute("data-clog-event"),params);break;case"member_prefs_item":e.preventDefault();TS.ui.prefs_dialog.start();break;case"team_help":e.preventDefault();_openHelp("team_menu");break;case"add_team":if(TSSSB.call("signInTeam"))e.preventDefault();break;case"member_presence":e.preventDefault();TS.members.toggleUserPresence();TS.menu.end_time=setTimeout(TS.menu.end,1e3);return;case"logout":e.preventDefault();if(TS.client)TS.client.windows.closeAll();TS.utility.loadUrlInWindowIfOnline(TS.boot_data.logout_url);break;case"enterprise_login":if(TSSSB.call("signInTeam"))e.preventDefault();break;case"enterprise_logout":break;case"switch_team":var team_id=$(this).data("user-id");if(TSSSB.call("displayTeam",team_id)){e.preventDefault()}else{var href=$(this).find("a").attr("href");if(href&&href.indexOf("?")==-1)$(this).find("a").attr("href",[href,TS.getQsArgsForUrl()].join("?"))}break;default:e.preventDefault();return}TS.menu.end()},startWithNotificationsMenu:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var status=TS.dnd.memberDndStatus();var template_args={user:TS.model.user,model_ob:TS.shared.getActiveModelOb(),in_dnd:status.in_dnd,is_snoozing:status.snoozed,readable_end_time:status.readable_end_time};TS.menu.has_submenu=true;TS.menu.$menu.addClass("notifications_menu");TS.menu.$menu_header.html(TS.templates.notifications_header(template_args));TS.menu.$menu_items.html(TS.templates.notifications_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onNotificationsMenuItemClick);var $adjust=TS.menu.$menu_items.find("#adjust_snooze_time");$adjust.on("highlighted",function(){$adjust.submenu({items_html:TS.templates.snooze_items(),onclick:TS.menu.onNotificationsMenuItemClick})}).on("unhighlighted",function(){if(TS.menu.$submenu&&!TS.menu.$submenu.hasClass("kb_active"))$adjust.submenu("destroy")});TS.menu.start(e);TS.menu.positionAt($("#team_menu .notifications_menu_btn"),-10,24)},onNotificationsMenuItemClick:function(e){var $action=$(e.target).closest("[data-dnd-menu-action]");if(!$action.length)return;var action=$action.data("dnd-menu-action");var status=TS.dnd.memberDndStatus();if(action==="turn_off"){
if(status.snoozed){TS.dnd.endSnooze()}else if(status.in_dnd){TS.dnd.endDnd()}}else if(action==="snooze"){var minutes=parseInt($action.data("snooze-length"));if(minutes&&!isNaN(minutes)){TS.dnd.setSnooze(minutes)}}else if(action==="dnd_schedule"){TS.ui.prefs_dialog.start("notifications",null,"prefs_dnd")}else if(action==="channel_settings"){var model_ob=TS.shared.getActiveModelOb();TS.ui.channel_prefs_dialog.start(model_ob.id)}else if(action==="notif_prefs"){TS.ui.prefs_dialog.start("notifications")}TS.menu.end()},startWithFlexMenu:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_flexpane_items({special_flex_panes:TS.boot_data.special_flex_panes,show_downloads:TS.model.supports_downloads,is_enterprise:TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise}));TS.menu.$menu_items.on("click.menu","li",TS.menu.onFlexMenuItemClick);TS.menu.start(e);TS.menu.$menu.addClass("flex_menu");TS.menu.$menu.attr("data-qa","flex_menu");TS.utility.queueRAF(function flexToggleRAF(){var $button=$("#flex_menu_toggle");var x=-(TS.menu.$menu.width()-$button.width());var y=6+$button.height();TS.menu.positionAt($button,x,y)});TS.help.updateIcon();TS.client.whats_new.updateIcon();$("#flex_menu_toggle").addClass("menu_open");$("#flex_menu_callout").bind("click",function(e){TS.menu.end()});TS.view.setFlexMenuSize()},onFlexMenuItemClick:function(e){var delay_ms=200;var $tab=$(this);var tab_id=$(this).data("tab-id");if(tab_id){var flex_name=tab_id;setTimeout(function(){if(flex_name=="files"){TS.client.ui.files.toggleFileList("all");TS.client.ui.files.filterFileList("all")}else if(flex_name=="team"){TS.client.ui.showTeamList()}else if(flex_name=="groups"&&TS.boot_data.feature_searchable_member_list){TS.client.ui.showGroupsList()}else{if(flex_name=="whats_new"&&TS.boot_data.feature_clog_whats_new){var badged=!$tab.find("#whats_new_count").hasClass("hidden");if(badged){TS.clog.track("WHATSNEW_ACTION",{action:"open_pane_badged",trigger:"flex_menu"})}else{TS.clog.track("WHATSNEW_ACTION",{action:"open_pane",trigger:"flex_menu"})}}TS.client.ui.flex.openFlexTab(flex_name)}},delay_ms)}else if($(this).data("filetype")){var filetype=$(this).data("filetype");var $file_list=$("#file_list");if(!$file_list.length||!$file_list.children().length){if(TS.view.files.last_files_html){TS.view.files.last_files_html=""}}setTimeout(function(){TS.client.ui.files.toggleFileList("all");TS.client.ui.files.filterFileList(filetype);TS.view.files.setButtonState(filetype)},delay_ms)}else{var id=$(this).attr("id");if(id=="help"){e.preventDefault();setTimeout(function(){_openHelp("flex_menu")},delay_ms)}}TS.menu.end()},startWithUserGroupMenu:function(e,user_group_id){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.user_group=TS.user_groups.getUserGroupsById(user_group_id);TS.menu.$menu.addClass("no_min_width");var show_user_groups_disable=TS.members.canUserCreateAndDeleteUserGroups()&&!TS.menu.user_group.date_delete;var show_user_groups_enable=TS.members.canUserCreateAndDeleteUserGroups()&&TS.menu.user_group.date_delete;var show_user_group_delete=TS.boot_data.feature_subteams_hard_delete&&!TS.menu.user_group.auto_type&&!TS.menu.user_group.is_external;TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.user_group_items({show_user_groups_edit:TS.members.canUserEditUserGroups(),show_user_groups_disable:show_user_groups_disable,show_user_groups_enable:show_user_groups_enable,show_user_group_delete:show_user_group_delete}));TS.menu.$menu_items.on("click.menu","li",TS.menu.onUserGroupMenuItemClick);TS.menu.start(e);TS.utility.queueRAF(function flexToggleRAF(){TS.menu.positionAt($("#user_group_menu_toggle"),-(TS.menu.$menu.width()-$("#user_group_menu_toggle").width()),37)})},onUserGroupMenuItemClick:function(e){var action=$(this).data("action");if(action==="edit_info"){TS.ui.admin_user_groups.editInfo(TS.menu.user_group)}else if(action==="edit_members"){TS.ui.admin_user_groups.editMembers(TS.menu.user_group)}else if(action==="disable"){TS.ui.admin_user_groups.disable(TS.menu.user_group)}else if(action==="enable"){TS.ui.admin_user_groups.enable(TS.menu.user_group)}else if(action==="delete"){TS.ui.admin_user_groups.remove(TS.menu.user_group)}TS.menu.end()},startWithSearchFilter:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();var template_args={search_exclude_bots:TS.model.prefs.search_exclude_bots,search_only_my_channels:TS.model.prefs.search_only_my_channels,search_only_current_team:TS.model.prefs.search_only_current_team,result_type:TS.search.filter==="messages"?"messages":"files",is_enterprise:TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu.addClass("search_filter_menu");TS.menu.$menu_items.html(TS.templates.menu_search_filter_items(template_args));TS.menu.start(e);_convertToPopoverMenu();var $menu_anchor=$("#search_filter_menu_label");TS.menu.positionAt($menu_anchor,-8,$menu_anchor.height()+10);$("#search_only_my_channels_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"search_only_my_channels",value:!$(this).prop("checked")})});$("#search_exclude_bots_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"search_exclude_bots",value:!$(this).prop("checked")})});$("#search_only_current_team_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"search_only_current_team",value:!$(this).prop("checked")})});TS.menu.search_filter_is_showing=true;$("#search_filter_menu_label").addClass("active")},startWithMentionsFilter:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();var template_args={exclude_at_channels:TS.model.prefs.mentions_exclude_at_channels,exclude_at_user_groups:TS.model.prefs.mentions_exclude_at_user_groups,show_user_group_filter:true};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu.addClass("search_filter_menu");TS.menu.$menu_items.html(TS.templates.menu_mentions_filter_items(template_args));TS.menu.start(e);_convertToPopoverMenu();var $menu_anchor=$("#mentions_filter_menu_label");TS.menu.positionAt($menu_anchor,-8,$menu_anchor.height()+10);$("#exclude_at_channels_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"mentions_exclude_at_channels",value:!$(this).prop("checked")})});$("#exclude_at_user_groups_cb").bind("change",function(){TS.prefs.setPrefByAPI({name:"mentions_exclude_at_user_groups",value:!$(this).prop("checked")})});$("#mentions_filter_menu_label").addClass("active")},startWithEditTeamProfileListActions:function(e,onclick){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();var $el=$(e.target);var field=TS.team.getTeamProfileFieldById($el.data("id"));var template_args={id:field.id,hidden:!!(field&&field.is_hidden)};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.admin_menu_edit_team_profile_list_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",onclick);TS.menu.start(e);TS.menu.positionAt($el.find('[data-action="edit_team_profile_list_menu"]'),-(TS.menu.$menu.width()+6),0);TS.menu.keepInBounds()},startWithAllUnreadsSortOrderMenu:function(e){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var template_args={sort_order:TS.client.unread.getSortOrder(),is_paid_team:TS.model.team.plan!==""};TS.menu.has_submenu=true;TS.menu.$menu.addClass("all_unreads_sort_order_menu");TS.menu.$menu_items.html(TS.templates.unread_sort_order_menu(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.onAllUnreadsSortOrderMenuItemClick);TS.menu.start(e);TS.menu.positionAt($(".channel_header_info_count"),105,20)},onAllUnreadsSortOrderMenuItemClick:function(e){var $action=$(e.target).closest("[data-sort-order]");if(!$action.length)return;var sort_order=$action.data("sortOrder");if(sort_order===TS.client.unread.getSortOrder()){TS.menu.end();return}TS.model.prefs.all_unreads_sort_order=sort_order;TS.prefs.setPrefByAPI({name:"all_unreads_sort_order",value:sort_order});TS.prefs.all_unreads_sort_order_changed_sig.dispatch(sort_order);TS.client.ui.unread.updateChannelHeader();TS.client.unread.reload();TS.menu.end()},positionAt:function($el,x_plus,y_plus){x_plus=x_plus||0;y_plus=y_plus||0;var offset=$el.offset();var x=offset.left+x_plus;var y=offset.top+y_plus;TS.menu.$menu.css({top:y,left:x})},isRedundantClick:function(e){if(TS.isPartiallyBooted()){e.preventDefault();TS.incremental_boot.userDidInteractWithUI();return true}if(e&&TS.menu.last_e&&(e.target==TS.menu.last_e.target||e.currentTarget==TS.menu.last_e.currentTarget))return true;return false},isLarge:function(){return TS.menu&&TS.menu.$menu&&TS.menu.$menu.find("li").length>TS.menu.large_dom_trigger},start:function(e,position_by_click,options){options=options||{};TS.menu.last_e=e;if(!_no_reposition){var offset=$(e.target).offset();var x=offset.left+$(e.target).width()+10;var y=offset.top;if(position_by_click){x=e.pageX+10;y=e.pageY+10}}$(".tooltip").hide();TS.tips.hideAll();$(e.currentTarget).addClass("active");TS.menu.$target_element=$(e.currentTarget);TS.model.menu_is_showing=true;var $menu=TS.menu.$menu;if(options.onClose){$menu.one("closed",options.onClose)}var is_large_list=TS.menu.isLarge();if(!_no_reposition){$menu.css({top:y,left:x})}var $menu_items_scroller=$menu.find("#menu_items_scroller");$menu_items_scroller.scrollTop(0);if(TS.client){$menu.appendTo($("#client-ui"))}else{$menu.appendTo($("body"))}if(!is_large_list&&!_no_reposition){$menu.css("opacity",0);$menu.stop().transition({opacity:1},200)}else{$menu.css("opacity",1)}$menu.find(".menu_close").on("click",TS.menu.end);TS.menu.keepInBounds();TS.ui.utility.updateClosestMonkeyScroller($menu_items_scroller,true);if(TS.menu.menu_lazy_load&&TS.menu.menu_lazy_load.detachEvents){TS.menu.menu_lazy_load.detachEvents()}TS.menu.menu_lazy_load=TS.menu.$menu_items.find(".lazy").lazyload({container:$("#menu_items_scroller"),all_images_same_size:true,throttle:250});$(window).bind("resize",TS.menu.keepInBounds);$(window.document).bind("keydown",TS.menu.onKeyDown);$("html").bind("mousedown touchstart",TS.menu.onMouseDown);var $menu_list=$menu.find(".menu_list");if(TS.menu.has_submenu){TS.kb_nav.start($menu.find("#menu_items"),"li:not(.divider)",$menu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists})}else{if($menu_list.length){TS.kb_nav.start($menu_list,"li")}else{TS.kb_nav.start($menu.find("#menu_items"),"li:not(.divider)")}}var $first_menu_list_link=$menu_list.length?$menu_list.first().find("a, button").first():null;if(TS.ui&&TS.ui.a11y)TS.ui.a11y.focusAndAddTabindex($first_menu_list_link);_no_reposition=false;_on_esc=options.on_esc},clean:function(){TS.menu.$menu_footer.empty();TS.menu.$menu_header.removeClass("hidden");TS.menu.$menu.removeClass("no_min_width no_max_width profile_preview flex_menu search_filter_menu popover_menu no_icons team_menu file_menu notifications_menu all_unreads_sort_order_menu").css("max-height","");TS.menu.$menu.removeAttr("data-qa");TS.menu.$menu.find("#menu_items_scroller").css("max-height","");TS.menu.$menu.find(".arrow, .arrow_shadow").remove();TS.menu.$menu_items.off("mouseenter.section_header");TS.menu.$menu.removeClass("narrow_menu");TS.menu.$menu_body.off("mouseenter.section_header");if(TS.boot_data.feature_browse_date){TS.menu.$menu.removeClass("date_picker")}if(TS.boot_data.page_needs_enterprise){TS.menu.$menu_list_container.html('<div id="menu_list" role="menu"></div>').removeClass("populated");TS.menu.$menu_list=TS.menu.$menu.find("#menu_list");TS.menu.$menu.off("keydown","#file_member_filter .member_filter")}_on_esc=null},end:function(){TS.model.menu_is_showing=false;TS.menu.menu_items_hidden=true;TS.menu.has_submenu=false;TS.menu.$submenu_parent=null;TS.menu.submenu_template_args={};var $menu=TS.menu.$menu;var menu_end=function(){if(TS.model.menu_is_showing)return;setTimeout(function(){if(!TS.model.menu_is_showing)TS.menu.last_e=null},50);$menu.detach();TS.menu.$menu_header.empty();TS.menu.$menu_footer.empty();TS.menu.$menu_items.empty();TS.menu.clean()};if(!TS.menu.isLarge()&&!_no_reposition){$menu.stop().transition({opacity:0},200,menu_end)}else{menu_end()}$menu.trigger("closed");TS.menu.$menu_items.removeClass("hidden");TS.menu.$menu_body.empty();if(TS.menu.$target_element){TS.menu.$target_element.removeClass("active");TS.menu.$target_element=null}if(TS.menu.$secondary_target_element){TS.menu.$secondary_target_element.removeClass("active");TS.menu.$secondary_target_element=null}if(TS.menu.mpim&&TS.menu.mpim.mpim&&TS.menu.mpim.mpim.members.length>4){$("#active_channel_name").find(".name").tooltip("enable")}TS.menu.user_group=null;TS.menu.$menu_header.unbind("click.menu");TS.menu.$menu_items.off("click.menu");TS.menu.$menu_body.off("click.menu");$(window).unbind("resize",TS.menu.keepInBounds);$(window.document).unbind("keydown",TS.menu.onKeyDown);$("html").unbind("mousedown touchstart",TS.menu.onMouseDown);TS.members.view.team_filter_changed_sig.remove(TS.kb_nav.clearHighlightedItem);TS.members.view.team_filter_changed_sig.remove(TS.menu.member.filterChanged,TS.menu);$(".file_list_item.active").removeClass("active");TS.tips.unhideAll();TS.menu.search_filter_is_showing=false;$("#search_filter_menu_label").removeClass("active");$("#mentions_filter_menu_label").removeClass("active");$("#flex_menu_toggle").removeClass("menu_open");$("#channel_actions_toggle").removeClass("active");$menu.removeClass("narrow_menu");setTimeout(function(){TS.menu.file.file_list_menu_up=false;$(".inline_file_preview_container.file_menu_open, .file_container.file_menu_open").removeClass("file_menu_open")},100);if(TS.menu.menu_lazy_load&&TS.menu.menu_lazy_load.detachEvents){TS.menu.menu_lazy_load.detachEvents();TS.menu.menu_lazy_load=null}TS.kb_nav.end();if(TS.client&&TS.model.ui.active_tab_id!="team"&&TS.model.ui.active_tab_id!="details")TS.client.flex_pane.stopLocalTimeInterval();TS.menu.menu_closed_sig.dispatch()},onKeyDown:function(e){var keymap=TS.utility.keymap;var key=e.which;var modifier_pressed=e.metaKey||e.ctrlKey||e.altKey;if(key==keymap.esc){e.stopPropagation();e.preventDefault();TS.menu.end();if(_on_esc)_on_esc();return}else if(!modifier_pressed&&!TS.utility.isArrowKey(key)&&key!=keymap.tab&&key!=keymap.enter){TS.kb_nav.clearHighlightedItem();if(key==keymap.enter){setTimeout(function(){$("#menu_member_dm_input").focus()},0)}else{$("#menu_member_dm_input").focus()}}},onLeftKeyDownIfSubmenuExists:function(e){var prevent_kb_default=false;if(TS.menu.$submenu&&TS.menu.$submenu.hasClass("kb_active")){TS.menu.$submenu.removeClass("kb_active");TS.kb_nav.end();TS.kb_nav.highlightItemWithKey(TS.menu.$submenu_origin);TS.kb_nav.start(TS.menu.$menu.find("#menu_items"),"li:not(.divider)",TS.menu.$menu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists});TS.menu.$submenu_origin.submenu("destroy");prevent_kb_default=true}return prevent_kb_default},onRightKeyDownIfSubmenuExists:function(e){var prevent_kb_default=false;if(TS.kb_nav.getHighlightedItem()&&TS.kb_nav.getHighlightedItem().data("has-submenu")){if(!TS.menu.$submenu){TS.kb_nav.getHighlightedItem().submenu({items_html:TS.templates.snooze_items(),onclick:TS.menu.onNotificationsMenuItemClick})}}if(TS.menu.$submenu){if(TS.menu.$submenu.hasClass("kb_active")){TS.menu.$submenu.removeClass("kb_active");TS.menu.end()}else{TS.menu.$submenu.addClass("kb_active");TS.kb_nav.end();TS.kb_nav.highlightItemWithKey(TS.menu.$submenu.find("li").first());TS.kb_nav.start(TS.menu.$submenu.find("ul"),"li:not(.divider)",TS.menu.$submenu,{onLeftKeyDownIfSubmenuExists:TS.menu.onLeftKeyDownIfSubmenuExists,onRightKeyDownIfSubmenuExists:TS.menu.onRightKeyDownIfSubmenuExists})}prevent_kb_default=true}return prevent_kb_default},onMouseDown:function(e){var $target=$(e.target);if($target.closest("#menu, .submenu").length===0||$target.hasClass("popover_mask")){TS.menu.end()}},keepInBounds:function(){if(window.requestAnimationFrame){window.requestAnimationFrame(TS.menu.keepInBoundsThrottled)}else{TS.menu.keepInBoundsThrottled()}},keepInBoundsThrottled:function(){var $menu=TS.menu.$menu;var allowance=10;var rect=$menu.dimensions_rect();var allow_rect={top:0+allowance,right:$(window).width()-allowance,bottom:$(window).height()-(allowance+14),left:0+allowance};if(TS.utility.doesRectContainRect(allow_rect,rect))return;if(rect.left<allow_rect.left){$menu.css("left",allow_rect.left)}else if(rect.right>allow_rect.right){$menu.css("left",Math.max(allow_rect.left,allow_rect.right-rect.width))}if(rect.top<allow_rect.top){$menu.css("top",allow_rect.top)}else if(rect.bottom>allow_rect.bottom){$menu.css("top",Math.max(allow_rect.top,allow_rect.bottom-rect.height+$(window).scrollTop()))}},addSubmenu:function(submenu_selector,items_html,onclick){var $submenu_element=TS.menu.$menu_items.find(submenu_selector);$submenu_element.on("highlighted",function(){$submenu_element.submenu({items_html:items_html,onclick:onclick})}).on("unhighlighted",function(){if(TS.menu.$submenu&&!TS.menu.$submenu.hasClass("kb_active")){$submenu_element.submenu("destroy")}})}});var _no_reposition=false;var _openHelp=function(trigger){TS.help_modal.start();TS.clog.track("HELP_MODAL_ACTION",{action:"open_modal",trigger:trigger})};var _convertToPopoverMenu=function(){var $menu=TS.menu.$menu;$menu.addClass("popover_menu");$menu.prepend('<span class="arrow"></span><span class="arrow_shadow"></span>')};$.widget("TS.submenu",{_create:function(){this.element.data("has-submenu",true);var html='<div class="menu submenu" data-origin-id="'+this.element.attr("id")+'" data-model-ob-id="'+this.element.data("modelObId")+'"><ul aria-hidden="true" aria-label="submenu">'+this.options.items_html+"</ul></div>";var X_OFFSET=7;var Y_OFFSET=11;var x=TS.menu.$menu.offset().left+TS.menu.$menu.width()+X_OFFSET;var y=this.element.offset().top-Y_OFFSET;this.$submenu=$(html);this.$submenu.appendTo("body");TS.menu.$submenu=this.$submenu;TS.menu.$submenu_origin=this.element;if(x+this.$submenu.width()>window.innerWidth){x=TS.menu.$menu.offset().left-this.$submenu.width()-X_OFFSET}if(y+this.$submenu.height()>window.innerHeight){y=window.innerHeight-this.$submenu.height()-Y_OFFSET}this.$submenu.css({position:"absolute",left:x+"px",top:y+"px"});var onclick=this.options.onclick;this.$submenu.on("click",function(e){onclick.call(this,e)})},_destroy:function(){TS.menu.$submenu=null;TS.menu.$submenu_origin=null;this.$submenu.remove()}})})();var _on_esc;(function(){"use strict";TS.registerModule("menu.app",{onStart:function(){_app_presence_list=TS.presence_manager.createList()},app:null,app_item_click_sig:new signals.Signal,startWithApp:function(e,app_id,bot_id,position_by_click){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing&&!TS.boot_data.feature_browse_date){return}TS.menu.buildIfNeeded();TS.menu.clean();TS.apps.promiseToGetFullAppProfile(app_id,bot_id).then(showAllAppInformation);function showAllAppInformation(app){_app_presence_list.add(app_id);var template_header_args={name:app.name,desc:app.desc,app_icons:app.icons,is_slack_integration:app.is_slack_integration};if(app.app_card_color){template_header_args.color=TS.utility.hex2rgb(app.app_card_color);template_header_args.color.hex=app.app_card_color}if(app.config&&app.config.is_custom_integration){if(app.config.icons){if(app.config.icons.emoji){var emoji_img_html=TS.emoji.graphicReplace(TS.utility.htmlEntities(app.config.icons.emoji),{force_img:true});template_header_args.emoji_img_tag=new Handlebars.SafeString(emoji_img_html)}else{template_header_args.bot_icons=app.config.icons}}if(app.bot_user){if(TS.boot_data.feature_name_tagging_client){template_header_args.name=app.config.full_name?app.config.full_name:app.bot_user.username}else{template_header_args.name=app.config.real_name?app.config.real_name:app.bot_user.username}}else{template_header_args.name=app.config.username}template_header_args.desc=app.config.descriptive_label}var template_items_args={bot_id:bot_id,commands:app.commands,is_slack_integration:app.is_slack_integration};if(!app.is_slack_integration&&!app.auth){template_items_args.disabled=true}else if(app.is_slack_integration&&app.config&&(app.config.is_active!=="1"||app.config.date_deleted!=="0")){template_items_args.disabled=true}if(app.card_posting_summary){var escaped_summary=TS.utility.htmlEntities(app.card_posting_summary);escaped_summary=escaped_summary.replace(/@([A-Z0-9]+)/g,function(match,user_id){var name_replace="<b>";if(TS.boot_data.feature_name_tagging_client){name_replace+=TS.utility.htmlEntities(TS.members.getMemberFullName(app.auth.created_by))}else{name_replace+=TS.members.getMemberDisplayNameById(app.auth.created_by,true,true)}name_replace+="</b>";return name_replace});template_items_args.card_posting_summary=new Handlebars.SafeString(escaped_summary)}TS.menu.$menu_header.html(TS.templates.menu_app_card_header(template_header_args));TS.menu.$menu_items.html(TS.templates.menu_app_card_items(template_items_args));TS.menu.start(e,position_by_click);TS.menu.$menu_items.on("click.menu","li",TS.menu.app.onAppItemClick);TS.menu.keepInBounds()}},onAppItemClick:function(e){var $item=$(this);var action=$item.data("action");clearTimeout(TS.menu.end_time);if(action==="slash_command"){var command=$item.data("name");var current_input=TS.utility.contenteditable.value(TS.client.msg_input.$input);if(current_input){TS.client.msg_input.populate(command+" "+current_input)}else{TS.client.msg_input.populate(command)}TS.client.msg_input.$input.focus();TS.client.msg_input.$input.trigger("textchange");if(current_input){TS.client.msg_input.$input[0].setSelectionRange(command.length+1,(command+" "+current_input).length)}if(TS.boot_data.feature_you_autocomplete_me){TS.client.msg_input.$input.TS_tabCompleteNew("promiseToChoose",undefined,true)}else{TS.client.msg_input.$input.TS_tabComplete("promiseToChoose",undefined,true)}}TS.menu.app.end()},end:function(){TS.menu.app.app=null;TS.menu.end()}});var _app_presence_list})();(function(){"use strict";TS.registerModule("menu.channel",{onStart:function(){},channel:null,startWithChannel:function(e,channel_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing&&!TS.boot_data.feature_browse_date){return}TS.menu.buildIfNeeded();TS.menu.clean();TS.menu.channel.channel=TS.channels.getChannelById(channel_id);var channel=TS.menu.channel.channel;var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.$menu_header.addClass("hidden").empty();var template_args={channel:channel,user:TS.model.user,show_email_item:show_email_item,show_handy_rxns:TS.model.user.is_admin&&TS.boot_data.feature_thanks};if(!channel.is_general||TS.members.canUserPostInGeneral()){if(channel.purpose.last_set===0&&!TS.model.user.is_ultra_restricted&&channel.is_member)template_args.show_purpose_item=true}var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(TS.channels.getActiveMembersNotInThisChannelForInviting(channel_id));if(invite_members.length===0){template_args.disable_invite=true}if(TS.notifs.isCorGMuted(channel.id))template_args.channel_is_muted=true;if(channel.is_member&&(!channel.is_general||TS.members.canUserPostInGeneral()))template_args.show_advanced_item=true;if(TS.boot_data.page_needs_enterprise&&channel.is_shared){if(TS.model.user.enterprise_user&&(TS.model.user.enterprise_user.is_admin||TS.model.user.enterprise_user.is_owner))template_args.show_manage_teams=true;if(template_args.show_advanced_item){if(TS.boot_data.feature_shared_channels_settings&&!TS.members.canUserManageSharedChannels())template_args.show_advanced_item=false}template_args.is_not_allowed_integrations=true}TS.menu.$menu_items.html(TS.templates.menu_channel_items(template_args));TS.menu.$menu_header.bind("click.menu",TS.menu.channel.onChannelHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.channel.onChannelItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.channel.onChannelItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","channel_menu");if(TS.boot_data.feature_browse_date){TS.menu.$menu.addClass("narrow_menu");TS.ui.date_picker.getOldestMsgTs()}var use_channel_name_toggle=TS.boot_data.feature_channel_name_menu&&$(e.target).closest("#channel_name").length;var $toggle_button=use_channel_name_toggle?$("#channel_name"):$("#channel_actions_toggle");var toggle_button_height=$toggle_button.height();var y_plus=use_channel_name_toggle?toggle_button_height+6:toggle_button_height;var x_plus=use_channel_name_toggle?18:6;TS.menu.positionAt($toggle_button,x_plus,y_plus);if(template_args.disable_invite){$("#channel_invite_item a").tooltip({title:"Everyone on your team is already in this channel",delay:{show:500,hide:0}})}},onChannelHeaderClick:function(e){e.preventDefault()},onChannelItemClick:function(e){var id=$(this).attr("id");if($(this).hasClass("disabled")){TS.menu.channel.end();return}if(id=="channel_join_item"){e.preventDefault();if(TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==TS.menu.channel.channel.id){TS.channels.join(TS.client.archives.current_model_ob.name)}else{TS.channels.displayChannel(TS.menu.channel.channel.id)}}else if(id=="channel_details_item"){e.preventDefault();if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="details"){$("#details_tab").highlight(null,"channel_page_details_highlighter")}else{TS.client.ui.flex.openFlexTab("details")}}else if(id=="channel_handy_rxns_item"){TS.ui.handy_rxns.startChannelDialog(TS.menu.channel.channel.id)}else if(id=="channel_display_item"){e.preventDefault();TS.channels.displayChannel(TS.menu.channel.channel.id)}else if(id=="channel_close_archived_item"){e.preventDefault();TS.channels.closeArchivedChannel(TS.menu.channel.channel.id)}else if(id=="channel_leave_item"){e.preventDefault();TS.channels.leave(TS.menu.channel.channel.id)}else if(id=="channel_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="channel_email_item"){}else if(id=="channel_manage_teams_item"){e.preventDefault();TS.ui.channel_manage_teams_dialog.start(TS.menu.channel.channel.id)}else if(id=="channel_advanced_item"){e.preventDefault();TS.ui.channel_options_dialog.start(TS.menu.channel.channel.id)}else if(id=="channel_unarchive_item"){e.preventDefault();TS.api.call("channels.unarchive",{channel:TS.menu.channel.channel.id},function(ok,data,args){if(ok)return;var err_str='Un-archiving failed with error "'+data.error+'"';if(data.error=="restricted_action"){err_str="<p>You don't have permission to un-archive channels.</p><p>Talk to your Team Owner.</p>"}setTimeout(TS.generic_dialog.alert,100,err_str)})}else if(id=="channel_archives_item"){}else if(id==="channel_jump_item"){e.preventDefault();TS.menu.startWithDatePicker(e);return}else if(id=="channel_mute_item"){e.preventDefault();TS.notifs.muteOrUnmuteCorG(TS.menu.channel.channel.id)}else if(id=="channel_files_item"){TS.client.ui.flex.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="channel_rename_item"){e.preventDefault();TS.ui.channel_create_dialog.start(TS.menu.channel.channel.name,TS.menu.channel.channel)}else if(id=="channel_purpose_item"){e.preventDefault();TS.ui.purpose_dialog.start(TS.menu.channel.channel.name,TS.menu.channel.channel)}else if(id=="channel_invite_item"){e.preventDefault();TS.ui.channel_invite_modal.startInviteToChannelModal(TS.menu.channel.channel.id)}else if(id=="channel_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.channel.channel.id)}else if(id=="channel_add_service_item"){}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.channel.end()},startWithChannelPickerForChange:function(e,user_id){if(TS.menu.isRedundantClick(e))return;TS.menu.buildIfNeeded();TS.menu.clean();var member=TS.members.getMemberById(user_id);var channels_for_ura=[],groups_for_ura=[];$.each(TS.channels.getUnarchivedChannelsForUser(),function(index,channel){if(!member.channels.hasOwnProperty(channel.id)){channels_for_ura.push(channel)}});$.each(TS.groups.getUnarchivedGroups(),function(index,group){if(!member.groups.hasOwnProperty(group.id)){groups_for_ura.push(group)}});var template_args={user_id:user_id,channels:channels_for_ura,groups:groups_for_ura};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",TS.menu.channel.onChannelPickerItemClickChangeChannel);TS.menu.start(e);var $el=$(e.target).closest(".pill");if(TS.boot_data.app=="mobile"){TS.menu.positionAt($el,-$el.offset().left+16,0)}else{TS.menu.positionAt($el,-TS.menu.$menu.width()+$el.outerWidth(),$el.height()+4)}TS.menu.$menu.scrollintoview({duration:500,offset:"bottom",px_offset:-25});_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onChannelPickerItemClickChangeChannel:function(e){var user_id=$(this).data("user-id"),channel_id=$(this).data("channel-id"),group_id=$(this).data("group-id");if(channel_id){TS.api.call("users.admin.changeURAChannel",{user:user_id,channel:channel_id},TS.web.admin.onMemberURAChanged)}else if(group_id){TS.api.call("users.admin.changeURAChannel",{user:user_id,channel:group_id},TS.web.admin.onMemberURAChanged)}TS.menu.channel.end()},startWithChannelPickerForInvite:function(e,user_id){if(TS.menu.isRedundantClick(e))return;TS.menu.buildIfNeeded();TS.menu.clean();var member=TS.members.getMemberById(user_id);var channels_for_ra=[],groups_for_ra=[];$.each(TS.channels.getUnarchivedChannelsForUser(),function(index,channel){if(!member.channels.hasOwnProperty(channel.id)){channels_for_ra.push(channel)}});$.each(TS.groups.getUnarchivedGroups(),function(index,group){if(!member.groups.hasOwnProperty(group.id)){groups_for_ra.push(group)}});var template_args={user_id:user_id,channels:channels_for_ra,groups:groups_for_ra};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",TS.menu.channel.onChannelPickerItemClickInviteChannel);TS.menu.start(e);var $el=$(e.target).closest(".pill");if(TS.boot_data.app=="mobile"){TS.menu.positionAt($el,-$el.offset().left+16,0)}else{TS.menu.positionAt($el,-$el.width()+10,$el.height()+4)}TS.menu.$menu.scrollintoview({duration:500,offset:"bottom",px_offset:-25});_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onChannelPickerItemClickInviteChannel:function(e){var user_id=$(this).data("user-id"),channel_id=$(this).data("channel-id"),group_id=$(this).data("group-id");if(channel_id){TS.api.call("channels.invite",{user:user_id,channel:channel_id},TS.web.admin.onMemberInviteChannel)}else if(group_id){TS.api.call("groups.invite",{user:user_id,channel:group_id},TS.web.admin.onMemberInviteGroup)}TS.menu.channel.end()},startWithChannelPicker:function(e,model_obs,item_selected_callback){if(TS.menu.isRedundantClick(e))return;TS.menu.buildIfNeeded();TS.menu.clean();var channels=[];var groups=[];var mpims=[];model_obs.forEach(function(model_ob){if(model_ob.is_channel){channels.push(model_ob)}else if(model_ob.is_mpim){mpims.push(model_ob)}else if(model_ob.is_group){groups.push(model_ob)}});var template_args={user_id:TS.model.user.id,channels:channels,groups:groups,
mpims:mpims};TS.menu.$menu_header.html(TS.templates.menu_channel_picker_header(template_args));TS.menu.$menu_items.html(TS.templates.menu_channel_picker(template_args)).css("max-height",274);TS.menu.$menu_items.on("click.menu","li",item_selected_callback);TS.menu.start(e);_bindChannelFilterStart();TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},end:function(){TS.menu.channel.channel=null;TS.menu.end()}});var _bindChannelFilterStart=function(){var $none_found=TS.menu.$menu.find(".no_results");var $close_icon=TS.menu.$menu.find(".icon_close");var $filter=TS.menu.$menu.find(".menu_filter");var prev_query="";$close_icon.click(function(){$filter.val("").trigger("change");$filter.focus()});TS.menu.$menu_items.children("li").each(function(){var channel_id=$(this).data("channel-id");if(channel_id){var channel=TS.channels.getChannelById(channel_id);if(channel){$(this).data("name","#"+channel.name)}return}var group_id=$(this).data("group-id");if(group_id){var group=TS.groups.getGroupById(group_id);if(group){$(this).data("name",group.name)}}var mpim_id=$(this).data("mpim-id");if(mpim_id){var mpim=TS.mpims.getMpimById(mpim_id);if(mpim)$(this).data("mpim",mpim)}});$filter.on("keyup change paste",TS.utility.debounce(function(e){var query=$(this).val();if(query){if(prev_query!==query){var any_found=false;var name_regex=new RegExp(TS.utility.regexpEscape(query),"i");var prefix_regexes=[];var queries=query.split(/[,| ]/).filter(function(i){return!!i});for(var i=0;i<queries.length;i++){prefix_regexes.push(new RegExp("^"+TS.utility.regexpEscape(queries[i]),"i"))}$close_icon.removeClass("hidden");TS.menu.$menu_items.children("li").removeClass("hidden").each(function(){var name=$(this).data("name");var mpim=$(this).data("mpim");if(name){var match=name.match(name_regex);if(match){any_found=true;return}}else if(mpim){if(TS.mpims.checkMpimMatch(mpim,prefix_regexes)){any_found=true;return}}$(this).addClass("hidden")});if(any_found){$none_found.addClass("hidden")}else{$none_found.removeClass("hidden");$none_found.find(".query").text(query)}TS.kb_nav.clearHighlightedItem()}}else{TS.menu.$menu_items.children("li.hidden").removeClass("hidden");$none_found.addClass("hidden");$close_icon.addClass("hidden");if(prev_query!==query){TS.kb_nav.clearHighlightedItem()}}prev_query=query;TS.ui.utility.updateClosestMonkeyScroller(TS.menu.$menu.find("#menu_items_scroller"),true)},250));$filter.focus()}})();(function(){"use strict";TS.registerModule("menu.enterprise_team_signin",{start:function(e,el,options){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;options=_.merge({},options);TS.menu.buildIfNeeded();TS.menu.enterprise_team_signin.clean();TS.menu.$menu.addClass("enterprise_team_signin_menu");TS.menu.$menu_header.addClass("hidden").empty();var items_html=TS.templates.enterprise_team_signin_menu_items({should_show_leave_team:false,team_site_url:options.team_site_url||""});TS.menu.$menu_items.html(items_html);TS.menu.$menu_items.on("click.menu","li",TS.menu.enterprise_team_signin.onMenuItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.enterprise_team_signin.onMenuItemClick);TS.menu.start(e,false);TS.menu.$menu.attr("data-qa","enterprise_team_signin_menu");TS.menu.positionAt(el,el.width()-TS.menu.$menu.width(),el.outerHeight()+10)},onMenuItemClick:function(e){var $clicked=$(this).closest("[data-which]");if(!$clicked.length)$clicked=$(e.target).closest("[data-which]");var which=$clicked.data("which");if(which=="visit_team_site"){}else if(which=="leave_team"){e.preventDefault()}else{e.preventDefault();TS.warn("not sure what to do with clicked element:"+which)}TS.menu.enterprise_team_signin.end()},clean:function(){TS.menu.clean()},end:function(){TS.menu.end()}})})();(function(){"use strict";TS.registerModule("menu.file",{onStart:function(){},reported_no_file_reader:false,startWithNewFileOptions:function(e,el){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.file.clean();TS.menu.$menu.addClass("file_menu");TS.menu.$menu_header.addClass("hidden").empty();var should_show_upload_file=window.File&&TS.model.team.prefs.disable_file_uploads!=="disable_all";if(should_show_upload_file){var file_type=TS.model.team.prefs.disable_file_uploads==="disable_all_except_images"?"an image":"a file";var upload_file_text="Upload "+file_type}else{if(!TS.menu.file.reported_no_file_reader){TS.menu.file.reported_no_file_reader=true;TS.info("TS.menu: No File support?  navigator.userAgent: "+navigator.userAgent)}var file_type="";var upload_file_text=""}var should_show_email=TS.boot_data.feature_email_ingestion&&TS.model.team.prefs.allow_email_ingestion;var should_show_thanks=TS.boot_data.feature_thanks;var should_show_box=TS.utility.box.isBrowserSupported()&&TS.model.prefs.box_enabled;var should_show_multnomah=TS.boot_data.feature_multnomah;var should_show_dropbox=window.Dropbox&&Dropbox.isBrowserSupported()&&TS.model.prefs.dropbox_enabled;var should_show_gdrive=TS.boot_data.feature_gdrive_1_dot_5&&TS.model.team.prefs.gdrive_enabled_team;var cloud_service_count=0;if(should_show_box)cloud_service_count++;if(should_show_dropbox)cloud_service_count++;if(should_show_gdrive)cloud_service_count++;var use_cloud_submenu=cloud_service_count>1;var items_html=TS.templates.menu_file_new_file_items({should_show_upload_file:should_show_upload_file,should_show_email:should_show_email,should_show_thanks:should_show_thanks,should_show_box:should_show_box,should_show_dropbox:should_show_dropbox,should_show_gdrive:should_show_gdrive,should_show_multnomah:should_show_multnomah,file_type:file_type,upload_file_text:upload_file_text,use_cloud_submenu:use_cloud_submenu});TS.menu.$menu_items.html(items_html);TS.menu.addSubmenu("#gdrive_create_submenu",TS.templates.menu_file_gdrive_doc_type_items(),TS.menu.file.onGDriveDocumentTypeItemClick);if(use_cloud_submenu){var cloud_html=TS.templates.menu_file_cloud_service_items({should_show_box:should_show_box,should_show_dropbox:should_show_dropbox,should_show_gdrive:should_show_gdrive});TS.menu.addSubmenu("#cloud_submenu",cloud_html,TS.menu.file.onNewFileOptionsItemClick)}TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onNewFileOptionsItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.file.onNewFileOptionsItemClick);var is_primary_file_button=el&&el.attr("id")=="primary_file_button";var on_esc;if(TS.client&&is_primary_file_button){on_esc=function(){TS.client.ui.$msg_input.focus()}}TS.menu.start(e,false,{on_esc:on_esc});TS.menu.$menu.attr("data-qa","file_menu");if(is_primary_file_button){TS.menu.positionAt(el,1,-(TS.menu.$menu.height()+6))}else{TS.menu.positionAt(el,el.width()-TS.menu.$menu.width(),el.outerHeight()+10)}},onGDriveDocumentTypeItemClick:function(e){var $anchor=$(e.target);var type=$anchor.data("doc-type");if(!type)return;var $loading_icon=TS.templates.mentions_loading_indicator();_$plus_icon_cached.remove();_$primary_file_button.append($loading_icon);TS.files.gdrive.createAndShare(type);TS.menu.file.end();_$primary_file_button.toggleClass("active",true)},onGDriveCreateComplete:function(success,response){if(success&&response){if($("#allow_popups_banner").is(":visible")){TS.client.ui.addEphemeralBotMsg({text:"It looks like your browser is blocking popups so here's a link to your <"+response.data.url+"|document>",ephemeral_type:"created_google_drive_document"})}}_$primary_file_button.find(".ts_icon").remove();_$primary_file_button.toggleClass("active",false).append(_$plus_icon_cached);return},onNewFileOptionsItemClick:function(e){var $clicked=$(this).closest("[data-which]");if(!$clicked.length)$clicked=$(e.target).closest("[data-which]");var which=$clicked.data("which");if(which=="choose"){e.preventDefault();TS.client.ui.files.$upload.trigger("click")}else if(which=="email"){}else if(which=="reaction_poll"){e.preventDefault();if(TS.boot_data.feature_thanks)TS.ui.handy_rxns.startPollDialog(TS.model.active_cid)}else if(which=="snippet"){e.preventDefault();TS.client.msg_input.startSnippet()}else if(which=="post"){}else if(which=="box"){e.preventDefault();TS.files.openBoxChooser()}else if(which=="dropbox"){e.preventDefault();TS.files.openDropboxChooser()}else if(which=="gdrive_import"){e.preventDefault();TS.files.gdrive.openPickerWindow()}else if(which=="gdrive_create_submenu"){e.preventDefault()}else if(which=="cloud_submenu"){e.preventDefault()}else if(which=="space"){e.preventDefault();var open_in_browser=TS.utility.cmdKey(e);TS.files.createAndOpenNewSpace(null,open_in_browser)}else if(which=="multnomah"){e.preventDefault();var open_in_browser=TS.utility.cmdKey(e);TS.files.createAndOpenNewMultnomah(null,open_in_browser)}else{e.preventDefault();TS.warn("not sure what to do with clicked element:"+which)}TS.menu.file.end()},startWithFileFilter:function(e,search_filter){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.file.clean();var active_type="all";if(TS.model.file_list_types){active_type=TS.model.file_list_types[0]}var show_email_item=TS.boot_data.feature_email_ingestion&&TS.model.team.prefs.allow_email_ingestion||TS.model.team.plan;TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_file_filter_items({active_type:active_type,show_email_item:show_email_item}));if(search_filter){TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onSearchFileFilterItemClick)}else{TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onFileFilterItemClick)}TS.menu.start(e);if(search_filter){TS.menu.positionAt($("#search_results_container"),8,74)}else{TS.menu.positionAt($("#file_list_container"),8,44)}},onFileFilterItemClick:function(e){e.preventDefault();TS.client.ui.files.filterFileList($(this).data("filetype"));TS.view.files.setButtonState($(this).data("filetype"));TS.menu.file.end()},onSearchFileFilterItemClick:function(e){e.preventDefault();TS.search.setFiletypeFilter($(this).data("filetype"));TS.view.files.setButtonState($(this).data("filetype"));TS.menu.file.end()},startWithFileMemberPromiseFilter:function(e,search_filter){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.file.clean();TS.menu.$menu_header.html(TS.templates.menu_file_member_header());TS.menu.start(e);if(TS.boot_data.page_needs_enterprise)$("#menu_promise_spinner").removeClass("hidden");if(search_filter){TS.menu.positionAt($("#search_results_container"),102,100)}else{var $btn=$("#file_list_toggle_user");TS.menu.positionAt($("#file_list_toggle_user"),0,$btn.outerHeight())}_promiseToFilterMembers("",e,search_filter).then(_maybeStartLongListView).then(_displayFilterMembersResults)},startWithFileMemberFilter:function(e,search_filter){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.file.clean();TS.menu.$menu_header.html(TS.templates.menu_file_member_header());var members=_humansGreaterThanBots(TS.members.getMembersForUser());TS.menu.$menu_items.html(TS.templates.menu_file_member_filter_items({members:members}));if(search_filter){TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onSearchFileMemberFilterItemClick)}else{TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onFileMemberFilterItemClick)}TS.menu.start(e);if(search_filter){TS.menu.positionAt($("#search_results_container"),102,100)}else{var $btn=$("#file_list_toggle_user");TS.menu.positionAt($("#file_list_toggle_user"),0,$btn.outerHeight())}TS.members.view.bindTeamFilter("#file_member_filter","#menu_items_scroller");$("#file_member_filter").find(".member_filter").focus().keydown(function(e){if(e.which==TS.utility.keymap.enter){var visible_members=$("#menu_items .member_item.active");if(visible_members.length==1){visible_members.find("a").click()}}});TS.members.view.team_filter_changed_sig.add(TS.kb_nav.clearHighlightedItem,TS.kb_nav);TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},onFileMemberFilterItemClick:function(e){e.preventDefault();var id=$(e.currentTarget).data("member-id");TS.client.ui.files.toggleFileList(id);TS.menu.file.end()},onSearchFileMemberFilterItemClick:function(e){e.preventDefault();var id=$(e.currentTarget).data("member-id");TS.search.setMember(id);TS.menu.file.end()},file_list_menu_up:false,startWithFileActions:function(e,file_id){if(TS.client&&!TS.model.ms_connected){TS.sounds.play("beep");return}if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.file.clean();var file=TS.files.getFileById(file_id);if(!file)return;var actions=TS.files.getFileActions(file);var $el=$(e.target);var $actions=$el.closest(".file_actions");if(actions.comment&&$actions.data("exclude-comment"))actions.comment=false;if(actions.download&&$actions.data("exclude-download"))actions.download=false;if(actions.open_original&&$actions.data("exclude-original"))actions.open_original=false;if(actions.rxn_file&&$actions.data("exclude-rxn"))actions.rxn_file=false;if(actions.pin_file&&($actions.data("exclude-pin")||$actions.data("exclude-pin-file")))actions.pin_file=false;if(actions.unpin_file&&($actions.data("exclude-pin")||$actions.data("exclude-unpin-file")))actions.unpin_file=false;if(actions.edit&&$actions.data("exclude-edit"))actions.edit=false;if(actions.edit_title&&$actions.data("exclude-edit-title"))actions.edit_title=false;if(actions.print&&$actions.data("exclude-print"))actions.print=false;if(actions.create_public_link&&$actions.data("exclude-create-public-link"))actions.create_public_link=false;if(actions.revoke_public_link&&$actions.data("exclude-revoke-public-link"))actions.revoke_public_link=false;if($actions.data("include-open-flexpane"))actions.open_in_flexpane=true;if($actions.data("include-open-file-page"))actions.open_file_page=true;if($actions.data("include-view-public-link"))actions.view_public_link=true;var in_file_list=$el.closest(".file_list_item").length>0;if(in_file_list){if(TS.model.ui_state.flex_name!=="details"||!TS.boot_data.feature_files_list)actions.share=false;TS.menu.file.file_list_menu_up=true}var file_container=$el.closest(".inline_file_preview_container, .file_container");if(file_container.length>0){file_container.addClass("file_menu_open");actions.new_window=false}TS.menu.$menu_header.addClass("hidden").empty();var show_workflow_divider=false;if(actions.edit||TS.client&&actions.edit_title||actions.create_public_link||actions.revoke_public_link||actions.print||actions.save_to_dropbox||actions.refresh){show_workflow_divider=true}var template_args={file:file,actions:actions,is_refreshing:TS.files.waiting_for_refresh[file.id],model_ob:TS.shared.getActiveModelOb(),show_workflow_divider:show_workflow_divider};if(TS.model.unread_view_is_showing){template_args.source_model_ob_id=$el.closest(".unread_group").data("modelId")}if(TS.client)template_args.info_pane_visible=TS.model.ui_state.flex_name==="details";TS.menu.$menu_items.html(TS.templates.menu_file_action_items(template_args));if(TS.boot_data.feature_fix_files){TS.menu.$menu.addClass("no_icons")}if(TS.web){TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onFileActionClickWeb)}else if(TS.client){TS.menu.$menu_items.on("click.menu","li",TS.menu.file.onFileActionClickClient)}TS.menu.start(e);$el.closest(".file_list_item").addClass("active");TS.menu.positionAt($el,-(TS.menu.$menu.width()+6),0);TS.menu.keepInBounds()},onFileActionClickClient:function(e){var id=$(this).attr("id");var rxn_key=$(this).data("rxn-key");var file=TS.files.getFileById($(this).data("file-id"));var model_ob=TS.shared.getActiveModelOb();var source_model_ob_id=$(this).data("sourceModelId");if(!file){TS.error("no file id:"+$(this).data("file-id"));return}if(id=="share_file"){e.preventDefault();TS.view.files.shareInCurrentChannelOrIM(file.id,source_model_ob_id)}else if(id=="edit_file_snippet"){if(!file.is_truncated){e.preventDefault();TS.ui.snippet_dialog.startEdit(file.id)}}else if(id=="edit_file_post"){}else if(id=="edit_file_space"||id=="open_new_window"){if(TS.client.windows.openFileWindow(file.id))e.preventDefault()}else if(id=="edit_file_multnomah"){}else if(id=="edit_file_title"){e.preventDefault();TS.client.ui.files.previewFile(file.id,"file_list");TS.files.editFileTitle(file.id)}else if(id=="delete_file"){e.preventDefault();TS.view.files.delete(file.id)}else if(id=="create_public_link"){e.preventDefault();if(TS.model.team.prefs.disallow_public_file_urls){if(TS.boot_data.feature_external_files){TS.generic_dialog.alert("An administator has disabled external file URL creation. You will not be able to create an external URL for this file.");return}else{TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this file.");return}}TS.files.createPublicURL(file,function(ok,data,args){if(ok){if(TS.model.previewed_file_id)$("#file_preview_scroller").find(".file_actions_link").scrollintoview({duration:500,offset:"top",px_offset:-50});$(".file_public_link_"+file.id).highlightText();TS.ui.file_share.fileShowPublicUrlDialog(file)}})}else if(id=="revoke_public_link"){e.preventDefault();TS.ui.file_share.fileRevokePublicLink(file.id)}else if(id=="view_public_link"){e.preventDefault();TS.ui.file_share.fileShowPublicUrlDialog(file)}else if(id=="refresh_file"){e.preventDefault();TS.files.refreshFile(file.id);TS.menu.$menu.find("#refresh_file .item_label").text("Refreshing...").end();return}else if(id=="download_file"){var open_flexpane=!(TS.ui.fs_modal_file_viewer&&TS.ui.fs_modal_file_viewer.is_showing);if(TS.client&&TS.client.downloads.startDownload(file,open_flexpane)){e.preventDefault()}}else if(id=="open_original_file"){}else if(id=="comment_file"){e.preventDefault();if(TS.model.previewed_file_id!=file.id){TS.client.ui.files.previewFile(file.id,"file_list",false,true)}else{$("#file_comment").focus()}}else if(id=="save_to_dropbox"){return TS.api.callImmediately("files.getTempURL",{file:file.id},function(ok,data,args){if(ok){Dropbox.save(data.url,file.name)}})}else if(id==="rxn_file"){e.preventDefault();TS.menu.emoji.start({e:e,rxn_key:rxn_key})}else if(id==="share_private_file"){e.preventDefault();TS.files.shareOrReshareFile(file.id)}else if(id==="pin_file"&&model_ob){e.preventDefault();TS.pins.startPinFile(file.id,model_ob)}else if(id==="unpin_file"&&model_ob){e.preventDefault();TS.pins.unPinFile(file.id,model_ob)}else if(id==="open_in_flexpane"){e.preventDefault();TS.client.ui.files.previewFile(file.id)}else if(id==="copy_file_link"){e.preventDefault();TS.clipboard.writeText(file.permalink)}else if(id==="star_file"){e.preventDefault();TS.stars.checkForStarClick(e)}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.file.end()},onFileActionClickWeb:function(e){var id=$(this).attr("id");var rxn_key=$(this).data("rxn-key");var file=TS.files.getFileById($(this).data("file-id"));var model_ob=TS.shared.getActiveModelOb();if(!file){TS.error("no file id:"+$(this).data("file-id"));return}if(id=="share_file"){e.preventDefault();TS.ui.share_dialog.start(file.id)}else if(id==="share_private_file"){e.preventDefault();TS.files.shareOrReshareFile(file.id)}else if(id=="edit_file_snippet"){}else if(id=="edit_file_post"){}else if(id=="edit_file_space"||id=="open_new_window"){}else if(id=="edit_file_title"){}else if(id=="delete_file"){e.preventDefault();TS.web.file.deleteFile(file.id)}else if(id=="create_public_link"){e.preventDefault();if(!TS.model.team.prefs.disallow_public_file_urls){TS.api.callImmediately("files.sharedPublicURL",{file:file.id},function(ok,data,args){if(ok){var $share_link=$(".file_public_link_shared");$share_link.slideToggle(100);TS.files.upsertAndSignal({id:file.id,public_url_shared:true});if($share_link.length===0)TS.ui.file_share.fileShowPublicUrlDialog(file)}else if(data.error&&data.error==="not_allowed"){TS.model.team.prefs.disallow_public_file_urls=true;if(TS.boot_data.feature_external_files){TS.generic_dialog.alert("An administator has disabled external file URL creation. You will not be able to create an external URL for this file.")}else{TS.generic_dialog.alert("An administator has disabled public file URL creation. You will not be able to create a public URL for this file.")}}})}}else if(id=="revoke_public_link"){e.preventDefault();if(TS.web.file){TS.web.file.revokePublicURL(file)}else{TS.ui.file_share.fileRevokePublicLink(file.id)}}else if(id=="view_public_link"){e.preventDefault();TS.ui.file_share.fileShowPublicUrlDialog(file)}else if(id=="refresh_file"){e.preventDefault();TS.files.refreshFile(file.id);TS.menu.$menu.find("#refresh_file .item_label").text("Refreshing...").end();return}else if(id=="download_file"){}else if(id=="print_file"){window.print();e.preventDefault()}else if(id=="open_original_file"){}else if(id=="comment_file"){e.preventDefault();$("#file_comment").focus()}else if(id=="save_to_dropbox"){return TS.api.callImmediately("files.getTempURL",{file:file.id},function(ok,data,args){if(ok){Dropbox.save(data.url,file.name)}})}else if(id==="rxn_file"){e.preventDefault();TS.menu.emoji.start({e:e,rxn_key:rxn_key})}else if(id==="pin_file"&&model_ob){e.preventDefault();TS.pins.startPinFile(file.id,model_ob)}else if(id==="unpin_file"&&model_ob){e.preventDefault();TS.pins.unPinFile(file.id,model_ob)}else if(id==="copy_file_link"){e.preventDefault();TS.clipboard.writeText(file.permalink)}else if(id==="open_file_page"){}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.file.end()},clean:function(){if(TS.boot_data.page_needs_enterprise){if(_$long_list_container)_$long_list_container=null;_member_searcher={}}TS.menu.clean()},end:function(){TS.menu.end()}});var _member_searcher={};var _$long_list_container;var _APPROXIMATE_LONG_LIST_ITEM_HEIGHT=25;var _$long_list_current_active_item;var _$primary_file_button=$('[data-js="primary_file_button"]');var _$plus_icon_cached=_$primary_file_button.find(".ts_icon_plus_thick");var _promiseToFilterMembers=function(query,e,search_filter){if(query.charAt(0)==="@")query=query.substring(1);if(e)_member_searcher._e=e;if(search_filter)_member_searcher._search_filter=search_filter;if(_member_searcher.query!==query){if(_$long_list_current_active_item)_$long_list_current_active_item.removeClass("active");_$long_list_current_active_item=null;_member_searcher.query=query;_member_searcher.include_org=TS.boot_data.page_needs_enterprise;_member_searcher.include_slackbot=true;_member_searcher.include_self=true;_member_searcher.full_profile_filter=false;_member_searcher.scroll_mark=0;if(_$long_list_container)_$long_list_container.off("scroll.filter")}return TS.members.promiseToSearchMembers(_member_searcher)};var _humansGreaterThanBots=function(items){var humans=[];var bots=[];for(var i=0;i<items.length;i++){var member=items[i];if(member.is_bot||member.is_slackbot){bots.push(member)}else{humans.push(member)}}return humans.concat(bots)};var _selectLongListItem=function(direction){var $to_select;if(!_$long_list_current_active_item){$to_select=TS.menu.$menu_list.find(".menu_list_item:not(.selected, .hidden)").first()}else{$to_select=_$long_list_current_active_item[direction](".menu_list_item:not(.selected, .hidden)").first()}if($to_select.length){$to_select.scrollintoview({duration:0});if(_$long_list_current_active_item)_$long_list_current_active_item.removeClass("active");$to_select.addClass("active");_$long_list_current_active_item=$to_select}};var _maybeStartLongListView=function(response){if(_$long_list_container)return Promise.resolve(response);TS.menu.$menu_list_container.addClass("populated");_$long_list_container=TS.menu.$menu_list;$("#file_member_filter").find(".member_filter").focus();_$long_list_container.longListView({items:_humansGreaterThanBots(response.items),approx_item_height:_APPROXIMATE_LONG_LIST_ITEM_HEIGHT,preserve_dom_order:true,makeElement:function(data){return $('<div class="menu_list_item member_item" role="menuitem"></div>')},renderItem:function($el,item,data){$el.data("member-id",item.id);$el.html(TS.templates.menu_long_list_member_item({member:item}))}});if(TS.boot_data.page_needs_enterprise)$("#menu_promise_spinner").addClass("hidden");_$long_list_container.monkeyScroll();_$long_list_container.on("click",".menu_list_item",function(e){if(response._search_filter){TS.menu.file.onSearchFileMemberFilterItemClick(e)}else{TS.menu.file.onFileMemberFilterItemClick(e)}});response._mouse={lastX:null,lastY:null};TS.menu.$menu_list.on("mousemove",".menu_list_item",function(e){if(e.clientX==response._mouse.lastX&&e.clientY==response._mouse.lastY)return;if(_$long_list_current_active_item)_$long_list_current_active_item.removeClass("active");if(!$(this).hasClass("active")){$(this).addClass("active");_$long_list_current_active_item=$(this)}response._mouse.lastX=e.clientX;response._mouse.lastY=e.clientY});TS.menu.$menu_list.on("mouseleave",".menu_list_item.active",function(e){$(this).removeClass("active");_$long_list_current_active_item=null});TS.menu.$menu.on("keydown","#file_member_filter .member_filter",function(e){if(e.keyCode===TS.utility.keymap.enter){if(_$long_list_current_active_item)_$long_list_current_active_item.click()}if(e.keyCode===TS.utility.keymap.down){_selectLongListItem("nextAll")}if(e.keyCode===TS.utility.keymap.up){_selectLongListItem("prevAll")}if(e.keyCode===TS.utility.keymap.esc){TS.menu.file.end();return}}).on("input",function(e){var val=$(e.target).val().trim();if(response._items_already_set)response._items_already_set=false;_promiseToFilterMembers(val).then(_displayFilterMembersResults)});response._items_already_set=true;return Promise.resolve(response)};var _displayFilterMembersResults=function(response){if(!response._items_already_set){_$long_list_container.longListView("setItems",_humansGreaterThanBots(response.items),true)}var $none_found=TS.menu.$menu.find(".no_results");if(0===response.items.length){$none_found.removeClass("hidden");$none_found.find(".query").text(response.query)}else{$none_found.addClass("hidden")}TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$long_list_container);_$long_list_container.longListView("resizeImmediately")});if(response._is_new)_$long_list_container.longListView("scrollToTop",true);if(response._is_new){_$long_list_container.on("scroll.filter",function(e){var maybe_scroll_mark=$(this).scrollTop()+$(this).height()+_APPROXIMATE_LONG_LIST_ITEM_HEIGHT;if(maybe_scroll_mark<=response.scroll_mark)return;var list_items_height=$(this).find(".list_items").height();if(maybe_scroll_mark>list_items_height&&_member_searcher._searcher_p&&_member_searcher._searcher_p.isResolved()){if(response._items_already_set)response._items_already_set=false;_promiseToFilterMembers(response.query).then(_displayFilterMembersResults);response.scroll_mark=maybe_scroll_mark}})}}})();(function(){"use strict";TS.registerModule("menu.group",{onStart:function(){},group:null,startWithGroup:function(e,group_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing&&!TS.boot_data.feature_browse_date){return}TS.menu.buildIfNeeded();TS.menu.clean();var group=TS.menu.group.group=TS.groups.getGroupById(group_id);var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.$menu_header.addClass("hidden").empty();var template_args={group:group,user:TS.model.user,show_email_item:show_email_item,leave_action:TS.groups.getLeaveAction(group_id),show_handy_rxns:TS.model.user.is_admin&&TS.boot_data.feature_thanks};if(group.purpose.last_set===0&&!TS.model.user.is_ultra_restricted)template_args.show_purpose_item=true;var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(TS.groups.getActiveMembersNotInThisGroupForInviting(group_id));if(invite_members.length===0){template_args.disable_invite=true}if(TS.notifs.isCorGMuted(group.id))template_args.group_is_muted=true;template_args.show_advanced_item=true;if(TS.boot_data.page_needs_enterprise&&group.is_shared){if(TS.model.user.enterprise_user&&(TS.model.user.enterprise_user.is_admin||TS.model.user.enterprise_user.is_owner))template_args.show_manage_teams=true;if(group.creator!==TS.model.user.id)template_args.show_advanced_item=false;if(TS.boot_data.feature_shared_channels_settings&&TS.members.canUserManageSharedChannels())template_args.show_advanced_item=true;template_args.is_not_allowed_integrations=true}TS.menu.$menu_items.html(TS.templates.menu_group_items(template_args));TS.menu.$menu_header.bind("click.menu",TS.menu.group.onGroupHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.group.onGroupItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","group_menu");if(TS.boot_data.feature_browse_date){TS.menu.$menu.addClass("narrow_menu");TS.ui.date_picker.getOldestMsgTs()}$("#menu_group_topic_input").bind("keydown",TS.menu.handleTopicKeydown);var use_channel_name_toggle=TS.boot_data.feature_channel_name_menu&&$(e.target).closest("#channel_name").length;var $toggle_button=use_channel_name_toggle?$("#channel_name"):$("#channel_actions_toggle");var toggle_button_height=$toggle_button.height();var y_plus=use_channel_name_toggle?toggle_button_height+6:toggle_button_height;var x_plus=use_channel_name_toggle?18:6;TS.menu.positionAt($toggle_button,x_plus,y_plus);if(template_args.disable_invite){$("#group_invite_item a").tooltip({title:"Everyone on your team is already in this private channel",delay:{show:500,hide:0}})}},onGroupHeaderClick:function(e){e.preventDefault()},onGroupItemClick:function(e){var id=$(this).attr("id");if($(this).hasClass("disabled")){TS.menu.end();return}if(id=="group_display_item"){e.preventDefault();TS.groups.displayGroup(TS.menu.group.group.id)}else if(id=="group_details_item"){e.preventDefault();if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="details"){$("#details_tab").highlight(null,"channel_page_details_highlighter")}else{TS.client.ui.flex.openFlexTab("details")}}else if(id=="group_handy_rxns_item"){TS.ui.handy_rxns.startChannelDialog(TS.menu.group.group.id)}else if(id=="group_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="group_mute_item"){e.preventDefault();TS.notifs.muteOrUnmuteCorG(TS.menu.group.group.id)}else if(id=="group_email_item"){}else if(id=="group_files_item"){TS.client.ui.flex.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="group_leave_item"){e.preventDefault();TS.groups.leave(TS.menu.group.group.id)}else if(id=="group_unarchive_item"){e.preventDefault();TS.api.call("groups.unarchive",{channel:TS.menu.group.group.id})}else if(id=="group_archives_item"){}else if(id=="group_jump_item"){e.preventDefault();TS.menu.startWithDatePicker(e);return}else if(id=="channel_manage_teams_item"){e.preventDefault();TS.ui.channel_manage_teams_dialog.start(TS.menu.group.group.id)}else if(id=="group_advanced_item"){e.preventDefault();TS.ui.channel_options_dialog.start(TS.menu.group.group.id)}else if(id=="group_purpose_item"){e.preventDefault();TS.ui.purpose_dialog.start(TS.menu.group.group.name,TS.menu.group.group)}else if(id=="group_invite_item"){e.preventDefault();TS.ui.channel_invite_modal.startInviteToChannelModal(TS.menu.group.group.id)}else if(id=="group_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.group.group.id)}else if(id=="group_add_service_item"){}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.end()}})})();(function(){"use strict";TS.registerModule("menu.member",{onStart:function(){_member_presence_list=TS.presence_manager.createList()},member:null,member_item_click_sig:new signals.Signal,startWithMember:function(e,member_id,position_by_click,is_header_menu,is_im_menu){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing&&!TS.boot_data.feature_browse_date){return}TS.menu.buildIfNeeded();var member=TS.menu.member.member=TS.members.getMemberById(member_id);if(!member)return;if(!TS.members.canUserSeeMember(member))return;
var show_email_item=TS.model.team.prefs.allow_email_ingestion;TS.menu.clean();_member_presence_list.add(member_id);TS.menu.menu_closed_sig.addOnce(function(){_member_presence_list.clear()});var template_args={member:member,show_dm_item:!is_im_menu,show_email_item:show_email_item,show_group_create:TS.members.canUserCreateGroups()&&!member.is_ultra_restricted,is_im_menu:is_im_menu};if(is_im_menu){TS.menu.$menu_header.addClass("hidden").empty();template_args.im=TS.ims.getImByMemberId(member_id)}else{TS.menu.$menu_header.html(TS.templates.menu_member_header(template_args));TS.client.flex_pane.startLocalTimeInterval()}if(is_header_menu&&member_id==TS.model.user.id){template_args.other_accounts=TS.boot_data.other_accounts;template_args.logout_url=TS.boot_data.logout_url;template_args.signin_url=TS.boot_data.signin_url}if(!member.deleted&&!member.is_slackbot&&member_id!=TS.model.user.id){if(!TS.model.user.is_ultra_restricted&&!member.is_ultra_restricted){var invite_channels=TS.members.getMyChannelsThatThisMemberIsNotIn(member_id);if(invite_channels.length){template_args.show_channel_invite=true}}}var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id||TS.model.active_group_id){if((!model_ob.is_general||member.is_restricted)&&member_id!=TS.model.user.id&&model_ob.members&&model_ob.members.indexOf(member_id)!=-1){if(!member.is_ultra_restricted){if(model_ob.is_group&&TS.members.canUserKickFromGroups()||model_ob.is_channel&&TS.members.canUserKickFromChannels()){template_args.channel_kick_name=(TS.model.active_channel_id?"#":"")+model_ob.name}}}}if(member_id=="USLACKBOT"){var show_slackbot_responses_item=false;if(TS.model.user.is_admin){show_slackbot_responses_item=true}else if(!TS.model.team.prefs.slackbot_responses_disabled&&!TS.model.team.prefs.slackbot_responses_only_admins){show_slackbot_responses_item=true}template_args.show_slackbot_responses_item=show_slackbot_responses_item}if(TS.boot_data.feature_calls&&TS.utility.calls.isEnabled()&&!member.is_bot&&member_id!="USLACKBOT"){template_args.show_call_action=true;if(TS.boot_data.page_needs_enterprise){var team=TS.model.team;if(team&&team.id!==member.team_id)template_args.show_call_action=false}}TS.menu.$menu_items.html(TS.templates.menu_member_items(template_args));if(member_id==TS.model.user.id){var menu_user_footer_html="";if(!is_im_menu){menu_user_footer_html+=TS.templates.menu_member_footer({member:member})}TS.menu.$menu_footer.html(menu_user_footer_html)}else{if(!is_im_menu){TS.menu.$menu_footer.html(TS.templates.menu_member_footer({member:member}))}}TS.menu.start(e,position_by_click);var keymap=TS.utility.keymap;var starting_im=false;$("#menu_member_dm_input").bind("keydown",function(e){var input=$(this);if(e.which==keymap.enter&&!e.shiftKey&&!starting_im){if($.trim(input.val())!==""){e.preventDefault();TS.ims.startImByMemberId(member.id,false,input.val());TS.menu.member.end();starting_im=true}}});if(member.is_self){TS.menu.$menu_header.find(".member_timezone_value a").on("click.timezone",function(e){if(TS.boot_data.feature_client_tz_picker){e.preventDefault()}else{e.stopPropagation()}TS.menu.member.end()})}TS.menu.$menu_header.bind("click.menu",TS.menu.member.onMemberHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.member.onMemberItemClick);TS.kb_nav.setSubmitItemHandler(TS.menu.member.onMemberItemClick);if(is_im_menu){var use_channel_name_toggle=TS.boot_data.feature_channel_name_menu&&$(e.target).closest("#channel_name").length;var $toggle_button=use_channel_name_toggle?$("#channel_name"):$("#channel_actions_toggle");var toggle_button_height=$toggle_button.height();var y_plus=use_channel_name_toggle?toggle_button_height+6:toggle_button_height;var x_plus=use_channel_name_toggle?18:6;TS.menu.positionAt($toggle_button,x_plus,y_plus);TS.menu.$menu.attr("data-qa","member_menu");if(TS.boot_data.feature_browse_date){TS.menu.$menu.addClass("narrow_menu");TS.ui.date_picker.getOldestMsgTs()}}$("#menu_user_status_input").select();if(is_im_menu){TS.view.setFlexMenuSize()}else{TS.menu.keepInBounds()}},onMemberHeaderClick:function(e){e.preventDefault();TS.client.ui.previewMember(TS.menu.member.member.id,"menu_member_header");TS.menu.member.end()},onMemberItemClick:function(e){var id=$(this).attr("id");clearTimeout(TS.menu.end_time);if(id=="member_photo_item"){}else if(id==="member_details_item"){e.preventDefault();if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="details"){$("#details_tab").highlight(null,"channel_page_details_highlighter")}else{TS.client.ui.flex.openFlexTab("details")}}else if(id=="member_archives_item"){}else if(id=="member_jump_item"){e.preventDefault();TS.menu.startWithDatePicker(e);TS.menu.member.member_item_click_sig.dispatch(id);return}else if(id=="member_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="member_email_item"){}else if(id=="member_skype_item"){}else if(id=="member_account_item"){}else if(id=="member_prefs_item"){e.preventDefault();TS.ui.prefs_dialog.start()}else if(id=="member_files_item"){e.preventDefault();TS.view.files.clearFilter();TS.client.ui.files.filterFileList(TS.menu.member.member.id)}else if(id=="member_im_files_item"){TS.client.ui.flex.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="member_dm_item"){e.preventDefault();TS.ims.startImByMemberId(TS.menu.member.member.id)}else if(id=="member_invite_channel_item"){e.preventDefault();TS.ui.invite.showInviteMemberToChannelDialog(TS.menu.member.member.id)}else if(id=="member_create_group_item"){e.preventDefault();TS.ui.new_channel_modal.start("",false,[TS.menu.member.member.id])}else if(id=="member_profile_item"){e.preventDefault();if(TS.menu.member.member.is_self){TS.ui.edit_member_profile.start()}else{TS.client.ui.previewMember(TS.menu.member.member.id)}}else if(id=="member_presence"){e.preventDefault();TS.members.toggleUserPresence();TS.menu.end_time=setTimeout(function(){TS.menu.member.end();TS.menu.member.member_item_click_sig.dispatch(id)},1e3);return}else if(id=="logout"){e.preventDefault();if(TS.client)TS.client.windows.closeAll();TS.utility.loadUrlInWindowIfOnline(TS.boot_data.logout_url)}else if($(this).hasClass("switch_team")){e.preventDefault();var team_id=$(this).data("team-id");if(TSSSB.call("displayTeam",team_id)){e.preventDefault()}else{var href=$(this).find("a").attr("href");if(href&&href.indexOf("?")==-1){$(this).find("a").attr("href",href+="?"+TS.getQsArgsForUrl())}}}else if(id=="member_kick_channel_item"){e.preventDefault();if(TS.model.active_channel_id){TS.channels.kickMember(TS.model.active_channel_id,TS.menu.member.member.id)}else if(TS.model.active_group_id){TS.groups.kickMember(TS.model.active_group_id,TS.menu.member.member.id)}}else if(id=="member_slackbot_responses"){}else if(id=="member_open_profile_item"){}else if(id=="member_call_item"){TS.utility.calls.startCallInModelOb(TS.menu.member.member)}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.member.end();TS.menu.member.member_item_click_sig.dispatch(id)},startWithMemberPreview:function(e,member_id,is_team_page,is_member_preview){if(TS.menu.isRedundantClick(e))return;if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var $btn=$(e.target).closest(".member_preview_menu_target");if(!member_id){member_id=$btn.closest("[data-member-id]").data("member-id")}var member=TS.menu.member.member=TS.members.getMemberById(member_id);var im=TS.ims.getImByMemberId(member_id);var template_args={member:member,is_team_directory:true,im_id:im&&im.id,hide_view_profile:is_member_preview,show_group_create:TS.members.canUserCreateGroups()&&!member.is_ultra_restricted};TS.menu.$menu_header.addClass("hidden").empty();if(!member.deleted&&!member.is_slackbot&&member_id!=TS.model.user.id){if(!TS.model.user.is_ultra_restricted&&!member.is_ultra_restricted){var invite_channels=TS.members.getMyChannelsThatThisMemberIsNotIn(member_id);if(invite_channels.length){template_args.show_channel_invite=true}}if(TS.boot_data.page_needs_enterprise){var team=TS.model.team;if(team&&team.id!==member.team_id)template_args.show_call_action=false}}if(is_team_page){TS.menu.$menu_items.html(TS.templates.menu_member_items_short(template_args))}else{TS.menu.$menu_items.html(TS.templates.menu_member_items(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.member.onMemberItemClick)}TS.menu.start(e);TS.kb_nav.setSubmitItemHandler(TS.menu.member.onMemberItemClick);var left_offset=$btn.outerWidth()-TS.menu.$menu.width()-1;TS.menu.positionAt($btn,left_offset,$btn.outerHeight()+5);TS.menu.keepInBounds()},filterChanged:function(query,result_count){if(!TS.menu.$menu_items)return;if(TS.menu.large_list_trigger>0&&result_count>TS.menu.large_list_trigger&&(!query||!query.length)){if(!TS.menu.menu_items_hidden){TS.menu.$menu_items[0].style.display="none";TS.menu.menu_items_hidden=true}}else{if(TS.menu.menu_items_hidden){TS.menu.$menu_items[0].style.display="block";TS.menu.menu_items_hidden=false}}TS.menu.keepInBounds()},onMembersItemClick:function(e){e.preventDefault();var member_id=$(this).data("member-id");if(member_id){TS.ims.startImByMemberId(member_id)}TS.menu.member.end()},startWithEditMemberProfilePhotoActions:function(e,onclick){if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();var $el=$(e.target);var is_button=$el.is(".btn");var template_args={show_delete:!!TS.model.user.profile.image_original&&!is_button,is_iOS:TS.model.is_iOS};TS.menu.clean();TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_edit_member_profile_photo_action_items(template_args));TS.menu.$menu_items.on("click.menu","li",onclick);TS.menu.start(e);if(is_button){TS.menu.positionAt($el,0,$el.outerHeight()+5)}else{TS.menu.positionAt($el.closest('[data-action="edit_member_profile_photo_menu"]'),36,156)}TS.menu.keepInBounds()},startWithEnterpriseMemberHeader:function(e){var SPACING_BETWEEN_TARGET_AND_MENU=15;if(TS.menu.isRedundantClick(e))return;if(TS.model.menu_is_showing)return;TS.menu.buildIfNeeded();TS.menu.clean();var template_args={enterprise_name:$("[data-enterprise-name]").val(),signout_url:TS.boot_data.signout_url};TS.menu.$menu_header.addClass("hidden").empty();TS.menu.$menu_items.html(TS.templates.menu_enterprise_member_header(template_args));TS.menu.$menu_items.on("click.menu","li",TS.menu.member.onEnterpriseMemberHeaderClick);TS.kb_nav.setSubmitItemHandler(TS.menu.member.onEnterpriseMemberHeaderClick);TS.menu.start(e);var $menu_target=$("[data-header-menu-toggle]");var x_offset=-TS.menu.$menu.outerWidth()+$menu_target.outerWidth();var y_offset=$menu_target.outerHeight()+SPACING_BETWEEN_TARGET_AND_MENU;TS.menu.positionAt($menu_target,x_offset,y_offset);e.preventDefault()},onEnterpriseMemberHeaderClick:function(e){var id=$(this).attr("id");if(id=="sign_out"){return}else if(id=="view_account"){return}else{e.preventDefault();TS.warn("not sure what to do with clicked element id:"+id);return}},end:function(){TS.menu.member.member=null;TS.menu.end()}});var _member_presence_list})();(function(){"use strict";TS.registerModule("menu.mpim",{onStart:function(){},mpim:null,startWithMpim:function(e,mpim_id){if(TS.menu.isRedundantClick(e))return;if(TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing&&!TS.boot_data.feature_browse_date){return}TS.menu.buildIfNeeded();TS.menu.clean();var mpim=TS.menu.mpim.mpim=TS.mpims.getMpimById(mpim_id);var show_email_item=TS.model.team.prefs.allow_email_ingestion;if(mpim.members.length>4){$("#active_channel_name").find(".name").tooltip("disable")}TS.menu.$menu_header.addClass("hidden").empty();var template_args={mpim:mpim,user:TS.model.user,show_email_item:show_email_item,show_mpim_create:TS.members.canUserCreateMpims(),show_mpim_convert:TS.members.canUserCreateGroups()};TS.menu.$menu_header.addClass("hidden").empty();if(TS.notifs.isCorGMuted(mpim.id))template_args.mpim_is_muted=true;TS.menu.$menu_items.html(TS.templates.menu_mpim_items(template_args));TS.menu.$menu_header.bind("click.menu",TS.menu.mpim.onMpimHeaderClick);TS.menu.$menu_items.on("click.menu","li",TS.menu.mpim.onMpimItemClick);TS.menu.start(e);TS.menu.$menu.attr("data-qa","mpim_menu");if(TS.boot_data.feature_browse_date){TS.menu.$menu.addClass("narrow_menu");TS.ui.date_picker.getOldestMsgTs()}var use_channel_name_toggle=TS.boot_data.feature_channel_name_menu&&$(e.target).closest("#channel_name").length;var $toggle_button=use_channel_name_toggle?$("#channel_name"):$("#channel_actions_toggle");var toggle_button_height=$toggle_button.height();var y_plus=use_channel_name_toggle?toggle_button_height+6:toggle_button_height;var x_plus=use_channel_name_toggle?18:6;TS.menu.positionAt($toggle_button,x_plus,y_plus);if(template_args.disable_invite){$("#mpim_invite_item a").tooltip({title:"Everyone on your team is already in this conversation",delay:{show:500,hide:0}})}},onMpimHeaderClick:function(e){e.preventDefault()},onMpimItemClick:function(e){var id=$(this).attr("id");var mpim=TS.menu.mpim.mpim;if($(this).hasClass("disabled")){TS.menu.mpim.end();return}if(id=="mpim_details_item"){e.preventDefault();if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="details"){$("#details_tab").highlight(null,"channel_page_details_highlighter")}else{TS.client.ui.flex.openFlexTab("details")}}else if(id=="mpim_star_item"){e.preventDefault();TS.stars.checkForStarClick(e)}else if(id=="mpim_archives_item"){}else if(id=="mpim_jump_item"){e.preventDefault();TS.menu.startWithDatePicker(e);return}else if(id=="mpim_mute_item"){e.preventDefault();TS.notifs.muteOrUnmuteCorG(TS.menu.mpim.mpim.id)}else if(id=="mpim_email_item"){}else if(id=="mpim_prefs"){e.preventDefault();TS.ui.channel_prefs_dialog.start(TS.menu.mpim.mpim.id)}else if(id=="mpim_files_item"){TS.client.ui.flex.openFlexTab("search");TS.search.setFilter("files");TS.view.resizeManually("TS.key_triggers");var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt)}else if(id=="mpim_create_mpim_item"){e.preventDefault();setTimeout(function(){TS.ui.im_browser.startWithMpim(mpim)},1)}else if(id=="convert_to_private_channel"){e.preventDefault();var model_ob=TS.shared.getActiveModelOb();TS.ui.mpim_conversion_modal.startMpimConversionModal(model_ob)}else{TS.warn("not sure what to do with clicked element id:"+id);return}TS.menu.mpim.end()},end:function(){TS.menu.mpim.mpim=null;TS.menu.end()}})})();(function(){"use strict";TS.registerModule("cmd_handlers",{server_cmds:null,onStart:function(){var always_wait=true;_resetUpCmdsThrottled=TS.utility.throttleFunc(_resetUpCmdsThrottled,3e3,always_wait);TS.prefs.team_allow_calls_changed_sig.add(_maybeUpdateCallsCommand)},parseArgs:function(txt){var args={cmd:"",rest:"",words:[]};if(!_.isString(txt))return args;var txt_trimmed=txt.trim();if(!txt_trimmed)return args;args.words=txt_trimmed.split(/\s/);args.cmd=args.words[0].toLowerCase();args.rest=txt_trimmed.substring(args.cmd.length).trim();return args},setUpCmds:function(){if(!TS.boot_data.page_needs_custom_cmds){_maybeUpdateCallsCommand();return Promise.resolve()}var ls_cmds=TS.storage.fetchCmds();if(ls_cmds&&TS.model.commands_cache_ts==ls_cmds.cache_ts){TS.model.did_we_load_with_cmd_cache=true;TS.cmd_handlers.mergeInServerCmds(ls_cmds.data);_maybeUpdateCallsCommand();return Promise.resolve()}var unused_deprecated_handler;var dont_set_active=true;return TS.api.call("commands.list",{},unused_deprecated_handler,dont_set_active).then(function(resp){if(!resp.data.commands){return}_setCommands(resp.data.commands,resp.data.cache_ts)}).catch(_.noop)},removeCommand:function(command_name,cache_ts){delete TS.cmd_handlers.server_cmds[command_name];_setCommands(TS.cmd_handlers.server_cmds,cache_ts)},updateCommand:function(command_info,cache_ts){TS.cmd_handlers.server_cmds[command_info.name]=command_info;_setCommands(TS.cmd_handlers.server_cmds,cache_ts)},resetUpCmds:function(){TS.storage.storeCmds("");_resetUpCmdsThrottled()},sortNames:function(names){var sorted_names=names.sort(function(a,b){return a.localeCompare(b)});function filterByTypes(names,types){return names.filter(function(name){return types.indexOf(TS.cmd_handlers[name].type)!==-1})}var slack_commands=filterByTypes(sorted_names,["client","core"]);var team_commands=filterByTypes(sorted_names,["custom"]);var app_commands=filterByTypes(sorted_names,["app","service"]);var app_commands_with_name=app_commands.filter(function(name){var cmd=TS.cmd_handlers[name];return!!(cmd.app||cmd.service_name)});app_commands_with_name.sort(function(a,b){var a_cmd=TS.cmd_handlers[a];var b_cmd=TS.cmd_handlers[b];var a_name=a_cmd.service_name||TS.model.apps[a_cmd.app].name;var b_name=b_cmd.service_name||TS.model.apps[b_cmd.app].name;return TS.apps.compareNames(a_name,b_name)});var app_commands_without_name=app_commands.filter(function(name){var cmd=TS.cmd_handlers[name];return!(cmd.app||cmd.service_name)});app_commands_without_name.sort();var flattened=[].concat(slack_commands,team_commands,app_commands_with_name,app_commands_without_name);return flattened},getAppNameForCmdName:function(cmd_name){var cmd=TS.cmd_handlers[cmd_name];if(!cmd)return"";var app_name;if(cmd.app&&TS.model.apps[cmd.app]){app_name=TS.model.apps[cmd.app].name}else if(cmd.service_name){app_name=cmd.service_name}return app_name},mergeInServerCmds:function(cmds){TS.cmd_handlers.server_cmds=cmds;var cmd_name;for(var k in TS.cmd_handlers){if(k.indexOf("/")!==0)continue;if(TS.cmd_handlers[k].type=="client"){delete TS.cmd_handlers[k].override}else{TS.log(65,'mergeInCmds is removing the server command "'+k+'" from cmd_handlers');delete TS.cmd_handlers[k]}}for(cmd_name in cmds){if(cmd_name.indexOf("/")!==0)continue;if(TS.cmd_handlers[cmd_name]){if(TS.cmd_handlers[cmd_name].can_be_overridden_by_server_cmd){TS.log(65,'mergeInCmds is overriding client command "'+cmd_name+'" with a server command')}else{TS.cmd_handlers[cmd_name].override=true;TS.log(65,'mergeInCmds is NOT overwriting a client command for "'+cmd_name+'"');continue}}TS.cmd_handlers[cmd_name]=TS.cmd_handlers.makeInternalCmdObject(cmds[cmd_name])}for(cmd_name in cmds){if(cmd_name.indexOf("/")!==0)continue;if(!TS.cmd_handlers[cmd_name].alias_of)continue;var aliased_to=TS.cmd_handlers[TS.cmd_handlers[cmd_name].alias_of];if(!aliased_to){TS.log(65,'mergeInCmds is NOT adding an alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'" because it was not found');continue}if(aliased_to.type=="client"){TS.log(65,'mergeInCmds is NOT adding an alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'" because it is not a server command');continue}TS.log(65,'mergeInCmds is adding on alias of "'+cmd_name+'" to "'+TS.cmd_handlers[cmd_name].alias_of+'"');if(!aliased_to.aliases)aliased_to.aliases=[];aliased_to.aliases.push(cmd_name)}},makeInternalCmdObject:function(cmd){return{autocomplete:true,alias_of:cmd.alias_of?cmd.alias_of:null,aliases:null,usage:cmd.usage||"",desc:cmd.desc||"",help_text:cmd.help_text||"",type:cmd.type||"",app:cmd.app||"",service_name:cmd.service_name||""}},addTempEphemeralFeedback:function(text,input_txt,slackbot_feels){if(input_txt){if(TS.boot_data.feature_name_tagging_client_extras){TS.utility.populateInput(TS.client.ui.$msg_input,input_txt)}else{TS.utility.contenteditable.value(TS.client.ui.$msg_input,input_txt)}}var ephemeral_msg={text:text,ephemeral_type:"temp_slash_cmd_feedback"};if(slackbot_feels){ephemeral_msg.slackbot_feels=slackbot_feels}TS.client.ui.addOrFlashEphemeralBotMsg(ephemeral_msg)},addEphemeralFeedback:function(text,input_txt,slackbot_feels){if(input_txt){if(TS.boot_data.feature_name_tagging_client_extras){TS.utility.populateInput(TS.client.ui.$msg_input,input_txt)}else{TS.utility.contenteditable.value(TS.client.ui.$msg_input,input_txt)}}TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.active_cid);var ephemeral_msg={text:text};if(slackbot_feels){ephemeral_msg.slackbot_feels=slackbot_feels}TS.client.ui.addEphemeralBotMsg(ephemeral_msg)},runCommand:function(cmd,rest,words,e,in_reply_to_msg,model_ob){if(!TS.cmd_handlers[cmd])return;if(TS.model.last_active_cid){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.last_active_cid)}TS.cmd_handlers[cmd].func(cmd,rest,words,e,in_reply_to_msg,model_ob)},"/status":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.members.setUserStatus(rest)}},"/away":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:'Toggle your "away" status',func:function(cmd,rest,words,e,in_reply_to_msg){TS.members.toggleUserPresence().then(function(res){var presence=res.args.presence||TS.model.user.presence;TS.cmd_handlers.addEphemeralFeedback(":white_check_mark: You are now marked as *"+presence+"*.")}).catch(_.noop);if(rest)TS.members.setUserStatus(rest)}},"/prefs":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Open the preferences dialog",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.prefs_dialog.start()}},"/shortcuts":{type:"client",autocomplete:true,alias_of:null,aliases:["/keys"],desc:"Open the keyboard shortcuts dialog",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.shortcuts_dialog.start()}},"/keys":{type:"client",autocomplete:true,alias_of:"/shortcuts",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/shortcuts"].func(cmd,rest,words,e)}},"/open":{type:"client",autocomplete:true,alias_of:null,aliases:["/join"],desc:"Open a channel",args:[{name:"channel",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(words.length==1){TS.ui.channel_browser.start()}else{var channel_name=TS.utility.cleanChannelName(rest);var channel=TS.channels.getChannelByName(channel_name);var group=TS.groups.getGroupByName(channel_name);if(channel){if(channel.is_member){TS.channels.displayChannel(channel.id)}else if(!TS.model.user.is_restricted){TS.channels.join(channel.name)}}else if(group){if(!group.is_archived||group.was_archived_this_session){TS.groups.displayGroup(group.id)}}else{if(TS.members.canUserCreateChannels()){TS.ui.new_channel_modal.start(channel_name)}else{TS.cmd_handlers.addEphemeralFeedback("I couldn't find a channel named \""+channel_name+'", sorry',"","sad_surprise")}}}}},"/join":{type:"client",autocomplete:true,alias_of:"/open",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/open"].func(cmd,rest,words,e)}},"/msg":{type:"client",autocomplete:true,alias_of:null,aliases:["/dm"],desc:"Send a DM message to another user",args:[{name:"@user",optional:false},{name:"your message",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var c_or_g;var m;if(TS.boot_data.feature_name_tagging_client_extras){m=TS.members.getMemberById(name)}else{m=TS.members.getMemberByName(name)}if(!m){if(name){var c_name=name.replace("#","");c_or_g=TS.channels.getChannelByName(c_name);if(!c_or_g)c_or_g=TS.groups.getGroupByName(c_name);if(!c_or_g){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest,"sad_surprise");return}}else{$("#direct_messages_header").trigger("click.open_dialog").scrollintoview({duration:500})}}var text_to_send=rest.replace(name,"");if(m){if(m.deleted){TS.cmd_handlers.addTempEphemeralFeedback("That user has been deactivated :disappointed:",cmd+" "+rest);return}TS.ims.startImByMemberId(m.id,false,text_to_send)}else if(c_or_g){if(c_or_g.is_archived){TS.cmd_handlers.addTempEphemeralFeedback("That "+(c_or_g.is_channel?"channel":"private channel")+" has been archived","","sad_surprise");return}if(c_or_g.is_channel){TS.channels.displayChannel(c_or_g.id,text_to_send)}else{TS.groups.displayGroup(c_or_g.id,text_to_send)}}}},"/invite":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Invite another member to a channel",args:[{name:"@user",optional:false},{name:"channel",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var ug;var m;if(TS.boot_data.feature_name_tagging_client_extras){m=TS.members.getMemberById(name)}else{m=TS.members.getMemberByName(name)}if(name){ug=TS.user_groups.getUserGroupsByHandle(name)}if(!m&&!ug&&name){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest,"sad_surprise");return}if(m&&m.deleted){TS.cmd_handlers.addTempEphemeralFeedback("That user has been deactivated.",cmd+" "+rest,"sad_surprise");return}var member_identifier;if(m){if(TS.boot_data.feature_name_tagging_client_extras){member_identifier="@"+m.id}else{member_identifier="@"+m.name}}if(m&&m.is_ultra_restricted){if(TS.model.user.is_admin){TS.cmd_handlers.addTempEphemeralFeedback(TS.utility.htmlEntities(name)+" is a Single-Channel Guest, and can't be added to a second channel. To invite "+TS.utility.htmlEntities(name)+" to this channel, you'll need to <"+TS.boot_data.team_url+"admin#restricted|upgrade their membership> to a Multi-Channel Guest. Note: This will add a billable seat to your team.",cmd+" "+rest,"sad_surprise")}else{TS.cmd_handlers.addTempEphemeralFeedback(TS.utility.htmlEntities(name)+" is a Single-Channel Guest, and can't be added to a second channel. Your Team Admin can upgrade their membership to a Multi-Channel Guest.",cmd+" "+rest,"sad_surprise")}return}var channel_name=words.length>2?words[2]:"";if(channel_name){if(!m&&!ug){TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest,"sad_surprise");return}var c=TS.channels.getChannelByName(channel_name);var g=TS.groups.getGroupByName(channel_name);if(c){if(m){if(c.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback(member_identifier+" is already in this channel.",cmd+" "+rest);return}if(TS.boot_data.page_needs_enterprise&&!TS.permissions.channels.canMemberJoinChannel(channel,m)){TS.cmd_handlers.addTempEphemeralFeedback("This channel is not available to "+member_identifier,cmd+" "+rest,"sad_surprise");return}TS.api.call("channels.invite",{channel:c.id,user:m.id})}if(ug){var users_to_invite=ug.users.filter(function(member_id){if(TS.boot_data.page_needs_enterprise){var mbr=TS.members.getMemberById(member_id);if(!TS.permissions.channels.canMemberJoinChannel(c,mbr))return false}return c.members.indexOf(member_id)===-1});users_to_invite.forEach(function(member_id){TS.api.call("channels.invite",{channel:c.id,user:member_id})})}}else if(g){if(m){if(g.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback(member_identifier+" is already in this group.",cmd+" "+rest);return}if(TS.boot_data.page_needs_enterprise&&!TS.permissions.channels.canMemberJoinChannel(g,m)){TS.cmd_handlers.addTempEphemeralFeedback("This channel is not available to "+member_identifier,cmd+" "+rest,"sad_surprise");return}TS.ui.invite.showInviteMembersPreSelected(g.id,[m.id])}if(ug){var users_to_invite=ug.users.filter(function(member_id){if(TS.boot_data.page_needs_enterprise){var mbr=TS.members.getMemberById(member_id);if(!TS.permissions.channels.canMemberJoinChannel(g,mbr))return false}return g.members.indexOf(member_id)===-1});TS.ui.invite.showInviteMembersPreSelected(g.id,users_to_invite)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest,"sad_surprise");return}}else{if(TS.model.active_channel_id){if(m){var channel=TS.channels.getChannelById(TS.model.active_channel_id);if(channel&&channel.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback(member_identifier+" is already in this channel.",cmd+" "+rest);return}if(TS.boot_data.page_needs_enterprise&&!TS.permissions.channels.canMemberJoinChannel(channel,m)){TS.cmd_handlers.addTempEphemeralFeedback("This channel is not available to "+member_identifier,cmd+" "+rest,"sad_surprise");return}TS.api.call("channels.invite",{channel:TS.model.active_channel_id,user:m.id})}else if(ug){var channel=TS.channels.getChannelById(TS.model.active_channel_id);if(channel){var users_to_invite=ug.users.filter(function(member_id){if(TS.boot_data.page_needs_enterprise){var mbr=TS.members.getMemberById(member_id);if(!TS.permissions.channels.canMemberJoinChannel(channel,mbr))return false}return channel.members.indexOf(member_id)===-1});users_to_invite.forEach(function(member_id){TS.api.call("channels.invite",{channel:TS.model.active_channel_id,user:member_id})})}}else{if(e&&e.which==TS.utility.keymap.enter){$(window.document).bind("keyup.wait_for_invite",function(e){TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_channel_id);$(window.document).unbind("keyup.wait_for_invite")})}else{TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_channel_id)}}}else if(TS.model.active_group_id){if(m){var group=TS.groups.getGroupById(TS.model.active_group_id);if(group&&group.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback(member_identifier+" is already in this channel.",cmd+" "+rest);return}if(TS.boot_data.page_needs_enterprise&&!TS.permissions.channels.canMemberJoinChannel(group,m)){TS.cmd_handlers.addTempEphemeralFeedback("This channel is not available to "+member_identifier,cmd+" "+rest,"sad_surprise");return}TS.ui.invite.showInviteMembersPreSelected(TS.model.active_group_id,[m.id])}else if(ug){var group=TS.groups.getGroupById(TS.model.active_group_id);if(group){var users_to_invite=ug.users.filter(function(member_id){if(TS.boot_data.page_needs_enterprise){var mbr=TS.members.getMemberById(member_id);if(!TS.permissions.channels.canMemberJoinChannel(c,mbr))return false}return group.members.indexOf(member_id)===-1});TS.ui.invite.showInviteMembersPreSelected(TS.model.active_group_id,users_to_invite)}}else{if(e&&e.which==TS.utility.keymap.enter){$(window.document).bind("keyup.wait_for_invite",function(e){TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_group_id);$(window.document).unbind("keyup.wait_for_invite")})}else{TS.ui.channel_invite_modal.startInviteToChannelModal(TS.model.active_group_id)}}}else if(TS.model.active_mpim_id){var mpim=TS.mpims.getMpimById(TS.model.active_mpim_id);if(m){if(mpim&&mpim.members.indexOf(m.id)!==-1){TS.cmd_handlers.addTempEphemeralFeedback(member_identifier+" is already in this group message.",cmd+" "+rest);return}TS.ui.im_browser.startWithMpim(mpim,[m.id])}else{TS.ui.im_browser.startWithMpim(mpim)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.",cmd+" "+rest,"sad_surprise");return}}}},"/invite_people":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Invite people to your Slack team",args:[{name:"name@domain.com, ...",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.ui.admin_invites.canInvite()){rest=rest&&rest.trim();if(rest){TS.ui.admin_invites.populateInvites(rest.split(/\s*,\s*|\s+/).map(function(word){return{email:word}}))}TS.ui.admin_invites.start()}else{TS.cmd_handlers.addTempEphemeralFeedback("You don't have permission to invite people.","","sad_surprise")}}},"/dm":{type:"client",autocomplete:true,alias_of:"/msg",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/msg"].func(cmd,rest,words,e)}},"/archive":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Archive the current channel",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_archived||model_ob.is_general)return;if(TS.model.active_channel_id){if(!TS.members.canUserArchiveChannels())return;var channel=TS.channels.getChannelById(TS.model.active_channel_id);TS.channels.ui.showArchiveChannelDialog(channel)}else if(TS.model.active_group_id){if(TS.model.user.is_restricted)return;var group=TS.groups.getGroupById(TS.model.active_group_id);TS.channels.ui.showArchiveGroupDialog(group)}}},"/leave":{type:"client",autocomplete:true,alias_of:null,aliases:["/close","/part"],desc:"Leave a channel",
func:function(cmd,rest,words,e,in_reply_to_msg){if(words.length==1){var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id){if(model_ob.is_archived){TS.channels.closeArchivedChannel(TS.model.active_channel_id)}else{TS.channels.leave(TS.model.active_channel_id)}}else if(TS.model.active_im_id){TS.ims.closeIm(TS.model.active_im_id)}else if(TS.model.active_mpim_id){TS.mpims.closeMpim(TS.model.active_mpim_id)}else if(TS.model.active_group_id){if(model_ob.is_archived){TS.shared.closeArchivedChannel(model_ob.id)}else{TS.groups.leave(model_ob.id)}}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel or team member name is required.","","sad_surprise")}}else{var channel=TS.channels.getChannelByName(rest);if(channel){TS.channels.leave(channel.id)}else{TS.cmd_handlers.addTempEphemeralFeedback("A valid channel name is required.","","sad_surprise")}}}},"/star":{type:"client",autocomplete:true,alias_of:null,desc:"Stars the current channel or conversation",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();var starred=model_ob.is_starred;var api_args={};api_args.channel=model_ob.id;if(!starred){TS.api.call("stars.add",api_args,function(ok,data,args){if(ok){TS.cmd_handlers.addTempEphemeralFeedback("Ok, I starred "+model_ob.name);return}else if(data.error){TS.error(data.error)}})}else{TS.api.call("stars.remove",api_args,function(ok,data,args){if(ok){TS.cmd_handlers.addTempEphemeralFeedback("Ok, "+model_ob.name+" is unstarred");return}else if(data.error){TS.error(data.error)}})}}},"/close":{type:"client",autocomplete:true,alias_of:"/leave",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/leave"].func(cmd,rest,words,e)}},"/part":{type:"client",autocomplete:true,alias_of:"/leave",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/leave"].func(cmd,rest,words,e)}},"/topic":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Set the channel topic",args:[{name:"new topic",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.user.is_restricted||TS.shared.getActiveModelOb().is_general&&!TS.members.canUserPostInGeneral()){TS.cmd_handlers.addTempEphemeralFeedback("Setting the topic is a restricted action.",cmd+" "+rest,"sad_surprise");return}if(rest.length>TS.model.channel_topic_max_length){TS.cmd_handlers.addTempEphemeralFeedback("Topics cannot exceed "+TS.model.channel_topic_max_length+" characters.",cmd+" "+rest,"sad_surprise");return}if(TS.model.active_channel_id){if(rest){TS.channels.setTopic(TS.model.active_channel_id,rest)}else{$("#channel_topic_text").click().focus().select()}}else if(TS.model.active_group_id){if(rest){TS.groups.setTopic(TS.model.active_group_id,rest)}else{$("#channel_topic_text").click().focus().select()}}else{TS.cmd_handlers.addTempEphemeralFeedback("Regrettably, DMs do not have topics","","sad_surprise")}}},"/togglethemes":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.prefs.setPrefByAPI({name:"messages_theme",value:TS.model.prefs.messages_theme=="light_with_avatars"?"dense":"light_with_avatars"})}},"/search":{type:"client",autocomplete:false,alias_of:null,aliases:["/s"],desc:"Perform a search",args:[{name:"your text",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){TS.client.ui.flex.openFlexTab("search");TS.view.resizeManually("TS.search.view.showResults");TS.search.autocomplete.search(rest,true);TS.clog.track("SEARCH_OPEN",{open_method:"command"})}},"/s":{type:"client",autocomplete:true,alias_of:"/search",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/search"].func(cmd,rest,words,e)}},"/rename":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Rename a channel",args:[{name:"new name",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.user.is_restricted){TS.cmd_handlers.addTempEphemeralFeedback("You don't have permission to rename.","","sad_surprise");return}if(!TS.model.active_channel_id&&!TS.model.active_group_id){TS.cmd_handlers.addTempEphemeralFeedback("IM channels cannot be renamed.","","sad_surprise");return}var model_ob=TS.shared.getActiveModelOb();if(TS.model.active_channel_id||TS.model.active_group_id){if(!TS.model.user.is_admin&&model_ob.creator!=TS.model.user.id){TS.cmd_handlers.addTempEphemeralFeedback("Only Team Admins (or the channel creator) are allowed to rename channels.","","sad_surprise");return}}TS.ui.channel_create_dialog.start(TS.utility.htmlEntities(rest)||model_ob.name,model_ob)}},"/beep":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.sounds.play("new_message")}},"/upload":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){var blob=TS.utility.base64StrtoBlob(rest);TS.client.ui.file_pasted_sig.dispatch(blob)}},"/colors":{type:"client",autocomplete:false,alias_of:null,aliases:["/colours"],desc:"View any custom colors you have set for other members",func:function(cmd,rest,words,e,in_reply_to_msg){var members=TS.members.getMembersForUser();var member;var str="";for(var i=0;i<members.length;i++){member=members[i];if(member.member_color!=member.color){str+=member.name+": "+member.member_color+"\n"}}TS.cmd_handlers.addEphemeralFeedback(str?"You have overridden colors as follows:\n"+str:"No user color overrides have been set.")}},"/colours":{type:"client",autocomplete:true,alias_of:"/colors",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/colors"].func(cmd,rest,words,e)}},"/color":{type:"client",autocomplete:false,alias_of:null,aliases:["/colour"],desc:"Set a custom color for another member",func:function(cmd,rest,words,e,in_reply_to_msg){var name=words.length>1?words[1]:"";var color=words.length>2?words[2].replace(/\#/g,""):"";var m;if(TS.boot_data.feature_name_tagging_client_extras){m=TS.members.getMemberById(name)}else{m=TS.members.getMemberByName(name)}if(!m){TS.cmd_handlers.addTempEphemeralFeedback("A valid team member name is required.",cmd+" "+rest,"sad_surprise");return}var member_identifier;if(m){if(TS.boot_data.feature_name_tagging_client_extras){member_identifier="@"+m.id}else{member_identifier="@"+m.name}}if(color&&(color.length!=6||!("#"+color).match(TS.format.hex_rx))){TS.cmd_handlers.addTempEphemeralFeedback("A valid 6 character hex code is required, like `FF0000`.",cmd+" "+rest);return}TS.members.setMemberUserColor(m,color);TS.model.prefs.user_colors=JSON.stringify(TS.model.user_colors);TS.prefs.setPrefByAPI({name:"user_colors",value:TS.model.prefs.user_colors});if(color){TS.cmd_handlers.addEphemeralFeedback("You've set your custom color for "+member_identifier+" to #"+color)}else{TS.cmd_handlers.addEphemeralFeedback("You've removed your custom color for "+member_identifier+".")}}},"/colour":{type:"client",autocomplete:true,alias_of:"/color",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/color"].func(cmd,rest,words,e)}},"/colortest":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){var colors=null;if(rest){try{colors=JSON.parse(rest)}catch(ex){TS.cmd_handlers.addTempEphemeralFeedback("Not a good value for colors: "+rest,"","sad_surprise");return}}if(!colors||!colors.length){colors=["#DDCFFA","#2EF645","#F38303","#E702AE","#3C986D","#9D6158","#F43368","#97C10A","#7491F9","#9E63A3","#FACE41","#35A5CC","#39A93E","#4FECA8","#CA5B34","#E2A974","#2BCFCB","#F89BA7","#89868A","#6A7841","#ADC498","#B1DBDD","#B849C3","#9CDB81","#E72F36","#A16A28","#F68CCF","#317C84","#58851C","#FC4A97","#5774BB","#97B7FE","#C64D97","#CB4A5C","#F68B6B","#81EE4F","#B7ED6D","#756D8E","#3AED69","#81E7FB","#91ECB7","#ED8947","#57AF19","#28BC89","#4A9788","#D645DF","#B498FE","#71C8F9","#C07B1D","#16BD60","#EFCAE3","#A4E0BB","#478AAF","#59953E","#886CA7","#F0C3F1","#29AF70","#80A5F8","#636BB8"]}var i;for(i=0;i<colors.length;i++){colors[i]=colors[i].replace("#","")}var members=TS.members.getMembersForUser();for(i=0;i<members.length;i++){TS.members.setMemberUserColor(members[i],colors[_.random(0,colors.length-1)])}}},"/discon":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.disconnect()}},"/sleepsleep":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.sleep()}},"/sleepsleep2":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.sleep();TS.ms.setReconnectUrl("")}},"/wakewake":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.wake()}},"/discon2":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.break_token=true;TS.ms.disconnect()}},"/discon3":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.break_reconnections=true;TS.ms.disconnect()}},"/discon4":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ms.setReconnectUrl("");TS.ms.disconnect()}},"/msg_replies":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(!TS.boot_data.feature_message_replies)return;var msg_replies=TS.utility.parseJSONOrElse(TS.model.prefs.msg_replies,{});var accepted_options_msg="Accepted options are: flexpane.";switch(rest){case"flexpane":msg_replies.flexpane=true;TS.cmd_handlers.addTempEphemeralFeedback("OK, using flexpane for conversations.");break;case"":var current_mode="flexpane";TS.cmd_handlers.addTempEphemeralFeedback(accepted_options_msg+" Your current mode is "+current_mode+".");break;default:TS.cmd_handlers.addTempEphemeralFeedback("Unknown msg_replies pref. "+accepted_options_msg,"","sad_surprise");break}TS.prefs.setPrefByAPI({name:"msg_replies",value:JSON.stringify(msg_replies)})}},"/emo":{type:"client",autocomplete:false,alias_of:null,aliases:["/emote","/emoji"],desc:"",func:function(cmd){var e={target:TS.client.ui.$msg_input};TS.menu.emoji.start({e:e})}},"/emoji":{type:"client",autocomplete:false,alias_of:"/emo",aliases:null,desc:"",func:function(cmd){TS.cmd_handlers["/emo"].func(cmd)}},"/emote":{type:"client",autocomplete:false,alias_of:"/emo",aliases:null,desc:"",func:function(cmd){TS.cmd_handlers["/emo"].func(cmd)}},"/editlast":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"Edit the last message you posted",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}rest=$.trim(rest);if(!rest){TS.cmd_handlers.addTempEphemeralFeedback("You must enter some text!",cmd+" "+rest);return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.cmd_handlers.addTempEphemeralFeedback("Found no recent messages from you to edit.",cmd+" "+rest,"sad_surprise");return}TS.msg_edit.commitEdit(msg,TS.shared.getActiveModelOb(),rest)}},"/deletelast":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"Delete the last message you posted",func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}var msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,model_ob.msgs);if(!msg){TS.cmd_handlers.addTempEphemeralFeedback("Found no recent messages from you to delete.","","sad_surprise");return}TS.msg_edit.startDelete(msg.ts)}},"/collapse":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Collapse all files in the current channel (opposite of /expand)",func:function(cmd,rest,words,e,in_reply_to_msg){TS.inline_imgs.collapseAllInCurrent();TS.inline_videos.collapseAllInCurrent();TS.inline_attachments.collapseAllInCurrent();TS.inline_audios.collapseAllInCurrent();TS.inline_others.collapseAllInCurrent();TS.inline_file_previews.collapseAllInCurrent();TS.cmd_handlers.addEphemeralFeedback("I've collapsed all files in this channel for you.")}},"/expand":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Expand all files in the current channel (opposite of /collapse)",func:function(cmd,rest,words,e,in_reply_to_msg){TS.inline_imgs.expandAllInCurrent();TS.inline_videos.expandAllInCurrent();TS.inline_attachments.expandAllInCurrent();TS.inline_audios.expandAllInCurrent();TS.inline_others.expandAllInCurrent();TS.inline_file_previews.expandAllInCurrent();TS.cmd_handlers.addEphemeralFeedback("I've expanded all files in this channel for you.")}},"/attach_align":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){$("body").toggleClass("attachments_flush_with_avatar")}},"/attach_thumb_align":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){window.attach_thumb_align_title=!window.attach_thumb_align_title;TS.client.msg_pane.rebuildMsgs()}},"/remove":{type:"client",autocomplete:true,alias_of:null,aliases:["/kick"],desc:"Remove a person from the current channel",args:[{name:"@user",optional:false}],func:function(cmd,rest,words,e,in_reply_to_msg){if(TS.model.active_channel_id&&!TS.members.canUserKickFromChannels()){TS.cmd_handlers.addTempEphemeralFeedback("Removing from channels is a restricted action.","","sad_surprise");return}if(TS.model.active_group_id&&!TS.members.canUserKickFromGroups()){TS.cmd_handlers.addTempEphemeralFeedback("Removing from private channels is a restricted action.","","sad_surprise");return}if(TS.model.active_im_id||TS.model.active_mpim_id){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove someone from a DM.","","sad_surprise");return}var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_archived){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove anyone from *"+(TS.model.active_channel_id?"#":"")+model_ob.name+"* while it is archived.","","sad_surprise");return}rest=$.trim(rest);if(!rest){TS.cmd_handlers.addTempEphemeralFeedback("Please specify someone to remove!",cmd+" "+rest);return}var member;if(TS.boot_data.feature_name_tagging_client_extras){member=TS.members.getMemberById(rest)}else{member=TS.members.getMemberByName(rest)}if(!member){TS.cmd_handlers.addTempEphemeralFeedback("*"+TS.utility.htmlEntities(rest)+"* is not a recognized member name.",cmd+" "+rest,"","sad_surprise");return}if(model_ob.is_general&&!member.is_restricted&&!member.is_bot){TS.cmd_handlers.addTempEphemeralFeedback("You can't remove this member from *"+(TS.model.active_channel_id?"#":"")+model_ob.name+"*!");return}if(model_ob.members.indexOf(member.id)==-1){TS.cmd_handlers.addTempEphemeralFeedback("*"+TS.utility.htmlEntities(rest)+"* is not a member of this "+(TS.model.active_channel_id?"channel":"private channel")+".",cmd+" "+rest,"sad_surprise");return}if(member.is_self){TS.client.ui.onSubmit("/leave");return}if(TS.model.active_channel_id){TS.channels.kickMember(TS.model.active_channel_id,member.id)}else if(TS.model.active_group_id){TS.groups.kickMember(TS.model.active_group_id,member.id)}else{return}}},"/kick":{type:"client",autocomplete:true,alias_of:"/remove",aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.cmd_handlers["/remove"].func(cmd,rest,words,e)}},"/feedback":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Send feedback to Slack",args:[{name:"your message",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg){if(!rest){TS.utility.openInNewTab("/help/requests/new","_blank");return}TS.generic_dialog.start({title:"Send feedback",body:'<p class="bold">Looks like you are trying to send us some feedback! Yes?</p>',show_cancel_button:true,show_go_button:true,go_button_text:"Yes, send it",onGo:function(){TS.api.call("chat.command",{command:cmd,text:TS.format.cleanCommandText(rest),channel:TS.model.active_cid},function(ok,data,api_args){TS.client.ui.onAPICommand(ok,data,api_args,rest)})},onCancel:function(){TS.utility.populateInput(TS.client.ui.$msg_input,cmd+" "+rest)}})}},"/shrug":{type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Appends \\_()_/ to your message",args:[{name:"your message",optional:true}],func:function(cmd,rest,words,e,in_reply_to_msg,model_ob){var txt=rest||"";if(txt&&txt.substr(txt.length-1)!=" "){txt+=" "}txt+="\\_()_/ ";if(!model_ob)model_ob=TS.shared.getActiveModelOb();if(model_ob.is_channel){TS.channels.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_im){TS.ims.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.groups.sendMsg(model_ob.id,txt,in_reply_to_msg)}else if(model_ob.is_mpim){TS.mpims.sendMsg(model_ob.id,txt,in_reply_to_msg)}}},"/showfallbacks":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.model.show_attachment_fallback=!TS.model.show_attachment_fallback;TS.client.msg_pane.rebuildMsgs()}},"/macgap.app.enabledevelopertools()":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){if(window.macgap&&window.macgap.app&&window.macgap.app.enableDeveloperTools){macgap.app.enableDeveloperTools()}}},"/toggle_debugging_prefs":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(cmd,rest,words,e,in_reply_to_msg){TS.ui.prefs_dialog.start("advanced","#prefs_debug")}},"/slack_diagnostic_report":{type:"client",autocomplete:false,alias_of:null,aliases:null,desc:"",func:function(){_generateAndDisplayDiagnosticReport()}}});var _setCommands=function(commands,cache_ts){TS.model.commands_cache_ts=cache_ts;TS.storage.storeCmds({data:commands,cache_ts:TS.model.commands_cache_ts});TS.cmd_handlers.mergeInServerCmds(commands);_maybeUpdateCallsCommand()};var _resetUpCmdsThrottled=function(){TS.cmd_handlers.setUpCmds()};var _maybeUpdateCallsCommand=function(){if(!TS.boot_data.feature_calls){_.unset(TS.cmd_handlers,"/call");return}if(TS.cmd_handlers["/call"]&&TS.cmd_handlers["/call"].type!="client"){_.unset(TS.cmd_handlers,"/call");return}if(!TS.utility.calls.isEnabled()){_.unset(TS.cmd_handlers,"/call");return}TS.cmd_handlers["/call"]={type:"client",autocomplete:true,alias_of:null,aliases:null,desc:"Start a call",args:[{name:"help",optional:true}],can_be_overridden_by_server_cmd:true,func:function(cmd,rest,words,e,in_reply_to_msg){var model_ob=TS.shared.getActiveModelOb();var member=TS.members.getMemberById(model_ob.user);if(TS.boot_data.page_needs_enterprise){var team=TS.model.team;if(model_ob.is_shared&&!model_ob.is_org_shared||member&&team&&member.team_id!==team.id){TS.cmd_handlers.addTempEphemeralFeedback("You are not allowed to use this command here.","","sad_surprise");return}}if(rest.trim()=="help"){if(TS.utility.calls.isCurrentContextMultiParty()&&!TS.utility.calls.isMultiPartyEnabled()){TS.cmd_handlers.addTempEphemeralFeedback("To call a teammate, use `/call` from your Direct Message conversation with that person.");return}var help_message;if(model_ob.is_mpim){help_message="To call "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` in this group conversation."}else if(model_ob.is_im){help_message="To call "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` in this Direct Message conversation."}else{help_message="To start a call in "+TS.shared.getDisplayNameForModelOb(model_ob)+", use `/call` here"}TS.cmd_handlers.addTempEphemeralFeedback(help_message);return}if(TS.utility.calls.isCurrentContextMultiParty()&&!TS.utility.calls.isMultiPartyEnabled()){if(TS.boot_data.feature_platform_calls&&TS.model.team.prefs.calling_app_name!="Slack"){TS.utility.calls.startCallInModelOb(model_ob,true);return}else{TS.cmd_handlers.addTempEphemeralFeedback("Group calls aren't available on the free plan. Try using `/call` in a Direct Message conversation!");return}}else if(model_ob.is_slackbot_im){var slackbot_responses=["I'm on the other line. Sorry!","Thanks for calling me! I'm afraid I only accept calls from my mother, Sundays at 2pm.","I'm washing my hair right nowcan't come to the phone!","It's awfully nice of you to try calling me. But  shh!  I'm quite afraid of the phone! :grimacing:","Thank you so much for calling, but I can't talk right now, I'm watching my stories."];var random_slackbot_response=_.shuffle(slackbot_responses)[0];TS.cmd_handlers.addTempEphemeralFeedback(random_slackbot_response);return}else if(member&&(member.is_bot||member.id==TS.model.user.id)){TS.cmd_handlers.addTempEphemeralFeedback("Unfortunately, "+TS.members.getMemberDisplayName(member,false,true)+" is busy right now, and can't answer your call.","","sad_surprise");return}TS.utility.calls.startCallInModelOb(model_ob,true)}}};var _generateAndDisplayDiagnosticReport=function(){TS.info("Generating diagnostic report...");var report_p=_generateDiagnosticReport();var report_text;var body_html="This will take a minute &mdash;hang tight.";TS.generic_dialog.start({title:"Building diagnostic report",body:body_html,show_cancel_button:true,show_go_button:false,go_button_text:"Send Report to Slack",onCancel:function(){if(report_p.isPending()){TS.info("Cancelling diagnostic report");report_p.cancel()}},onGo:function(){TS.info("Sending diagnostic report to Zendesk...");TS.api.call("help.issues.create",{title:"Slack diagnostic report",text:"Please see attached file.",attach_text:report_text,tags:"slack_diagnostic_report"}).catch(function(err){TS.generic_dialog.alert('Oops! That didn\'t work &mdash; please give it another try. If problems persist, please <a href="/help/requests/new">contact support</a>.',"Something went wrong","Close")}).finally(function(){TS.generic_dialog.cancel()});TS.generic_dialog.div.find(".btn").addClass("disabled").attr("disabled",true);return false}});report_p.then(function(report){report_text=report;TS.info(report);TS.generic_dialog.div.find("h3").text("Diagnostic report ready");TS.generic_dialog.div.find(".modal-body").html("Click the button below to send the report to Slack.");TS.generic_dialog.div.find(".btn.dialog_go").removeClass("hidden");TS.generic_dialog.div.find(".btn.dialog_cancel").text("Close")})};var _generateDiagnosticReport=function(){var t0=performance.now();var promises={};promises["rtm.start"]=TS.api.call("rtm.start",{}).then(function(resp){return{latency:performance.now()-t0,size_bytes:JSON.stringify(resp.data).length}}).catch(function(err){return{error:err}});promises["channels"]=TS.api.call("channels.list").then(function(resp){return{remote:_.map(resp.data.channels,"id").sort(),local:_.map(TS.model.channels,"id").sort(),for_user:_.map(TS.channels.getChannelsForUser(),"id").sort()}}).catch(function(err){return{error:err}});promises["groups"]=TS.api.call("groups.list",{mpim_aware:true}).then(function(resp){return{remote:_.map(resp.data.groups,"id").sort(),local:_.map(TS.model.groups,"id").sort()}}).catch(function(err){return{error:err}});promises["ims"]=TS.api.call("im.list").then(function(resp){return{remote:_.map(resp.data.ims,"id").sort(),local:_.map(TS.model.ims,"id").sort()}}).catch(function(err){return{error:err}});promises["mpims"]=TS.api.call("mpim.list").then(function(resp){return{remote:_.map(resp.data.groups,"id").sort(),local:_.map(TS.model.mpims,"id").sort()}}).catch(function(err){return{error:err}});promises["members"]=TS.api.call("users.list").then(function(resp){return{remote:_.map(resp.data.members,"id").sort(),local:_.map(TS.model.members,"id").sort(),for_user:_.map(TS.members.getMembersForUser(),"id").sort()}}).catch(function(err){return{error:err}});promises["channel pane"]=new Promise(function(resolve){var ids_in_channels_list=$("#channels_scroller li").map(function(i,elem){var $elem=$(elem);if($elem.hasClass("channel")){return $elem.find("[data-channel-id]").attr("data-channel-id")}else if($elem.hasClass("group")){return $elem.find("[data-group-id]").attr("data-group-id")}else if($elem.hasClass("member")){return $elem.find("[data-member-id]").attr("data-member-id")}else if($elem.hasClass("mpim")){return $elem.find("[data-mpim-id]").attr("data-mpim-id")}else{return null}}).toArray();resolve(ids_in_channels_list)});promises["version info"]=TS.api.call("test.versionInfo").then(function(resp){return{active_version_ts:TS.boot_data.version_ts,latest_version_ts:_.get(resp.data,"version_ts"),min_version_ts:_.get(resp.data,"min_version_ts")}});return Promise.props(promises).then(function(responses){var responses_formatted=Object.keys(responses).map(function(response_name){return[response_name,_.repeat("-",response_name.length),JSON.stringify(responses[response_name])].join("\n")});var report_lines=["Slack Diagnostic Report","-----------------------","Date: "+TS.makeLogDate().trim(),"Time to generate: "+_.round((performance.now()-t0)/1e3,2)+" seconds","User agent: "+navigator.userAgent,"Logged-in user:"+TS.model.user.id,"",responses_formatted.join("\n\n"),"","-------------","End of report"];return report_lines.join("\n")})}})();(function(){"use strict";TS.registerModule("stars",{member_stars_fetched_sig:new signals.Signal,member_stars_being_fetched_sig:new signals.Signal,has_more:false,fetched_once:false,onStart:function(){TS.files.team_file_changed_sig.add(_teamFileChanged);TS.files.team_file_deleted_sig.add(TS.stars.maybeUpdateUserStarredList);TS.files.team_file_comment_deleted_sig.add(TS.stars.maybeUpdateUserStarredList);_$member_stars_more_btn=$("#member_stars_more_btn")},maybeUpdateUserStarredList:function(args){if(!TS.client)return;if(!TS.model.team)return;if(_stars_being_fetched||!TS.stars.fetched_once){_stars_needs_fetched=true;return}_updateUserStarredList(args)},fetchUserStarredItems:function(){var api_args=_starsListArgs();if(!TS.stars.fetched_once)TS.stars.fetched_once=true;return TS.api.call("stars.list",api_args,_onFetchUserStarredItems)},userStarStatusHasChanged:function(starred,item,parent_type){_slurpStarItem(item,parent_type);if(item.type=="message"){_updateMsgStar(item.message.ts,item.channel,starred,false)}else if(item.type=="file"){if(item.file.is_starred!=starred){_updateFileStar(item.file.id,starred)}}else if(item.type=="file_comment"){if(item.comment.is_starred!=starred){_updateFileCommentStar(item.comment.id,item.file.id,starred)}}else if(item.type=="channel"){var channel=TS.channels.getChannelById(item.channel);if(!channel){TS.warn("userStarStatusHasChanged channel_id:"+item.channel+" not found")}else{if(channel.is_starred!=starred){_updateChannelStar(item.channel,starred)}}}else if(item.type=="group"){var model_ob=TS.groups.getGroupById(item.channel);if(!model_ob){model_ob=TS.mpims.getMpimById(item.channel)}if(!model_ob){TS.warn("userStarStatusHasChanged group_id:"+item.channel+" not found")}else{if(model_ob.is_starred!=starred){if(model_ob.is_mpim){_updateMpimStar(item.channel,starred)}else{_updateGroupStar(item.channel,starred)}}}}else if(item.type=="im"){var im=TS.ims.getImById(item.channel);if(!im){TS.warn("userStarStatusHasChanged im_id:"+item.channel+" not found")}else{if(im.is_starred!=starred){_updateImStar(item.channel,starred)}}}else{TS.error("userStarStatusHasChanged needs to handle star item type:"+item.type)}},checkForStarClick:function(e){if(!e.target)return false;var $el=$(e.target);var $star;if($el.closest(".star").length){$star=$el.closest(".star")}else{$star=$el.closest(".star_link")}var is_starred_icon_in_list=false;if(!$star||!$star.length){if($el.is("button.file_star")){$star=$el.children(".star")}else if($el.closest(".starred_icon").length){is_starred_icon_in_list=true;$star=$el.closest(".starred_icon")}}if(!$star||!$star.length)return false;if($star.hasClass("not-clickable"))return false;var currently_starred=$star.hasClass("starred");var api_args={};var updateFunc;if(is_starred_icon_in_list){var model_ob=TS.shared.getModelObById($star.data("c-id"));if(model_ob){api_args.channel=model_ob.id;currently_starred=model_ob.is_starred;updateFunc=function(starred){if(model_ob.is_channel){_updateChannelStar(api_args.channel,starred)}else if(model_ob.is_im){_updateImStar(api_args.channel,starred)}else if(model_ob.is_mpim){_updateMpimStar(api_args.channel,starred)}else if(model_ob.is_group){_updateGroupStar(api_args.channel,starred)}}}}else if($star.hasClass("star_message")){api_args.channel=$star.data("c-id");api_args.timestamp=$star.data("msg-id");updateFunc=function(starred){_updateMsgStar(api_args.timestamp,api_args.channel,starred,true)}}else if($star.hasClass("star_file")){api_args.file=$star.data("file-id");updateFunc=function(starred){_updateFileStar(api_args.file,starred)}}else if($star.hasClass("star_file_comment")){api_args.file_comment=$star.data("comment-id");updateFunc=function(starred){_updateFileCommentStar(api_args.file_comment,$star.data("file-id"),starred)}}else if($star.hasClass("star_channel")){api_args.channel=$star.data("channel-id");updateFunc=function(starred){_updateChannelStar(api_args.channel,starred)}}else if($star.hasClass("star_group")){api_args.channel=$star.data("group-id");updateFunc=function(starred){_updateGroupStar(api_args.channel,starred)}}else if($star.hasClass("star_im")){api_args.channel=$star.data("im-id");updateFunc=function(starred){_updateImStar(api_args.channel,starred)}}else if($star.hasClass("star_mpim")){api_args.channel=$star.data("mpim-id");updateFunc=function(starred){_updateMpimStar(api_args.channel,starred)}}else{TS.error("checkForStarClick doesn't know what to do with a click on "+$star[0].outerHTML);return false}e.preventDefault();updateFunc(!currently_starred);if(currently_starred){TS.api.call("stars.remove",api_args,function(ok,data,args){if(ok)return;if(data.error=="not_starred"){updateFunc(false)}else{updateFunc(true)}})}else{TS.api.call("stars.add",api_args,function(ok,data,args){if(ok)return;if(data.error=="already_starred"){updateFunc(true)}else{updateFunc(false)}})}return true},updateFileStar:function(file_id,starred){_updateFileStar(file_id,starred)}});var _page=1;var _page_size=20;var _$member_stars_more_btn;var _stars_being_fetched=false;var _stars_needs_fetched=false;var _updateUserStarredList=function(args){_stars_being_fetched=true;_stars_needs_fetched=false;TS.stars.member_stars_being_fetched_sig.dispatch(TS.model.user,true);var dont_set_active=true;var api_args=_starsListArgs();api_args.page=1;api_args._update=true;api_args.count=Math.max(TS.model.user.stars.length,_page_size);if(args&&args.delta)api_args.count+=args.delta;TS.api.call("stars.list",api_args,_onFetchUserStarredItems,dont_set_active)};var _teamFileChanged=function(file){if(file.hasOwnProperty("is_starred")){_updateFileStar(file.id,file.is_starred,file.id);TS.files.updateFileListItem(file,$(".star_item"))}};var _onFetchUserStarredItems=function(ok,data,args){_stars_being_fetched=false;TS.stars.member_stars_being_fetched_sig.dispatch(TS.model.user,false);if(_stars_needs_fetched){TS.stars.maybeUpdateUserStarredList();return}if(!ok){TS.stars.member_stars_fetched_sig.dispatch({error:"api_not_ok"});return}for(var i=0;i<data.items.length;i++){var item=data.items[i];TS.stars.userStarStatusHasChanged(true,item,"stars.list")}if(args.page==1){TS.model.user.stars=data.items}else{TS.model.user.stars=TS.model.user.stars.concat(data.items);TS.model.user.stars=_.uniqWith(TS.model.user.stars,_.isEqual)}_$member_stars_more_btn.data("ladda")&&_$member_stars_more_btn.data("ladda").stop();TS.stars.has_more=data.paging.pages>data.paging.page;if(!args._update)_page++;TS.stars.member_stars_fetched_sig.dispatch(null,TS.model.user)};var _starsListArgs=function(){var args={user:TS.model.user.id,exclude:"Ch,Gh,Dh",page:_page,count:_page_size};return args};var _slurpStarItem=function(item,parent_type){var upsert;if(item.type=="message"){item.message._rxn_key=TS.rxns.getRxnKey("message",item.message.ts,item.channel);if(item.message.type=="channel_topic"||item.message.type=="channel_purpose"||item.message.type=="channel_join"||item.message.type=="channel_leave"){
item.message.subtype=item.message.type}item.message.type="message"}else if(item.type=="file"||item.type=="file_comment"){if(item.file){upsert=TS.files.upsertAndSignal(item.file);item.file=upsert.file;if(item.type=="file_comment"){if(item.comment){item.comment=TS.files.addCommentToFile(item.comment,item.file)}else{TS.error("WTF no comment in type "+item.type+" in "+parent_type);return false}}}else{TS.error("WTF no file in type "+item.type+" in "+parent_type);return false}}else if(item.type=="channel"){}else if(item.type=="group"){}else if(item.type=="im"){}else{TS.error("need to handle star item type:"+item.type+" in "+parent_type);return false}return true};var _updateMsgStar=function(ts,c_id,starred,should_log){var model_ob=TS.shared.getModelObById(c_id);var msg;if(model_ob){msg=TS.utility.msgs.getMsg(ts,model_ob.msgs)}if(should_log){var payload={};var clog_key=starred?"STAR_ADD_CLICKED":"STAR_REMOVE_CLICKED";if(TS.model.unread_view_is_showing){_.merge(payload,TS.client.ui.unread.getTrackingData(ts));TS.client.ui.unread.incrementTrackingSeqId()}TS.clog.track(clog_key,payload)}var selector='.star_message[data-msg-id="'+ts+'"][data-c-id="'+c_id+'"]';_updateStar($(selector),starred,msg,selector)};var _updateFileCommentStar=function(comment_id,file_id,starred){var file=TS.files.getFileById(file_id);var comment;if(!file){TS.warn("updateFileCommentStar file_id:"+file_id+" not found")}else{comment=TS.files.getFileCommentById(file,comment_id)}var selector='.star_comment[data-comment-id="'+comment_id+'"]';_updateStar($(selector),starred,comment,selector)};var _updateFileStar=function(file_id,starred){var file=TS.files.getFileById(file_id);if(!file){TS.warn("updateFileStar file_id:"+file_id+" not found")}var selector='.star_file[data-file-id="'+file_id+'"]';_updateStar($(selector),starred,file,selector)};var _updateChannelStar=function(channel_id,starred){var channel=TS.channels.getChannelById(channel_id);if(!channel){TS.warn("updateChannelStar channel_id:"+channel_id+" not found")}channel.is_starred=starred;var selector='.star_channel[data-channel-id="'+channel_id+'"]';_updateStar($(selector),starred,channel,selector);if(TS.client){TS.client.channel_pane.rebuild("channels","starred")}};var _updateGroupStar=function(group_id,starred){var group=TS.groups.getGroupById(group_id);if(!group){TS.warn("updateGroupStar group_id:"+group_id+" not found")}group.is_starred=starred;var selector='.star_group[data-group-id="'+group_id+'"]';_updateStar($(selector),starred,group,selector);if(TS.client){TS.client.channel_pane.rebuild("channels","starred")}};var _updateImStar=function(im_id,starred){var im=TS.ims.getImById(im_id);if(!im){TS.warn("updateImStar im_id:"+im_id+" not found")}im.is_starred=starred;var selector='.star_im[data-im-id="'+im_id+'"]';_updateStar($(selector),starred,im,selector);if(TS.client){TS.client.channel_pane.rebuild("ims","starred")}};var _updateMpimStar=function(mpim_id,starred){var mpim=TS.mpims.getMpimById(mpim_id);if(!mpim){TS.warn("updateMpimStar mpim_id:"+mpim_id+" not found")}mpim.is_starred=starred;var selector='.star_mpim[data-mpim-id="'+mpim_id+'"]';_updateStar($(selector),starred,mpim,selector);if(TS.client){TS.client.channel_pane.rebuild("ims","starred")}};var _updateStar=function($star,starred,ob,selector){if(starred){if(!$star.hasClass("starred")){$star.addClass("starred ts_icon_star").removeClass("ts_icon_star_o")}}else{$star.removeClass("starred ts_icon_star").addClass("ts_icon_star_o")}if(ob){ob.is_starred=starred}else{}}})();(function(){"use strict";TS.registerModule("mentions",{mention_changed_sig:new signals.Signal,mention_removed_sig:new signals.Signal,mentions_fetched_sig:new signals.Signal,mentions_being_fetched_sig:new signals.Signal,mentions_being_fetched:false,mentions_needs_fetched:false,has_more:false,after_ts:null,fetched_once:false,active_tab:"all",onStart:function(){TS.prefs.mentions_exclude_at_channels_changed_sig.add(_excludeAtChannelsPrefChanged);TS.prefs.mentions_exclude_at_user_groups_changed_sig.add(_excludeUserGroupsPrefChanged)},maybeUpdateMentions:function(user_requested){if(TS.boot_data.app!="client")return;if(!TS.model.team)return;if(TS.mentions.mentions_being_fetched||!TS.mentions.fetched_once||TS.model.ui_state.flex_name!=="mentions"){TS.mentions.mentions_needs_fetched=true;return}TS.mentions.updateMentions(user_requested)},updateMentions:function(user_requested){TS.mentions.mentions_being_fetched=true;TS.mentions.mentions_needs_fetched=false;TS.mentions.mentions_being_fetched_sig.dispatch(user_requested);var dont_set_active=true;TS.api.call("activity.mentions",_activityMentionsArgs(),TS.mentions.onFetchMentions,dont_set_active)},fetchMoreMentions:function(){TS.mentions.fetchMentions(TS.mentions.after_ts)},fetchMentions:function(after_ts){TS.mentions.mentions_needs_fetched=false;TS.mentions.fetched_once=true;var args=_activityMentionsArgs();after_ts=after_ts||"";args.after_ts=after_ts;TS.api.call("activity.mentions",args,TS.mentions.onFetchMentions)},getMentionByMsgId:function(id,replace_message_with,and_remove_it){for(var i=0;i<TS.model.user.mentions.length;i++){var mention=TS.model.user.mentions[i];if(!mention.message)continue;if(mention.message.ts==id){if(replace_message_with){TS.model.user.mentions[i].message=replace_message_with}else if(and_remove_it){TS.model.user.mentions.splice(i,1)}return mention}}return null},onFetchMentions:function(ok,data,args){TS.mentions.mentions_being_fetched=false;if(TS.mentions.mentions_needs_fetched){setTimeout(TS.mentions.maybeUpdateMentions,100)}if(!ok){TS.error("failed fetchMentions");return}var mentions=[];var existing_rxns;var threads={};var thread_channels={};if(TS.boot_data.feature_message_replies&&data.threads&&data.threads.length){data.mentions.forEach(function(mention){if(!mention.message||!mention.channel)return;if(mention.message.thread_ts){thread_channels[mention.message.thread_ts]=mention.channel}});data.threads.forEach(function(thread){var c_id=thread_channels[thread.ts];threads[thread.ts]=TS.utility.msgs.processImsg(thread,c_id)})}for(var i=0;i<data.mentions.length;i++){var mention=data.mentions[i];if(mention.type=="reaction"){if(mention.item.type=="message"){mention.rxn_ts=mention.ts;mention.channel=mention.item.channel;mention.message=mention.item.message;mention.item.message._rxn_key=TS.rxns.getRxnKey("message",mention.item.message.ts,mention.item.channel);delete mention.item}else if(TS.boot_data.feature_file_reactions_activity&&mention.item.type==="file"){mention.rxn_ts=mention.ts;mention.channel=_.first(mention.item.file.channels);mention.message={file:mention.item.file,subtype:"file_reaction",ts:mention.ts};delete mention.item}else{continue}}var msg=mention.message;if(!msg)continue;if(TS.boot_data.feature_message_replies&&mention.type==="thread"){if(threads[msg.thread_ts]){mention.thread=threads[msg.thread_ts]}else{TS.warn("Missing thread in activity.mentions for "+msg.thread_ts);mention.type="at"}}var file=msg.file;var comment=msg.comment;if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"||msg.subtype=="file_reaction"){if(!file)continue;if(msg.subtype=="file_comment"){if(!comment)continue}}if(msg.ts=="0000000000.000000"){TS.warn("bad mention! msg.ts == 0000000000.000000");continue}if(msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_comment"||msg.subtype=="file_reaction"){file._rxn_key=TS.rxns.getRxnKey("file",file.id);existing_rxns=TS.rxns.getExistingRxnsByKey(file._rxn_key);if(existing_rxns&&!file.reactions){TS.warn("file:"+file.id+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(file._rxn_key,file.reactions)}if(msg.subtype=="file_comment"){comment._rxn_key=TS.rxns.getRxnKey("file_comment",comment.id);existing_rxns=TS.rxns.getExistingRxnsByKey(comment._rxn_key);if(existing_rxns&&!comment.reactions){TS.warn("comment:"+comment.id+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(comment._rxn_key,comment.reactions)}}}else{TS.ui.handy_rxns.decorateMsg(msg,msg.text);msg._rxn_key=TS.rxns.getRxnKey("message",msg.ts,mention.channel);existing_rxns=TS.rxns.getExistingRxnsByKey(msg._rxn_key);if(existing_rxns&&!msg.reactions){TS.warn("msg:"+msg.ts+" has reactions in local model, but we got an object in mentions that does NOT have reactions, which seems suspicious")}else{TS.rxns.upsertRxnsFromDataAndUpdateUI(msg._rxn_key,msg.reactions)}var model_ob=TS.shared.getModelObById(mention.channel);var existing_msg=model_ob&&TS.utility.msgs.getMsg(msg.ts,model_ob.msgs);if(existing_msg){msg.is_starred=existing_msg.is_starred}}if(TS.mentions.getMentionByMsgId(msg.ts,msg))continue;mentions.push(mention)}TS.model.user.mentions=TS.model.user.mentions.concat(mentions);TS.mentions.sortMentions();if(TS.mentions.after_ts===null||args.after_ts){TS.mentions.has_more=data.has_more;if(TS.model.user.mentions.length){TS.mentions.after_ts=TS.model.user.mentions[TS.model.user.mentions.length-1].message.ts}}if(TS.boot_data.feature_message_replies){mentions.forEach(function(mention){if(!mention.thread)return;TS.replies.maybeSlurpSubscriptionState(mention.channel,[mention.thread])})}TS.mentions.mentions_fetched_sig.dispatch()},sortMentions:function(){var a_val;var b_val;function compare(a,b){a_val=a.rxn_ts||a.message.ts;b_val=b.rxn_ts||b.message.ts;if(a_val<b_val)return 1;if(a_val>b_val)return-1;return 0}TS.model.user.mentions.sort(compare)},replaceMsg:function(imsg){var mention=TS.mentions.getMentionByMsgId(imsg.ts,imsg);if(mention){TS.mentions.mention_changed_sig.dispatch(mention)}},removeMsg:function(ts){var mention=TS.mentions.getMentionByMsgId(ts,null,true);if(mention){TS.mentions.mention_removed_sig.dispatch(ts)}},setExcludeAtChannelsPref:function(value){value=!!value;TS.model.prefs.mentions_exclude_at_channels=value;TS.prefs.setPrefByAPI({name:"mentions_exclude_at_channels",value:value});_excludeAtChannelsPrefChanged()},setExcludeAtUserGroupsPref:function(value){value=!!value;TS.model.prefs.mentions_exclude_at_user_groups=value;TS.prefs.setPrefByAPI({name:"mentions_exclude_at_user_groups",value:value});_excludeUserGroupsPrefChanged()},weaveInRxnRecords:function(){if(TS.boot_data.feature_message_replies){if(TS.mentions.active_tab==="replies")return}var rxn_records=TS.rxns.getRxnRecords();var key_parts;var rxn_key;var mention_item;var model_ob;var existing_msg;TS.model.user.mentions=TS.model.user.mentions.filter(function(m){return m.type!="rxn"});for(var i=0;i<rxn_records.length;i++){rxn_key=rxn_records[i].rxn_key;key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(key_parts.type=="message"){model_ob=TS.shared.getModelObById(key_parts.c_id);existing_msg=model_ob&&TS.utility.msgs.getMsg(key_parts.id,model_ob.msgs);if(!existing_msg)continue;TS.mentions.getMentionByMsgId(key_parts.id,null,true);mention_item={channel:key_parts.c_id,type:"reaction",rxn_ts:rxn_records[i].last_update,message:_.cloneDeep(existing_msg)};mention_item.message._rxn_key=rxn_key}else if(key_parts.type=="file"){continue}else if(key_parts.type=="file_comment"){continue}else{continue}TS.model.user.mentions.push(mention_item)}TS.mentions.sortMentions()},setActiveTab:function(tab_name){if(TS.mentions.mentions_being_fetched)return;if(tab_name===TS.mentions.active_tab)return;var $tabs=$("#mentions_tab_bar li");$tabs.removeClass("active");$tabs.filter('[data-tab-name="'+tab_name+'"]').addClass("active");TS.mentions.active_tab=tab_name;TS.model.user.mentions=[];$("#mentions_options").toggleClass("hidden",tab_name==="replies");TS.view.hideMentionsMoreButton();TS.view.rebuildMentionsLoading();TS.mentions.maybeUpdateMentions()}});var _activityMentionsArgs=function(){if(TS.boot_data.feature_message_replies){if(TS.mentions.active_tab==="replies"){return _activityMentionsArgsReplies()}else{return _activityMentionsArgsAll()}}else{return _activityMentionsArgsAll()}};var _activityMentionsArgsAll=function(){var args={count:20,reactions:1};var exclude=[];if(TS.model.prefs.mentions_exclude_at_channels){exclude.push("everyone");exclude.push("channel")}if(TS.model.prefs.mentions_exclude_at_user_groups){exclude.push("user_group")}if(exclude.length>0){args.exclude=exclude.join(",")}return args};var _activityMentionsArgsReplies=function(){var args={count:20,replies_only:1};return args};var _excludeAtChannelsPrefChanged=function(){var value=TS.model.prefs.mentions_exclude_at_channels;if(value){_removeMentionTypeMsgs(["everyone","channel"]);TS.mentions.mentions_fetched_sig.dispatch()}else{TS.mentions.maybeUpdateMentions()}};var _excludeUserGroupsPrefChanged=function(){var value=TS.model.prefs.mentions_exclude_at_user_groups;if(value){_removeMentionTypeMsgs(["user_group"]);TS.mentions.mentions_fetched_sig.dispatch()}else{TS.mentions.maybeUpdateMentions()}};var _removeMentionTypeMsgs=function(types){var mention;for(var i=TS.model.user.mentions.length-1;i>=0;i--){mention=TS.model.user.mentions[i];if(types.indexOf(mention.type)!==-1){TS.model.user.mentions.splice(i,1)}}}})();(function(){"use strict";TS.registerModule("inline_videos",{no_scrolling:false,expand_sig:new signals.Signal,collapse_sig:new signals.Signal,onStart:function(){},shouldExpand:function(container_id,inline_video){if(TS.model.expandable_state["vid_"+container_id+inline_video.src])return true;if(TS.model.expandable_state["vid_"+container_id+inline_video.src]===false)return false;if(inline_video.internal_file_id)return TS.model.prefs.expand_internal_inline_imgs;return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){var $collapsed_togglers=$(".msg_inline_media_toggler[data-media-type=video]:not(.expanded)");if(!$collapsed_togglers.length)return;TS.inline_videos.no_scrolling=true;$collapsed_togglers.trigger("click");TS.inline_videos.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_media_toggler[data-media-type=video].expanded").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_video_holder").filter(filter);$holder.find(".msg_inline_video_thumb_div").removeClass("hidden");$holder.removeClass("hidden");$el.find(".msg_inline_media_toggler[data-media-type=video]:not(.expanded)").filter(filter).addClass("expanded");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_videos.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$el.find(".msg_inline_video").last().scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}TS.inline_videos.expand_sig.dispatch(container_id);if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_video_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_media_toggler[data-media-type=video].expanded").filter(filter).removeClass("expanded");$holder.find(".msg_inline_video_iframe_div").html("");TS.inline_videos.collapse_sig.dispatch(container_id);setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},enCommentHTML:function(html){if(!html)return"";var parser=new DOMParser;var body_html="<body>"+html+"</body>";var doc=parser.parseFromString(body_html,"text/html")||parser.parseFromString(body_html,"text/xml");if(!doc||!doc.body)return"";if(doc.body.childNodes.length===0){return""}if(doc.body.childNodes.length==1&&doc.body.childNodes[0].nodeType==Node.COMMENT_NODE){return doc.body.innerHTML}var comment=document.createComment(html);return $("<div>").append(comment).html()},unCommentHTML:function(html){if(!html)return"";var parser=new DOMParser;var doc=parser.parseFromString("<body>"+html+"</body>","text/html");if(!doc||!doc.body)return"";if(doc.body.childNodes.length!=1)return"";var comment=doc.body.childNodes[0];if(comment.nodeType!=Node.COMMENT_NODE)return"";return comment.textContent},checkForInlineVideoClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var $msg_inline_media_toggler=$el.closest(".msg_inline_media_toggler[data-media-type=video]");if($msg_inline_media_toggler.length){e.preventDefault();var src=$msg_inline_media_toggler.data("real-src");if($msg_inline_media_toggler.hasClass("expanded")){TS.inline_videos.collapse(container_id,src)}else{TS.inline_videos.expand(container_id,src)}return}var $msg_inline_video_play_button=$el.closest(".msg_inline_video_play_button");if($msg_inline_video_play_button.length){var $msg_inline_video_holder=$msg_inline_video_play_button.closest(".msg_inline_video_holder");var $msg_inline_video_iframe_div=$msg_inline_video_holder.find(".msg_inline_video_iframe_div");$msg_inline_video_iframe_div.removeClass("hidden");$msg_inline_video_holder.find(".msg_inline_video_thumb_div").addClass("hidden");var url=$msg_inline_video_iframe_div.data("url");var inline_video=TS.model.inline_videos[url];if(!inline_video){var corrected_url=url.replace(/\&/g,"&amp;");inline_video=TS.model.inline_videos[corrected_url]}if(inline_video){$msg_inline_video_iframe_div.html(TS.inline_videos.unCommentHTML(inline_video.html));if(url.indexOf("twitter.com"!==-1)){var $video=$msg_inline_video_iframe_div.find("video");if($video.length){$video[0].play()}}}else{$msg_inline_video_iframe_div.html('<div style="padding:10px; color:white">Error: unable to find "'+TS.utility.htmlEntities(url)+'" in TS.model.inline_videos</div>')}return}},makeInternalInlineVideo:function(key,video){var max_w=400;var max_h=500;TS.model.inline_videos[key]=video;video.src=video.thumbnail.url||key;video.width=video.display_w=parseInt(video.thumbnail.width);video.height=video.display_h=parseInt(video.thumbnail.height);if(video.display_w>max_w){video.display_w=max_w;video.display_h=parseInt(video.height*(video.display_w/video.width))}if(video.display_h>max_h){video.display_h=max_h;video.display_w=parseInt(video.width*(video.display_h/video.height))}if(!video.html)video.html="MISSING video.html";if(video.html.indexOf("gfycat.com/ifr")>-1){video.html=_maybeRewriteGfyCatHtml(video.html)}video.html=video.html.replace("http://","//");if(video.html.indexOf("oldwidth")==-1){video.html=video.html.replace(" width=",' width="'+video.display_w+'" oldwidth=');video.html=video.html.replace(" height=",' height="'+video.display_h+'" oldheight=')}video.html=TS.inline_videos.enCommentHTML(video.html);video.html=TS.utility.swapInRedirUrlForIframe(video.html);var proxied_src=TS.utility.getImgProxyURL(video.src,video.display_w,video.display_h);if(proxied_src!=video.src){video.proxied_src=proxied_src}else{delete video.proxied_src}},test:function(){return{maybeRewriteGfyCatHtml:_maybeRewriteGfyCatHtml}}});var GFYCAT_KEY_REGEXP=/^[a-zA-Z0-9]+$/;var _maybeRewriteGfyCatHtml=function(html){var gfycat_attrs=TS.utility.getAttributesFromHTMLString(html);var gfycat_src=gfycat_attrs.src;if(!gfycat_src){return html}var gfycat_key=gfycat_src.split("ifr/")[1]||"";if(!gfycat_key.match(GFYCAT_KEY_REGEXP)){return html}var gfycat_w=parseInt(gfycat_attrs.width,10);var gfycat_h=parseInt(gfycat_attrs.height,10);if(!gfycat_w||!gfycat_h){return html}gfycat_attrs.src="https://"+document.location.host+"/gfycat_iframe.php?key="+gfycat_key+"&w="+gfycat_w+"&h="+gfycat_h+"&"+Date.now();var $gfycat_ifr=$("<iframe>").attr(gfycat_attrs);return $gfycat_ifr[0].outerHTML}})();(function(){"use strict";TS.registerModule("inline_attachments",{no_scrolling:false,expand_sig:new signals.Signal,collapse_sig:new signals.Signal,onStart:function(){TS.client&&TS.prefs.attachments_with_borders_changed_sig.add(TS.client.msg_pane.rebuildMsgs)},shouldExpand:function(container_id,inline_attachment){if(TS.model.expandable_state["attach_"+container_id+inline_attachment.from_url])return true;if(TS.model.expandable_state["attach_"+container_id+inline_attachment.from_url]===false)return false;return true},shouldShow:function(attachment,msg){if(attachment.is_share)return true;if(attachment.service_name=="twitter"&&msg.subtype=="bot_message")return true;if(!attachment.from_url)return true;if(msg.standalone_attachment)return true;if(msg&&msg.text){if(msg.text.indexOf(attachment.from_url)==-1){if(TS.model.ampersands_are_inconsistent_in_from_urls){if(msg.text.indexOf(attachment.from_url.replace(/\&/g,"&amp;"))==-1){return true}}else{return true}}}if(TS.model.prefs.expand_inline_imgs){if(attachment.audio_html)return true;if(attachment.other_html)return true;if(attachment.video_html)return true;if(attachment.image_url)return true;if(attachment.service_name&&attachment.service_name.toString().toLowerCase()=="twitter")return true}return!!TS.model.prefs.expand_non_media_attachments},expandAllInCurrent:function(){TS.inline_attachments.no_scrolling=true;$(".msg_inline_attachment_expander").trigger("click");TS.inline_attachments.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_attachment_collapser").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["attach_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=$el.find(".inline_attachment").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_attachment_expander").filter(filter).addClass("hidden");$el.find(".msg_inline_attachment_collapser").filter(filter).removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_attachments.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$holder.scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}TS.inline_attachments.expand_sig.dispatch(container_id);if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["attach_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=$el.find(".inline_attachment").filter(filter);if(!$holder.length)$holder=$el.find(".msg_inline_attachment_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_attachment_expander").filter(filter).removeClass("hidden");$el.find(".msg_inline_attachment_collapser").filter(filter).addClass("hidden");TS.inline_attachments.collapse_sig.dispatch(container_id);setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},checkForInlineAttachmentClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id,msg_id;var $message=$el.closest(".message");if(TS.boot_data.feature_message_replies){msg_id=$message.data("ts");container_id=$message.attr("id");if(!container_id)return}else{msg_id=$message.data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return;msg_id=msg_id.toString()}var $msg_inline_attachment_expander=$el.closest(".msg_inline_attachment_expander");if($msg_inline_attachment_expander.length){e.preventDefault();TS.inline_attachments.expand(container_id,$msg_inline_attachment_expander.data("real-src"))}var $msg_inline_attachment_collapser=$el.closest(".msg_inline_attachment_collapser");if($msg_inline_attachment_collapser.length){e.preventDefault();TS.inline_attachments.collapse(container_id,$msg_inline_attachment_collapser.data("real-src"))}var $rest_text_expander=$el.closest(".rest_text_expander");if($rest_text_expander.length){e.preventDefault();var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var $short_text=$rest_text_expander.parent().find(".short_text");var $rest_text_expander_text;var $more_text=$rest_text_expander.parent().find(".more_text");if($rest_text_expander.data("show-text")){if($more_text.length){$more_text.addClass("hidden");$rest_text_expander_text=$rest_text_expander.find("a span");$rest_text_expander.data("hide-text",$rest_text_expander_text.text());$rest_text_expander_text.text($rest_text_expander.data("show-text"));$rest_text_expander.data("show-text","");$rest_text_expander.find("a .ts_icon").removeClass("ts_icon_caret_down").addClass("ts_icon_caret_right")}}else{var all_text=$short_text.attr("data-all-text");if(all_text){$short_text.html(all_text);$short_text.data("all-text","")}if($more_text.length)$more_text.removeClass("hidden");if($more_text.length&&$rest_text_expander.data("hide-text")){$rest_text_expander_text=$rest_text_expander.find("a span");$rest_text_expander.data("show-text",$rest_text_expander_text.text());$rest_text_expander_text.text($rest_text_expander.data("hide-text"));$rest_text_expander.data("hide-text","");$rest_text_expander.find("a .ts_icon").removeClass("ts_icon_caret_right").addClass("ts_icon_caret_down")}else{$rest_text_expander.css("display","none")}}$short_text.css("opacity",0).transition({opacity:1},300);TS.inline_attachments.rest_texts_expanded[$rest_text_expander.attr("id")]=true;if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($short_text);if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$short_text.scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}}var $delete_attachment_link=$el.closest(".delete_attachment_link");if($delete_attachment_link.length){e.preventDefault();var attach_id=$delete_attachment_link.data("attachment-id").toString();var model_ob_id=$message.attr("data-model-ob-id");var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob){alert("missing model_ob");return}if(!attach_id){alert("missing attachment-id");return}var c_id=model_ob.id;var msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);var blacklist_html="";if(TS.model.user.is_admin){var attachment=_.find(msg.attachments,{id:attach_id});if(attachment&&attachment.from_url){var select_html=TS.inline_attachments.makeBlackListSelect(attachment.from_url);blacklist_html='						<p class="large_left_margin '+(select_html?"no_bottom_margin":"")+'">							<label class="checkbox normal" style="font-size: 16px;">								<input id="attachment_blacklist_cb" type="checkbox" class="small_right_margin" />								Disable future attachments from this website?</label>';if(select_html)blacklist_html+=select_html;blacklist_html+="</p>"}}TS.generic_dialog.start({title:"Remove attachment",body:'<p class="'+(blacklist_html?"small_bottom_margin":"")+'">Are you sure you wish to remove this attachment from the message?</p>'+blacklist_html,go_button_text:"Yes, remove",onShow:function(){$("#attachment_blacklist_cb").bind("change",function(){var do_blacklist=!!$("#attachment_blacklist_cb").prop("checked");TS.info(do_blacklist);if(do_blacklist){$("#attachment_blacklist_select").prop("disabled",false)}else{$("#attachment_blacklist_select").prop("disabled",true)}})},onGo:function(){var do_blacklist=!!$("#attachment_blacklist_cb").prop("checked");var blacklist_type=do_blacklist?$("#attachment_blacklist_select").val():"none";var blacklist_url=do_blacklist?$("#attachment_blacklist_select").find(":selected").data("url"):"";var args={channel:c_id,ts:msg_id,attachment:attach_id,blacklist_type:blacklist_type,blacklist_url:blacklist_url};TS.dir(0,args);TS.api.call("chat.deleteAttachment",args,function(ok,data,args){if(ok){if(TS.web){msg.attachments=TS.inline_attachments.removeAttachmentById(msg.attachments,attach_id);TS.utility.msgs.replaceMsg(model_ob,msg)}}else{TS.generic_dialog.alert("Attachment removing failed!")}})}})}},makeBlackListSelect:function(url){if(!url)return"";url=TS.utility.htmlEntities(url).replace("https://","").replace("http://","");var html="";var parts=url.split("/");var host=parts[0];var last=parts[parts.length-1];html+='<label class="select small full_width">\r';html+='<select id="attachment_blacklist_select" disabled="disabled" class="small" style="margin-bottom: 4px;">\r';html+='<option value="all" data-url="'+host+'">All links from '+host+"</option>\r";html+='<option value="just" data-url="'+url+'">Just the link '+url+"</option>\r";if(last!=host){TS.info(last);var new_parts=parts.concat();new_parts.length=new_parts.length-1;var host_path=new_parts.join("/");if(host_path!=host){host_path+="/";html+='<option value="under" data-url="'+host_path+'">All links under '+host_path+"</option>\r"}}html+="</select>\r";html+="</label>\r";return html},rest_texts_expanded:{},shouldExpandText:function(id){return!!TS.inline_attachments.rest_texts_expanded[id]},renderStandaloneAttachment:function(attachment){TS.inline_attachments.massageAttachment(attachment,0);if(attachment.image_url&&!TS.model.inline_imgs[attachment.from_url]){if(!attachment.from_url){attachment.from_url=attachment.image_url}TS.inline_imgs.makeInternalInlineImg(attachment.from_url,{link_url:attachment.from_url,bytes:attachment.image_bytes,src:attachment.image_url,width:isNaN(attachment.image_width)?null:attachment.image_width,height:isNaN(attachment.image_height)?null:attachment.image_height,should_expand:true})}if(attachment.video_html&&!TS.model.inline_videos[attachment.from_url]){TS.inline_videos.makeInternalInlineVideo(attachment.from_url,{src:attachment.thumb_url,html:attachment.video_html,proxied_src:attachment.proxied_thumb_url,title:attachment.title,display_h:attachment.video_html_height,display_w:attachment.video_html_width,thumbnail:{link_url:attachment.from_url,url:attachment.thumb_url,height:attachment.thumb_height,width:attachment.thumb_width}})}var msg_id=TS.utility.date.makeTsStamp();var attachment_html=TS.templates.builders.buildAttachmentHTML({attachment:attachment,msg:{enable_slack_action_links:false,text:attachment["from_url"],ts:msg_id,url:attachment["from_url"],standalone_attachment:attachment.standalone_attachment||false},can_delete:false,maybe_show_file_viewer:false,has_content:TS.utility.attachments.hasContent(attachment),from_post:true});var container_id=TS.templates.makeMsgDomId(msg_id);return'<div class="message standalone-attachment" id="'+container_id+'" data-ts="'+msg_id+'">'+attachment_html+"</div>"},massageAttachment:function(attachment,index){attachment._index=index;
if("id"in attachment)attachment.id=attachment.id.toString();var short_text_limit=500;var short_text_br_limit=3;var short_text="";var short_text_display_length=0;if(attachment.text){var rest_text="";var markup_chunk="";var label="";var c;var br_count=0;var stop_at_next_space=false;for(var i=0;i<attachment.text.length;i++){c=attachment.text.charAt(i);if(markup_chunk||c=="<"){markup_chunk+=c;if(label||c=="|"){label+=c}if(c==">"){short_text+=markup_chunk;short_text_display_length+=label.length-2;if(short_text_display_length>short_text_limit){stop_at_next_space=true}markup_chunk="";label=""}}else{if(c=="\n"){br_count++}if(br_count>short_text_br_limit+1){rest_text=attachment.text.replace(short_text,"");break}short_text+=c;short_text_display_length++;if(short_text_display_length>short_text_limit){stop_at_next_space=true}if(stop_at_next_space&&c==" "){rest_text=attachment.text.replace(short_text,"");break}}}attachment._short_text=short_text==attachment.text?"":short_text;var tbt_before=short_text.match(/```/g);var tbt_after=rest_text.match(/```/g);if(tbt_before&&tbt_after){attachment._short_text+="```"}}attachment._floated_thumb_display_height=75;attachment._floated_thumb_display_width=75;if(attachment.thumb_height&&attachment.thumb_width){if(attachment.thumb_height>attachment.thumb_width){attachment._floated_thumb_display_width=parseInt(attachment.thumb_width*(attachment._floated_thumb_display_height/attachment.thumb_height))}else{attachment._floated_thumb_display_height=parseInt(attachment.thumb_height*(attachment._floated_thumb_display_width/attachment.thumb_width))}}var proxied_thumb_url=TS.utility.getImgProxyURL(attachment.thumb_url,attachment._floated_thumb_display_width,attachment._floated_thumb_display_height);if(proxied_thumb_url!=attachment.thumb_url){attachment.proxied_thumb_url=proxied_thumb_url}else{delete attachment.proxied_thumb_url}},getAttachmentByFromUrl:function(attachments,url){if(!attachments)return null;for(var i=0;i<attachments.length;i++){if(!attachments[i]){TS.info(url);TS.dir(0,attachments);continue}if(!attachments[i].from_url){continue}if(attachments[i].from_url==url){return attachments[i]}if(TS.model.ampersands_are_inconsistent_in_from_urls){if(attachments[i].from_url.replace(/\&/g,"&amp;")==url){return attachments[i]}}}return null},getAttachmentBySlackFileId:function(attachments,slack_file_id){if(!attachments)return null;if(!slack_file_id)return null;for(var i=0;i<attachments.length;i++){if(!attachments[i]){continue}if(attachments[i].slack_file_id==slack_file_id){return attachments[i]}}return null},removeAttachmentById:function(attachments,id){if(!attachments)return null;var A=[];for(var i=0;i<attachments.length;i++){if(attachments[i].id!=id){A.push(attachments[i])}}return A}})})();(function(){"use strict";TS.registerModule("inline_others",{no_scrolling:false,expand_sig:new signals.Signal,collapse_sig:new signals.Signal,onStart:function(){},shouldExpand:function(container_id,inline_other){if(TS.model.expandable_state["vid_"+container_id+inline_other.src])return true;if(TS.model.expandable_state["vid_"+container_id+inline_other.src]===false)return false;if(inline_other.internal_file_id)return TS.model.prefs.expand_internal_inline_imgs;return TS.model.prefs.expand_inline_imgs},expandAllInCurrent:function(){var $collapsed_togglers=$(".msg_inline_media_toggler[data-media-type=other]:not(.expanded)");if(!$collapsed_togglers.length)return;TS.inline_others.no_scrolling=true;$collapsed_togglers.trigger("click");TS.inline_others.no_scrolling=false;if(TS.client){TS.client.ui.instaScrollMsgsToBottom(false)}},collapseAllInCurrent:function(){$(".msg_inline_media_toggler[data-media-type=other].expanded").trigger("click")},expand:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_other_holder").filter(filter);$holder.removeClass("hidden");$el.find(".msg_inline_media_toggler[data-media-type=other]:not(.expanded)").filter(filter).addClass("expanded");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!TS.inline_others.no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$el.children().first().scrollintoview({duration:0,offset:"top",px_offset:10,direction:"y"})}else{$el.find(".msg_inline_other").last().scrollintoview({duration:200,offset:"bottom",px_offset:-10,direction:"y"})}}TS.inline_others.expand_sig.dispatch(container_id);if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere()},collapse:function(container_id,src){TS.model.expandable_state["vid_"+container_id+src]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(i){return $(this).data("real-src")==src};var $holder=TS.boot_data.feature_attachments_inline?$el.find(".inline_attachment").filter(filter):null;if(!$holder||!$holder.length)$holder=$el.find(".msg_inline_other_holder").filter(filter);$holder.css("visibility","hidden");$el.find(".msg_inline_media_toggler[data-media-type=other].expanded").filter(filter).removeClass("expanded");$holder.find(".msg_inline_other_iframe_div").html("");TS.inline_others.collapse_sig.dispatch(container_id);setTimeout(function(){$holder.addClass("hidden");$holder.css("visibility","visible")},200)},checkForInlineOtherClick:function(e,match){if(!e.target)return;var $el=$(e.target);var container_id;if(TS.boot_data.feature_message_replies){var $message=$el.closest(".message");container_id=$message.attr("id");if(!container_id)return}else{var msg_id=$el.closest(".message").data("ts");container_id=TS.templates.makeMsgDomId(msg_id);if(!msg_id&&match){msg_id=$el.closest(".search_message_result").data("ts");container_id=TS.templates.makeMSRDomId(match)}if(!msg_id)return}var $msg_inline_media_toggler=$el.closest(".msg_inline_media_toggler[data-media-type=other]");if($msg_inline_media_toggler.length){e.preventDefault();var src=$msg_inline_media_toggler.data("real-src");if($msg_inline_media_toggler.hasClass("expanded")){TS.inline_others.collapse(container_id,src)}else{TS.inline_others.expand(container_id,src)}return}},makeInternalInlineOther:function(attachment){var max_w=400;var max_h=500;if(attachment.other_html_width>max_w){attachment.other_html_height=parseInt(attachment.other_html_height*(max_w/attachment.other_html_width));attachment.other_html_width=max_w}if(attachment.other_html_height>max_h){attachment.other_html_width=parseInt(attachment.other_html_width*(max_h/attachment.other_html_height));attachment.other_html_height=max_h}var google_map_config;if(attachment.google_map_config){google_map_config=TS.utility.parseJSONOrElse(attachment.google_map_config,undefined)}if(google_map_config&&google_map_config.center&&typeof google_map_config.center.lat!="string"){google_map_config.scrollwheel=false;var dom_id="googmap_"+_googmap_index++;attachment.other_html='<div class="google-maps" id="'+dom_id+'" style="width:100%; min-width:'+TS.utility.htmlEntities(attachment.other_html_width)+"px; height:"+TS.utility.htmlEntities(attachment.other_html_height)+'px;"></div>			<script>TS.inline_others.runGoogleMapCode("'+dom_id+"\", '"+JSON.stringify(google_map_config)+"')</script>";attachment.safe_other_html=attachment.other_html}else{if(attachment.other_html.indexOf("oldwidth")==-1){attachment.other_html=attachment.other_html.replace(" width=",' width="'+attachment.other_html_width+'" oldwidth=');attachment.other_html=attachment.other_html.replace(" height=",' height="'+attachment.other_html_height+'" oldheight=')}attachment.safe_other_html=attachment.other_html;attachment.safe_other_html=TS.utility.swapInRedirUrlForIframe(attachment.safe_other_html);if(TS.client)attachment.safe_other_html=TS.utility.getPlaceholderHTMLFromIframe(attachment.safe_other_html)}TS.model.inline_others[attachment.other_html]={src:TS.utility.htmlEntities(attachment.other_html),attachment:attachment}},runGoogleMapCode:function(map_id,config_str){if(!window.google)return;if(!config_str)return;var config=JSON.parse(config_str);var map=new google.maps.Map(document.getElementById(map_id),config);if(!config.query)return;var geocoder=new google.maps.Geocoder;var max_results=typeof config.max_results=="number"?config.max_results:10;if(max_results<0){max_results=Number.MAX_VALUE}var boundsChangedHandler=function(){google.maps.event.clearListeners(map,"bounds_changed");var bounds=map.getBounds();var markers_placed=0;var mapperFunction=function(maps_result){new google.maps.Marker({map:map,position:maps_result.geometry.location});markers_placed++};var geocodeHandler=function(results,status){var has_exact_match=false;if(status==google.maps.GeocoderStatus.OK){results.slice(0,max_results).map(function(result){mapperFunction(result);has_exact_match=has_exact_match||!result.partial_match})}else{TS.warn("Geocoder failed due to: "+status)}if(!has_exact_match&&markers_placed<max_results){var place=new google.maps.places.PlacesService(map);var nearbySearchHandler=function(results,status){if(status==google.maps.places.PlacesServiceStatus.OK){results.slice(0,max_results-markers_placed).map(mapperFunction)}else{TS.warn("PlacesService failed due to: "+status)}};place.nearbySearch({bounds:bounds,name:config.query},nearbySearchHandler)}};geocoder.geocode({address:config.query,bounds:bounds},geocodeHandler)};google.maps.event.addListener(map,"bounds_changed",boundsChangedHandler)}});var _googmap_index=0})();(function(){"use strict";TS.registerModule("msg_edit",{edit_started_sig:new signals.Signal,edit_ended_sig:new signals.Signal,editing:false,editing_in_msg_pane:false,editing_in_convo_pane:false,deleting_from_editing:false,current_msg:null,current_model_ob:null,edit_interv:0,onStart:function(){},onCountDownInterval:function(){if(!TS.msg_edit.current_msg)return;if(TS.model.team.prefs.msg_edit_window_mins==-1){$("#edit_countdown").empty();return}var exp=TS.utility.date.toDateObject(TS.msg_edit.current_msg.ts).getTime()+TS.model.team.prefs.msg_edit_window_mins*60*1e3;var seconds=Math.floor((exp-Date.now())/1e3);if(seconds<1){$("#edit_countdown").html("(your time to edit ran out)&nbsp&nbsp&nbsp&nbsp")}else if(seconds<61){$("#edit_countdown").html("(you have <b>"+seconds+"</b> seconds)&nbsp&nbsp&nbsp&nbsp")}else{$("#edit_countdown").empty()}},cancelEditingINothingHasChanged:function(){if(!TS.msg_edit.editing)return true;var original_msg_text=TS.format.unFormatMsg(TS.msg_edit.current_msg.text);var edited_text=$("#message_edit_form").find("#msg_text").val();if(edited_text===original_msg_text){if(TS.boot_data.feature_tinyspeck)console.log("13921 cancelEditingINothingHasChanged: text has not changed, cancelling");TS.msg_edit.onCancelEdit();return true}return false},editExpiration:function(minutes){var expiration_text="<p>Oops&mdash;";if(minutes>0){var msg_edit_duration_text=_getReadableMessageEditDuration(minutes);expiration_text+="Messages can only be edited up to <b>"+msg_edit_duration_text+"</b> after posting.</p><p>Never mind, we all make mistakes. Post again!</p>";if(TS.model.user.is_admin){expiration_text+='<p>(To adjust the message editing window, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}}else{expiration_text+="You cannot edit your message after posting.</p>";if(TS.model.user.is_admin){expiration_text+='<p>(To enable message editing, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}}return expiration_text},startEdit:function(msg_ts,model_ob,edit_state){if($("#message_edit_form").length&&!TS.msg_edit.cancelEditingINothingHasChanged()){TS.msg_edit.promptEdit();return}if(!msg_ts){TS.error("no msg_ts?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!model_ob.msgs){TS.error("no model_ob.msgs?");return null}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(TS.boot_data.feature_message_replies&&!msg){msg=TS.ui.replies.getActiveMessage(model_ob,msg_ts)}if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing&&!msg){msg=TS.client.threads.getMessage(model_ob,msg_ts)}if(!msg){TS.error("no msg in msgs?");return null}if(TS.boot_data.feature_thanks&&msg._handy_rxns_poll_data){return TS.ui.handy_rxns.startPollDialog(model_ob.id,msg_ts)}var original_msg_text=TS.format.unFormatMsg(msg.text);var is_reopening_after_failed_edit=edit_state&&edit_state.force_reopen;if(!is_reopening_after_failed_edit){var now=Date.now();var ts=TS.utility.date.toDateObject(msg.ts);var elapsed=now-ts;var elapsed_minutes=elapsed/6e4;if(TS.model.team.prefs.msg_edit_window_mins>=0&&elapsed_minutes>TS.model.team.prefs.msg_edit_window_mins&&!model_ob.is_self_im){TS.warn("Editing unvailable on channel "+model_ob.id+", msg with ts = "+msg.ts+". now = "+now+", elapsed (minutes) = "+elapsed_minutes+", msg_edit_window_mins = "+TS.model.team.prefs.msg_edit_window_mins);TS.generic_dialog.alert(TS.msg_edit.editExpiration(TS.model.team.prefs.msg_edit_window_mins),"Editing Unavailable","Got It");return}}var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var msg_el;if(edit_state=="convo"){TS.msg_edit.editing_in_msg_pane=false;TS.msg_edit.editing_in_convo_pane=true;msg_el=TS.msg_edit.getDivForMsgInConvoPane(msg.ts)}else{TS.msg_edit.editing_in_msg_pane=true;TS.msg_edit.editing_in_convo_pane=false;msg_el=TS.msg_edit.getDivForMsgInMsgPane(msg.ts)}if(!msg_el.length){TS.error("no msg div for edit");return null}TS.msg_edit.current_msg=msg;TS.msg_edit.current_model_ob=model_ob;msg_el.addClass("hidden");var edit_text=original_msg_text;if(edit_state&&edit_state.text){edit_text=edit_state.text}var html=TS.templates.message_edit_form({msg:msg,edit_text:edit_text,permalink:TS.utility.msgs.constructMsgPermalink(model_ob,msg.ts),include_emo:!!TS.client});msg_el.after(html);var form=$("#message_edit_form");var input=form.find("#msg_text");TS.msg_edit.checkLengthOK(input);TS.info("message_edit_form added");TS.msg_edit.editing=true;TS.msg_edit.edit_started_sig.dispatch();form.bind("destroyed",function(){if(TS.boot_data.feature_tinyspeck)console.log("13921 message_edit_form removed");TS.info("message_edit_form removed");TS.msg_edit.editing=false;TS.msg_edit.editing_in_msg_pane=false;TS.msg_edit.editing_in_convo_pane=false;TS.msg_edit.edit_ended_sig.dispatch();form=null;input=null;TS.msg_edit.resetEditUI()});if(TS.boot_data.feature_you_autocomplete_me){input.TS_tabCompleteNew({complete_cmds:false,complete_channels:true,complete_user_groups:true,complete_emoji:true,complete_member_specials:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput(input,txt,new_cp)},sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}else{input.TS_tabComplete({complete_cmds:false,complete_channels:true,complete_user_groups:true,complete_emoji:true,complete_member_specials:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput(input,txt,new_cp)},sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}var tab_complete_ui_props={id:"msg_edit_tab_ui",scroll_with_element:!!TS.client};var in_flexpane=input.closest("#col_flex").length>0;if(in_flexpane){tab_complete_ui_props.min_width=300;tab_complete_ui_props.narrow=!!TS.client}input.tab_complete_ui(tab_complete_ui_props);TSSSB.call("inputFieldCreated",input.get(0));form.bind("submit",function(e){if(TS.boot_data.feature_tinyspeck)console.log("13921 message_edit_form submit");e.preventDefault();var edited_text=input.val();if(edited_text===original_msg_text){if(TS.boot_data.feature_tinyspeck)console.log("13921 message_edit_form submit no changes");TS.msg_edit.onCancelEdit();return}if(!edited_text){TS.msg_edit.startDelete(TS.msg_edit.current_msg.ts,TS.msg_edit.current_model_ob,TS.msg_edit.onCancelEdit,true);return}var blocked_keyword=TS.ui.needToBlockAtChannelKeyword(edited_text,null,TS.msg_edit.current_model_ob.id);if(blocked_keyword){TS.generic_dialog.alert("<p>A Team Owner has restricted the use of <b>"+TS.utility.htmlEntities(blocked_keyword)+"</b> messages.</p>");return}if(!$.trim(edited_text))return;TS.msg_edit.onConfirmEdit(edited_text)});input.bind("textchange",function(e,prev_txt){TS.msg_edit.checkLengthOK(input)}).bind("keyup",function(e){var selection;var msgs_scroller_dimensions=TS.client&&TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);if(window.getSelection){selection=window.getSelection();if(selection&&selection.toString&&!selection.toString()){if(!TS.client||form.outerHeight()<msgs_scroller_dimensions.height){$("#edit_controls").scrollintoview({px_offset:-50})}}}}).bind("keydown",function(e){if(e.which==TS.utility.keymap.enter&&(e.ctrlKey||e.altKey)){if(!TS.model.is_mac||(TS.model.is_FF||TS.model.is_electron||TS.model.is_chrome_desktop)){var p=input.getCursorPosition();var val=input.val();input.val(val.substr(0,p)+"\n"+val.substr(p));input.trigger("autosize").trigger("autosize-resize");input.setCursorPosition(p+1)}}else if(e.which==TS.utility.keymap.enter){if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs(input)&&!e.shiftKey){return}else if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs(input)&&e.shiftKey){e.preventDefault();TS.msg_edit.checkAndSubmit(input,form);return}else if(input.tab_complete_ui("isShowing")){e.preventDefault();return}else if(!e.shiftKey&&!e.altKey){e.preventDefault();TS.msg_edit.checkAndSubmit(input,form);return}}}).autosize({boxOffset:18});$("body").bind("keydown.close_message_edit_form",function(e){if(e.which==TS.utility.keymap.esc){if(input.tab_complete_ui("isShowing")||input.tab_complete_ui("wasJustHidden"))return;if(!TS.model.menu_is_showing&&!TS.model.dialog_is_showing)setTimeout(TS.msg_edit.onCancelEdit,0)}});form.find("#commit_edit").bind("click",function(){TS.msg_edit.checkAndSubmit(input,form)});form.find("#cancel_edit").bind("click",function(){TS.msg_edit.onCancelEdit()});var $emo_menu=form.find(".emo_menu");$emo_menu.removeClass("hidden");$emo_menu.bind("click.open_dialog",function(e){TS.menu.emoji.start({e:e,input_to_fill:"#msg_text"})});if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false)}var msgs_scroller_dimensions=TS.client&&TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);if(!TS.client||form.outerHeight()<msgs_scroller_dimensions.height){$("#edit_controls").scrollintoview({duration:500,px_offset:-50,complete:function(){TS.msg_edit.focusAndSetCursorPosition(input,edit_state)}})}else{TS.msg_edit.focusAndSetCursorPosition(input,edit_state);$("#edit_controls").scrollintoview({duration:500,px_offset:-50})}$("#msg_text").attr("spellcheck",!!TS.model.prefs.webapp_spellcheck);TS.msg_edit.onCountDownInterval();TS.msg_edit.edit_interv=setInterval(TS.msg_edit.onCountDownInterval,1e3)},checkLengthOK:function(input){var too_long=TS.format.cleanMsg(input.val()).length>TS.model.input_maxlength;if(too_long){$("#edit_warning").removeClass("hidden");$("#edit_saver").addClass("hidden");return false}else{$("#edit_warning").addClass("hidden");$("#edit_saver").removeClass("hidden");return true}},checkAndSubmit:function(input,form){if(TS.boot_data.feature_tinyspeck)console.log("13921 checkAndSubmit");if(TS.msg_edit.checkLengthOK(input)){form.submit()}},onConfirmEdit:function(edited_text){if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}if(!edited_text){TS.error("no edited_text?");return null}var in_replies=TS.msg_edit.editing_in_convo_pane;TS.msg_edit.commitEditInternal(edited_text);TS.msg_edit.resetEditUI();if(TS.client){if(in_replies){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}}},onCancelEdit:function(){if(TS.boot_data.feature_tinyspeck)console.log("13921 onCancelEdit");if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}var in_replies=TS.msg_edit.editing_in_convo_pane;TS.msg_edit.resetEditUI();if(TS.client){if(in_replies){TS.ui.replies.focusReplyInput()}else{TS.view.focusMessageInput()}}},resetEditUI:function(){if(TS.boot_data.feature_tinyspeck)console.log("13921 resetEditUI");clearInterval(TS.msg_edit.edit_interv);if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}TS.msg_edit.getDivBeingEdited().removeClass("hidden");$("#message_edit_container").remove();$("body").unbind("keydown.close_message_edit_form")},getDivBeingEdited:function(){if(TS.msg_edit.editing_in_msg_pane)return TS.msg_edit.getDivForMsgInMsgPane(TS.msg_edit.current_msg.ts);if(TS.msg_edit.editing_in_convo_pane)return TS.msg_edit.getDivForMsgInConvoPane(TS.msg_edit.current_msg.ts);return $()},getDivForMsgInMsgPane:function(ts){var is_unread_view=TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing;var is_threads_view=TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing;if(is_unread_view){return $("#"+TS.templates.makeMsgDomIdInUnreadView(ts))}else if(is_threads_view){return $("#"+TS.templates.makeMsgDomIdInThreadsView(ts))}else{return $("#"+TS.templates.makeMsgDomId(ts))}},getDivForMsgInConvoPane:function(ts){return $("#"+TS.templates.makeMsgDomIdInConversation(ts))},getAllDivsForMsg:function(ts){var $msg_pane_div=TS.msg_edit.getDivForMsgInMsgPane(ts);if(TS.replies&&TS.replies.isEnabled()){return $msg_pane_div.add(TS.msg_edit.getDivForMsgInConvoPane(ts))}else{return $msg_pane_div}},commitEditInternal:function(edited_text){TS.msg_edit.commitEdit(TS.msg_edit.current_msg,TS.msg_edit.current_model_ob,edited_text)},commitEdit:function(msg,model_ob,edited_text,attempts,delay_ms){if(!msg){TS.error("no msg?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!attempts)attempts=0;if(!delay_ms)delay_ms=100;TS.api.call("chat.update",{channel:model_ob.id,ts:msg.ts,text:TS.format.cleanMsg(edited_text),_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok){if(TS.web||model_ob.is_channel&&!model_ob.is_member){var new_msg=_.extend({},msg,{text:data.text,edited:{ts:TS.utility.date.makeTsStamp(null,"0")}});TS.utility.msgs.replaceMsg(model_ob,new_msg)}}else{if(!data||!data.error){TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}else if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitEdit(msg,model_ob,edited_text,args._attempts,args._delay_ms)},args._delay_ms);return}if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}else if(data.error=="edit_window_closed"){var error_text="<p>Sorry, but messages can only be edited for <b>"+_getReadableMessageEditDuration(TS.model.team.prefs.msg_edit_window_mins)+"</b> after posting.</p>";if(TS.model.user.is_admin){error_text+='<p>(To adjust the message editing window, visit <a href="/admin/settings#message_editing" target="_new">Team&nbsp;Settings</a>.)</p>'}TS.generic_dialog.alert(error_text,"Message editing failed")}else if(data.error=="msg_too_long"){TS.generic_dialog.alert("Sorry, your message is too long. Please shorten it and try again.","Message editing failed")}else{TS.generic_dialog.alert("Sorry, something went wrong with editing your message. Try again in a moment.","Message editing failed")}TS.msg_edit.startEdit(msg.ts,model_ob,{text:edited_text,force_reopen:true})}})},promptEdit:function(){if($("#message_editing_info").css("display")!="none"){$("#message_edit_container").scrollintoview({duration:300,px_offset:0});return}$("#message_editing_info").css("display","");$("#message_editing_info").css("opacity",0);$("#message_edit_container").scrollintoview({duration:300,px_offset:0,complete:function(){$("#message_editing_info").transition({opacity:1},250)}})},startDelete:function(msg_ts,model_ob,onSuccessFunc,from_editing){if(!msg_ts){TS.error("no msg_ts?");return null}if(!model_ob){TS.error("no model_ob?");return null}if(!model_ob.msgs){TS.error("no model_ob.msgs?");return null}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(TS.boot_data.feature_message_replies&&!msg){msg=TS.ui.replies.getActiveMessage(model_ob,msg_ts)}if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing&&!msg){msg=TS.client.threads.getMessage(model_ob,msg_ts)}if(!msg){TS.error("no msg in msgs?");return null}TS.msg_edit.deleting_from_editing=!!from_editing;TS.msg_edit.current_msg=msg;TS.msg_edit.current_model_ob=model_ob;var $msg_el=TS.msg_edit.getAllDivsForMsg(msg.ts);var dialog_body='<p class="small_bottom_margin">Are you sure you want to delete this message? This cannot be undone.</p>';if(msg.subtype){var file_label;if(msg.file){file_label="file";if(msg.file.mode=="snippet"){file_label="snippet"}else if(msg.file.mode=="post"){file_label="post"}}var txt="";if(msg.subtype=="file_upload"){txt="Note that deleting this message will not delete the "+file_label+" that was uploaded."}else if(msg.subtype=="file_share"){txt="Note that deleting this message will not unshare the "+file_label+"."}else if(msg.subtype=="file_comment"){txt="Note that deleting this message will not delete the comment."}if(txt){dialog_body+="<p>"+txt+"</p>"}}$msg_el.addClass("delete_mode");TS.generic_dialog.start({title:"Delete Message",body:dialog_body+TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true}),go_button_text:"Yes, delete this message",go_button_class:"btn_danger",onGo:function(){if(TS.msg_edit.deleting_from_editing){TS.msg_edit.onCancelEdit()}TS.msg_edit.commitDeleteInternal(onSuccessFunc)},onCancel:function(){TS.msg_edit.onCancelDelete()}});TS.generic_dialog.div.find("img.msg_inline_img.hidden").each(function(index,element){var $element=$(element);$element.prop("src",$element.data("real-src"));$element.removeClass("hidden")})},onCancelDelete:function(){if(!TS.msg_edit.current_msg){TS.error("no TS.msg_edit.current_msg?");return null}var $msg_el=TS.msg_edit.getAllDivsForMsg(TS.msg_edit.current_msg.ts);$msg_el.removeClass("delete_mode");if(TS.msg_edit.deleting_from_editing){$("#msg_text").focus()}},commitDeleteInternal:function(onSuccessFunc){TS.msg_edit.commitDelete(TS.msg_edit.current_msg,TS.msg_edit.current_model_ob,TS.msg_edit.onCancelDelete,onSuccessFunc)},commitDelete:function(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,attempts,delay_ms){if(!msg){TS.error("no msg?");return null}if(!model_ob){TS.error("no model_ob?");return null}var c_id=model_ob.id;if(!attempts)attempts=0;if(!delay_ms)delay_ms=100;if(msg.is_ephemeral||TS.utility.msgs.isTempMsg(msg)){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}else{return}}else{if(msg._jl_rollup_hash&&msg._jl_rollup_hash.msg_ids){var msg_ids=msg._jl_rollup_hash.msg_ids;for(var i=0;i<msg_ids.length;i++){if(msg_ids[i]==msg.ts)continue;TS.api.call("chat.delete",{channel:c_id,ts:msg_ids[i],_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok||data.error=="message_not_found"){if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitDelete(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,args._attempts,args._delay_ms)},args._delay_ms);return}}if(TS.web||model_ob.is_channel&&!model_ob.is_member){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,TS.utility.msgs.getMsg(args.ts,_getMsgs(model_ob)))}}}})}}TS.api.call("chat.delete",{channel:c_id,ts:msg.ts,_attempts:attempts,_delay_ms:delay_ms},function(ok,data,args){if(ok||data.error=="message_not_found"){if(data.error=="message_not_found"){if(args._attempts<10){args._delay_ms*=1.75;setTimeout(function(){TS.msg_edit.commitDelete(msg,model_ob,onFailFunc,onSuccessFunc,no_fail_alert,args._attempts,args._delay_ms)},args._delay_ms);return}}if(TS.web||model_ob.is_channel&&!model_ob.is_member){if(model_ob.is_channel){TS.channels.removeMsg(model_ob.id,msg)}else if(model_ob.is_im){TS.ims.removeMsg(model_ob.id,msg)}else if(model_ob.is_mpim){TS.mpims.removeMsg(model_ob.id,msg)}else if(model_ob.is_group){TS.groups.removeMsg(model_ob.id,msg)}}if(onSuccessFunc)onSuccessFunc()}else{if(onFailFunc)onFailFunc();if(!no_fail_alert){var txt="The message was not deleted.  The error was: "+(data&&data.error?data.error:"unknown");TS.generic_dialog.start({title:"Delete Message Failed",body:txt,show_cancel_button:false,esc_for_ok:true})}}if(TS.web){var all_deleted=!TS.utility.msgs.getDisplayedMsgs(model_ob.msgs).length;if(all_deleted){var prev_link=$(".pager .previous a");if(prev_link.attr("href")){window.location=prev_link.attr("href")}else{window.location.reload()}}}})}},$last_clicked_cb:null,startBatchDelete:function(){$("#msgs_div").addClass("selecting_messages");$("#channel_actions_div").addClass("hidden");$("#batch_delete_div").removeClass("hidden");TS.msg_edit.batchDeleteSelectionChanged()},cancelBatchDelete:function(){TS.msg_edit.selectNoneBatchDelete();$("#msgs_div").removeClass("selecting_messages");$("#channel_actions_div").removeClass("hidden");$("#batch_delete_div").addClass("hidden")},doBatchDelete:function(){var $cbs_checked=$("#msgs_div").find(".msg_select_cb:checked");var model_ob=TS.shared.getActiveModelOb();if($cbs_checked.length){var count=$cbs_checked.length;if(count==1){TS.msg_edit.startDelete($cbs_checked.eq(0).closest(".message").data("ts"),model_ob,TS.msg_edit.cancelBatchDelete);return}var count_txt=count==1?"this message":"these "+count+" messages";var dialog_body='<p class="small_bottom_margin">Are you sure you want to delete '+count_txt+"? This cannot be undone! Note that deleting these messages will not delete any files or file comments.</p>";var prev_msg;var msg;for(var i=0;i<count;i++){if(msg&&!msg.no_display)prev_msg=msg;var msg_ts=$cbs_checked.eq(i).closest(".message").data("ts");msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg)continue;dialog_body+=TS.templates.builders.buildMsgHTML({msg:msg,prev_msg:prev_msg,model_ob:model_ob,standalone:true})}var deleteThese=function(A){function deleteOne(msg){TS.msg_edit.commitDelete(msg,model_ob,next,next,true)}function next(){if(A.length){setTimeout(function(){deleteOne(A.pop())},100)}else{TS.generic_dialog.cancel();TS.generic_dialog.start({title:"",body:"Messages deleted.",show_cancel_button:false,esc_for_ok:true})}}TS.generic_dialog.start({title:"",body:"<P>Deleting messages...</p>",show_cancel_button:false,show_go_button:false});next()};TS.generic_dialog.start({title:"Delete Messages",body:dialog_body,go_button_text:"Yes, delete these messages",go_button_class:"btn_danger",onGo:function(){var A=[];for(var i=0;i<count;i++){var msg_ts=$cbs_checked.eq(i).closest(".message").data("ts");if(!msg_ts){alert("no msg_ts");return}var msg=TS.utility.msgs.getMsg(msg_ts,_getMsgs(model_ob));if(!msg){alert("no msg");return}A.push(msg)}TS.msg_edit.cancelBatchDelete();
deleteThese(A)}})}else{}},batchDeleteSelectionChanged:function($cb,extend){var $last_clicked_cb=TS.msg_edit.$last_clicked_cb;if($last_clicked_cb&&$cb&&extend){var $cbs=$("#msgs_div").find(".msg_select_cb:visible");var start_i=$cbs.index($last_clicked_cb);var end_i=$cbs.index($cb);if(start_i>end_i){end_i=start_i;start_i=$cbs.index($cb)}var checked=$last_clicked_cb.prop("checked")=="checked";for(var i=start_i;i<=end_i;i++){$cbs.eq(i).prop("checked",checked)}}TS.msg_edit.$last_clicked_cb=$last_clicked_cb=$cb;var count_txt="0 messages";var $cbs_checked=$("#msgs_div").find(".msg_select_cb:checked");$("#msgs_div").find(".multi_delete_mode").removeClass("multi_delete_mode");if($cbs_checked.length){if($cbs_checked.length==1){count_txt="1 message"}else{count_txt=$cbs_checked.length+" messages"}$("#batch_delete_button").removeClass("disabled");$cbs_checked.each(function(){$(this).closest(".message").addClass("multi_delete_mode")})}else{$("#batch_delete_button").addClass("disabled")}$("#batch_delete_count_span").html(count_txt)},selectAllBatchDelete:function(){$("#msgs_div").find(".msg_select_cb:visible").prop("checked",true);TS.msg_edit.batchDeleteSelectionChanged()},selectNoneBatchDelete:function(){$("#msgs_div").find(".msg_select_cb:visible").prop("checked",false);TS.msg_edit.batchDeleteSelectionChanged()},pauseEditing:function(){if(!TS.msg_edit.editing)return;var $input=$("#msg_text");var text=$input.val();var cursor_start=$input.textrange("get","start");var cursor_length=$input.textrange("get","length");var edit_state={msg_ts:TS.msg_edit.current_msg.ts,model_ob:TS.msg_edit.current_model_ob,text:text,cursor_start:cursor_start,cursor_length:cursor_length};TS.msg_edit.resetEditUI();return edit_state},resumeEditing:function(edit_state){if(TS.msg_edit.editing)return;if(!edit_state)return;if(TS.model.active_cid!==edit_state.model_ob.id)return;TS.msg_edit.startEdit(edit_state.msg_ts,edit_state.model_ob,edit_state)},focusAndSetCursorPosition:function(input,edit_state){input.focus();TS.utility.rAF(function(){if(edit_state&&_.isFinite(edit_state.cursor_start)&&_.isFinite(edit_state.cursor_length)){TS.utility.setCursorPosition("#msg_text",edit_state.cursor_start,edit_state.cursor_length)}else{TS.utility.setCursorPosition("#msg_text",1e8)}})}});var _getMsgs=function(model_ob){return TS.model.archive_view_is_showing&&model_ob._archive_msgs?model_ob._archive_msgs:model_ob.msgs};var _getReadableMessageEditDuration=function(minutes){if(minutes==1){return"1 minute "}var time=TS.utility.date.toTimeAmount(minutes);var expiration_text="";if(time.w>=1){expiration_text+=time.w+" week"+(time.w>1?"s ":" ")}if(time.d>=1){expiration_text+=time.d+" day"+(time.d>1?"s ":" ")}if(time.h>=1){expiration_text+=time.h+" hour"+(time.h>1?"s ":" ")}if(time.mi>=1){expiration_text+=time.mi+" minute"+(time.mi>1?"s ":" ")}return expiration_text}})();(function(){"use strict";TS.registerModule("ui.fs_modal",{is_showing:false,transition_duration:250,onStart:function(){},start:function(settings){if(TS.ui.fs_modal.is_showing)return void _swap(settings);_current_settings=_.defaults({},settings,_default_settings);TS.ui.fs_modal.is_showing=true;_build();if(_current_settings.modal_class)_$div.addClass(_current_settings.modal_class);if(_current_settings.modal_bg_class)_$bg.addClass(_current_settings.modal_bg_class);if(_current_settings.modal_contents_container_class)_$div.find(".contents_container").addClass(_current_settings.modal_contents_container_class);_$div_contents=_$div.find(".contents");_$div_sidebar=_$div.find("#fs_modal_sidebar");var body_html;if(_current_settings.body_template_html){body_html=_current_settings.body_template_html;if(_current_settings.body)TS.warn("Both body and body_template_html were passed in settings to TS.ui.fs_modal.start(). Using body_template.")}else{body_html=TS.templates.fs_modal_generic_contents({settings:_current_settings,fs_modal_header:_.includes(_current_settings.modal_class,"fs_modal_header"),fs_modal_footer:_.includes(_current_settings.modal_class,"fs_modal_footer")})}_$div_contents.html(body_html);if(_current_settings.sidebar_html)_$div_sidebar.html(_current_settings.sidebar_html);_$div.on("click",".dialog_go",_go);_$div.on("click",".dialog_secondary_go",_secondaryGo);_$div.on("click",".dialog_cancel",_cancel);$(window.document).on("keydown.fs_modal",_onKeyDown);_$div_close_btn.on("click",function(){if(_current_settings.esc_for_ok){_go()}else{_cancel()}});$("html").addClass("fs_modal_active");setTimeout(function(){if(_$bg)_$bg.addClass("active");if(_$div)_$div.addClass("active")},0);if(_$div.find("input").length){_$div.find("input").first().focus()}else if(document.activeElement&&document.activeElement!==document.body){document.activeElement.blur()}if(_current_settings.onShow)_current_settings.onShow();if(_current_settings.onShowComplete){var triggered=false;var end_event=_getTransitionEndEventName();var show_complete_timer=setTimeout(function(){triggered=true;_current_settings.onShowComplete();_$div.off(end_event+".fs_modal_show_complete")},600);_$div.one(end_event+".fs_modal_show_complete",function(){if(!triggered){clearTimeout(show_complete_timer);_current_settings.onShowComplete()}})}document.activeElement.blur()},close:function(force_close){_cancel(force_close)},bindBackButton:function(callback){$("#fs_modal_back_btn").off("click.fs_modal").on("click.fs_modal",callback)},unbindBackButton:function(){$("#fs_modal_back_btn").off("click.fs_modal")},showBackButton:function(){$("#fs_modal_back_btn").removeClass("hidden")},hideBackButton:function(){$("#fs_modal_back_btn").addClass("hidden")},activate:function(){_$div.addClass("active");_$bg.addClass("active")},deactivate:function(){_$div.removeClass("active");_$bg.removeClass("active")},setHeaderTitle:function(title){if(!_$div_header.length)return;_$div_header.find("h3").text(title)},showFooter:function(){if(!_$div_footer.length)return;_$div.addClass("fs_modal_footer");_$div_footer.removeClass("hidden")},hideFooter:function(){if(!_$div_footer.length)return;_$div.removeClass("fs_modal_footer");_$div_footer.addClass("hidden")}});var _$div;var _$bg;var _$div_close_btn;var _$div_contents;var _$div_sidebar;var _$div_header;var _$div_footer;var _current_settings=null;var _default_settings={title:"",body:"",body_template_html:null,show_go_button:true,show_secondary_go_button:false,show_cancel_button:true,go_button_text:"OK",go_button_class:"",secondary_go_button_text:"OK 2",secondary_go_button_class:"",cancel_button_text:"Cancel",disable_default_controls:false,disable_esc:false,onGo:null,onSecondaryGo:null,onCancel:null,onEnd:null,esc_for_ok:false,onShow:null,enter_always_gos:false,fullscreen:false,modal_class:null,modal_bg_class:null,modal_contents_container_class:null,sidebar_html:null};var _build=function(){var template_data={settings:_current_settings,fs_modal_header:_.includes(_current_settings.modal_class,"fs_modal_header"),fs_modal_footer:_.includes(_current_settings.modal_class,"fs_modal_footer"),fs_modal_sidebar:_.includes(_current_settings.modal_class,"fs_modal_sidebar"),disable_default_controls:_current_settings.disable_default_controls};var html=TS.templates.fs_modal(template_data);$("body").append(html);_$bg=$("#fs_modal_bg");_$div=$("#fs_modal");_$div_header=$("#fs_modal_header");_$div_footer=$("#fs_modal_footer");_$div_close_btn=$("#fs_modal_close_btn")};var _go=function(){if(!TS.ui.fs_modal.is_showing){TS.error("not showing?");return}if(_current_settings.onGo){if(_current_settings.onGo()!==false){_cancel()}}else{_cancel()}};var _secondaryGo=function(e){if(!TS.ui.fs_modal.is_showing){TS.error("not showing?");return}if(_current_settings.onSecondaryGo){if(_current_settings.onSecondaryGo()!==false){_cancel()}}else{_cancel()}};var _onKeyDown=function(e){if(e.which==TS.utility.keymap.enter&&(TS.utility.getActiveElementProp("NODENAME")=="BODY"||_current_settings.enter_always_gos)){if(_current_settings.show_go_button){_go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc&&TS.utility.getActiveElementProp("NODENAME")=="BODY"){if(_current_settings.disable_esc)return;if(_current_settings.esc_for_ok){_go()}else{_cancel();if(_current_settings.clog_name){TS.clog.track(_current_settings.clog_name+"_ACTION",{action:"close_modal",trigger:"esc_key"})}}}};var _cancel=function(force_close){if(_canClose(force_close)){if(_$div)_$div.removeClass("active");if(_$bg)_$bg.removeClass("active");setTimeout(function(){$("html").removeClass("fs_modal_active")},TS.ui.fs_modal.transition_duration);if(_current_settings.onCancel)_current_settings.onCancel();_end()}};var _clean=function(){if(_$div)_$div.remove();if(_$bg)_$bg.remove();_$bg=null;_$div=null;_$div_header=null;_$div_footer=null;_$div_close_btn=null;_$div_contents=null;_$div_sidebar=null};var _end=function(){TS.ui.fs_modal.is_showing=false;setTimeout(function(){_clean()},TS.ui.fs_modal.transition_duration);$(window.document).off("keydown.fs_modal").off("resize.fs_modal");if(_current_settings.onEnd)_current_settings.onEnd()};var _swap=function(settings){_$div.removeClass("active");if(_current_settings.onCancel)_current_settings.onCancel();TS.ui.fs_modal.is_showing=false;$(window.document).off("keydown.fs_modal").off("resize.fs_modal");var $bg=_$bg.attr("id",null).addClass("fs_modal_bg");setTimeout(function(){_$div.remove();TS.ui.fs_modal.start(settings);setTimeout($bg.remove.bind($bg),TS.ui.fs_modal.transition_duration)},TS.ui.fs_modal.transition_duration)};var _getTransitionEndEventName=function(){var event_names={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",transition:"transitionend"};for(var name in event_names){if(_$div[0].style[name]!==undefined){return event_names[name]}}};var _canClose=function(force_close){if(force_close)return true;if(TS.menu.emoji.is_showing)return false;if(TS.model.menu_is_showing)return false;if(TS.model.dialog_is_showing)return false;if(TS.utility.isTabCompleteShowing())return false;return true}})();(function(){"use strict";TS.registerModule("ui.admin_invites",{invites_sent_sig:new signals.Signal,emails_parsed_sig:new signals.Signal,onStart:function(){TS.ui.admin_invites.invites_sent_sig.add(_invitesSent,TS.ui.admin_invites);TS.ui.admin_invites.emails_parsed_sig.add(_emailsParsed,TS.ui.admin_invites);TS.team.team_email_domain_changed_sig.add(_setPlaceholderEmailAddress,TS.ui.admin_invites);TS.prefs.team_auth_mode_changed_sig.add(_applySSORestrictions,TS.ui.admin_invites);TS.prefs.team_sso_auth_restrictions_changed_sig.add(_applySSORestrictions,TS.ui.admin_invites);TS.prefs.team_invites_only_admins_changed_sig.add(TS.ui.admin_invites.maybeShowInviteLink,TS.ui.admin_invites);if(TS.web)TS.web.login_sig.add(TS.ui.admin_invites.onLogin,TS.ui.admin_invites);if(TS.client)TS.client.login_sig.add(TS.ui.admin_invites.onLogin,TS.ui.admin_invites);_unprocessed_invites=TS.storage.fetchInvitesState();$("body").on("click",'[data-action="admin_invites_modal"]',function(){if(TS.isPartiallyBooted())return;var options={};if($(this).data("account-type"))options.account_type=$(this).data("account-type");_start(options)})},onLogin:function(){_setPlaceholderEmailAddress()},start:function(options){if(TS.isPartiallyBooted())return;if(_canInvite())_start(options)},switchToPicker:function(){if(_canInvite())_switchToPicker()},maybeShowInviteLink:function(){if(!TS.client)return;var show_invite_link=false;var dim_invite_link=false;if(_canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length<26){show_invite_link=true}if(_canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length>=2){dim_invite_link=true}$("#channel_list_invites_link").toggleClass("hidden",!show_invite_link).toggleClass("dim",dim_invite_link)},populateInvites:function(invites){if(!_canInvite())return;if(!invites)return;var invites_map=_unprocessed_invites.reduce(function(accumulator,invite){accumulator[invite.email]=true;return accumulator},{});invites.forEach(function(invite){if(!invites_map[invite.email]){invites_map[invite.email]=true;_unprocessed_invites.push(invite)}});TS.storage.storeInvitesState(_unprocessed_invites);if(_unprocessed_invites.length&&TS.ui.fs_modal.is_showing){_$div.find(".admin_invite_row").remove();_unprocessed_invites.forEach(function(invite){_addRow(invite)})}},canInvite:function(){return _canInvite()},test:function(){var test_ob={_error_map:_error_map,_getError:_getError};Object.defineProperty(test_ob,"_getError",{get:function(){return _getError},set:function(v){_getError=v}});Object.defineProperty(test_ob,"_error_map",{get:function(){return _error_map},set:function(v){_error_map=v}});return test_ob}});var _$div;var _row_index=0;var _queue_size=0;var _success_invites=[];var _error_invites=[];var _unprocessed_invites=[];var _placeholder_email_address_default="name@domain.com";var _placeholder_email_address=_placeholder_email_address_default;var _new_email_domains="";var _custom_message="";var _initial_channel_id;var _google_contacts_data;var _btn_connect_contacts;var _google_auth_instance_id;var _cancel_google_auth_polling;var _event_family_name="INVITEMODAL";var _clog_name=_event_family_name+"_ACTION";var _error_map={url_in_message:"Sorry, but URLs are not allowed in the custom message. Please remove it and try again!",invalid_email:"That doesn't look like a valid email address!",already_in_team:"This person is already on your team.",user_disabled:function(){return'This person is already on your team, but their account is deactivated. You can <a href="'+TS.model.team_url+'#disabled">manage</a> their account.'},already_invited:"This person has already been invited to your team.",sent_recently:"This person was recently invited. No need to invite them again just yet.",invite_failed:"Something went wrong with this invite :(",ura_limit_reached:"You've reached your team limit for Single-channel Guests. You must invite more paid team members first.",user_limit_reached:"You've reached the maximum number of users for this team.",not_allowed:"You can't invite this type of account based on your current SSO settings.",custom_message_not_allowed:"Sorry, you can't add a custom message to this invite. Please remove it and try again!",domain_mismatch:"Your SSO settings prevent you from inviting people from this email domain.",invite_limit_reached:"You've exceeded the limit on invitations. Once more people have accepted the ones youve sent, you can send more. Revoking invitations will not lift the limit. Our Help Center has <a href='https://get.slack.help/hc/en-us/articles/201330256#invitation_limits'>more details on invitation limits</a>.",too_long:"This person's name exceeds the 35-character limit.",org_user_is_disabled:"This person has a deactivated account for your organization.",org_user_is_disabled_but_present:"This person is already on your team, but they have been deactivated by your organization. Contact an organization administrator to re-enable their account",mismatch_with_pending_team_invite:function(data){var account_type;switch(data.user_type){case"ultra_restricted":account_type="Single-Channel Guest";break;case"restricted":account_type="Multi-Channel Guest";break;default:account_type="full Team Member";break}return"This person can't be invited, because they have already been invited as a "+account_type+" to your organization"},user_type_mismatch:function(data){var account_type;var message;switch(data.issue){case"org_user_is_restricted":account_type="Multi-Channel Guest";break;case"org_user_is_ultra_restricted":account_type="Single-Channel Guest";break;case"org_user_not_restricted":case"org_user_not_ultra_restricted":account_type="full Team Member";break}if(_.isUndefined(account_type)){message="This person already has an account for your organization"}else{message="This person already has a "+account_type+" account for your organization, so you can only invite them in that role."}return message}};var _start=function(options){var account_type;if(_shouldSeeAccountTypeOptions()){if(options&&options.account_type){account_type=options.account_type}}else{account_type="full"}if(options&&options.initial_channel_id){_initial_channel_id=options.initial_channel_id}var body_template_html=TS.templates.admin_invite_modal({can_add_ura:TS.model.can_add_ura,team_name:TS.model.team.name,team_in_org:TS.model.team.enterprise_id,hide_full_member_option:TS.utility.invites.hideFullMemberInviteOption(),team_signup_url:"https://"+TS.model.team.domain+".slack.com/signup",invites_limit:TS.model.team.plan===""&&TS.model.team.prefs.invites_limit,show_custom_message:TS.model.team.plan,is_paid_team:TS.model.team.plan});var settings={body_template_html:body_template_html,onShow:_onShow,onCancel:_onCancel,clog_name:"INVITEMODAL"};if(TS.client)TS.ui.a11y.saveCurrentFocus();TS.ui.fs_modal.start(settings);if(account_type){setTimeout(function(){_switchAccountType(account_type)},0)}};var _onShow=function(){var $custom_message_container;_$div=$("#admin_invites_container");_$div.find("#admin_invites_switcher").on("click",'[data-action="switch_type"]',function(e){var $el=$(e.target);if($el.is("a"))return;if($el.closest(".admin_invites_account_type_option").hasClass("disabled"))return;_switchAccountType($(this).data("account-type"))});_$div.find('[data-action="admin_invites_add_row"]').on("click",_addRow);_$div.find('a[data-action="admin_invites_switch_view"]').on("click",function(){_switchInviteView($(this).data("view"))});_$div.find('button[data-action="api_send_invites"]').on("click",function(e){e.preventDefault();_send()});_$div.find('button[data-action="api_parse_emails"]').on("click",function(e){e.preventDefault();_parseEmails();$(this).find(".ladda-label").text("Processing email addresses ...")});$custom_message_container=_$div.find(".admin_invites_custom_message_container");_setupGoogleContactsButton();_$div.find('a[data-action="admin_invites_show_custom_message"]').on("click",function(){_showCustomMessage()});_$div.find('[data-action="admin_invites_hide_custom_message"]').on("click",function(){_hideCustomMessage()}).hover(function(){$custom_message_container.addClass("delete_highlight")},function(){$custom_message_container.removeClass("delete_highlight")});_$div.find("#admin_invite_custom_message").on("input",_updateSubmitButtonBasedOnCustomMessage);_$div.find("#bulk_emails").css("overflow","hidden").autogrow();_unprocessed_invites=TS.storage.fetchInvitesState();if(_unprocessed_invites.length){TS.ui.admin_invites.populateInvites(_unprocessed_invites)}else{_addRow()}};var _onCancel=function(){_row_index=0;_queue_size=0;_unprocessed_invites=_error_invites.length?[]:_prepareInvites();_success_invites=[];_error_invites=[];_clearInitialChannelId();if(_cancel_google_auth_polling)_cancel_google_auth_polling();TS.storage.storeInvitesState(_unprocessed_invites);if(TS.client)TS.ui.a11y.restorePreviousFocus()};var _setPlaceholderEmailAddress=function(){_placeholder_email_address=_placeholder_email_address_default};var _setupGoogleContactsButton=function(){_btn_connect_contacts=document.getElementById("btn_connect_contacts");if(!_btn_connect_contacts)return;_btn_connect_contacts.addEventListener("click",_onConnectContactsClicked);_google_auth_instance_id=TS.model.user.id+Date.now();TS.google_auth.getAuthLink(_google_auth_instance_id).then(function(){TS.utility.disableElement(_btn_connect_contacts,false)})};var _onConnectContactsClicked=function(){TS.google_auth.getAuthLink(_google_auth_instance_id).then(function(url){var window_features="menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes,width=600,height=500";var window_ref=window.open(url,"auth_window",window_features);_startPollingGoogleAuth(window_ref)})};var _startPollingGoogleAuth=function(window_ref){_cancel_google_auth_polling=TS.google_auth.pollForAuthStatus(_google_auth_instance_id,_googleAuthedCallback,window_ref).cancel};var _googleAuthedCallback=function(did_auth){_cancel_google_auth_polling=null;if(did_auth){_$div.find(".btn_connect_contacts_text").text("Google contacts connected");_btn_connect_contacts.removeEventListener("click",_onConnectContactsClicked);TS.clog.track(_clog_name,{action:"google_auth_success",trigger:"user_allowed_access"});_setupFilterSelectForConnectedContacts()}};var _setupFilterSelectForConnectedContacts=function(){var opts={page:1,count:1e3};TS.google_auth.getContactList(_google_auth_instance_id,opts).then(function(data){var empty_rows=$("input.email_field").filter(function(){return!this.value});if(empty_rows.length===0)_addRow();_startFilterSelectForEmailAddresses(data)})};var _startFilterSelectForEmailAddresses=function(contact_data){if(!contact_data)return;_google_contacts_data=_google_contacts_data||contact_data.items;$("input.email_field").lazyFilterSelect({approx_item_height:50,data:_google_contacts_data,single:true,placeholder_text:"name@domain.com",onReady:function(){_upsertEmailContactsData(this)},filter:function(item,query){query=query.toLowerCase();if(item.full_name)var item_full_name=item.full_name.toLowerCase();if(item.email)var item_email=item.email.toLowerCase();return item_full_name&&item_full_name.indexOf(query)!==-1||item_email&&item_email.indexOf(query)!==-1},noResultsTemplate:function(query){return"None of your Google contacts match <strong>"+TS.utility.htmlEntities(query)+"</strong>"},onItemAdded:function(item){_upsertEmailContactsData(this,item);TS.clog.track(_clog_name,{action:"add_google_email",trigger:"select_google_contact_from_dropdown"})},onInputFocus:function(){$(".ts_tip_tip").remove();$(".lazy_filter_select").removeClass("ts_tip ts_tip_top ts_tip_float ts_tip_multiline ts_tip_delay_1000")},onInputBlur:function(){_upsertEmailContactsData(this)},template:function(item){var html=TS.templates.admin_invite_filter_select_contact({contact:item});return new Handlebars.SafeString(html)}}).addClass("hidden");if(contact_data.items!==undefined){var tooltip='<span class="ts_tip_tip"><span class="ts_tip_multiline_inner">Type here to search your Google contacts</span></span>';$("input.email_field:last").lazyFilterSelect("container").addClass("ts_tip ts_tip_top ts_tip_float ts_tip_multiline ts_tip_delay_1000").append(tooltip)}};var _upsertEmailContactsData=function(elem,item){var current_invite_email=elem.$container[0];var current_invite_row=$(current_invite_email).parents(".admin_invite_row");if(item){$(current_invite_row).find("input[name*=first_name]").val(item.given_name);$(current_invite_row).find("input[name*=last_name]").val(item.family_name);$(current_invite_row).find("input[name*=email_address]").val(item.email)}else{var custom_input_email=$(current_invite_row).find("input.lfs_input").val();var existing_email=$(current_invite_row).find("input[name*=email_address]").val();if(custom_input_email){$(current_invite_row).find("input.email_field").lazyFilterSelect("clearValue");$(current_invite_row).find("input[name*=email_address]").val(custom_input_email)}else if(existing_email){$(current_invite_row).find("input.lfs_input").val(existing_email)}}};var _addRow=function(email){var show_delete_btn=true;if(_$div.find(".admin_invite_row").length===0){show_delete_btn=false}else{_$div.find(".admin_invite_row").first().find(".delete_row").removeClass("hidden")}_$div.find("#invite_rows").append(TS.templates.admin_invite_row({index:_row_index,show_delete_btn:show_delete_btn,placeholder_email_address:_placeholder_email_address}));var $row=_$div.find("#invite_"+_row_index);$row.find('[data-action="admin_invites_delete_row"]').on("click",function(){_removeRow($row)}).hover(function(){$row.addClass("delete_highlight")},function(){$row.removeClass("delete_highlight")});$row.find('[name="email_address"]').focus();if(email){$row.find('[name="email_address"]').val(email.email);$row.find(".lfs_input_container input.lfs_input").val(email.email);if(TS.boot_data.feature_name_tagging_client){$row.find('[name="full_name"]').val(email.full_name)}else{$row.find('[name="first_name"]').val(email.first_name);$row.find('[name="last_name"]').val(email.last_name)}}_updateSendButtonLabel();if(TS.google_auth.isAuthed(_google_auth_instance_id)&&_google_contacts_data){_startFilterSelectForEmailAddresses(_google_contacts_data)}_row_index++};var _showInfoMessage=function(message_class,html){_$div.find("#invite_notice").toggleClass("alert_warning",message_class==="alert_warning").toggleClass("alert_info",message_class==="alert_info").toggleClass("alert_error",message_class==="alert_error").html(html).slideDown(100)};var _showCustomMessage=function(){_$div.find(".admin_invites_hide_custom_message").addClass("hidden");_$div.find(".admin_invites_show_custom_message").removeClass("hidden");_updateSubmitButtonBasedOnCustomMessage()};var _hideCustomMessage=function(){_$div.find(".admin_invites_hide_custom_message").removeClass("hidden");_$div.find(".admin_invites_show_custom_message").addClass("hidden");_updateSubmitButtonBasedOnCustomMessage()};var _updateSubmitButtonBasedOnCustomMessage=function(){var custom_message=_$div.find("#admin_invite_custom_message").val().trim();var $show_custom_message=_$div.find(".admin_invites_show_custom_message");var disable_submit_btn=!!TS.utility.findUrls(custom_message).length&&!$show_custom_message.hasClass("hidden");_shouldDisableSubmitButton(disable_submit_btn)};var _shouldDisableSubmitButton=function(should_disable){_$div.find("#admin_invites_submit_btn").toggleClass("disabled",should_disable)};var _removeRow=function($row){if(!$row||!$row.length)return;$row.slideToggle(100,function(){$row.remove();var row_count=$(".admin_invite_row").length;if(row_count===0){_addRow()}else if(row_count===1){_$div.find(".admin_invite_row").first().find(".delete_row").addClass("hidden")}_updateSendButtonLabel()})};var _updateSendButtonLabel=function(){var invite_count=$(".admin_invite_row").length;var label="Invite "+invite_count+" ";var account_type=$("#account_type").val();if(account_type=="full"){if(invite_count===1){label+="Person"}else{label+="People"}}else if(account_type=="restricted"){label+=TS.templates.builders.raLabel("Restricted Account");if(invite_count>1)label+="s"}else if(account_type=="ultra_restricted"){label+="Single-Channel Guest";if(invite_count>1)label+="s";if($("#ultra_restricted_channel_picker").val()){label+=" to "+$("#ultra_restricted_channel_picker")[0].options[$("#ultra_restricted_channel_picker")[0].selectedIndex].text}}_$div.find('button[data-action="api_send_invites"]').find(".ladda-label").text(label)};var _clearInitialChannelId=function(){_initial_channel_id=undefined};var _applySSORestrictions=function(){var invite_type=_$div.find("#account_type").val();var show_google_auth_email_domain_notice=false;var has_sso_auth_mode=TS.model.team.prefs.auth_mode==="google"||TS.model.team.prefs.auth_mode==="saml";var show_sso_signup_notice=false;var team_in_enterprise_org=TS.boot_data.page_needs_enterprise;var sso_signup_notice_msg="";if(team_in_enterprise_org&&invite_type==="full"||has_sso_auth_mode&&TS.model.team.prefs.sso_auth_restrictions===0){show_sso_signup_notice=true;sso_signup_notice_msg="Only people with "+TS.utility.enterprise.getProviderLabel(TS.model.enterprise,_.get(TS.model,"enterprise.sso_provider.label","single sign-on"))+" accounts will be able to accept invitations."}if(TS.model.team.prefs.auth_mode=="google"){if(invite_type=="full"&&(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1)){show_google_auth_email_domain_notice=true}else if((invite_type=="restricted"||invite_type=="ultra_restricted")&&TS.model.team.prefs.sso_auth_restrictions===0){show_google_auth_email_domain_notice=true}}else if(TS.model.team.prefs.auth_mode=="saml"){if(TS.model.team.prefs.sso_auth_restrictions===0||TS.model.team.prefs.sso_auth_restrictions===1){if(invite_type=="full"){if(!team_in_enterprise_org){var admin_invites_switcher_html=TS.templates.admin_invite_switcher({can_add_ura:TS.model.can_add_ura,hide_full_member_option:TS.utility.invites.hideFullMemberInviteOption(),team_signup_url:"https://"+TS.model.team.domain+".slack.com/signup",team_in_org:TS.model.team.enterprise_id});$("#admin_invites_switcher").html(admin_invites_switcher_html);_switchToPicker()}}}}$("#google_auth_email_domain_notice").toggleClass("hidden",!show_google_auth_email_domain_notice);$("#sso_signup_notice").html(sso_signup_notice_msg).toggleClass("hidden",!show_sso_signup_notice)};var _selectRow=function(email){var $row;_$div.find('input[name="email_address"]').each(function(){if($(this).val()==email){$row=$(this).closest(".admin_invite_row")}});return $row};var _rowError=function($row,error){var error_msg=_getError(error);if($row){$row.find("label.email").addClass("error").end().find(".error_msg").removeClass("hidden").html(error_msg);if(error=="too_long")$row.find("label").addClass("error")}};var _rowValid=function($row){if($row){$row.find("label.email").removeClass("error").end().find(".error_msg").addClass("hidden")}};var _resetIndividualForm=function(){setTimeout(function(){Ladda.stopAll();_$div.find(".admin_invite_row").remove();_success_invites=[];_error_invites=[];_updateSendButtonLabel();_addRow()},0)};var _resetBulkForm=function(){setTimeout(function(){Ladda.stopAll();_$div.find('button[data-action="api_parse_emails"]').find(".ladda-label").text("Add Invitees");_$div.find("#bulk_emails").prop("disabled",false)},0)};var _switchToPicker=function(){_$div.find("#admin_invites_header").find(".admin_invites_header_type").removeClass("normal").text("people").end().find(".admin_invites_header_team_name").removeClass("hidden");_$div.find("#admin_invites_switcher").removeClass("hidden");_$div.find("#admin_invites_workflow").addClass("hidden");TS.ui.fs_modal.hideBackButton()};var _switchInviteView=function(view){if(view=="individual"){_$div.find("#individual_invites").removeClass("hidden");_$div.find("#bulk_invites, #bulk_notice").addClass("hidden");_$div.find("#bulk_emails").val("");_$div.find(".email_field").first().focus();_$div.find(".invite_modal_options_container").removeClass("hidden");_resetBulkForm()}else if(view=="bulk"){_$div.find("#bulk_invites").removeClass("hidden");_$div.find("#individual_invites").addClass("hidden");_$div.find(".invite_modal_options_container").addClass("hidden");var $bulk_submit_btn=_$div.find('button[data-action="api_parse_emails"]');if(!$bulk_submit_btn.hasClass("ladda")){Ladda.bind('button[data-action="api_parse_emails"]');$bulk_submit_btn.addClass("ladda")}$bulk_submit_btn.find(".ladda-label").text("Add Invitees");var invites=_prepareInvites();if(invites){var invites_bulk="";$.each(invites,function(index,invite){if(invite.first_name)invites_bulk+=invite.first_name+" ";if(invite.last_name)invites_bulk+=invite.last_name+" ";invites_bulk+="<"+invite.email+">, "});_$div.find("#bulk_emails").val(invites_bulk).autogrow()}_$div.find("#bulk_emails").focus()}};var _switchAccountType=function(invite_type){var channels=TS.channels.getUnarchivedChannelsForUser();TS.boot_data.default_channels.forEach(function(default_channel){channels.forEach(function(channel){if(channel.id==default_channel.id){channel.is_default=true}})});var general_channel=TS.channels.getGeneralChannel();var general_channel_name="";if(general_channel){general_channel_name=general_channel.name}var template_args={invite_type:invite_type,channels:channels,default_channels:TS.boot_data.default_channels,general_name:general_channel_name,groups:TS.groups.getUnarchivedGroups(),email_domains:TS.model.team.email_domain.split(","),is_admin:TS.model.user.is_admin,initial_channel_id:_initial_channel_id};var channel_picker_html=TS.templates.admin_invite_channel_picker(template_args);var invite_type_label="Full Members";if(invite_type=="restricted"){invite_type_label=TS.templates.builders.raLabel("Restricted Accounts")}else if(invite_type=="ultra_restricted"){invite_type_label="Single-Channel Guests"}_$div.find("#admin_invites_header").find(".admin_invites_header_type").addClass("normal").text(invite_type_label).end().find(".admin_invites_header_team_name").addClass("hidden");_$div.find("#admin_invites_channel_picker_container").html(channel_picker_html);_$div.find("#account_type").val(invite_type);_$div.find("#admin_invites_switcher, #admin_invites_workflow").toggleClass("hidden");
_$div.find("#admin_invites_billing_notice").toggleClass("hidden",!(TS.model.team.plan!==""&&invite_type!="ultra_restricted"));_$div.find("#ura_warning").toggleClass("hidden",invite_type!="restricted"&&invite_type!="ultra_restricted");_$div.find("#invite_notice").hide();_$div.find("#ultra_restricted_channel_picker").on("change",function(){_updateSendButtonLabel();_clearInitialChannelId()});_$div.find(".email_field").first().focus();var $submit_btn=_$div.find('button[data-action="api_send_invites"]');if(!$submit_btn.hasClass("ladda")){Ladda.bind('button[data-action="api_send_invites"]');$submit_btn.addClass("ladda")}_updateSendButtonLabel();_applySSORestrictions();_$div.find("#defaultchannelsmulti, #ultra_restricted_channel_picker").lazyFilterSelect({onItemRemoved:function(item){if(item.value==_initial_channel_id){_clearInitialChannelId()}}}).addClass("hidden");if(_shouldSeeAccountTypeOptions()){TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker);TS.ui.fs_modal.showBackButton()}};var _prepareInvites=function(){var invites=[];var email;_$div.find(".admin_invite_row").each(function(){email=$.trim($(this).find('[name="email_address"]').val());if(TS.boot_data.feature_name_tagging_client){var full_name=$.trim($(this).find('[name="full_name"]').val())}else{var first_name=$.trim($(this).find('[name="first_name"]').val());var last_name=$.trim($(this).find('[name="last_name"]').val())}if(email){var invite={};invite.email=email;if(TS.boot_data.feature_name_tagging_client&&full_name)invite.full_name=full_name;if(first_name)invite.first_name=first_name;if(last_name)invite.last_name=last_name;invites.push(invite)}else{if($(".admin_invite_row").length>1){_removeRow($(this))}}});_unprocessed_invites=invites;TS.storage.storeInvitesState(_unprocessed_invites);return invites};var _send=function(){var validation_error=false;_$div.find(".admin_invite_row").each(function(){var email=$.trim($(this).find('[name="email_address"]').val());if(email){if(!TS.utility.email_regex.test(email)){_rowError($(this),"invalid_email");validation_error=true}else{_rowValid($(this))}}else{if($(".admin_invite_row").length>1){_removeRow($(this))}}});if(validation_error){setTimeout(Ladda.stopAll,0);return}var invites=_prepareInvites();if(!invites.length){var message_html='<i class="ts_icon ts_icon_info_circle"></i> Add at least one email address before sending invitations.';_showInfoMessage("alert_info",message_html);setTimeout(Ladda.stopAll,0)}else if(invites){var account_type=_$div.find("#account_type").val();var $show_custom_message=_$div.find(".admin_invites_show_custom_message");var $custom_message=_$div.find("#admin_invite_custom_message");var channels;var invite_mode=TS.google_auth.isAuthed(_google_auth_instance_id)?"contact":"manual";if(account_type=="full"||account_type=="restricted"){var default_channels=_$div.find("#defaultchannelsmulti").val();if(default_channels)channels=default_channels.join(",")}else if(account_type=="ultra_restricted"){channels=_$div.find("#ultra_restricted_channel_picker").val()}if(!$show_custom_message.hasClass("hidden")){_custom_message=$custom_message.val()}else{_custom_message=""}_queue_size=invites.length;$.each(invites,function(index,invite){var args={email:invite.email,source:"invite_modal",mode:invite_mode};if(channels)args.channels=channels;if(_custom_message)args.extra_message=_custom_message;if(invite.full_name)args.full_name=invite.full_name;if(invite.first_name)args.first_name=invite.first_name;if(invite.last_name)args.last_name=invite.last_name;if(account_type=="restricted"){args.restricted=1}else if(account_type=="ultra_restricted"){args.ultra_restricted=1}TS.api.call("users.admin.invite",args,_onInviteSent)})}};var _onInviteSent=function(ok,data,args){if(ok){_success_invites.push({email:args.email,full_name:args.full_name,first_name:args.first_name,last_name:args.last_name});var $row=_selectRow(args.email);_removeRow($row)}else{if(data.error=="requires_channel"){setTimeout(Ladda.stopAll,0);_$div.find("#ra_channel_picker_header").highlightText();var message_html='<i class="ts_icon ts_icon_info_circle"></i> Pick at least one channel before inviting '+TS.templates.builders.raLabel("Restricted Accounts")+".";_showInfoMessage("alert_warning",message_html);return}else if(data.error=="requires_one_channel"){setTimeout(Ladda.stopAll,0);_$div.find("#ura_channel_picker_header").highlightText();var message_html='<i class="ts_icon ts_icon_info_circle"></i> Pick a channel before inviting Single-Channel Guests.';_showInfoMessage("alert_warning",message_html);return}else{var invitation_error=data.error;if(TS.boot_data.page_needs_enterprise){var member_belongs_to_team=TS.members.getMemberByEmail(args.email)!==null;if(member_belongs_to_team&&invitation_error==="org_user_is_disabled"){invitation_error="org_user_is_disabled_but_present"}}_error_invites.push({email:args.email,error:invitation_error,error_msg:_getError(_.extend({},data,{error:invitation_error}))})}}_decrementInviteQueue()};var _decrementInviteQueue=function(){_queue_size--;if(_queue_size===0){_unprocessed_invites=[];TS.storage.storeInvitesState(_unprocessed_invites);var done=function(){setTimeout(Ladda.stopAll,0);TS.ui.admin_invites.invites_sent_sig.dispatch()};_new_email_domains=_collectNewDomains(_success_invites);if(_new_email_domains){TS.api.call("team.checkEmailDomains",{email_domains:_new_email_domains}).then(function(response){if(response.data.ok){_new_email_domains=response.data.email_domains}else{_new_email_domains=""}},function(response){_new_email_domains=""}).finally(done)}else{done()}}};var _invitesSent=function(){var account_type=$("#account_type").val();var success_invites_html;var plural_str=_success_invites.length>1?"s":"";if(account_type=="full"){success_invites_html="<strong>"+_success_invites.length+" Full Member"+plural_str+"</strong>"}else if(account_type=="restricted"){success_invites_html="<strong>"+_success_invites.length+" "+TS.templates.builders.raLabel("Restricted Account")+plural_str+"</strong>"}else if(account_type=="ultra_restricted"){success_invites_html="<strong>"+_success_invites.length+" Single-Channel Guest"+plural_str+"</strong>"}var api_args={success_invites_html:success_invites_html,success_invites:_success_invites,error_invites:_error_invites,team_name:TS.model.team.name,domains:_new_email_domains,paid_team:""!==TS.model.team.plan,is_admin:TS.model.user.is_admin};if(TS.model.team.plan){api_args["custom_message"]=_custom_message}var html=TS.templates.admin_invite_summary(api_args);_$div.find("#invite_notice").slideUp(100);_$div.find("#admin_invites_workflow, #admin_invites_header").addClass("hidden");_$div.find("#admin_invites_success").html(html).removeClass("hidden");function resetAndSwitchToIndividualForm(){_resetIndividualForm();$("#admin_invites_workflow, #admin_invites_success").toggleClass("hidden");$("#admin_invites_header").removeClass("hidden");TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker)}_$div.find('button[data-action="admin_invites_reset"]').on("click",resetAndSwitchToIndividualForm);TS.ui.fs_modal.bindBackButton(resetAndSwitchToIndividualForm);_$div.find('button[data-action="admin_invites_try_again"]').on("click",function(){$.each(_error_invites,function(index,invite){var $row=_selectRow(invite.email);_rowError($row,invite.error)});$("#admin_invites_workflow, #admin_invites_success").toggleClass("hidden");$("#admin_invites_header").removeClass("hidden");TS.ui.fs_modal.bindBackButton(TS.ui.admin_invites.switchToPicker);_success_invites=[];_error_invites=[]});if(_canSaveDomains()){var $btn=_$div.find('button[data-action="add_signup_domains"]').on("click",_saveDomains);_$div.on("keyup","#invite_signup_domains",TS.ui.resetButtonSpinner.bind(Object.create(null),$btn.get(0)))}};var _parseEmails=function(){var emails=$.trim($("#bulk_emails").val().replace(/[\u200B-\u200D\uFEFF]/g,""));_$div.find("#bulk_emails").prop("disabled",true);TS.api.call("users.admin.parseEmails",{emails:emails},_onEmailsParsed)};var _onEmailsParsed=function(ok,data,args){if(!ok){TS.error("failed onEmailsParsed");_$div.find("#bulk_notice").html('<i class="ts_icon ts_icon_warning"></i> Oops! There was an error processing those emails. Please try again.').removeClass("hidden");_resetBulkForm();return}if(data.emails.length===0){_$div.find("#bulk_notice").html('<i class="ts_icon ts_icon_warning"></i> We couldn\'t find any email addresses in that text. Please try again.').removeClass("hidden");_resetBulkForm();return}TS.ui.admin_invites.emails_parsed_sig.dispatch(data.emails)};var _emailsParsed=function(emails){_$div.find(".admin_invite_row").remove();_switchInviteView("individual");var message_html;if(emails.length==1){message_html='<i class="ts_icon ts_icon_check_circle_o_large"></i> We found 1 email address to invite. We\'ve done our best to guess a name. See if it looks right, then press Invite.'}else{message_html='<i class="ts_icon ts_icon_check_circle_o_large"></i> We found '+emails.length+" email addresses to invite. We've done our best to guess a name for each one. See if everything looks right, then press Invite."}_showInfoMessage("alert_info",message_html);_$div.find(".admin_invite_row").each(function(){var email=$.trim($(this).find('[name="email_address"]').val());if(!email)_removeRow($(this))});$.each(emails,function(index,email){_addRow(email)});_unprocessed_invites=emails;TS.storage.storeInvitesState(_unprocessed_invites)};var _canSaveDomains=function(){var account_type=$("#account_type").val();return account_type=="full"&&TS.model.user.is_owner&&TS.model.team.prefs.auth_mode=="normal"};var _collectNewDomains=function(invites){if(!_canSaveDomains())return"";var domains=invites.map(function(invite){return invite.email.split("@")[1]});if(TS.model.team.email_domain){var map=TS.model.team.email_domain.split(",").reduce(function(accumulator,domain){accumulator[domain]=true;return accumulator},{});domains=_.uniq(domains.filter(function(domain){return!map[domain]}))}return domains.join(", ")};var _deduplicateDomains=function(domains){if(!domains)return domains;var map=domains.split(",").reduce(function(accumulator,domain){accumulator[domain]=true;return accumulator},{});return Object.keys(map).join(",")};var _saveDomains=function(e){TS.ui.startButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0));var domains=_$div.find("#invite_signup_domains").val();if(TS.model.team.email_domain)domains=[TS.model.team.email_domain,domains].join(",");domains=_deduplicateDomains(domains);var args={prefs:JSON.stringify({signup_mode:"email",signup_domains:domains})};TS.api.call("team.prefs.set",args).then(function(response){TS.ui.stopButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0),true);TS.model.team.email_domain=response.data.prefs.signup_domains},function(response){TS.ui.stopButtonSpinner(_$div.find('button[data-action="add_signup_domains"]').get(0),false);var msg="Sorry! Something went wrong. Please try again.";if(response.data.error==="signup_domains_missing"){msg="Please enter a domain"}else if(response.data.error==="bad_domain"){msg="Sorry! You can't use "+response.data.domain+"."}else if(response.data.error==="invalid_domain"){msg="Hmm, this doesn't look like a domain! Check for typos?"}else if(response.data.error==="too_many_domains"){msg="Sorry! Youve entered too many domains."}$("#invite_signup_domains").focus().tooltip({title:msg,trigger:"manual"}).tooltip("show").on("blur",function(){$(this).tooltip("destroy")})})};var _canNonAdminInvite=function(){return!TS.model.team.prefs.invites_only_admins&&!TS.model.user.is_restricted};var _canInvite=function(){return TS.model.user.is_admin||_canNonAdminInvite()};var _shouldSeeAccountTypeOptions=function(){return TS.model.user.is_admin&&TS.model.team.plan!==""};var _getError=function(data){if(!data||!data.error||!_error_map[data.error])return"";var error_msg=_error_map[data.error];return _.isFunction(error_msg)?error_msg(data):error_msg}})();(function(){"use strict";TS.registerModule("ui.admin_edit_team_profile",{onStart:function(){$("body").on("click",'[data-action="edit_team_profile_modal"]',TS.ui.admin_edit_team_profile.start)},start:function(){if(_userCanEditTeamProfile())_start()}});var _$div;var _$body;var _active_section_id;var _back_stack=[];var _start=function(){var settings={body_template_html:TS.templates.admin_edit_team_profile_modal(),onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#edit_team_profile_container");_$body=$("body");_$div.on("click",'[data-action="edit_team_profile_to_custom"]',_switchToCustom);_$div.on("click",'[data-action="edit_team_profile_to_add"]',_switchToAdd);_$div.on("click",'[data-action="edit_team_profile_to_edit"]',_switchToEdit);_$div.on("click",'[data-action="edit_team_profile_to_hide"]',_switchToHide);_$div.on("click",'[data-action="edit_team_profile_to_delete"]',_switchToDelete);_$div.on("click",'[data-action="edit_team_profile_cancel"]',_switchToList);_$div.on("click",'[data-action="edit_team_profile_confirm_edit"]',_editField);_$div.on("click",'[data-action="edit_team_profile_confirm_hide"]',_hideField);_$div.on("click",'[data-action="edit_team_profile_confirm_delete"]',_deleteField);_$div.on("click",'[data-action="edit_team_profile_remove_option"]',_removeOption);_$div.on("click",'[data-action="edit_team_profile_add_option"]',_addOption);_$div.on("focusin",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_decoratePreview);_$div.on("focusout",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_undecoratePreview);_$div.on("input",'[data-action="edit_team_profile_update_preview_label"], [data-action="edit_team_profile_update_preview_hint"], .option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]',_updatePreviewValue);_$div.on("click",'[data-action="edit_team_profile_list_menu"]',_openListMenu);_$div.on("input","input",_toggleSave);_$body.on("keydown.admin_submit",_onKeydown);_ensureProfile().then(_switchToList).catch(TS.error)};var _onCancel=function(){_updateBackButton(true);_$div=null;_back_stack=[];_active_section_id=null;_$body.off("keydown.admin_submit");_$body=null;if(TS.web&&TS.web.account_profile)TS.web.account_profile.render();if(TS.web&&TS.web.members)TS.web.members.render()};var _onKeydown=function(e){if(e.which==TS.utility.keymap.enter){$(_active_section_id).find('button[type="submit"]').trigger("click");return false}};var _ensureProfile=function(){return TS.team.ensureTeamProfileFields()};var _apiCall=function(method,calling_args){if(!method)return;return TS.api.call(method,calling_args).then(function(response){if(TS.web){if(method==="team.profile.delete"){TS.team.upsertTeam({profile:JSON.parse(calling_args.profile)})}else{TS.team.upsertTeam(response.data)}}return Promise.resolve(response)},function(error){return Promise.reject(error)})};var _deleteField=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;_saveProfile("team.profile.delete",[id]).then(function(){_switchToList()},_.noop)};var _hideField=function(e){_hideOrShowField(e,true)};var _showField=function(e){_hideOrShowField(e,false)};var _hideOrShowField=function(e,hide){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;field=$.extend({},field);field.is_hidden=hide;if(hide)field.ordering=_makeOrdering();_saveProfile("team.profile.set",[field]).then(function(){_switchToList();_highlightInList(id)},_.noop)};var _editField=function(e){var $edit=_$div.find("#edit_team_profile_edit");if(!TS.ui.validation.validate($edit,{quiet:true,fast:true})){TS.ui.validation.validate($edit);Ladda.stopAll();$("#edit_team_profile_confirm_edit_btn").addClass("disabled");return}var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id], [data-type]");id=$el.data("id");var $label=_$div.find('input[name="label"]');var $hint=_$div.find('input[name="hint"]');var field=TS.team.getTeamProfileFieldById(id)||{};var copy=JSON.stringify(field);field=$.extend({},field);field.type=field.type||$el.data("type")||"text";field.label=$label.val().trim();field.hint=$hint.val().trim();field.ordering=field.ordering!==undefined?field.ordering:_makeOrdering();if(field.type==="options_list"){field.possible_values=_$div.find('input[name^="option_"]').map(function(){return $(this).val().trim()}).toArray()}function resolve(){_switchToList();_highlightInList(id)}if(JSON.stringify(field)==copy){resolve();Ladda.stopAll()}else{_saveProfile("team.profile.set",[field]).then(resolve,_.noop)}};var _saveProfile=function(method,fields){fields=fields&&fields.length?fields:TS.model.team.profile.fields;var calling_args={profile:JSON.stringify({fields:fields})};return _apiCall(method,calling_args).catch(function(error){if(error.data.error==="no_perms"||error.data.error==="missing_scope"){TS.generic_dialog.start({body:"Sorry! An owner on your team has restricted who can customize your team's profile.",show_cancel_button:false,esc_for_ok:true,fullscreen:false,onEnd:TS.ui.fs_modal.close})}else{TS.error("Failed to customize profile: "+error.data.error);return TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.")}}).finally(Ladda.stopAll)};var _switchToList=function(){_back_stack.length=0;_back_stack.push({back:_switchToList});var template_args={};template_args.team_profile_fields=_getVisibleTeamProfileFields();template_args.hidden_team_profile_fields=_getHiddenTeamProfileFields();template_args.default_team_profile_fields=_getDefaultTeamProfileFields();var html=TS.templates.admin_edit_team_profile_list(template_args);_$div.find("#edit_team_profile_header").text("Customize profile").removeClass("hidden center_and_narrow");var note;if(TS.model.team.profile&&TS.model.team.profile.fields.length>=50){note='<div class="alert alert_info"><i class="ts_icon ts_icon_info_circle"></i> You have reached the maximum number of fields that can be added to profiles.</div>'}else{note="Expand your team's profiles by adding additional fields below"}_$div.find("#edit_team_profile_value_note").html(note).removeClass("hidden center_and_narrow");_$div.find("#edit_team_profile_list").html(html);_hideAllSectionsBut("#edit_team_profile_list");_enableDragAndDrop();_unflexContentsAndCenter();_updateBackButton(true)};var _switchToAdd=function(){_back_stack.push({back:_switchToAdd});var template_args={};template_args.default_team_profile_fields=_getDefaultTeamProfileFields();var html=TS.templates.admin_edit_team_profile_add(template_args);_$div.find("#edit_team_profile_header").text("Select a field type").removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").addClass("hidden");_$div.find("#edit_team_profile_add").html(html);_hideAllSectionsBut("#edit_team_profile_add");_unflexContentsAndCenter();_updateBackButton()};var _switchToCustom=function(){_back_stack.push({back:_switchToCustom});var html=TS.templates.admin_edit_team_profile_custom();_$div.find("#edit_team_profile_header").text("Create a new field").removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").text("Which type of field would you like to create?").removeClass("hidden center_and_narrow");_$div.find("#edit_team_profile_custom").html(html);_hideAllSectionsBut("#edit_team_profile_custom");_unflexContentsAndCenter();_updateBackButton();_makePeoplePicker()};var _switchToEdit=function(e){var $el=$(e.target);if($el.hasClass("ts_icon_grabby_patty"))return false;var id=$el.data("id");if(!id)$el=$el.closest("[data-id], [data-type]");id=$el.data("id");var template_args={};var header_text;if(!id){template_args.type=$el.data("type");template_args.label=$el.data("label");header_text="Customize profile field"}else{template_args=TS.team.getTeamProfileFieldById(id);if(!template_args)return;header_text="Edit profile field"}e.stopPropagation();_back_stack.push({back:_switchToEdit,event:e});var html=TS.templates.admin_edit_team_profile_edit(template_args);_$div.find("#edit_team_profile_header").text(header_text).removeClass("center_and_narrow");_$div.find("#edit_team_profile_value_note").addClass("hidden");_$div.find("#edit_team_profile_edit").html(html);_hideAllSectionsBut("#edit_team_profile_edit");_maybeShowOptionRemoveAction();_maybeUpdateOptionPreviewValue();_makePeoplePicker();Ladda.bind("#edit_team_profile_confirm_edit_btn");_unflexContentsAndCenter();_updateBackButton();_toggleSave()};var _switchToHide=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;e.stopPropagation();_back_stack.push({back:_switchToHide,event:e});var html=TS.templates.admin_edit_team_profile_hide(field);var header_text='Disable "'+field.label+'"';_$div.find("#edit_team_profile_header").text(header_text).addClass("center_and_narrow");var note="All data entered for this field will no longer be visible on your team's profiles. You can re-enable it later.";_$div.find("#edit_team_profile_value_note").text(note).addClass("center_and_narrow").removeClass("hidden");_$div.find("#edit_team_profile_hide").html(html);_hideAllSectionsBut("#edit_team_profile_hide");Ladda.bind("#edit_team_profile_confirm_hide_btn");_flexContentsAndCenter();_updateBackButton()};var _switchToDelete=function(e){var $el=$(e.target);var id=$el.data("id");if(!id)$el=$el.closest("[data-id]");id=$el.data("id");if(!id)return;var field=TS.team.getTeamProfileFieldById(id);if(!field)return;e.stopPropagation();_back_stack.push({back:_switchToDelete,event:e});var html=TS.templates.admin_edit_team_profile_delete(field);var header_text='Delete "'+field.label+'"';_$div.find("#edit_team_profile_header").text(header_text).addClass("center_and_narrow");var note="<strong>Are you sure?</strong> All data associated with this field will be permanently deleted. This <strong>cannot be undone</strong>.";_$div.find("#edit_team_profile_value_note").html(note).addClass("center_and_narrow").removeClass("hidden");_$div.find("#edit_team_profile_delete").html(html);_hideAllSectionsBut("#edit_team_profile_delete");Ladda.bind("#edit_team_profile_confirm_delete_btn");_flexContentsAndCenter();_updateBackButton()};var _flexContentsAndCenter=function(){_$div.closest(".contents").addClass("display_flex flex_direction_column").css("height","70vh");_$div.css({margin:"auto 0",height:"auto","padding-top":0})};var _unflexContentsAndCenter=function(){_$div.closest(".contents").removeClass("display_flex flex_direction_column").css("height","");_$div.css({margin:"",height:"","padding-top":""})};var _userCanEditTeamProfile=function(){if(!(TS.model.team&&TS.model.team.plan))return false;var user=TS.model.user;if(!user)return false;if(TS.model.team.prefs.who_can_change_team_profile==="admin")return user.is_admin;if(TS.model.team.prefs.who_can_change_team_profile==="owner")return user.is_owner;return true};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(function(){_back_stack.pop();var go_back=_back_stack.pop();go_back.back(go_back.event)});TS.ui.fs_modal.showBackButton()}};var _maybeShowOptionRemoveAction=function(){var options=_$div.find(".option_row");if(options.length>=3)return void options.addClass("show_remove_action");options.removeClass("show_remove_action")};var _maybeUpdateOptionPreviewValue=function(){_updatePreviewValue({target:_$div.find('.option_header_row + .option_row [data-action="edit_team_profile_update_preview_option"]')})};var _removeOption=function(e){$(e.target).closest(".row.option_row").remove();_toggleSave();_maybeShowOptionRemoveAction();_maybeUpdateOptionPreviewValue();_maybeUpdateAddOptionAction()};var _addOption=function(e){var row=TS.templates.admin_edit_team_profile_option_row({index:_$div.find(".row.option_row").length});_$div.find("#option_rows").append(row).find(".row.option_row").last().find("input").focus();_toggleSave();_maybeShowOptionRemoveAction();_maybeUpdateAddOptionAction()};var _maybeUpdateAddOptionAction=function(){if(_$div.find(".row.option_row").length===50){_$div.find('[data-action="edit_team_profile_add_option"]').addClass("hidden").next().removeClass("hidden")}else{_$div.find('[data-action="edit_team_profile_add_option"]').removeClass("hidden").next().addClass("hidden")}};var _updatePreviewValue=function(e){var $el=$(e.target);var value=$el.val();if(value)value=value.trim();if(value!==undefined&&!value.length)value=$el.data("default");_$div.find('.profile_field_preview [data-id="'+$el.data("target")+'"]').text(value)};var _decoratePreview=function(e){var $el=_$div.find('.profile_field_preview [data-id="'+$(e.target).data("target")+'"]');var $select=$el.closest("select");if($select.length)$el=$select;$el.addClass("highlight_yellow_bg")};var _undecoratePreview=function(e){var $el=_$div.find('.profile_field_preview [data-id="'+$(e.target).data("target")+'"]');var $select=$el.closest("select");if($select.length)$el=$select;$el.removeClass("highlight_yellow_bg")};var _makePeoplePicker=function(){var lazy_filter_select=_$div.find(".edit_team_profile_lazy_filter_select");if(!lazy_filter_select.length)return;var options={append:true,classes:"normal_style disabled",preselected_ids:[TS.members.getMemberByName("slackbot").id]};TS.ui.people_picker.make(lazy_filter_select,options)};var _enableDragAndDrop=function(){_$div.find("#edit_team_profile_list_drag_and_drop_area").sortable({items:".visible_row[data-id]",handle:".ts_icon_grabby_patty",forcePlaceholderSize:true}).on("sortupdate",function(e,ui){e.stopPropagation();var dirty=[];$(this).find(".row[data-id]").each(function(index){var field=TS.team.getTeamProfileFieldById($(this).data("id"));if(field&&field.ordering!=index){field.ordering=index;dirty.push({id:field.id,ordering:index})}});TS.team.sortTeamProfileFieldsByOrdering();_saveProfile("team.profile.reorder",dirty)})};var _makeOrdering=function(){if(!TS.model.team.profile.fields.length)return 0;return _.max(TS.model.team.profile.fields.map(function(field){return field.ordering}))+1};var _openListMenu=function(e){e.stopPropagation();var real_target=$(e.target).closest("[data-id]").get(0);var menu_event=jQuery.Event("click",{target:real_target,currentTarget:real_target});TS.menu.startWithEditTeamProfileListActions(menu_event,_onListMenuClick)};var _onListMenuClick=function(e){e.preventDefault();var $id=$(e.target).closest("[data-id]");if($id.is('[data-action="edit_team_profile_to_show"]')){_showField(e)}else if($id.is('[data-action="edit_team_profile_to_hide"]')){_switchToHide(e)}else if($id.is('[data-action="edit_team_profile_to_delete"]')){_switchToDelete(e)}TS.menu.end()};var _hideAllSectionsBut=function(id){var sections=["#edit_team_profile_loading","#edit_team_profile_list","#edit_team_profile_add","#edit_team_profile_custom","#edit_team_profile_edit","#edit_team_profile_hide","#edit_team_profile_delete"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden");_active_section_id=id};var _getVisibleTeamProfileFields=function(){var fields=TS.team.getVisibleTeamProfileFields();return fields.length?fields:null};var _getHiddenTeamProfileFields=function(){var fields=TS.team.getHiddenTeamProfileFields();return fields.length?fields:null};var _getLabelsMap=function(){return TS.model.team.profile.fields.reduce(function(accumulator,field){accumulator[field.label.toLowerCase()]=true;return accumulator},{})};var _getDefaultTeamProfileFields=function(){var map=_getLabelsMap();var fields=[{type:"text",label:"Address"},{type:"date",label:"Birthdate"},{type:"user",label:"Direct Reports"},{type:"link",label:"Facebook"},{type:"link",label:"Flickr"},{type:"link",label:"GitHub"},{type:"link",label:"Instagram"},{type:"link",label:"LinkedIn"},{type:"user",label:"Manager"},{type:"link",label:"Pinterest"},{type:"text",label:"Skype"},{type:"link",label:"SoundCloud"},{type:"date",label:"Start Date"},{type:"link",label:"Tumblr"},{type:"link",label:"Twitter"},{type:"link",label:"YouTube"}].filter(function(field){return!map[field.label.toLowerCase()]});return fields.length?fields:[]};var _highlightInList=function(id){var selector=id?"[data-id="+id+"]":".visible_row[data-id]";var $el=_$div.find("#edit_team_profile_list").find(selector).last();var offset=$el.outerHeight()*-2;$el.highlight(1500,"",null,0);$el.scrollintoview({duration:200,px_offset:offset,direction:"y"})};var _toggleSave=function(){$("#edit_team_profile_confirm_edit_btn").toggleClass("disabled",!TS.ui.validation.validate(_$div.find("#edit_team_profile_edit"),{quiet:true,fast:true}))}})();(function(){"use strict";TS.registerModule("ui.edit_member_profile",{onStart:function(){TS.members.changed_profile_sig.add(_maybeUpdateMemberPhoto);if(TS.view)TS.view.resize_sig.add(_maybeResizePhotoCrop);$("body").on("click",'[data-action="edit_member_profile_modal"]',function(e){e.preventDefault();TS.ui.edit_member_profile.start()})},start:function(){_start()},handleDrag:function(show){if(TS.boot_data.feature_take_profile_photo){show?_showImageUpload():_hideImageUpload()}},handleDrop:function(files){if(TS.boot_data.feature_take_profile_photo){_hideImageUpload();_preprocessPhoto(files)}}});var _$div;var _$body;var _$progress;var _jcrop;var _image;var _timeout;var _active_section_id;var _back_stack=[];var _abort;var _capture;var _start=function(){var settings={body_template_html:TS.templates.edit_member_profile_modal(),onShow:_onShow,onGo:_editMemberProfile,onCancel:_onCancel,go_button_text:"Save Changes",go_button_class:"edit_member_profile_confirm_edit_btn ladda-button",modal_class:"fs_modal_header fs_modal_footer",title:"Edit your profile"};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#edit_member_profile_container");_$body=$("body");if(_userCanEditTeamProfile()){$("#fs_modal_footer").prepend(TS.templates.edit_member_profile_footer({can_edit_team_profile:true}))}if(TS.boot_data.feature_take_profile_photo){_setupPhotoCapture()}_$div.on("click",'[data-action="edit_member_profile_cancel_photo"]',_switchToList);_$div.on("click",'[data-action="edit_member_profile_confirm_photo_delete"]',_deletePhoto);_$div.on("click",'[data-action="edit_member_profile_confirm_photo_crop"]',_uploadPhoto);_$div.on("click",'[data-action="edit_member_profile_photo_menu"]',_maybeOpenPhotoMenu);_$div.on("click",'[data-action="edit_member_profile_upload_image"]',_onPhotoMenuClick);_$div.on("click",'[data-action="edit_member_profile_to_delete"]',_onDeleteImage);_$div.on("click",'[data-action="edit_member_profile_take_photo"]',_switchToPhotoTake);_$div.on("click",'[data-action="edit_member_profile_capture_photo"]',_capturePhoto);_$body.on("change.photo",'[data-action="edit_member_profile_upload_photo"]',_preprocessPhoto);_$body.on("keydown.member_submit",_onKeydown);_$div.on("input","input",_toggleSave).on("change","select",_toggleSave);_$div.on("input",'[data-plastic-type="date"]',_displayHumanReadableDate);_$div.on("dragenter",".member_image_upload",_handleUploadDragOver);_$div.on("dragleave",".member_image_upload",_handleUploadDragExit);_ensureProfile().then(_switchToList).catch(TS.error)};var _onCancel=function(){_maybeCancelPhotoEdit();_maybeCancelCapturePreview();_$div=null;_$progress=null;_jcrop=null;_image=null;_back_stack=[];_active_section_id=null;_capture=null;if(_$body){_$body.off("change.photo");_$body.off("keydown.member_submit");_$body=null}if(TS.web&&TS.web.account_profile)TS.web.account_profile.render();if(TS.web&&TS.web.members)TS.web.members.render();
};var _onKeydown=function(e){if(e.which==TS.utility.keymap.enter){var $active_section_submit=$(_active_section_id).find('button[type="submit"]');if($active_section_submit.length){$active_section_submit.trigger("click")}else{_editMemberProfile()}return false}};var _ensureProfile=function(){return TS.team.ensureTeamProfileFields()};var _setupPhotoCapture=function(){if(!TS.boot_data.feature_take_profile_photo)return;var get_media=_getUserMedia();_capture={};_capture.is_supported=get_media?true:false;_capture.is_accepted=true;_capture.is_enabled=false;_capture.video_el=null;_capture.video_stream=null;_capture.get_media=get_media};var _getUserMedia=function(){if(!TS.boot_data.feature_take_profile_photo)return;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){return navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices)}var old_user_media=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(old_user_media){return function(constraints){return new Promise(function(resolve,reject){old_user_media.call(navigator,constraints,resolve,reject)})}}return null};var _maybeStartCapturePreview=function(){if(!TS.boot_data.feature_take_profile_photo)return;if(_capture.is_enabled){$(_capture.video_el).removeClass("no_opacity");return}var overlay_show=true;var overlay_delay=700;var $overlay=$("#edit_member_profile_photo_preview_overlay");$overlay.addClass("no_opacity");_abort=function(){overlay_show=false;$overlay.addClass("no_opacity")};var showVideo=function(){overlay_show=false;$overlay.addClass("no_opacity");$(_capture.video_el).removeClass("no_opacity")};var showOverlay=function(){if(overlay_show)$overlay.removeClass("no_opacity")};setTimeout(showOverlay,overlay_delay);var constraints={video:{width:1280,height:720}};_capture.get_media(constraints).then(_startCaptureVideo).then(showVideo).catch(_handleUserMediaError)};var _startCaptureVideo=function(stream){return new Promise(function(resolve,reject){var src=stream;var vendor=window.URL||window.webkitURL;if(vendor)src=vendor.createObjectURL(stream);_capture.video_el=$("#edit_member_profile_photo_preview_video").get()[0];_capture.is_accepted=true;_capture.is_enabled=true;_capture.video_stream=stream;$(_capture.video_el).attr("src",src);_capture.video_el.addEventListener("loadeddata",resolve)})};var _maybeCancelCapturePreview=function(){if(!TS.boot_data.feature_take_profile_photo)return;if(!_capture||!_capture.is_enabled)return;_resetCapturePreview();_capture.video_el.pause();_capture.video_el.src="";_capture.video_el=null;_capture.video_stream.getVideoTracks()[0].stop();_capture.video_stream=null;_capture.is_enabled=false};var _resetCapturePreview=function(){if(_capture.video_el){$(_capture.video_el).addClass("no_opacity")}var $overlay=$("#edit_member_profile_photo_preview_overlay");$overlay.addClass("no_opacity");var $button=$("#edit_member_profile_photo_capture_button");$button.removeClass("hidden");var $countdown=$("#edit_member_profile_photo_capture_countdown");$countdown.addClass("hidden")};var _handleUserMediaError=function(error){switch(error.name){case"PermissionDeniedError":_capture.is_accepted=false;_handlePermissionDeniedError();break;case"PermissionDismissedError":_capture.is_accepted=false;_handlePermissionDeniedError();break;case"NotFoundError":_handleNotFoundError();break;default:_handleUnexpectedError()}};var _handlePermissionDeniedError=function(){return TS.generic_dialog.alert("It looks like you've blocked Slack from accessing your camera. Just change your browser's settings to allow Slack to take a photo now.","Please enable your camera").then(_switchToList)};var _handleNotFoundError=function(){return TS.generic_dialog.alert("Sorry! Your camera could not be found!").then(_switchToList)};var _capturePhoto=function(){if(!TS.boot_data.feature_take_profile_photo)return;if(!_capture.is_enabled)return;_startCaptureCountdown().then(_finishCaptureCountdown).then(_captureDataFromVideo).then(_convertDataToFile).then(_validateSize).then(_preparePhotoOnServer).then(_setupPhotoForCrop).then(_startPhotoCrop).catch(_handlePhotoRejects)};var _startCaptureCountdown=function(){if(!TS.boot_data.feature_take_profile_photo)return;return new Promise(function(resolve,reject){if(!_capture.is_enabled){TS.warn("Camera not enabled");reject()}TS.ui.fs_modal.setHeaderTitle("Smile for the camera!");var $button=$("#edit_member_profile_photo_capture_button");$button.addClass("hidden");var $countdown=$("#edit_member_profile_photo_capture_countdown");$countdown.removeClass("hidden");_captureCountdownCycle(3,false,resolve,reject)})};var _captureCountdownCycle=function(count,aborted,resolve,reject){if(!TS.boot_data.feature_take_profile_photo)return;_abort=function(){aborted=true};if(aborted){TS.info("Profile photo capture aborted");reject(new Error("abort"));return}if(count===0){resolve();return}var $progress=$("#edit_member_profile_photo_countdown_progress");var $text=$("#edit_member_profile_photo_countdown_text");$progress.circleProgress({value:1,size:64,animation:{duration:1e3},fill:{gradient:["#50acf4","#41a6f5"]},startAngle:Math.PI/-2}).on("circle-animation-progress",function(){$text.html(parseInt(count))});setTimeout(function(){_captureCountdownCycle(--count,aborted,resolve,reject)},1e3)};var _finishCaptureCountdown=function(){_resetCapturePreview();_switchToPhotoUpload();_updateProgress(0)};var _captureDataFromVideo=function(){if(!TS.boot_data.feature_take_profile_photo)return;return new Promise(function(resolve,reject){var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.width=_capture.video_el.videoHeight;canvas.height=_capture.video_el.videoHeight;var offset=(_capture.video_el.videoWidth-canvas.width)/-2;context.translate(canvas.width,0);context.scale(-1,1);context.drawImage(_capture.video_el,offset,0,_capture.video_el.videoWidth,_capture.video_el.videoHeight);var data=canvas.toDataURL("image/png",1);resolve(data)})};var _convertDataToFile=function(data){if(!TS.boot_data.feature_take_profile_photo)return;var byte_string;if(data.split(",")[0].indexOf("base64")>=0){byte_string=atob(data.split(",")[1])}else{byte_string=unescape(data.split(",")[1])}var mime_string=data.split(",")[0].split(":")[1].split(";")[0];var ia=new Uint8Array(byte_string.length);for(var i=0;i<byte_string.length;i++){ia[i]=byte_string.charCodeAt(i)}var blob=new Blob([ia],{type:mime_string});blob.lastModifiedDate=new Date;blob.name="camera_photo";var file={file:blob,src:data};return file};var _deletePhoto=function(){$("#edit_member_profile_cancel_photo_delete_btn").addClass("disabled");$("#fs_modal").addClass("stop_pointer_events");_$body.on("keydown.deletePhoto",function(e){e.stopPropagation()});TS.api.call("users.deletePhoto").then(function(){if(TS.web){return TS.api.call("users.info",{user:TS.model.user.id}).then(function(response){delete response.data.ok;var self=$.extend(true,TS.model.user,response.data.user);TS.members.upsertMember(self);_maybeUpdateMemberPhoto();_switchToList()},_switchToList)}else{_switchToList()}}).catch(function(error){TS.warn("Unable to delete profile photo");TS.error(error);return _handleUnexpectedError()}).finally(function(){Ladda.stopAll();_$body.off("keydown.deletePhoto");$("#fs_modal").removeClass("stop_pointer_events");$("#edit_member_profile_cancel_photo_delete_btn").removeClass("disabled")})};var _uploadPhoto=function(e){if(_jcrop)_jcrop.disable();$("#edit_member_profile_cancel_photo_crop_btn").addClass("disabled");$("#edit_member_profile_retake_photo_crop_btn").addClass("disabled");$("#fs_modal").addClass("stop_pointer_events");_$body.on("keydown.uploadPhoto",function(e){e.stopPropagation()});var $el=$("#edit_member_profile_photo");var $cropbox=$("#cropbox");var calling_args=$cropbox.data("dimensions");calling_args.id=$el.data("src_id");TS.api.call("users.setPhoto",calling_args).then(function(response){if(TS.web){delete response.data.ok;var self=$.extend(true,TS.model.user,response.data);TS.members.upsertMember(self);_maybeUpdateMemberPhoto()}_switchToList()}).catch(function(error){TS.warn("Unable to upload cropped profile photo");TS.error(error);return _handleUnexpectedError()}).finally(function(){Ladda.stopAll();_$body.off("keydown.uploadPhoto");$("#fs_modal").removeClass("stop_pointer_events");$("#edit_member_profile_cancel_photo_crop_btn").removeClass("disabled");$("#edit_member_profile_retake_photo_crop_btn").removeClass("disabled");$cropbox.removeData("dimensions")})};var _preprocessPhoto=function(files){var $el=files.type==="change"?$(this):undefined;if($el){if(!$el.val()){if(TS.model.is_iOS)TS.menu.end();return}var files=$el.get(0).files}if(files){if(TS.model.is_iOS)TS.menu.end();if(!files.length)return;_switchToPhotoUpload();_updateProgress(0);_readPhoto(files[0]).then(_validateFormat).then(_validateSize).then(_preparePhotoOnServer).then(_setupPhotoForCrop).then(_startPhotoCrop).catch(_handlePhotoRejects);_$div.find('[data-action="edit_member_profile_upload_photo"]').val("")}};var _readPhoto=function(file){return new Promise(function(resolve,reject){var reader=new FileReader;reader.onload=function(e){resolve({file:file,src:e.target.result})};reader.onabort=function(){TS.info("Profile photo file read aborted");reject(new Error("abort"))};reader.onerror=function(err){TS.warn("Unable to read profile photo file");TS.error(err);reject(err)};_abort=function(){try{reader.abort()}catch(err){TS.error(err)}};reader.readAsDataURL(file)})};var _validateFormat=function(data){return data.file.type.match(/image\/(?:gif|png|jpeg)/i)?Promise.resolve(data):Promise.reject(new Error("format"))};var _validateSize=function(data){return new Promise(function(resolve,reject){_image=new Image;_image.onload=function(){resolve(data)};_image.onerror=function(err){TS.warn("Unable to set profile photo file image src");TS.error(err);reject(err)};_image.src=data.src})};var _preparePhotoOnServer=function(data){var url=TS.model.api_url+"users.preparePhoto";var form_data=new FormData;form_data.append("image",data.file);form_data.append("token",TS.model.api_token);return new Promise(function(resolve,reject){var xhr=$.ajax({url:url,data:form_data,dataType:"json",cache:false,contentType:false,processData:false,type:"POST",xhr:function(){var xhr=jQuery.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){_updateProgress(evt.loaded/evt.total)}else{TS.info("Upload length not computable");_updateProgress(1)}},false)}return xhr}}).fail(function(xhr,text_status,error_thrown){_abort=null;reject(new Error(error_thrown))}).done(function(data,text_status,xhr){_abort=null;if(data.ok){resolve(data)}else{reject(new Error(data.error))}});_abort=xhr.abort})};var _setupPhotoForCrop=function(data){return new Promise(function(resolve,reject){var $el=$("#edit_member_profile_photo");var el=$el.get(0);var loaded=function(event){$("#edit_member_profile_photo_preview").css("background","url("+data.url+")");$el.css("opacity",0);_switchToPhotoCrop();removeListeners();resolve()};var errored=function(event){TS.warn("Unable to set crop photo file image src");TS.error(event);removeListeners();reject(event)};var removeListeners=function(){el.removeEventListener("load",loaded);el.removeEventListener("error",errored)};_abort=function(){removeListeners();resolve()};$el.attr("src",data.url).data("src_id",data.id);el.addEventListener("load",loaded);el.addEventListener("error",errored)})};var _startPhotoCrop=function(){function updatePreview(dimensions){if(!_image)return;var size=$preview.width();var width=size*_image.width/dimensions.crop_w;var height=size*_image.height/dimensions.crop_w;var x=width*dimensions.crop_x*-1/_image.width;var y=height*dimensions.crop_y*-1/_image.height;$preview.css({"background-size":width+"px","background-position":x+"px "+y+"px"})}function updateSelection(crop){if(!_image)return;var dimensions={crop_x:Math.round(crop.x),crop_y:Math.round(crop.y),crop_w:Math.min(Math.round(crop.w),_image.height)};$cropbox.data("dimensions",dimensions);updatePreview(dimensions)}function selectAll(){_jcrop.animateTo(start_crop,function(){var crop=this.tellSelect();crop.w=_image.width;updateSelection(crop)});_jcrop.focus()}var $cropbox=$("#cropbox");var $preview=$("#edit_member_profile_photo_preview");var $el=$("#edit_member_profile_photo");var box_width=$el.width();var box_height=$el.height();var start_crop;if(!_image)return;var min=Math.min(_image.width,_image.height);updatePreview({crop_x:(_image.width-min)/2,crop_y:(_image.height-min)/2,crop_w:min});$("#edit_member_profile_photo").css("opacity",0);$el.Jcrop({aspectRatio:1,allowSelect:false,boxWidth:box_width,boxHeight:box_height,onSelect:updateSelection,onRelease:selectAll,bgColor:"white",trueSize:[_image.width,_image.height]},function(){_jcrop=this;var bounds=this.getBounds();var min=Math.min(bounds[0],bounds[1]);var x=(bounds[0]-min)/2;var y=(bounds[1]-min)/2;start_crop=[x,y,min,min];selectAll()})};var _handlePhotoRejects=function(error){switch(error&&error.message){case"abort":break;case"format":case"bad_image":case"too_many_frames":_switchToPhotoFormatError();break;case"too_large":_switchToPhotoOversizeError();break;default:return _handleUnexpectedError()}};var _maybeCancelPhotoEdit=function(){if(_abort){_abort();_abort=null}};var _handleUnexpectedError=function(){return TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.").then(_switchToList)};var _switchToList=function(){_back_stack.length=0;_back_stack.push({back:_switchToList});_maybeCleanUpPhotoCrop();_maybeCancelPhotoEdit();_maybeCancelCapturePreview();_image=null;var edit_profile_modal=!_$div.find("#edit_member_profile_list").children().first().length;if(edit_profile_modal){var template_args={member:TS.model.user,team:TS.model.team,team_member_profile_fields:TS.team.getVisibleTeamProfileFieldsForMember(TS.model.user,true)};if(TS.boot_data.feature_client_tz_picker){var timezone_options=[];_.each(TS.boot_data.timezones,function(tz){timezone_options.push({label:tz[0],val:tz[1]})});template_args.timezone_options=timezone_options}var html=TS.templates.edit_member_profile_list(template_args);_$div.find("#edit_member_profile_list").html(html)}_hideAllSectionsBut("#edit_member_profile_list");TS.ui.fs_modal.showFooter();TS.ui.fs_modal.setHeaderTitle("Edit your profile");Ladda.bind(".edit_member_profile_confirm_edit_btn");_toggleSave();_makePeoplePickers();_unflexContentsAndCenter();_updateBackButton(true);if(TS.boot_data.feature_take_profile_photo){_maybeShowDelete();_maybeShowTake()}return null};var _maybeShowDelete=function(){var $delete=_$div.find(".show_delete");if(TS.model.user.profile.image_original){$delete.removeClass("hidden");_$div.find(".member_image_wrapped_no_photo").addClass("hidden");_$div.find(".member_image_wrapped").removeClass("hidden")}else{$delete.addClass("hidden");_$div.find(".member_image_wrapped_no_photo").removeClass("hidden");_$div.find(".member_image_wrapped").addClass("hidden")}};var _showImageUpload=function(){if(TS.model.user.profile.image_original){_$div.find(".member_image_wrapped").addClass("hidden")}else{_$div.find(".member_image_wrapped_no_photo").addClass("hidden")}_$div.find(".edit-profile-drop-overlay").removeClass("hidden");_$div.find(".member_image_upload").removeClass("hidden");$(".file_drop_icon").fadeIn({queue:false,duration:"slow"});$(".file_drop_icon").animate({top:"20px"},"slow")};var _hideImageUpload=function(){if(TS.model.user.profile.image_original){_$div.find(".member_image_wrapped").removeClass("hidden")}else{_$div.find(".member_image_wrapped_no_photo").removeClass("hidden")}_$div.find(".member_image_upload").addClass("hidden");_$div.find(".edit-profile-drop-overlay").addClass("hidden");_$div.find(".file_drop_icon").css("top","-20px")};var _handleUploadDragOver=function(){_$div.find(".member_image_upload").addClass("hovered")};var _handleUploadDragExit=function(){_$div.find(".member_image_upload").removeClass("hovered")};var _maybeShowTake=function(){var $take=_$div.find(".show_take");if(_capture.is_supported){$take.removeClass("hidden")}else{$take.addClass("hidden")}};var _maybeShowRetake=function(){var $retake=_$div.find("#edit_member_profile_retake_photo_crop_btn");if(_capture.is_supported&&_capture.is_enabled&&_capture.is_accepted){$retake.removeClass("hidden")}else{$retake.addClass("hidden")}};var _switchToPhotoTake=function(){if(!TS.boot_data.feature_take_profile_photo)return;if(!_capture||!_capture.is_supported)return;_back_stack.push({back:_switchToList});_image=null;_maybeCleanUpPhotoCrop();_maybeStartCapturePreview();_hideAllSectionsBut("#edit_member_profile_photo_take");TS.ui.fs_modal.hideFooter();TS.ui.fs_modal.setHeaderTitle("Take a profile photo");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoCrop=function(){_back_stack.push({back:_switchToList});if(TS.boot_data.feature_take_profile_photo){_maybeShowRetake()}_hideAllSectionsBut("#edit_member_profile_photo_crop");TS.ui.fs_modal.setHeaderTitle("Crop your photo");Ladda.bind("#edit_member_profile_confirm_photo_crop_btn");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoUpload=function(){_back_stack.push({back:_switchToList});if(!_$progress)_makeProgressCircle();_hideAllSectionsBut("#edit_member_profile_photo_upload");TS.ui.fs_modal.hideFooter();TS.ui.fs_modal.setHeaderTitle("Uploading your photo ...");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoDelete=function(){_back_stack.push({back:_switchToPhotoDelete});_hideAllSectionsBut("#edit_member_profile_photo_delete");TS.ui.fs_modal.hideFooter();TS.ui.fs_modal.setHeaderTitle("Remove profile photo");Ladda.bind("#edit_member_profile_confirm_photo_delete_btn");_flexContentsAndCenter();_updateBackButton()};var _switchToPhotoFormatError=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_format_error");TS.ui.fs_modal.setHeaderTitle("Oh cripes");_unflexContentsAndCenter();_updateBackButton()};var _switchToPhotoOversizeError=function(){_back_stack.push({back:_switchToList});_hideAllSectionsBut("#edit_member_profile_photo_oversize_error");TS.ui.fs_modal.setHeaderTitle("Dang");_unflexContentsAndCenter();_updateBackButton()};var _editMemberProfile=function(){if(!TS.ui.validation.validate(_$div,{quiet:true,fast:true})){TS.ui.validation.validate(_$div);Ladda.stopAll();$(".edit_member_profile_confirm_edit_btn").addClass("disabled");return}var field_names=["first_name","last_name","title","phone"];if(TS.boot_data.feature_name_tagging_client){field_names=["full_name","preferred_name","title","phone"]}var profile={};field_names.forEach(function(name){var $field=_$div.find('input[name="'+name+'"]');var value=$field.val();profile[name]=value&&value.trim();$field.val("").val(value)});(TS.model.team.profile.fields||[]).filter(function(field){return!field.is_hidden}).forEach(function(field){var $field=_$div.find('input[name="'+field.id+'"], select[name="'+field.id+'"]');var $alt_field=_$div.find('input[name="'+field.id+'_alt"]');var value=$field.val();var alt_value=$alt_field.val();profile.fields=profile.fields||{};profile.fields[field.id]={value:value&&value.trim(),alt:alt_value&&alt_value.trim()};if(field.type==="text"&&field.label.toLocaleLowerCase()==="skype")profile["skype"]=value&&value.trim();$field.val("").val(value);$alt_field.val("").val(alt_value)});var calling_args={profile:JSON.stringify(profile)};if(TS.boot_data.feature_client_tz_picker){var tz_value=_$div.find('[name="tz"]').val();if(tz_value!==TS.model.user.tz){TS.prefs.setPrefByAPI({name:"tz",value:tz_value})}}TS.api.call("users.profile.set",calling_args).then(function(response){$(".edit_member_profile_confirm_edit_btn").addClass("disabled");if(TS.web){var self=$.extend(true,TS.model.user);self.profile=response.data.profile;TS.members.upsertMember(self)}TS.ui.fs_modal.close()}).catch(function(error){$(".edit_member_profile_confirm_edit_btn").addClass("disabled");if(error.data.error==="ratelimited"){return TS.generic_dialog.alert("You're changing your profile too often! You might have better luck if you try again in a few minutes.")}else{return TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.")}}).finally(Ladda.stopAll)};var _flexContentsAndCenter=function(){_$div.closest(".contents").addClass("display_flex flex_direction_column").css("height","70vh");_$div.css({margin:"auto 0",height:"auto","padding-top":0})};var _unflexContentsAndCenter=function(){_$div.closest(".contents").removeClass("display_flex flex_direction_column").css("height","");_$div.css({margin:"",height:"","padding-top":""})};var _maybeOpenPhotoMenu=function(e){e.stopPropagation();if((!TS.model.user.profile.image_original||$(e.target).is(".btn"))&&!TS.model.is_iOS){_$div.find('[data-action="edit_member_profile_upload_photo"]').trigger("click")}else{TS.menu.member.startWithEditMemberProfilePhotoActions(e,_onPhotoMenuClick)}};var _onPhotoMenuClick=function(e){var $el;if(TS.boot_data.feature_take_profile_photo){$el=$(e.target).closest("ts-icon")}else{$el=$(e.target).closest("li")}if($el.is('[data-action="edit_member_profile_upload_image"]')){if(!TS.model.is_iOS){e.preventDefault();_$div.find('[data-action="edit_member_profile_upload_photo"]').trigger("click");TS.menu.end()}}else if($el.is('[data-action="edit_member_profile_to_delete"]')){e.preventDefault();_switchToPhotoDelete();TS.menu.end()}};var _onDeleteImage=function(e){var $el=TS.boot_data.feature_take_profile_photo?$(e.target).closest("ts-icon"):$(e.target).closest("li");if($el.is('[data-action="edit_member_profile_to_delete"]')){e.preventDefault();_switchToPhotoDelete();TS.menu.end()}};var _hideAllSectionsBut=function(id){var sections=["#edit_member_profile_loading","#edit_member_profile_list","#edit_member_profile_photo_upload","#edit_member_profile_photo_crop","#edit_member_profile_photo_delete","#edit_member_profile_photo_take","#edit_member_profile_photo_size_error","#edit_member_profile_photo_format_error","#edit_member_profile_photo_oversize_error"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden");_active_section_id=id};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(function(){_back_stack.pop();var go_back=_back_stack.pop();go_back.back()});TS.ui.fs_modal.showBackButton()}};var _toggleSave=function(){$(".edit_member_profile_confirm_edit_btn").toggleClass("disabled",!TS.ui.validation.validate(_$div,{quiet:true,fast:true}))};var _makePeoplePickers=function(){_$div.find(".edit_member_profile_lazy_filter_select").each(function(index,el){var $el=$(el);var preselected_ids=$el.val().split(/\s*\,\s*/);TS.ui.people_picker.make($el,{preselected_ids:preselected_ids});$el.on("change",function(){var value=TS.ui.people_picker.value($el).map(function(item){return item.member.id}).join(",");$el.val(value);_toggleSave()})})};var _maybeUpdateMemberPhoto=function(){if(!_$div)return;$("#edit_member_profile_photo_container .member_image").replaceWith(TS.templates.builders.makeMemberPreviewLinkImage(TS.model.user.id,192,false,true))};var _makeProgressCircle=function(){_$progress=$("#edit_member_profile_progress_circle").circleProgress({value:0,size:64,fill:{gradient:["#50acf4","#41a6f5"]},startAngle:Math.PI/-2})};var _updateProgress=function(percent_done){var value=parseFloat(percent_done);if(!isNaN(value))_$progress.circleProgress({value:value.toFixed(2)})};var _maybeCleanUpPhotoCrop=function(){if(!_jcrop)return;_jcrop.destroy();_jcrop=null;$("#edit_member_profile_photo").css({width:"auto",height:"auto",display:"block",visibility:"visible",opacity:1})};var _maybeResizePhotoCrop=function(){if(_jcrop&&_jcrop.getOptions().disabled)return;_maybeCleanUpPhotoCrop();if(_timeout)clearTimeout(_timeout);_timeout=setTimeout(function(){if(_image&&!_jcrop)_startPhotoCrop()},300)};var _displayHumanReadableDate=function(e){var $field=$(e.target);var $alt_field=$('input[name="'+$field.attr("name")+'_alt"]');var value=$field.val();if(value)value=value.trim();if(TS.ui.validation.validate($field,{quiet:true,fast:true}))$alt_field.val(_convertISOtoUTCReadableDate(value))};var _convertISOtoUTCReadableDate=function(iso_date_string){var utc_string="";var ms=Date.parse(iso_date_string);if(!isNaN(ms)){var date=new Date(ms);utc_string+=["January","February","March","April","May","June","July","August","September","October","November","December"][date.getUTCMonth()];utc_string+=" "+TS.utility.ordinalNumber(date.getUTCDate());if(date.getUTCFullYear())utc_string+=", "+date.getUTCFullYear()}return utc_string};var _userCanEditTeamProfile=function(){if(!TS.model.team.plan)return false;var user=TS.model.user;if(!user)return false;if(TS.model.user.enterprise_user)return TS.model.user.enterprise_user.is_admin||TS.model.user.enterprise_user.is_owner;if(TS.model.team.prefs.who_can_change_team_profile==="admin")return user.is_admin;if(TS.model.team.prefs.who_can_change_team_profile==="owner")return user.is_owner;return true}})();(function(){"use strict";TS.registerModule("ui.validation",{completed_sig:new signals.Signal,onStart:function(){$("body").on("input.validation paste.validation change.validation blur.validation","[data-validation]",TS.utility.debounce(function(e){_validate($(e.target),{},e)},250));$("body").on("submit.validation","form[data-validation-form]",function(e){var $form=$(e.target);var passed=TS.ui.validation.validate($form);if(!passed)e.preventDefault();TS.ui.validation.completed_sig.dispatch($form,{event:e,passed:passed})})},validate:function($el,options){options=options||{};var el=document;if($el){if($el.is("[data-validation]")){if($el.length===1)return _validate($el,options);return $el.toArray().every(function(el){return _validate($(el),options)})}el=$el.get(0)}var els=Array.prototype.slice.call(el.querySelectorAll("[data-validation]"));if(options&&options.fast){return els.every(function(el){return _validate($(el),options)})}else{return els.reduce(function(accumulator,el){return _validate($(el),options)&&accumulator},true)}},register:function(key,value){if(_validator_map[key])return void TS.warn(key+" cannot be registered because that key is already in use.");if(typeof value!=="function")return void TS.warn("Only functions can be registered as validators.");_validator_map[key]=value},showCustomValidation:function($el,message,options,hide_after_ms){_showMessage($el,options.error_message||message,options.class,options,hide_after_ms)},showError:function($el,message,options,hide_after_ms){_showMessage($el,options.error_message||message,"validation_error",options,hide_after_ms)},showWarning:function($el,message,options,hide_after_ms){_showMessage($el,options.warning_message||message,"validation_warning",options,hide_after_ms)},showSuccess:function($el,message,options,hide_after_ms){_showMessage($el,options.success_message||message,"validation_success",options,hide_after_ms)},test:function(){return{validations:_validator_map}}});var OPTIONAL_PROTOCOL_URL_REGEXP=/^(?:(?:https?|ftp):\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,}))\.?)(?::\d{2,5})?(?:[/?#]\S*)?$/i;var _validator_map={dateandformat:_validateDateAndFormat,firstalphanumeric:_validateFirstAlphanumeric,hasnourl:_validateHasNoUrl,isurl:_validateIsUrl,lowercase:_validateLowercase,maxcsv:_validateMaxCSV,maxlength:_validateMaxLength,mincsv:_validateMinCSV,minlength:_validateMinLength,nospace:_validateNospace,required:_validateRequired,reservedwords:_validateReservedWords,keywords:_validateKeywords,username:_validateUsername,channel_name:_validateChannelName,shared_channel_name:_validateSharedChannelName,is_email:_validateIsEmail};var _validate=function($el,options,e){options=options||{};if($el.is("[data-validation-for]"))options.custom_for=$el.attr("data-validation-for");options.success_message="Nice, thanks!";if($el.is("[data-validation-success]"))options.success_message=$el.attr("data-validation-success");if($el.is("[data-validation-warning]"))options.warning_message=$el.attr("data-validation-warning");if($el.is("[data-validation-error]"))options.error_message=$el.attr("data-validation-error");if($el.is("input")||$el.is("textarea"))_clearCountdown($el,options);var every=_getValidators($el).every(function(validator){if(validator.indexOf("=")===-1){return _validator_map[validator.trim()]($el,options)}else{var validator_parts=validator.split("=");return _validator_map[validator_parts[0]]($el,options,validator_parts[1])}});TS.ui.validation.completed_sig.dispatch($el,{event:e,passed:every});if(_shouldShowSuccess($el,every,options))TS.ui.validation.showSuccess($el,options.success_message,options,3e3);return every};var _getValidators=function($el){if($el.is("[data-validation]")){return $el.attr("data-validation").replace(/\s*(,|=)\s*/g,"$1").split(/\s+/)}else{return[]}};function _validateRequired($el,options){if($el.is('input[type="radio"]')){if($(document.querySelectorAll('[name="'+$el.prop("name")+'"][data-validation]')).filter(":checked").length)return true;return void TS.ui.validation.showWarning($el,"Please select an option",options)}else if($el.is('input[type="checkbox"]')){if($(document.querySelectorAll('[name="'+$el.prop("name")+'"][data-validation]')).filter(":checked").length)return true;return void TS.ui.validation.showWarning($el,"Please select at least one option",options)}else if($el.is("select")){if($el.val())return true;return void TS.ui.validation.showWarning($el,"Please select an option",options)}else if($el.is("input")||$el.is("textarea")){if($el.val().trim())return true;return void TS.ui.validation.showWarning($el,"This field can't be empty",options)}else{return void TS.error("WTF: cannot validate")}}function _validateReservedWords($el,options,reserved){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim().toLowerCase();var reserved_words=reserved.split(",");if(reserved_words.indexOf(value)===-1)return true;return void TS.ui.validation.showWarning($el,'"'+TS.utility.htmlEntities(value)+'" is a reserved word. Try something else!',options)}else{return void TS.error("WTF: cannot validate")}}function _validateKeywords($el,options){return _validateReservedWords($el,options,TS.model.RESERVED_KEYWORDS.join(","))}function _validateIsUrl($el,options,protocols){var error_message="This doesn't seem like a proper link. Sorry!";if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;var found=value.match(OPTIONAL_PROTOCOL_URL_REGEXP);if(found&&found.length===1&&found[0]===value){if(!protocols)return true;var allowed_protocols=protocols.split(",");for(var i=0;i<allowed_protocols.length;i++){if(found[0].indexOf(allowed_protocols[i])===0){return true}else if(allowed_protocols[i]=="https"){error_message="Please use https (for security)."}}}return void TS.ui.validation.showWarning($el,error_message,options)}else{return void TS.error("WTF: cannot validate")}}function _validateHasNoUrl($el,options){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;if(!TS.utility.findUrls(value).length){return true}return void TS.ui.validation.showWarning($el,"Unfortunately, custom messages can't contain URLs.",options)}else{return void TS.error("WTF: cannot validate")}}function _validateMinLength($el,options,length,hide_countdown){return _validateLength($el,"minlength",options,length,hide_countdown)}
function _validateMaxLength($el,options,length,hide_countdown){return _validateLength($el,"maxlength",options,length,hide_countdown)}function _validateLength($el,key,options,length,hide_countdown){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();length=+length;if(value===undefined||isNaN(length))return void TS.error("WTF: no length to validate");var plural_str=length>1?"s":"";if("minlength"===key){if(value.length>=length)return true;return void TS.ui.validation.showError($el,"This field can't be less than "+length+" character"+plural_str,options)}else if("maxlength"===key){if(!hide_countdown)_countdown($el,value.length,length,options);if(value.length<=length)return true;return void TS.ui.validation.showError($el,"This field can't be more than "+length+" character"+plural_str,options)}}else{return void TS.error("WTF: cannot validate")}}function _validateMinCSV($el,options,length){return _validateCSV($el,"mincsv",options,length)}function _validateMaxCSV($el,options,length){return _validateCSV($el,"maxcsv",options,length)}function _validateCSV($el,key,options,length){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim();length=+length;if(value===undefined||isNaN(length))return void TS.error("WTF: no length to validate");var plural_str=length>1?"s":"";if("mincsv"===key){if(value.split(/\s*\,\s*/).length>=length)return true;return void TS.ui.validation.showError($el,"This field can't have less than "+length+" value"+plural_str,options)}else if("maxcsv"===key){if(value.split(/\s*\,\s*/).length<=length)return true;return void TS.ui.validation.showError($el,"This field can't have more than "+length+" value"+plural_str,options)}}else{return void TS.error("WTF: cannot validate")}}function _validateDateAndFormat($el,options,format){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val().trim();if(!value)return true;var ui_pattern,found,match,valid;switch(format){case"Y-m-d":ui_pattern="YYYY-MM-DD";found=value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/);match=found&&found.length===1&&found[0]===value;if(match)valid=_isValidISODate(value+"T00:00:00.000Z");break;case"m-d":ui_pattern="MM-DD";found=value.match(/^[0-9]{2}-[0-9]{2}$/);match=found&&found.length===1&&found[0]===value;if(match)valid=_isValidISODate("0000-"+value+"T00:00:00.000Z");break;default:return void TS.error("WTF: cannot validate")}if(match&&valid)return true;if(!match)return void TS.ui.validation.showWarning($el,"This needs to be in the format "+ui_pattern+". Sorry!",options);if(!valid)return void TS.ui.validation.showWarning($el,TS.utility.htmlEntities(value)+" doesn't appear to be a valid date. Sorry!",options)}else{return void TS.error("WTF: cannot validate")}}function _validateLowercase($el,options){var value=$el.val();var is_lowercase=value===value.toLocaleLowerCase();if(is_lowercase)return true;return void TS.ui.validation.showWarning($el,"This field must be lowercase only",options)}function _validateNospace($el,options){var value=$el.val();var has_spaces=/\s/.test(value);if(!has_spaces)return true;return void TS.ui.validation.showWarning($el,"This field can't contain spaces",options)}function _validateFirstAlphanumeric($el,options){var value=$el.val();var is_first_alphanumeric=/^[^\W_]/.test(value);if(is_first_alphanumeric)return true;return void TS.ui.validation.showWarning($el,"This first character must be a letter or number",options)}function _validateUsername($el,options){var max_length=21;var msgs={firstalphanumeric:"Usernames must start with a letter or number. Sorry about that!",lowercase:"Sorry, usernames must be lowercase!",maxlength:"Sorry, thats a bit too long! Usernames must be fewer than "+max_length+" characters.",required:"Please fill in a username.",specials:"Usernames cant contain special characters. Sorry about that!"};var quiet_options=$.extend({},options,{quiet:true});if(!_validateRequired($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.required,options);if(!_validateMaxLength($el,quiet_options,max_length,true))return void TS.ui.validation.showWarning($el,msgs.maxlength,options);if(!_validateNospace($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validatePattern($el,quiet_options,/^[\w\._-]+$/))return void TS.ui.validation.showWarning($el,msgs.specials,options);if(!_validateFirstAlphanumeric($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.firstalphanumeric,options);if(!_validateLowercase($el,quiet_options))return void TS.ui.validation.showWarning($el,msgs.lowercase,options);if(!_validateReservedWords($el,options,TS.model.RESERVED_USERNAMES.join(",")))return false;return true}function _channelNameValidation($el,options){var max_length=21;var msgs={lowercase:"Channel names must be all lowercase. Try again?",maxlength:"Blerg, that's a bit too long! Channel names must be fewer than "+(max_length+1)+" characters.",required:"Please fill in a channel name.",specials:"Channel names can't contain special characters, spaces, or periods. Try again?",single_punctuation:"Names can't be a single hyphen or underscore. Please elaborate!"};var quiet_options=$.extend({},options,{quiet:true});if(!_validateRequired($el,quiet_options)){TS.ui.validation.showWarning($el,msgs.required,options);return true}if(!_validateMaxLength($el,quiet_options,max_length,true)){TS.ui.validation.showWarning($el,msgs.maxlength,options);return true}if(!_validateLowercase($el,quiet_options)){TS.ui.validation.showWarning($el,msgs.lowercase,options);return true}if(!_validateNospace($el,quiet_options)){TS.ui.validation.showWarning($el,msgs.specials,options);return true}if(!_validatePattern($el,quiet_options,/^[a-zA-Z0-9-_]+$/)){TS.ui.validation.showWarning($el,msgs.specials,options);return true}if(_validatePattern($el,quiet_options,/^[-|_]$/)){TS.ui.validation.showWarning($el,msgs.single_punctuation,options);return true}}function _validateChannelName($el,options){var name_validation=_channelNameValidation($el,options);if(name_validation)return false;if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();var other_channel=TS.channels.getChannelByName(value)||TS.groups.getGroupByName(value)||TS.members.getMemberByName(value);if(!other_channel)return true;return void TS.ui.validation.showWarning($el,'"'+TS.utility.htmlEntities(value)+'"'+" is already taken by a channel, username, or user group.",options)}else{return void TS.error("WTF: cannot validate")}}function _validateSharedChannelName($el,options){var name_validation=_channelNameValidation($el,options);if(name_validation)return false;if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();var need_to_check_api=false;var other_channel=TS.channels.getChannelByName(value)||TS.groups.getGroupByName(value)||TS.members.getMemberByName(value);var current_model_ob=TS.shared.getActiveModelOb();if(!other_channel)need_to_check_api=true;if(other_channel&&other_channel.id===current_model_ob.id)need_to_check_api=true;if(other_channel&&other_channel.id!==current_model_ob.id)return void TS.ui.validation.showWarning($el,TS.utility.htmlEntities(value)+" has already been taken. Try something else!",options);if(need_to_check_api){return true}else{return false}}else{return void TS.error("WTF: cannot validate")}}function _validateIsEmail($el,options,protocols){if($el.is('input[type="radio"]')||$el.is('input[type="checkbox"]')||$el.is("select"))return true;if($el.is("input")||$el.is("textarea")){var value=$el.val();if(!value)return true;var found=value.match(TS.utility.email_regex);if(found&&found.length===1&&found[0]===value)return true;return void TS.ui.validation.showWarning($el,"This doesn't seem like an email address. Sorry!",options)}else{return void TS.error("WTF: cannot validate")}}function _validatePattern($el,options,pattern){var value=$el.val();if(!pattern.test(value)){return void TS.ui.validation.showWarning($el,"This field contains invalid characters",options)}return true}var _isValidISODate=function(iso_date_string){if(!isNaN(Date.parse(iso_date_string))){var date=new Date(iso_date_string);return!date.toISOString().indexOf(iso_date_string)}};var _shouldShowSuccess=function($el,every,options){var $label=$(document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]'));if(!$label.length)return;return!(options&&options.quiet)&&every&&$label.data("validation-ephemeral")===false};var _showMessage=function($el,message,validation_level,options,hide_after_ms){if(options&&options.quiet)return;var $label=$(document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]'));if(!$label.length)return;var timeout=$label.data("validation-timeout");clearTimeout(timeout);var $message=$label.find(".validation_message");if(!$message.length){$message=$("<span />").addClass("validation_message overflow_ellipsis");if($el.is("select")){$message.insertBefore($label.find("select"))}else{$message.appendTo($label)}}_toggleValidationLevel($el,$label,validation_level);$message.get(0).title=message;$message.fadeIn(100);$label.data("validation-ephemeral",!!hide_after_ms);if(hide_after_ms){$label.data("validation-timeout",setTimeout(function(){$label.removeData("validation-ephemeral").removeData("validation-timeout");$message.fadeOut(100,function(){_toggleValidationLevel($el,$label);$message.remove()})},hide_after_ms))}};var _levels=["validation_error","validation_warning","validation_success"];var _toggleValidationLevel=function($el,$label,validation_level){if($label.hasClass(validation_level))return;$el.removeClass(_levels.join(" "));$el.addClass(validation_level);$label.removeClass(_levels.join(" "));$label.addClass(validation_level)};var _countdown=function($el,value_length,validation_length,options){if(validation_length-value_length<=6){_setCountdown($el,value_length,validation_length,options)}else{_clearCountdown($el,options)}};var _setCountdown=function($el,value_length,validation_length,options){var label=document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]');if(!label)return;var countdown_data_attr=[value_length,validation_length].join("/");$(label).attr("data-countdown",countdown_data_attr).addClass("countdown");var styles=window.getComputedStyle(label,":after");var countdown_text_width=parseFloat(styles.width)||9*countdown_data_attr.length;if(!$el.data("countdown-padding-right"))$el.data("countdown-padding-right",parseFloat($el.css("padding-right")));$el.css("padding-right",countdown_text_width+parseFloat(styles.right)+$el.data("countdown-padding-right"))};var _clearCountdown=function($el,options){var label=document.querySelector('label[for="'+(options.custom_for||$el.attr("name"))+'"]');if(!label)return;$(label).removeClass("countdown");$el.removeData("countdown-padding-right");$el.css("padding-right","")}})();(function(){"use strict";TS.registerModule("ui.token_input",{onStart:function(){},make:function($container,options){if(!($container&&$container.length))return;var $input=$container.find("input");if(!($input&&$input.length))return;if($input.val().trim()){_tokenizeInput($input)}$container.on("click",function(){$container.addClass("active");$input.focus()});$input.on("paste",function(e){setTimeout(function(){var val=$input.val().trim();if(!/\,/.test(val))return true;if(val)_tokenizeInput($input,options)},0)}).on("keydown",function(e){var length=$input.val().length;if(!length&&e.which===TS.utility.keymap.del){_untokenizeInput($input,options)}else if(length===1&&!$input.prev(".token").length){_untokenizeInput($input,options)}if(length&&e.which===TS.utility.keymap.enter){_tokenizeInput($input,options)}}).on("keyup",function(e){var length=$input.val().length;if(length&&(e.which===TS.utility.keymap.comma||e.which===TS.utility.keymap.space)){_tokenizeInput($input,options)}}).on("focusout",function(){_tokenizeInput($input,options);$container.removeClass("active")}).on("focusin",function(){$container.addClass("active")});$input.data("placeholder",$input.attr("placeholder"));if($container.find(".token").length)$input.attr("placeholder","");if(options&&options.remove_on_click){$container.on("click",".token",function(){$(this).remove()})}},value:function($container,value){if(value)return _setTokenInputValue($container,value);return _getTokenInputValue($container)}});var _getTokenInputValue=function($container){var token_values=[];$container.find(".token").each(function(index){var value=$(this).text().trim();token_values.push(value)});return token_values.join(", ")};var _setTokenInputValue=function($container,value){var $input=$container.find("input");$container.find(".token").remove();$input.val(value);_tokenizeInput($input)};var _tokenizeInput=function($input,options){var val=$input.val().trim();var vals=val.split(/\s*[\,\s]\s*/);var has_tokens=false;vals.forEach(function(value){if(value){var $token=$("<span />").addClass("token").text(value);$token.toggleClass("remove_on_click",options&&options.remove_on_click);$input.before($token);has_tokens=true;if(options&&options.onTokenChange)options.onTokenChange($input,$token)}});if(has_tokens)$input.attr("placeholder","").val("")};var _untokenizeInput=function($input,options){var $token=$input.prev(".token");if($token.length){var val=$token.text();$token.remove();$input.val(val+" ")}else{$input.attr("placeholder",$input.data("placeholder"))}if(options&&options.onTokenChange)options.onTokenChange($input)}})();(function(){"use strict";TS.registerModule("help",{issues_sorted_sig:new signals.Signal,issues:[],more_url:null,fake_api_rsps:false,max_title_chars:100,onStart:function(){if(!TS.client)return;TS.ms.connected_sig.addOnce(function(){TS.api.call("help.issues.list",{},TS.help.onListIssues)})},getIssueById:function(id){var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];if(issue.id==id){return issue}}return null},onListIssues:function(ok,data,args){if(TS.help.fake_api_rsps){TS.help.more_url="/help";TS.help.issues=[{id:"T00001",title:"issue 1",ts:"1111111111",short_text:"blah blah blah blah blah",state:"resolved"},{id:"T00002",title:"issue 2",ts:"1141111111",short_text:"I think this is ok",state:"open"},{id:"T00003",title:"issue 3",ts:"1121111111",short_text:"but I am not so sure abotu this",state:"unread"},{id:"T00004",title:"issue 4",ts:"1161111111",short_text:"what about that?",state:"open"},{id:"T00005",title:"issue 5",ts:"1151111111",short_text:"fuck it all to hell",state:"open"},{id:"T00006",title:"issue 6",ts:"1171111111",short_text:"MORE BATTRY PLZ",state:"read"},{id:"T00007",title:"issue 7",ts:"1191111111",short_text:"halp",state:"unread"},{id:"T00008",title:"issue 8",ts:"191111111",short_text:"halp",state:"unread"},{id:"T00009",title:"issue 9",ts:"181111111",short_text:"halp",state:"unread"},{id:"T000010",title:"issue 10",ts:"171111111",short_text:"halp halp halp halp halp halp halp halp halp halp ...",state:"unread"}]}else if(ok){TS.help.issues=data.issues}TS.help.sortIssues();TS.help.updateIcon()},sortIssues:function(){var sort_map={unread:4,open:3,read:2,resolved:1};var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];issue._sorter=parseFloat((sort_map[issue.state]||5)+"."+issue.ts)}TS.help.issues.sort(function compare(a,b){if(a._sorter<b._sorter)return 1;if(a._sorter>b._sorter)return-1;return 0});TS.help.issues_sorted_sig.dispatch()},updateIcon:function(){var tab_css_class="normal";var unread_count=0;var open_count=0;var issue;for(var i=0;i<TS.help.issues.length;i++){issue=TS.help.issues[i];if(issue.state=="unread"){tab_css_class="unread";unread_count++}else if(issue.state=="open"){}}$("#help_icon").removeClass("normal open unread").addClass(tab_css_class);if(unread_count){$("#help_icon_circle_count").text(unread_count)}else{$("#help_icon_circle_count").text(open_count)}$("#flex_menu_toggle").removeClass("normal open unread").addClass(tab_css_class);$(".help_icon_circle_count").addClass("hidden");if(unread_count>9)unread_count="9+";if(unread_count)$(".help_icon_circle_count").removeClass("hidden").text(unread_count)},createIssue:function(user_args,callback){var title=user_args["title"];var text=user_args["text"];if(!title)return;text=text||"";var args={title:title,text:text};if(user_args["tags"]){args["tags"]=user_args["tags"]}TS.api.call("help.issues.create",args,function(ok,data,args){if(ok){}else if(TS.help.fake_api_rsps){var issue={id:Date.now(),title:title,ts:Date.now()/1e3,short_text:text.substr(0,50),state:"open"};setTimeout(function(){TS.ms.handleMsg({type:"issue_created",issue:issue})},2e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},fetchIssueDetails:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,issue,"unknown issue");return}TS.api.call("help.issues.info",{id:id},function(ok,data,args){var iissue;if(TS.help.fake_api_rsps){ok=true;iissue=_.cloneDeep(issue);iissue.comments=[{ts:112211111,from:"eeric",text:"comment 1"},{ts:112214444,from:"whoop",text:"comment 2"}]}else if(ok){iissue=data.issue}TS.help.onIssueChange(iissue);if(callback)callback(ok,issue,TS.help.makeErrStr(data))})},markIssueRead:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,"unknown issue");return}if(issue.state!="unread"){if(callback)callback(true);return}TS.api.call("help.issues.markRead",{id:id},function(ok,data,args){if(ok){}else if(TS.help.fake_api_rsps){var clone=_.cloneDeep(issue);clone.state="read";setTimeout(function(){TS.ms.handleMsg({type:"issue_change",issue:clone})},2e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},replyToIssue:function(id,text,callback){TS.api.call("help.issues.replyTo",{id:id,text:text},function(ok,data,args){if(callback)callback(ok,TS.help.makeErrStr(data),data&&data.error?data.error:"")})},markIssueResolved:function(id,callback){var issue=TS.help.getIssueById(id);if(!issue){if(callback)callback(false,"unknown issue");return}TS.api.call("help.issues.markResolved",{id:id},function(ok,data,args){if(TS.help.fake_api_rsps||!ok&&data&&data.error=="ticket_closed"){ok=true;var clone=_.cloneDeep(issue);clone.state="resolved";setTimeout(function(){TS.ms.handleMsg({type:"issue_change",issue:clone})},1e3)}if(callback)callback(ok,TS.help.makeErrStr(data))})},onIssueChange:function(iissue){var issue=TS.help.getIssueById(iissue.id);if(issue){TS.help.updateIssue(iissue,issue)}else{TS.help.issues.push(iissue)}TS.help.sortIssues();TS.help.updateIcon()},updateIssue:function(iissue,issue){for(var k in iissue){issue[k]=iissue[k]}if(issue.comments){issue.comments.sort(function compare(a,b){if(a.ts<b.ts)return 1;if(a.ts>b.ts)return-1;return 0})}},makeErrStr:function(data){if(!data)return"missing data";if(data.ok)return null;if(data.error&&data.info&&TS.boot_data.feature_tinyspeck){try{return'api error: "'+data.error+'"<br><br><div class="admin-section" style="word-wrap: break-word; word-break: break-word;">api rsp: '+JSON.stringify(data).replace(/\,/g,", ")+"</div>"}catch(error){}}if(data.error)return'api error: "'+data.error+'"'}})})();(function(){"use strict";TS.registerModule("ui.share_dialog",{div:null,showing:false,delegate:undefined,onStart:function(){},onKeydown:function(e){if(!TS.ui.share_dialog.showing)return;if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.share_dialog.go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.share_dialog.cancel()}}},start:function(item_id,hide_file_preview,has_title,source_model_ob_id){if(TS.client&&TS.client.ui.checkForEditing())return;_submitting=false;var item=TS.files.getFileById(item_id);var type="file";if(item.mode=="post"){type="file_post"}else if(item.mode=="space"){type="file_space"}else if(item.mode=="snippet"){type="file_snippet"}else if(item.mode=="multnomah"){type="file_multnomah"}var template_args={type:type,item:item,item_owner:TS.members.getMemberById(item.user),sharing_html:TS.templates.builders.buildFileSharingControls(item,true,null,has_title),file_html:hide_file_preview?"":TS.templates.builders.fileHTML(item,{for_share_dialog:true})};template_args["icon_class"]=TS.utility.getImageIconClass(item,"thumb_80");if(!TS.ui.share_dialog.div)TS.ui.share_dialog.build();var html=TS.templates.share_dialog(template_args);html=TS.format.replaceHighlightMarkers(html);var div=TS.ui.share_dialog.div;div.html(html);var $file_comment_textarea=$("#file_comment_textarea");TS.ui.comments.bindInput($file_comment_textarea,TS.ui.share_dialog.go);$file_comment_textarea.autogrow();$file_comment_textarea=null;div.modal("show");div.find(".dialog_cancel").click(TS.ui.share_dialog.cancel);div.find(".dialog_go").click(TS.ui.share_dialog.go);TS.ui.file_share.bindFileShareDropdowns(false,{id:source_model_ob_id});TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField()},go:function(){if(_submitting){TS.info("TS.ui.share_dialog stopping because already sharing");return}if(!TS.ui.share_dialog.showing){TS.error("not showing?");return}if(TS.ui.file_share.shouldBlockUploadDialogSubmission())return;var div=$("#share_dialog");var item_id=div.find("#share_item_id").val();var model_ob_id=div.find("#share_model_ob_id").val();if(!model_ob_id){var selected=$("#select_share_channels").lazyFilterSelect("value")[0];if(selected){model_ob_id=selected.model_ob.id}}if(!model_ob_id){TS.warn("model_ob_id is not set! "+$("#select_share_channels").val());return}var comment=TS.format.cleanMsg($("#file_comment_textarea").val());if($.trim(comment)==="")comment="";var share_fn=function(){TS.shared.getShareModelObId(model_ob_id,function(real_model_ob_id){var shared_from_msg=false;TS.files.shareFile(item_id,real_model_ob_id,comment,shared_from_msg).then(function(){if(!TS.client)return;var dest_model_ob=TS.shared.getModelObById(real_model_ob_id);if(!dest_model_ob)return;var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&active_model_ob.id===dest_model_ob.id){TS.client.ui.instaScrollMsgsToBottom()}else{return TS.client.displayModelOb(dest_model_ob)}})})};if(TS.ui.share_dialog.delegate&&typeof TS.ui.share_dialog.delegate.submit=="function"){TS.ui.share_dialog.delegate.submit(div,share_fn)}else{share_fn()}_submitting=true;TS.ui.share_dialog.div.modal("hide")},cancel:function(){TS.ui.share_dialog.div.modal("hide")},end:function(){if(_thumbnail_lazy_load&&_thumbnail_lazy_load.detachEvents){_thumbnail_lazy_load.detachEvents()}_thumbnail_lazy_load=null;TS.ui.share_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.comments.unbindInput($("#file_comment_textarea"));TS.ui.share_dialog.div.empty();$(window.document).unbind("keydown",TS.ui.share_dialog.onKeydown)},build:function(){$("body").append('<div id="share_dialog" class="modal hide fade"></div>');var div=TS.ui.share_dialog.div=$("#share_dialog");div.on("hidden",function(e){if(e.target!=this)return;TS.ui.share_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.ui.share_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;var preselected=$("#select_share_channels").lazyFilterSelect("value");if(preselected.length<1){$("#select_share_channels").lazyFilterSelect("getInstance").$input.focus()}else{$("#file_comment_textarea").focus()}$(window.document).bind("keydown",TS.ui.share_dialog.onKeydown);_thumbnail_lazy_load=TS.ui.share_dialog.div.find("img.lazy").lazyload()})}});var _thumbnail_lazy_load=null;var _submitting=false})();(function(){"use strict";TS.registerModule("pins",{pins_fetched_sig:new signals.Signal,pinned_status_changed_sig:new signals.Signal,pinned_message_changed_sig:new signals.Signal,pinned_message_deleted_sig:new signals.Signal,onStart:function(){TS.files.team_file_comment_deleted_sig.add(_fileCommentDeleted);TS.files.team_file_deleted_sig.add(_fileDeleted);if(TS.boot_data.feature_pin_update){if(TS.client&&TS.client.login_sig){TS.client.login_sig.add(_handleDisplayChannel)}else if(TS.web&&TS.web.login_sig){TS.web.login_sig.add(_handleDisplayChannel)}TS.channels.switched_sig.add(_handleDisplayChannel);TS.groups.switched_sig.add(_handleDisplayChannel);TS.ims.switched_sig.add(_handleDisplayChannel);TS.mpims.switched_sig.add(_handleDisplayChannel);TS.ms.connected_sig.add(__handleSocketConnected);TS.channels.left_sig.add(_handleLeftChannelOrGroup);TS.groups.left_sig.add(_handleLeftChannelOrGroup)}},fetchPins:function(model_ob,callback){if(!model_ob)return;_are_pins_currently_being_fetched[model_ob.id]=true;TS.api.call("pins.list",{channel:model_ob.id},function(ok,data,args){if(ok){var pinned_items=data.items;TS.pins.upsertPinnedItems(pinned_items);model_ob.pinned_items=pinned_items;model_ob.has_pins=pinned_items.length>0;if(!model_ob.is_channel||model_ob.is_member)_have_pins_been_fetched[model_ob.id]=true;TS.pins.pins_fetched_sig.dispatch(model_ob,pinned_items)}delete _are_pins_currently_being_fetched[model_ob.id];if(callback)callback(ok,data,args)})},arePinsCurrentlyBeingFetched:function(model_ob){return!!_are_pins_currently_being_fetched[model_ob.id]},havePinsBeenFetched:function(model_ob){return!!_have_pins_been_fetched[model_ob.id]},startPinFile:function(file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return;_promptAddPin("file",model_ob,{file:file,type:"file"})},unPinFile:function(file_id,model_ob){var file=_getPinnedFile(file_id,model_ob);if(!file)return;var item={file:file,type:"file"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})},startPinFileComment:function(comment_id,file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment)return;_promptAddPin("comment",model_ob,{file:file,comment:comment,type:"file_comment"})},unPinFileComment:function(comment_id,file_id,model_ob){var comment=_getPinnedComment(comment_id,file_id,model_ob);var file=TS.files.getFileById(file_id);if(!comment||!file)return;var item={file:file,comment:comment,type:"file_comment"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})},startPinMessage:function(msg_ts,model_ob){msg_ts=msg_ts.toString();var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg&&TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){msg=TS.client.unread.getMessage(model_ob,msg_ts)}if(msg){if(msg.subtype==="file_comment"){TS.pins.startPinFileComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){TS.pins.startPinFile(msg.file.id,model_ob)}else{_promptAddPin("message",model_ob,{message:msg,type:"message"})}}},unPinMessage:function(msg_ts,model_ob){msg_ts=msg_ts.toString();var msg=_getPinnedMsg(msg_ts,model_ob);if(msg){if(msg.subtype==="file_comment"){TS.pins.unPinFileComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){TS.pins.unPinFile(msg.file.id,model_ob)}else{var item={message:msg,type:"message"};_promptRemovePin(item,model_ob,function(){_callPinsRemove(model_ob,item)})}}},isMessagePinned:function(msg,model_ob){if(msg.subtype==="file_comment"){if(!msg.comment)return false;return!!_getPinnedComment(msg.comment.id,msg.file.id,model_ob)}else if(msg.file){return!!_getPinnedFile(msg.file.id,model_ob)}else{return!!_getPinnedMsg(msg.ts,model_ob)}},pinStatusHasChanged:function(pinned,item,type,model_ob){var msg,file,comment;var item_changed,model_ob_changed,file_changes;if(type==="message"&&(model_ob.msgs||model_ob._archive_msgs)){msg=TS.utility.msgs.getMsg(item.message.ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(item.message.ts,model_ob._archive_msgs);if(msg){item.message=msg;item_changed=_updatePinnedStatus(pinned,msg,model_ob)}}else if(type==="file_comment"){file_changes=TS.files.upsertFile(item.file);file=TS.files.getFileById(item.file.id);item.file=file;comment=TS.files.getFileCommentById(file,item.comment.id);if(comment){item.comment=comment;item_changed=_updatePinnedStatus(pinned,comment,model_ob)}else{comment=TS.files.addCommentToFile(item.comment,file);item.comment=comment}item_changed=item_changed||file_changes.status==="CHANGED"}else if(type==="file"){file_changes=TS.files.upsertFile(item.file);file=TS.files.getFileById(item.file.id);item.file=file;item_changed=_updatePinnedStatus(pinned,file,model_ob);item_changed=item_changed||file_changes.status==="CHANGED"}model_ob_changed=_updateModelPinnedItems(pinned,item,type,model_ob);if(item_changed||model_ob_changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob,item,pinned)},upsertPinnedItems:function(pinned_items){pinned_items.forEach(function(item){if(item.type==="file"){TS.files.upsertFile(item.file);item.file=TS.files.getFileById(item.file.id)}else if(item.type==="file_comment"){TS.files.upsertFile(item.file);item.file=TS.files.getFileById(item.file.id);var comment=TS.files.getFileCommentById(item.file,item.comment.id);if(!comment)comment=TS.files.addCommentToFile(item.comment,item.file);item.comment=comment}})},replaceMsg:function(msg,model_ob){if(!model_ob.pinned_items)return;model_ob.pinned_items.forEach(function(item){if(item.type==="message"&&item.message.ts===msg.ts){item.message=msg;TS.pins.pinned_message_changed_sig.dispatch(model_ob,item)}})},removeMsg:function(msg_ts,model_ob){if(!model_ob.pinned_items)return;_updateModelPinnedItems(false,{message:{ts:msg_ts}},"message",model_ob);TS.pins.pinned_message_deleted_sig.dispatch(model_ob)},canUserPinHere:function(model_ob){if(!TS.client||!model_ob)return false;if(model_ob.is_general&&!TS.members.canUserPostInGeneral())return false;if(model_ob.is_channel&&!model_ob.is_member)return false;if(!TS.members.canMemberPostInChannel(model_ob))return false;return true},getPinData:function(msg){var matching_pin;var pinned_items=TS.shared.getActiveModelOb().pinned_items;if(_.isEmpty(pinned_items))return;_.forEach(pinned_items,function(pinned_item){if(pinned_item.type==="file"&&(msg.subtype==="file_share"||msg.subtype==="file_mention")){if(msg.file.id===pinned_item.file.id){matching_pin=pinned_item;return false}}else if(pinned_item.type==="file_comment"&&msg.subtype==="file_comment"){if(msg.comment.id===pinned_item.comment.id){matching_pin=pinned_item;return false}}else if(pinned_item.type==="message"){if(msg.ts===pinned_item.message.ts){matching_pin=pinned_item;return false}}});if(!matching_pin)return;var pin_data={created:matching_pin.created,created_by:matching_pin.created_by};return pin_data},getUnreadPins:function(model_ob){var last_read;var unread_pins=[];if(!model_ob)return unread_pins;var marked_reason=model_ob._marked_reason;if(model_ob.last_read==="0000000000.000000"&&marked_reason!=="back")return unread_pins;if(TS.model.ui.is_window_focused){if(marked_reason==="back"){var msg_after_last_read=TS.utility.msgs.getDisplayedMsgAfterTS(model_ob.last_read,model_ob.msgs);if(msg_after_last_read){last_read=parseFloat(msg_after_last_read.ts)-1}else{last_read=model_ob.last_read}}else if(model_ob._prev_last_read&&(!marked_reason||marked_reason==="viewed")){last_read=model_ob._prev_last_read}else{last_read=model_ob.last_read}}else{last_read=model_ob.last_read}var pinned_items=model_ob.pinned_items;if(_.isEmpty(pinned_items))return unread_pins;_.forEach(pinned_items,function(pinned_item){var user=TS.members.getMemberById(pinned_item.created_by);if(!user)return;if(pinned_item.created>Math.ceil(last_read)){if(user.is_self&&marked_reason==="back"){unread_pins.push(pinned_item)}else if(!user.is_self){unread_pins.push(pinned_item)}}});return unread_pins},test:function(){return{fileDeleted:_fileDeleted,fileCommentDeleted:_fileCommentDeleted,have_pins_been_fetched:_have_pins_been_fetched
}}});var _have_pins_been_fetched={};var _are_pins_currently_being_fetched={};var _previously_connected=false;var _getPinnedFile=function(file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file||!file.pinned_to)return null;var pinned=file.pinned_to.indexOf(model_ob.id)!==-1;return pinned?file:null};var _getPinnedComment=function(comment_id,file_id,model_ob){var file=TS.files.getFileById(file_id);if(!file)return null;var comment=TS.files.getFileCommentById(file,comment_id);if(!comment||!comment.pinned_to)return null;var pinned=comment.pinned_to.indexOf(model_ob.id)!==-1;return pinned?comment:null};var _getPinnedMsg=function(msg_ts,model_ob){if(model_ob.pinned_items){var item;for(var i=0;i<model_ob.pinned_items.length;i++){item=model_ob.pinned_items[i];if(item.type==="message"&&item.message.ts===msg_ts)return item.message}}var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg)return null;if(msg.subtype==="file_comment"){if(_getPinnedComment(msg.comment.id,msg.file.id,model_ob))return msg}else if(msg.file){if(_getPinnedFile(msg.file.id,model_ob))return msg}else{if(msg.pinned_to&&msg.pinned_to.indexOf(model_ob.id)!==-1)return msg}return null};var _updatePinnedStatus=function(pinned,item,model_ob){var changed=false;if(!item.pinned_to)item.pinned_to=[];if(pinned){if(item.pinned_to.indexOf(model_ob.id)===-1){item.pinned_to.push(model_ob.id);changed=true}}else{var index=item.pinned_to.indexOf(model_ob.id);if(index!==-1){item.pinned_to.splice(index,1);changed=true}}return changed};var _updateModelPinnedItems=function(pinned,item,type,model_ob){var changed=false;if(!model_ob.pinned_items)model_ob.pinned_items=[];var pinned_items_index=-1;model_ob.pinned_items.some(function(pinned_item,index){var matches=false;if(type==="message"&&pinned_item.type==="message"){if(pinned_item.message.ts===item.message.ts)matches=true}else if(type==="file"&&pinned_item.type==="file"){if(pinned_item.file.id===item.file.id)matches=true}else if(type==="file_comment"&&pinned_item.type==="file_comment"){if(pinned_item.comment.id===item.comment.id)matches=true}if(matches){pinned_items_index=index;return true}});if(!pinned&&pinned_items_index!==-1){model_ob.pinned_items.splice(pinned_items_index,1);changed=true}else if(pinned&&pinned_items_index===-1){model_ob.pinned_items.unshift(item);changed=true}model_ob.has_pins=model_ob.pinned_items.length>0;return changed};var _promptAddPin=function(type,model_ob,item){var template=Handlebars.compile("<p>Are you sure you want to pin this {{type}} to {{pinToLabel model_ob}}?</p>");var body=template({type:type,model_ob:model_ob});body+=TS.client.channel_page.pinnedItemHtml(item,model_ob);TS.generic_dialog.start({title:"Pin "+type,body:body,go_button_text:"Yes, pin this "+type,onGo:function(){_callPinsAdd(model_ob,item)}})};var _callPinsAdd=function(model_ob,item){var args=_apiArgs(model_ob,item);var ts=TS.utility.date.makeTsStamp(null,"0");TS.api.call("pins.add",args,function(ok,data){if(!ok){if(data.error==="too_many_pins"){var type="message";if(item.type==="file")type="file";if(item.type==="file_comment")type="comment";TS.generic_dialog.start({title:"Couldn't pin "+type,body:"<p>Sorry! You've hit the limit on how many pins you can have in this channel.</p>",show_cancel_button:false})}else{TS.info("pins.add got a not ok rsp: "+data.error)}if(data.error!=="already_pinned")return}item.created=ts;item.created_by=TS.boot_data.user_id;TS.pins.pinStatusHasChanged(true,item,item.type,model_ob)})};var _callPinsRemove=function(model_ob,item){var args=_apiArgs(model_ob,item);TS.api.call("pins.remove",args,function(ok,data){if(!ok){if(data.error!=="not_pinned")return}TS.pins.pinStatusHasChanged(false,item,item.type,model_ob)})};var _apiArgs=function(model_ob,item){var args={channel:model_ob.id};if(item.type==="message"){args.timestamp=item.message.ts}else if(item.type==="file"){args.file=item.file.id}else if(item.type==="file_comment"){args.file_comment=item.comment.id}return args};var _promptRemovePin=function(item,model_ob,callback){TS.client.channel_page.highlightPinnedItemForRemoval(item);var html=TS.client.channel_page.pinnedItemHtml(item,model_ob);TS.generic_dialog.start({title:"Remove Pinned Item",body:"<p>Are you sure you want to remove this pinned item?</p>"+html,go_button_text:"Yes, remove this pinned item",onGo:callback,onCancel:function(){TS.client.channel_page.unHighlightPinnedItemForRemoval(item)}})};var _fileCommentDeleted=function(file,comment_id,deleted_comment){if(!deleted_comment||!deleted_comment.pinned_to)return;deleted_comment.pinned_to.forEach(function(model_ob_id){var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var changed=_updateModelPinnedItems(false,{comment:deleted_comment},"file_comment",model_ob);if(changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob)})};var _fileDeleted=function(file){if(!file)return;if(file.pinned_to){file.pinned_to.forEach(function(model_ob_id){var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var changed=_updateModelPinnedItems(false,{file:file},"file",model_ob);if(changed)TS.pins.pinned_status_changed_sig.dispatch(model_ob)})}if(file.comments){file.comments.forEach(function(comment){_fileCommentDeleted(file,comment.id,comment)})}};var _handleDisplayChannel=function(){var model_ob=TS.shared.getActiveModelOb();if(model_ob&&!_have_pins_been_fetched[model_ob.id]&&!_are_pins_currently_being_fetched[model_ob.id])TS.pins.fetchPins(model_ob)};var __handleSocketConnected=function(){if(_previously_connected){_have_pins_been_fetched={};_are_pins_currently_being_fetched={}}else{_previously_connected=true}};var _handleLeftChannelOrGroup=function(){var model_ob=TS.shared.getActiveModelOb();delete _have_pins_been_fetched[model_ob.id];delete _are_pins_currently_being_fetched[model_ob.id]}})();(function(){"use strict";TS.registerModule("ui.toggle",{onStart:function(){$('input[type="checkbox"][data-style="toggle"]').each(function(){$(this).togglify()})},togglify:function($checkbox,settings){if(settings){settings=_.defaults({},settings,_default_settings)}else{settings={};settings.initial_state=$checkbox.data("initial_state")?$checkbox.data("initial_state"):_default_settings.initial_state;settings.label=$checkbox.data("label")?$checkbox.data("label"):_default_settings.label;settings.on_class=$checkbox.data("on-class")?$checkbox.data("on-class"):_default_settings.on_class;settings.on_text=$checkbox.data("on-text")?$checkbox.data("on-text"):_default_settings.on_text;settings.off_text=$checkbox.data("off-text")?$checkbox.data("off-text"):_default_settings.off_text;settings.off_class=$checkbox.data("off-class")?$checkbox.data("off-class"):_default_settings.off_class;settings.off_label=$checkbox.data("off-label")?$checkbox.data("off-label"):_default_settings.off_label;settings.disabled=$checkbox.data("disabled")?$checkbox.data("disabled"):_default_settings.disabled;settings.cls=$checkbox.data("cls")?$checkbox.data("cls"):_default_settings.cls}if(settings.initial_state===null){settings.initial_state=$checkbox.is(":checked")?true:false}if(settings.disabled===null){settings.disabled=$checkbox.is(":disabled")?true:false}_create($checkbox,settings);return $checkbox}});var _default_settings={cls:"",initial_state:null,label:"",on_text:"On",on_class:"",off_text:"Off",off_class:"",off_label:"",disabled:null};var _create=function($checkbox,settings){var $el_to_hide=$checkbox;var $label=$checkbox.closest("label");if($label.length){$el_to_hide=$label;var label_text=$.trim($label.text());if(label_text&&settings.label===_default_settings.label&&settings.off_label===_default_settings.off_label){settings.label=label_text}}var html=_build(settings);var $toggle=$(html);$el_to_hide.addClass("hidden").after($toggle);$toggle.on("click",function(){$(this).toggleClass("checked");$checkbox.prop("checked",$(this).hasClass("checked")).trigger("change");if(settings.on_class!==settings.off_class){$(this).toggleClass(settings.on_class,$(this).hasClass("checked"));$(this).toggleClass(settings.off_class,!$(this).hasClass("checked"))}else if(settings.on_class!==""){TS.warn("TS.ui.toggle: on & off classes are the same. You may want to use the `cls` option instead")}})};var _build=function(settings){var html=TS.templates.toggle({settings:settings});return html}})();$.fn.togglify=function(settings){"use strict";return TS.ui.toggle.togglify($(this),settings)};(function(){"use strict";TS.registerModule("inline_file_previews",{expand_sig:new signals.Signal,collapse_sig:new signals.Signal,onStart:function(){_startTimeAgoInterval()},checkForInlineFilePreviewClick:function(e){var $el=$(e.target);var file_id;var $msg=$el.closest(".message");if($msg.length===0)return;if($el.hasClass("service_link")||$el.closest(".service_link")>0)return;var container_id=$msg.attr("id");var $msg_inline_file_preview_toggler=$el.closest(".msg_inline_file_preview_toggler");if($msg_inline_file_preview_toggler.length>0){e.preventDefault();file_id=$msg_inline_file_preview_toggler.data("file-id");if($msg_inline_file_preview_toggler.hasClass("collapsed")){_inlineExpand(container_id,file_id)}else{_inlineCollapse(container_id,file_id)}return true}var $container=$el.closest(".inline_file_preview_container, .file_container");if($container.length===0)return;if($el.closest(".preview_show.preview_show_more").length>0){e.preventDefault();_expandContent(e,$msg,$container);return true}if($el.closest(".preview_show.preview_show_less .preview_show_btn, .preview_show_less_header").length>0){e.preventDefault();_collapseContent(e,$msg,$container);return true}if($el.closest("a").length)return false;file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return false;if(file.mode==="space"||file.mode==="post"||file.mode=="multnomah"||file.mode==="email"||file.mode==="snippet"){if($container.hasClass("inline_collapsed")){e.preventDefault();_expandContent(e,$msg,$container);return true}}return false},shouldTruncate:function(file){if(!file)return false;if(file.mode==="snippet"){if(file.lines_more>0||file.preview_is_truncated)return true}else if(file.mode==="post"||file.mode==="space"){if(!file.preview)return false;if(file.preview.length>=400)return true;if(file.preview.split(" ").length>=50)return true;if(file.preview.split("\n").length>=4)return true;var closing_tags=file.preview.match(/<\/(?:h\d|p|li|pre|blockquote)>/g)||[];var only_start_tags=file.preview.match(/<hr>/g)||[];var tags=closing_tags.concat(only_start_tags);if(tags.length>=4)return true}else if(file.mode==="email"){return true}return false},isTruncated:function(msg_id,file){if(!file)return false;return!_expanded_content_state[msg_id+"_"+file.id]},expandableState:function(container_id,file_id){if(TS.model.expandable_state["inline_file_"+container_id+file_id])return true;if(TS.model.expandable_state["inline_file_"+container_id+file_id]===false)return false},shouldExpand:function(container_id,file_id){var expandable_state=TS.inline_file_previews.expandableState(container_id,file_id);if(typeof expandable_state==="boolean")return expandable_state;return true},expandAllInCurrent:function(){_no_scrolling=true;$(".msg_inline_file_preview_toggler").each(function(i,el){var $el=$(el);var file_id=$el.data("file-id");var container_id=$el.closest(".message").attr("id");_inlineExpand(container_id,file_id)});_no_scrolling=false;if(TS.client)TS.client.ui.instaScrollMsgsToBottom(false)},collapseAllInCurrent:function(){$(".msg_inline_file_preview_toggler").each(function(i,el){var $el=$(el);var file_id=$el.data("file-id");var container_id=$el.closest(".message").attr("id");_inlineCollapse(container_id,file_id)})},test:function(){return{actuallyExpandContent:_actuallyExpandContent}}});var _expanded_content_state={};var _no_scrolling=false;var _inlineExpand=function(container_id,file_id){TS.model.expandable_state["inline_file_"+container_id+file_id]=true;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var filter=function(){return $(this).data("file-id")==file_id};var $holder=$el.find(".inline_file_preview_container, .file_container").filter(filter);$el.find(".msg_inline_file_title_hider").filter(filter).addClass("hidden");$el.find('.msg_inline_file_preview_toggler[data-file-id="'+file_id+'"]').removeClass("collapsed").addClass("expanded");$holder.removeClass("hidden");if(TS.client)TS.client.ui.checkInlineImgsAndIframesEverywhere();$holder.css("opacity",0).stop().animate({opacity:1},300);if(!_no_scrolling){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false);$holder.scrollintoview({duration:0,offset:"top",px_offset:0,direction:"y"})}else{$holder.scrollintoview({duration:200,offset:"bottom",px_offset:0,direction:"y"})}}TS.inline_file_previews.expand_sig.dispatch(container_id);if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($el)};var _inlineCollapse=function(container_id,file_id){TS.model.expandable_state["inline_file_"+container_id+file_id]=false;TS.storage.storeExpandableState(TS.model.expandable_state);var selector="#"+TS.utility.makeSafeForDomId(container_id);var $el=$(selector);if(!$el.length)return;var filter=function(){return $(this).data("file-id")==file_id};var $holder=$el.find(".inline_file_preview_container, .file_container").filter(filter);$el.find(".msg_inline_file_title_hider").filter(filter).removeClass("hidden");$el.find('.msg_inline_file_preview_toggler[data-file-id="'+file_id+'"]').removeClass("expanded").addClass("collapsed");$holder.addClass("hidden");TS.inline_file_previews.collapse_sig.dispatch(container_id);setTimeout(function(){if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($el)},0)};var _expandContent=function(e,$msg,$container){var file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return;if(file.mode==="post"||file.mode==="space"||file.mode==="snippet"){var $btn=$container.find(".preview_show_more .preview_show_btn");$btn.data("stashed_text",$btn.html()).empty();var spinner=new Spinner({lines:9,length:0,width:4,radius:5,corners:1,rotate:0,direction:1,color:"#ffffff",speed:1,trail:25,shadow:false,hwaccel:false,className:"spinner",zIndex:2e9,top:"-8px",left:"-4px",opacity:.1});spinner.spin($btn.get(0));$container.addClass("loading");TS.files.fetchFileInfo(file_id,function(id,file){spinner.stop();$btn.html($btn.data("stashed_text"));$container.removeClass("loading");if(file.content_html||file.content_highlight_html)_actuallyExpandContent($msg,file);TS.utility.welcome_post.clogWelcomePostExpand(file)})}else if(file.mode==="email"){if(file.simplified_html){_actuallyExpandContent($msg,file)}else{$msg.find(".email_content").addClass("loading");var expand_timeout=setTimeout(function(){$msg.find(".inline_file_preview_container, .file_container").addClass("expanded")},1e3);TS.files.fetchFileInfo(file_id,function(id,fetched_file){clearTimeout(expand_timeout);_actuallyExpandContent($msg,fetched_file);$msg.find(".email_content").removeClass("loading")})}}};var _actuallyExpandContent=function($msg,file){var container_id=$msg.attr("id");var state_id=container_id+"_"+file.id;_expanded_content_state[state_id]=true;$msg.find(".inline_file_preview_container, .file_container").removeClass("inline_collapsed").addClass("inline_expanded");TS.inline_file_previews.expand_sig.dispatch($msg);if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($msg)};var _collapseContent=function(e,$msg,$container){var ts=$msg.attr("id");var file_id=$container.data("file-id");var file=TS.files.getFileById(file_id);if(!file)return;var state_id=ts+"_"+file_id;delete _expanded_content_state[state_id];$msg.find(".inline_file_preview_container, .file_container").removeClass("inline_expanded").addClass("inline_collapsed");if(!_no_scrolling){$msg.scrollintoview({duration:0,offset:"top",px_offset:0,direction:"y"})}TS.inline_file_previews.collapse_sig.dispatch($msg);if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($msg)};var _timeAgoInterval;var _startTimeAgoInterval=function(){if(_timeAgoInterval)clearInterval(_timeAgoInterval);var updater=function(){var $times=$("#msgs_div .file_time_ago");var times=[];$times.each(function(){var file_id=$(this).data("file-id");var file=TS.files.getFileById(file_id);if(!file){times.push($(this).text());return}times.push(TS.utility.date.toTimeAgo(file.updated));file=null});$times.each(function(index,element){$(element).text(times[index]);element=null});$times=null};updater=TS.utility.throttleFunc(updater,5e3);_timeAgoInterval=setInterval(updater,6e4)}})();(function(){"use strict";TS.registerModule("rxns",{rxn_records_changed_sig:new signals.Signal,member_rxns_fetched_sig:new signals.Signal,member_rxns_being_fetched_sig:new signals.Signal,need_alerts:{},onStart:function(){if(!TS.client)return;TS.prefs.team_handy_rxns_changed_sig.add(_updateAllRxnsUI);TS.prefs.channel_handy_rxns_changed_sig.add(_updateAllRxnsUI);TS.prefs.preferred_skin_tone_changed_sig.add(_updateAllRxnsUI);TS.prefs.emoji_mode_changed_sig.add(_updateAllRxnsUI);_dispatchSignalThrottled=function(){};var _throttledUpdateUI=function(){};TS.client.login_sig.add(function(){_dispatchSignalThrottled=TS.utility.throttleFunc(_dispatchSignal,100);_throttledUpdateUI=TS.utility.throttleFunc(_updateUI,1e3)});_updateUIThrottled=function(rxn_key,item_type){_throttledUpdateUI(rxn_key,undefined,undefined,item_type)}},upsertRxnsFromDataAndUpdateUI:function(rxn_key,rxns){var upsert=_upsertRxnsFromData(rxn_key,rxns);if(upsert.status!="NOOP"){_updateUIThrottled(rxn_key)}return upsert},getRxnKey:function(type,id,c_id){if(type=="message"&&!c_id)TS.error("getRxnKey: no c_id provided for message rxn_key");if(type!="message"&&c_id)TS.error("getRxnKey: c_id provided for but this is not a message rxn_key");return type+"-"+id+"-"+(c_id||"")},getRxnKeyByMsgType:function(msg){var rxn_key;if(msg.subtype=="file_upload"||msg.subtype=="file_share"||msg.subtype=="file_mention"||msg.subtype=="file_reaction"){if(msg.file)rxn_key=msg.file._rxn_key}else if(msg.subtype=="file_comment"){if(msg.comment)rxn_key=msg.comment._rxn_key}else{rxn_key=msg._rxn_key}return rxn_key},getRxnKeyFromData:function(item){var id;if(item.type=="message"){id=item.ts||item.message.ts}else if(item.type=="file"){id=item.file.id||item.file}else if(item.type=="file_comment"){id=item.file_comment||item.comment.id}else{throw"item.type not handled"}return TS.rxns.getRxnKey(item.type,id,item.channel)},getExistingRxnsByKey:function(rxn_key){return _rxns[rxn_key]||null},getRxnRecordByKey:function(rxn_key){if(_rxn_records_map[rxn_key])return _rxn_records_map[rxn_key];for(var i=_rxn_records.length-1;i>-1;i--){if(_rxn_records[i].rxn_key===rxn_key){_rxn_records_map[rxn_key]=_rxn_records[i];return _rxn_records_map[rxn_key]}}return null},getNextRxnRecordThatNeedsAlert:function(){var candidate;for(var i=_rxn_records.length-1;i>-1;i--){if(TS.rxns.need_alerts[_rxn_records[i].rxn_key]){candidate=_rxn_records[i]}else{break}}return candidate},getRxnsFromData:function(item){if(item.type=="message")return item.message&&item.message.reactions;if(item.type=="file")return item.file&&item.file.reactions;if(item.type=="file_comment")return item.comment&&item.comment.reactions;return null},doesRxnsHaveRxnFromMember:function(rxns,name,member_id){name=TS.emoji.nameToCanonicalName(name);if(!rxns)return false;var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(!rxn)return false;if(!rxn.count)return false;if(!rxn.users)return false;return rxn.users.indexOf(member_id)!=-1},doesRxnsHaveRxnFromUser:function(rxns,name){return TS.rxns.doesRxnsHaveRxnFromMember(rxns,name,TS.model.user.id)},doesRxnsHaveRxn:function(rxns,name){if(!rxns)return false;return!!TS.rxns.getRxnFromRxns(rxns,name)},doesRxnsHaveSkinlessRxn:function(rxns,name){if(!rxns)return false;var names=[name.replace(/(\::skin-tone-[2-6])/,"")];TS.emoji.spliceSkinToneVariationsIntoAnArrayOfEmojiNames(names);for(var i=0;i<names.length;i++){if(TS.rxns.getRxnFromRxns(rxns,names[i]))return true}return false},countAllRxns:function(rxns){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){t+=rxn.count||0});return t},countAllEmoji:function(rxns){if(!rxns)return 0;return rxns.length},countAllUsersRxns:function(rxns,user_id){if(!rxns)return 0;var t=0;rxns.forEach(function(rxn){if(rxn.users.indexOf(user_id)>-1){t++}});return t},getAllUniqueRxners:function(rxns,except){if(!rxns)return[];var rxners=[];rxns.forEach(function(rxn){if(!rxn)return;if(!rxn.count)return;if(!rxn.users)return;rxn.users.forEach(function(member_id){if(except==member_id)return;if(rxners.indexOf(member_id)!=-1)return;rxners.push(member_id)})});return rxners},getRxnFromRxns:function(rxns,name){if(!rxns)return null;return rxns.filter(function(val){return val.name==name})[0]||null},changeRxnsFromIMsg:function(imsg){if(!imsg.item)return;var simple_format=false;if(imsg.item.type=="message"&&imsg.item.ts){simple_format=true}else if(imsg.item.type=="file"&&typeof imsg.item.file=="string"){simple_format=true}else if(imsg.item.type=="file_comment"&&imsg.item.file_comment&&typeof imsg.item.file=="string"){simple_format=true}if(!simple_format)return;if(!_isReactionItemRelevant(imsg.item))return;var by_self=imsg.user==TS.model.user.id;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);var new_rxns;var adding=imsg.type=="reaction_added";new_rxns=_addOrRemoveRxnFromRxns(adding,_.cloneDeep(existing_rxns)||[],imsg.reaction,imsg.user);var upsert=_upsertRxnsFromData(rxn_key,new_rxns);TS.dir(888,upsert,"handleRxnChangeFromMS upsert status:"+upsert.status);_maybeUpdateRxnRecords(imsg);if(upsert.status=="NOOP")return;if(by_self&&!imsg._from_evt_log){_updateUI(rxn_key,imsg.reaction,imsg.user,imsg.item.type)}else{_updateUIThrottled(rxn_key,imsg.item.type)}},changeRxnsFromUserAction:function(rxn_key,name,adding){name=TS.emoji.nameToCanonicalName(name);TS.log(888,"changeRxnsFromUserAction rxn_key:"+rxn_key+" name:"+name+" adding:"+adding);if(adding&&!TS.emoji.isValidName(name)){TS.error('"'+name+'" is not a valid emoji');return}if(adding&&TS.boot_data.feature_thanks&&TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key).is_poll){_removeAllRxnsFromUser(rxn_key)}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];if(adding){var emoji_cnt=TS.rxns.countAllEmoji(existing_rxns);var rxns_cnt=TS.rxns.countAllUsersRxns(existing_rxns,TS.model.user.id);if(emoji_cnt>=50&&!TS.rxns.doesRxnsHaveRxn(existing_rxns,name)){_displayTooManyError(TOO_MANY_EMOJI);return}else if(rxns_cnt>=20){_displayTooManyError(TOO_MANY_REACTIONS);return}}var new_rxns=_addOrRemoveUserRxnFromRxns(adding,_.cloneDeep(existing_rxns),name);TS.dir(888,existing_rxns,"existing_rxns");TS.dir(888,new_rxns,"new_rxns");var upsert=_upsertRxnsFromUserAction(rxn_key,new_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.error("changeRxnsFromUserAction called but no NOOP?");return}_updateUI(rxn_key,name,TS.model.user.id);var method=adding?"reactions.add":"reactions.remove";var api_args=_getApiArgsFromKey(rxn_key,{name:name});var payload={};var clog_key=adding?"REACTION_ADDED":"REACTION_REMOVED";if(TS.model.unread_view_is_showing&&api_args.timestamp){_.merge(payload,TS.client.ui.unread.getTrackingData(api_args.timestamp));TS.client.ui.unread.incrementTrackingSeqId()}TS.clog.track(clog_key,payload);_incrementPendingCnt(rxn_key);TS.api.call(method,api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);var update_ui=false;if(ok){if(adding)TS.prefs.recordEmojiUse(":"+args.name+":")}else if(!adding&&data.error&&data.error=="no_reaction"){}else{if(data.error==TOO_MANY_EMOJI||data.error==TOO_MANY_REACTIONS){_displayTooManyError(data.error)}else if(data.error==INVALID_NAME){TS.warn("Attempted to add/remove invalid emoji and the API complained: "+args.name)}var current_rxns=TS.rxns.getExistingRxnsByKey(rxn_key)||[];var undone_rxns=_addOrRemoveUserRxnFromRxns(!adding,_.cloneDeep(current_rxns),name);var upsert=_upsertRxnsFromUserAction(rxn_key,undone_rxns);TS.dir(888,upsert,"changeRxnsFromUserAction UNDO upsert status:"+upsert.status);if(upsert.status=="NOOP"){TS.log(888,"changeRxnsFromUserAction trying to undo because of API rsp, but no NOOP?")}else{update_ui=true}}var maybeUpdateModel=function(){TS.log(888,"maybeUpdateModel pending:"+_pending_counts[rxn_key]+" _pending_last:"+_pending_last[rxn_key]);if(_pending_counts[rxn_key])return false;if(!_pending_last.hasOwnProperty(rxn_key))return false;var upsert=_upsertRxnsFromUserAction(rxn_key,_pending_last[rxn_key]);delete _pending_last[rxn_key];TS.dir(888,upsert,"maybeUpdateModel status:"+upsert.status);if(upsert.status=="NOOP")return false;_updateUI(rxn_key);_fetchAndUpdateRxns(rxn_key);return true};if(!maybeUpdateModel()&&!update_ui)return;_updateUI(rxn_key)})},checkForRxnClick:function(e){if(!e||!e.target)return;var $el=$(e.target);var $rxn=$el.closest(".rxn");if(!$rxn.length)return;var name=String($rxn.data("emoji"));var $rxn_panel=$el.closest(".rxn_panel");var rxn_key=$rxn_panel.data("rxn-key");var is_handy=$rxn.hasClass("is_handy");var adding;if($rxn.hasClass("menu_rxn")){TS.menu.emoji.start({e:e,rxn_key:rxn_key})}else{adding=!$rxn.hasClass("user_reacted");if(!adding&&e.shiftKey){_removeAllRxnsFromUser(rxn_key)}else{var suffix=is_handy&&TS.emoji.isNameSkinToneModifiable(name)?":"+TS.emoji.getChosenSkinToneModifier():"";TS.rxns.changeRxnsFromUserAction(rxn_key,name+suffix,adding)}}},getRxnRecords:function(){return _rxn_records},getRxnKeyParts:function(rxn_key){var keyA=rxn_key.split("-");return{type:keyA[0],id:keyA[1],c_id:keyA[2]}},test:function(){return{updateUI:_updateUI,addOrRemoveRxnFromRxns:_addOrRemoveRxnFromRxns,upsertRxnsFromData:_upsertRxnsFromData,upsertRxns:_upsertRxns,incrementPendingCnt:_incrementPendingCnt,decrementPendingCnt:_decrementPendingCnt,fetchAndUpdateRxns:_fetchAndUpdateRxns,displayTooManyError:_displayTooManyError}},clearHandyRxnsDisplayDataCache:function(){_handy_rxns_dd={}},getHandyRxnsDisplayDataByCidAndMsgId:function(c_id,msg_id){var scope=c_id||"team";var handy_rxns;if(c_id&&msg_id&&TS.boot_data.feature_thanks){var msg=TS.utility.msgs.getMsg(msg_id,TS.shared.getModelObById(c_id).msgs);if(msg&&msg._handy_rxns_poll_data){scope=c_id+"-"+msg_id;handy_rxns=msg._handy_rxns_poll_data}}if(_handy_rxns_dd[scope]){return _handy_rxns_dd[scope]}handy_rxns=handy_rxns||TS.rxns.getHandyRxnsByCidAndMsgId(c_id,msg_id,TS.model.team.prefs.team_handy_rxns);if(!handy_rxns){return{list:[],restrict:false,is_poll:false}}_handy_rxns_dd[scope]={items:{},restrict:!!handy_rxns.restrict,is_poll:!!handy_rxns.is_poll};handy_rxns.list.forEach(function(item){var suffix=TS.emoji.isNameSkinToneModifiable(item.name)?TS.emoji.getChosenSkinToneModifier():"";var name_with_colons=":"+item.name+":"+suffix;_handy_rxns_dd[scope].items[item.name]={html:new Handlebars.SafeString(TS.emoji.graphicReplace(name_with_colons,{no_skin_tone_squares:true})),name:name_with_colons,title:item.title,use_title:TS.boot_data.feature_thanks&&item.title&&item.title!=item.name,names:name_with_colons}});return _handy_rxns_dd[scope]},getHandyRxnsDisplayDataByRxnKey:function(rxn_key){rxn_key=rxn_key||"";var key_parts=TS.rxns.getRxnKeyParts(rxn_key);var c_id=key_parts.c_id||"";var msg_id=key_parts.type=="message"&&key_parts.id;return TS.rxns.getHandyRxnsDisplayDataByCidAndMsgId(c_id,msg_id)},getHandyRxnsByCidAndMsgId:function(c_id,msg_id,fallback){fallback=fallback||null;if(c_id&&msg_id&&TS.boot_data.feature_thanks){var msg=TS.utility.msgs.getMsg(msg_id,TS.shared.getModelObById(c_id).msgs);if(msg&&msg._handy_rxns_poll_data)return msg._handy_rxns_poll_data}var pref=TS.model.team.prefs.channel_handy_rxns;return pref&&pref[c_id]&&Object.keys(pref[c_id]).length&&pref[c_id]||fallback},getHandyRxnsTitleForEmojiByRxnKey:function(name,rxn_key){name=TS.emoji.stripWrappingColons(name).replace(/(\:\:skin-tone-[2-6])/g,"");var datum=TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key).items[name];return datum&&datum.use_title&&datum.title||""}});var _handy_rxns_dd={};var _rxn_records=[];var _rxn_records_map={};var _rxns={};var _pending_counts={};var _pending_last={};var _updateUI=function(rxn_key,name,member_id,item_type){var can_ignore_scroll;var rxn_key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(rxn_key_parts&&rxn_key_parts.c_id){var current_model_ob=TS.shared.getActiveModelOb();if(current_model_ob&&current_model_ob.id!==rxn_key_parts.c_id){if(TS.pri)TS.log(888,"rxn c_id of "+rxn_key_parts.c_id+" != current model_ob id of "+current_model_ob.id+" - skipping scroll work.");can_ignore_scroll=true}}var was_at_bottom;if(!can_ignore_scroll)was_at_bottom=TS.client&&TS.client.ui&&TS.client.ui.areMsgsScrolledToBottom();TS.templates.builders.updateRxnPanels(rxn_key,name,member_id);if(TS.boot_data.feature_file_reactions_activity&&item_type==="file"){TS.log("(Temporary) Rebuilding mentions due to file reaction.");TS.view.rebuildMentions()}if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(true)}};var _updateUIThrottled=function(rxn_key,item_type){_updateUI(rxn_key,undefined,undefined,item_type)};var _addOrRemoveUserRxnFromRxns=function(adding,rxns,name){return _addOrRemoveRxnFromRxns(adding,rxns,name,TS.model.user.id)};var _addOrRemoveRxnFromRxns=function(adding,rxns,name,member_id){var rxn=TS.rxns.getRxnFromRxns(rxns,name);if(adding){if(!rxn){rxns.push({users:[member_id],count:1,name:name})}else{if(TS.utility.ensureInArray(rxn.users,member_id)){rxn.count++}}}else{if(rxn){var rxn_exists=rxn.users.indexOf(member_id)>=0;if(rxn_exists){_.pull(rxn.users,member_id);rxn.count--;if(rxn.count<1||rxn.users.length===0){_.pull(rxns,rxn)}if(!rxns.length){rxns=null}}}}return rxns};var _upsertRxnsFromUserAction=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,true)};var _upsertRxnsFromData=function(rxn_key,rxns){return _upsertRxns(rxn_key,rxns,false)};var _upsertRxns=function(rxn_key,rxns,force){var upsert={status:"NOOP",what_changed:[],rxns:rxns};if(!force&&_pending_counts[rxn_key]){_pending_last[rxn_key]=_.cloneDeep(rxns);TS.log(888,"_upsertRxns call ignored because !force && _pending_counts["+rxn_key+"]:"+_pending_counts[rxn_key]);return upsert}var existing_rxns=TS.rxns.getExistingRxnsByKey(rxn_key);if(rxns){if(existing_rxns){if(!TS.utility.areSimpleObjectsEqual(existing_rxns,rxns,"rxn_key:"+rxn_key)){upsert.status="CHANGED";_rxns[rxn_key]=rxns}}else{upsert.status="ADDED";_rxns[rxn_key]=rxns}}else if(existing_rxns){upsert.status="CHANGED";delete _rxns[rxn_key]}upsert.rxns=_rxns[rxn_key]||null;TS.dir(888,upsert,rxn_key);return upsert};var _incrementPendingCnt=function(rxn_key){if(!rxn_key)return;_pending_counts[rxn_key]=_pending_counts[rxn_key]||0;_pending_counts[rxn_key]++;TS.log(888,"_incrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _decrementPendingCnt=function(rxn_key){if(!_pending_counts[rxn_key]){TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key]);return}_pending_counts[rxn_key]--;if(_pending_counts[rxn_key]===0){delete _pending_counts[rxn_key]}TS.log(888,"_decrementPendingCnt "+rxn_key+": "+_pending_counts[rxn_key])};var _getApiArgsFromKey=function(rxn_key,args){args=args||{};var key_parts=TS.rxns.getRxnKeyParts(rxn_key);if(key_parts.type=="message"){args.channel=key_parts.c_id;args.timestamp=key_parts.id}else if(key_parts.type=="file"){args.file=key_parts.id}else if(key_parts.type=="file_comment"){args.file_comment=key_parts.id}else{throw"type not handled"}return args};var _fetchAndUpdateRxns=function(rxn_key,attempt){attempt=attempt||1;var max_attempts=2;var api_args=_getApiArgsFromKey(rxn_key,{full:true});TS.log(888,"_fetchAndUpdateRxns rxn_key:"+rxn_key+" attempt:"+attempt);_incrementPendingCnt(rxn_key);TS.api.call("reactions.get",api_args,function(ok,data,args){_decrementPendingCnt(rxn_key);if(ok){var rxns=TS.rxns.getRxnsFromData(data);var upsert=_upsertRxnsFromData(rxn_key,rxns);TS.dir(888,upsert,"_fetchAndUpdateRxns upsert status:"+upsert.status);
if(upsert.status=="NOOP")return;_updateUI(rxn_key)}else{TS.error("_fetchAndUpdateRxns got an err:"+JSON.stringify(data||null))}if(attempt<max_attempts){_fetchAndUpdateRxns(rxn_key,++attempt)}})};var _getRxnRecordEntryByNameAndMemberId=function(record,name,member_id){if(!record)return null;if(!record.emoji)return null;if(!record.emoji.hasOwnProperty(name))return null;for(var i=0;i<record.emoji[name].length;i++){if(record.emoji[name][i].id===member_id)return record.emoji[name][i]}return null};var _isImsgRelevantToRxnRecords=function(imsg){if(!TS.client)return false;if(imsg.user==TS.model.user.id)return false;if(imsg.item.type=="message"&&typeof imsg.item.message!=="undefined"&&imsg.item.message.user!=TS.model.user.id)return false;if(imsg.item.type=="file"&&typeof imsg.item.file!=="undefined"&&imsg.item.file.user!=TS.model.user.id)return false;if(imsg.item.type=="file_comment"&&typeof imsg.item.comment!=="undefined"&&imsg.item.comment.user!=TS.model.user.id)return false;return true};var _maybeUpdateRxnRecords=function(imsg){if(!_isImsgRelevantToRxnRecords(imsg))return;var rxn_key=TS.rxns.getRxnKeyFromData(imsg.item);if(imsg.type=="reaction_added"){if(imsg.item.type=="message"){var source_channel=imsg.item.channel}var and_alert=!imsg._from_evt_log&&imsg.item.type=="message";_addToRxnsRecord(imsg.reaction,rxn_key,imsg.user,imsg.event_ts,and_alert,source_channel)}else{_removeFromRxnsRecord(imsg.reaction,rxn_key,imsg.user)}};var _isReactionItemRelevant=function(item){if(!item)return false;if(item.type=="message"){var msg=TS.utility.msgs.findMsg(item.ts,item.channel);if(!msg)return false;item.message=msg;return true}else if(item.type=="file"||item.type=="file_comment"){var file=TS.files.getFileById(item.file);if(!file)return false;item.file=file;if(item.type=="file_comment"){var comment=TS.files.getFileCommentById(file,item.file_comment);if(!comment)return false;item.comment=comment}return true}return false};var _addToRxnsRecord=function(name,rxn_key,member_id,when,and_alert,source_channel){when=when||TS.utility.date.makeTsStamp();and_alert=!!and_alert;var added=false;var record=_rxn_records_map[rxn_key];if(!record){added=true;record=_rxn_records_map[rxn_key]=_rxn_records[_rxn_records.length]={rxn_key:rxn_key}}record.last_update=when;if(and_alert){TS.rxns.need_alerts[rxn_key]=TS.rxns.need_alerts[rxn_key]||when}record.emoji=record.emoji||{};record.source=source_channel||"";var which=record.emoji[name]=record.emoji.hasOwnProperty(name)&&record.emoji[name]||[];var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id)||(which[which.length]={id:member_id});entry.when=when;TS.dir(877,_rxn_records,name+" "+rxn_key+" "+member_id);var len=_rxn_records.length;if(added&&len>1&&_rxn_records[len-1].last_update<_rxn_records[len-2].last_update){_rxn_records.sort(function compare(a,b){if(a.last_update<b.last_update)return-1;if(a.last_update>b.last_update)return 1;return 0})}_dispatchSignalThrottled(and_alert)};var _dispatchSignal=function(and_alert){TS.rxns.rxn_records_changed_sig.dispatch(and_alert)};var _dispatchSignalThrottled=function(){_dispatchSignal()};var _removeFromRxnsRecord=function(name,rxn_key,member_id){var record=TS.rxns.getRxnRecordByKey(rxn_key);var entry=_getRxnRecordEntryByNameAndMemberId(record,name,member_id);if(entry&&record){_.pull(record.emoji[name],entry);if(!record.emoji[name].length){delete record.emoji[name]}if(!Object.keys(record.emoji).length){delete _rxn_records_map[rxn_key];_.pull(_rxn_records,record)}}TS.rxns.rxn_records_changed_sig.dispatch()};var _displayTooManyError=function(error){var reaction_limit_reached_title=TS.i18n.t("Reaction Limit Reached","rxns")();var too_many_reactions=TS.i18n.t("A message can contain up to 20 different emojis from a single person. Sorry, you cant add any more than this!","rxns")();var too_many_emoji=TS.i18n.t("A message can contain up to 50 different emojis in its reactions. Sorry, you cant add any more than this!","rxns")();if(error==TOO_MANY_REACTIONS){TS.generic_dialog.alert(too_many_reactions,reaction_limit_reached_title)}else if(error==TOO_MANY_EMOJI){TS.generic_dialog.alert(too_many_emoji,reaction_limit_reached_title)}else{return}};var _updateAllRxnsUI=function(){$(".msgs_holder").find("ts-message").each(function(){var $msg_el=$(this);var rxn_key=$msg_el.find(".rxn_panel").data("rxn-key")||"";TS.ui.messages.maybeUpdateMessageHoverContainer($msg_el);TS.templates.builders.updateRxnPanelsAndHandyRxns(rxn_key)})};var TOO_MANY_REACTIONS="too_many_reactions";var TOO_MANY_EMOJI="too_many_emoji";var INVALID_NAME="invalid_name";var _removeAllRxnsFromUser=function(rxn_key){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);if(!rxns)return;rxns.forEach(function(rxn){if(!TS.rxns.doesRxnsHaveRxnFromUser(rxns,rxn.name))return;TS.rxns.changeRxnsFromUserAction(rxn_key,rxn.name,false)})}})();(function(){"use strict";TS.registerModule("ui.new_channel_modal",{onStart:function(){},start:function(title,is_public,preselected_ids){if(!TS.members.canUserCreateChannels()&&!TS.members.canUserCreateGroups())return;TS.ui.fs_modal.start({body_template_html:'<div id="new_channel_modal_container"></div>',onShow:_onShow,onEnd:_onEnd});_$modal_container=$("#new_channel_modal_container");return TS.ui.new_channel_modal.startInContainer(_$modal_container,title,is_public,preselected_ids)},startInContainer:function($container,title,is_public,preselected_ids){if(!TS.members.canUserCreateChannels()&&!TS.members.canUserCreateGroups())return;_$modal_container=$container;_is_public=is_public!==false;if(!TS.members.canUserCreateChannels())_is_public=false;if(!TS.members.canUserCreateGroups())_is_public=true;var can_toggle_private=TS.members.canUserCreateChannels()&&TS.members.canUserCreateGroups();title=TS.utility.cleanChannelName(title||"").substr(0,TS.model.channel_name_max_length);preselected_ids=preselected_ids||[];var members_you_can_invite=TS.groups.getActiveMembersForInviting(TS.model.user.is_admin);members_you_can_invite=members_you_can_invite.filter(function(member){return member._is_local});var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(members_you_can_invite,preselected_ids);_$modal_container.html(TS.templates.channel_new_modal({title:title,is_public:_is_public,can_toggle_private:can_toggle_private,compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start,is_ra:TS.model.user.is_restricted}));_ladda=Ladda.create(_$modal_container.find(".new_channel_go")[0]);invite_members.sort(function(a,b){return TS.members.memberSorterByName(a.member,b.member)});_bindUI(invite_members);if(TS.model.user.is_admin){TS.api.call("users.admin.invited").then(function(resp){var pending_invites=TS.pending_users.filterOutURAs(resp.data.pending);if(_$modal_container&&pending_invites.length){pending_invites.forEach(function(invitee){TS.pending_users.sanitizeNameFields(invitee)});invite_members=invite_members.concat(pending_invites).sort(function(a,b){return TS.pending_users.usersSorterByName(a,b)});_updateFilterSelect(invite_members)}})}return new Promise(function(resolve,reject){_deferred={resolve:resolve,reject:reject}})},go:function(){var validated=TS.ui.validation.validate(_$modal_container.find(".title_input"),{});if(!validated)return;validated=TS.channels.ui.channelCreateDialogCleanName(_$modal_container);if(!validated)return;var title=_$modal_container.find(".title_input").val();var invited_members=$("#invite_members_container").lazyFilterSelect("value");var invited_member_ids=[];var pending_users=[];if(invited_members){invited_members.forEach(function(item){if(item.member){invited_member_ids.push(item.member.id)}else{pending_users.push(item)}})}var purpose=$.trim(_$modal_container.find("#channel_purpose_input").val());if(_ladda)_ladda.start();if(_is_public){_createPublicChannel(title,purpose,invited_member_ids,pending_users)}else{_createPrivateChannel(title,purpose,invited_member_ids,pending_users)}},end:function(){_cleanup()},test:function(){return{createPublicChannel:_createPublicChannel,createPrivateChannel:_createPrivateChannel,showNameTakenAlert:_showNameTakenAlert}}});var _$modal_container;var _ladda;var _is_public;var _deferred;var _bindKeyboardShortcuts=function(){var people_picker_input=_$modal_container.find("#invite_members_container").find("input")[0];var purpose_input=_$modal_container.find("#channel_purpose_input")[0];_$modal_container.on("keydown",function(e){if(e.which===TS.utility.keymap.enter&&document.activeElement!=people_picker_input&&document.activeElement!=purpose_input){TS.ui.new_channel_modal.go();e.preventDefault()}else if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close();e.preventDefault()}})};var _bindPublicPrivateToggle=function(){var $toggle=$("#channel_public_private_toggle");$toggle.togglify();$toggle.bind("change",function(){_is_public=$toggle.is(":checked");if($toggle.is(":checked")){_$modal_container.find(".private_channel_item").addClass("hidden");_$modal_container.find(".public_channel_item").removeClass("hidden")}else{_$modal_container.find(".public_channel_item").addClass("hidden");_$modal_container.find(".private_channel_item").removeClass("hidden")}})};var _bindFilterSelect=function(members){var prev_query;var start_regex;var suffix_regex;$("#invite_members_container").lazyFilterSelect({append:true,data:members,per_page:50,approx_item_height:50*TS.utility.getA11yFontSizeMultiplier(),placeholder_text:"Search by name",template:function(item){var html;if(item.member){html=TS.templates.channel_invite_member_small({member:item.member})}else{html=TS.templates.channel_invite_pending_user_small({invitee:item})}return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html;if(item.member){html=TS.templates.channel_invite_member_token({member:item.member})}else{html=TS.templates.channel_invite_pending_user_token({invitee:item})}return new Handlebars.SafeString(html)},tokenClass:function(item){if(item.member){return TS.templates.builders.getMemberTypeClass(item.member)}else{return"lfs_token_pending_user"}},filter:function(item,query){var member=item.member;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}var match_names_only=true;if(member){return TS.utility.members.checkMemberMatch(member,start_regex,match_names_only)||TS.utility.members.checkMemberMatch(member,suffix_regex,match_names_only)}else{return TS.pending_users.checkUserMatch(item,start_regex)||TS.pending_users.checkUserMatch(item,suffix_regex)}},noResultsTemplate:function(query){if(!query){return"No one found"}else{return"No one found matching <strong>"+TS.utility.truncateAndEscape(query,50)+"</strong>"}}})};var _bindUI=function(members){_bindFilterSelect(members);_$modal_container.find(".new_channel_go").click(TS.ui.new_channel_modal.go);_bindKeyboardShortcuts();_bindPublicPrivateToggle();_$modal_container.find(".title_input").keydown(function(e){_$modal_container.find(".modal_input_note.mustard_yellow").each(function(){$(this).addClass("hidden")})});$("#channel_create_title").focus();_$modal_container.find(".new_channel_cancel_btn").on("click",function(e){TS.ui.fs_modal.close()});var $button=$("#save_channel");var $input=$("#channel_create_title");function inputChange(){var value=$input.val();if(value&&value.length){TS.utility.disableElement($button,false)}else{TS.utility.disableElement($button,true)}}if($button.length&&$input.length){$input.on("input",inputChange);inputChange()}};var _createPublicChannel=function(title,purpose,invited_members,pending_users){TS.channels.join(title,function(ok,data,args){if(_ladda)_ladda.stop();if(!ok){if(data.error=="name_taken"){_showNameTakenAlert()}else if(data.error=="restricted_action"){_showError("Sorry! An admin on your team has restricted who can create public channels.")}else{TS.error("Failed to create public channel: "+data.error);_showError("Sorry! Something went wrong.")}return}if(purpose)TS.channels.setPurpose(data.channel.id,purpose);if(invited_members){for(var i=0;i<invited_members.length;i++){TS.api.call("channels.invite",{channel:data.channel.id,user:invited_members[i]})}}if(pending_users&&pending_users.length){TS.pending_users.invitePendingUsersToChannel(pending_users,data.channel.id)}var resolve=_deferred&&_deferred.resolve;TS.ui.fs_modal.close();if(resolve)resolve(data.channel)})};var _createPrivateChannel=function(title,purpose,invited_members,pending_users){TS.groups.create(title,invited_members,function(ok,data,args){if(_ladda)_ladda.stop();if(!ok){if(data.error=="name_taken"){_showNameTakenAlert()}else if(data.error=="restricted_action"){_showError("Sorry! An admin on your team has restricted who can create private channels.")}else{TS.error("Failed to create private channel: "+data.error);_showError("Sorry! Something went wrong.")}return}if(purpose)TS.groups.setPurpose(data.group.id,purpose);if(pending_users&&pending_users.length){TS.pending_users.invitePendingUsersToChannel(pending_users,data.group.id)}var resolve=_deferred&&_deferred.resolve;TS.ui.fs_modal.close();if(resolve)resolve(data.group)})};var _updateFilterSelect=function(members){var lfs_id_count=0;members.forEach(function(member){member.lfs_id=lfs_id_count});$("#invite_members_container").lazyFilterSelect("update",members)};var _showNameTakenAlert=function(){TS.channels.ui.channelCreateDialogShowNameTakenAlert(_$modal_container)};var _showError=function(message){TS.channels.ui.channelCreateDialogShowOtherErrorAlert(_$modal_container,message)};var _unbindUI=function(){if(_$modal_container){_$modal_container.find(".new_channel_go").off("click");_$modal_container.find("#channel_public_private_toggle").off("change");_$modal_container.off("keydown")}};var _onShow=function(){};var _onEnd=function(){_cleanup()};var _cleanup=function(){_unbindUI();_$modal_container=null;_ladda=null;_deferred=null}})();(function(){"use strict";TS.registerModule("ui.lazy_filter_select",{onStart:function(){$("select[data-lazy-filter-select], label[data-lazy-filter-select] select").addClass("hidden").lazyFilterSelect({use_data_attributes:true})},create:function($select,settings){if(settings.use_data_attributes){var settings_keys=Object.keys($select.data());settings_keys.forEach(function(setting_key){if(setting_key.indexOf("lazyFilterSelect")>-1&&setting_key!=="TS-lazyFilterSelect"&&$select.data(setting_key)!==""){var setting=$select.data(setting_key);if(setting==="true"||setting==="false")setting=setting==="true";settings[setting_key.replace("lazyFilterSelect","").toLowerCase()]=setting}})}if($select.prop("tagName")==="SELECT"){if(typeof settings.single==="undefined"){settings.single=!$select.prop("multiple")}}var instance=$.extend({},_DEFAULT_SETTINGS,settings);if(settings.approx_divider_height===undefined){instance.approx_divider_height*=TS.utility.getA11yFontSizeMultiplier()}if(settings.approx_item_height===undefined){instance.approx_item_height*=TS.utility.getA11yFontSizeMultiplier()}var $container=$('<div class="lazy_filter_select">');if(instance.classes)$container.addClass(instance.classes);if($select.prop("disabled"))instance.disabled=true;if(instance.disabled)$container.addClass("disabled");var html=TS.templates.lazy_filter_select_container({instance:instance});$container.html(html);if(instance.append){$container.appendTo($select)}else{$container.insertAfter($select)}if(instance.default_style)$container.addClass("default_style");if(instance.single)$container.addClass("single");if(instance.width)$container.css("width",instance.width);if(instance.css)$container.css(instance.css);instance.$container=$container;instance.$select=$select;instance.$input_container=$container.find(".lfs_input_container");instance.$lfs_value=$container.find(".lfs_value");instance.$input=$container.find(".lfs_input");instance.$list_container=$container.find(".lfs_list_container");instance.$list=$container.find(".lfs_list");instance.$empty=$container.find(".lfs_empty");instance._page_number=1;instance._slug_id_counter=1;instance.run=_run;if(instance.data_promise){if(instance._running_promise)instance._running_promise.cancel("Uhhh...");instance._running_promise=instance.data_promise("").then(function(response){instance._running_promise=null;var data=response;if(data.items)data=data.items;if(typeof response.all_items_fetched!=="undefined")instance._all_done_fetching=!!response.all_items_fetched;if(typeof response.num_remaining!=="undefined"&&response.num_remaining===0)instance._all_done_fetching=true;instance.data=data.slice();instance.run()},function(error){TS.log(null,"Something failed while trying to return the initial promise for lazyFilterSelect.")})}else{if(instance.data)instance.data=instance.data.slice();instance.run()}return instance}});var _DEFAULT_SETTINGS={allow_item_unselect:false,always_visible:false,append:false,approx_divider_height:28,approx_item_height:30,data_promise:null,default_style:true,disabled:false,filter:function(item,query){var text=item.toString();query=query.toLowerCase();if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();var additional_text=$(item).attr("data-additional-search-field");if(additional_text&&additional_text.toLowerCase().indexOf(query)>-1)return true}return text.toLowerCase().indexOf(query)>-1},max_selected_items:Infinity,monkey_scroll:true,no_default_selection:false,noResultsTemplate:function(query){return"No items matched <strong>"+TS.utility.htmlEntities(query)+"</strong>"},onInputBlur:_.noop,onInputFocus:_.noop,onReady:function(){},onItemAdded:function(item){},onItemRemoved:function(item){},onKeyDown:function(e,handled){},onMaxItemsSelected:function(){},placeholder_text:"Search",render_divider_func:null,render_item_func:null,restrict_input_container_height:false,restrict_preselected_item_removal:false,scroll_threshold:1e3,set_height:true,single:false,sluggify:{enabled:false,delimiter:null,key_name:null,validator:null},template:function(item){var text=item.toString();var addl_text;var ts_icon;if(item instanceof jQuery||item instanceof HTMLElement){text=$(item).text();addl_text=TS.utility.htmlEntities($(item).attr("data-additional-search-field"));ts_icon=TS.utility.htmlEntities($(item).attr("data-ts-icon"))}text=TS.utility.htmlEntities(text);if(addl_text)text+=' <span class="addl_text">'+addl_text+"</span>";if(ts_icon)text+=' <ts-icon class="addl_icon '+ts_icon+'"></ts-icon>';return new Handlebars.SafeString(text)},tokenClass:null,tokenTemplate:null,use_data_attributes:false,_$active:null,_all_done_fetching:false,_list_built:false,_list_visible:false,_mouse:{},_page_number:1,_prevent_blur:false,_previous_val:"",_running_promise:null,_scroll_callback_was_called:false};$.widget("TS.lazyFilterSelect",{_create:function(){this.instance=TS.ui.lazy_filter_select.create(this.element,this.options)},_destroy:function(){this.instance.$container.remove();delete this.instance},blur:function(){this.instance.$input.blur()},clearValue:function(){if(this.instance.single){if(this.instance._selected.length){var $item=this.instance.$input_container.find(".lfs_item");_removeSelected(this.instance,$item)}}else{_removeAllSelected(this.instance)}},container:function(){return this.instance.$container},disable:function(){_disable(this.instance)},disabled:function(){return this.instance.disabled},enable:function(){_enable(this.instance)},focus:function(){this.instance.$input.focus()},getInstance:function(){return this.instance},hideList:function(){_hideList(this.instance,true);_hideNoResults(this.instance)},recomputeHeight:function(){_updateMonkeyScroll(this.instance)},setValue:function(val){var prev_selected_index=this.element[0].selectedIndex;this.element.val(val);if(this.element[0].selectedIndex<0){this.element[0].selectedIndex=0}var selected_option=this.element[0].options[this.element[0].selectedIndex];if(this.instance.single){if(this.element[0].selectedIndex==prev_selected_index)return}else{_removeAllSelected(this.instance)}var data_item=_getData(this.instance,$(selected_option));_selectDataItem(this.instance,data_item)},showList:function(){_showList(this.instance)},update:function(data){_update(this.instance,data)},updatePlaceholder:function(text){this.instance.placeholder_text=text;this.instance.$input.prop("placeholder",text)},value:function(){return this.instance._selected}});var _addUserCreatedSlugFromString=function(instance,str){if(!_instanceCanSluggify(instance))return;if(!str.trim())return;if(!_canAddNewItem(instance))return;var item={};item[instance.sluggify.key_name]=str.trim();item.lfs_id=null;item.lfs_slug_id=instance._slug_id_counter;instance._slug_id_counter++;instance._selected.push(item);var slug_html=TS.templates.lazy_filter_select_item({content:instance.tokenTemplate(item),applied_classes:"lfs_token",slug_id:item.lfs_slug_id}).replace(/(\r\n|\n|\r)/gm,"");var $slug=$(slug_html);$slug.insertBefore(instance.$input);if(instance.sluggify.validator){instance.sluggify.validator($slug)}_populate(instance,instance.data);_showList(instance);instance.$input.val("");instance._previous_val="";_adjustInput(instance);instance.onItemAdded(item);if(!_canAddNewItem(instance))instance.onMaxItemsSelected()};var _adjustInput=function(instance){if(!instance.single){instance.$input.prop("size",instance.$input.val().length+1);if(instance.$input.val().length+instance._selected.length===0){_showEmptyState(instance)}else{instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}};var _bindListListeners=function(instance){if(instance.data_promise){instance.$list.on("scroll",function(e){var top=$(this).scrollTop();var list_height=instance.$list.height();var list_items_height=instance.$list.find(".list_items").height();var scroll_mark=list_items_height-top-list_height;if(scroll_mark<=instance.scroll_threshold&&!instance._scroll_callback_was_called&&!instance._all_done_fetching){_callScrollCallback(instance,instance._previous_val,instance._page_number+1);instance._scroll_callback_was_called=true}else if(scroll_mark>instance.scroll_threshold&&instance._scroll_callback_was_called){if(instance._running_promise)instance._running_promise.cancel("User scrolled back and we do not need to add more data");instance._scroll_callback_was_called=false}})}};var _bindUI=function(instance){instance.$input.on("input",function(){var query=$(this).val();if(_instanceCanSluggify(instance)&&query.match(instance.sluggify.delimiter)){var slugs=query.split(instance.sluggify.delimiter);slugs.forEach(function(slug){if(slug.length)_addUserCreatedSlugFromString(instance,slug)})}else{_runQuery(instance,query,true)}});instance.$input.on("keydown",function(e){if(instance.disabled)return;switch(e.keyCode){case TS.utility.keymap.down:_stopThePresses(e);_selectDown(instance);break;case TS.utility.keymap.up:_stopThePresses(e);_selectUp(instance);break;case TS.utility.keymap.enter:if(instance._$active&&instance._$active.length&&instance._list_visible){_stopThePresses(e);var $current_active=instance._$active;if(!instance.single&&instance.allow_item_unselect&&_isAlreadySelected(instance,_getData(instance,$current_active))){_unselectItem(instance,$current_active)}else{if(!_canAddNewItem(instance))return;_selectListItem(instance);if($(this).val()!==""){$(this).val("");instance._previous_val="";_populate(instance)}if(instance.single)_hideList(instance)}}break;case TS.utility.keymap.del:if(instance.$input.val()===""){_stopThePresses(e);var $last_item=instance.$input_container.find(".lfs_token").last();if(_instanceCanSluggify(instance)&&_itemIsUserCreatedSlug($last_item)){_unsluggifySlug(instance,$last_item)}else{_removeLastSelected(instance)}}break;case TS.utility.keymap.tab:if(instance.$input.val().trim()&&_instanceCanSluggify(instance)){_stopThePresses(e);_addUserCreatedSlugFromString(instance,instance.$input.val())}else if(instance.tab_to_nav){_stopThePresses(e);if(e.shiftKey){_selectUp(instance)}else{_selectDown(instance)}}break;case TS.utility.keymap.esc:_stopThePresses(e);_hideList(instance);_hideNoResults(instance);instance.$input.blur();break}instance.onKeyDown(e,e.isDefaultPrevented())});instance.$input.on("blur",function(){if(!instance._prevent_blur){_hideList(instance);_hideNoResults(instance)}if(instance.$input.val().trim()&&_instanceCanSluggify(instance)){_addUserCreatedSlugFromString(instance,instance.$input.val())}});instance.$lfs_value.on("click",function(e){if(instance.disabled)return;e.stopPropagation();_showList(instance);instance._prevent_blur=false});instance.$lfs_value.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$list_container.on("mousemove",".lfs_item",function(e){if(instance.disabled)return;if(e.clientX==instance._mouse.lastX&&e.clientY==instance._mouse.lastY)return;if(instance._$active)instance._$active.removeClass("active");if(!$(this).hasClass("active")&&_selectable($(this))){$(this).addClass("active");instance._$active=$(this)}instance._mouse.lastX=e.clientX;instance._mouse.lastY=e.clientY});instance.$list_container.on("mouseleave",".lfs_item.active",function(e){$(this).removeClass("active");instance._$active=null});instance.$list_container.on("click",".lfs_item",function(e){if(instance.disabled)return;e.preventDefault();instance._$active=$(this);if(!instance.single&&instance.allow_item_unselect&&_isAlreadySelected(instance,_getData(instance,$(this)))){_unselectItem(instance,$(this))}else{var selectable=_selectable($(this));if(!selectable&&!instance.single)return;if(!_canAddNewItem(instance))return;if(!selectable&&instance.single){_hideList(instance);e.stopPropagation();return}if(instance.$input.val()!==""){instance.$input.val("");instance._previous_val="";_populate(instance)}if(instance.single){_hideList(instance);e.stopPropagation()}_selectListItem(instance)}instance._prevent_blur=false});instance.$list_container.on("mousedown",function(e){if(e.which===1)instance._prevent_blur=true});instance.$input.on("focus",function(){if(!instance._input_is_focused){instance._input_is_focused=true;instance.$input_container.click();instance.onInputFocus()}if(!instance.single)instance.$input_container.addClass("active")});instance.$input.on("blur",function(){instance._input_is_focused=false;instance.onInputBlur()});instance.$input_container.on("focus",function(){instance.$input_container.click();instance.$input.focus()});instance.$input_container.on("click",".lfs_token",function(e){if(instance.disabled)return;_removeSelected(instance,$(this));instance._prevent_blur=false});instance.$input_container.on("mousedown",".lfs_token",function(e){if(e.which===1)instance._prevent_blur=true});instance.$container.on("mouseleave",function(e){instance._prevent_blur=false});instance.$container.on("click",function(e){if(instance.disabled)return;_showList(instance)});instance.$container.parents("label").on("click",function(e){if(instance.disabled)return;e.preventDefault();_showList(instance)});instance.onReady()};var _buildItem=function(instance,item,token){var $item=$(item);var selected=_isAlreadySelected(instance,item);var disabled=item.disabled||item.lfs_disabled;if(instance.restrict_preselected_item_removal&&item.preselected)disabled=true;var content;if(token&&_.isFunction(instance.tokenTemplate)){content=instance.tokenTemplate(item)}else{content=instance.template(item)}var class_map={active:instance._previous_val!==""&&!selected&&!disabled,disabled:disabled,lfs_token:token,selected:selected,single:instance.single};if(_.isFunction(instance.tokenClass)){class_map[instance.tokenClass(item)]=true}return TS.templates.lazy_filter_select_item({content:content,icon:$item.data("lfs-item-icon"),desc:$item.data("lfs-item-desc"),applied_classes:TS.utility.getAppliedClasses(class_map),lfs_id:item.lfs_id}).replace(/(\r\n|\n|\r)/gm,"")};var _calculateHeight=function(instance){if(!instance._list_built)return;var list_height=instance.$list.css({"max-height":""}).height();var container_height=instance.$list_container.height();var padding=instance.$list_container.outerHeight()-container_height;var max_height=parseInt(instance.$list_container.css("max-height"),10);var available_height=Math.floor($(window).height()-instance.$list.offset().top);if(isNaN(max_height))max_height=container_height;if(max_height>available_height)max_height=available_height;max_height=max_height-padding;instance.$list.css({"max-height":Math.min(list_height,max_height)})};var _callScrollCallback=function(instance,query,page_number){if(instance._running_promise)instance._running_promise.cancel("Scrolling happened");if(instance._all_done_fetching)return;instance._running_promise=instance.data_promise(query,page_number).then(function(response){instance._running_promise=null;var new_data=response;if(new_data.items)new_data=new_data.items;if(new_data&&new_data.length){instance._page_number++;if(!instance._current_data)instance._current_data=instance.data.slice();if(typeof response.all_items_fetched!=="undefined")instance._all_done_fetching=!!response.all_items_fetched;if(typeof response.num_remaining!=="undefined"&&response.num_remaining===0)instance._all_done_fetching=true;var actual_new_items;var num_new=parseInt(response.num_new,10)||0;actual_new_items=new_data.slice(-num_new);if(actual_new_items.length){if(response._replace_all_items||response.replace_all_items){instance._current_data=actual_new_items}else{instance._current_data=instance._current_data.concat(actual_new_items)}_doAllTheThingsRequiredWithNewData(instance,instance._current_data)}else{instance._all_done_fetching=true}}else{instance._all_done_fetching=true}})};var _canAddNewItem=function(instance){return instance._selected.length<instance.max_selected_items};var _disable=function(instance){if(instance.disabled)return;instance.disabled=true;instance.$container.addClass("disabled");instance.$input.prop("disabled",true)};var _doAllTheThingsRequiredWithNewData=function(instance,data){_prepItems(instance,data);_populate(instance,data);_adjustInput(instance)};var _enable=function(instance){if(!instance.disabled)return;instance.disabled=false;instance.$container.removeClass("disabled");instance.$input.prop("disabled",false)};var _filterGroup=function(instance,query){var data=instance.data;var filtered=[];for(var i=0;i<data.length;i++){var item=data[i];if(item.lfs_group||item.is_divider){var filtered_children=[];for(var j=0;j<item.children.length;j++){var subitem=item.children[j];if(instance.filter(subitem,query))filtered_children.push(subitem)}if(filtered_children.length>0){filtered.push({is_divider:true,lfs_group:true,label:item.label,children:filtered_children})}}else{if(instance.filter(item,query))filtered.push(item)}}return filtered};var _getLfsId=function($item){return $item.attr("data-lfs-id")||$item.prop("lfs_id")||null};var _getData=function(instance,$item,is_already_selected){var lfs_id=_getLfsId($item);var data;if(is_already_selected){data=instance._selected}else{data=instance.data_promise&&instance._current_data?instance._current_data:instance.data;if(lfs_id.indexOf(".")!==-1){var parent_group_index=parseInt(lfs_id.split(".")[0],10);data=data[parent_group_index]?data[parent_group_index].children:data[0].children}}var vals=data.filter(function(item){return item.lfs_id===lfs_id});if(vals.length){return vals[0]}else{return null}};var _getUserCreatedSlugData=function(instance,$slug){var lfs_slug_id=parseInt($slug.attr("data-lfs-slug-id"),10);var data=instance._selected;var vals=data.filter(function(item){return item.lfs_slug_id===lfs_slug_id});if(vals.length)return vals[0];return null};var _hideList=function(instance,force){if(!force&&(!instance._list_visible||instance.always_visible||instance.disabled))return;instance._list_visible=false;instance.$list_container.removeClass("visible");instance.$container.removeClass("list_visible");instance.$input_container.removeClass("active");if(instance._list_built){instance.$list.longListView("setHidden",true)}};var _hideNoResults=function(instance){instance.$empty.addClass("hidden");instance.$input_container.removeClass("active");instance.$container.removeClass("showing_no_results")};var _instanceCanSluggify=function(instance){
if(!instance.sluggify.enabled){return false}else if(!instance.sluggify.delimiter){TS.error("You must pass a delimiter regular expression to use sluggify with lazyFilterSelect.");return false}else if(!instance.sluggify.key_name){TS.error("You must pass a key name to use sluggify with lazyFilterSelect.");return false}else if(instance.single){TS.error("Sluggify only works in multi-select versions of lazyFilterSelect.");return false}else{return true}};var _isAlreadySelected=function(instance,item){if(!instance._selected.length)return false;var matches=instance._selected.filter(function(selected_item){if(selected_item.lfs_id===item.lfs_id)return true});return!!matches.length};var _itemIsUserCreatedSlug=function(item){if(item instanceof jQuery){return!!item.attr("data-lfs-slug-id")}else{return item.lfs_slug_id!==undefined}};var _loadSlugAndRemoveFromData=function(instance,item,data){if(!_instanceCanSluggify(instance))return;if(!_itemIsUserCreatedSlug(item))return;var $item=$(item);instance._slug_id_counter=Math.max(item.lfs_slug_id,instance._slug_id_counter)+1;instance._selected.push(item);var $slug;var slug_html=TS.templates.lazy_filter_select_item({content:instance.tokenTemplate(item),icon:$item.data("lfs-item-icon"),desc:$item.data("lfs-item-desc"),applied_classes:"lfs_token",slug_id:item.lfs_slug_id}).replace(/(\r\n|\n|\r)/gm,"");$slug=$(slug_html);$slug.insertBefore(instance.$input);_adjustInput(instance);if(instance.sluggify.validator){instance.sluggify.validator($slug)}instance.data=data.filter(function(data_item){return data_item.lfs_slug_id!==item.lfs_slug_id});return instance.data};var _parseHTMLOptionData=function($select){var $items=$select.children("option, optgroup");var data=[];$items.each(function(){if($(this).prop("tagName")==="OPTGROUP"){var children=$(this).children("option").toArray();if($(this).prop("disabled")){children=children.map(function(item){item.lfs_disabled=true;return item})}data.push({is_divider:true,lfs_group:true,label:$(this).prop("label"),children:children})}else{data.push(this)}});return data};var _populate=function(instance,data){if(!data)data=instance.data;if(data.length===0){_showNoResults(instance);return}instance.$empty.addClass("hidden");instance.$list_container.removeClass("empty");if(!instance._list_built){_startListView(instance)}else{var temp_data=_preLongListViewPrep(data);instance.$list.longListView("setItems",temp_data,true);instance._current_data=data;_updateMonkeyScroll(instance)}};var _preLongListViewPrep=function(data){var temp_data=[];data.forEach(function(item){temp_data.push(item);if(item.children&&item.children.length){for(var i=0;i<item.children.length;i++){temp_data.push(item.children[i])}}});return temp_data};var _prepItems=function(instance,data){if(!data)data=instance.data;var html="";var token=!instance.single;var i=0;while(i<data.length){var item=data[i];if(_itemIsUserCreatedSlug(item)){data=_loadSlugAndRemoveFromData(instance,item,data);continue}if(item.children&&item.children.length){item.lfs_group=true}if(item.lfs_group||item.is_divider){item.is_divider=true;var k=i;for(var j=0;j<item.children.length;j++){var subitem=item.children[j];subitem.lfs_id=subitem.lfs_id||k+"."+j;if((subitem.selected||subitem.preselected)&&instance.no_default_selection===false){if(_isAlreadySelected(instance,subitem))continue;instance._selected.push(subitem);html+=_buildItem(instance,subitem,token)}}}else{item.lfs_id=item.lfs_id||String(i);if((item.selected||item.preselected)&&instance.no_default_selection===false){if(instance.single&&html.length>0||_isAlreadySelected(instance,item)){i++;continue}instance._selected.push(item);html+=_buildItem(instance,item,token)}}i++}if(html.length>0){instance.$container.addClass("value");if(instance.single){instance.$lfs_value.html(html)}else{$(html).insertBefore(instance.$input);instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}}};var _removeAllSelected=function(instance){while(instance.$input_container.find(".lfs_token").length>0){_removeLastSelected(instance)}};var _removeLastSelected=function(instance){var $token=instance.$input_container.find(".lfs_token").last();if($token.length)_removeSelected(instance,$token)};var _removeSelected=function(instance,$item){if(instance.disabled)return;if(_itemIsUserCreatedSlug($item)){_removeUserCreatedSlug(instance,$item);return}var data_item=_getData(instance,$item,true);if(data_item.disabled||instance.restrict_preselected_item_removal&&data_item.preselected)return;instance._selected=instance._selected.filter(function(item){if(item!==data_item)return true});var $list_item=instance.$list.find('[data-lfs-id="'+data_item.lfs_id+'"]');$list_item.removeClass("selected");$item.remove();_updateVal(instance);if(instance.$input.val().length+instance._selected.length===0){_showEmptyState(instance)}if(instance._selected.length===0)instance.$container.removeClass("value");instance.onItemRemoved(data_item)};var _removeUserCreatedSlug=function(instance,$slug){if(!_instanceCanSluggify(instance))return;var data_item=_getUserCreatedSlugData(instance,$slug);instance._selected=instance._selected.filter(function(item){if(item!==data_item)return true});$slug.remove();_updateVal(instance);if(instance.$input.val().length+instance._selected.length===0){_showEmptyState(instance)}instance.onItemRemoved(data_item)};var _run=function(){if(this.data&&this.data.length===0)TS.warn("Data passed to lazyFilterSelect is empty.");_update(this,this.data);_bindUI(this);if(this.always_visible)_showList(this);if(this.restrict_input_container_height){this.$container.addClass("has_restricted_input_container_height");if(!TS.environment.supports_custom_scrollbar){this.$input_container.monkeyScroll()}}};var _runQuery=function(instance,query,keep_value){if(instance.disabled)return;if(query===instance._previous_val)return;instance._all_done_fetching=false;instance._previous_val=query;_adjustInput(instance);instance._page_number=1;if(instance._list_built)instance.$list.longListView("scrollToTop",true);if(instance.data_promise){if(instance._running_promise)instance._running_promise.cancel("User entered more text");instance._running_promise=instance.data_promise(query).then(function(response){instance._running_promise=null;var data=response;if(data.items)data=data.items;if(typeof response.all_items_fetched!=="undefined")instance._all_done_fetching=!!response.all_items_fetched;if(typeof response.num_remaining!=="undefined"&&response.num_remaining===0)instance._all_done_fetching=true;data=data.slice();_showList(instance,keep_value);_doAllTheThingsRequiredWithNewData(instance,data)})}else{_showList(instance,keep_value);var filtered=_filterGroup(instance,query);_populate(instance,filtered);_adjustInput(instance)}};var _select=function(instance,direction){if(instance.disabled)return;if(!instance._list_visible){_showList(instance);return}var $to_select;if(!instance._$active){$to_select=instance.$list.find(".lfs_item:not(.disabled, .hidden)").first()}else{$to_select=instance._$active[direction](".lfs_item:not(.disabled, .hidden)").first()}if($to_select.length){$to_select.scrollintoview({duration:0});if(instance._$active)instance._$active.removeClass("active");$to_select.addClass("active");instance._$active=$to_select}};var _selectable=function($item){return!($item.hasClass("selected")||$item.hasClass("disabled"))};var _selectDataItem=function(instance,data_item){if(!_canAddNewItem(instance))return;if(instance.single&&instance._selected.length){var $prev_list_item=instance.$list.find('[data-lfs-id="'+instance._selected[0].lfs_id+'"]');$prev_list_item.removeClass("selected");instance._selected.length=0;instance.$lfs_value.empty()}instance._selected.push(data_item);_updateVal(instance);var $token=$(_buildItem(instance,data_item,!instance.single));if(_.isFunction(instance.tokenClass)){$token.addClass(instance.tokenClass(data_item))}if(instance.single){$token.appendTo(instance.$lfs_value)}else{$token.addClass("lfs_token");$token.insertBefore(instance.$input)}if(!instance.single){instance.$input_container.removeClass("empty");instance.$input.prop("placeholder","")}instance.$container.addClass("value");instance.onItemAdded(data_item);if(!_canAddNewItem(instance))instance.onMaxItemsSelected();instance.$input.focus()};var _selectDown=function(instance){return _select(instance,"nextAll")};var _selectListItem=function(instance){if(instance.disabled)return;var $active=instance._$active;if(!$active.length)return;if(!_selectable($active))return;if(!_canAddNewItem(instance))return;$active.addClass("selected");$active.removeClass("active");instance._$active=null;var data_item=_getData(instance,$active);_selectDataItem(instance,data_item)};var _selectUp=function(instance){return _select(instance,"prevAll")};var _showEmptyState=function(instance){instance.$input_container.addClass("empty");instance.$input.prop("placeholder",instance.placeholder_text)};var _showList=function(instance,keep_value){if(instance.disabled)return;TS.utility.rAF(function(){instance.$input.focus()});if(instance._list_visible)return;if(!instance._list_built)_startListView(instance);if(instance._list_built){instance._list_visible=true;instance.$list_container.addClass("visible");instance.$container.addClass("list_visible").removeClass("showing_no_results");instance.$input_container.addClass("active");instance.$list.longListView("setHidden",false)}if(instance.single&&!keep_value){instance.$input.val("");instance._previous_val="";instance.$input.focus();_populate(instance)}if(instance.set_height){_calculateHeight(instance);if(instance.monkey_scroll&&!TS.environment.supports_custom_scrollbar){instance.$list.monkeyScroll()}}};var _showNoResults=function(instance){if(instance._list_built){instance.$container.addClass("showing_no_results");_hideList(instance,true);instance.$input_container.addClass("active");instance.$list_container.addClass("empty");instance.$empty.html(instance.noResultsTemplate(instance.$input.val()));instance.$empty.removeClass("hidden");instance._$active=null}};var _startListView=function(instance){if(instance.data.length===0)return;var data=_preLongListViewPrep(instance.data);instance._list_built=true;var long_list_view_args={items:data,approx_item_height:instance.approx_item_height,approx_divider_height:instance.approx_divider_height,preserve_dom_order:true,makeDivider:function(data){return $('<div class="lfs_group"></div>')},makeElement:function(data){return $(TS.templates.lazy_filter_select_item().replace(/(\r\n|\n|\r)/gm,""))},renderDivider:function($el,item,data){if(instance.render_divider_func)return instance.render_divider_func($el,item,data);$el.html(TS.utility.htmlEntities(item.label))},renderItem:function($el,item,data){if(instance.render_item_func)return instance.render_item_func($el,item,data);var $item=$(item);var remove_classes="active selected disabled single group_item lfs_token";var applied_classes=TS.utility.getAppliedClasses({disabled:item.disabled||item.lfs_disabled,selected:_isAlreadySelected(instance,item),single:instance.single});$el.attr("data-lfs-id",item.lfs_id).removeClass(remove_classes).addClass(applied_classes).html(instance.template(item).string);if($item.data("lfs-item-icon")){var background_css="url("+$item.data("lfs-item-icon")+")";var $icon=$('<span class="lfs_item_icon">').css("background-image",background_css);$el.prepend($icon)}if($item.data("lfs-item-desc")){var $desc=$('<span class="lfs_item_desc">').text($item.data("lfs-item-desc"));$el.append($desc)}}};instance.$list.longListView(long_list_view_args);_bindListListeners(instance);instance.$list_items=instance.$container.find(".list_items");TS.utility.rAF(function(){if(instance.monkey_scroll&&!TS.environment.supports_custom_scrollbar){instance.$list.monkeyScroll()}instance.$list.longListView("resizeImmediately")})};var _stopThePresses=function(e){e.stopPropagation();e.preventDefault()};var _unselectItem=function(instance,$item){if(instance.single||!instance.allow_item_unselect)return;var data_item=_getData(instance,$item,true);$item.removeClass("selected");instance._selected=instance._selected.filter(function(item){if(item!==data_item)return true});instance.$input_container.find('.lfs_item[data-lfs-id="'+data_item.lfs_id+'"]').remove();_updateVal(instance);if(instance.$input.val().length+instance._selected.length===0){_showEmptyState(instance)}if(instance._selected.length===0)instance.$container.removeClass("value");instance.onItemRemoved(data_item)};var _unsluggifySlug=function(instance,$slug){if(!_instanceCanSluggify(instance)||!_itemIsUserCreatedSlug($slug))return;var slug_text=$slug.text().trim();if($slug.length)_removeUserCreatedSlug(instance,$slug);instance.$input.val(slug_text);_adjustInput(instance);instance.$input.select()};var _update=function(instance,data){instance.data=data||_parseHTMLOptionData(instance.$select);instance._selected=[];_prepItems(instance);if(instance.$input.val().length){var query=instance.$input.val();instance._previous_val="";_runQuery(instance,query)}};var _updateMonkeyScroll=function(instance){if(instance.restrict_input_container_height){TS.ui.utility.updateClosestMonkeyScroller(instance.$input_container,true)}if(instance.monkey_scroll&&!TS.environment.supports_custom_scrollbar){TS.utility.rAF(function(){_calculateHeight(instance);TS.ui.utility.updateClosestMonkeyScroller(instance.$list,true)})}};var _updateVal=function(instance){if(instance.append)return;var values=instance._selected.map(function(item){if(item instanceof HTMLOptionElement)return $(item).val()});instance.$select.val(values).trigger("change")}})();(function(){"use strict";TS.registerModule("ui.people_picker",{onStart:function(){},preload:function(options){_createFilterFunction(options)("");return options},make:function($el,options){options=options||{};if(!options.append)$el.addClass("hidden");if(TS.boot_data.page_needs_enterprise||options.force_lazy_filter_select){$el.lazyFilterSelect({append:!!options.append,always_visible:!!options.always_visible,approx_item_height:options.approx_item_height||50,data_promise:_createFilterFunction(options),placeholder_text:options.placeholder_text||"Search by name",classes:options.classes||"normal_style",scroll_threshold:2500,single:!!options.single,template:options.template||function(item){var html=TS.templates.member_small({member:item.member});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.member_token({member:item.member});return new Handlebars.SafeString(html)},tokenClass:function(item){return TS.templates.builders.getMemberTypeClass(item.member)},noResultsTemplate:function(query){if(!query){return"No one found"}else{return"No one found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}},onItemAdded:options.onItemAdded,onItemRemoved:options.onItemRemoved})}else{var data_specified=options.include_bots?TS.members.getActiveMembersExceptSelfAndSlackbot():TS.members.getActiveMembersExceptSelfAndBots();var opts={append:!!options.append,always_visible:!!options.always_visible,data:_makeMembersWithPreselectsForTemplate(options.members||data_specified,options.preselected_ids||[]),per_page:50,approx_item_height:options.approx_item_height||50,placeholder_text:options.placeholder_text||"Search by name",classes:options.classes||"normal_style",single:!!options.single,template:options.template||function(item){var html=TS.templates.member_small({member:item.member});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.member_token({member:item.member});return new Handlebars.SafeString(html)},tokenClass:function(item){return TS.templates.builders.getMemberTypeClass(item.member)},filter:function(item,query){var start_regex,suffix_regex,prev_query;var member=item.member;if(!options.include_bots&&member.is_bot){return false}if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}var match_names_only=true;return TS.utility.members.checkMemberMatch(member,start_regex,match_names_only)||TS.utility.members.checkMemberMatch(member,suffix_regex,match_names_only)},noResultsTemplate:function(query){if(!query){return"No one found"}else{return"No one found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}},onItemAdded:options.onItemAdded,onItemRemoved:options.onItemRemoved};$el.lazyFilterSelect(opts)}},value:function($el){return $el.lazyFilterSelect("value")},clearValue:function($el){return $el.lazyFilterSelect("clearValue")},recomputeHeight:function($el){return $el.lazyFilterSelect("recomputeHeight")}});var _createFilterFunction=function(options){var member_searcher={};var preselected_ids={};if(options.preselected_ids&&options.preselected_ids.length){_.forEach(options.preselected_ids,function(id){if(!!id)preselected_ids[id]=true})}var promiseToFilter=function(query,pageNumber){if(query.charAt(0)==="@")query=query.substring(1);if(query===""&&options.empty_query_result){if(pageNumber>0){return Promise.resolve([])}else{return Promise.resolve(options.empty_query_result.map(function(member){return{member:member,lfs_id:String(member.id),preselected:!!preselected_ids[member.id]}}))}}if(query===""&&options.initial_load_promise){if(_.isUndefined(pageNumber)){return options.initial_load_promise}options.initial_load_promise=_getSearchPromise(options.initial_load_promise,preselected_ids);return options.initial_load_promise}if(member_searcher.query!==query){member_searcher.query=query;member_searcher.include_org=TS.boot_data.page_needs_enterprise;member_searcher.include_slackbot=false;member_searcher.include_self=false;member_searcher.full_profile_filter=false;member_searcher.include_bots=!!options.include_bots}var load_promise=TS.members.ensureMembersArePresent(preselected_ids).then(function(){return _getSearchPromise(member_searcher,preselected_ids)});if(query===""&&!options.initial_load_promise){options.initial_load_promise=load_promise}return load_promise};return promiseToFilter};var _getSearchPromise=function(searcherOrPromise,preselectedIds){return Promise.resolve().then(function(){var unknown_user_ids=[];var ids=_.keys(preselectedIds);ids.forEach(function(id){var mbr=TS.members.getMemberById(id);if(!mbr)unknown_user_ids.push(id)});if(unknown_user_ids.length){return TS.members.ensureMembersArePresent(unknown_user_ids)}else{return Promise.resolve()}}).then(function(){return TS.members.promiseToSearchMembers(searcherOrPromise).then(function(response){var items=[];if(response.query===""){items=TS.members.getMembersForUser()}else{items=response.items}response.items=items.map(function(item){if(item.member&&typeof item.preselected!=="undefined")return item;return{member:item,lfs_id:String(item.id),preselected:!!preselectedIds[item.id]}});return response})})};var _makeMembersWithPreselectsForTemplate=function(members,preselected_ids){return members&&members.map(function(member){return{member:member,lfs_id:String(member.id),preselected:preselected_ids.indexOf(member.id)!==-1}})}})();(function(){"use strict";TS.registerModule("ui.utility",{onStart:_.noop,preventElementFromScrolling:function($el,callback,find_new_el){if(!$el.length){callback();return}var initial_offset=$el.offset();callback();if(_.isFunction(find_new_el)){$el=find_new_el();if(!$el.length)return}var now_top=$el.offset().top;var dist_moved=now_top-initial_offset.top;var $scroller=$el.closest(".monkey_scroller");if(!$scroller.length){$scroller=$el.closest(":scrollable(vertical)")}if($scroller.is("html"))$scroller=$("body");if(0!==dist_moved){var scroll_top=$scroller.scrollTop()+dist_moved;$scroller.scrollTop(Math.round(scroll_top))}if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($el)},updateClosestMonkeyScroller:function($el,force){if(!$el)return;var $scroller=$el.closest(".monkey_scroller");var data=$scroller.data("monkeyScroll");if(!data)return;if(!$scroller.data("monkeyScrollBeingCalled")){$scroller.data("monkeyScrollBeingCalled",true);TS.utility.setImmediate(function(){data.updateFunc(force);$scroller.data("monkeyScrollBeingCalled",false)})}}})})();(function(){"use strict";TS.registerModule("dnd",{dnd_statuses_changed_sig:new signals.Signal,current_user_dnd_status_changed_sig:new signals.Signal,onStart:function(){if(!TS.client)return;TS.ms.connected_sig.add(_onConnected);TS.ms.disconnected_sig.add(_onDisconnected);var team_delay=_.random(_TEAM_INFO_DELAY_MIN,_TEAM_INFO_DELAY_MAX);var single_user_delay=Math.round(team_delay*_SINGLE_USER_INFO_DELAY_SCALE);TS.dnd.setApiDelays(team_delay,single_user_delay);TS.members.joined_team_sig.add(_memberJoinedTeam);TS.members.changed_deleted_sig.add(_memberDeletedChanged);TS.dnd.debouncedCheckForChanges=TS.utility.throttleFunc(TS.dnd.checkForChanges,500,true);if(TS.lazyLoadMembersAndBots()){TS.members.lazily_added_sig.add(_maybeSetDndStatusForNewMemberAndSignal)}},memberDndStatus:function(){var in_dnd=TS.dnd.isMemberInDnd(TS.model.user);var snoozing=in_dnd&&TS.model.dnd.snooze_enabled;var end_time_ts=_endTime(TS.model.user);var readable_end_time;if(end_time_ts&&snoozing){readable_end_time=_snoozeReadableCountdown(end_time_ts)}else if(end_time_ts){readable_end_time=TS.utility.date.toTime(end_time_ts,true);if(!TS.utility.date.do24hrTime()){readable_end_time=readable_end_time.split(":00").join("")}}return{in_dnd:in_dnd,snoozed:snoozing,ends:end_time_ts,readable_end_time:readable_end_time}},setSnooze:function(num_minutes){return TS.api.call("dnd.setSnooze",{num_minutes:num_minutes},function(ok,data,args){if(!ok){TS.warn("dnd.setSnooze failed");return}_log("dnd.setSnooze to "+num_minutes+" minutes. New end time is "+_readableTs(data.snooze_endtime))})},endSnooze:function(){return TS.api.call("dnd.endSnooze",{},function(ok,data,args){if(!ok){TS.warn("dnd.endSnooze failed");return}_log("dnd.endSnooze succeeded")})},endDnd:function(){return TS.api.call("dnd.endDnd",{},function(ok,data,args){if(!ok){TS.warn("dnd.endDnd failed");return}_log("dnd.endDnd succeeded")})},isMemberInDnd:function(member,now){var is_in_dnd;if(!now)now=_now();var start=_startTime(member);var end=_endTime(member);if(member.is_self&&TS.model.dnd.snooze_enabled&&end){if(end>now)return true}if(null==start||null==end)return false;is_in_dnd=end>now&&(start<=now||start>end);return is_in_dnd},checkForChanges:function(){if(!TS.model.ms_connected)return;var self_changed=false;var all_members=TS.members.getMembersForUser();var now=_now();if(TS.model.dnd.snooze_enabled){if(now>=TS.model.dnd.snooze_endtime){TS.model.dnd.snooze_enabled=false;self_changed=true}}var members_with_stale_times=[];var members_with_updates=all_members.filter(function(member){if(member.deleted)return;var was_in_dnd=member._is_in_dnd||false;var is_in_dnd=TS.dnd.isMemberInDnd(member,now);var changed=false;if(was_in_dnd!=is_in_dnd){member._is_in_dnd=is_in_dnd;if(member.is_self)self_changed=true;changed=true}if(_memberHasStaleTimes(member,now)){members_with_stale_times.push(member)}return changed});if(self_changed&&!_.includes(members_with_updates,TS.model.user))members_with_updates.push(TS.model.user);if(members_with_updates.length>0)_log("Processing DND status changes for "+members_with_updates.length+" members");TS.dnd.dnd_statuses_changed_sig.dispatch(members_with_updates);if(self_changed){TS.dnd.current_user_dnd_status_changed_sig.dispatch();TSSSB.call("dndStatusChanged",TS.members.isMemberInDnd(TS.model.user))}TS.dnd.kickOffNextEventTimer();return members_with_stale_times},debouncedCheckForChanges:function(){},kickOffNextEventTimer:function(){clearTimeout(_next_event_timer);var now=_now();var next_ts=_calcNextCheckTime(now);_log("next DND tick scheduled for "+_readableTs(next_ts));var in_ms=(next_ts-now)*1e3;_next_timer_time=next_ts;_next_event_timer=setTimeout(function(){var members_needing_new_data=TS.dnd.checkForChanges();var force_full_team=false;if(_team_info_first_boot_fail_time){if(_now()-_team_info_first_boot_fail_time>15*60)force_full_team=true}if(force_full_team||members_needing_new_data.length>_INDIVIDUAL_UPDATE_LIMIT){TS.dnd.fetchFullTeam()}else if(members_needing_new_data.length>1){TS.dnd.fetchMultipleMembers(members_needing_new_data)}else if(members_needing_new_data.length===1){TS.dnd.refreshMember(members_needing_new_data[0])}},in_ms)},fetchFullTeam:function(first_boot){var promise=_fetchTeamInfo(first_boot);if(promise)return promise.finally(TS.dnd.checkForChanges)},fetchMultipleMembers:function(members){var promise=_fetchUsersInfo(members);if(promise)return promise.finally(TS.dnd.checkForChanges)},refreshMember:function(member){var promise=_fetchUserInfo(member);if(promise)return promise.finally(TS.dnd.checkForChanges)},updateUserPropsAndSignal:function(user_id,props){_updateUserDndProps(user_id,props);if(user_id===TS.model.user.id){TS.dnd.checkForChanges()}else{TS.dnd.debouncedCheckForChanges()}},dndOverride:function(c_id,ts){var channel=TS.shared.getModelObById(c_id);if(!channel)return;var msg=TS.utility.msgs.getMsg(ts,channel.msgs);if(!msg)return;if(msg._ignore_dnd)return;msg._ignore_dnd=true;if(channel.is_im){TS.ui.growls.growlImMessage(channel,msg)}else{TS.ui.growls.growlchannelOrGroupMessage(channel,msg)}},debugInfo:function(){var logging=["DND debug info:"];logging.push("next timer fires at "+_readableTs(_next_timer_time));logging.push("_team_info_delay: "+_team_info_delay);logging.push("_single_user_info_delay: "+_single_user_info_delay);logging.push("_calcNextCheckTime: "+_readableTs(_calcNextCheckTime()));var output="\n"+logging.join("\n");TS.info(output)},debugMember:function(member){var logging=["DND member debugging:"];logging.push("is in DND: "+!!member._is_in_dnd+" ("+TS.dnd.isMemberInDnd(member)+")");logging.push("start: "+_readableTs(_startTime(member),true));logging.push("end  : "+_readableTs(_endTime(member),true));logging.push("next : "+_readableTs(_nextTime(member),true));logging.push("stale? "+_memberHasStaleTimes(member));var end=_endTime(member);if(end&&_timeWasProbablyASnooze(end)){logging.push("Probably a snooze")}else if(end){logging.push("Probably a scheduled DND")}var output="\n"+logging.join("\n");TS.info(output)},setApiDelays:function(team_delay,single_user_delay){_team_info_delay=team_delay;_single_user_info_delay=single_user_delay},test:function(){return{fetchUsersInfo:_fetchUsersInfo,calcNextCheckTime:_calcNextCheckTime,snoozeReadableCountdown:_snoozeReadableCountdown,updateUserDndProps:_updateUserDndProps,timeWasProbablyASnooze:_timeWasProbablyASnooze,memberHasStaleTimes:_memberHasStaleTimes}}});var _MIN_TIMER_DELAY=15;var _MAX_TIMER_DELAY=5*60;var _INDIVIDUAL_UPDATE_LIMIT=100;var _TEAM_INFO_DELAY_MAX=1500;var _TEAM_INFO_DELAY_MIN=10;var _SINGLE_USER_INFO_DELAY_SCALE=.01;var _team_info_delay=_TEAM_INFO_DELAY_MAX;var _single_user_info_delay=_TEAM_INFO_DELAY_MIN;var _next_event_timer;var _next_timer_time;var _team_info_first_boot_fail_time=null;var _onConnected=function(was_fast_reconnect){if(!was_fast_reconnect){var first_boot=true;setTimeout(function(){TS.dnd.fetchFullTeam(first_boot)},_.random(100,1e4))}TS.dnd.checkForChanges()};var _onDisconnected=function(){clearTimeout(_next_event_timer)};var _memberJoinedTeam=function(member){TS.dnd.refreshMember(member)};var _memberDeletedChanged=function(member){if(!member.deleted)TS.dnd.refreshMember(member)};var _calcNextCheckTime=function(now){var next_ts;if(!now)now=_now();var next_self=_nextTime(TS.model.user,now);if(next_self)next_ts=next_self;var next_member;var next_member_time;for(var uid in TS.model.dnd.team){if(uid==TS.model.user.id)continue;next_member=TS.members.getMemberById(uid);if(!next_member)continue;next_member_time=_nextTime(next_member,now);if(!next_member_time)continue;if(!next_ts||next_member_time<next_ts)next_ts=next_member_time}var max_delay=_MAX_TIMER_DELAY+now;if(!next_ts||next_ts>max_delay)next_ts=max_delay;var min_delay=_MIN_TIMER_DELAY+now;if(next_ts<min_delay)next_ts=min_delay;return next_ts};var _updateUserDndProps=function(user_id,props,team_props){if(!team_props)team_props=TS.model.dnd.team;if(user_id===TS.model.user.id){if(props.dnd_enabled){TS.model.dnd.next_dnd_start_ts=props.next_dnd_start_ts;TS.model.dnd.next_dnd_end_ts=props.next_dnd_end_ts}else{TS.model.dnd.next_dnd_start_ts=null;TS.model.dnd.next_dnd_end_ts=null}if("snooze_enabled"in props)TS.model.dnd.snooze_enabled=props.snooze_enabled;if("snooze_endtime"in props)TS.model.dnd.snooze_endtime=props.snooze_endtime}if(props.dnd_enabled){team_props[user_id]={next_dnd_start_ts:props.next_dnd_start_ts,next_dnd_end_ts:props.next_dnd_end_ts}}else{team_props[user_id]={next_dnd_start_ts:null,next_dnd_end_ts:null}}};var _team_fetch_in_progress=false;var _fetchTeamInfo=function(first_boot){if(_team_fetch_in_progress)return;_team_fetch_in_progress=true;return TS.api.call("dnd.teamInfo",{},function(ok,data){_team_fetch_in_progress=false;if(!ok){if(first_boot)_team_info_first_boot_fail_time=_now();TS.warn("dnd.teamInfo failed");return}_team_info_first_boot_fail_time=null;var team_data={};if(data.users){_.forOwn(data.users,function(props,user_id){_updateUserDndProps(user_id,props,team_data)});TS.model.dnd.team=team_data}},true)};var _team_multi_fetch_in_progress=false;var _fetchUsersInfo=function(members){if(_team_multi_fetch_in_progress)return;_team_multi_fetch_in_progress=true;var member_ids=_.map(members,"id").join(",");return TS.api.call("dnd.teamInfo",{users:member_ids},function(ok,data,args){_team_multi_fetch_in_progress=false;if(!ok){TS.warn("dnd.teamInfo failed for a multi-user request");return}if(data.users){_.forOwn(data.users,function(props,user_id){_updateUserDndProps(user_id,props)})}},true)};var _current_single_user_requests={};var _fetchUserInfo=function(member){if(_current_single_user_requests[member.id])return;_current_single_user_requests[member.id]=true;return new Promise(function(resolve,reject){setTimeout(function(){TS.api.call("dnd.info",{user:member.id},function(ok,data,args){delete _current_single_user_requests[member.id];if(!ok){TS.warn("dnd.info failed for "+member.id);reject(new Error("dnd.info failed for "+member.id));return}var user_id=member.id;var props=data;_updateUserDndProps(user_id,props);resolve()},true)},_single_user_info_delay*1e3)})};var _startTime=function(member){if(member.is_self)return TS.model.dnd.next_dnd_start_ts;var times=TS.model.dnd.team[member.id];if(!times)return null;return times.next_dnd_start_ts};var _endTime=function(member){if(member.is_self){if(TS.model.dnd.snooze_enabled)return TS.model.dnd.snooze_endtime;return TS.model.dnd.next_dnd_end_ts}var times=TS.model.dnd.team[member.id];if(!times)return null;return times.next_dnd_end_ts};var _nextTime=function(member,now){if(!now)now=_now();var start=_startTime(member);var end=_endTime(member);if(start&&end){if(start>now&&start<end)return start}if(end){if(end>now)return end;var delayed_fetch=end+_team_info_delay;if(delayed_fetch>=now)return delayed_fetch}return null};var _now=function(){return Math.floor(Date.now()/1e3)};var _snoozeReadableCountdown=function(end_time_ts){var remaining=end_time_ts-_now();if(remaining<0)return"0s";var hours,minutes;hours=remaining/3600;if(hours>=1){hours=Math.floor(hours);minutes=(remaining-hours*3600)/60;minutes=Math.round(minutes);if(minutes===60)return hours+1+"h";if(minutes===0)return hours+"h";return hours+"h"+" "+minutes+"m"}minutes=remaining/60;if(minutes>=1){minutes=Math.round(minutes);if(minutes===60)return"1h";return minutes+"m"}return remaining+"s"};var _memberHasStaleTimes=function(member,now){if(!now)now=_now();var end=_endTime(member);if(!end||end>now)return false;var delta=now-end;if(_timeWasProbablyASnooze(end)){return true}else{return delta>=_team_info_delay}};var _timeWasProbablyASnooze=function(end_ts){var d=new Date(end_ts*1e3);var seconds=d.getSeconds();var minutes=d.getMinutes();var probably_scheduled=seconds===0&&(minutes===0||minutes===30);return!probably_scheduled};var _log=function(s){TS.log(2002,s)};var _readableTs=function(ts,include_date){if(!ts)return"<null>";var d=new Date(ts*1e3);if(include_date)return d.toTimeString()+" ("+d.toDateString()+")";
return d.toTimeString()};var _maybeSetDndStatusForNewMemberAndSignal=function(member){if(_.isEmpty(TS.model.dnd.team)||_team_fetch_in_progress){return}var times=TS.model.dnd.team[member.id];if(!times)return;var should_have_dnd_enabled=!!times.next_dnd_start_ts;if(!should_have_dnd_enabled){return}var props={dnd_enabled:true,next_dnd_start_ts:times.next_dnd_start_ts,next_dnd_end_ts:times.next_dnd_end_ts};_updateUserDndProps(member.id,props);TS.dnd.debouncedCheckForChanges()}})();(function(){"use strict";TS.registerModule("ui.inline_saver",{show:function(settings){settings=settings||{};var $el=$(settings.target);if(!$el.length){TS.warn("TS.ui.inline_saver called without a valid target.");return}var $existing_saver=$el.data("inline-saver");if($existing_saver&&$existing_saver.length){$existing_saver.remove();clearTimeout($el.data("inline-saver-spin-timeout"))}var $inline_saver=$(TS.templates.inline_saver({custom_text:settings.custom_text}));$inline_saver.insertAfter($el);$el.data("inline-saver",$inline_saver);if(settings.promise){settings.promise.then(function(){_hideSaver(settings)}).catch(function(){_hideSaver(settings,true)})}else{var timeout=setTimeout(function(){_hideSaver(settings)},_SPIN_DURATION);$el.data("inline-saver-spin-timeout",timeout)}}});var _SPIN_DURATION=500;var _FADE_DURATION=2e3;var _FAIL_FADE_DURATION=3e3;var _hideSaver=function(settings,failed){settings=settings||{};var $el=$(settings.target);clearTimeout($el.data("inline-saver-hide-timeout"));var $existing_saver=$el.data("inline-saver");if(!$existing_saver||!$existing_saver.length){return}var next_class=failed?"failed":"saved";$existing_saver.removeClass("saving").addClass(next_class);var fade_duration=failed?_FAIL_FADE_DURATION:_FADE_DURATION;var timeout=setTimeout(function(){$existing_saver.remove()},fade_duration);$el.data("inline-saver-hide-timeout",timeout)}})();(function(){"use strict";TS.registerModule("ui.messages",{onStart:function(){var $body=$("body");$body.on("click.msg_action","ts-message",function(e){if(TS.client&&TS.client.ui.checkForEditing(e))return;_msgActionHandler(e)});$body.delegate("ts-message.dirty_hover_container","mouseenter",function(e){TS.ui.messages.updateMessageHoverContainer($(e.currentTarget))})},maybeUpdateMessageHoverContainer:function($msg){if(!$msg.length)return;if($msg.is(":visible")){TS.ui.messages.updateMessageHoverContainer($msg)}else{$msg.addClass("dirty_hover_container")}},updateMessageHoverContainer:function($msg){$msg.removeClass("dirty_hover_container");var model_ob_id=$msg.data("model-ob-id");var model_ob=model_ob_id?TS.shared.getModelObById(model_ob_id):TS.shared.getActiveModelOb();if(!model_ob)return;var msg_ts=$msg.attr("data-ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg&&model_ob._archive_msgs)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg&&TS.model.unread_view_is_showing)msg=TS.client.unread.getMessage(model_ob,msg_ts);if(!msg&&TS.boot_data.feature_message_replies)msg=TS.ui.replies.getActiveMessage(model_ob,msg_ts);if(!msg&&TS.boot_data.feature_message_replies_threads_view)msg=TS.client.threads.getMessage(model_ob,msg_ts);if(!msg){TS.error(msg_ts+" not found in "+model_ob_id);return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);var $ahc=$msg.find(".action_hover_container");var handy_rxns_dd=TS.boot_data.feature_thanks&&TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key);var show_unnadded_handy_rxns=!handy_rxns_dd.is_poll&&(_always_show_unnadded_handy_rxns||$msg.hasClass("just_added_handy_rxn_from_actions"));var handy_rxns_to_show;if(handy_rxns_dd){if(show_unnadded_handy_rxns){var rxns=TS.rxns.getExistingRxnsByKey(rxn_key);handy_rxns_to_show=_.cloneDeep(handy_rxns_dd);for(var k in handy_rxns_to_show.items){if(!TS.rxns.doesRxnsHaveSkinlessRxn(rxns,k))continue;delete handy_rxns_to_show.items[k]}if($msg.hasClass("just_added_handy_rxn_from_actions")){$msg.bind("mouseout.handy_rxns",function(){if(!_always_show_unnadded_handy_rxns)$msg.addClass("dirty_hover_container");$msg.removeClass("just_added_handy_rxn_from_actions");$msg.unbind("mouseout.handy_rxns")})}}else{if(!TS.rxns.getExistingRxnsByKey(rxn_key)&&!handy_rxns_dd.is_poll){handy_rxns_to_show=handy_rxns_dd}}}if(TS.boot_data.feature_message_replies){var is_in_conversation=$msg.closest("ts-conversation").length>0;var is_in_threads_view=TS.model.threads_view_is_showing;var is_in_thread=is_in_conversation||is_in_threads_view}$ahc.html(TS.templates.action_hover_items({msg:msg,actions:TS.utility.msgs.getMsgActions(msg,model_ob),ts_tip_delay_class:"ts_tip_delay_60",handy_rxns:handy_rxns_to_show,is_in_thread:is_in_thread,show_rxn_action:!!$ahc.data("show_rxn_action")&&(!handy_rxns_dd||!handy_rxns_dd.restrict),show_reply_action:!!$ahc.data("show_reply_action"),show_jump_action:!!$ahc.data("show_jump_action"),show_comment_action:!!$ahc.data("show_comment_action"),abs_permalink:$ahc.data("abs_permalink")}));if(TS.boot_data.feature_message_replies){$ahc.toggleClass("narrow_buttons",$ahc.children().length>3)}}});var _always_show_unnadded_handy_rxns=false;var _msgActionHandler=function(e){if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();e.preventDefault();return}var $el=$(e.target);var $action_el=$el.closest("[data-action]");if($action_el.length){var $msg_el=$el.closest("ts-message");var model_ob_id=$msg_el.data("model-ob-id");var model_ob=model_ob_id?TS.shared.getModelObById(model_ob_id):TS.shared.getActiveModelOb();var msg_ts=$msg_el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);var action=$action_el.data("action");var in_archives=false;if(!msg){msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(msg)in_archives=true}if(!msg&&TS.boot_data.feature_message_replies){msg=TS.ui.replies.getActiveMessage(model_ob,msg_ts)}if(!msg&&TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing){msg=TS.client.threads.getMessage(model_ob,msg_ts)}if(!msg&&TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){msg=TS.client.unread.getMessage({id:model_ob_id},msg_ts);if(msg){model_ob=TS.client.unread.getGroup(model_ob_id).model_ob}}if(!msg){TS.error("WTF no message to click?");return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);switch(action){case"actions_menu":if(in_archives){TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob._archive_msgs,model_ob)}else{TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob.msgs,model_ob)}break;case"reaction":if(TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing&&TS.client.unread.shouldRecordMetrics()){TS.metrics.count("unread_view_emoji_reaction")}TS.menu.emoji.start({e:e,rxn_key:rxn_key});break;case"pin":TS.pins.startPinMessage(msg_ts,model_ob);break;case"unpin":TS.pins.unPinMessage(msg_ts,model_ob);break;case"edit":TS.msg_edit.startEdit(msg_ts,model_ob);break;case"delete":TS.msg_edit.startDelete(msg_ts,model_ob);break;case"mark_unread":TS.info("_msgActionHandler: setting unread point on "+model_ob.id+", ts = "+msg_ts+" (mark_unread)");TS.client.msg_pane.setUnreadPoint(msg_ts);break;case"reply":if($msg_el.length&&TS.replies&&TS.replies.canReplyToMsg(model_ob,msg)){if(TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing&&TS.client.unread.shouldRecordMetrics()){TS.metrics.count("unread_view_reply")}var thread_ts=msg.thread_ts||msg.ts;TS.ui.replies.openConversation(model_ob,thread_ts)}break;case"open_conversation":break;case"jump_to_original":TS.client.ui.tryToJump(model_ob.id,msg.ts);break;case"copy_link":var floater_title=TS.i18n.t("Copied!","messages_action_items")();TS.tips.updateFloater({title:floater_title,classes_to_add:["success"]});TS.clipboard.writeText($action_el.data("permalink"));break;case"comment":if(!TS.client)return;if(msg.file){e.preventDefault();TS.client.ui.files.previewFile(msg.file.id,"",false,true)}break;case"share_message":if(TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing&&TS.client.unread.shouldRecordMetrics()){TS.metrics.count("unread_view_share_message")}TS.ui.share_message_dialog.start(msg.ts,model_ob);break;case"add_handy_rxn":var name=$action_el.data("name");var adding=!TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(rxn_key),name);if(adding)$msg_el.addClass("just_added_handy_rxn_from_actions");TS.rxns.changeRxnsFromUserAction(rxn_key,name,adding);break;case"share_file":var file=msg.file;if(!file)return;if(TS.client){TS.view.files.shareInCurrentChannelOrIM(file.id,model_ob_id)}else{TS.ui.share_dialog.start(file.id)}break;default:TS.error("WTF no action?");break}}}})();(function(){"use strict";TS.registerModule("click",{onStart:function(){_setupBinding();_addAll()},addHandler:function(selector,fn,prevent_on_drag){if(_.isFunction(selector)){prevent_on_drag=fn;fn=selector;selector=null}_handlers.push({selector:selector,fn:fn,prevent_on_drag:prevent_on_drag||false})},addClientHandler:function(){if(!TS.client)return;return TS.click.addHandler.apply(this,arguments)},addWebHandler:function(){if(!TS.web)return;return TS.click.addHandler.apply(this,arguments)},test:function(){return{addAll:_addAll,setupBinding:_setupBinding,handlers:function(){return _handlers},resetHandlers:function(){_handlers=[]},unbind:function(){$("body").off("click.ts_dot_click");$("body").off("mousedown.ts_dot_click_mousedown")}}}});var _handlers=[];var _addAll=function(){TS.click.addClientHandler(function(e){if(TS.client.ui.checkForEditing(e))e.preventDefault()});TS.click.addWebHandler("#msgs_div",function(e){if(!TS.utility.isSpaceClickEventSafe(e))e.preventDefault()});TS.click.addClientHandler("#msgs_div .message[data-ts]",function(e){var $el=$(e.target);var msg_id=$el.closest(".message").data("ts");if(msg_id)msg_id=msg_id.toString();var model_ob=TS.shared.getActiveModelOb();if(!msg_id)return;if($el.hasClass("resend_temp_msg")||$el.hasClass("remove_temp_msg")){e.preventDefault();var resend=$el.hasClass("resend_temp_msg");TS.utility.msgs.handleFailedMsgSend(msg_id,model_ob,resend);return}if(e.altKey){e.preventDefault();TS.info("setting unread point on "+model_ob.id+" due to alt+click on message with ts = "+msg_id);TS.client.msg_pane.setUnreadPoint(msg_id);return}if(TS.utility.cmdKey(e)&&e.shiftKey){e.preventDefault();var msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);TS.dir(0,msg);if(model_ob.is_im){TS.ui.growls.growlImMessage(model_ob,msg,false,true)}else{TS.ui.growls.growlchannelOrGroupMessage(model_ob,msg,false,true)}}});TS.click.addClientHandler(".search_message_result a, .search_message_result button",function(e,$el){var $target=$(e.target);var match_with_index=TS.search.view.getMatchForSearchResult($el);if(!match_with_index)return;var match=match_with_index.match;var target_type;var target_user_id;var target_ts;if($target.hasClass("search_jump")){target_type="jump"}else if($target.hasClass("archive")){target_type="archive"}else if($target.is(".channel_link, .internal_im_link, .mpim_link, .group_link")){target_type="channel"}else if($target.hasClass("message_sender")){target_type="sender";var $message=$target.closest("ts-message");target_user_id=$message.data("memberId");target_ts=$message.data("ts")+""}else if($target.hasClass("timestamp")){target_type="timestamp";var $message=$target.closest("ts-message");target_user_id=$message.data("memberId");target_ts=$message.data("ts")+""}else if($target.hasClass("star")){target_type="star";var $message=$target.closest("ts-message");target_user_id=$message.data("memberId");target_ts=$message.data("ts")+""}else if($target.attr("href")||$target.attr("onclick")){target_type="link"}if(target_type){var payload={click_target_type:target_type,click_position:match_with_index.index,click_user_id:match.user,click_channel_id:match.channel.id,click_timestamp:match.ts,click_target_user_id:target_user_id,click_target_timestamp:target_ts};if(TS.search.last_request_id){payload["request_id"]=TS.search.last_request_id}TS.clog.track("SEARCH_CLICK",payload)}});TS.click.addClientHandler(".search_message_result .sli_feedback",function(e,$el){e.preventDefault();var $target=$(e.target);var match_with_index=TS.search.view.getMatchForSearchResult($el);if(!match_with_index)return;var payload={};var tip="";var tooltip_text_map={plus:"Search result is relevant<br><span class='subtle_silver'>(query string will be logged!)</span>",circle:"Search result is somewhat relevant<br><span class='subtle_silver'>(query string will be logged!)</span>",minus:"Search result is not relevant<br><span class='subtle_silver'>(query string will be logged!)</span>"};if($target.is(".selected")){payload.undo=true;if($target.is(".sli_feedback_plus")){tip=tooltip_text_map["plus"]}else if($target.is(".sli_feedback_circle")){tip=tooltip_text_map["circle"]}else if($target.is(".sli_feedback_minus")){tip=tooltip_text_map["minus"]}}else{tip="oops!<br><span class='subtle_silver'>remove my feedback</span>"}TS.tips.updateTipTitle($target,tip);$target.toggleClass("selected");$target.siblings(".sli_feedback").each(function(){$(this).removeClass("selected");var tip="";if($(this).is(".sli_feedback_plus")){tip=tooltip_text_map["plus"]}else if($(this).is(".sli_feedback_circle")){tip=tooltip_text_map["circle"]}else if($(this).is(".sli_feedback_minus")){tip=tooltip_text_map["minus"]}TS.tips.updateTipTitle($(this),tip)});if($target.is(".sli_feedback_plus")){payload.value=5}else if($target.is(".sli_feedback_circle")){payload.value=1}else if($target.is(".sli_feedback_minus")){payload.value=-5}payload.channel_id=match_with_index.match.channel.id;payload.message_id=match_with_index.match.ts;payload.permalink=match_with_index.match.permalink;payload.query=TS.search.view.latest_msg_search_results.query;payload.search_sort=TS.model.prefs.search_sort;payload.search_exclude_bots=TS.model.prefs.search_exclude_bots;payload.search_only_current_team=TS.model.prefs.search_only_current_team;payload.search_exclude_channel=TS.model.prefs.search_exclude_channels;payload.search_only_my_channels=TS.model.prefs.search_only_my_channels;TS.api.call("search.feedback",payload)});TS.click.addClientHandler("ts-message .message_body a, ts-message .file_container a",function(e,$el){var $message=$el.closest("ts-message");var message_ts=$message.data("ts")+"";var message_c_id=$message.data("model-ob-id");var original_href=$el.data("referer-original-href");var url=original_href?original_href:$el.attr("href");var payload={message_timestamp:message_ts,channel_id:message_c_id,channel_type:message_c_id?message_c_id.charAt(0):"",url:url?url:""};if($el.is(".channel_link, .internal_channel_link")){var channel_id=$el.data("channel-id");payload["item_id"]=channel_id;payload["item_type"]="C"}else if($el.is("[data-file-id]")){var file_id=$el.data("file-id");payload["item_id"]=file_id;payload["item_type"]="F"}if(TS.model.unread_view_is_showing){_.merge(payload,TS.client.ui.unread.getTrackingData(message_ts));TS.client.ui.unread.incrementTrackingSeqId()}TS.clog.track("MSG_LINK_CLICKED",payload)});TS.click.addClientHandler(".member_preview_link, .member_preview_image",function(e,$el,preview_origin){e.preventDefault();var parent_preview_scroller=$el.closest("#member_preview_scroller");var member_id=$el.data("member-id");if(member_id){if(parent_preview_scroller.length&&member_id==TS.model.previewed_member_id){TS.menu.member.startWithMember(e,member_id)}else if(parent_preview_scroller.length){TS.menu.member.startWithMember(e,member_id,true)}else if(preview_origin==="mentions"||preview_origin==="search_results"||preview_origin==="conversation"||preview_origin==="threads"){TS.menu.member.startWithMember(e,member_id)}else{var parent_msgs_div=$el.closest("#msgs_div, #archives_msgs_div, #unread_msgs_div");var is_in_all_members_dialog=$el.closest("#all_members_container").length>0;if(TS.ui.share_dialog.showing)TS.ui.share_dialog.div.modal("hide");if(parent_msgs_div.length||is_in_all_members_dialog){TS.menu.member.startWithMember(e,member_id)}else{TS.client.ui.previewMember(member_id,preview_origin||"team_list")}}}else{TS.warn("hmmm, no data-member-id?")}});TS.click.addClientHandler(".member",function(e,$el){e.preventDefault();var member_id=$el.data("member-id");if(member_id){TS.menu.member.startWithMember(e,member_id)}else{TS.warn("hmmm, no data-member-id?")}});TS.click.addClientHandler(".theme_installer_btn",function(e,$el){e.preventDefault();var custom_values=$el.data("theme");var remove_last_theme_selected=false;if(custom_values){custom_values=custom_values.replace(/ /g,"");custom_values=custom_values.replace(/,$/g,"");var custom_arr=custom_values.split(",");custom_values={column_bg:custom_arr[0],menu_bg:custom_arr[1],active_item:custom_arr[2],active_item_text:custom_arr[3],hover_item:custom_arr[4],text_color:custom_arr[5],active_presence:custom_arr[6],badge:custom_arr[7]};TS.prefs.last_theme_selected_in_UI="custom_theme";TS.prefs.setMultiPrefsByAPI({sidebar_theme:TS.prefs.last_theme_selected_in_UI,sidebar_theme_custom_values:JSON.stringify(custom_values)});TS.model.prefs.sidebar_theme=TS.prefs.last_theme_selected_in_UI;TS.prefs.setSidebarThemeCustomValues(custom_values);TS.view.prefs.sidebarThemePrefChanged(remove_last_theme_selected)}});TS.click.addClientHandler(".internal_im_link",function(e,$el){e.preventDefault();TS.ims.startImByMemberName($el.data("member-name"))});TS.click.addClientHandler(".group_link, .internal_group_link",function(e,$el){e.preventDefault();TS.view.onGroupReferenceClick(e,$el.data("group-id"))});TS.click.addClientHandler(".internal_im_call_link",function(e,$el){if(!TS.utility.calls.isEnabled())return;e.preventDefault();TS.utility.calls.startCallInModelOb(TS.members.getMemberByName($el.data("member-name")))});TS.click.addClientHandler(".file_viewer_link",function(e,$el){e.preventDefault();if($el.hasClass("file_viewer_channel_link")){TS.ui.fs_modal_file_viewer.start({modal_class:"fs_modal_file_viewer",$el:$el,current_file_id:$el.data("file-id"),show_control_btns:!$el.closest("#file_preview_container").length})}});TS.click.addClientHandler(".file_viewer_external_link",function(e,$el){e.preventDefault();TS.ui.fs_modal_file_viewer.start({modal_class:"fs_modal_file_viewer",$el:$el,current_file_id:$el.data("file-id"),current_external_link:$el[0]})});TS.click.addHandler(".inline_attachment.clickable, .inline_attachment.clickable + .reply_broadcast_rule",function(e,$el){var ignore_selectors=["a",".media_caret",".delete_attachment_link",".msg_inline_video_buttons_div"].join(",");if($(e.target).closest(ignore_selectors).length)return;var $link;if($el.is(".reply_broadcast")){$link=$el.closest(".message_body").find('[data-action="open_conversation"]')}else{$link=$el.find(".attachment_from_url_link")}$link[0]&&$link[0].click()},true);TS.click.addClientHandler(".internal_file_list_filter",function(e,$el){e.preventDefault();TS.client.ui.files.showFileList();TS.client.ui.files.toggleFileList($el.data("file-list-filter"))});TS.click.addClientHandler(".channel_link, .internal_channel_link",function(e,$el){e.preventDefault();TS.view.onChannelReferenceClick(e,$el.data("channel-id"))});TS.click.addClientHandler(".internal_member_link:not(.plastic_contenteditable_element)",function(e,$el){e.preventDefault();if(TS.boot_data.feature_name_tagging_client&&$el.data("member-id")){TS.view.onMemberReferenceClick(e,$el.data("member-id"))}else{TS.view.onMemberReferenceClick(e,$el.data("member-name"))}});TS.click.addClientHandler(".internal_user_group_link",function(e,$el){e.preventDefault();TS.view.onUserGroupReferenceClick(e,$el.data("user-group-id"))});TS.click.addClientHandler(".file_preview_link, .file_details_container .file_comment_btn, .back_from_file_comments",function(e,$el,preview_origin){e.preventDefault();if(TS.ui.share_dialog.showing)TS.ui.share_dialog.div.modal("hide");var c_id=$el.closest("[data-model-ob-id]").attr("data-model-ob-id");var file_id=$el.attr("data-file-id");if(!file_id)file_id=$el.closest("[data-file-id]").attr("data-file-id");var file=TS.files.getFileById(file_id);if(file&&file.is_deleted){TS.generic_dialog.alert("<p>This file has been deleted.</p>");return}if(preview_origin==="search_results"&&TS.files.fileIsImage(file)){TS.ui.fs_modal_file_viewer.start({modal_class:"fs_modal_file_viewer",$el:$el,current_file_id:file_id,show_control_btns:false});return}var focus_comment_input=$el.hasClass("file_comment_link");var force_flexpane=$el.hasClass("file_force_flexpane");if(!force_flexpane){var qs=focus_comment_input?"?comments=1":"";if(TS.client.windows.openFileWindow(file_id,qs))return}TS.client.ui.files.previewFile(file_id,preview_origin||"file_list",false,focus_comment_input,c_id)});TS.click.addClientHandler(".msg_actions",function(e,$el){var msg_ts=$el.data("msg-ts");if($el.is($el)||$el.closest(".msg_cog").length){e.preventDefault();if(TS.model.archive_view_is_showing){TS.menu.startWithMessageActions(e,msg_ts,TS.client.archives.current_model_ob._archive_msgs)}else{TS.menu.startWithMessageActions(e,msg_ts,TS.shared.getActiveModelOb().msgs)}}});TS.click.addClientHandler(".comment_actions",function(e,$el){var $cog=$(e.target);if($cog.hasClass("comment_cog")){e.preventDefault();TS.menu.startWithCommentActions(e,$el.data("file-id"),$el.data("comment-id"))}});TS.click.addHandler(".file_actions",function(e,$el){e.preventDefault();TS.menu.file.startWithFileActions(e,$el.data("file-id"))});TS.click.addClientHandler(".file_ssb_download_link",function(e,$el){var open_flexpane=!(TS.ui.fs_modal_file_viewer&&TS.ui.fs_modal_file_viewer.is_showing);var file=TS.files.getFileById($el.data("file-id"));if(TS.boot_data.feature_pdf_viewer&&TS.model.pdf_viewer_enabled&&file&&TS.files.fileIsPDF(file)){if(TS.ui.fs_modal_file_viewer.is_showing){TS.metrics.count("pdf_viewer_download_in_file_viewer")}else{TS.metrics.count("pdf_viewer_download_outside_file_viewer")}}if(file&&TS.client.downloads.startDownload(file,open_flexpane)){e.preventDefault();return}});TS.click.addClientHandler(".msg_jump, .star_jump",function(e,$el,origin){e.preventDefault();var msg_id=$el.closest("[data-ts]").data("ts")+"";if(!msg_id){TS.error("WTF no msg_id to jump to?");return}var c_id=$el.data("cid");if(TS.boot_data.feature_message_replies){var model_ob=TS.shared.getModelObById(c_id);var thread_ts=$el.closest("[data-thread-ts]").attr("data-thread-ts");if(thread_ts&&thread_ts!=msg_id){TS.ui.replies.openConversation(model_ob,thread_ts,msg_id,origin);return}}TS.client.ui.tryToJump(c_id,msg_id)});TS.click.addClientHandler(".search_message_result .search_jump",function(e,$el,origin){var match_with_index=TS.search.view.getMatchForSearchResult($el);if(!match_with_index)return;var match=match_with_index.match;e.preventDefault();var load_history=false;var first_with_extracts=TS.search.view.firstResultWithExtracts(match);var c_id=match.channel&&match.channel.id?match.channel.id:match.channel;if(TS.boot_data.feature_message_replies){var model_ob=TS.shared.getModelObById(c_id);var thread_ts=first_with_extracts.thread_ts;if(thread_ts&&thread_ts!=first_with_extracts.ts){TS.ui.replies.openConversation(model_ob,thread_ts,first_with_extracts.ts,origin);return}}TS.client.ui.tryToJump(c_id,first_with_extracts.ts,"","",load_history)});TS.click.addWebHandler("#msgs_div.selecting_messages ts-message",function(e,$el){var $target=$(e.target);if($target.attr("href")||$target.hasClass("star"))return;var $message=$target.closest("ts-message");var $checkbox=$message.find(".msg_select_cb");if(!$target.is("input")){$checkbox.prop("checked",!$checkbox.prop("checked"))}TS.msg_edit.batchDeleteSelectionChanged($checkbox,e.shiftKey)});TS.click.addHandler(TS.rxns.checkForRxnClick);TS.click.addHandler(TS.stars.checkForStarClick);TS.click.addHandler(function(e){var search_match=TS.client&&TS.search.view.getMatchForSearchResult($(e.target));TS.inline_imgs.checkForInlineImgClick(e,search_match&&search_match.match);if(search_match&&TS.client)TS.ui.utility.updateClosestMonkeyScroller($(e.target))});TS.click.addHandler(function(e){var search_match=TS.client&&TS.search.view.getMatchForSearchResult($(e.target));TS.inline_videos.checkForInlineVideoClick(e,search_match&&search_match.match);if(search_match&&TS.client)TS.ui.utility.updateClosestMonkeyScroller($(e.target))});TS.click.addHandler(function(e){var search_match=TS.client&&TS.search.view.getMatchForSearchResult($(e.target));TS.inline_audios.checkForInlineAudioClick(e,search_match&&search_match.match);if(search_match&&TS.client)TS.ui.utility.updateClosestMonkeyScroller($(e.target))});TS.click.addHandler(function(e){var search_match=TS.client&&TS.search.view.getMatchForSearchResult($(e.target));TS.inline_others.checkForInlineOtherClick(e,search_match&&search_match.match);if(search_match&&TS.client)TS.ui.utility.updateClosestMonkeyScroller($(e.target))});TS.click.addHandler(function(e){var search_match=TS.client&&TS.search.view.getMatchForSearchResult($(e.target));TS.inline_attachments.checkForInlineAttachmentClick(e,search_match&&search_match.match);if(search_match&&TS.client)TS.ui.utility.updateClosestMonkeyScroller($(e.target))});TS.click.addHandler(TS.inline_file_previews.checkForInlineFilePreviewClick);if(TS.boot_data.feature_calls){TS.click.addHandler(TS.inline_room_previews.checkForInlineRoomPreviewClick)}TS.click.addClientHandler(".file_list_item",function(e,$el,preview_origin){var can_click_through;var $target=$(e.target);if(TS.boot_data.feature_files_list){can_click_through=!TS.menu.file.file_list_menu_up&&!$target.is(".star")&&(!$target.closest("a").length&&!$target.closest("button").length)}else{can_click_through=!TS.menu.file.file_list_menu_up&&!$target.is(".star")&&!$target.closest("a").length&&!$target.closest(".preview").length&&!$target.closest(".snippet_preview").length}if(can_click_through){e.preventDefault();if(!TS.boot_data.feature_files_list){if(TS.client.windows.openFileWindow($el.data("file-id")))return}var file_id=$el.data("file-id");if(TS.files.fileIsImage(file_id)){TS.ui.fs_modal_file_viewer.start({modal_class:"fs_modal_file_viewer",$el:$el,current_file_id:file_id,show_control_btns:false});return}if(TS.ui.share_dialog.showing)TS.ui.share_dialog.div.modal("hide");TS.client.ui.files.previewFile($el.data("file-id"),preview_origin||"file_list",false);return}});TS.click.addClientHandler("a.file_share, button.file_share",function(e,$el){e.preventDefault();TS.view.files.shareInCurrentChannelOrIM($el.data("file-id"))});TS.click.addClientHandler(".snippet_edit_dialog_link",function(e,$el){var file=TS.files.getFileById($el.data("file-id"));if(!file.is_truncated){e.preventDefault();TS.ui.snippet_dialog.startEdit(file.id)}});TS.click.addClientHandler(".file_new_window_link",function(e,$el){if(TS.client.windows.openFileWindow($el.data("file-id"),"")){e.preventDefault()}else{TS.utility.welcome_post.clogWelcomePostOpen($el)}});TS.click.addClientHandler("a.show_parent_replies, a.show_replies, .reply_bar",function(e,$el,origin){if(!TS.replies||!TS.replies.isEnabled())return;e.preventDefault();var $msg_el=$el.closest("ts-message");var thread_ts=$msg_el.attr("data-thread-ts");if(!thread_ts)return;var model_ob_id=$msg_el.attr("data-model-ob-id");var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;TS.ui.replies.openConversation(model_ob,thread_ts,null,origin);return});TS.click.addWebHandler(".reply_bar",function(e,$el,origin){if(!TS.replies||!TS.replies.isEnabled())return;var target=$(e.target);if(!target.is("a")){var $msg_el=$el.closest("ts-message");var thread_ts=$msg_el.attr("data-thread-ts");if(!thread_ts)return;var model_ob_id=$msg_el.attr("data-model-ob-id");var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var url=TS.utility.msgs.constructConversationPermalink(model_ob,thread_ts);window.open(url)}});TS.click.addClientHandler('[data-action="open_conversation"]',function(e,$el,origin){e.preventDefault();var model_ob_id=$el.attr("data-model-ob-id");var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;var thread_ts=$el.attr("data-thread-ts");if(!thread_ts)return;var reply_ts=$el.attr("data-ts");TS.ui.replies.openConversation(model_ob,thread_ts,reply_ts,origin)});TS.click.addClientHandler("#mentions_clear_notifications",function(e){e.preventDefault();TS.replies.markAllThreads()});TS.click.addClientHandler("#mentions_tab_bar li",function(e,$el){e.preventDefault();var tab_name=$el.attr("data-tab-name");TS.mentions.setActiveTab(tab_name)});TS.click.addClientHandler("#reply_container .reply_send",function(e,$el){if(!TS.boot_data.feature_message_replies)return;e.preventDefault();TS.ui.replies.submitReply(e,$el)});TS.click.addClientHandler("#threads_msgs .reply_send",function(e,$el){if(!TS.boot_data.feature_message_replies_threads_view)return;e.preventDefault();TS.client.ui.threads.submitReply(e,$el)});TS.click.addClientHandler("#reply_container .join_channel_from_thread",function(e,$el){if(!TS.boot_data.feature_message_replies)return;e.preventDefault();TS.ui.replies.joinChannelFromThread(e,$el)});TS.click.addClientHandler("a.see_all_pins",function(e,$el){if(TS.client&&TS.client.channel_page){e.preventDefault();TS.client.ui.flex.openFlexTab("details");TS.client.channel_page.showPinsSection();$("#channel_page_scroller .channel_page_pinned_items").highlight(null,"channel_page_pinned_items_highlighter")}});TS.click.addClientHandler("a[href]",function(e,$el){if(TS.client.archives.maybeHandleArchiveLink($el)){if(TS.ui.fs_modal_file_viewer&&TS.ui.fs_modal_file_viewer.is_showing){TS.ui.fs_modal.close()}e.preventDefault();return}if(TS.boot_data.feature_calls&&TS.utility.calls.maybeHandleCallLink($el)){e.preventDefault();return}if(!$el.attr("target")&&$el.attr("href").toLowerCase().indexOf("skype:")!==0){e.preventDefault();TS.utility.openInNewTab($el.attr("href"),TS.templates.builders.newWindowName());return}var file_id=TS.utility.getFileIDFromURL($el.attr("href"));if(file_id&&TS.client.windows.openFileWindow(file_id,"")){e.preventDefault();return}});TS.click.addClientHandler(".search_message_result",function(e,$el){var $result=$(this);var $target=$(e.target);if($target.attr("href")||$target.attr("onclick"))return;if($target.parents(".message").length&&window.getSelection&&window.getSelection().toString())return;var match_with_index=TS.search.view.getMatchForSearchResult($el);if(!match_with_index)return;if($result.hasClass("no_extracts"))return;e.preventDefault();TS.search.view.toggleExtractsForMatch(e,match_with_index)});TS.click.addClientHandler(".attachment_show_more",function(e,$el){var model_ob=TS.shared.getActiveModelOb();var ts=$el.data("msg-ts").toString();var msg=TS.utility.msgs.findMsg(ts,model_ob.id);var shown_attachments=msg._shown_attachments;if(Number.isInteger(shown_attachments)&&shown_attachments+20<=msg.attachments.length){msg._shown_attachments+=20}else{msg._shown_attachments=msg.attachments.length}if(ts==TS.shared.getLatestMsgTs(model_ob)){TS.shared.markReadMsg(model_ob.id,ts,TS.model.marked_reasons.viewed)}TS.client.msg_pane.rebuildMsgs()});TS.click.addClientHandler(".attachment_actions_buttons .btn",function(e){e.preventDefault();var context=TS.attachment_actions.handleActionEventAndGetContext($(e.target));if(context.action.confirm){TS.attachment_actions.confirmAction(context.action,function(){TS.attachment_actions.action_triggered_sig.dispatch(context)})}else{TS.attachment_actions.action_triggered_sig.dispatch(context)}});if(!TS.boot_data.feature_better_msg_copying){TS.click.addClientHandler("#msgs_div ts-message",function(e,$el){if(!$el.data("triple-clicks-constrained")){$el.append('<span class="constrain_triple_clicks"></span>');$el.data("triple-clicks-constrained",true)}})}TS.click.addClientHandler("#threads_view_banner .clear_unread_messages",function(e,$el){e.preventDefault();TS.client.threads.markAllNewThreads()});TS.click.addClientHandler("#threads_view_banner",function(e,$el){e.preventDefault();TS.client.ui.threads.jumpToTop()});TS.click.addClientHandler(".reveal_new_replies",function(e,$el){var $thread=$el.closest("ts-thread");if(!$thread.length)return;e.preventDefault();var model_ob_id=$thread.attr("data-model-ob-id");var thread_ts=$thread.attr("data-thread-ts");TS.client.threads.showNewRepliesAndMarkThread(model_ob_id,thread_ts)});if(TS.boot_data.feature_app_cards_and_profs_frontend){
TS.click.addClientHandler(".app_preview_link",function(e,$el){e.preventDefault();var $closest_ts_message=$el.closest("[data-app-id]");var app_id=$closest_ts_message.data("app-id");var bot_id=$closest_ts_message.data("bot-id");if(app_id){TS.menu.app.startWithApp(e,app_id,bot_id)}else{TS.warn("hmm, no data-app-id?")}})}};var _setupBinding=function(){var mousedown_position={};$("body").on("mousedown.ts_dot_click_mousedown",function(e){mousedown_position.x=e.clientX;mousedown_position.y=e.clientY});$("body").on("click.ts_dot_click",function(e){if(e.isDefaultPrevented())return;if(TS.view&&TS.view.maybeFollowLink(e))return;if(TS.isPartiallyBooted()){e.preventDefault();return}var $target=$(e.target);var preview_origin=_getPreviewOrigin(e);var handler;var $el;for(var i=0;i<_handlers.length;i++){handler=_handlers[i];$el=null;if(handler.prevent_on_drag&&(e.clientX!=mousedown_position.x||e.clientY!=mousedown_position.y)){continue}else if(handler.selector){$el=$target.closest(handler.selector);if(!$el.length)continue;handler.fn(e,$el,preview_origin);if(e.isDefaultPrevented())TS.log(2003,"click on "+handler.selector)}else{handler.fn(e,preview_origin)}if(e.isDefaultPrevented())return}})};var _getPreviewOrigin=function(e){var $target=$(e.target);if($target.closest("#search_results_container").length)return"search_results";if($target.closest("#member_stars_list").length)return"starred_items";if($target.closest("#member_mentions").length)return"mentions";if($target.closest("#file_list").length)return"file_list";if($target.closest("#file_preview_scroller").length)return"file_preview";if($target.closest("#member_preview_scroller").length)return"member_preview";if($target.closest("#convo_scroller").length)return"conversation";if(TS.boot_data.feature_message_replies&&$target.closest("#threads_msgs_scroller_div").length)return"threads";if($target.closest("#channel_page_scroller").length){var model_ob=TS.shared.getActiveModelOb();var origin="channel_page";if(model_ob.is_group&&!model_ob.is_mpim){origin="group_page"}else if(model_ob.is_im||model_ob.is_mpim){origin="im_page"}return origin}return null}})();(function(){"use strict";TS.registerModule("frecency",{onStart:function(){},construct:function(namespace,options){return _createFrecency(namespace,options)},getExisting:function(namespace){return _getFrecency(namespace)},test:function(){return{_clearInstance:function(namespace){delete _instances[namespace]}}}});var _DAY=1e3*60*60*24;var _BUCKETS=[1e3*60*60*4,_DAY,_DAY*3,_DAY*7,_DAY*30,_DAY*90];var _WEIGHTS=[100,80,60,40,20,10];var _REDUCED_MULTIPLIER=.5;var _PRUNE_AFTER=_BUCKETS[_BUCKETS.length-1];var _PRUNE_BELOW_COUNT=100;function _getFrecency(namespace){return _instances[namespace]}function _createFrecency(namespace,options){if(_instances[namespace]){TS.error('namespace "'+namespace+'" already exists');return null}var _cache;_cache=TS.storage.fetchFrecency(namespace)||{};if(options&&options.onStart)_cache=options.onStart(namespace);function _query(list,text,bonusPoints,sortOptions){var keys=_.keys(_cache);if(!bonusPoints)bonusPoints=function(){return 0};var hits={};_.each(keys,function(key){if(key.indexOf(text)>-1||text.indexOf(key)>-1){if(Array.isArray(_cache[key])){_.each(_cache[key],function(item){if(hits[item.id]){var old_score=_calculateScore(hits[item.id]);var new_score=_calculateScore(item);if(new_score>old_score){hits[item.id]=item}}else{hits[item.id]=item}})}else{if(hits[_cache[key].id]){var old_score=_calculateScore(hits[_cache[key].id]);var new_score=_calculateScore(_cache[key]);if(new_score>old_score){hits[_cache[key].id]=_cache[key]}}else{hits[_cache[key].id]=_cache[key]}}}});var new_list=[];_.each(list,function(item,index){var extra_score=0;if(_cache[item.id]){extra_score=_calculateScore(_cache[item.id])}if(!sortOptions||!sortOptions.normalize){extra_score+=bonusPoints(item,sortOptions)}new_list.push({id:item.id,score:_calculateScore(hits[item.id])+extra_score,original_index:index})});if(sortOptions&&sortOptions.normalize){new_list=_normalize(new_list);new_list=_.map(new_list,function(item,i){item.score+=bonusPoints(list[i],sortOptions);return item})}new_list.sort(function(a,b){if(a.score===b.score)return a.original_index-b.original_index;return b.score-a.score});return new_list}function _record(item,text){if(_cache[text]&&!Array.isArray(_cache[text])){if(_cache[text].id===item.id){_countVisit(_cache[text])}else{_cache[text]=[_cache[text],_createCacheRecord(item.id)]}}else if(Array.isArray(_cache[text])){var exists=false;for(var i=0;i<_cache[text].length;i++){if(_cache[text][i].id===item.id){_countVisit(_cache[text][i]);exists=true;break}}if(!exists){_cache[text].push(_createCacheRecord(item.id))}}else{_cache[text]={id:item.id,count:1,visits:[Date.now()]}}if(_cache[item.id]){_countVisit(_cache[item.id]);_cache[item.id]._reduced=true}else{_cache[item.id]=_createCacheRecord(item.id);_cache[item.id]._reduced=true}if(options&&options.recordFunc){options.recordFunc(_cache)}else{TS.storage.storeFrecency(namespace,_cache)}}function _normalize(list){var high_score=_.get(_.maxBy(list,"score"),"score")||0;return _.map(list,function(item){if(item.score>0)item.score=item.score/high_score*100;return item})}function _countVisit(item){item.count++;if(item.visits.length===10)item.visits.shift();item.visits.push(Date.now())}function _createCacheRecord(id){return{id:id,count:1,visits:[Date.now()]}}function _getMostCommon(max,normalize){var new_cache={};var new_list=[];_traverseCache(false,function(item){if(!new_cache[item.id]){new_cache[item.id]={id:item.id,score:_calculateScore(item)+_cache[item.id]?_calculateScore(_cache[item.id]):0}}else{new_cache[item.id].score+=_calculateScore(item)}});new_list=_.toArray(new_cache);new_list.sort(function(a,b){return b.score-a.score});if(max){new_list=new_list.slice(0,max)}if(normalize){new_list=_normalize(new_list)}return new_list}function _getMostCommonWithPrefix(prefix,max,normalize){var new_cache={};var new_list=[];_traverseCache(false,function(item){if(item.id[0]!==prefix)return;if(!new_cache[item.id]){new_cache[item.id]={id:item.id,score:_calculateScore(item)+_cache[item.id]?_calculateScore(_cache[item.id]):0}}else{new_cache[item.id].score+=_calculateScore(item)}});new_list=_.toArray(new_cache);new_list.sort(function(a,b){return b.score-a.score});if(max){new_list=new_list.slice(0,max)}if(normalize){new_list=_normalize(new_list)}return new_list}function _calculateScore(item){if(!item||!item.visits)return 0;var points=0;var i=item.visits.length-1;var now=Date.now();for(i;i>=0;i--)points+=_weighVisit(now-item.visits[i]);if(item._reduced){points*=_REDUCED_MULTIPLIER}return item.count*points/item.visits.length}function _weighVisit(recency){var i=0;var length=_BUCKETS.length;for(i;i<length;i++){if(recency<_BUCKETS[i])return _WEIGHTS[i]}return 0}function _getCache(item){if(item)return _cache[item];return _cache}function _setCache(data){_cache=data}function _clearCache(){_cache={};TS.storage.clearFrecency(namespace);if(options&&options.onClearCache)options.onClearCache()}function _pruneCache(){var keys=Object.keys(_cache);_.each(keys,function(key){if(_.isArray(_cache[key])){for(var i=_cache[key].length;i>-1;i--){if(_shouldPruneCacheItem(_cache[key][i])){_cache[key].splice(i,1)}}if(!_cache[key].length){_cache[key]=null;delete _cache[key]}}else{if(_shouldPruneCacheItem(_cache[key])){_cache[key]=null;delete _cache[key]}}})}function _shouldPruneCacheItem(item){if(!item||_.isEmpty(item.visits)){return true}else{if(Date.now()-item.visits[item.visits.length-1]>_PRUNE_AFTER&&item.count<_PRUNE_BELOW_COUNT){return true}}}function _traverseCache(including_reduced,callback){_.each(_cache,function(item){if(!including_reduced&&item._reduced)return;if(Array.isArray(item)){_.each(item,function(entry){callback(entry)})}else{callback(item)}})}var api={query:_query,record:_record,getMostCommon:_getMostCommon,getMostCommonWithPrefix:_getMostCommonWithPrefix,_getCache:_getCache,_setCache:_setCache,_clearCache:_clearCache,_pruneCache:_pruneCache,_test:{_REDUCED_MULTIPLIER:_REDUCED_MULTIPLIER,_PRUNE_BELOW_COUNT:_PRUNE_BELOW_COUNT,_traverseCache:_traverseCache}};_instances[namespace]=api;return api}var _instances={}})();(function(){"use strict";TS.registerModule("ui.frecency",{onStart:function(){if(TS.client)TS.client.before_login_sig.addOnce(_onBeforeLogin);if(TS.web)TS.web.before_login_sig.addOnce(_onBeforeLogin);TS.prefs.frecency_jumper_changed_sig.add(_setFrecencyCache)},record:function(){_frecency.record.apply(this,arguments)},query:function(){return _frecency.query.apply(this,arguments)},clearCache:function(){_frecency._clearCache.apply(this)},getMostCommonWithPrefix:function(){return _frecency.getMostCommonWithPrefix.apply(this,arguments)},isEnterprise:function(){return TS.boot_data.feature_enterprise_frecency&&TS.boot_data.page_needs_enterprise},bonus_points:{starred_channel:10,member_of_this_channel:10,archived_channel_or_group:-25,not_in_channel:-25,usergroup_or_keyword:-25,fuzzy_match:50,exact_match:100,matches_previous_name:-10}});var _frecency;var _THROTTLE_MS=1e3*60;var _onBeforeLogin=function _onBeforeLogin(){_frecency=TS.frecency.construct("jumper",{onStart:function(namespace){_setPrefThrottled=TS.utility.throttleFunc(_setPrefThrottled,_THROTTLE_MS,true);return TS.model.frecency_jumper},recordFunc:function(cache){TS.model.frecency_jumper=cache;_setPrefThrottled()},onClearCache:function(){TS.prefs.setPrefByAPI({name:TS.ui.frecency.isEnterprise()?"frecency_ent_jumper":"frecency_jumper",value:"{}"})}})};var _setFrecencyCache=function _setFrecencyCache(){_frecency._setCache(TS.model.frecency_jumper)};var _setPrefThrottled=function _setPrefThrottled(){TS.prefs.setPrefByAPI({name:TS.ui.frecency.isEnterprise()?"frecency_ent_jumper":"frecency_jumper",value:JSON.stringify(TS.model.frecency_jumper)})}})();(function(){"use strict";TS.registerModule("sorter",{onStart:function(){},search:function(query,data,options){return _search(query,data,options)},printTest:function(query,options){var all_members=TS.members.getActiveMembersWithSlackbotAndNotSelf();var all_channels=TS.channels.getUnarchivedChannelsForUser();var all_groups=TS.groups.getUnarchivedGroups();var all_mpims=TS.mpims.getVisibleMpims();var all_teams=_.values(TS.boot_data.other_accounts);var all_usergroups=TS.user_groups.getActiveUserGroups();var all_emoji=TS.model.emoji_map;var all_broadcast_keywords=TS.utility.members.getBroadcastKeywordsForUser();var all_views=TS.model.NAMED_VIEWS;var data={members:all_members,channels:all_channels,groups:all_groups,mpims:all_mpims,teams:all_teams,usergroups:all_usergroups,emoji:all_emoji,broadcast_keywords:all_broadcast_keywords,views:all_views};TS.sorter.search(query,data,_.extend({print:true},options))},test:function(){return{sortFuzzy:_sortFuzzy,frecencyBonusPoints:TS.boot_data.feature_frecency_normalization?_frecencyBonusPointsNormalized:_frecencyBonusPoints,getFilteredMatchesForFrecency:_getFilteredMatchesForFrecency,scoreMember:_scoreMember,_scoreUserGroup:_scoreUserGroup,getSubQueryMatchers:_getSubQueryMatchers}}});var _SORT_LOCAL_AWARE_LIMIT=24;var _makeFuzzySearcher=function(query,options){var fuzzy_limit=options.fuzzy_limit!=null?options.fuzzy_limit:10;query=query.toLocaleLowerCase();var only_members=query.charAt(0)==="@";var only_channels=query.charAt(0)==="#";var only_emoji=query.charAt(0)===":";if(only_members||only_channels||only_emoji)query=query.substring(1);var fuzzy_options={fuzzy_limit:fuzzy_limit};var fuzzy_member_options={fuzzy_limit:fuzzy_limit,search_forward_only:true};var fuzzy_emoji_options={fuzzy_limit:fuzzy_limit,substrings_only:true};var fuzzy=TS.fuzzy.makeFuzzyMatcher(query,fuzzy_options);var fuzzy_members=TS.fuzzy.makeFuzzyMatcher(query,fuzzy_member_options);var sub_query_matchers=_getSubQueryMatchers(query,fuzzy_member_options);var fuzzy_emoji=TS.fuzzy.makeFuzzyMatcher(query,fuzzy_emoji_options);return{query:query,only_channels:only_channels,only_members:only_members,only_emoji:only_emoji,matchesChannel:function(c){if(only_members||only_emoji)return false;if((options.allow_empty_query||only_channels)&&!query){c._jumper_score=0;return true}var score=fuzzy.score(c.name);c._jumper_score=score;if(TS.boot_data.feature_reveal_channel_renames&&options.search_previous_channel_names&&c.previous_names&&c.previous_names.length){c._jumper_previous_name_scores=_.map(c.previous_names,function(name){return{score:fuzzy.score(name),name:name}});var did_match_previous_names=_.some(c._jumper_previous_name_scores,function(o){return o.score<=fuzzy_limit});c._jumper_only_matched_previous_names=did_match_previous_names&&score>fuzzy_limit;if(c._jumper_only_matched_previous_names){var lowest=_.minBy(c._jumper_previous_name_scores,"score");c._jumper_previous_name_match=lowest&&lowest.name}else{c._jumper_previous_name_match=null}return score<=fuzzy_limit||did_match_previous_names}return score<=fuzzy_limit},matchesGroup:function(g){if(only_channels||only_members||only_emoji)return false;if(options.allow_empty_query&&!query){g._jumper_score=0;return true}var score=fuzzy.score(g.name);g._jumper_score=score;return score<=fuzzy_limit},matchesMember:function(m){if(only_channels||only_emoji)return false;if((options.allow_empty_query||only_members)&&!query){m._jumper_score=0;return true}var score=_scoreMember(m,fuzzy_members,query);m._jumper_score=score;return score<=fuzzy_limit},matchesMpim:function(mpim){if(only_channels||only_members||only_emoji)return false;if(options.allow_empty_query&&!query){mpim._jumper_score=0;return true}var members=TS.mpims.getMembersInDisplayOrder(mpim);var scores=sub_query_matchers.map(function(query_matcher){var scores=members.map(function(m){return _scoreMember(m,query_matcher)});return _.min(scores)}.bind(this));var total=_.sum(scores);mpim._jumper_score=total;return total<=fuzzy_limit},matchesTeam:function(team){if(only_channels||only_members||only_emoji)return false;var score=fuzzy.score(team.team_name.toLocaleLowerCase());team._jumper_score=score;return score<=fuzzy_limit},matchesUserGroup:function(ug){if(only_channels||only_emoji)return false;if((options.allow_empty_query||only_members)&&!query){ug._jumper_score=0;return true}var score=_scoreUserGroup(ug,fuzzy);ug._jumper_score=score;return score<=fuzzy_limit},matchesEmoji:function(emoji){if(only_channels||only_members)return false;if(options.allow_empty_query&&!query){emoji._jumper_score=0;return true}var score=fuzzy_emoji.score(emoji.name);emoji._jumper_score=score;return score<=fuzzy_limit},matchesBroadcastKeyword:function(bk){if(only_channels||only_emoji)return false;if((options.allow_empty_query||only_members)&&!query){bk._jumper_score=0;return true}var score=_scoreBroadcastKeyword(bk,fuzzy);bk._jumper_score=score;return score<=fuzzy_limit},matchesView:function(v){if(only_channels||only_emoji)return false;var score=fuzzy.score(v.name.toLocaleLowerCase());v._jumper_score=score;return score<=fuzzy_limit}}};var _getSubQueryMatchers=function(query,fuzzy_options){var sub_queries=query.split(/[,| ]/).filter(function(i){return!!i});return sub_queries.map(function(q){q=q.charAt("0")==="@"?q.substring(1):q;return TS.fuzzy.makeFuzzyMatcher(q,fuzzy_options)})};var _scoreMember=function(member,matcher,query){if(TS.utility.queryIsMaybeSelf(query)&&member.is_self)return 0;if(TS.boot_data.feature_name_tagging_client){var full_name_score=Infinity;var full_name_normalized_score=Infinity;var preferred_name_score=Infinity;var preferred_name_normalized_score=Infinity;full_name_score=matcher.score(member._full_name_lc);if(member._full_name_lc!==member._full_name_normalized_lc){full_name_normalized_score=matcher.score(member._full_name_normalized_lc)}if(member._preferred_name_lc){preferred_name_score=matcher.score(member._preferred_name_lc);if(member._preferred_name_lc!==member._preferred_name_normalized_lc){preferred_name_normalized_score=matcher.score(member._preferred_name_normalized_lc)}}var score=Math.min(full_name_score,full_name_normalized_score,preferred_name_score,preferred_name_normalized_score)}else{var name_score=Infinity;var rn_score=Infinity;var rn_norm_score=Infinity;name_score=matcher.score(member.name);if(member._real_name_lc){rn_score=matcher.score(member._real_name_lc);if(member._real_name_lc!==member._real_name_normalized_lc){rn_norm_score=matcher.score(member._real_name_normalized_lc)}}var score=Math.min(name_score,rn_score,rn_norm_score)}return score};var _scoreUserGroup=function(usergroup,matcher){var name_score=Infinity;var handle_score=Infinity;name_score=matcher.score(usergroup.name);handle_score=matcher.score(usergroup.handle);var score=Math.min(name_score,handle_score);return score};var _scoreBroadcastKeyword=function(bk,matcher){var name_score=Infinity;name_score=matcher.score(bk.name);if(!bk.alias)return name_score;var alias_score=Infinity;alias_score=matcher.score(bk.alias);var score=Math.min(name_score,alias_score);return score};var _search=function(query,data,options){var searcher=_makeFuzzySearcher(query,options||{});var exact_matches=[];var member_matches=[];var channel_matches=[];var channel_matches_not_member=[];var channel_matches_archived=[];var group_matches=[];var group_matches_archived=[];var mpim_matches=[];var team_matches=[];var usergroup_matches=[];var emoji_matches=[];var broadcast_keyword_matches=[];var view_matches=[];data.members=data.members||[];data.channels=data.channels||[];data.groups=data.groups||[];data.mpims=data.mpims||[];data.teams=data.teams||[];data.usergroups=data.usergroups||[];data.emoji=data.emoji||[];data.broadcast_keywords=data.broadcast_keywords||[];data.views=data.views||[];if(!searcher.only_channels&&!searcher.only_emoji){member_matches=data.members.filter(function(m){if(TS.boot_data.feature_name_tagging_client){if(options.prefer_exact_match&&(TS.members.getMemberPreferredName(m).toLocaleLowerCase()===searcher.query||TS.members.getMemberFullName(m).toLocaleLowerCase()===searcher.query)){m._jumper_exact_match=true;exact_matches.push(m);return false}else{m._jumper_exact_match=false}}if(options.prefer_exact_match&&m.name===searcher.query){m._jumper_exact_match=true;exact_matches.push(m);return false}else{m._jumper_exact_match=false}return searcher.matchesMember(m)});usergroup_matches=data.usergroups.filter(function(ug){if(options.prefer_exact_match&&ug.handle===searcher.query||ug.name_lc===searcher.query){exact_matches.push(ug);return false}return searcher.matchesUserGroup(ug)});broadcast_keyword_matches=data.broadcast_keywords.filter(function(bk){if(options.prefer_exact_match&&bk.name===searcher.query){exact_matches.push(bk);return false}return searcher.matchesBroadcastKeyword(bk)})}if(!searcher.only_members&&!searcher.only_emoji){data.channels.forEach(function(c){if(options.prefer_exact_match&&c.name===searcher.query){c._jumper_exact_match=true;exact_matches.push(c);return false}else{c._jumper_exact_match=false}var matched=searcher.matchesChannel(c);if(!matched)return;if(c.is_member){channel_matches.push(c)}else{if(c.is_archived){channel_matches_archived.push(c)}else{channel_matches_not_member.push(c)}}})}if(!searcher.only_channels&&!searcher.only_members&&!searcher.only_emoji){data.groups.forEach(function(g){if(options.prefer_exact_match&&g.name===searcher.query){g._jumper_exact_match=true;exact_matches.push(g);return false}else{g._jumper_exact_match=false}var matched=searcher.matchesGroup(g);if(!matched)return;if(g.is_archived){group_matches_archived.push(g)}else{group_matches.push(g)}});mpim_matches=data.mpims.filter(function(mpim){return searcher.matchesMpim(mpim)});team_matches=data.teams.filter(function(team){if(options.prefer_exact_match&&team.team_name.toLocaleLowerCase()===searcher.query){team._jumper_exact_match=true;exact_matches.push(team);return false}else{team._jumper_exact_match=false}var match=searcher.matchesTeam(team);return match})}if(!searcher.only_channels&&!searcher.only_members){emoji_matches=data.emoji.filter(function(e){if(options.prefer_exact_match&&e.name===searcher.query){e._jumper_exact_match=true;exact_matches.push(e);return false}else{e._jumper_exact_match=false}return searcher.matchesEmoji(e)})}if(TS.boot_data.feature_unread_view&&TS.client&&TS.client.unread.isEnabled()){if(!searcher.only_channels&&!searcher.only_members){view_matches=data.views.filter(function(v){if(options.prefer_exact_match&&v.name===searcher.query){exact_matches.push(v);return false}return searcher.matchesView(v)})}}var primary_matches,secondary_matches,tertiary_matches,sort_locale_aware;primary_matches=member_matches.concat(channel_matches,group_matches,mpim_matches,emoji_matches,usergroup_matches,broadcast_keyword_matches,view_matches);sort_locale_aware=primary_matches.length<_SORT_LOCAL_AWARE_LIMIT;primary_matches.sort(_.partial(_sortFuzzy,sort_locale_aware));secondary_matches=channel_matches_not_member.concat(team_matches);sort_locale_aware=secondary_matches.length<_SORT_LOCAL_AWARE_LIMIT;secondary_matches.sort(_.partial(_sortFuzzy,sort_locale_aware));tertiary_matches=group_matches_archived.concat(channel_matches_archived);sort_locale_aware=tertiary_matches.length<_SORT_LOCAL_AWARE_LIMIT;tertiary_matches.sort(_.partial(_sortFuzzy,sort_locale_aware));var all_matches=primary_matches.concat(secondary_matches,tertiary_matches);var filtered_matches=all_matches;if(options.prefer_exact_match&&exact_matches.length>0){for(var i=0;i<exact_matches.length;i++){filtered_matches.unshift(exact_matches[i])}}if(options.frecency){if(TS.boot_data.feature_frecency_normalization){options.normalize=true;filtered_matches=TS.ui.frecency.query(filtered_matches,query,_frecencyBonusPointsNormalized,options)}else{filtered_matches=TS.ui.frecency.query(filtered_matches,query,_frecencyBonusPoints,options)}if(!TS.boot_data.feature_frecency_normalization){if(emoji_matches.length>0&&options.prefer_exact_match&&exact_matches.length>0&&query.length>2){var exact_match=[];for(var i=0;i<exact_matches.length;i++){exact_match=_.remove(filtered_matches,{id:exact_matches[i].id});filtered_matches.unshift(exact_match[0])}}}}if(options.limit){filtered_matches=_.take(filtered_matches,options.limit)}if(options.frecency){filtered_matches=_getFilteredMatchesForFrecency(filtered_matches)}if(options.print){var output="\n";filtered_matches.forEach(function(match){var model_ob=options.frecency?match.model_ob:match;if(options.frecency)output+="["+match.score+"] ";if(model_ob._jumper_score!=null)output+="["+model_ob._jumper_score+"] ";if(model_ob.is_mpim){output+=TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_channel){output+="#"+model_ob.name}else if(model_ob.is_group){output+=model_ob.name}else if(model_ob.team_name){output+=model_ob.team_name}else if(model_ob.is_usergroup){output+="@"+model_ob.name}else if(model_ob.presence){output+="@"+model_ob.name}else{output+=match.model_ob.name}output+="\n"});TS.info(output)}return filtered_matches};var _getFilteredMatchesForFrecency=function(filtered_matches){var matches_for_render=[];if(TS.boot_data.page_needs_enterprise){filtered_matches=_.uniqBy(filtered_matches,function(match){return match.id})}_.forEach(filtered_matches,function(f_match){var model_ob;if(TS.boot_data.page_needs_enterprise){if(TS.utility.strLooksLikeAMemberId(f_match.id)){var member_model_ob=TS.members.getMemberById(f_match.id);if(member_model_ob){matches_for_render.push({model_ob:member_model_ob,score:f_match.score});return}}var team_match=_.find(TS.boot_data.other_accounts,function(account){return account.id===f_match.id&&account.team_id!=TS.model.team.id});var bk_match=f_match.id.indexOf("BK")===0;var view_match=f_match.id.indexOf("V")===0;if(team_match){model_ob=team_match}else if(bk_match){model_ob=TS.model.getBroadcastKeywordById(f_match.id)}else if(view_match){model_ob=TS.model.getViewById(f_match.id)}else{model_ob=TS.shared.getModelObById(f_match.id)}if(model_ob){matches_for_render.push({model_ob:model_ob,score:f_match.score})}}else{var team_match=_.find(TS.boot_data.other_accounts,function(account){return account.id===f_match.id&&account.team_id!=TS.model.team.id});var bk_match=f_match.id.indexOf("BK")===0;var view_match=f_match.id.indexOf("V")===0;if(team_match){model_ob=team_match}else if(bk_match){model_ob=TS.model.getBroadcastKeywordById(f_match.id)}else if(view_match){model_ob=TS.model.getViewById(f_match.id)}else if(TS.utility.strLooksLikeAMemberId(f_match.id)){model_ob=TS.members.getMemberById(f_match.id)}else{model_ob=TS.shared.getModelObById(f_match.id)}matches_for_render.push({model_ob:model_ob,score:f_match.score})}});return matches_for_render};var _getNameForComparison=function(model_ob){var name;if(model_ob.is_mpim){name=TS.mpims.getDisplayNameLowerCase(model_ob)}else if(model_ob.is_usergroup){name=model_ob.handle}else if(model_ob._name_lc){name=model_ob._name_lc}else if(model_ob.team_name){name=model_ob.team_name.toLocaleLowerCase()}else{name=model_ob.name}return name};var _sortFuzzy=function(locale_aware,a,b){if(a.is_mpim&&!b.is_mpim)return 1;if(b.is_mpim&&!a.is_mpim)return-1;if(!a.is_mpim&&!b.is_mpim){var score_diff=a._jumper_score-b._jumper_score;if(score_diff!==0)return score_diff}if(a.is_mpim&&b.is_mpim){var mpim_score_diff=a._jumper_score-b._jumper_score;if(mpim_score_diff!==0)return mpim_score_diff;var member_count_diff=TS.mpims.getMemberCount(a)-TS.mpims.getMemberCount(b);if(member_count_diff!==0)return member_count_diff}var a_name=_getNameForComparison(a);var b_name=_getNameForComparison(b);if(locale_aware){return a_name.localeCompare(b_name)}else{if(a_name>b_name)return 1;if(b_name>a_name)return-1;return 0}};var _frecencyBonusPoints=function(item,options){if(item.is_mpim)return 0;var score=_calculateFuzzyBonusPoints(item);if(options.prefer_channel_members&&item.presence){if(options.model_ob&&TS.utility.members.isMemberOfChannel(item.id,options.model_ob)){score+=100}}if(item.is_starred){score+=100}if(item.is_emoji){if(item.name==="thumbsup"||item.name==="point_up"){score+=1}}if(item.is_channel||item.is_group){if(item.is_archived){score-=100}if(options.prefer_channels_user_belongs_to){if(!item.is_archived&&!TS.utility.members.isMemberOfChannel(TS.model.user.id,TS.shared.getModelObById(item.id))){score-=100}}}if(item.is_usergroup||item.is_broadcast_keyword){score-=100}return score};var _frecencyBonusPointsNormalized=function(item,options){if(item.is_mpim)return 0;var score=0;if(item._jumper_exact_match){score+=TS.ui.frecency.bonus_points.exact_match}else{score+=_calculateNormalizedFuzzyBonusPoints(item)}if(TS.boot_data.feature_reveal_channel_renames){if(item._jumper_previous_name_scores){score+=TS.ui.frecency.bonus_points.matches_previous_name}}if(options.prefer_channel_members&&item.presence){if(options.model_ob&&TS.utility.members.isMemberOfChannel(item.id,options.model_ob)){score+=TS.ui.frecency.bonus_points.member_of_this_channel}}if(item.is_starred){score+=TS.ui.frecency.bonus_points.starred_channel}if(item.is_emoji){if(item.name==="thumbsup"||item.name==="point_up"){score+=1}}if(item.is_channel||item.is_group){if(item.is_archived){score+=TS.ui.frecency.bonus_points.archived_channel_or_group}if(options.prefer_channels_user_belongs_to){if(!item.is_archived&&!TS.utility.members.isMemberOfChannel(TS.model.user.id,TS.shared.getModelObById(item.id))){score+=TS.ui.frecency.bonus_points.not_in_channel}}}if(item.is_usergroup||item.is_broadcast_keyword){score+=TS.ui.frecency.bonus_points.usergroup_or_keyword}return score};var _calculateFuzzyBonusPoints=function(item){var fuzziness=item._jumper_score;if(!_.isFinite(fuzziness))return 0;var scaler=Math.pow(.5,fuzziness);var exact_match_bonus=500;return Math.round(exact_match_bonus*scaler)};var _calculateNormalizedFuzzyBonusPoints=function(item){var fuzziness=item._jumper_score;if(!_.isFinite(fuzziness))return 0;var scaler=Math.pow(.5,fuzziness);return Math.round(TS.ui.frecency.bonus_points.fuzzy_match*scaler)}})();(function(){"use strict";TS.registerModule("fuzzy",{onStart:function(){},score:function(str,query,options){if(!options)options={};var matcher=TS.fuzzy.makeFuzzyMatcher(query,options);return matcher.score(str)},makeFuzzyMatcher:function(query,options){var query_node=_queryToLinkedList(query);if(null==options.fuzzy_limit)options.fuzzy_limit=Infinity;return{score:function(str){var should_continue=_containsAllLetters(str,query_node);if(!should_continue)return Infinity;if(!query_node)return Infinity;var node=_lettersToGraph(str);if(!node)return Infinity;var result=_searchWordBoundariesOnly(node,query_node,options);if(!result)return Infinity;var summed_up=_countResult(result);if(summed_up>options.fuzzy_limit)return Infinity;return summed_up}}},test:function(){return{lettersToGraph:_lettersToGraph,queryToLinkedList:_queryToLinkedList}}});var _ignored_chars=" -_'.()";var _countResult=function(result){if(!result)return 0;return result.count+_countResult(result.next)};var _searchWordBoundariesOnly=function(node,query_node,options){var first=_searchWordBoundariesOnlyWorker(node,query_node,0,options);if(!first){first=_.reduce(node.jumps,function(match,jump_node){if(match||jump_node===node)return match;return _searchWordBoundariesOnlyWorker(jump_node,query_node,1,options)},null)}return first};var _searchWordBoundariesOnlyWorker=function(node,query_node,score,options){if(!node)return null;var this_match;if(!node.visited&&(node.letter===query_node.letter||node.ignored&&query_node.is_separator)){this_match={node:node,count:score}}if(!this_match)return null;if(!query_node.next)return this_match;node.visited=true;var next=_searchWordBoundariesOnlyWorker(node.next,query_node.next,0,options);var next_query_node=query_node.next;if(next_query_node.is_space){if(next_query_node.next)next_query_node=next_query_node.next}if(!next){next=_.reduce(node.jumps,function(result,jump_node){if(result)return result;if(jump_node.visited||jump_node===node)return result;if(options.search_forward_only||options.substrings_only){if(jump_node.index<node.index)return result}if(options.substrings_only){if(jump_node.index>node.index+2)return result}return _searchWordBoundariesOnlyWorker(jump_node,next_query_node,1,options)},null)}node.visited=false;if(next){this_match.next=next;return this_match}return null};var _lettersToGraph=function(str){var letters=str.split("");var l=letters.shift();return _lettersToGraphWorker(l,null,letters,[],0)};var _lettersToGraphWorker=function(letter,prev,rest,jumps,index){if(!letter)return null;var node=_makeLetterNode(letter,prev,jumps,index);if(!prev||prev.ignored&&!node.ignored){jumps.push(node)}var next_node=_lettersToGraphWorker(rest.shift(),node,rest,jumps,index+1);if(next_node){node.next=next_node}return node};var _makeLetterNode=function(letter,prev,jumps,index){return{letter:letter,ignored:_ignored_chars.indexOf(letter)!==-1,next:null,prev:prev,jumps:jumps,visited:false,index:index}};var _queryToLinkedList=function(query){if(!query)return null;var letters=query.split("");return _queryToLinkedListWorker(letters,0)};var _queryToLinkedListWorker=function(letters,index){if(index>=letters.length)return null;var letter=letters[index];var is_separator=_ignored_chars.indexOf(letter)!==-1&&(index!==0||letters.length>1);var is_space=letter===" ";return{letter:letter,is_separator:is_separator,is_space:is_space,next:_queryToLinkedListWorker(letters,index+1),index:index}};var _containsAllLetters=function(str,query_node){if(!query_node)return true;if(TS.boot_data.feature_tinyspeck&&(_.isUndefined(str)||str===null)){TS.warn("_containsAllLetters: str passed in was not defined: ",str)}var found_it=query_node.is_separator||str.indexOf(query_node.letter)!==-1;if(!found_it)return false;return _containsAllLetters(str,query_node.next)}})();(function(){"use strict";TS.registerModule("ui.shared_channels_invites",{onStart:function(){TS.ui.validation.register("valid_invite",_validateValidInvite)},start:function(){if(TS.boot_data.page_needs_enterprise)_start()}});var _$body;var _$div;var _$filter;var _filtered_channels=[];var _$list;var _list_built=false;var _$list_container;var _list_visible=false;var _private_shared_channels=[];var _private_shared_invites=[];var _shared_channels=[];var _shared_invites=[];var _$sort_by;var _managing=false;
var _addSentEmailsFeedback=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;_$div.find('.sci_send_email_container [data-action="replace_sent_emails"]').replaceWith(TS.templates.shared_channels_invites_sent_emails(invite))};var _name_check_wait_time=325;var _name_check_timer;var _name_available_timer;var _name_available_show_time=1e3;var _toggleChannelNameChecking=function(disable,trigger_available){if(!disable)disable=false;if(!trigger_available)trigger_available=false;_$div.find("#sci_channels_create .input_wrapper .spinner").toggleClass("hidden",disable);if(trigger_available)_toggleChannelNameAvailable(!disable)};var _toggleChannelNameAvailable=function(disable){if(_name_available_timer){clearTimeout(_name_available_timer);_name_available_timer=null}if(!disable)disable=false;var $available=_$div.find("#sci_channels_create .input_wrapper .available");$available.toggleClass("hidden",disable);if(!disable){_name_available_timer=setTimeout(function(){$available.addClass("hidden")},_name_available_show_time)}};var _bindUI=function(){TS.kb_nav.start(_$list.find(".list_items"),".channel_browser_row",_$list,{use_data_ordering:true,px_offset:35,scrollToStartImmediately:function(){_$list.longListView("scrollToTop",true)},scrollToEndImmediately:function(){_$list.longListView("scrollToEnd",true)}});TS.kb_nav.setAllowHighlightWithoutBlurringInput(true);TS.kb_nav.setSubmitItemHandler(function(e){if(_managing)_openChannel($(this),e)});_$list.find(".list_items").on("click",".channel_browser_row",function(e){_openChannel($(this),e)});_$div.on("click",'[data-action="sci_to_create"]',_switchToCreate);_$div.on("click",'[data-action="sci_channels_create"]',_createInvite);_$div.on("click",'[data-action="sci_cancel"]',_switchToManage);_$div.on("change",'[type="radio"][name="share_with"]',_toggleShareWith);_$div.on("click",'[data-action="sci_show_action"]',_showAction);_$div.on("input",'#sci_channels_create input[name="channel_name"]',function(e){e.preventDefault();e.stopPropagation();$(".validation_message").remove();$('label[for="channel_name"]').removeClass("validation_warning");$(this).removeClass("validation_warning");var $create_button=_$div.find('#sci_channels_create [data-action="sci_channels_create"]');if(_name_check_timer){clearTimeout(_name_check_timer);_name_check_timer=null}_name_check_timer=setTimeout(function(){var do_validation=false;var is_disabled=true;var disable_checking_spinner=true;var trigger_available_name_message=false;_toggleChannelNameChecking();_toggleButton(null,$create_button,do_validation,is_disabled);var validation=TS.ui.validation.validate($(this));if(validation){var $el=$(this);var new_name=$el.val().trim();TS.api.callImmediately("enterprise.nameTaken",{name:new_name,ignore_local_team:true},function(ok,data,args){if(!ok){disable_checking_spinner=true;trigger_available_name_message=false;_toggleChannelNameChecking(disable_checking_spinner,trigger_available_name_message);TS.generic_dialog.alert("Something failed! "+data.error)}else{if(data.name_taken){disable_checking_spinner=true;trigger_available_name_message=false;_toggleChannelNameChecking(disable_checking_spinner,trigger_available_name_message);is_disabled=true;_toggleButton(null,$create_button,do_validation,is_disabled);return void TS.ui.validation.showWarning($el,'"'+TS.utility.htmlEntities(new_name)+'"'+" is already taken by a channel, username, or user group.",{})}disable_checking_spinner=true;trigger_available_name_message=true;_toggleChannelNameChecking(disable_checking_spinner,trigger_available_name_message);is_disabled=false;_toggleButton(null,$create_button,do_validation,is_disabled)}})}else{disable_checking_spinner=true;_toggleChannelNameChecking(disable_checking_spinner)}}.bind(this),_name_check_wait_time)});_$div.on("input",'#sci_channels_create [data-validation]:not([name="channel_name"])',function(e){var $container=_$div.find("#sci_channels_create");_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_channels_create"]'),true)});_$filter.on("textchange",function(){if(!_list_built)return;_filterList()}).on("keydown",function(e){if(e.which===TS.utility.keymap.esc)TS.ui.fs_modal.close()});_$sort_by.on("change",function(){if(!_list_built)return;var sort_by=$(this).val();if(TS.model.ui_state){TS.model.ui_state.sort_shared_channel_browser_by=sort_by;TS.storage.storeUIState(TS.model.ui_state)}_sortChannels(sort_by);_filterList()});_$div.on("click",".clear_filter_icon",function(){_$filter.val("").trigger("textchange").focus()});_$body.on("keyup.sci",_onKeyUp);_$div.on("click",'[data-action="sci_toggle_contents"]',_toggleContents);_$div.on("click",'[data-action="sci_toggle_send_email"]',_toggleSendEmail);_$div.on("click",'[data-action="sci_toggle_copy_link"]',_toggleCopyLink);_$div.on("click",'[data-action="sci_send"]',_sendInviteEmail);_$div.on("click",'[data-action="sci_copy"]',_maybeCopyLink);_$div.on("click",'[data-action="sci_revoke"]',_revokeSharedInvite);_$div.on("input","input[data-invite-id]",function(e){var $container=$(e.target).parent();var do_validation=true;_toggleButton($container,$container.find('[data-action="sci_send"]'),do_validation)})};var _collapseAction=function(){_$div.find(".showing_sci_action").removeClass("showing_sci_action")};var _collapseCopyLink=function(e){$(e.target).closest(".sci_invite_container").find(".sci_copy_link_mini_container").addClass("hidden")};var _collapseSendEmail=function(e){$(e.target).closest(".sci_invite_container").find(".sci_send_email_mini_container").addClass("hidden")};var _concatWithDividers=function(to_join,joined){var channels=[];if(to_join.length>0){channels.push({is_divider:true,name:TS.i18n.t("Channels you can join","shared")});channels=channels.concat(to_join)}if(joined.length>0){channels.push({is_divider:true,name:TS.i18n.t("Channels you belong to","shared")});channels=channels.concat(joined)}return channels};var _createInvite=function(){var $container=_$div.find("#sci_channels_create");var $contents=$container.find(_getCreateViewValidationSelector());if(!TS.ui.validation.validate($contents,{quiet:true,fast:true})){TS.ui.validation.validate($contents);Ladda.stopAll();$container.find('[data-action="sci_channels_create"]').addClass("disabled");return}var args={};var is_private=!$container.find('[name="access"]').prop("checked");if(_isEnterprise()){switch($container.find('[name^="share_with"]:checked').val()){case"specific":args.target_domains=$container.find('[name="domains"]').val();break;case"external":args.target_domain=$container.find('[name="domain"]').val();break;case"all":args.all_teams=true;break}}else{args.target_domain=$container.find('[name="domain"]').val()}var channel_name=$container.find('[name="channel_name"]').val();if(channel_name)args.channel_name=channel_name;var purpose=$container.find('[name="purpose"]').val();if(purpose)args.purpose=purpose.trim();if(args.target_domain){_promiseToCallInviteShared(args,is_private).then(function(response){var invite_id=response.data.invite_id;_switchToSend(response.data);return _promiseToCallListSharedInvites(is_private).then(function(response){_setSharedInvitesIntoModel(response.data.invites,is_private);_rebuildSharedInvite(invite_id)})}).catch(_handleError).finally(Ladda.stopAll)}else{_promiseToCallCreateShared(args,is_private).then(function(created_channel){var new_channel_id;if(created_channel.data.group){TS.groups.upsertGroup(created_channel.data.group);new_channel_id=created_channel.data.group.id}else{TS.channels.upsertChannel(created_channel.data.channel);new_channel_id=created_channel.data.channel.id}return _promiseToCallListShared(is_private).then(function(response){_setSharedChannelsIntoModel(response.data.channels,is_private);var new_channel_ob=TS.shared.getModelObById(new_channel_id);if(new_channel_ob.is_group){TS.groups.displayGroup(new_channel_id)}else{TS.channels.displayChannel(new_channel_id)}TS.ui.fs_modal.close();return null})}).catch(_handleError).finally(Ladda.stopAll)}};var _filterList=function(){var query=$.trim(_$filter.val());if(query!==""){if(query.indexOf("#")!==-1){query=query.replace("#","","g");query=$.trim(query)}}if(query){_$filter.closest(".channel_browser_filter_container").addClass("active");_filtered_channels=_getListItems(query)}else{_$filter.closest(".channel_browser_filter_container").removeClass("active");_filtered_channels=_getListItems()}if(_filtered_channels.length===0){_updateNoChannelsMessage(query);_hideAllSectionsBut("#sci_no_shared_channels")}else{_hideAllSectionsBut("#sci_channels_container")}_$list.longListView("scrollToTop",true);_$list.longListView("setItems",_filtered_channels);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list);_$list.longListView("resizeImmediately")});if(query){TS.kb_nav.highlightFirstItem()}else{TS.kb_nav.clearHighlightedItem()}};var _findSharedInviteByTeamDomainAndChannelName=function(team_domain,channel_name){return _.find(_getSharedInvitesFromModel(),function(invite){return invite.team.domain===team_domain&&invite.channel_name===channel_name})||_.find(_getSharedInvitesFromModel(true),function(invite){return invite.team.domain===team_domain&&invite.channel_name===channel_name})};var _getCreateViewValidationSelector=function(){var selectors=['[name="channel_name"]','[name="purpose"]'];if(_isEnterprise()){switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":selectors.push('[name="team_list"]');break;case"external":selectors.push('[name="domain"]');break}}else{selectors.push('[name="domain"]')}return selectors.join(", ")};var _getEnterpriseTeamsFromModelLessOwn=function(){return _isEnterprise()?_.filter(TS.model.enterprise_teams,function(team){return team.id!==TS.model.team.id}):[]};var _getListItems=function(query){var shared_channels=_getSharedChannelsFromModel();var private_shared_channels=_getSharedChannelsFromModel(true);var no_shared_channels=!(shared_channels.length||private_shared_channels.length);if(no_shared_channels)return;var merged=_mergePublicChannelsWithPrivateChannels(shared_channels,private_shared_channels);var to_join=[];var joined=[];var duplicates={};var exact_match;var match_regex;if(query){query=TS.utility.regexpEscape(query);match_regex=new RegExp(query,"i")}merged.forEach(function(channel,index){var is_already_listed=duplicates.hasOwnProperty(channel.id);if(is_already_listed)return;if(!channel.hasOwnProperty("name"))return;if(!is_already_listed)duplicates[channel.id]=true;if(query){if(channel.name.toLowerCase()===query.toLowerCase()){exact_match=channel;return}if(!channel.name.match(match_regex))return}if(channel.is_member){joined.push(channel)}else{to_join.push(channel)}});if(exact_match){if(exact_match.is_member){joined.unshift(exact_match)}else{to_join.unshift(exact_match)}}return _concatWithDividers(to_join,joined)};var _getSharedChannelsFromModel=function(is_private){return is_private?_private_shared_channels:_shared_channels};var _getSharedInviteFromModelById=function(id,is_private){return _.find(_getSharedInvitesFromModel(is_private),function(invite){return invite.invite_id==id})};var _getSharedInvitesFromModel=function(is_private){return is_private?_private_shared_invites:_shared_invites};var _getToggleInputLabel=function(){var label=TS.i18n.t("Anyone on your team can join","shared");if(_isEnterprise()){var name=TS.utility.htmlEntities(TS.model.enterprise.name);switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":label=TS.i18n.t("Specific teams at {name} can join","shared")({name:name});break;case"all":label=TS.i18n.t("Anyone at {name} can join","shared")({name:name});break}}return label};var _getToggleInputOffLabel=function(){var label=TS.i18n.t("Restricted to invited members","shared");if(_isEnterprise()){var name=TS.utility.htmlEntities(TS.model.enterprise.name);switch(_$div.find('[name^="share_with"]:checked').val()){case"specific":label=TS.i18n.t("Restricted to invited members on specific {name} teams","shared")({name:name});break;case"all":label=TS.i18n.t("Restricted to invited members at {name}","shared")({name:name});break}}return label};var _handleError=function(error){var body;switch(error.data.error){case"invalid_target_domain":body=TS.i18n.t("Darn&mdash;we couldnt find a team with that domain. Try again?","shared");break;case"name_taken":body=TS.i18n.t("Darn&mdash;that channel name is already taken. Try another?","shared");break;case"invite_exists":body=TS.i18n.t("An invitation already exists for that team and channel.","shared");break;case"shared_channel_exists":body=TS.i18n.t("Good news! That team has already joined the shared channel.","shared");break;case"not_paid":body=TS.i18n.t("Darn&mdash;that team has to upgrade to a paid Slack plan to join a shared channel.","shared");break;default:return _handleUnexpectedError(error)}return TS.generic_dialog.alert(body)};var _handleUnexpectedError=function(error){var message=error.message||"";if(error.data&&error.data.error)message+=": "+error.data.error;TS.error(message);var alert_str=TS.i18n.t("Sorry! Something went wrong. Please try again.","shared");return TS.generic_dialog.alert(alert_str)};var _hideAllSectionsBut=function(id){var sections=["#sci_loading","#sci_no_shared_channels","#sci_channels_container","#sci_channels_create","#sci_send","#sci_invites_container"].filter(function(section_id){return section_id!==id}).join(", ");_$div.find(sections).addClass("hidden");_$div.find(id).removeClass("hidden")};var _hideList=function(){_list_visible=false;if(_list_built){_$list.longListView("setHidden",true)}};var _isEnterprise=function(){return TS.boot_data.page_needs_enterprise};var _isPrivateInviteById=function(id){return!!_getSharedInviteFromModelById(id,true)};var _makeEnterpriseTeamsPicker=function(){var $container=_$div.find("#sci_channels_create");$container.find('[name="domains"]').each(function(index,el){var $el=$(el);TS.ui.team_picker.make($el,{teams:_getEnterpriseTeamsFromModelLessOwn(),classes:"normal_style team_picker"});$el.on("change",function(){var value=TS.ui.team_picker.value($el).map(function(item){return item.team.domain}).join(",");$el.val(value);var do_validation=true;_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_channels_create"]'),do_validation)})})};var _maybeCopyLink=function(e){var $el=$(e.target);var $container=$el.parent();var $input=$container.find("input");var $feedback=$container.find("label > span");var input=$input.get(0);var link=$input.val();if(TS.clipboard.canWriteText()){TS.clipboard.writeText(link)}else{_showEphemeralCopyLinkFeedback($feedback)}if(input)input.setSelectionRange(0,link.length)};var _maybeRebuildManageView=function(){if(!_getSharedInvitesFromModel().length&&!_getSharedChannelsFromModel().length&&!_getSharedInvitesFromModel(true).length&&!_getSharedChannelsFromModel(true).length)_switchToManage()};var _mergePublicChannelsWithPrivateChannels=function(public_channels,private_channels){return public_channels.concat(private_channels)};var _numMembers=function(channel){return("num_members"in channel?channel.num_members:channel.active_members?channel.active_members.length:0)||0};var _onCancel=function(){_updateBackButton(true);_$div=null;_$body.off("keyup.sci");_$body=null;TS.kb_nav.end();_list_visible=false;_list_built=false;_setSharedChannelsIntoModel([]);_setSharedChannelsIntoModel([],true)};var _onKeyUp=function(e){if(e.which!==TS.utility.keymap.enter)return;var $el=$(e.target);if($el.is("input[data-invite-id]"))return void _sendInviteEmail(e);if($el.is('input[name="domain"], input[name="channel_name"]')){TS.ui.startButtonSpinner($('#sci_channels_create [data-action="sci_channels_create"]').get(0));_createInvite(e);return}};var _onShow=function(){_$div=$("#sci_container");_$body=$("body");_$list_container=_$div.find(".list_container");_$list=_$list_container.find(".list");_$filter=_$div.find("#channel_browser_filter");_$sort_by=_$div.find("#channel_browser_sort");if(TS.model.ui_state&&TS.model.ui_state.sort_shared_channel_browser_by)_$sort_by.find('option[value="'+TS.model.ui_state.sort_shared_channel_browser_by+'"]').attr("selected",true);_promiseToGetData().then(_switchToManage).catch(_handleError)};var _openChannel=function($row,e){if($row.hasClass("channel_link")){var channel_id=$row.data("channel-id");TS.view.onChannelReferenceClick(e,channel_id)}else{var group_id=$row.data("group-id");TS.view.onGroupReferenceClick(e,group_id)}TS.ui.fs_modal.close()};var _promiseToCallCreateShared=function(args,is_private){return TS.api.call(is_private?"enterprise.groups.createShared":"enterprise.channels.createShared",args)};var _promiseToCallInviteShared=function(args,is_private){return TS.api.call(is_private?"groups.inviteShared":"channels.inviteShared",args)};var _promiseToCallListShared=function(is_private){return TS.api.call(is_private?"groups.listShared":"channels.listShared")};var _promiseToCallListSharedInvites=function(is_private){return TS.api.call(is_private?"groups.listSharedInvites":"channels.listSharedInvites")};var _promiseToCallRevokeSharedInvite=function(args,is_private){return TS.api.call(is_private?"groups.revokeSharedInvite":"channels.revokeSharedInvite",args)};var _promiseToCallSendSharedInvite=function(args,is_private){return TS.api.call(is_private?"groups.sendSharedInvite":"channels.sendSharedInvite",args)};var _promiseToGetData=function(){var promises=[_promiseToCallListShared().reflect(),_promiseToCallListShared(true).reflect()];if(TS.boot_data.feature_external_shared_channels_ui){promises.push(_promiseToCallListSharedInvites().reflect());promises.push(_promiseToCallListSharedInvites(true).reflect())}return Promise.all(promises).then(function(responses){var rejection_reasons=[];responses.forEach(function(response){if(response.isFulfilled())return;rejection_reasons.push(response.reason())});if(rejection_reasons.length){return Promise.reject(new Error("Some shared channels start APIs failed:\n"+rejection_reasons.join("\n")))}else{_setSharedChannelsIntoModel(responses[0].value().data.channels);_setSharedChannelsIntoModel(responses[1].value().data.channels,true);if(TS.boot_data.feature_external_shared_channels_ui){_setSharedInvitesIntoModel(responses[2].value().data.invites);_setSharedInvitesIntoModel(responses[3].value().data.invites,true)}}})};var _rebuildEmailedInvitations=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;_$div.find("#sci_invite_container_"+id+' [data-action="replace_emailed_invites"]').replaceWith(TS.templates.shared_channels_invites_emailed_invitations(invite))};var _rebuildSharedInvite=function(id){if(!id)return;var invite=_getSharedInviteFromModelById(id,_isPrivateInviteById(id));if(!invite)return;var $el=_$div.find("#sci_invite_container_"+id);if($el.length){$el.replaceWith(TS.templates.shared_channels_invites_invite(invite))}else{_$div.find("#sci_invites_container .sci_list_header").after(TS.templates.shared_channels_invites_invite(invite))}_$div.find("#sci_invites_container").removeClass("hidden")};var _removeSharedInvite=function(id){if(!id)return;_$div.find("#sci_invite_container_"+id).remove();var $el=_$div.find("#sci_invites_container");if($el.children().length===1)$el.addClass("hidden")};var _removeSharedInviteFromModelById=function(id,is_private){_.remove(_getSharedInvitesFromModel(is_private),function(invite){return invite.invite_id==id})};var _revokeSharedInvite=function(e){var $el=$(e.target);var invite_id=$el.data("invite-id");var is_private=_isPrivateInviteById(invite_id);_promiseToCallRevokeSharedInvite({invite_id:invite_id},is_private).then(function(response){_removeSharedInviteFromModelById(invite_id,is_private);_removeSharedInvite(invite_id);_maybeRebuildManageView()}).catch(_handleError)};var _sendInviteEmail=function(e){var $el=$(e.target);var $container=$el.parent();if(!TS.ui.validation.validate($container,{quiet:true,fast:true})){TS.ui.validation.validate($container);$container.find('[data-action="sci_send"]').addClass("disabled");return}var invite_id=$el.data("invite-id");var $input=$container.find("input");var email=$input.val();if(!email)return;var is_private=_isPrivateInviteById(invite_id);var args={invite_id:invite_id,email:email};_promiseToCallSendSharedInvite(args,is_private).then(function(){$input.val("");return _promiseToCallListSharedInvites(is_private).then(function(response){_setSharedInvitesIntoModel(response.data.invites,is_private);_rebuildEmailedInvitations(invite_id);_addSentEmailsFeedback(invite_id)})}).catch(_handleError)};var _setSharedChannelsIntoModel=function(shared_channels,is_private){if(shared_channels.length){shared_channels=shared_channels.map(function(shared_channel){var model_ob=TS.shared.getModelObById(shared_channel.channel);return $.extend({},shared_channel,model_ob)})}if(is_private){_private_shared_channels=shared_channels}else{_shared_channels=shared_channels}};var _setSharedInvitesIntoModel=function(shared_invites,is_private){if(is_private){_private_shared_invites=shared_invites}else{_shared_invites=shared_invites}};var _setupTeamNameOverlayEffect=function(){var overlay=_$div.find("#sci_channels_create .placeholder_overlay");_$div.find('#sci_channels_create input[name="domain"]').on("input",function(e){overlay.toggleClass("hidden",!!$(e.target).val())})};var _setupToggleInput=function(){_$div.find('#sci_channels_create [name="access"]').togglify({on_text:TS.i18n.t("Public","shared"),off_text:TS.i18n.t("Private","shared"),label:_getToggleInputLabel(),off_label:_getToggleInputOffLabel(),off_class:"ts_toggle_orange",initial_state:true})};var _showAction=function(e){_collapseAction();var $el=$(e.currentTarget).addClass("showing_sci_action");if($el.is(".sci_send_email_container"))$el.find("input").focus()};var _showEphemeralCopyLinkFeedback=function($el){var timeout=$el.data("timeout");clearTimeout(timeout);$el.removeClass("hidden").data("timeout",setTimeout(function(){$el.addClass("hidden")},3e3))};var _showList=function(){if(_list_visible)return;if(!_list_built){_startListView();_list_visible=true;return}if(_list_built){_list_visible=true;_$list.longListView("setHidden",false);_$list.longListView("setItems",_getListItems(),true);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list)})}};var _sortChannels=function(sort_by){var sorts=["name","creator","created","members_high","members_low"];var sort="name";if(sorts.indexOf(sort_by)!==-1)sort=sort_by;_sortChannelsBy(_getSharedChannelsFromModel(),sort);_sortChannelsBy(_getSharedChannelsFromModel(true),sort)};var _sortChannelsBy=function(channels,sort){if(sort==="name"){channels.sort(function(a,b){return a._name_lc>b._name_lc?1:b._name_lc>a._name_lc?-1:0})}else if(sort==="creator"){channels.sort(function(a,b){var a_creator,b_creator;a_creator=TS.members.getMemberById(a.creator);b_creator=TS.members.getMemberById(b.creator);if(a_creator&&b_creator){return a_creator._name_lc>b_creator._name_lc?1:b_creator._name_lc>a_creator._name_lc?-1:0}else if(a_creator&&!b_creator){return-1}else if(!a_creator&&b_creator){return 1}else{return 0}})}else if(sort==="created"){channels.sort(function(a,b){return a.created<b.created?1:b.created<a.created?-1:0})}else if(sort==="members_high"){channels.sort(function(a,b){var num_a=_numMembers(a);var num_b=_numMembers(b);return num_a<num_b?1:num_b<num_a?-1:0})}else if(sort==="members_low"){channels.sort(function(a,b){var num_a=_numMembers(a);var num_b=_numMembers(b);return num_a>num_b?1:num_b>num_a?-1:0})}};var _start=function(){var show_create_shared_channel_btn=TS.members.canUserCreateConvertSharedChannels();var settings={body_template_html:TS.templates.shared_channels_invites_modal({show_create_shared_channel_btn:show_create_shared_channel_btn}),onShow:_onShow,onCancel:_onCancel,modal_class:"fs_modal_internal_scroll convert_to_shared_dialog"};TS.ui.fs_modal.start(settings)};var _startListView=function(){_list_built=true;var list_items=_getListItems();var long_list_view_args={items:list_items,approx_item_height:60,preserve_dom_order:true,approx_divider_height:35,pin_dividers:true,makeElement:function(data){var $el=$(TS.templates.channel_browser_row({is_shared:true}));data.$icon=$el.find(".channel_browser_type_icon");data.$name=$el.find(".channel_browser_channel_name");data.$creator=$el.find(".channel_browser_created_by");data.$date=$el.find(".channel_browser_created_on");data.$purpose=$el.find(".channel_browser_channel_purpose");data.$member_count_container=$el.find(".channel_browser_member_count_container");data.$member_count=$el.find(".channel_browser_member_count");data.$open=$el.find(".channel_browser_open");data.$preview=$el.find(".channel_browser_preview");data.$joined=$el.find(".channel_browser_joined");data.$shared_channel_icon=$el.find(".shared_channel_icon");data.$teams=$el.find(".teams");return $el},makeDivider:function(data){return $("<div>").addClass("channel_browser_divider")},renderItem:function($el,item,data){if(TS.boot_data.page_needs_enterprise&&item.is_shared){data.$shared_channel_icon.removeClass("hidden")}else{data.$shared_channel_icon.addClass("hidden")}if(item.is_channel){data.$icon.removeClass("ts_icon_lock").addClass("ts_icon_channel_pane_hash")}else{data.$icon.removeClass("ts_icon_channel_pane_hash").addClass("ts_icon_lock")}data.$name.text(item.name?item.name:"");var creator=TS.members.getMemberById(item.creator);if(creator){data.$creator.removeClass("hidden");data.$creator.find(".channel_browser_creator_name").text(TS.members.getMemberDisplayName(creator))}else{data.$creator.addClass("hidden")}data.$date.text(TS.utility.date.toCalendarDate(item.created));var member_count=_numMembers(item);data.$member_count.text(member_count);if(item.purpose&&item.purpose.value){var purpose_html=TS.utility.formatTopicOrPurpose(item.purpose.value);purpose_html=purpose_html.replace(/<a .*?>(.*?)<\/a>/g,"$1");data.$purpose.removeClass("hidden").html(purpose_html)}else{data.$purpose.text("").addClass("hidden")}var is_member=item.is_member||item.is_group;if(is_member){data.$open.removeClass("hidden");data.$preview.addClass("hidden");data.$joined.removeClass("hidden")}else{data.$open.addClass("hidden");data.$preview.removeClass("hidden");data.$joined.addClass("hidden")}if(item.is_group){$el.removeClass("channel_link").removeAttr("data-channel-id");$el.addClass("group_link").attr("data-group-id",item.id)}else{$el.removeClass("group_link").removeAttr("data-group-id");$el.addClass("channel_link").attr("data-channel-id",item.id)}if(item.shares){var team_icons_html="";var additional_teams=0;var shared_teams=[];item.shares.forEach(function(team,index){if(index>9){additional_teams++;return}shared_teams.push(team)});team_icons_html+=TS.templates.shared_channel_list_team_icon({teams:shared_teams,show_additional_teams:additional_teams>0,additional_teams:additional_teams});data.$teams.html(team_icons_html)}else{data.$teams.empty()}},renderDivider:function($el,item,data){$el.text(item.name)},calcItemHeight:function($el,item,data){return $el.outerHeight()}};_$list.longListView(long_list_view_args);_bindUI();TS.utility.rAF(function(){_$list.monkeyScroll()})};var _switchToCreate=function(){_managing=false;var is_enterprise=_isEnterprise();var template_args={reserved_domain:TS.model.team.domain};if(is_enterprise)template_args.enterprise_info=TS.model.enterprise;var html=TS.templates.shared_channels_invites_create(template_args);var $create=_$div.find("#sci_channels_create");$create.html(html).find("textarea").autogrow();_hideAllSectionsBut("#sci_channels_create");_hideList();$("#fs_modal.convert_to_shared_dialog").toggleClass("fs_modal_internal_scroll",false);_$div.find("#sci_header_wrapper").addClass("hidden");_setupTeamNameOverlayEffect();_setupToggleInput();if(is_enterprise)_makeEnterpriseTeamsPicker();_$div.find('#sci_channels_create [name="domain"]').focus();Ladda.bind('#sci_channels_create [data-action="sci_channels_create"]');_updateBackButton()};var _switchToManage=function(){_managing=true;_$div.find("#sci_header_wrapper").removeClass("hidden");var shared_channels=_getSharedChannelsFromModel();var private_shared_channels=_getSharedChannelsFromModel(true);var no_shared_channels=!(shared_channels.length||private_shared_channels.length);if(no_shared_channels){_updateNoChannelsMessage();_hideAllSectionsBut("#sci_no_shared_channels");_hideList();_bindUI();return null}else{_hideAllSectionsBut("#sci_channels_container")}$("#fs_modal.convert_to_shared_dialog").toggleClass("fs_modal_internal_scroll",true);if(TS.model.ui_state&&TS.model.ui_state.sort_shared_channel_browser_by){_sortChannels(TS.model.ui_state.sort_shared_channel_browser_by)}else{_sortChannels(_$sort_by.val())}_showList();_updateBackButton(true)};var _switchToSend=function(args){_managing=false;var html=TS.templates.shared_channels_invites_send(args);_$div.find("#sci_send").html(html);_hideAllSectionsBut("#sci_send");_hideList();_updateBackButton()};var _toggleButton=function($container,$btn,do_validation,is_disabled){if(do_validation)is_disabled=!TS.ui.validation.validate($container,{quiet:true,fast:true});$btn.toggleClass("disabled",is_disabled)};var _toggleContents=function(e){if($(e.target).is("a, input, .btn"))return;var $el=$(e.currentTarget);var is_showing=$el.hasClass("showing_contents");$el.toggleClass("showing_contents",!is_showing);$el.find(".sci_toggle_icon").toggleClass("ts_icon_caret_right",is_showing).toggleClass("ts_icon_caret_down",!is_showing)};var _toggleCopyLink=function(e){var $el=$(e.target).closest(".sci_invite_container").find(".sci_copy_link_mini_container");$el.toggleClass("hidden",!$el.hasClass("hidden"));_collapseSendEmail(e)};var _toggleSendEmail=function(e){var $el=$(e.target).closest(".sci_invite_container").find(".sci_send_email_mini_container");$el.toggleClass("hidden",!$el.hasClass("hidden")).find("input").focus();_collapseCopyLink(e)};var _toggleShareWith=function(e){var $el=$(e.target);var $container=_$div.find("#sci_channels_create");var checked=$el.val();var show_specific=checked==="specific";var show_external=checked==="external";$("#sci_specific_team").toggleClass("hidden",!show_specific);$("#sci_external_team").toggleClass("hidden",!show_external);$container.find('[for="share_with_specific"]').toggleClass("hidden",!show_specific);$container.find('[for="share_with_external"]').toggleClass("hidden",!show_external);if(checked==="specific")$container.find('[name="team_list"]').focus();if(checked==="external")$container.find('[name="domain"]').focus();var do_validation=true;_toggleButton($container.find(_getCreateViewValidationSelector()),$container.find('[data-action="sci_channels_create"]'),do_validation);_updateToggleInputLabels()};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(_switchToManage);TS.ui.fs_modal.showBackButton()}};var _updateNoChannelsMessage=function(query){var _$empty_state=_$div.find("#sci_no_shared_channels");var _$msg=_$empty_state.find(".sci_no_shared_note");var default_message=TS.i18n.t("You dont have any shared channels yet.","shared");if(query){var no_match_warning=TS.i18n.t("No matches found for <strong> {escaped_query_string} </strong>","shared")({escaped_query_string:TS.utility.truncateAndEscape(query,50)});_$msg.html(no_match_warning)}else{_$msg.text(default_message)}};var _updateToggleInputLabels=function(){_$div.find(".ts_toggle_on_label").text(_getToggleInputLabel());_$div.find(".ts_toggle_off_label").text(_getToggleInputOffLabel())};var _validateValidInvite=function($el,options){if(!_$div)return true;if(!$el.is("input"))return true;var $container=$("#sci_channels_create");var $domain_el=$el.is('[name="domain"]')?$el:$container.find("[name=domain]");var $channel_el=$el.is("[name=channel_name]")?$el:$container.find("[name=channel_name]");var domain=$domain_el.val();var channel=$channel_el.val();if(!domain)return true;domain=domain.trim();channel=channel.trim();if(_findSharedInviteByTeamDomainAndChannelName(domain,channel)){
if(!options.quiet)$el.addClass("invalid_invite");var warning=TS.i18n.t("This invite already exists. Try a different team or channel!","shared");return void TS.ui.validation.showWarning($el,warning,options)}if($domain_el===$el){if(channel&&!options.quiet&&$channel_el.hasClass("invalid_invite")){$channel_el.removeClass("invalid_invite");TS.ui.validation.validate($channel_el)}}else{if(domain&&!options.quiet&&$domain_el.hasClass("invalid_invite")){$domain_el.removeClass("invalid_invite");TS.ui.validation.validate($domain_el)}}if(!options.quiet)$el.removeClass("invalid_invite");return true}})();(function(){"use strict";TS.registerModule("ui.team_picker",{onStart:function(){},make:function($el,options){options=options||{};var prev_query;var start_regex;var suffix_regex;if(!options.append)$el.addClass("hidden");var filter_select_options={append:!!options.append,data:_makeTeamsWithPreselectsForTemplate(options.teams||[],options.preselected_ids||[]),approx_item_height:38,per_page:50,placeholder_text:"Add teams",classes:options.classes||"normal_style",restrict_preselected_item_removal:options.restrict_preselected_item_removal||false,single:!!options.single,template:function(item){var html=TS.templates.invite_team_small({team:item.team});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.invite_team_token({team:item.team});return new Handlebars.SafeString(html)},filter:function(item,query){var team=item.team;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}return _checkTeamMatch(team,start_regex)||_checkTeamMatch(team,suffix_regex)},noResultsTemplate:function(query){if(!query){return"No teams found"}else{return"No teams found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}}};$el.lazyFilterSelect(filter_select_options)},value:function($el){return $el.lazyFilterSelect("value")}});var _makeTeamsWithPreselectsForTemplate=function(teams,preselected_ids){return teams&&teams.map(function(team){return{team:team,preselected:preselected_ids.indexOf(team.id)!==-1}})};var _checkTeamMatch=function(team,regex){return team.name&&team.name.match(regex)}})();(function(){"use strict";TS.registerModule("user_groups",{updated_sig:new signals.Signal,is_in_bulk_upsert_mode:false,onStart:function(){if(TS.client){TS.client.login_sig.add(TS.user_groups.onLogin)}else if(TS.web){TS.web.login_sig.add(TS.user_groups.onLogin)}TS.user_groups.sortUserGroupsAndDispatchThrottled=_.debounce(TS.user_groups.sortUserGroupsAndDispatchThrottled,500)},onLogin:function(){_login_sig_fired=true;TS.user_groups.sortUserGroups()},getUserGroupsByHandle:function(handle){if(!handle||handle==="@")return;handle=_.toLower(handle);var user_groups=TS.model.user_groups;if(!user_groups)return;var user_group=_handle_map[handle];if(user_group)return user_group;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.handle==handle||"@"+user_group.handle==handle){TS.warn(handle+" not in _handle_map?");_handle_map["@"+handle]=user_group;_handle_map[handle]=user_group;return user_group}}return null},getUserGroupsById:function(id){if(TS.model.user&&TS.model.user.is_restricted)return false;var user_groups=TS.model.user_groups;var user_group=_id_map[id];if(user_group)return user_group;if(!user_groups)return;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=user_group;return user_group}}return null},getActiveUserGroups:function(include_idp_usergroups){var user_groups=_.filter(TS.model.user_groups,function(ug){if(include_idp_usergroups)return!ug.date_delete;return!ug.date_delete&&ug.team_id});return user_groups},getUserGroupMembers:function(id,handler){TS.api.call("subteams.users.list",{subteam:id,include_disabled:1},function(ok,data){if(ok&&data){var user_group=TS.user_groups.getUserGroupsById(id);if(user_group){user_group.users=data.users;user_group.user_count=data.users.length;TS.user_groups.upsertUserGroupAndSignal(user_group);user_group=TS.user_groups.getUserGroupsById(id);if(handler){handler(user_group)}}}})},updateMembersOfUserGroup:function(data,handler){TS.api.call("subteams.users.update",data,handler)},createUserGroup:function(data,handler){TS.api.call("subteams.create",data,handler)},updateUserGroup:function(data,handler){TS.api.call("subteams.update",data,handler)},enableUserGroup:function(user_group_id,handler){TS.api.call("subteams.enable",{subteam:user_group_id},handler)},disableUserGroup:function(user_group_id,handler){TS.api.call("subteams.disable",{subteam:user_group_id},handler)},deleteUserGroup:function(user_group_id,handler){TS.api.call("subteams.delete",{subteam:user_group_id,include_disabled:1},handler)},getMembersInCorG:function(user_group_id,id,callback){var ug=TS.user_groups.getUserGroupsById(user_group_id);var channel=TS.channels.getChannelById(id)||TS.groups.getGroupById(id);var result=[];var filter_members=function(){var group=TS.user_groups.getUserGroupsById(user_group_id);var members=group.users.filter(function(member_id){return channel.members.indexOf(member_id)!==-1});return members};var do_work=function(){result=filter_members();return callback(result)};if(!ug||!channel){return callback(result,true)}if(ug.users===undefined){if(!_pending_group_requests[user_group_id]){_pending_group_requests[user_group_id]=true;TS.user_groups.getUserGroupMembers(user_group_id,function(updated_group){if(updated_group&&updated_group.users){_pending_group_requests[user_group_id]=false;ug=updated_group;return do_work()}})}else{return callback(result,true)}}else{return do_work()}},upsertUserGroup:function(user_group){if(TS.model.user&&TS.model.user.is_restricted)return false;var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);user_group._name_lc=user_group.name.toLowerCase();if(existing_user_group){if(TS.pri)TS.log(4,'updating existing User Group "'+user_group.id+'"');var user_user_group=TS.model.your_user_group_regex[user_group.id];if(user_user_group)TS.user_groups.removeSelfUserGroup(existing_user_group.id);for(var k in user_group){if(existing_user_group[k]!=user_group[k]){existing_user_group[k]=user_group[k]}}if(!user_group.date_delete&&user_group.users&&user_group.users.indexOf(TS.model.user.id)!==-1){if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}TS.user_groups.upsertSelfUserGroup(existing_user_group.id);_assignMapsForGroup(user_group)}}else if(!user_group.date_delete){TS.log(4,'Adding user group "'+user_group.id+'"');if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}_assignMapsForGroup(user_group)}if(!TS.user_groups.is_in_bulk_upsert_mode)TS.user_groups.sortUserGroupsAndDispatchThrottled()},sortUserGroupsAndDispatch:function(){TS.user_groups.sortUserGroups();TS.user_groups.updated_sig.dispatch()},sortUserGroupsAndDispatchThrottled:function(){return TS.user_groups.sortUserGroupsAndDispatch()},startBatchUpsert:function(){if(TS.user_groups.is_in_bulk_upsert_mode)return false;TS.user_groups.is_in_bulk_upsert_mode=true;return true},finishBatchUpsert:function(){if(!TS.user_groups.is_in_bulk_upsert_mode)return false;TS.user_groups.is_in_bulk_upsert_mode=false;TS.user_groups.sortUserGroupsAndDispatch();return true},sortUserGroups:function(){if(!_login_sig_fired)return;TS.model.user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)})},upsertUserGroupAndSignal:function(user_group){TS.user_groups.upsertUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},removeUserGroup:function(user_group){var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);if(existing_user_group){TS.user_groups.removeSelfUserGroup(existing_user_group.id);_deleteMapsForGroup(existing_user_group);existing_user_group.date_delete=-1}},removeUserGroupAndSignal:function(user_group){TS.user_groups.removeUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},upsertSelfUserGroup:function(user_group_id){var existing_user_group_regex=TS.model.your_user_group_regex[user_group_id];if(existing_user_group_regex)TS.user_groups.removeSelfUserGroup(user_group_id);var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug&&!ug.date_delete){var user_group_regex=new RegExp("<!subteam\\^("+ug.id+(ug.handle?"|"+ug.handle:"")+")\\b");TS.model.your_user_group_regex[ug.id]=user_group_regex;if(ug.handle){TS.model.highlight_words.push("@"+ug.handle);TS.model.highlight_words_regex=null}}},removeSelfUserGroup:function(user_group_id){TS.model.your_user_group_regex[user_group_id]=null;delete TS.model.your_user_group_regex[user_group_id];var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug){if(ug.handle)_.pull(TS.model.highlight_words,"@"+ug.handle);_deleteMapsForGroup(ug);TS.model.highlight_words_regex=null;TS.user_groups.updated_sig.dispatch(ug.id)}},ensureUserGroupsArePresent:function(user_group_ids){var unknown_ids=[];user_group_ids.forEach(function(id){if(!TS.user_groups.getUserGroupsById(id))unknown_ids.push(id)});if(!unknown_ids.length)return Promise.resolve();return _promiseToGetUserGroups(unknown_ids)},test:function(){return{clearUseGroupMaps:_clearUseGroupMaps}}});var _handle_map={};var _id_map={};var _promiseToGetUserGroups=function(user_group_ids){var clauses=[];user_group_ids.forEach(function(id){clauses.push({type:"and",clauses:[{type:"is",value:"group"},{type:"id",value:id}]})});var api_options={count:user_group_ids.length,include_usergroups:true,query:{type:"or",clauses:clauses}};api_options.query=JSON.stringify(api_options.query);return TS.api.callImmediately("search.enterprise",api_options).then(function(response){if(response.data.items&&response.data.items.length){TS.user_groups.startBatchUpsert();response.data.items.forEach(function(ug){TS.user_groups.upsertUserGroup(ug)});TS.user_groups.finishBatchUpsert()}return null})};var _clearUseGroupMaps=function(){_handle_map={};_id_map={}};var _assignMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){_handle_map[user_group.handle]=user_group;_handle_map["@"+user_group.handle]=user_group}_id_map[user_group.id]=user_group};var _deleteMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){delete _handle_map[user_group.handle];delete _handle_map["@"+user_group.handle]}delete _id_map[user_group.id]};var _pending_group_requests={};var _login_sig_fired})();(function(){"use strict";TS.registerModule("ui.admin_user_groups",{user_groups_fetched:new signals.Signal,onStart:function(){$("body").on("click",'[data-action="admin_user_groups_modal"]',function(){_start()});$("body").on("click",'[data-action="admin_user_groups_modal_new"]',function(){TS.ui.admin_user_groups.add()})},start:function(){_start()},add:function(){_start();_close_when_done=true;_switchSettingsFormView()},editInfo:function(user_group){_start();_close_when_done=true;_switchSettingsFormView(user_group)},editMembers:function(user_group){_start();_close_when_done=true;_switchMembersFormView(user_group,false)},disable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"disable_user_group")},enable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"enable_user_group")},remove:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"delete_user_group")},test:function(){var test_ob={_isFullLocalMember:_isFullLocalMember};Object.defineProperty(test_ob,"_isFullLocalMember",{get:function(){return _isFullLocalMember},set:function(v){_isFullLocalMember=v}});return test_ob}});var _$div;var _$all_user_groups;var _$user_groups_form_div;var _$user_groups_toggle_div;var _refresh_list=true;var _user_groups=[];var _temp_user_group;var _close_when_done=false;var _start=function(){var body_template_html=TS.templates.user_group_modal({show_info_pane:!TS.model.prefs.hide_user_group_info_pane,show_user_groups_add:TS.members.canUserCreateAndDeleteUserGroups()});var settings={body_template_html:body_template_html,onShow:_onShow,onCancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#user_groups_container");_$all_user_groups=$("#all_user_groups");_$user_groups_form_div=$("#user_groups_form_div");_$user_groups_toggle_div=$("#user_groups_toggle_div");_switchListView();_$div.find('[data-action="open_form"]').on("click",function(e){e.preventDefault();var id=$(this).closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)})};var _onCancel=function(){_refresh_list=true;if(_temp_user_group){TS.user_groups.deleteUserGroup(_temp_user_group.id)}_$div=null;_$all_user_groups=null;_$user_groups_form_div=null;_$user_groups_toggle_div=null;_close_when_done=false;_$monkey_scroll=null;_$icon_close=null;$(window).off("resize",_onResizeList)};var _onReset=function(e){if(e)e.preventDefault();if(!_close_when_done){_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _onUpdateComplete=function(){if(!_close_when_done){_refresh_list=true;_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _bindBackButton=function(){if(!_close_when_done){TS.ui.fs_modal.bindBackButton(_switchListView);TS.ui.fs_modal.showBackButton()}};var _findAutoUserGroup=function(auto_type){if(!_user_groups||!auto_type)return false;for(var i=0,j=_user_groups.length;i<j;i++){if(_user_groups[i].auto_type===auto_type){return _user_groups[i]}}return false};var _alertIfNotOk=function(ok,data){if(!ok){var group_name=$("#user_group_name_input").val()||"";var group_handle=$("#user_group_handle_input").val()||"";data.group_name=group_name;data.group_handle=group_handle;if(data.error&&(data.error==="forbidden_handle"||data.error==="forbidden_name")){var combined_input=group_name+group_handle;if(combined_input){var auto_owners=_findAutoUserGroup("owner");var auto_admins=_findAutoUserGroup("admin");var looks_like_admin_group=!!combined_input.match(/admins/i);var looks_like_owner_group=!!combined_input.match(/owners/i);data.suggest_auto_group=true;data.can_create_auto_owners=looks_like_owner_group&&TS.model.user.is_admin&&!auto_owners;data.can_enable_auto_owners=looks_like_owner_group&&auto_owners&&auto_owners.date_delete;data.can_create_auto_admins=looks_like_admin_group&&TS.model.user.is_admin&&!auto_admins;data.can_enable_auto_admins=looks_like_admin_group&&auto_admins&&auto_admins.date_delete}}$("#user_group_alerts").html(TS.templates.user_group_alerts(data));return true}return false};var _onResizeList=function(){var $groups_header=$("#user_groups_header");var $list=$("#user_groups_list_div");var groups_header_padding=parseInt($groups_header.css("padding-top"),10);var header_height=$groups_header[0].offsetHeight;var window_height=$(window).height();var min_list_height=250;var height=Math.max(min_list_height,window_height-header_height-groups_header_padding);$list.css("height",height)};var _switchListView=function(highlight_id){if(_refresh_list){var $user_group_list=$("#user_groups_list_div");$user_group_list.html(Handlebars.helpers.loadingHTML());TS.api.call("subteams.list",{include_disabled:1,include_users:1},function(ok,data){if(_alertIfNotOk(ok,data))return;_user_groups=data.subteams;for(var i=0,j=_user_groups.length;i<j;i++){_user_groups[i]._name_lc=_user_groups[i].name.toLowerCase()}_user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)});TS.ui.admin_user_groups.user_groups_fetched.dispatch(_user_groups);_refreshList();_bindListUI();if(highlight_id){$('#fs_modal [data-user-group-id="'+highlight_id+'"]').addClass("highlight_yellow");$("#fs_modal").animate({scrollTop:$(".highlight_yellow").offset().top},500)}});_refresh_list=false}_$all_user_groups.removeClass("hidden");_$user_groups_form_div.addClass("hidden");_$user_groups_toggle_div.addClass("hidden");TS.ui.fs_modal.hideBackButton()};var _bindListUI=function(){$(window).on("resize",_onResizeList);_onResizeList();$("#user_groups_list_div").monkeyScroll();_$monkey_scroll=$("#user_groups_list_div").data("monkeyScroll");$("#user_group_modal_search").on("keydown keyup change",_updateSearch);_$icon_close=$("#user_groups_header .user_groups_search .icon_close");_$icon_close.off("click").on("click",_clearSearch);_$all_user_groups.off("click");_$all_user_groups.on("click",'[data-action="open_form"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)});_$all_user_groups.on("click",'[data-action="edit_members"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchMembersFormView(user_group)});_$all_user_groups.on("click",'[data-action="hide_info_pane"]',function(e){e.preventDefault();TS.prefs.setPrefByAPI({hide_user_group_info_pane:true},function(ok,data){if(_alertIfNotOk(ok,data))return;_$div.find(".info_panel").addClass("hidden")})});_$all_user_groups.on("click",".user_group_toggle_btn",function(e){e.preventDefault();var $target=$(e.target).closest("button, a");var id=$target.closest(".user_group_item").data("user-group-id");var action=$target.data("action");var user_group=_getUserGroupFromId(id);_switchToggleView(user_group,action)});_$all_user_groups.on("click",".clear_members_filter",_clearSearch);var autoMethodHandler=function(ok,data){if(ok){_refresh_list=true;_close_when_done=false;_switchListView(data.subteam&&data.subteam.id?data.subteam.id:null)}};var auto_methods={owners:{create:function(){TS.api.call("subteams.createAuto",{type:"owner"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("owner");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}},admins:{create:function(){TS.api.call("subteams.createAuto",{type:"admin"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("admin");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}}};_$user_groups_form_div.off("click").on("click","a.user_group_auto_action",function(e){var $target=$(e.target);var type=$target.data("auto-type");var action=$target.data("auto-action");if(auto_methods[type]&&auto_methods[type][action]){auto_methods[type][action]();e.preventDefault();return false}})};var _switchToggleView=function(user_group,action){if(!user_group){TS.warn("Cannot switch toggle view to undefined User Group");return}_$user_groups_toggle_div.html(TS.templates.user_group_toggle({action:action,user_group:user_group,show_delete:TS.boot_data.feature_subteams_hard_delete&&!user_group.auto_type&&!user_group.is_external}));_$user_groups_toggle_div.find('[data-action="cancel"]').on("click",_onReset);_$user_groups_toggle_div.find(".user_group_toggle_btn").on("click",function(e){var action=$(this).data("action");TS.user_groups[action](user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;if(action==="enableUserGroup"){_enableUserGroup(user_group)}_onUpdateComplete()})});_$user_groups_toggle_div.find('[data-action="switch_delete_user_group"]').on("click",function(e){e.preventDefault();_switchToggleView(user_group,"delete_user_group")});_$all_user_groups.addClass("hidden");_$user_groups_toggle_div.removeClass("hidden");_bindBackButton()};var _enableUserGroup=function(user_group){var ug=TS.user_groups.getUserGroupsById(user_group.id);if(!ug)TS.user_groups.upsertUserGroup(_.cloneDeep(user_group))};var _switchSettingsFormView=function(user_group){_$user_groups_form_div.html(TS.templates.user_group_settings_form(user_group));var channels=TS.channels.getUnarchivedChannelsForUser().map(function(option){return{id:option.id,name:option.name}});var groups=TS.groups.getUnarchivedGroups().map(function(option){return{id:option.id,name:option.name,is_group:true}});var options=channels.concat(groups);if(user_group){var default_channels_groups=user_group.prefs.channels.concat(user_group.prefs.groups);default_channels_groups.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].id){options[i].selected=true;break}}})}var opts={data:options,template:function(item){if(item.is_group){return new Handlebars.SafeString(TS.utility.htmlEntities(item.name))}return new Handlebars.SafeString("#"+TS.utility.htmlEntities(item.name))},placeholder_text:"",filter:function(item,query){var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var prefix_regex=new RegExp("^"+TS.utility.regexpEscape(query.replace("#","")),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|#)"+TS.utility.regexpEscape(query),"i");return item.name.match(prefix_regex)||item.name.match(start_regex)||item.name.match(suffix_regex)}};$("#user_group_default_channels").lazyFilterSelect(opts);_bindSettingsFormUI(user_group);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");_bindBackButton()};var _bindSettingsFormUI=function(user_group){var save_function;var is_new;var user_group_id;if(user_group){save_function=TS.user_groups.updateUserGroup;is_new=false;user_group_id=user_group.id}else{save_function=TS.user_groups.createUserGroup;is_new=true}var $user_group_handle_input=$("#user_group_handle_input");$user_group_handle_input.on("input",function(){$(this).closest(".handle_input").toggleClass("empty",!this.value.length)});_$user_groups_form_div.find(".user_group_settings_form").on("submit",function(e){e.preventDefault();var name=$('input[name="name"]').val();var handle=$('input[name="handle"]').val();var description=$('input[name="description"]').val();var channels=$("#user_group_default_channels").lazyFilterSelect("value");channels=channels.map(function(channel){return channel.id});var args={name:name,handle:handle,description:description,channels:channels};if(user_group_id)args.subteam=user_group_id;save_function(args,function(ok,data){if(_alertIfNotOk(ok,data))return;if(is_new){_temp_user_group=data.subteam;_switchMembersFormView(data.subteam,is_new)}else{_onUpdateComplete()}})});_$user_groups_form_div.find(".user_group_settings_form").on("reset",_onReset);var $button=$("#save_user_group");var $input=$("#user_group_name_input");function inputChange(){var value=$input.val();if(value&&value.length){$button.removeAttr("disabled")}else{$button.attr("disabled",true)}}if($button.length&&$input.length){$input.on("change",inputChange);$input.on("keyup",inputChange);inputChange()}};var _switchMembersFormView=function(user_group,is_new){var is_locked=!!user_group.is_external||!!user_group.auto_type;var options=TS.members.getMembersForUser().filter(_isFullLocalMember).map(function(member){return{member:member}});var renderForm=function(){_$user_groups_form_div.html(TS.templates.user_group_members_form({is_new:is_new,is_locked:is_locked,user_group:user_group}))};var renderUI=function(){var $member_count=$("#member_count");var member_count=user_group.user_count||0;var updateForm=function(){var $button=$(is_new?"#create_group":"#save_group");if($button.length){if(member_count<1){$button.prop("disabled",true)}else{$button.prop("disabled",false)}}};var opts={data:options,approx_item_height:50,template:function(item){var html=TS.templates.user_group_invite_member_small(item);return new Handlebars.SafeString(html)},onItemAdded:function(item){member_count++;$member_count.html(member_count);updateForm()},onItemRemoved:function(item){member_count--;$member_count.html(member_count);updateForm()},filter:function(item,query){var member=item.member;if(query.charAt(0)==="@")query=query.substr(1);var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");return TS.utility.members.checkMemberMatch(member,start_regex)||TS.utility.members.checkMemberMatch(member,suffix_regex)},disabled:!!user_group.is_external||!!user_group.auto_type};$("#user_group_members_select").lazyFilterSelect(opts);_bindMembersFormUI(user_group,is_new);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");updateForm()};if(is_new){renderForm();TS.ui.fs_modal.hideBackButton();renderUI()}else{var selected_members;var work=function(){selected_members=user_group.users;selected_members.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].member.id){options[i].selected=true;break}}});renderForm();_bindBackButton();renderUI()};if(user_group.users===undefined){TS.user_groups.getUserGroupMembers(user_group.id,function(updated_group){if(updated_group&&updated_group.users){user_group=updated_group;return work()}})}else{return work()}}};var _bindMembersFormUI=function(user_group,is_new){_$user_groups_form_div.find(".user_group_members_form").on("submit",function(e){e.preventDefault();var members=$("#user_group_members_select").lazyFilterSelect("value");members=members.map(function(option){return option.member.id});TS.user_groups.updateMembersOfUserGroup({subteam:user_group.id,users:members},function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onUpdateComplete()})});_$user_groups_form_div.find(".user_group_members_form").on("reset",function(e){e.preventDefault();if(is_new){if(TS.boot_data.feature_subteams_hard_delete){TS.user_groups.deleteUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}else{TS.user_groups.disableUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}}else{_onReset(e)}})};var _updateSearch=function(e){var $input=$(e.target);var value=$input.val();if(value!==_last_query){_last_query=value;_$icon_close.toggleClass("hidden",value==="");_refreshList()}};var _clearSearch=function(){var $input=$("#user_group_modal_search");_last_query="";$input.val("");setTimeout(function(){$input.focus()},0);_$icon_close.addClass("hidden");_refreshList()};var _refreshList=function(){var $list_div=$("#user_groups_list_div");var query=_last_query;var html;$("#user_groups_header .user_groups_search").toggleClass("hidden",!_user_groups.length);if(typeof query==="string"&&query.length){var user_groups=_user_groups.filter(function(ug){return ug.handle.indexOf(query)!==-1||ug._name_lc.indexOf(query)!==-1||ug.description&&ug.description.toLowerCase().indexOf(query)!==-1});if(user_groups.length){$list_div.html(TS.templates.builders.buildUserGroupListHTML(user_groups));if(_$monkey_scroll)_$monkey_scroll.updateFunc();return}var template_args={query:query,tab:{label:"User Groups"}};html='<div class="no_results top_margin">'+TS.templates.team_list_no_results(template_args)+"</div>"}else{html=TS.templates.builders.buildUserGroupListHTML(_user_groups)}$list_div.html(html);if(_$monkey_scroll)_$monkey_scroll.updateFunc()};var _isFullLocalMember=function(member){if(!member)return false;if(member._is_local&&!member.deleted&&!member.is_ultra_restricted&&!member.is_restricted&&!(member.is_bot||member.is_slackbot)){return true}return false};var _getUserGroupFromId=function(id){if(id){for(var i=0;i<_user_groups.length;i++){if(_user_groups[i].id==id){return _user_groups[i]}}}return};var _last_query;var _$monkey_scroll;var _$icon_close})();(function(){"use strict";TS.registerModule("enterprise",{enterprise_domain_changed_sig:new signals.Signal,onStart:function(){if(TS.boot_data.page_needs_enterprise)_maybeSetupEnterpriseModel()},getTeamsForMember:function(member,with_shared){var user=TS.model.user;if(!member.enterprise_user)return null;if(with_shared&&!user.enterprise_user)return null;if(!TS.model.enterprise||!TS.model.enterprise_teams)return null;var all_teams=TS.model.enterprise_teams;var member_teams=member.enterprise_user.teams;var user_teams=[];var teams={all:[]};if(with_shared){user_teams=user.enterprise_user.teams;teams.other=[];teams.shared=[]}all_teams.forEach(function(all_team){var has_member=false;var has_user=false;if(member_teams.indexOf(all_team.id)>-1){has_member=true;teams.all.push(all_team)}if(with_shared&&has_member){if(user_teams.indexOf(all_team.id)>-1)has_user=true;if(has_user){teams.shared.push(all_team)}else{teams.other.push(all_team)}}});return teams},upsertAndSignal:function(enterprise){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.upsertAndSignal");if(!enterprise)return;var upsert=TS.enterprise.upsertEnterprise(enterprise);if(upsert.status=="CHANGED"){if(upsert.what_changed.indexOf("name")!=-1){TS.enterprise.enterprise_domain_changed_sig.dispatch(upsert.enterprise)}}return upsert},upsertEnterprise:function(enterprise){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.upsertEnterprise");_maybeSetupEnterpriseModel();var existing_enterprise=TS.model.enterprise;var status="NOOP";var what_changed=[];if(enterprise){for(var k in enterprise){if(existing_enterprise[k]!=enterprise[k]){if(k=="icon"){existing_enterprise[k]=enterprise[k];what_changed.push(k);status="CHANGED"}else if(existing_enterprise[k]!=enterprise[k]){if(enterprise[k]&&!TS.utility.isScalar(enterprise[k])){existing_enterprise[k]=enterprise[k];TS.warn(k+" is not scalar! it needs to be handled by upsertEnterprise specifically to test if it has changed! "+typeof enterprise[k])}else if(typeof enterprise[k]!="boolean"||!enterprise[k]!=!existing_enterprise[k]){existing_enterprise[k]=enterprise[k];what_changed.push(k);status="CHANGED"}}}}}return{status:status,enterprise:existing_enterprise,what_changed:what_changed}},upsertEnterpriseTeam:function(team){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.upsertEnterpriseTeam");if(!team||typeof team==="string")return;var teams=TS.model.enterprise_teams;var existing_enterprise_team=TS.enterprise.getTeamById(team.id);if(existing_enterprise_team){for(var k in team){existing_enterprise_team[k]=team[k]}team=existing_enterprise_team}else{teams.push(team);_processNewTeamForUpserting(team);_id_map[team.id]=team}return team},getTeamById:function(id){var teams=TS.model.enterprise_teams;var team=_id_map[id];if(team)return team;if(!teams)return null;for(var i=0;i<teams.length;i++){team=teams[i];if(team.id===id){TS.warn(id+" not in _id_map?");_id_map[id]=team;return team}}return null},promiseToEnsureEnterprise:function(){if(!TS.boot_data.page_needs_enterprise)TS.warn("Unexpected call to TS.enterprise.promiseToEnsureEnterprise");_maybeSetupEnterpriseModel();return Promise.all([TS.api.call("enterprise.info").reflect(),TS.enterprise.promiseToGetTeams().reflect()]).then(function(responses){var rejection_reasons=[];responses.forEach(function(response){if(response.isFulfilled())return;rejection_reasons.push(response.reason())});if(rejection_reasons.length){return Promise.reject(new Error("Some enterprise APIs failed:\n"+rejection_reasons.join("\n")))}else{var enterprise=responses[0].value().data.enterprise;TS.enterprise.upsertEnterprise(enterprise)}})},promiseToGetTeams:function(exclude_discoverable){var calling_args={include_archived:false,include_deleted:false};if(exclude_discoverable)calling_args.exclude_discoverable=exclude_discoverable;return TS.api.call("enterprise.teams.list",calling_args).reflect().then(function(response){if(!response.isFulfilled())return Promise.reject(new Error("The API failed:\n"+response.reason()));var teams=response.value().data.teams;teams.forEach(function(team){TS.enterprise.upsertEnterpriseTeam(team)});return Promise.resolve(TS.model.enterprise_teams.filter(function(team){if(!exclude_discoverable)return true;return exclude_discoverable.indexOf(team.discoverable)<0}))})},addTeamsToSharedForChannel:function(channel,teams_ids){if(!TS.boot_data.page_needs_enterprise)return;if(!channel.is_shared)return;var shares=channel.shares;teams_ids.forEach(function(team_id){var team=TS.enterprise.getTeamById(team_id);if(!team)return;shares.push({id:team_id,team:team})});channel.shares=shares},updateSharesForChannel:function(channel,teams_ids){if(!TS.boot_data.page_needs_enterprise)return;
if(!channel.is_shared)return;var shares=[];teams_ids.forEach(function(team_id){var team=TS.enterprise.getTeamById(team_id);if(!team)return;shares.push({id:team_id,team:team})});channel.shares=shares}});var _id_map={};var _maybeSetupEnterpriseModel=function(){if(TS.model.enterprise&&TS.model.enterprise_teams)return;TS.model.enterprise=_.merge({},TS.model.enterprise);TS.model.enterprise_teams=_.merge([],TS.model.enterprise_teams)};var _processNewTeamForUpserting=function(team){if(TS.boot_data.feature_discoverable_teams_client){switch(team.discoverable){case"public":team.is_public=true;break;case"private":team.is_private=true;break;case"unlisted":default:team.is_unlisted=true;break}}}})();(function(){"use strict";TS.registerModule("signup",{ERROR_BAD_EMAIL_DOMAIN:"bad_email_domain",ERROR_DOMAIN_NOT_FOUND:"domain_not_found",ERROR_INVALID_CODE:"invalid_code",ERROR_MISC:"misc",ERROR_MISSING_ARGS:"missing_args",ERROR_MISSING_USERNAME:"missing_username",ERROR_NO_EMAIL:"no_email",ERROR_NO_EMAIL_MISC:"no_email_misc",ERROR_NO_TEAM_NAME:"no_team_name",ERROR_NO_URL:"no_url",ERROR_NO_USERNAME:"no_username",ERROR_RATELIMITED:"ratelimited",ERROR_URL_BAD:"url_bad",ERROR_URL_LONG:"url_long",ERROR_URL_NO_LETTER:"url_no_letter",ERROR_URL_START_END_DASH:"url_start_end_dash",ERROR_URL_TAKEN:"url_taken",ERROR_USERNAME_BAD:"username_bad",ERROR_USERNAME_LONG:"username_long",ERROR_USERNAME_NOT_ALLOWED:"username_not_allowed",ERROR_USERNAME_START:"username_start",ERROR_USERNAME_TAKEN:"username_taken",ERROR_NAME_IS_SLACKBOT:"name_is_slackbot",onStart:function(){_method=window.callSlackAPIUnauthed?window.callSlackAPIUnauthed:TS.api.call},isBadSignupDomain:function(domain){if(_checked_bad_domains[domain]!==undefined){return new Promise.resolve(_checked_bad_domains[domain])}return new Promise(function(resolve,reject){_method("signup.checkEmailDomain",{domain:domain},function(ok,data){_checked_bad_domains[domain]=!data.ok;resolve(!data.ok)})})},checkEmail:function(email,options){var check_syntax=TS.utility.email.validateEmail(email,1);if(!check_syntax.is_valid){return new Promise.resolve({is_valid:false,error_key:check_syntax.error_key,error_message:check_syntax.error_message})}options=options||{};var timeout=options.timeout||2e3;var email_domain=email.split("@")[1];var check_mx_records=options.get_info=options.get_info&&_domain_found_mx_records[email_domain]===undefined;if(check_mx_records&&timeout){var resolve;var has_resolved;var timeout_id;_checkEmail(email,email_domain,options).then(function(data){if(!has_resolved){has_resolved=true;resolve(data);clearInterval(timeout_id)}});var timeout_id=setTimeout(function(){if(!has_resolved){_checkEmail(email,email_domain).then(function(data){if(!has_resolved){has_resolved=true;resolve(data)}})}},timeout);return new Promise(function(r){resolve=r})}return _checkEmail(email,email_domain,{get_info:check_mx_records})},verifyEmailConfirmationCode:function(email,code){var api_args={email:email,code:code};return new Promise(function(resolve,reject){_method("signup.confirmCode",api_args,function(ok,data,args){if(ok){return resolve({is_valid:true})}var error_key=data.error;if(error_key=="failed"){error_key=TS.signup.ERROR_INVALID_CODE}return resolve({is_valid:false,error_key:error_key,error_message:TS.signup.getErrorMessage(error_key)})})})},checkUsernameSyntax:function(username){var error_key;if(!username||!username.length){error_key=TS.signup.ERROR_MISSING_USERNAME}else if(username.length>_MAX_USERNAME_LENGTH){error_key=TS.signup.ERROR_USERNAME_LONG}else if(!_REGEX_USERNAME.test(username)){error_key=TS.signup.ERROR_USERNAME_BAD}else if(!_REGEX_USERNAME_START.test(username)){error_key=TS.signup.ERROR_USERNAME_START}if(error_key){return{is_valid:false,error_key:error_key,error_message:TS.signup.getErrorMessage(error_key)}}return{is_valid:true}},checkUsernameAvailability:function(username,options){var check_syntax=TS.signup.checkUsernameSyntax(username);if(!check_syntax.is_valid){return new Promise.resolve({is_valid:false,error_key:check_syntax.error_key,error_message:check_syntax.error_message})}var api_args={username:username};options=options||{};if(options.team_id)api_args["team_id"]=options.team_id;if(options.lead_id)api_args["lead_id"]=options.lead_id;return new Promise(function(resolve,reject){_method("signup.checkUsername",api_args,function(ok,data,args){if(ok){return resolve({is_valid:true})}else{var error_key=data.error;var error_message;if(data.error===TS.signup.ERROR_USERNAME_NOT_ALLOWED){error_message=_ERROR_MESSAGES[error_key]({username:TS.utility.htmlEntities(username)})}else if(data.error==="taken"){error_key=TS.signup.ERROR_USERNAME_TAKEN}var return_data={is_valid:false,error_key:error_key,error_message:error_message||TS.signup.getErrorMessage(error_key)};if(!options.get_suggestions)return resolve(return_data);if(!options.email){TS.warn("TS.signup.checkUsernameAvailability can only try to get username suggestions when options.email is set");return resolve(return_data)}TS.signup.suggestUsernameFromEmail(options.email).then(function(obj){if(obj.has_suggestion){return_data.has_suggestion=true;return_data.suggestion=obj.username}return resolve(return_data)})}})})},suggestUsernameFromEmail:function(email,options){var username=email.toLocaleLowerCase().match(/^[a-z0-9]+/gi);if(username)username=username[0];if(!username||username.length>_MAX_USERNAME_LENGTH){return new Promise.resolve({has_suggestion:false})}return new Promise(function(resolve,reject){options=options||{};var new_options={lead_id:options.lead_id,get_suggestions:false};TS.signup.checkUsernameAvailability(username,new_options).then(function(data){if(data.is_valid){return resolve({has_suggestion:true,username:username})}return resolve({has_suggestion:false})})})},checkNameSyntax:function(name){if(name&&name.toLocaleLowerCase()==="slackbot"){var error_key=TS.signup.ERROR_NAME_IS_SLACKBOT;return{is_valid:false,error_key:error_key,error_message:TS.signup.getErrorMessage(error_key)}}return{is_valid:true}},checkURLSyntax:function(url){var error_key;if(url.length>_MAX_URL_LENGTH){error_key=TS.signup.ERROR_URL_LONG}else if(!_REGEX_LETTERS_NUMS_DASHES.test(url)){error_key=TS.signup.ERROR_URL_BAD}else if(_REGEX_NO_START_END_DASH.test(url)){error_key=TS.signup.ERROR_URL_START_END_DASH}else if(!_REGEX_HAS_LETTER.test(url)){error_key=TS.signup.ERROR_URL_NO_LETTER}if(error_key){return{is_valid:false,error_key:error_key,error_message:TS.signup.getErrorMessage(error_key)}}return{is_valid:true}},checkURLAvailability:function(url,email,options){if(!url||!email){TS.error("TS.signup.checkURLAvailability missing arguments");return new Promise.resolve({is_valid:false,error_key:TS.signup.ERROR_MISSING_ARGS,error_message:TS.signup.getErrorMessage(TS.signup.ERROR_MISSING_ARGS)})}var check_syntax=TS.signup.checkURLSyntax(url);if(!check_syntax.is_valid){return new Promise.resolve({is_valid:false,error_key:check_syntax.error_key,error_message:check_syntax.error_message})}var api_args={email:email,url:url};options=options||{};if(options.lead_id)api_args["lead_id"]=options.lead_id;return new Promise(function(resolve,reject){_method("signup.checkURL",api_args,function(ok,data,args){if(ok){return resolve({is_available:true})}else if(data.error==="ratelimited"){return resolve({error_key:TS.signup.ERROR_RATELIMITED,error_message:TS.signup.getErrorMessage(TS.signup.ERROR_RATELIMITED)})}if(data.error==="bad")data.error=TS.signup.ERROR_URL_BAD;if(data.error==="taken")data.error=TS.signup.ERROR_URL_TAKEN;var return_data={is_available:false,error_key:data.error,error_message:TS.signup.getErrorMessage(data.error)};if(!options.get_suggestions)return resolve(return_data);TS.signup.suggestURL(url,email).then(function(obj){return_data.available=obj.available;return_data.unavailable=obj.unavailable;return resolve(return_data)})})})},suggestURL:function(url,email){if(!url||!email){TS.error("TS.signup.suggestURL missing arguments");return new Promise.resolve({error_key:TS.signup.ERROR_MISSING_ARGS,error_message:TS.signup.getErrorMessage(TS.signup.ERROR_MISSING_ARGS)})}var api_args={email:email,url:url};return new Promise(function(resolve,reject){_method("signup.suggestURL",api_args,function(ok,data,args){if(ok){return resolve({available:data.available,unavailable:data.unavailable})}return resolve({error_key:data.error})})})},createTeam:function(api_args){return new Promise(function(resolve,reject){_method("signup.createTeam",api_args,function(ok,data,args){if(ok){return resolve({team_created:true,signin_url:data.url,user_id:data.user_id,team_id:data.team_id,api_token:data.api_token,valid_signup_domain:data.valid_signup_domain})}var error_message;if(data.error===TS.signup.ERROR_BAD_EMAIL_DOMAIN&&TS.utility.email_regex.test(api_args.email)){var email_domain=TS.utility.htmlEntities(api_args.email.split("@")[1]);error_message=_ERROR_MESSAGES[data.error]({email_domain:email_domain})}return resolve({team_created:false,error_key:data.error,error_message:error_message||TS.signup.getErrorMessage(data.error)})})})},getErrorMessage:function(error_key,data){return(_ERROR_MESSAGES[error_key]||_ERROR_MESSAGES[TS.signup.ERROR_MISC])(data||{})},test:function(){return{error_messages:_ERROR_MESSAGES}}});var _ERROR_MESSAGES={bad_email_domain:TS.i18n.t("Sorry, but we do not allow signups from @{email_domain}. Please pick a different email address!","signup"),domain_not_found:TS.i18n.t("Are you sure that address is typed correctly? If there are no mistakes, carry on!","signup"),invalid_code:TS.i18n.t("That code wasnt valid. Give it another go!","signup"),missing_username:TS.i18n.t("Please fill in a username.","signup"),name_is_slackbot:TS.i18n.t("Sorry, slackbot is a reserved word. Try something else!","signup"),misc:TS.i18n.t("For some weird reason, that didnt work. Please try again to continue.","signup"),no_email:TS.i18n.t("For some really weird reason, were having trouble with your email. Please try again.","signup"),no_email_misc:TS.i18n.t("For some really weird reason, were having trouble with your email preferences. Please try again.","signup"),no_team_name:TS.i18n.t("For some really weird reason, were having trouble with your team name. Please try again.","signup"),no_url:TS.i18n.t("For some really weird reason, were having trouble with your web address. Please try again.","signup"),no_username:TS.i18n.t("For some really weird reason, were having trouble with your username. Please try again.","signup"),ratelimited:TS.i18n.t("Sorry, youve hit the rate limit. Youll be able to try again soon.","signup"),url_bad:TS.i18n.t("Web addresses can only have letters, numbers, and dashes.","signup"),url_long:TS.i18n.t("Web addresses must be 21 characters or less.","signup"),url_no_letter:TS.i18n.t("Web addresses must have at least one letter.","signup"),url_start_end_dash:TS.i18n.t("Web addresses cant start or end with a dash. Sorry!","signup"),url_taken:TS.i18n.t("This web address is not available. Sorry!","signup"),username_bad:TS.i18n.t("Sorry, usernames can only contain letters, numbers, periods, hyphens, and underscores, with no spaces!","signup"),username_long:TS.i18n.t("Usernames cannot be longer than 21 characters.","signup"),username_not_allowed:TS.i18n.t("Oops, sorry! Your username cant be {username}, as its reserved for other uses.","signup"),username_start:TS.i18n.t("Sorry, usernames must begin with a letter or number!","signup"),username_taken:TS.i18n.t("Sorry, but this username is not available! Please pick another one.","signup")};var _MAX_URL_LENGTH=21;var _MAX_USERNAME_LENGTH=21;var _REGEX_LETTERS_NUMS_DASHES=new RegExp("^[a-z0-9-]+$","i");var _REGEX_HAS_LETTER=new RegExp("[a-z]","i");var _REGEX_NO_START_END_DASH=new RegExp("(^[-])|(.*[-])$","i");var _REGEX_USERNAME=new RegExp("^[a-z0-9-._]+$","i");var _REGEX_USERNAME_START=new RegExp("^[a-z0-9][a-z0-9-._]*$","i");var _method;var _checked_bad_domains={};var _domain_found_mx_records={};var _checkEmail=function(email,email_domain,options){var check_mx_records=options&&options.get_info;var api_args={email:email,get_info:check_mx_records};return new Promise(function(resolve,reject){_method("signup.checkEmail",api_args,function(ok,data,args){if(ok){return resolve({is_ok:true})}else{var error_message;if(data.error===TS.signup.ERROR_BAD_EMAIL_DOMAIN){error_message=_ERROR_MESSAGES[data.error]({email_domain:email_domain})}else if(data.error===TS.signup.ERROR_DOMAIN_NOT_FOUND){_domain_found_mx_records[email_domain]=false}else if(check_mx_records){_domain_found_mx_records[email_domain]=true}return resolve({is_ok:false,error_key:data.error,error_message:error_message||TS.signup.getErrorMessage(data.error)})}})})}})();(function(){"use strict";TS.registerModule("google_auth",{isAuthed:function(instance_id){return _auth_instances[instance_id]},pollForAuthStatus:function(instance_id,callback,window_ref,options){options=options||{};var interval=options.interval||1e3;var max_attempts=options.max_attempts||Infinity;var attempts=0;var timeout_id;var is_authed;var clear_polling=false;var checkAuth=function(){++attempts;is_authed=TS.google_auth.isAuthed(instance_id);if(is_authed||window_ref&&window_ref.closed){timeout_id=null;callback(!!is_authed)}else if(!clear_polling&&attempts<max_attempts){_checkIfAuthed(instance_id);timeout_id=setTimeout(checkAuth,interval)}};checkAuth();return{cancel:function(){if(timeout_id)clearTimeout(timeout_id);clear_polling=true}}},getAuthLink:function(instance_id){if(_auth_urls[instance_id])return new Promise.resolve(_auth_urls[instance_id]);return new Promise(function(resolve,reject){TS.api.call("services.googlecontacts.oauth.init",{instance_id:instance_id}).then(function(obj){_auth_urls[instance_id]=obj.data.auth_url;resolve(obj.data.auth_url)})})},getContactList:function(instance_id,opts){if(!TS.google_auth.isAuthed(instance_id))return new Promise.resolve([]);return new Promise(function(resolve,reject){var aggregate_data=[];TS.google_auth.getContactsFromAPI(instance_id,opts,aggregate_data,function(data){resolve(data||[])})})},getContactsFromAPI:function(instance_id,opts,aggregate_data,callback){TS.api.call("services.googlecontacts.list",{instance_id:instance_id,page:opts.page,count:opts.count}).then(function(obj){aggregate_data.push.apply(aggregate_data,obj.data.contacts);if(obj.data.all_items_fetched===false){opts.page=opts.page+1;TS.google_auth.getContactsFromAPI(instance_id,opts,aggregate_data,callback)}else{var callback_data={items:aggregate_data,all_items_fetched:obj.data.all_items_fetched};callback(callback_data)}})},getContactListFromQuery:function(instance_id,opts){if(!TS.google_auth.isAuthed(instance_id))return new Promise.resolve([]);return new Promise(function(resolve,reject){TS.api.call("services.googlecontacts.search",{instance_id:instance_id,query:opts.query,page:opts.page,count:opts.count}).then(function(obj){var data={items:obj.data.contacts,all_items_fetched:obj.data.all_items_fetched};resolve(data||[])})})},isAppsEmail:function(email_val,timeout){if(!TS.utility.email.validateEmail(email_val).is_valid){return new Promise.resolve({error_key:"invalid_email"})}var domain=email_val.split("@")[1];if(_cached_is_apps_email_checks[domain]!==undefined){return new Promise.resolve(_cached_is_apps_email_checks[domain])}var timeout_id;var has_timed_out;var api_args={email:email_val,get_info:true};var method=window.callSlackAPIUnauthed?window.callSlackAPIUnauthed:TS.api.call;return new Promise(function(resolve){method("signup.checkEmail",api_args,function(ok,data,args){if(timeout_id){clearTimeout(timeout_id);timeout_id=null}if(ok){_cached_is_apps_email_checks[domain]={is_google:data.type==="google_apps",auth_url:data.auth_url}}if(!has_timed_out){return resolve(_cached_is_apps_email_checks[domain])}});if(timeout){timeout_id=setTimeout(function(){TS.log(99,"TS.google_auth.isAppsEmail timed out after "+timeout/1e3+" seconds");timeout_id=null;has_timed_out=true;return resolve({error_key:"timed_out"})},timeout)}})}});var _cached_is_apps_email_checks={};var _auth_instances={};var _auth_urls={};var _checkIfAuthed=function(instance_id){return new Promise(function(resolve,reject){TS.api.call("services.googlecontacts.oauth.hasAuth",{instance_id:instance_id}).then(function(obj){var has_authed=obj.data.has_auth;_auth_instances[instance_id]=has_authed;resolve(has_authed)})})}})();(function(){"use strict";TS.registerModule("utility.email",{ERROR_EMPTY:"empty",ERROR_INVALID:"invalid",ERROR_TOO_MANY:"too_many",EMAIL_REGEX:new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i"),DOMAIN_REGEX:new RegExp("^@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i"),convertToArray:function(email_val){return email_val.replace(/\s|\n/g,"").replace(/,$/g,"").split(",")},validateEmail:function(email_val,max_addresses){var email_array=TS.utility.email.convertToArray(email_val);return _validateEmail(email_array,max_addresses)},validateDomain:function(email_domain_val){var email_domain_array=email_domain_val?TS.utility.email.convertToArray(email_domain_val):[];return _validateDomain(email_domain_array)},correctTypos:function(email_val,recorrect){if(recorrect===undefined)recorrect=true;return _correctAllTypos(email_val,recorrect)},removeDuplicates:function(email_val){return _.uniq(TS.utility.email.convertToArray(email_val)).join(",")},getErrorMessage:function(error_key,data){return _ERROR_MESSAGES[error_key]?_ERROR_MESSAGES[error_key](data||{}):""},getTooManyErrorMessage:function(max_addresses){return _ERROR_MESSAGES[TS.utility.email.ERROR_TOO_MANY]({max_addresses:max_addresses})},test:function(){return{error_messages:_ERROR_MESSAGES,tld_typo:_TLD_TYPO,domain_typo:_DOMAIN_TYPO}}});var _ERROR_MESSAGES={empty:TS.i18n.t("Please fill in your email.","email_utility"),invalid:TS.i18n.t("Sorry, but your email is invalid.","email_utility"),too_many:TS.i18n.t("Please make your list shorter  we can check up to {max_addresses} addresses at a time.","email_utility"),invalid_domain:TS.i18n.t("Sorry, but that isnt a valid email domain.","email_utility")};var _validateDomain=function(domain_array){if(!Array.isArray(domain_array))TS.error("Type error: TS.utility.email._validateDomain requires an array. domain_array is a",typeof domain_array);var error_domain_array=[];_.each(domain_array,function(domain_val){if(!TS.utility.email.DOMAIN_REGEX.test(domain_val)){error_domain_array.push(domain_val)}});if(error_domain_array.length){var error_key="invalid_domain";return{is_valid:false,email_domain:domain_array,error_key:error_key,error_message:_ERROR_MESSAGES[error_key](),error_domains:error_domain_array}}return{is_valid:true,email_domain:domain_array,error_key:"",error_message:""}};var _validateEmail=function(email_array,max_addresses){if(!Array.isArray(email_array))TS.error("Type error: TS.utility.email._validateEmail requires an array. email_array is a",typeof email_array);var index=0;var total_emails=email_array.length;var email_val;var error_key;var error_message;if(max_addresses&&total_emails>max_addresses){error_key=TS.utility.email.ERROR_TOO_MANY;if(max_addresses>1){error_message=TS.utility.email.getTooManyErrorMessage(max_addresses)}else{error_message=TS.utility.email.getErrorMessage(TS.utility.email.ERROR_INVALID)}return{is_valid:false,email_array:email_array,error_key:error_key,error_message:error_message}}for(index;index<total_emails;index++){email_val=email_array[index];if(!index&&email_val===""){error_key=TS.utility.email.ERROR_EMPTY}else if(!TS.utility.email.EMAIL_REGEX.test(email_val)){error_key=TS.utility.email.ERROR_INVALID}if(error_key){return{is_valid:false,email_array:email_array,error_key:error_key,error_message:TS.utility.email.getErrorMessage(error_key)}}}return{is_valid:true,email_array:email_array,error_key:"",error_message:""}};var _TLD_TYPO={cmo:"com",ocm:"com",con:"com",om:"com","com.com":"com",vom:"com",cim:"com",cpm:"com",ccom:"com",coom:"com",comm:"com"};var _DOMAIN_TYPO={gmai:"gmail",gamil:"gmail",gmil:"gmail",gmial:"gmail",gmal:"gmail",gmaill:"gmail",gnail:"gmail",gamail:"gmail",gmsil:"gmail",yhoo:"yahoo",yahooo:"yahoo",yaho:"yahoo",homail:"hotmail",hotmaill:"hotmail",outook:"outlook",outlock:"outlook",otlook:"outlook",outlolk:"outlook"};var _corrected_emails={};var _correctAllTypos=function(email_val,recorrect){if(recorrect===undefined)recorrect=true;var email_array=TS.utility.email.convertToArray(email_val);var updated_val=email_val;var shadow_val=email_val;email_array.forEach(function(email,index){if(!recorrect&&_corrected_emails[email])return;var corrected=_correctTypos(email);if(corrected.has_typo){_corrected_emails[email]=true;updated_val=updated_val.replace(email,corrected.email_val);shadow_val=shadow_val.replace(email,corrected.shadow_val)}});return{typo_corrected:email_val!==updated_val,shadow_email:shadow_val.replace(/\n/g,"<br />"),updated_email:updated_val}};var _correctTypos=function(email_val){var shadow_val=email_val;var has_typo;var typo;var regex;for(typo in _TLD_TYPO){regex=new RegExp("\\."+typo+"$");if(regex.test(email_val)){has_typo=true;email_val=email_val.replace(regex,"."+_TLD_TYPO[typo]);shadow_val=shadow_val.replace(regex,'.<span class="seafoam_green">'+_TLD_TYPO[typo]+"</span>");break}}for(typo in _DOMAIN_TYPO){regex=new RegExp("@"+typo+"\\.");if(regex.test(email_val)){has_typo=true;email_val=email_val.replace(regex,"@"+_DOMAIN_TYPO[typo]+".");shadow_val=shadow_val.replace(regex,'@<span class="seafoam_green">'+_DOMAIN_TYPO[typo]+"</span>.");break}}return{has_typo:has_typo,email_val:email_val,shadow_val:shadow_val}}})();(function(){"use strict";TS.registerModule("ui.email_healing",{onStart:function(){_bindEmailInputs()},test:function(){return{_correctEmailTypos:_correctEmailTypos}}});var _count=0;var _colors={};var _bindEmailInputs=function(){var $body=$("body");$body.on("input","[data-email-healing]",_.debounce(_correctEmailTypos,600));$body.on("blur","[data-email-healing]",_correctEmailTypos)};var _correctEmailTypos=function(){var input_element=this;var email_val=_htmlEntities(input_element.value);if(!TS.utility.email.validateEmail(email_val).is_valid)return;var corrected=TS.utility.email.correctTypos(email_val,false);if(!corrected.typo_corrected)return;var id=input_element.getAttribute("data-email-healing");if(id==="true"){id=_count++;input_element.setAttribute("data-email-healing",id)}if(_colors[id]===undefined){_colors[id]={color:window.getComputedStyle(input_element).color,orange:this.getAttribute("data-email-healing-typo-color")||"#ffa800",green:this.getAttribute("data-email-healing-corrected-color")||"#2ab27b"}}input_element.style.color=_colors[id].orange;input_element.style.transition="color 0.2s ease-out 0s";setTimeout(function(){input_element.value=corrected.updated_email;input_element.style.color=_colors[id].green;input_element.style.transition="color 0.2s ease-out 0s"},300);setTimeout(function(){input_element.style.color=_colors[id].color;input_element.style.transition="color 0.6s ease-out 0.3s"},500)};var _htmlEntities=function(str){if(!str&&str!==0)return"";return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}})();(function(){"use strict";TS.registerModule("utility.search",{onStart:function(){},makeClause:function(type,value,field_id){if(_validateClauseParameters(type,value,field_id))return;var clause={type:type.toLowerCase(),value:value};if(field_id)clause.field_id=field_id;return clause},makeConjunction:function(type,clauses){if(_validateConjunctionParameters(type,clauses))return;return{type:type.toLowerCase(),clauses:clauses}},promiseToSearch:function(args){if(!args||!args.query)return Promise.reject(new Error("cannot search without arguments and a query"));if(args.all_of_org&&!TS.boot_data.page_needs_enterprise)return Promise.reject(new Error("cannot search an org when not an enterprise team"));if(TS.lazyLoadMembersAndBots()){if(!args.hasOwnProperty("raw_query")){return Promise.reject(new Error("Flannel searches require a `raw_query` to be provided"))}var query=args.raw_query;var max_count=args.count||Infinity;var results_p;if(_.isEmpty(args.raw_query)){results_p=Promise.resolve([])}else{results_p=TS.flannel.fetchAndUpsertObjectsWithQuery({query:args.raw_query,count:max_count})}return results_p.then(function(members){if(!args.include_bots){var deleted_bots=_.remove(members,{is_bot:true});if(deleted_bots.length)TS.log(1989,"Flannel: removed these bots from results:",deleted_bots)}if(TS.boot_data.page_needs_enterprise&&!args.all_of_org){var deleted_org_members=_.remove(members,function(member){var teams_for_member=_.get(member,"enterprise_user.teams",[]);var member_is_on_this_team=teams_for_member.includes(TS.model.team.id);return!member_is_on_this_team});if(deleted_org_members.length)TS.log(1989,"Flannel: removed these org members from results:",deleted_org_members)}if(!args.include_deleted){var deleted_members=_.remove(members,{deleted:true});if(deleted_members.length)TS.log(1989,"Flannel: removed these deleted members from results:",deleted_members)}return{ok:true,data:{items:members.slice(0,max_count),next_cursor_mark:null,num_found:members.length,teams:[TS.model.team]},args:{query:query}}})}var calling_args={query:JSON.stringify(args.query)};["sort","sort_direction","count","cursor_mark","include_bots","include_deleted"].forEach(function(key){if(args[key])calling_args[key]=args[key]});return TS.api.call(args.all_of_org?"search.enterprise":"search.team",calling_args).catch(_handleError)}});var _validateClauseParameters=function(type,value,field_id){if(!type)return void TS.error("cannot make a clause without a type");if(!value)return void TS.error("cannot make a clause without a value");if(type==="custom"&&!field_id)return void TS.error("cannot make a custom type clause without a field id")};var _validateConjunctionParameters=function(type,clauses){if(!type)return void TS.error("cannot make a conjunction without an 'and' or 'or' type");if(!clauses||clauses.length<2)return void TS.error("cannot make a conjunction without at least two clauses")};var _handleError=function(error){TS.error(error.data.error+" error occured while searching");TS.generic_dialog.alert("Sorry! Something went wrong. Please try again.");throw error}})();(function(){"use strict";TS.registerModule("utility.calls_analytics",{onStart:function(){if(TS.calls){TS.calls.room_id_sig.add(_sigRoomId);TS.web.login_sig.add(_sigLoggedIn)}if(TS.client){TS.utility.calls.room_id_sig.add(_sigRoomId);TS.client.login_sig.add(_sigLoggedIn)}},teardown:function(){clearTimeout(_record_timer);if(_utility_call_analytics_state.room_id)delete _utility_call_analytics_state.room_id},isStateClean:function(){return _.isEmpty(_utility_call_analytics_state)},record:function(series,stats){_record_buffer.push(_createAnalyticsData(series,stats));if(!_record_timer){_record_timer=setTimeout(TS.utility.calls_analytics.flush,_record_timer_duration)}},promiseToRecordImmediately:function(series,stats){var data={database:_getDatabaseName(),points:[_createAnalyticsData(series,stats)]};return TS.api.call("screenhero.rooms.proxyAnalytics",{data:JSON.stringify(data)}).catch(_.noop)},flush:function(){if(_record_buffer.length){var now=Date.now();_record_buffer=_record_buffer.map(function(data){data.fields["posted_time"]=now;return data});TS.api.call("screenhero.rooms.proxyAnalytics",{data:JSON.stringify({database:_getDatabaseName(),points:_record_buffer})}).catch(_.noop);_record_buffer=[]}clearTimeout(_record_timer);_record_timer=undefined},logEvent:function(event){var series;if(!(TS.model&&TS.model.user&&TS.model.user.id||_utility_call_analytics_state.room_id)){TS.warn("calls analytics module not ready: "+JSON.stringify(event));return}series=["user_event_logs"];if(_utility_call_analytics_state.room_id){series.push(_utility_call_analytics_state.room_id)}else{series.push(TS.model.user.id)}$.extend(event||{},{user_id:TS.model.user.id,os:_calls_analytics_config.os,ssb_version:_calls_analytics_config.ssb_version,webapp_version:_calls_analytics_config.webapp_version});TS.utility.calls_analytics.record(series.join("."),event)}});var _calls_analytics_config={};var _record_timer;var _record_timer_duration=1e4;var _record_buffer=[];var _utility_call_analytics_state={};var _getDatabaseName=function(){return TS.boot_data.version_ts==="dev"?"calls_dev":"calls"};var _createAnalyticsData=function(series,stats){if(typeof stats==="string"||typeof stats==="number"){stats={value:stats}}stats["value"]=JSON.stringify(stats["value"]);stats["client_time"]=Date.now();return{measurement:series,fields:stats}};var _sigRoomId=function(options){_utility_call_analytics_state.room_id=options.room_id};var _sigLoggedIn=function(){_calls_analytics_config.os=TS.model.is_mac?"mac":TS.model.is_win?"win":TS.model.is_lin?"lin":navigator.userAgent;_calls_analytics_config.webapp_version=TS.boot_data.min_sh_version_ts;if(TS.model.mac_ssb_version){if(window.macgap&&macgap.screenhero&&macgap.screenhero.getAppVersion){_calls_analytics_config.ssb_version=macgap.screenhero.getAppVersion()}else{_calls_analytics_config.ssb_version=TS.model.mac_ssb_version+"."+TS.model.mac_ssb_version_minor}}else if(TS.model.win_ssb_version){_calls_analytics_config.ssb_version=TS.model.win_ssb_version+"."+TS.model.win_ssb_version_minor}else if(TS.model.lin_ssb_version){_calls_analytics_config.ssb_version=TS.model.lin_ssb_version+"."+TS.model.win_lin_version_minor}else{_calls_analytics_config.ssb_version="N/A"}}})();(function(){"use strict";TS.registerModule("utility.calls_log",{enableDevLogging:function(){if(TS.boot_data.version_ts==="dev")TS.pri="123,"+TS.pri},enableBuffering:function(enable){_calls_log_config.enable_buffering=enable},log:function(){var msg=_constructMsg.apply(null,arguments);_storeToLogBuffer(msg,"DBG")},logInfo:function(){var msg=_constructMsg.apply(null,arguments);TS.info(msg);_storeToLogBuffer(msg,"INF")},logWarn:function(){var msg=_constructMsg.apply(null,arguments);TS.warn(msg);_storeToLogBuffer(msg,"WRN")},logError:function(){var msg=_constructMsg.apply(null,arguments);TS.error(msg);_storeToLogBuffer(msg,"ERR")},logEvent:function(event,skip_analytics){_logEvent(event,"EDBG",skip_analytics)},logEventInfo:function(event){_logEvent(event,"EINF")},logEventWarn:function(event){_logEvent(event,"EWRN")},logEventError:function(event){_logEvent(event,"EERR")},getAndClearBuffer:function(){var log_str=_utility_call_log_state.buffer.join("\n");if(_utility_call_log_state.buffer_overflow){log_str=log_str+_calls_log_config.excess}_utility_call_log_state.buffer=[];_utility_call_log_state.buffer_length=0;_utility_call_log_state.buffer_overflow=false;return log_str}});var _calls_log_config={enable_buffering:false,MAX_LENGTH:3e4,excess:"... log is too long"};var _utility_call_log_state={buffer:[],buffer_length:0,buffer_overflow:false};var _storeToLogBuffer=function(msg,level){var prefix;if(_calls_log_config.enable_buffering===false)return;prefix="["+level+"|"+TS.makeLogDate()+"]:";if(prefix.length+msg.length+_utility_call_log_state.buffer_length+_calls_log_config.excess.length<_calls_log_config.MAX_LENGTH){_utility_call_log_state.buffer.push(prefix+msg)}else{_utility_call_log_state.buffer_overflow=true}};var _constructMsg=function(){var msg=[];for(var i=0;i<arguments.length;i++){if(!arguments[i])continue;if(typeof arguments[i]==="object"){msg.push(JSON.stringify(arguments[i]))}else{msg.push(arguments[i].toString())}}return msg.join("")};var _logEvent=function(event,level,skip_analytics){var msg=_constructMsg(event.value);var name_value=event.event+": "+msg;switch(level){case"EDBG":break;case"EINF":TS.info(name_value);break;case"EWRN":TS.warn(name_value);break;case"EERR":TS.error(name_value);break}if(!skip_analytics){TS.utility.calls_analytics.logEvent($.extend(event,{level:level}))}_storeToLogBuffer(name_value,level)}})();(function(){"use strict";TS.registerModule("utility.calls",{share_url_prefix:document.location.origin+"/call/",calls_window_changed_sig:new signals.Signal,room_id_sig:new signals.Signal,started_platform_call_sig:TS.boot_data.feature_platform_calls?new signals.Signal:null,
window_types:{call_window:"call_window",mini_panel:"mini_panel",incoming_call:"incoming_call"},messages_to_call_window_types:{invite_response:"invite_response",invite_cancel:"invite_cancel",start_call:"start_call",caller_id:"caller_id",mini_panel_action:"mini_panel_action",did_close_window:"did_close_window",ping:"ping",ms_msg:"ms_msg",reachability:"reachability",calls_status:"calls_status",regions:"regions",got_server:"got_server",got_server_error:"got_server_error"},messages_to_mini_panel_types:{update_state:"update_state"},messages_from_call_window_types:{update_mini_panel:"update_mini_panel",set_call_window_loaded:"set_call_window_loaded",set_call_window_busy:"set_call_window_busy",show_growl_notification:"show_growl_notification",pong:"pong",close:"close",get_calls_status:"get_calls_status",force_janus_disconnect:"force_janus_disconnect",get_regions:"get_regions",get_server:"get_server",get_member_data:"get_member_data",play_sound:"play_sound"},messages_from_incoming_call_types:{user_clicked_accept_or_reject:"user_clicked_accept_or_reject"},messages_from_mini_panel_types:{user_clicked_action:"user_clicked_action"},invite_response_types:{accept:"accept",reject:"reject",on_call:"on_call",dnd:"dnd",hangup:"hangup"},invite_cancel_types:{cleanup:"cleanup",timeout:"timeout",inviter_cancel:"inviter_cancel",accepted_timeout:"accepted_timeout",caller_hangup:"caller_hangup"},invite_unsupported_types:{platform:"platform",client_version:"client_version",offline:"offline"},onStart:function(){_utility_call_state.in_slack_app=!!TS.client;_utility_call_state.in_call_window=!!TS.calls;_utility_call_state.calls_url_prefix=document.location.origin+"/call/";if(_utility_call_state.in_slack_app){TS.ms.on_msg_sig.add(_sigMsgReceived);TS.ms.connected_sig.add(_sigMSConnected);TS.ms.disconnected_sig.add(_sigMSDisconnected);window.addEventListener("online",_sigReachabilityChanged);window.addEventListener("offline",_sigReachabilityChanged);window.addEventListener("message",_receivePostedMessageFromChildWindow);if(TS.model.is_our_app){if(window.macgap)TS.ssb.teams_did_load_sig.add(_sigTeamsDidLoad);TS.client.login_sig.add(_sigDidLogin)}if(TS.client.windows){TS.client.windows.win_finished_loading_sig.add(_sigWindowFinishedLoading);TS.client.windows.win_will_close_sig.add(_sigWindowClosed);TS.client.windows.win_crashed_sig.add(_sigWindowCrashed);TS.client.windows.win_became_key_sig.add(_sigWindowBecameKey);TS.client.windows.win_resigned_key_sig.add(_sigWindowResignedKey)}if(TS.ui)TS.ui.window_unloaded_sig.add(_sigClientWindowUnloaded);if(TS.model.is_our_app){_utility_call_state.call_window_loaded=false}else{_utility_call_state.call_window_loaded=true}_utility_call_state.is_ms_connected=false;_utility_call_state.is_reachability_online=true}},startCallInModelOb:function(model_ob,force_native_call,is_video_call){var call_info;var is_platform_call=TS.boot_data.feature_platform_calls&&!force_native_call&&TS.model.team.prefs.calling_app_name!="Slack";if(TS.utility.strLooksLikeAMemberId(model_ob.id)){var member_id=model_ob.id;model_ob=TS.ims.getImByMemberId(member_id);if(!model_ob){TS.ims.promiseToStartImByMemberId(member_id,true,false).then(function(){model_ob=TS.ims.getImByMemberId(member_id);call_info={id:model_ob.id,is_dm:model_ob.is_im,is_mpdm:model_ob.is_mpim,is_video_call:is_video_call};if(is_platform_call){TS.utility.calls.launchPlatformCalls(call_info)}else{TS.utility.calls.launchVideoCall(call_info)}});return}}call_info={id:model_ob.id,is_dm:model_ob.is_im,is_mpdm:model_ob.is_mpim,is_video_call:is_video_call};if(is_platform_call){TS.utility.calls.launchPlatformCalls(call_info)}else{TS.utility.calls.launchVideoCall(call_info)}},getCallsUrlPrefix:function(){return _utility_call_state.calls_url_prefix},isEnabled:function(){if(!TS.model||!TS.model.team||!TS.model.team.prefs)return false;if(TS.model.is_our_app&&TS.model.lin_ssb_version&&!TS.boot_data.feature_calls_linux){return false}return TS.boot_data.feature_calls&&TS.model.team.prefs.allow_calls},isCallWindowReady:function(){return _utility_call_state.is_reachability_online&&_utility_call_state.is_ms_connected},isMultiPartyEnabled:function(){return TS.utility.calls.isEnabled()&&TS.model.team.plan!==""},isCurrentContextMultiParty:function(){if(TS.model.active_channel_id||TS.model.active_group_id||TS.model.active_mpim_id){return true}return false},launchPlatformCalls:function(call_info){if(!call_info)return;if(!call_info.id)return;var is_ssb=TSSSB.env.desktop_app_version!=null;TS.utility.calls.started_platform_call_sig.dispatch({is_loading:true});TS.api.call("calls.request",{channel:call_info.id,app:TS.model.team.prefs.calling_app_id}).then(function(res){if(!res.data.ok){_handleCallsRequestError(res);return}var platform_calls_window=window.open(encodeURI(res.data.url),TS.model.team.prefs.calling_app_name);try{platform_calls_window.focus()}catch(e){if(!is_ssb){var browser=bowser.name||"your browser";var popup_ephemeral_msg={text:"Please allow pop-ups in "+browser+" to make a call. You can <http://my.slack.com/help/requests/new|contact Slack> if you need help.",ephemeral_type:"enable_popups",slackbot_feels:"sad_surprise"};TS.client.ui.addEphemeralBotMsg(popup_ephemeral_msg)}}}).catch(function(res){_handleCallsRequestError(res)}).finally(function(){TS.utility.calls.started_platform_call_sig.dispatch({is_loading:false})})},launchVideoCall:function(call_info){if(!TS.model.supports_voice_calls&&!TS.utility.calls.platformHasCallsCode()){_showModalForUnsupportedCalls();return}if(!call_info)return;if(!call_info.id)return;if(!TS.utility.calls.isCallWindowReady())return;_isCallWindowBusy().then(function(is_busy){if(is_busy){_handleAlreadyInCall();return}TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.start_call,value:call_info});_startCall(_utility_call_state.calls_url_prefix+call_info.id,call_info.id,{start_with_video:call_info.is_video_call})})},sendInvitationResponseToCaller:function(args){if(!args||!args.user_id||!args.room_id||!args.response||!TS.utility.calls.invite_response_types[args.response]){TS.utility.calls_log.log("sendInvitationResponseToCaller: invalid args: ",args);return}TS.utility.calls.room_id_sig.dispatch({room_id:args.room_id});if(args.response){TS.api.callImmediately("screenhero.rooms.inviteResponse",{caller:args.user_id,room:args.room_id,response:args.response},function(ok,data,args){if(!ok)TS.utility.calls_log.log("inviteResponse API failed with: ",data)});if(args.response===TS.utility.calls.invite_response_types.accept){_utility_call_state.accepted_caller_id=args.user_id;_joinVideoCall(args.room_id,args.did_choose_video)}}Promise.join(_isCallWindowBusy(),_isInIncomingCall(),function(call_window_busy,incoming_call_window_busy){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.invite_response_send,value:{response_type:args.response,user_id:args.user_id,room_id:args.room_id,is_call_window_busy:call_window_busy,is_in_incoming_call:incoming_call_window_busy}});return null})},closeIncomingCallWindow:function(skip_teardown){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.close_incoming_call});if(TS.model.is_our_app){if(window.macgap){TSSSB.call("closeIncomingCallWindow")}else if(window.winssb){if(_utility_call_state.incoming_call_token){TSSSB.call("closeWindow",_utility_call_state.incoming_call_token);delete _utility_call_state.incoming_call_token}}}else{_isInIncomingCall().then(function(is_in_incoming_call){if(is_in_incoming_call)TS.incoming_call.timeout()})}if(!skip_teardown)_teardownIncomingCall()},maybeHandleCallLink:function($el){if(!TS.boot_data.feature_calls)return false;if(!_utility_call_state.in_slack_app)return false;if(!$el||!$el.length)return false;if(!$el.is("a"))return false;var href=$el.attr("href");if(!href)return false;href=TS.utility.normalizeDevHost(href);href=href.replace("https://","").replace("http://","");var call_url=TS.utility.normalizeDevHost(_utility_call_state.calls_url_prefix);call_url=call_url.replace("https://","").replace("http://","");if(href.indexOf(call_url)===0){href=href.replace(call_url,"call/")}while(href.indexOf("/")===0){href=href.substr(1)}if(href.indexOf("call/")!==0)return false;var A=href.split("/");if(A.length<2)return false;var room_id=A[1];if(!room_id)return false;if(!TS.utility.calls.isCallWindowReady())return true;_isInIncomingCall().then(function(is_in_incoming_call){if(is_in_incoming_call){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.call_object_click_in_incoming_call});return}TS.utility.calls.room_id_sig.dispatch({room_id:room_id});_joinVideoCall(room_id)});return true},getParentWindow:function(){if(window.macgap){if(_utility_call_state.in_call_window){if(document.ssb_main&&document.ssb_main.TS&&document.ssb_main.TS.utility&&document.ssb_main.TS.utility.calls){return document.ssb_main.TS.utility.calls.getParentWindow()}}else{return window}}else{if(window.winssb&&!(window.parentInfo||window.parentBrowserWindowId)){TS.utility.calls_log.log("WinSSB: Trying to get parent window before browser window ID is initialized");return}else if(window.opener){return window.opener}}},promiseToGetRegions:function(){if(_region_p)return _region_p;var regions;_region_p=new Promise(function(resolve,reject){$.ajax({type:"GET",url:"https://region.slack-core.com/region.json",async:true,cache:false,timeout:2e3,success:function(json){TS.utility.calls_log.logEvent({event:"Regions",value:json.region_text});regions=json.region_text;if(TS.boot_data.version_ts==="dev")regions="dev";resolve(regions)},error:function(XMLHttpRequest,textStatus,errorThrown){TS.utility.calls_log.logEventError({event:"GetRegionsErr",value:{status:textStatus,error:errorThrown}});regions="west|east|ap|eu";if(TS.boot_data.version_ts==="dev")regions="dev";resolve(regions)}})});return _region_p},promiseToGetServer:function(regions,id){if(_server_p[id])return _server_p[id];var method;var args={regions:regions,protocol:"1.0"};if(id.charAt(0)=="R"){method="screenhero.rooms.join";args.room=id}else{method="screenhero.rooms.create";args.channel=id}_server_p[id]=TS.api.callImmediately(method,args);return _server_p[id]},clearServerPromise:function(id){delete _server_p[id]},isSupportedMessage:function(type){var calls_supported_message_types=["user_change","pref_change","team_join","channel_created","channel_deleted","channel_archive","channel_unarchive","channel_rename","channel_joined","channel_left","group_deleted","group_archive","group_unarchive","group_rename","group_joined","group_left","im_open","mpim_joined","mpim_open","mpim_close"];if(!TS.boot_data.feature_calls_no_rtm_start){calls_supported_message_types.push("presence_change");calls_supported_message_types.push("manual_presence_change")}return calls_supported_message_types.indexOf(type)!==-1},getPlatformErrorMessage:function(){if(TS.model.is_our_app){if(TS.model.lin_ssb_version){return"Unfortunately, the calls feature is not available on Linux."}else if(window.winssb){return"To use the calls feature, please upgrade to the latest version of Slack for Windows."}else{return"To use the calls feature, please upgrade to the latest version of the Mac app for Slack."}}else if(bowser.mobile&&bowser.ios){return"Please update your Slack iOS app to the newest version."}else if(bowser.mobile){return"Unfortunately, the calls feature is not available on mobile browsers."}else{return"Unfortunately, the calls feature is not available in this browser. Please switch to Chrome."}},getPlatformErrorTitle:function(){if(TS.model.is_our_app){if(TS.model.lin_ssb_version){return"Calls feature is not available on Linux"}else if(window.winssb){return"Please update your Slack for Windows"}else{return"Please update your Slack for Mac"}}else if(bowser.mobile){return"Calls feature is not available on mobile browsers"}else{return"Calls feature is not available in this browser"}},platformHasCallsCode:function(){if(TS.model.is_our_app){if(TS.model.mac_ssb_version=="1.1"&&TS.model.mac_ssb_version_minor<8||parseFloat(TS.model.mac_ssb_version)<2){return false}if(TS.model.win_ssb_version=="1.2"&&TS.model.win_ssb_version_minor<5||parseFloat(TS.model.win_ssb_version)<1.2){return false}}return true},getUrlForRoom:function(room){return TS.utility.calls.getUrlForRoomId(room.id)},getUrlForRoomId:function(room_id){return TS.utility.calls.share_url_prefix+room_id},dbg:{getState:function(){return{config:_utility_calls_config,state:_utility_call_state}},isCallWindowBusy:function(){_isCallWindowBusy().then(function(is_busy){TS.info("_isCallWindowBusy: "+is_busy)})},isIncomingCallWindowBusy:function(){_isInIncomingCall().then(function(is_in_incoming_call){TS.info("_isInIncomingCall: "+is_in_incoming_call)})}}});var _region_p;var _server_p={};var _utility_calls_config={call_window_dims:{width:750,height:600,min_width:600,min_height:500},mini_panel_dims:{width:280,height:64,x_offset:50,y_offset:50},incoming_call_window_dims:{width:240,height:373},log_events:{previous_crash:"PreviousCrash",incoming_call:"IncomingCall",invite_response_from_callee:"InviteResponseFromCallee",ms_connected:"MSConnected",ms_disconnected:"MSDisconnected",reachability_changed:"ReachabilityChanged",window_closed:"WindowClosed",window_crashed:"WindowCrashed",call_window_load_timeout:"CallWindowLoadTimeout",call_window_load_start:"CallWindowLoadStart",incoming_call_timeout:"IncomingCallTimeout",send_msg_no_call_window:"SendMsgNoCallWindow",send_msg_no_mini_panel:"SendMsgNoMiniPanel",call_window_loaded:"CallWindowLoaded",call_window_busy:"CallWindowBusy",invalid_msg_from_child_window:"InvalidMsgFromChildWindow",call_window_pong:"CallWindowPong",unknown_msg_from_call_window:"UnknownMsgFromCallWindow",incoming_call_click:"IncomingCallClick",unknown_msg_from_incoming_call_window:"UnknownMsgFromIncomingCallWindow",mini_panel_click:"MiniPanelClick",unknown_msg_from_mini_panel:"UnknownMsgFromMiniPanel",call_object_click_in_incoming_call:"CallObjectClickInIncomingCall",invite_response_send:"InviteResponseSend",close_incoming_call:"CloseIncomingCall",no_mini_panel_in_update:"NoMiniPanelInUpdate",start_call:"StartCall",join_call:"JoinCall"},CALL_WINDOW_LOAD_TIMEOUT_MSECS:30*1e3,INCOMING_RING_TIMEOUT_MSECS:29*1e3};var _utility_call_state={};var _handleCallsRequestError=function(res){var ephemeral_msg={text:res.data.response||"Darn, that didn't work. Try your call again or <http://my.slack.com/help.requests/new|contact us> if it's still not working.",ephemeral_type:res.data.error||"uncaught_third_party_call_error",slackbot_feels:"sad_surprise"};TS.client.ui.addEphemeralBotMsg(ephemeral_msg)};var _sigMsgReceived=function(imsg){if(!_utility_call_state.in_slack_app)return;TS.utility.calls_log.log("Received msg type: ",imsg.type);switch(imsg.type){case"screenhero_invite":TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.incoming_call,value:imsg});Promise.join(_isCallWindowBusy(),_isInIncomingCall(),function(call_window_busy,incoming_call_window_busy){_handleIncomingCall(call_window_busy,incoming_call_window_busy,imsg);return null});break;case"screenhero_invite_cancel":TS.utility.calls.closeIncomingCallWindow();_isCallWindowBusy().then(function(is_busy){if(is_busy){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.invite_cancel,cancel_type:imsg.cancel_type,user_id:imsg.responder,room_id:imsg.room})}else{_utility_call_state.cached_invite_cancel={cancel_type:imsg.cancel_type,user_id:imsg.responder,room_id:imsg.room}}});break;case"screenhero_invite_response":TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.invite_response_from_callee,value:imsg});_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.invite_response,response_type:imsg.response,user_id:imsg.responder,room_id:imsg.room});TS.api.callImmediately("screenhero.rooms.inviteCancel",{responder:imsg.responder,room:imsg.room,cancel_type:TS.utility.calls.invite_cancel_types.cleanup},function(ok,data,args){});break;case"sh_room_join":TS.utility.calls_log.log("sh_room_join msg: ",imsg);break;default:if(TS.utility.calls.isSupportedMessage(imsg.type)){if(!TS.model.is_our_app){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.ms_msg,msg:imsg})}}break}};var _sigMSConnected=function(){var skip_analytics=true;var is_call_window_ready_prev=TS.utility.calls.isCallWindowReady();TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.ms_connected},skip_analytics);_utility_call_state.is_ms_connected=true;_updateCallIcon(is_call_window_ready_prev);_notifyReachability()};var _sigMSDisconnected=function(){var skip_analytics=true;var is_call_window_ready_prev=TS.utility.calls.isCallWindowReady();TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.ms_disconnected},skip_analytics);_utility_call_state.is_ms_connected=false;_updateCallIcon(is_call_window_ready_prev);_notifyReachability()};var _sigReachabilityChanged=function(){var is_call_window_ready_prev=TS.utility.calls.isCallWindowReady();TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.reachability_changed,value:{from:_utility_call_state.is_reachability_online,to:window.navigator.onLine}});_utility_call_state.is_reachability_online=window.navigator.onLine;_updateCallIcon(is_call_window_ready_prev);_notifyReachability()};var _sigTeamsDidLoad=function(){_utility_call_state.teams_loaded=true};var _sigDidLogin=function(){_utility_call_state.did_login=true};var _sigWindowFinishedLoading=function(token,doc){switch(token){case _utility_call_state.incoming_call_token:TSSSB.call("centerWindow",token);TSSSB.call("showWindow",token);_setupIncomingCall();break;case _utility_call_state.mini_panel_token:if(window.winssb&&winssb.window&&winssb.window.browserWindows&&winssb.window.browserWindows[token]&&winssb.window.browserWindows[token].setMinimumSize){winssb.window.browserWindows[token].setMinimumSize(_utility_calls_config.mini_panel_dims.width,_utility_calls_config.mini_panel_dims.height);winssb.window.browserWindows[token].setSize(_utility_calls_config.mini_panel_dims.width,_utility_calls_config.mini_panel_dims.height)}break}};var _sigWindowClosed=function(token){var skip_analytics=true;TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.window_closed,value:{token:token,cw_token:_utility_call_state.call_window_token,mp_token:_utility_call_state.mini_panel_token,ic_token:_utility_call_state.incoming_call_token}},skip_analytics);switch(token){case _utility_call_state.call_window_token:_utility_call_state.last_call_window_token=_utility_call_state.call_window_token;_notifySSBsCallWindowAvailable();if(_utility_call_state.call_window_token)delete _utility_call_state.call_window_token;_closeMiniPanel();break;case _utility_call_state.mini_panel_token:if(_utility_call_state.mini_panel_token)delete _utility_call_state.mini_panel_token;break}};var _sigWindowCrashed=function(token){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.window_crashed,value:{token:token,cw_token:_utility_call_state.call_window_token,mp_token:_utility_call_state.mini_panel_token,ic_token:_utility_call_state.incoming_call_token}});if(token!==_utility_call_state.last_call_window_token&&token!==_utility_call_state.call_window_token)return;_callWindowGoingAway();_notifySSBsCallWindowAvailable();delete _utility_call_state.call_window_token;TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.previous_crash});_closeMiniPanel()};var _sigWindowBecameKey=function(token){if(token!==_utility_call_state.call_window_token)return;TSSSB.call("hideWindow",_utility_call_state.mini_panel_token)};var _sigWindowResignedKey=function(token){if(token!==_utility_call_state.call_window_token)return;_isCallWindowBusy().then(function(is_busy){if(is_busy){TSSSB.call("showWindowInactive",_utility_call_state.mini_panel_token)}})};var _sigClientWindowUnloaded=function(){TS.utility.calls_log.log("client window unloaded!");_forceCloseWindow()};var _showModalForUnsupportedCalls=function(){TS.generic_dialog.start({title:TS.utility.calls.getPlatformErrorTitle(),body:TS.utility.calls.getPlatformErrorMessage(),show_cancel_button:true,go_button_text:"Update Slack App",onGo:function(){var target="_"+Math.random();TS.utility.openInNewTab("https://slack.com/downloads",target)}})};var _areTransparentWindowsSupported=function(){return _.get(window,"winssb.app.areTransparentWindowsSupported",true)};var _startCallWindow=function(url){var args;if(!TS.utility.calls.isEnabled())return;if(!TS.utility.calls.platformHasCallsCode())return;if(TS.model.is_our_app&&_utility_call_state.call_window_token){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.start_call,args:{url:url}});_openMiniPanel();TSSSB.call("focusWindow",_utility_call_state.call_window_token);return}args={url:url||_utility_call_state.calls_url_prefix,title:"",background:true,width:_utility_calls_config.call_window_dims.width,height:_utility_calls_config.call_window_dims.height,minWidth:_utility_calls_config.call_window_dims.min_width,minHeight:_utility_calls_config.call_window_dims.min_height,hideMenuBar:true,windowType:"calls",show:true,no_spinner:true,hides_on_close:false};if(TS.model.is_our_app){if(TS.model.is_mac)args["titleBarStyle"]="hidden"}if(window.winssb){var display=TSSSB.call("getAppDisplay");args.x=display.bounds.x+(display.bounds.width-_utility_calls_config.call_window_dims.width)/2;args.y=display.bounds.y+(display.bounds.height-_utility_calls_config.call_window_dims.height)/2}_utility_call_state.call_window_token=TS.client.windows.openWindow(args);TS.utility.calls_log.log("_startCallWindow: returned token: ",_utility_call_state.call_window_token);_openMiniPanel()};var _closeCallWindow=function(){if(!_utility_call_state.call_window_token)return;_callWindowGoingAway();var call_window_token=_utility_call_state.call_window_token;delete _utility_call_state.call_window_token;TSSSB.call("closeWindow",call_window_token)};var _openMiniPanel=function(){if(!window.winssb||_utility_call_state.mini_panel_token)return;var display=TSSSB.call("getDisplayForWindow",_utility_call_state.call_window_token);var win_args={x:display.bounds.x+(display.bounds.width-_utility_calls_config.mini_panel_dims.x_offset-_utility_calls_config.mini_panel_dims.width),y:display.bounds.y+_utility_calls_config.mini_panel_dims.y_offset,width:_utility_calls_config.mini_panel_dims.width,height:_utility_calls_config.mini_panel_dims.height,minHeight:_utility_calls_config.mini_panel_dims.height,hideMenuBar:true,resizable:false,alwaysOnTop:true,frame:false,windowType:"calls_mini_panel",show:false,useContentSize:true,skip_css:true,fullscreenable:false};if(TS.model.is_mac&&_areTransparentWindowsSupported()){win_args.transparent=true}win_args.content_html=TS.templates.calls_minipanel({no_border:!TS.model.is_mac,js_urls:TS.boot_data.electron_window_injection_urls?TS.boot_data.electron_window_injection_urls.calls_mini_panel.js:[],css_urls:TS.boot_data.electron_window_injection_urls?TS.boot_data.electron_window_injection_urls.calls_mini_panel.css:[]});_utility_call_state.mini_panel_token=TS.client.windows.openWindow(win_args);TSSSB.call("showWindowInactive",_utility_call_state.mini_panel_token);TSSSB.call("hideWindow",_utility_call_state.mini_panel_token)};var _closeMiniPanel=function(){if(!_utility_call_state.mini_panel_token)return;var mini_panel_token=_utility_call_state.mini_panel_token;delete _utility_call_state.mini_panel_token;TSSSB.call("closeWindow",mini_panel_token)};var _forceCloseWindow=function(){if(_utility_call_state.mini_panel_token){TSSSB.call("closeWindow",_utility_call_state.mini_panel_token);delete _utility_call_state.mini_panel_token}if(_utility_call_state.call_window_token){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.did_close_window});_callWindowGoingAway();TSSSB.call("closeWindow",_utility_call_state.call_window_token);_notifySSBsCallWindowAvailable();delete _utility_call_state.call_window_token}if(_utility_call_state.window_handle){_utility_call_state.window_handle.close();delete _utility_call_state.window_handle}};var _callWindowGoingAway=function(){_setCallWindowLoaded(false);_setCallWindowBusy(false)};var _handleIncomingCall=function(call_window_busy,incoming_call_window_busy,imsg){if(!TS.utility.calls.isEnabled())return;var is_relevant=TS.shared.isRelevantTeam();if(!is_relevant)return;if(call_window_busy||incoming_call_window_busy){TS.utility.calls.sendInvitationResponseToCaller({user_id:imsg.caller,room_id:imsg.room,response:TS.utility.calls.invite_response_types.on_call});return}if(TS.members.isMemberInDnd(TS.model.user)){TS.utility.calls.sendInvitationResponseToCaller({user_id:imsg.caller,room_id:imsg.room,response:TS.utility.calls.invite_response_types.dnd});return}var caller=TS.members.getMemberById(imsg.caller);var caller_p=Promise.resolve(caller);if(!caller){caller_p=TS.api.call("users.info",{user:imsg.caller}).then(function(response){TS.members.upsertMember(response.data.user);caller=TS.members.getMemberById(imsg.caller)})}caller_p.then(function(){var caller_name=TS.members.getMemberDisplayName(caller);if(TS.model.is_our_app){if(window.winssb){var win_args={width:_utility_calls_config.incoming_call_window_dims.width,height:_utility_calls_config.incoming_call_window_dims.height,hideMenuBar:true,resizable:false,alwaysOnTop:true,frame:false,windowType:"calls_incoming_call",show:false,skip_css:true,fullscreenable:false};if(TS.model.is_mac&&_areTransparentWindowsSupported()){win_args.transparent=true}var incoming_call_div=TS.templates.calls_incoming_call({caller:caller,name:caller_name,is_video_call:TS.model.supports_video_calls&&imsg.cameras_on>0,team:TS.model.team.name});win_args.content_html=TS.templates.calls_incoming_call_window({incoming_call_div:incoming_call_div,room_id:imsg.room,user_id:imsg.caller,no_border:!TS.model.is_mac,css_urls:TS.boot_data.electron_window_injection_urls?TS.boot_data.electron_window_injection_urls.calls_incoming_call.css:[]});_utility_call_state.incoming_call_token=TS.client.windows.openWindow(win_args)}else if(window.macgap){TSSSB.call("incomingCall",{room_id:imsg.room,name:caller_name,user_id:imsg.caller,avatar_img_src:caller.profile.image_192});_setupIncomingCall()}}else{TS.incoming_call.start({caller:caller,name:caller_name,is_video_call:TS.model.supports_video_calls&&imsg.cameras_on>0,onAccept:function(did_choose_video){TS.utility.calls.sendInvitationResponseToCaller({user_id:imsg.caller,room_id:imsg.room,response:TS.utility.calls.invite_response_types.accept,did_choose_video:did_choose_video})},onReject:function(){TS.utility.calls.sendInvitationResponseToCaller({user_id:imsg.caller,room_id:imsg.room,response:TS.utility.calls.invite_response_types.reject})},onTimeout:function(){},onShow:function(){_setupIncomingCall()},onEnd:function(){_teardownIncomingCall()}})}})};var _setupIncomingCall=function(){TS.sounds.play("call/incoming_ring_"+TS.boot_data.call_sounds_version+".mp3",{should_loop:true,ignore_mute:true});_utility_call_state.incoming_ring_timer=setTimeout(function(){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.incoming_call_timeout});TS.utility.calls.closeIncomingCallWindow()},_utility_calls_config.INCOMING_RING_TIMEOUT_MSECS);_utility_call_state.in_incoming_call=true;_notifySSBsIncomingCallWindowBusy()};var _teardownIncomingCall=function(){TS.sounds.stop("call/incoming_ring_"+TS.boot_data.call_sounds_version+".mp3",{ignore_mute:true});if(_utility_call_state.incoming_ring_timer){clearTimeout(_utility_call_state.incoming_ring_timer);delete _utility_call_state.incoming_ring_timer}delete _utility_call_state.in_incoming_call;_notifySSBsIncomingCallWindowAvailable()};var _isInIncomingCall=function(){if(!TS.model.is_our_app||!TSSSB.call("supportsIncomingCallWindowStatus")){return Promise.resolve(!!_utility_call_state.in_incoming_call)}else{return TSSSB.call("isIncomingCallWindowBusy")}};var _sendMessageToCallWindow=function(args){if(TS.model.is_our_app){var window_token=_utility_call_state.call_window_token;if(!window_token){TS.utility.calls_log.logEventWarn({event:_utility_calls_config.log_events.send_msg_no_call_window,value:args});return}if(window.macgap){var win=TS.client.windows.getWinByToken(window_token);if(win&&win.window){win.window.postMessage(args,"*")}}else if(window.winssb&&window.winssb.window){window.winssb.window.postMessage(args,window_token)}}else{if(_utility_call_state.window_handle)_utility_call_state.window_handle.postMessage(args,"*")}};var _sendMessageToMiniPanel=function(args){if(!_utility_call_state.mini_panel_token){TS.utility.calls_log.logEventWarn({event:_utility_calls_config.log_events.send_msg_no_mini_panel,value:args});return}if(window.winssb&&window.winssb.window){window.winssb.window.postMessage(args,_utility_call_state.mini_panel_token)}};var _notifyReachability=function(){if(!_utility_call_state.call_window_loaded)return;_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.reachability,online:_utility_call_state.is_reachability_online&&_utility_call_state.is_ms_connected})};var _setCallWindowLoaded=function(is_loaded){var skip_analytics=true;var is_call_window_ready_prev=TS.utility.calls.isCallWindowReady();TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.call_window_loaded,value:{is_loaded:is_loaded}},skip_analytics);_utility_call_state.call_window_loaded=is_loaded;_updateCallIcon(is_call_window_ready_prev);_notifyReachability()};var _setCallWindowBusy=function(is_busy){var skip_analytics=true;TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.call_window_busy,value:{is_busy:is_busy}},skip_analytics);_utility_call_state.is_call_window_busy=is_busy;if(is_busy){_notifySSBsCallWindowBusy();if(_utility_call_state.accepted_caller_id){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.caller_id,args:{caller_id:_utility_call_state.accepted_caller_id}})}if(_utility_call_state.cached_invite_cancel){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.invite_cancel,cancel_type:_utility_call_state.cached_invite_cancel.cancel_type,user_id:_utility_call_state.cached_invite_cancel.user_id,room_id:_utility_call_state.cached_invite_cancel.room_id})}}else{_notifySSBsCallWindowAvailable()}if(_utility_call_state.accepted_caller_id)delete _utility_call_state.accepted_caller_id;if(_utility_call_state.cached_invite_cancel)delete _utility_call_state.cached_invite_cancel};var _isCallWindowBusy=function(){if(!TS.model.is_our_app||!TSSSB.call("supportsCallWindowStatus")){return Promise.resolve(!!_utility_call_state.is_call_window_busy)}else{return TSSSB.call("isCallWindowBusy")}};var _startCall=function(url,name,options){options=options||{};url+="?_fast_members=1&_end_call_sound=1"+(options.start_with_video?"&_start_with_video=1":"");if(TS.pri){url+="&pri="+TS.pri}if(TS.qs_args._calls_halt_at_loading_screen){url+="&_calls_halt_at_loading_screen=1"}TS.utility.calls.promiseToGetRegions().then(function(regions){TS.utility.calls.promiseToGetServer(regions,name).catch(_.noop)});if(TS.model.is_our_app){_startCallWindow(url)}else{_utility_call_state.window_handle=window.open(url,name)}};var _joinVideoCall=function(room_id,start_with_video){if(!TS.model.supports_voice_calls&&!TS.utility.calls.platformHasCallsCode()){_showModalForUnsupportedCalls();return}if(!TS.utility.calls.isCallWindowReady())return;_isCallWindowBusy().then(function(is_busy){if(is_busy){_handleAlreadyInCall();return}TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.join_call,value:{room_id:room_id,start_with_video:start_with_video}});_startCall(_utility_call_state.calls_url_prefix+room_id,room_id,{start_with_video:start_with_video})})};var _showModalForAlreadyInCall=function(team_name){TS.generic_dialog.start({title:"You're already in a call on another team"+(team_name?" ("+team_name+")":""),body:'<p class="no_bottom_margin">You can only be in one call at a time. Please end that call and try again.',
go_button_text:"OK",show_cancel_button:false})};var _handleAlreadyInCall=function(){TS.utility.calls_log.log("_handleAlreadyInCall");if(!TS.model.is_our_app){_utility_call_state.window_handle.focus();return}if(!TSSSB.call("supportsCallWindowStatus")){TSSSB.call("focusWindow",_utility_call_state.call_window_token);return}TSSSB.call("getCallWindowTeamId",{cb:function(team_id){if(team_id===TS.model.team.id){TSSSB.call("focusWindow",_utility_call_state.call_window_token)}else{TSSSB.call("getCallWindowTeamName",{cb:function(team_name){_showModalForAlreadyInCall(team_name)}})}}})};var _updateCallIcon=function(is_call_window_ready_prev){if(TS.utility.calls.platformHasCallsCode()){TS.client.msg_pane.setCallButtonState(TS.utility.calls.isCallWindowReady())}else{TS.client.msg_pane.setCallButtonState(true)}};var _updateMiniPanelState=function(mini_panel_state){if(!_utility_call_state.mini_panel_token){TS.utility.calls_log.logEventWarn({event:_utility_calls_config.log_events.no_mini_panel_in_update});return}_sendMessageToMiniPanel({message_type:TS.utility.calls.messages_to_mini_panel_types.update_state,mini_panel_state:mini_panel_state})};var _notifySSBsCallWindowBusy=function(){if(!TS.model.is_our_app)return;TSSSB.call("setCallWindowBusy",{is_busy:true});TSSSB.call("setCallWindowToken",{token:_utility_call_state.call_window_token});TSSSB.call("setCallWindowTeamId",{team_id:TS.model.team.id});TSSSB.call("setCallWindowTeamName",{team_name:TS.model.team.name})};var _notifySSBsCallWindowAvailable=function(){if(!TS.model.is_our_app)return;if(!TSSSB.call("supportsCallWindowStatus"))return;var call_window_token=String(_utility_call_state.call_window_token);TSSSB.call("getCallWindowToken",{cb:function(token){if(token!==call_window_token)return;TSSSB.call("setCallWindowBusy",{is_busy:false});TSSSB.call("clearCallWindowToken");TSSSB.call("clearCallWindowTeamId");TSSSB.call("clearCallWindowTeamName")}})};var _notifySSBsIncomingCallWindowBusy=function(){if(!TS.model.is_our_app)return;if(!TSSSB.call("supportsIncomingCallWindowStatus"))return;TSSSB.call("setIncomingCallWindowBusy",{is_busy:true});if(_utility_call_state.incoming_call_token){TSSSB.call("setIncomingCallWindowToken",{token:_utility_call_state.incoming_call_token})}TSSSB.call("setIncomingCallWindowTeamId",{team_id:TS.model.team.id});TSSSB.call("setIncomingCallWindowTeamName",{team_name:TS.model.team.name})};var _notifySSBsIncomingCallWindowAvailable=function(){var _clearIncomingCallWindowData=function(){TSSSB.call("setIncomingCallWindowBusy",{is_busy:false});TSSSB.call("clearIncomingCallWindowToken");TSSSB.call("clearIncomingCallWindowTeamId");TSSSB.call("clearIncomingCallWindowTeamName")};if(!TS.model.is_our_app)return;if(!_utility_call_state.incoming_call_token){_clearIncomingCallWindowData();return}var incoming_call_window_token=String(_utility_call_state.incoming_call_token);TSSSB.call("getIncomingCallWindowToken",{cb:function(token){if(token!==incoming_call_window_token)return;_clearIncomingCallWindowData()}})};var _forceJanusDisconnect=function(server,session_id,token,transaction_id){$.ajax({timeout:2e3,type:"POST",url:server+"/"+session_id,async:true,cache:false,contentType:"application/json",headers:{Authorization:"Basic "+btoa(":"+token)},data:JSON.stringify({janus:"destroy",transaction:transaction_id}),dataType:"json"})};var _receivePostedMessageFromChildWindow=function(evt){if(!evt||!evt.data||!evt.data.message_type){TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.invalid_msg_from_child_window,value:evt});return}if(evt.data.origin_window_type===TS.utility.calls.window_types.call_window){switch(event.data.message_type){case TS.utility.calls.messages_from_call_window_types.update_mini_panel:_updateMiniPanelState(evt.data.mini_panel_state);if(evt.data.mini_panel_state.hidden)TSSSB.call("hideWindow",_utility_call_state.mini_panel_token);break;case TS.utility.calls.messages_from_call_window_types.set_call_window_loaded:_setCallWindowLoaded(evt.data.is_loaded);_notifyReachability();break;case TS.utility.calls.messages_from_call_window_types.set_call_window_busy:_setCallWindowBusy(evt.data.is_busy);break;case TS.utility.calls.messages_from_call_window_types.show_growl_notification:TS.ui.growls.show(evt.data.title,evt.data.txt,null,{subtitle:evt.data.subtitle,sound_name:"none",channelId:evt.data.channel});break;case TS.utility.calls.messages_from_call_window_types.pong:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.call_window_pong});break;case TS.utility.calls.messages_from_call_window_types.close:_closeCallWindow();_closeMiniPanel();break;case TS.utility.calls.messages_from_call_window_types.get_calls_status:_isCallWindowBusy().then(function(is_busy){TSSSB.call("getCallWindowTeamName",{cb:function(team_name){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.calls_status,is_busy:is_busy,team_name:team_name})}})});break;case TS.utility.calls.messages_from_call_window_types.force_janus_disconnect:_forceJanusDisconnect(event.data.server,event.data.session_id,event.data.token,event.data.transaction_id);break;case TS.utility.calls.messages_from_call_window_types.get_regions:TS.utility.calls.promiseToGetRegions().then(function(regions){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.regions,regions:regions})});break;case TS.utility.calls.messages_from_call_window_types.get_server:var call_id=event.data.id;var call_regions=event.data.regions;TS.utility.calls.promiseToGetServer(call_regions,call_id).then(function(response){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.got_server,data:response.data});TS.utility.calls.clearServerPromise(call_id)}).catch(function(error){TS.utility.calls.clearServerPromise(call_id);_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.got_server_error,error:error.data.error})});break;case TS.utility.calls.messages_from_call_window_types.get_member_data:_sendMessageToCallWindow({reply_to:event.data.message_id,message_type:event.data.message_type,message:{user_id:evt.data.user_id,member:TS.members.getMemberById(evt.data.user_id)}});break;case TS.utility.calls.messages_from_call_window_types.play_sound:TS.sounds.play("call/"+event.data.sound+"_"+TS.boot_data.call_sounds_version+".mp3");break;default:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.unknown_msg_from_call_window,value:evt});break}}else if(evt.data.origin_window_type===TS.utility.calls.window_types.incoming_call){switch(evt.data.message_type){case TS.utility.calls.messages_from_incoming_call_types.user_clicked_accept_or_reject:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.incoming_call_click,value:event.data});TS.utility.calls.sendInvitationResponseToCaller({user_id:evt.data.user_id,room_id:evt.data.room_id,response:evt.data.did_accept?TS.utility.calls.invite_response_types.accept:TS.utility.calls.invite_response_types.reject,did_choose_video:evt.data.did_choose_video});var skip_teardown=true;TS.utility.calls.closeIncomingCallWindow(skip_teardown);break;default:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.unknown_msg_from_incoming_call_window,value:evt});break}}else if(evt.data.origin_window_type===TS.utility.calls.window_types.mini_panel){switch(evt.data.message_type){case TS.utility.calls.messages_from_mini_panel_types.user_clicked_action:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.mini_panel_click,value:event.data});if(evt.data.action==="mute"||evt.data.action==="leave"||evt.data.action==="stop_screenshare"){_sendMessageToCallWindow({message_type:TS.utility.calls.messages_to_call_window_types.mini_panel_action,action:evt.data.action})}else if(evt.data.action==="activate"){TSSSB.call("showWindow",_utility_call_state.call_window_token)}break;default:TS.utility.calls_log.logEvent({event:_utility_calls_config.log_events.unknown_msg_from_mini_panel,value:evt});break}}}})();(function(){"use strict";TS.registerModule("utility.contenteditable",{create:function(input,options){if(!options)options={};input=_normalizeInput(input);if(!input)return;if(_isFormElement(input))return;if(_getTextyInstance(input))return;var texty=new Texty(input,options);_setTextyInstance(input,texty)},isActiveElement:function(input){input=_normalizeInput(input);if(!input)return false;if(_isFormElement(input)){return document.activeElement===input}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);return texty.hasFocus()}return false},focus:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){input.focus()}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.focus()}},blur:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){input.blur()}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.blur()}},isContenteditable:function(input){input=_normalizeInput(input);return _isTextyElement(input)},disable:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){input.disabled=true}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.disable()}},isDisabled:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){return input.disabled===true}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);return texty.isDisabled()}return false},enable:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){input.disabled=false}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.enable()}},isEnabled:function(input){input=_normalizeInput(input);if(!input)return false;if(_isFormElement(input)){return input.disabled!==true}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);return texty.isEnabled()}return false},value:function(input,value){input=_normalizeInput(input);if(!input)return"";if(_isFormElement(input)){if(_.isString(value))input.value=value;return input.value}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);if(_.isString(value))texty.setText(value);return texty.getFormattedContents()}return""},displayValue:function(input){input=_normalizeInput(input);if(!input)return"";if(_isFormElement(input)){return input.value}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);return texty.getText()}return""},clear:function(input){input=_normalizeInput(input);if(!input)return;if(_isFormElement(input)){input.value=""}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.clear()}},placeholder:function(input,value){input=_normalizeInput(input);if(!input)return"";var next_value;if(_isFormElement(input)){if(_.isString(value)){if(value===""){input.removeAttribute("placeholder")}else{input.setAttribute("placeholder",value)}}next_value=input.getAttribute("placeholder")}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);if(_.isString(value))texty.setPlaceholder(value);next_value=texty.getPlaceholder()}return next_value||""},cursorPosition:function(input,start,length){var pos={start:0,end:0,length:0};input=_normalizeInput(input);if(!input)return pos;if(_.isNumber(start)){if(!length)length=0;pos.start=start;pos.end=start+length;pos.length=length;if(_isFormElement(input)){TS.selection.selectCharacters(input,pos.start,pos.end)}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);texty.setSelection({index:pos.start,length:pos.length})}}else{if(!TS.utility.contenteditable.isActiveElement(input)){var prev_pos=$(input).data("utility-contenteditable-cursor-position");if(_.isObject(prev_pos))return prev_pos}if(_isFormElement(input)){input.focus();pos.start=input.selectionStart;pos.end=input.selectionEnd;pos.length=Math.abs(input.selectionEnd-input.selectionStart)}else if(_isTextyElement(input)){var texty=_getTextyInstance(input);var range=texty.getSelection();if(range){pos.start=range.index;pos.length=range.length;pos.end=pos.start+pos.length}}}return pos},test:function(){var test={_normalizeInput:_normalizeInput,_isFormElement:_isFormElement};return test}});var _normalizeInput=function(input){if(!input)return false;if(input instanceof jQuery&&input[0])input=input[0];if(input.nodeType!==Node.ELEMENT_NODE)return false;if(!TS.boot_data.feature_texty)return input;if(input.tagName.toLowerCase()==="textarea")return input;if(input.tagName.toLowerCase()==="input")return input;if(input.hasAttribute("contenteditable"))return input;if(TS.boot_data.feature_texty&&input.tagName==="DIV")return input;return false};var _isFormElement=function(input){if(!input)return false;if(!TS.boot_data.feature_texty)return true;if(input.tagName.toLowerCase()==="textarea")return true;if(input.tagName.toLowerCase()==="input")return true;return false};var _isTextyElement=function(input){if(!input)return false;if(!TS.boot_data.feature_texty)return false;var texty=_getTextyInstance(input);if(texty)return true;return false};var _getTextyInstance=function(input){return $(input).data("__ts_quill")};var _setTextyInstance=function(input,instance){$(input).data("__ts_quill",instance)}})();(function(){"use strict";TS.registerModule("utility.attachments",{hasContent:function(attachment,excluded_props){if(!attachment)return false;if(!_.isArray(excluded_props))excluded_props=[].concat(excluded_props);var props=_.difference(_CONTENT_PROPS,excluded_props);return _.some(props,function(prop){return!_.isEmpty(attachment[prop])})},getMediaSource:function(attachment){if(!attachment)return;var media_type=TS.utility.attachments.getMediaType(attachment);switch(media_type){case"video":return attachment.thumb_url;case"audio":return attachment.audio_html||attachment.audio_url;case"other":return attachment.other_html;case"image":return attachment.image_url}return attachment.from_url},getMediaType:function(attachment){if(!attachment)return;if(attachment.video_html)return"video";if(attachment.audio_html||attachment.audio_url)return"audio";if(attachment.other_html)return"other";if(attachment.image_url)return"image"},getDecoratedAttachment:function(original_attachment,msg){var attachment=_.cloneDeep(original_attachment);attachment._source=_getSource(attachment);if(_isSlackMessageUnfurl(attachment)){attachment=_decorateForSlackMessage(attachment,msg)}else if(attachment.service_name==="twitter"){attachment=_decorateForTweet(attachment)}else if(attachment.service_name==="salesforce"){attachment=_decorateForSalesforce(attachment)}if(attachment.from_url&&TS.model.prefs.attachments_with_borders){attachment=_removeDuplicativeLinks(attachment)}if(attachment._source.icon)attachment._source.icon=_getProxiedIcon(attachment._source.icon);if(attachment.footer_icon)attachment.footer_icon=_getProxiedIcon(attachment.footer_icon);return attachment},getMediaCaretLocation:function(attachment){var location=_.find(_POSSIBLE_CARET_LOCATIONS,function(prop){return _.some(attachment[prop])});return location||"end"},formatMessageAttachmentPart:function(text,msg,do_highlighting,do_specials,enable_slack_action_links){var formatted_msg=TS.format.formatWithOptions(text,msg,{no_highlights:do_highlighting!==true,no_specials:do_specials!==true,enable_slack_action_links:enable_slack_action_links===true});formatted_msg=TS.utility.msgs.handleSearchHighlights(formatted_msg);return formatted_msg},findAttachment:function(args){if(!args)return;var message=TS.utility.msgs.findMsg(args.message_ts,args.channel_id);if(!message)return;return _.find(message.attachments,{id:args.attachment_id})},test:function(){return{_isSlackMessageUnfurl:_isSlackMessageUnfurl}}});var _CONTENT_PROPS=["title","text","pretext","video_html","audio_html","audio_url","other_html","from_url","fields","actions","image_url","thumb_url","author_name","service_name","footer","footer_icon","ts"];var _POSSIBLE_CARET_LOCATIONS=["ts","footer","fields","text","title","_source"];var _ATTACHMENT_LINKS=["_source.link","_source.author_link","thumb_link","title_link","image_link"];var _getSource=function(attachment){var source={};source.icon=attachment.service_icon||attachment.author_icon;source.name=attachment.service_name||attachment.author_name;source.link=attachment.service_url||attachment.author_link;source.author_name=attachment.author_name==source.name?attachment.author_subname:attachment.author_name;source.author_link=attachment.author_link;return source};var _isSlackMessageUnfurl=function(attachment){if(attachment.is_msg_unfurl)return true;if(attachment.from_url&&/slack\.com\/archives\/.+\/p.+/.test(attachment.from_url)){attachment.is_msg_unfurl=true;return true}};var _decorateForSlackMessage=function(attachment,msg){if(attachment.author_link){var slack_author_id=TS.utility.getMemberIdFromURL(attachment.author_link);if(slack_author_id)attachment._slack_author_id=slack_author_id}if(msg&&msg.subtype=="pinned_item"){attachment.from_url=TS.utility.msgs.constructAbsoluteMsgPermalink(TS.shared.getActiveModelOb(),attachment.ts)}attachment.color=null;_.set(attachment,"mrkdwn_in_hash.text",true);var probably_real_name=attachment.author_name;var probably_username=attachment.author_subname;if(TS.members.shouldDisplayRealNames()||TS.boot_data.feature_name_tagging_client){attachment._source.name=probably_real_name||probably_username}else{attachment._source.name=probably_username||probably_real_name}attachment._source.author_name=null;attachment._source.author_link=null;attachment._unfurl_type_message=true;if(!attachment.footer){var footer_text=_getSlackMessageFooterText(attachment.from_url);if(footer_text)attachment.footer=footer_text}return attachment};var _getSlackMessageFooterText=function(url){url=url||"";var footer_text="";var channel_name=TS.utility.getChannelNameFromUrl(url);var model_ob=TS.shared.getModelObById(channel_name);if(model_ob&&(model_ob.is_im||model_ob.is_mpim)){footer_text="Direct message"}else if(channel_name){footer_text="Posted in #"+channel_name}return footer_text};var _decorateForTweet=function(attachment){attachment._source.name=attachment.author_name;attachment._source.link="https://twitter.com/"+attachment.author_subname;attachment._source.author_name=attachment.author_subname;attachment._source.author_link=attachment._source.link;attachment._unfurl_type_message=true;if(!attachment.footer)attachment.footer="Twitter";if(!attachment.footer_icon)attachment.footer_icon=cdn_url+"/6e067/img/services/twitter_pixel_snapped_32.png";return attachment};var _decorateForSalesforce=function(attachment){attachment._source.name=attachment.author_name;attachment._source.author_name=attachment.author_subname;attachment._unfurl_type_message=true;attachment._always_expand=true;return attachment};var _removeDuplicativeLinks=function(attachment){_ATTACHMENT_LINKS.forEach(function(prop){if(_.get(attachment,prop)==attachment.from_url){_.set(attachment,prop,null)}});return attachment};var _getProxiedIcon=function(url){if(!url)return;if(url.indexOf("/img/")===0)return url;var options={width:16,height:16};if(url.split(".").pop()==="ico")options.convert_ico=true;return TS.utility.getImgProxyURLWithOptions(url,options)}})();(function(){"use strict";TS.registerModule("incoming_call",{div:null,is_showing:false,default_setting:{onAccept:null,onReject:null,onTimeout:null,onShow:null,onEnd:null},current_setting:null,Q:[],onKeydown:function(e){if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.incoming_call.accept();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.incoming_call.reject()}}},start:function(setting){if(TS.incoming_call.is_showing){if(setting.unique&&TS.incoming_call.current_setting.unique==setting.unique){TS.info("redundant generic dialog not Qed: "+setting.unique)}else{TS.incoming_call.Q.push(setting)}return}var current_setting=TS.incoming_call.current_setting=_.defaults({},setting,TS.incoming_call.default_setting);if(!TS.incoming_call.div)TS.incoming_call.build();var div=TS.incoming_call.div;var html;if(TS.boot_data.feature_calls){html=TS.templates.calls_incoming_call({caller:setting.caller,name:setting.name,is_video_call:setting.is_video_call,team:TS.model.team.name})}div.empty();div.html(html);div.find(".accept_audio").click(function(){TS.incoming_call.accept(false)});div.find(".accept_video").click(function(){TS.incoming_call.accept(true)});div.find(".reject").click(TS.incoming_call.reject);div.modal("show");if(document.activeElement&&document.activeElement!=document.body){document.activeElement.blur()}if(current_setting.onShow){current_setting.onShow()}},accept:function(did_choose_video){if(!TS.incoming_call.is_showing){TS.error("incoming call not showing?");return}var current_setting=TS.incoming_call.current_setting;var div=TS.incoming_call.div;div.modal("hide");current_setting.onAccept(did_choose_video)},reject:function(){var current_setting=TS.incoming_call.current_setting;TS.incoming_call.div.modal("hide");if(current_setting.onReject){current_setting.onReject()}},timeout:function(){var current_setting=TS.incoming_call.current_setting;TS.incoming_call.div.modal("hide");if(current_setting.onTimeout){current_setting.onTimeout()}},end:function(){var current_setting=TS.incoming_call.current_setting;TS.incoming_call.is_showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.incoming_call.onKeydown);TS.incoming_call.div.empty();if(current_setting.onEnd){current_setting.onEnd()}if(!TS.incoming_call.is_showing&&TS.incoming_call.Q.length){var o=TS.incoming_call.Q.shift();TS.incoming_call.start(o)}},build:function(){$("body").append('<div id="incoming_call" class="modal hide" data-keyboard="false" data-backdrop="static"></div>');var $div=TS.incoming_call.div=$("#incoming_call");$div.on("hidden",function(e){if(e.target!=this)return;TS.incoming_call.end()});$div.on("show",function(e){if(e.target!=this)return;TS.incoming_call.is_showing=TS.model.dialog_is_showing=true});$div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){if(!TS.incoming_call.is_showing)return;$div.find(".title_input").select();$(window.document).bind("keydown",TS.incoming_call.onKeydown)},100)})}})})();(function(){"use strict";TS.registerModule("inline_room_previews",{onStart:function(){},toggle_sig:new signals.Signal,checkForInlineRoomPreviewClick:function(e){var $el=$(e.target);var $msg=$el.closest(".message");if(!$msg.length)return;if($el.closest(".msg_inline_room_preview_expander, .msg_inline_room_preview_collapser").length){e.preventDefault();TS.inline_room_previews.toggle($msg);return}if($el.closest(".screenhero_attachment").length&&!$el.hasClass("screenhero_room_link")){$msg.find(".screenhero_room_link").click();return}},shouldExpand:function(room_id){var state=TS.model.expandable_state["inline_room_"+room_id];var pref=TS.model.prefs.expand_internal_inline_imgs;return state===undefined?pref:!!state},toggle:function($msg){var $call_object=$msg.find(".sh_call_container");var should_expand=$call_object.hasClass("sh_call_collapsed");var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();TS.model.expandable_state["inline_room_"+$call_object.data("room-id")]=should_expand;TS.storage.storeExpandableState(TS.model.expandable_state);$call_object.toggleClass("sh_call_collapsed");TS.inline_room_previews.toggleIcons($msg);TS.inline_room_previews.toggle_sig.dispatch($msg);if(TS.client&&was_at_bottom)TS.client.ui.instaScrollMsgsToBottom(false)},expand:function(){},collapse:function(){},toggleIcons:function($msg){$msg.find(".msg_inline_room_preview_collapser, .msg_inline_room_preview_expander").toggleClass("hidden")},expandAllInCurrent:function(){$(".msg_inline_room_preview_expander").trigger("click");if(TS.client)TS.client.ui.instaScrollMsgsToBottom(false)},collapseAllInCurrent:function(){$(".msg_inline_room_preview_collapser").trigger("click")}})})();(function(){"use strict";TS.registerModule("ui.inline_msg_input",{onStart:_.noop,make:function($container,opts){var submit_fn=opts.onSubmit||_.noop;var cancel_fn=opts.onCancel||_.noop;var get_edit_msg_div_fn=opts.getMsgDivForEditing||_getMsgToEdit;var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();var include_emo=!!(TS.client&&!opts.no_emo);var html=TS.templates.inline_message_input({include_emo:include_emo});var $form=$(html);$form.appendTo($container);var $input=$form.find("textarea");if(opts.placeholder){$input.attr("placeholder",opts.placeholder)}_initTabComplete($input);_initUI($form,$input,submit_fn,cancel_fn,get_edit_msg_div_fn);_initEmoMenu($form,$input);if(opts.scrollIntoView){_scrollIntoView($form,$input,was_at_bottom)}return $form}});var _uniq_id=0;var _checkAndSubmit=function($input,$form){var too_long=TS.format.cleanMsg($input.val()).length>TS.model.input_maxlength;if(!too_long){$form.submit()}};var _initTabComplete=function($input){if(TS.boot_data.feature_you_autocomplete_me){$input.TS_tabCompleteNew({complete_cmds:false,complete_channels:true,complete_emoji:true,complete_member_specials:true,complete_user_groups:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput($input,txt,new_cp)},sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}else{$input.TS_tabComplete({complete_cmds:false,complete_channels:true,complete_emoji:true,complete_member_specials:true,complete_user_groups:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput($input,txt,new_cp)},sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}var props={id:"inline_msg_input_tab_ui_"+_uniq_id++,scroll_with_element:!!TS.client};var in_flexpane=$input.closest("#col_flex").length>0;if(in_flexpane){props.min_width=300;props.narrow=!!TS.client}$input.tab_complete_ui(props)};var _initUI=function($form,$input,submit_fn,cancel_fn,get_edit_msg_div_fn){$form.bind("destroyed",function(){cancel_fn($form)});$form.bind("submit",function(e){e.preventDefault();var text=$input.val();if(!$.trim(text))return;submit_fn(e,$form,text)});$input.bind("textchange",function(e,prev_txt){TS.msg_edit.checkLengthOK($input)}).bind("keyup",function(e){var selection;if(window.getSelection){selection=window.getSelection();if(selection&&selection.toString&&!selection.toString()){$form.scrollintoview({direction:"vertical",px_offset:-50})}}}).bind("keydown",function(e){if(e.which==TS.utility.keymap.enter&&(e.ctrlKey||e.altKey)){if(!TS.model.is_mac||(TS.model.is_FF||TS.model.is_electron||TS.model.is_chrome_desktop)){var p=$input.getCursorPosition();var val=$input.val();$input.val(val.substr(0,p)+"\n"+val.substr(p));$input.trigger("autosize").trigger("autosize-resize");$input.setCursorPosition(p+1)}}else if(e.which==TS.utility.keymap.enter){if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs($input)&&!e.shiftKey){return}else if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs($input)&&e.shiftKey){e.preventDefault();_checkAndSubmit($input,$form);return}else if($input.tab_complete_ui("isShowing")){e.preventDefault();return}else if(!e.shiftKey&&!e.altKey){e.preventDefault();_checkAndSubmit($input,$form);return}}else if(TS.client&&TS.client.ui.shouldEventTriggerMaybeEditLast(e,$input)){var $msg=get_edit_msg_div_fn($input,model_ob);if($msg&&$msg.length){var ts=$msg.data("ts");var model_ob_id=$msg.data("model-ob-id");var model_ob=TS.shared.getModelObById(model_ob_id);var in_convo=$msg.closest("#convo_container").length>0;var edit_state=in_convo?"convo":null;TS.msg_edit.startEdit(ts,model_ob,edit_state)}}}).autosize({boxOffset:18})};var _initEmoMenu=function($form,$input){var $emo_menu=$form.find(".emo_menu");$emo_menu.removeClass("hidden");$emo_menu.bind("click.open_dialog",function(e){TS.menu.emoji.start({e:e,input_to_fill:$input})})};var _scrollIntoView=function($form,$input,was_at_bottom){if(TS.client&&was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false)}$form.scrollintoview({duration:500,px_offset:100,complete:function(){$input.focus();TS.utility.setCursorPosition($input,1e8)}})};var _getMsgToEdit=function($input,model_ob){var $msg=$input.closest("ts-message");if(model_ob&&$msg.length){var ts=$msg.data("ts");var msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(msg&&TS.utility.msgs.canEditMsg(msg,model_ob)){return msg}}return null}})();(function(){"use strict";TS.registerModule("ui.handy_rxns",{onStart:function(){if(TS.web)TS.web.login_sig.add(_onLoginWeb);if(TS.client)TS.client.login_sig.add(_onLoginClient);TS.prefs.preferred_skin_tone_changed_sig.add(_updateSkinToneRows)},decorateMsg:function(msg,text){if(!TS.boot_data.feature_thanks)return msg;var data_and_copy=_extractPollDataAndCopyFromText(text);if(data_and_copy){msg._handy_rxns_poll_data=data_and_copy.data;msg.text=data_and_copy.copy}return msg},msgifyPollData:function(data){var txt=_poll_marker;var datum;for(var k in data.list){datum=data.list[k];txt+="\n:"+datum.name+": "+(datum.title||datum.name)+""}return txt},startPollDialog:function(c_id,msg_id){_model_ob=TS.shared.getModelObById(c_id);if(!_model_ob)return;_msg=TS.utility.msgs.getMsg(msg_id,_model_ob.msgs);if(_msg){_poll_text=TS.format.unFormatMsg(_msg.text)}else{_poll_text=TS.utility.contenteditable.value(TS.client.ui.$msg_input)}TS.view.clearMessageInput();_in_poll_mode=true;_build();_setHandyRxns();_conformUIToModel();var get_poll_title=_msg?TS.i18n.t("Edit a poll in {name}","rxns"):TS.i18n.t("Create a poll in {name}","rxns");var prefix=_model_ob.is_channel?"#":'<i class="ts_icon ts_icon_lock"></i> ';var title=get_poll_title({name:prefix+_model_ob.name});var go_button_text=_msg?TS.i18n.t("Save","rxns")():TS.i18n.t("Create","rxns")();var placeholder=TS.i18n.t("Your poll text","rxns")();TS.generic_dialog.start({title:title,$body:_$container,go_button_text:go_button_text,onGo:function(){if(!_isPollSendable())return false;var new_text=_$message_input.val();var value=_readFromDom();var text=new_text+TS.ui.handy_rxns.msgifyPollData(value);if(_msg){TS.msg_edit.commitEdit(_msg,_model_ob,text)}else{TS.client.ui.sendMessage(_model_ob,text)}_clean();return true},onEnd:function(){_clean()},onCancel:function(){if(!_msg)TS.client.msg_input.populate(_poll_text)},onShow:function(){TS.ui.inline_msg_input.make(_$container.find("#poll_dialog_input_container"),{placeholder:placeholder,no_emo:true});_$message_input=_$container.find(".message_input");_$message_input.val(_poll_text);_$message_input.on("textchange",function(){_updateIsDirty()});_is_dirty=undefined;_updateIsDirty()}})},startChannelDialog:function(c_id){_model_ob=TS.shared.getModelObById(c_id);if(!_model_ob)return;_in_poll_mode=false;_build();_setHandyRxns();_conformUIToModel();var get_poll_title=TS.i18n.t("Edit handy reactions for {name}","rxns");var prefix=_model_ob.is_channel?"#":'<i class="ts_icon ts_icon_lock"></i> ';var title=get_poll_title({name:prefix+_model_ob.name});var go_button_text=TS.i18n.t("Save","rxns")();TS.generic_dialog.start({title:title,$body:_$container,go_button_text:go_button_text,onGo:function(){TS.ui.handy_rxns.saveHandyRxns().then(function(){TS.generic_dialog.cancel();_clean()}).catch(function(){alert("saving failed")});return false},onEnd:function(){_clean()},onShow:function(){_is_dirty=undefined;_updateIsDirty()}})},saveHandyRxns:function(){var pref_ob;var value=_readFromDom();if(_model_ob){TS.model.team.prefs.channel_handy_rxns=TS.model.team.prefs.channel_handy_rxns||{};if(value.list.length){TS.model.team.prefs.channel_handy_rxns[_model_ob.id]=value}else{delete TS.model.team.prefs.channel_handy_rxns[_model_ob.id]}pref_ob={channel_handy_rxns:TS.model.team.prefs.channel_handy_rxns}}else{pref_ob={team_handy_rxns:value}}return TS.prefs.setTeamPrefByAPI(pref_ob).then(function(prefs){_setHandyRxns();var delayed_for_web=true;_updateIsDirty(delayed_for_web)})}});var _$container;var _$restrict_cb;var _$message_input;var _handy_rxns;var _model_ob;var _msg;var _in_poll_mode;var _poll_text;var _is_dirty;var _$rows=null;var _poll_marker=TS.i18n.t("\n\nThis is a poll. Choose from these reactions:","rxns")();
var _onLoginClient=function(){};var _setHandyRxns=function(){if(_in_poll_mode){_handy_rxns=_msg&&_msg._handy_rxns_poll_data||{list:[],restrict:false}}else if(_model_ob){_handy_rxns=TS.rxns.getHandyRxnsByCidAndMsgId(_model_ob.id,null,{list:[],restrict:false})}else{_handy_rxns=TS.model.team.prefs.team_handy_rxns}};var _onLoginWeb=function(){_setHandyRxns();_model_ob=null;_in_poll_mode=false;_build();_conformUIToModel();$("#handy_rxns_subsection").prepend(_$container)};var _clean=function(){if(!_$container)return;_$container.empty();_$container=null;_$rows=null;_$restrict_cb=null;_$message_input=null};var _filteredSuggestions=function(){var ss=_.cloneDeep(TS.boot_data.handy_rxns_suggestions);for(var k in ss){if(_in_poll_mode){if(!ss[k].is_poll)delete ss[k]}else{if(ss[k].is_poll)delete ss[k]}}return ss};var _build=function(){_$container=$(TS.templates.rxns_handy_controller({max_handy_rxns:_in_poll_mode?TS.boot_data.max_poll_handy_rxns:Math.max(TS.boot_data.max_channel_handy_rxns,TS.boot_data.max_team_handy_rxns),max_handy_rxns_title_chars:TS.boot_data.max_handy_rxns_title_chars,model_ob:_model_ob,in_poll_mode:_in_poll_mode,handy_rxns_suggestions:_filteredSuggestions()}));_$rows=_$container.find(".handy_rxns_row");_$restrict_cb=_$container.find("#handy_rxns_restrict_cb");_$message_input=$();_$container.find("#suggestions_ui a").bind("click",function(e){var $btn=$(e.currentTarget);var key=$btn.data("suggestion-key");if(!TS.boot_data.handy_rxns_suggestions[key])return;_conformUIToModel(TS.boot_data.handy_rxns_suggestions[key])});_$restrict_cb.bind("change",function(){_updateIsDirty()});_$container.find("input.title").on("textchange",function(){_updateIsDirty()});_$container.find("a.handy_rxns_remover").on("click",function(e){var $row=$(e.currentTarget).parent();_updateRow($row,"","");$row.insertAfter(_$rows.last());_updateIsDirty()});_$container.find("a.handy_rxns_picker").on("click",function(e){var $row=$(e.currentTarget).parent();var was_name=$row.find("a.btn").data("rxn");var was_title=$row.find("input.title").val();var disabled_names=$row.hasClass("empty")?_readFromDom().list.map(function(item){return item.name}):[was_name];TS.menu.emoji.start({e:e,disabled_names:disabled_names,callback:function(name){name=_cleanName(name);var $existing_row=_getExistingRow(name);var existing_title=$existing_row.find("input.title").val();if($existing_row.length){_updateRow($existing_row,was_name,was_title);_updateRow($row,name,existing_title)}else{_updateRow($row,name,was_title)}$row.insertBefore(_getEmptyRows().first());_updateIsDirty()}})})};var _readFromDom=function(){var list=[];_$rows=_$container.find(".handy_rxns_row");$.each(_getFilledRows(),function(i,row){var $row=$(row);list.push({name:$row.find("a.btn").data("rxn"),title:$row.find("input.title").val()})});var value={list:list,restrict:!!_$restrict_cb.prop("checked")};if(_in_poll_mode){value.restrict=true;value.is_poll=true}return value};var _cleanName=function(name){return TS.emoji.stripWrappingColons(name.replace(/(\::skin-tone-[2-6])/,""))};var _getExistingRow=function(name){return _$rows.filter(function(i){return $(this).find("a.btn").data("rxn")==name})};var _getFilledRows=function(){return _$rows.filter(function(i){return!$(this).hasClass("empty")})};var _getEmptyRows=function(){return _$rows.filter(function(i){return $(this).hasClass("empty")})};var _updateRow=function($row,name,title){var suffix=TS.emoji.isNameSkinToneModifiable(name)?TS.emoji.getChosenSkinToneModifier():"";var html=name&&TS.emoji.graphicReplace(":"+name+":"+suffix)||'<i class="ts_icon ts_icon_add_reaction subtle_silver"></i>';var title=name?TS.i18n.t("say what {name} means","rxns")({name:name}):"";$row.find("a.btn").html(html).attr("data-rxn",name).data("rxn",name);$row.find("input.title").val(title).attr("placeholder",title);$row.toggleClass("empty",!name);_updateUI();return $row};var _conformUIToModel=function(handy_rxns){handy_rxns=handy_rxns||_handy_rxns;$.each(_$rows,function(i,row){var $row=$(row);var datum=handy_rxns.list[i];if(datum){_updateRow($row,datum.name,datum.title)}else{_updateRow($row,"","")}});_$restrict_cb.prop("checked",!!handy_rxns.restrict);_updateUI();_updateIsDirty()};var _updateUI=function(){_$container.find("#handy_rxns_controller_empty").toggleClass("hidden",!!_getFilledRows().length)};var _updateSkinToneRows=function(){if(!_$rows)return;$.each(_$rows,function(i,row){var $row=$(row);var name=$row.find("a.btn").data("rxn");if(TS.emoji.isNameSkinToneModifiable(name)){_updateRow($row,name,$row.find("input.title").val())}})};var _isPollSendable=function(){if(!_$message_input.val())return false;if(_readFromDom().list.length<1)return false;return true};var _updateIsDirty=function(delayed_for_web){var was_is_dirty=_is_dirty;var pref_ob=_readFromDom();_is_dirty=!TS.utility.areSimpleObjectsEqual(_handy_rxns,pref_ob);if(_in_poll_mode&&_poll_text!=_$message_input.val())_is_dirty=true;if(TS.web){if(_is_dirty==was_is_dirty)return;if(delayed_for_web){setTimeout(function(){$("#handy_rxns_subsection").find(".submit_setting").toggleClass("disabled",!_is_dirty);TS.ui.resetButtonSpinner($("#handy_rxns_subsection").find(".submit_setting"))},2e3)}else{$("#handy_rxns_subsection").find(".submit_setting").toggleClass("disabled",!_is_dirty)}}else if(TS.client){if(_in_poll_mode){$("#generic_dialog").find(".btn.dialog_go").toggleClass("disabled",!_is_dirty||!_isPollSendable())}else{if(_is_dirty==was_is_dirty)return;$("#generic_dialog").find(".btn.dialog_go").toggleClass("disabled",!_is_dirty)}}};var _extractPollDataAndCopyFromText=function(txt){if(!txt)return null;var poll_parts=txt.split(_poll_marker);if(poll_parts.length!=2)return null;var copy=poll_parts[0];var data_lines=$.trim(poll_parts[1]).split("\n");var data={list:[],is_poll:true,restrict:true};data_lines.forEach(function(line){var name=line.split(":")[1];var title=$.trim(line.replace(":"+name+":",""))||"";if(title==name)title="";data.list.push({name:name,title:title})});if(!data.list.length)return null;return{data:data,copy:copy}}})();(function(){"use strict";TS.registerModule("ui.basic_share_dialog",{start:function(options){_options=options;var html=TS.templates.basic_share_dialog({attachment_html:new Handlebars.SafeString(options.attachment_html),warning:options.warning,show_copy_link:!!options.copy_link&&TS.clipboard.canWriteText(),copy_text:options.copy_text});var dialog_class="basic_share_dialog";if(options.dialog_class)dialog_class+=" "+options.dialog_class;TS.generic_dialog.start({title:options.title||"Share",go_button_text:options.go_button_text||"Share",dialog_class:dialog_class,body:html,onShow:_onShow,onEnd:_onEnd,onGo:options.onGo})}});var _options;var _onShow=function(){var $dialog=$("#generic_dialog.basic_share_dialog");$dialog.css("display","");var $container=$dialog.find("#share_dialog_input_container");TS.ui.inline_msg_input.make($container,{no_emo:false,placeholder:"Add a message, if youd like."});var $input=$container.find(".message_input");$input.attr("id","file_comment_textarea");$input.val(_options.initial_message||"");var $channel_picker=$dialog.find("#file_sharing_div");$channel_picker.prependTo($dialog.find(".modal-footer"));var show_share_prefix=true;TS.ui.file_share.bindFileShareDropdowns(show_share_prefix,_options.src_model_ob);$channel_picker.find("#select_share_channels").css({width:""});var $warning=$("#share_dialog_warning");if($warning.length){$channel_picker.addClass("hidden");$warning.prependTo($dialog.find(".modal-footer"))}var $copy=$dialog.find('[data-action="copy_link"]');if($copy.length){$dialog.find(".dialog_cancel").before($copy);$copy.removeClass("hidden");$copy.click(_onCopy)}TS.generic_dialog.div.on("shown",function shown(){TS.generic_dialog.div.off("shown",shown);$container.find(".message_input").select()});$input.on("keydown",function(e){if(e.which===TS.utility.keymap.esc){if(!$input.val()){e.preventDefault();TS.generic_dialog.cancel()}}else if(e.which===TS.utility.keymap.enter){if(!e.shiftKey&&!e.altKey&&!$input.tab_complete_ui("isShowing")){e.preventDefault();TS.generic_dialog.go()}}else if(e.which===TS.utility.keymap.tab&&!e.shiftKey&&!$input.tab_complete_ui("isShowing")&&!$input.tab_complete_ui("hasMatches")){e.preventDefault();$channel_picker.find(".lfs_input_container").click()}}).on("textchange",function(){TS.ui.file_share.updateAtChannelWarningNote();TS.ui.file_share.updateAtChannelBlockedNote()});if(_options.onShow)_options.onShow()};var _onEnd=function(){if(_options.onEnd)_options.onEnd();_options=null};var _onCopy=function(){if(!_options.copy_link||!TS.clipboard.canWriteText())return;TS.tips.updateFloater({title:"Copied!",classes_to_add:["success"]});TS.clipboard.writeText(_options.copy_link)}})();(function(){"use strict";TS.registerModule("ui.share_message_dialog",{start:function(msg_ts,model_ob,initial_message){var msg=TS.utility.msgs.findMsg(msg_ts,model_ob.id);if(!msg){TS.error("wtf no msg?");return}_msg_ts=msg_ts;if(!_.isString(msg_ts))_msg_ts=msg_ts.toString();_model_ob=model_ob;_submitting=false;var msg_html=TS.templates.builders.formatMessageAsAttachment(msg,model_ob);var copy_link_tooltip="Copy a link to this message.<br>To share, paste it anywhere.";var warning;if(!_canShareToOtherChannels()){copy_link_tooltip="Copy a link to this message.<br>Its private, so sharing is limited.";warning=TS.templates.share_message_dialog_warning({from_private_channel:model_ob.is_group&&!model_ob.is_mpim});warning=new Handlebars.SafeString(warning)}TS.ui.basic_share_dialog.start({title:"Share message",go_button_text:"Share",initial_message:initial_message,attachment_html:msg_html,warning:warning,copy_link:TS.utility.msgs.constructAbsoluteMsgPermalink(_model_ob,_msg_ts),copy_text:copy_link_tooltip,onGo:_onGo,onEnd:_onEnd,src_model_ob:_model_ob})}});var _msg_ts;var _model_ob;var _submitting;var _onEnd=function(){_msg_ts=null;_model_ob=null};var _onGo=function(){if(_submitting)return;var msg_ts=_msg_ts;var src_model_ob=_model_ob;var original_text=$(".basic_share_dialog .message_input").val();var text=TS.format.cleanMsg(original_text);text=_.trim(text);if(TS.ui.file_share.shouldBlockUploadDialogSubmission())return false;var args={channel:src_model_ob.id,timestamp:msg_ts,text:text};var dest_model_ob;if(_canShareToOtherChannels()){var $select_share_channels=$(".basic_share_dialog #select_share_channels");var destination=$select_share_channels.lazyFilterSelect("value");if(destination&&destination.length>0){dest_model_ob=destination[0].model_ob;args.share_channel=dest_model_ob.presence?"@"+dest_model_ob.name:dest_model_ob.id}else if(src_model_ob.is_archived){$("#select_share_pick_channel_note").removeClass("hidden");_.defer(function(){$select_share_channels.find(".lfs_input_container").click()});return false}}_submitting=true;if(!dest_model_ob)dest_model_ob=src_model_ob;var ready_to_share_p;if(dest_model_ob&&dest_model_ob.is_channel&&!dest_model_ob.is_member){ready_to_share_p=TS.channels.join(dest_model_ob.name)}else{ready_to_share_p=Promise.resolve()}ready_to_share_p.then(function(){return TS.api.call("chat.shareMessage",args).then(function(){if(!TS.client)return;var active_model_ob=TS.shared.getActiveModelOb();if(dest_model_ob&&active_model_ob&&active_model_ob.id===dest_model_ob.id&&!TS.model.threads_view_is_showing&&!TS.model.unread_view_is_showing){TS.client.ui.instaScrollMsgsToBottom()}else if(args.share_channel&&dest_model_ob){return TS.client.displayModelOb(dest_model_ob)}})}).catch(function(e){var error=e||"unknown error";if(e&&e.data&&e.data.error)error=e.data.error;TS.error("chat.shareMessage error: "+error);TS.generic_dialog.start({title:"Message could not be shared",body:"Sorry! Something went wrong.",go_button_text:"Try again",onGo:function(){TS.ui.share_message_dialog.start(msg_ts,src_model_ob,original_text)}})})};var _canShareToOtherChannels=function(){return _model_ob.is_channel}})();(function(){"use strict";TS.registerModule("attachment_actions",{action_triggered_sig:new signals.Signal,action_completed_sig:new signals.Signal,onStart:function(){TS.attachment_actions.action_triggered_sig.add(_onActionTriggered);TS.attachment_actions.action_completed_sig.add(_onActionCompleted)},getActionContext:function(args){if(!args)return;var message=TS.utility.msgs.findMsg(args.message_ts,args.channel_id);if(!message)return;var attachment=_.find(message.attachments,{id:args.attachment_id});if(!attachment)return;var action=_.find(attachment.actions,{id:args.action_id});if(!action)return;if(action.type==="select"){action.selected_options=_.filter(action.options,{value:args.selected_value});delete action.options}return{action:action,attachment:attachment,channel_id:args.channel_id,message:message}},handleActionEventAndGetContext:function($target){var $attachment=$target.parents("[data-attachment-id]");var $msg=$attachment.parents("ts-message");var channel_id=String($msg.data("model-ob-id"));var message_ts=String($msg.data("ts"));if(TS.client.activeChannelIsHidden()||channel_id!=TS.shared.getActiveModelOb().id){TS.client.ui.tryToJump(channel_id,message_ts)}var slack_action_url=$target.data("slack-action-url");if(slack_action_url){var actual_url=slack_action_url.match(/\<(.*?)\|/)[1];if(actual_url&&actual_url.indexOf(TS.utility.msgs.new_api_url_prefix)===0){TS.utility.msgs.doNewApiUrl(actual_url)}else{TS.error(slack_action_url+" does not contain a valid slack action URL.")}return}return TS.attachment_actions.getActionContext({channel_id:channel_id,message_ts:message_ts,attachment_id:String($attachment.data("attachment-id")),action_id:String($target.data("action-id")),action_type:String($target.data("action-type")),selected_value:$target.val()})},getPendingAttachment:function(attachment,actions){if(!attachment||!actions||!actions.length)return;var changed_ids=_.map(actions,"id");var pending_attachment=_.cloneDeep(attachment);pending_attachment.actions.forEach(function(action){action._disabled=true;action._loading=_.includes(changed_ids,action.id)});pending_attachment._pending=true;return pending_attachment},confirmAction:function(action,callback){var confirm_class=action.style=="danger"?"btn_danger":"btn_primary";var config=_.defaults(action.confirm,{dismiss_text:TS.i18n.t("Cancel","attachment_actions")(),ok_text:TS.i18n.t("OK","attachment_actions")(),text:"",title:""});if(config.text){config.text=TS.emoji.graphicReplace(config.text)}else if(!config.title){config.text=TS.i18n.t("Are you sure?","attachment_actions")()}if(config.title){config.title=TS.emoji.graphicReplace(config.title)}TS.generic_dialog.start({title:config.title,body:config.text,show_go_button:true,show_cancel_button:true,go_button_text:config.ok_text,go_button_class:confirm_class,cancel_button_text:config.dismiss_text,onGo:callback})},render:function(attachment,message_ts,only_render_if_pending){if(!attachment||!message_ts)return;var $container=_getAttachmentActionsContainer(attachment,message_ts);if(!$container.length)return;if(!only_render_if_pending||$container.find(".attachment_actions_buttons").hasClass("attachment_pending")){var html=TS.templates.attachment_actions({attachment:attachment});$container.html(html);if(TS.boot_data.feature_message_menus){TS.attachment_actions.select.decorateNewElements(TS.client.ui.$msgs_div)}}}});function _onActionTriggered(data){if(!data||!data.message||!data.attachment||!data.action||!data.channel_id){TS.warn("_onActionTriggered: missing message, attachment, action, or channel_id");return}var pending_attachment=TS.attachment_actions.getPendingAttachment(data.attachment,[data.action]);if(pending_attachment){TS.attachment_actions.render(pending_attachment,data.message.ts)}var api_args={payload:JSON.stringify({actions:[data.action],attachment_id:data.attachment.id,callback_id:data.attachment.callback_id,channel_id:data.channel_id,is_ephemeral:data.message.is_ephemeral,message_ts:data.message.ts})};if(data.message.bot_id)api_args.service_id=data.message.bot_id;if(data.message.user)api_args.bot_user_id=data.message.user;TS.api.call("chat.attachmentAction",api_args).then(function(res){TS.attachment_actions.action_completed_sig.dispatch({attachment:data.attachment,message_ts:data.message.ts,channel_id:data.channel_id,is_expecting_ms_update:!!(_.get(res,"data.replaced")||_.get(res,"data.deleted"))})}).catch(function(err){TS.error(err);TS.attachment_actions.action_completed_sig.dispatch({attachment:data.attachment,message_ts:data.message.ts,channel_id:data.channel_id,err:err})})}function _onActionCompleted(args){if(!args)return;if(args.err){var default_text=TS.i18n.t("Oh no, something went wrong. Please try that again.","attachment_actions")();var ephemeral_msg={text:_.get(args,"err.data.response")||default_text,ephemeral_type:_.get(args,"err.data.error")||"attachment_action_error",slackbot_feels:"sad_surprise"};TS.client.ui.addEphemeralBotMsg(ephemeral_msg)}if(args.attachment&&args.message_ts&&args.channel_id&&!args.is_expecting_ms_update){_waitThenRevertActions(args)}}function _waitThenRevertActions(args){TS.utility.rAF(function(){var current_attachment=TS.utility.attachments.findAttachment({attachment_id:args.attachment.id,message_ts:args.message_ts,channel_id:args.channel_id});if(current_attachment){TS.attachment_actions.render(current_attachment,args.message_ts,true)}})}function _getAttachmentActionsContainer(attachment,message_ts){var msg_dom_id=TS.templates.makeMsgDomId(message_ts);return $("#"+msg_dom_id).find("[data-attachment-id="+attachment.id+"] .attachment_actions")}})();(function(){"use strict";TS.registerModule("attachment_actions.select",{onStart:_.noop,decorateNewElements:function($container){$container.find(".attachment_actions_buttons select:visible").lazyFilterSelect({onItemAdded:_onItemAdded,filter:_filter}).hide()},getActionModel:function(action,is_disabled){var model=_.merge({_disabled:!!is_disabled,data_source:"default",desc:"",id:"",name:"",options:[],text:""},action);model.options=_getOptionsForModel(model);model.text=_formatAndMarkSafeString(model.text);return model}});var _DATA_SOURCES={channels:"channels","default":"default",users:"users"};function _onItemAdded(item){var context=TS.attachment_actions.handleActionEventAndGetContext(this.$select);TS.attachment_actions.action_triggered_sig.dispatch(context)}function _filter(item,query){return TS.fuzzy.score(item.text.toLowerCase(),query)<Infinity}function _getOptionsForModel(model){switch(model.data_source){case _DATA_SOURCES.channels:return _getOptionsForChannels();case _DATA_SOURCES.users:return _getOptionsForUsers();default:return _getOptionsForDefault(model.options)}}function _getOptionsForDefault(options){return _.map(options,function(option){option.text=_formatAndMarkSafeString(option.text);option.desc=_formatAndMarkSafeString(option.desc);return option})}function _getOptionsForChannels(){var sorted_channels=TS.sorter.search("#",{channels:TS.channels.getChannelsForUser()},{frecency:true});return sorted_channels.map(function(result){var channel=result.model_ob;return{text:"#"+channel.name,value:channel.id}})}function _getOptionsForUsers(){var sorted_members=TS.sorter.search("@",{members:TS.members.getActiveMembersExceptSelfAndBots()},{frecency:true});return sorted_members.map(function(result){var member=result.model_ob;return{desc:TS.members.getMemberDisplayName(member),icon:member.profile.image_24,text:TS.members.getMemberFullName(member),value:member.id}})}function _formatAndMarkSafeString(str){var formatted_text=TS.emoji.graphicReplace(str);return new Handlebars.SafeString(formatted_text)}})();(function(){"use strict";TS.registerComponent("ui.ContextualDropDown",{_constructor:function(container,options){options=options||{};this._show_description=options.show_description;this.updated_sig=new signals.Signal;var option_els=Array.prototype.slice.call(container.querySelectorAll("select option"));container.innerHTML=TS.templates.contextual_dropdown({show_description:options.show_description});this._dropdown=container.querySelector(".contextual_dropdown");this._dropdown_label=container.querySelector(".contextual_dropdown_label");this._dropdown_container=container.querySelector(".contextual_dropdown_container");if(options.show_description)this._dropdown_desc=container.querySelector(".contextual_dropdown_desc");this._onOpen=_onOpen.bind(this);this._onClose=_onClose.bind(this);this._onItemClicked=_onItemClicked.bind(this);this._onItemMouseOver=_onItemMouseOver.bind(this);this._onItemMouseOut=_onItemMouseOut.bind(this);this._onItemPress=_onItemPress.bind(this);this._onFocus=_onFocus.bind(this);this._onBlur=_onBlur.bind(this);this._onEnterPress=_onEnterPress.bind(this);this._onArrowPress=_onArrowPress.bind(this);this._dropdown_label.addEventListener("click",this._onOpen);this._dropdown_label.addEventListener("focus",this._onFocus);this._dropdown_label.addEventListener("blur",this._onBlur);var tags_regex=/(<([^>]+)>)/gi;var items_html="";var desc;var desc_disabled;var disabled;option_els.forEach(function(option_el){desc=option_el.getAttribute("data-desc")||"";desc_disabled=option_el.getAttribute("data-desc-disabled")||"";disabled=option_el.getAttribute("disabled")?true:false;items_html+=TS.templates.contextual_dropdown_item({label:option_el.label,value:option_el.value,desc:desc,desc_disabled:desc_disabled,disabled:disabled,aria_label:(desc?desc:option_el.label).replace(tags_regex,"")})});var dropdown_items=container.querySelector(".contextual_dropdown_items");dropdown_items.innerHTML=items_html;this._items=Array.prototype.slice.call(dropdown_items.querySelectorAll(".contextual_dropdown_item"));this._items.forEach(function(item){item.addEventListener("click",this._onItemClicked);item.addEventListener("keydown",this._onItemPress);if(options.show_description){item.addEventListener("mousemove",this._onItemMouseOver);item.addEventListener("focus",this._onItemMouseOver);item.addEventListener("mouseout",this._onItemMouseOut)}}.bind(this));if(this._items.length){if(options.start_value){_setCurrentSelected.call(this,dropdown_items.querySelector('[data-value="'+options.start_value+'"]'))}else if(options.select_first){_setCurrentSelected.call(this,this._items[0])}}},getSelectedItem:function(){return this._current_item||null},getSelectedValue:function(){if(!this._current_item)return null;return this._current_item.getAttribute("data-value")},destroy:function(){this._onClose();this._dropdown_label.removeEventListener("click",this._onOpen);this._dropdown_label.removeEventListener("focus",this._onFocus);this._dropdown_label.removeEventListener("blur",this._onBlur);this._items.forEach(function(item){item.removeEventListener("click",this._onItemClicked);item.removeEventListener("keydown",this._onItemPress);if(this._show_description){item.removeEventListener("mousemove",this._onItemMouseOver);item.removeEventListener("focus",this._onItemMouseOver);item.removeEventListener("mouseout",this._onItemMouseOut)}}.bind(this))}});var _onFocus=function(evt){document.addEventListener("keydown",this._onEnterPress)};var _onBlur=function(evt){document.removeEventListener("keydown",this._onEnterPress)};var _onEnterPress=function(evt){if(evt.key==="Enter"){if(this._is_open){this._onClose()}else{this._onOpen()}}else if(!this._is_open&&evt.key==="ArrowDown"){this._onOpen();this._onArrowPress(evt)}};var _onArrowPress=function(evt){var index;if(evt.key==="ArrowDown"){index=this._items.indexOf(this._focused_item);if(index<this._items.length-1){index++}else{index=0}}else if(evt.key==="ArrowUp"){index=this._items.indexOf(this._focused_item);if(index>0){index--}else{index=this._items.length-1}}if(index!==undefined)this._items[index].focus()};var _onOpen=function(evt){if(evt)evt.stopPropagation();this._dropdown_label.removeEventListener("click",this._onOpen);document.body.addEventListener("click",this._onClose);document.addEventListener("keydown",this._onArrowPress);if(this._current_item){var label=this._current_item.getAttribute("data-desc");this._dropdown_desc.innerHTML=label}this._dropdown.classList.add("is_open");this._is_open=true;this._focused_item=null;this._dropdown_container.setAttribute("aria-hidden",false)};var _onClose=function(evt){document.body.removeEventListener("click",this._onClose);document.removeEventListener("keydown",this._onArrowPress);this._dropdown_label.addEventListener("click",this._onOpen);this._dropdown.classList.remove("is_open");this._is_open=false;this._dropdown_container.setAttribute("aria-hidden",true)};var _setCurrentSelected=function(item,evt){if(this._current_item&&this._current_item===item||!item)return;if(item.getAttribute("disabled")){if(evt)evt.stopPropagation();return}if(this._current_item)this._current_item.classList.remove("is_selected");this._current_item=item;this._current_item.classList.add("is_selected");this._dropdown_label.innerHTML=this._current_item.getAttribute("data-label");var label=this._current_item.getAttribute("data-desc");if(this._dropdown_desc)this._dropdown_desc.innerHTML=label;this.updated_sig.dispatch(this.getSelectedValue())};var _onItemClicked=function(evt){_setCurrentSelected.call(this,evt.target,evt)};var _onItemMouseOver=function(evt){if(this._focused_item===evt.target)return;var label;var label=evt.target.getAttribute("disabled")?evt.target.getAttribute("data-desc-disabled"):evt.target.getAttribute("data-desc");this._dropdown_desc.innerHTML=label;if(this._focused_item)this._focused_item.blur();this._focused_item=evt.target;this._focused_item.focus()};var _onItemMouseOut=function(evt){if(this._focused_item===evt.target){this._focused_item.blur();this._focused_item=null}};var _onItemPress=function(evt){if(evt.key==="Enter"){_setCurrentSelected.call(this,evt.target,evt);this._dropdown_label.focus();this._onClose();evt.stopPropagation()}}})();(function(){"use strict";TS.registerModule("utility.slackbot",{getWithFeels:function(feels){var slackbot=_cloneSlackbotMemberObject();if(!slackbot||!slackbot.profile)return;_setProfileImages(slackbot,feels);return slackbot}});function _cloneSlackbotMemberObject(){return _.cloneDeep(TS.members.getMemberById("USLACKBOT"))}function _setProfileImages(slackbot,feels){switch(feels){case"sad_surprise":slackbot.profile.image_20=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_20.png";slackbot.profile.image_24=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_24.png";slackbot.profile.image_32=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_32.png";slackbot.profile.image_36=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_36.png";slackbot.profile.image_48=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_48.png";slackbot.profile.image_72=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_72.png";slackbot.profile.image_192=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_192.png";slackbot.profile.image_512=cdn_url+"/c6db/img/slackbot/slackbot_sad_surprise_512.png";break;case"fancy":slackbot.profile.image_20=cdn_url+"/c6db/img/slackbot/slackbot_fancy_20.png";slackbot.profile.image_24=cdn_url+"/c6db/img/slackbot/slackbot_fancy_24.png";slackbot.profile.image_32=cdn_url+"/c6db/img/slackbot/slackbot_fancy_32.png";slackbot.profile.image_36=cdn_url+"/c6db/img/slackbot/slackbot_fancy_36.png";slackbot.profile.image_48=cdn_url+"/c6db/img/slackbot/slackbot_fancy_48.png";slackbot.profile.image_72=cdn_url+"/c6db/img/slackbot/slackbot_fancy_72.png";slackbot.profile.image_192=cdn_url+"/c6db/img/slackbot/slackbot_fancy_192.png";slackbot.profile.image_512=cdn_url+"/c6db/img/slackbot/slackbot_fancy_512.png";break;default:TS.warn("Slackbot doesn't have an avatar for that feeling.");break}}})();(function(){"use strict";TS.registerModule("utility.welcome_post",{WELCOME_POST_NAME:"Getting_started_with_Slack__team_creator_welcome_post_identifier",clogWelcomePostExpand:function(file){if(file&&file.name===TS.utility.welcome_post.WELCOME_POST_NAME){if(TS.model.user.is_primary_owner){TS.clog.track("WEBSITE_CLICK",{click_target:"expand_post_button",trigger:"welcome_post_team_creator",action:"open_post"})}else{TS.clog.track("WEBSITE_CLICK",{click_target:"expand_post_button",trigger:"welcome_post_team_joiner",action:"open_post"})}}},clogWelcomePostOpen:function($el){var file_id=$el.data("file-id");var file=TS.files.getFileById(file_id);if(file&&file.name===TS.utility.welcome_post.WELCOME_POST_NAME){if(TS.model.user.is_primary_owner){TS.clog.track("WEBSITE_CLICK",{click_target:"edit_in_new_window_button",trigger:"welcome_post_team_creator",action:"open_post"})}else{TS.clog.track("WEBSITE_CLICK",{click_target:"open_in_new_window_button",trigger:"welcome_post_team_joiner",action:"open_post"})}}},clogWelcomePostSetting:function(isEnabled){if(isEnabled){TS.clog.track("WEBSITE_CLICK",{click_target:"save_welcome_post_setting",trigger:"button_click",action:"enable"})}else{TS.clog.track("WEBSITE_CLICK",{click_target:"save_welcome_post_setting",trigger:"button_click",action:"disable"})}}})})();(function(){"use strict";TS.registerModule("utility.enterprise",{splitQueryIntoTerms:function(query,terms){var results=terms;var query_terms;query=query.trim();if(query.length>=2){query_terms=query.split(" ");results=results||[];_.each(query_terms,function(term){if(term.length>=2){results.push({type:"fuzzy_with_email",value:term})}})}return results},getSSOProviderLabel:function(provider,placeholder){if(!provider)return placeholder;var type=_.get(provider,"type","");var name=_.get(provider,"name","");var is_unconfigured=type==="";var is_unlabeled_custom_SAML=type==="saml";if(is_unconfigured||is_unlabeled_custom_SAML)return placeholder;return name||placeholder},getProviderLabel:function(org_data,placeholder){var fallback=placeholder||"IDP";var placeholder;if(!org_data)return fallback;placeholder=_.get(org_data,"saml_provider")||fallback;if(placeholder.toLowerCase()==="saml")placeholder=fallback;return TS.utility.enterprise.getSSOProviderLabel(_.get(org_data,"sso_provider"),placeholder)},wrapWithStrongTags:_.wrap(_.escape,function(esc,text){return"<strong>"+esc(text)+"</strong>"}),commaSeparatedListWithStrongFormatting:function(list){if(list.length>1){return _(list).dropRight().map(TS.utility.enterprise.wrapWithStrongTags).join(", ")+", and "+TS.utility.enterprise.wrapWithStrongTags(_.last(list))}else if(list.length===1){return TS.utility.enterprise.wrapWithStrongTags(list[0])}else{return""}}})})();(function(){"use strict";TS.registerModule("ui.unsaved_form_warning",{onStart:function(){$("form[data-unsaved-form-warning]").each(function(i,form){var initial_form=$(form).serializeArray();var form_submitted=false;if(form.hasAttribute("data-validation-form")){TS.ui.validation.completed_sig.add(function(validated_form,status){if(status.passed&&validated_form[0]===form){form_submitted=true}})}else{$(form).on("submit",function(){form_submitted=true})}$(window).on("beforeunload",function(){if(!form_submitted&&!_.isEqual(initial_form,$(form).serializeArray())){return"Changes you made may not be saved."}})})}})})();(function(){"use strict";TS.registerModule("ui.pins",{onStart:function(){if(TS.boot_data.feature_pin_update){TS.pins.pins_fetched_sig.add(TS.ui.pins.rebuildPinnedMessagesUI);TS.pins.pinned_status_changed_sig.add(TS.ui.pins.updatePinUI)}},updatePinUI:function(model_ob,pinned_item,is_pinned){if(!model_ob||!pinned_item)return;if(pinned_item.type==="file"){_updatePinnedFileUI(model_ob,pinned_item.file,is_pinned)}else if(pinned_item.type==="file_comment"){_updatePinnedFileCommentUI(model_ob,pinned_item.comment,is_pinned)}if(pinned_item.type==="message"){_updatePinnedMessageUI(model_ob,pinned_item.message,is_pinned)}},rebuildPinnedMessagesUI:function(model_ob,pinned_items){if(!pinned_items||pinned_items.length===0)return;pinned_items.forEach(function(pinned_item){TS.ui.pins.updatePinUI(model_ob,pinned_item,true)})},clearUnreadPinState:function(){TS.client.channel_header.clearUnreadPinState();TS.client.channel_page.clearUnreadPinState()}});var _updatePinnedMessageUI=function(model_ob,msg,is_pinned){if(!model_ob||!msg||!msg.ts)return;var msg_dom_id=TS.templates.makeMsgDomId(msg.ts);var $msg=$("#messages_container #"+msg_dom_id+', #messages_container .message_unfurl[data-attachment-ts="'+msg.ts+'"]');var $is_pinned_holder=$msg.find(".is_pinned_holder:first");
if($msg.length===0||$is_pinned_holder.length===0)return;if(is_pinned){$msg.addClass("is_pinned");$is_pinned_holder.html(TS.templates.builders.buildPinInfoHtml(msg).string)}else{$msg.removeClass("is_pinned");$is_pinned_holder.empty()}};var _updatePinnedFileUI=function(model_ob,file,is_pinned){if(!model_ob||!file)return;var $files=$('.message_body[data-file-id="'+file.id+'"]');var $msgs=$files.closest("ts-message");_updatePinnedMsgDomElementUI(model_ob,$msgs,is_pinned)};var _updatePinnedFileCommentUI=function(model_ob,comment,is_pinned){if(!model_ob||!comment)return;var $comment=$(".rxns_key_"+comment._rxn_key);var $msg=$comment.closest("ts-message");_updatePinnedMsgDomElementUI(model_ob,$msg,is_pinned)};var _updatePinnedMsgDomElementUI=function(model_ob,$msgs,is_pinned){if(!model_ob||$msgs.length===0)return;_.forEach($msgs,function(msg){var msg_ts=$(msg).data("ts");if(!msg_ts)return;var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg)return;_updatePinnedMessageUI(model_ob,msg,is_pinned)})}})();
